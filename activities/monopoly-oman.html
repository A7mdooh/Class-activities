<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="مونوبولي سلطنة عُمان - لعبة العقارات التعليمية">
    <title>مونوبولي سلطنة عُمان - لعبة العقارات العُمانية</title>
    
    <!-- الخطوط والأيقونات -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- المكتبات الخارجية -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <!-- الأنماط والسكريبت الموحد -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/activityUtils.js"></script>

    <style>
        /* ===========================================
           نظام الألوان العُماني المتقدم
        =========================================== */
        :root {
            /* الألوان العُمانية الرئيسية */
            --oman-red: #DC143C;
            --oman-green: #228B22;
            --oman-white: #FFFFFF;
            --accent-gold: #FFD700;
            
            /* تدرجات مونوبولي مخصصة */
            --gradient-red: linear-gradient(135deg, var(--oman-red) 0%, #B71C1C 100%);
            --gradient-green: linear-gradient(135deg, var(--oman-green) 0%, #1B5E20 100%);
            --gradient-gold: linear-gradient(135deg, var(--accent-gold) 0%, #F57C00 100%);
            --gradient-background: linear-gradient(135deg, #0F172A 0%, #1E293B 25%, #334155 50%, #475569 75%, #64748B 100%);
            
            /* ألوان المونوبولي التقليدية */
            --property-brown: #8B4513;
            --property-light-blue: #87CEEB;
            --property-pink: #FF1493;
            --property-orange: #FF8C00;
            --property-red: var(--oman-red);
            --property-yellow: #FFD700;
            --property-green: var(--oman-green);
            --property-dark-blue: #191970;
            --utility-color: #F0F8FF;
            --railroad-color: #2F4F4F;
            
            /* ألوان النظام */
            --success-color: #22C55E;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
            
            /* ألوان النص والخلفيات */
            --text-primary: #FFFFFF;
            --text-secondary: #E2E8F0;
            --text-muted: #94A3B8;
            --text-dark: #1E293B;
            --text-board: #1F2937;
            
            /* خلفيات وأسطح */
            --background-primary: #0F172A;
            --background-secondary: #1E293B;
            --surface-elevated: rgba(255, 255, 255, 0.1);
            --surface-glass: rgba(255, 255, 255, 0.05);
            --surface-board: rgba(255, 255, 255, 0.98);
            
            /* ظلال وتأثيرات */
            --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.25);
            --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.35);
            --shadow-glow-red: 0 0 24px rgba(220, 20, 60, 0.4);
            --shadow-glow-green: 0 0 24px rgba(34, 139, 34, 0.4);
            --shadow-glow-gold: 0 0 24px rgba(255, 215, 0, 0.4);
            --shadow-board: 0 12px 48px rgba(0, 0, 0, 0.4);
            
            /* أنصاف أقطار الحدود */
            --border-radius-small: 8px;
            --border-radius-medium: 12px;
            --border-radius-large: 16px;
            --border-radius-xl: 24px;
            
            /* انتقالات */
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===========================================
           الإعدادات العامة
        =========================================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--gradient-background);
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* خلفية متحركة متطورة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(220, 20, 60, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(34, 139, 34, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.08) 0%, transparent 50%);
            animation: monopolyFlow 25s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes monopolyFlow {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                opacity: 0.6;
            }
            25% { 
                transform: scale(1.2) rotate(90deg);
                opacity: 0.8;
            }
            50% { 
                transform: scale(0.8) rotate(180deg);
                opacity: 0.4;
            }
            75% { 
                transform: scale(1.1) rotate(270deg);
                opacity: 0.7;
            }
        }

        /* ===========================================
           أزرار التحكم
        =========================================== */
        .control-btn {
            position: fixed;
            top: 15px;
            font-size: 20px;
            background: var(--surface-glass);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-normal);
            padding: 12px;
            z-index: 2147483647;
            border-radius: 50%;
            backdrop-filter: blur(16px);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
            font-weight: 600;
        }
        
        .control-btn:hover {
            transform: translateY(-3px) scale(1.1);
            background: var(--gradient-red);
            color: var(--oman-white);
            border-color: var(--oman-red);
            box-shadow: var(--shadow-glow-red);
        }

        #returnToIndex {
            right: 20px;
        }

        #soundToggle {
            right: 80px;
        }

        /* ===========================================
           الحاوية الرئيسية
        =========================================== */
        .monopoly-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* العنوان الرئيسي */
        .game-title {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--surface-glass);
            border-radius: var(--border-radius-xl);
            backdrop-filter: blur(16px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-large);
        }

        .game-title h1 {
            font-size: 3rem;
            font-weight: 700;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-title p {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* ===========================================
           لوحة اللعبة
        =========================================== */
        .game-board {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            aspect-ratio: 1;
            background: var(--surface-board);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-board);
            position: relative;
            border: 4px solid var(--oman-red);
            overflow: hidden;
        }

        /* مربعات اللوحة */
        .board-square {
            position: absolute;
            border: 2px solid var(--text-dark);
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            padding: 5px;
            transition: var(--transition-normal);
            cursor: pointer;
            color: var(--text-dark);
        }

        .board-square:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
            z-index: 10;
        }

        /* مربعات الزوايا */
        .corner-square {
            width: 120px;
            height: 120px;
        }

        /* مربعات الجانب */
        .side-square {
            width: 80px;
            height: 120px;
        }

        /* ألوان المجموعات */
        .brown { background-color: var(--property-brown) !important; color: white; }
        .light-blue { background-color: var(--property-light-blue) !important; }
        .pink { background-color: var(--property-pink) !important; color: white; }
        .orange { background-color: var(--property-orange) !important; }
        .red { background-color: var(--property-red) !important; color: white; }
        .yellow { background-color: var(--property-yellow) !important; }
        .green { background-color: var(--property-green) !important; color: white; }
        .dark-blue { background-color: var(--property-dark-blue) !important; color: white; }
        .utility { background-color: var(--utility-color) !important; }
        .railroad { background-color: var(--railroad-color) !important; color: white; }

        /* مواضع المربعات */
        /* الصف السفلي */
        .square-0 { bottom: 0; right: 0; }
        .square-1 { bottom: 0; right: 120px; }
        .square-2 { bottom: 0; right: 200px; }
        .square-3 { bottom: 0; right: 280px; }
        .square-4 { bottom: 0; right: 360px; }
        .square-5 { bottom: 0; right: 440px; }
        .square-6 { bottom: 0; right: 520px; }
        .square-7 { bottom: 0; right: 600px; }
        .square-8 { bottom: 0; right: 680px; }
        .square-9 { bottom: 0; right: 760px; }
        .square-10 { bottom: 0; left: 0; }

        /* الصف الأيسر */
        .square-11 { left: 0; bottom: 120px; transform: rotate(90deg); }
        .square-12 { left: 0; bottom: 200px; transform: rotate(90deg); }
        .square-13 { left: 0; bottom: 280px; transform: rotate(90deg); }
        .square-14 { left: 0; bottom: 360px; transform: rotate(90deg); }
        .square-15 { left: 0; bottom: 440px; transform: rotate(90deg); }
        .square-16 { left: 0; bottom: 520px; transform: rotate(90deg); }
        .square-17 { left: 0; bottom: 600px; transform: rotate(90deg); }
        .square-18 { left: 0; bottom: 680px; transform: rotate(90deg); }
        .square-19 { left: 0; bottom: 760px; transform: rotate(90deg); }
        .square-20 { top: 0; left: 0; }

        /* الصف العلوي */
        .square-21 { top: 0; left: 120px; transform: rotate(180deg); }
        .square-22 { top: 0; left: 200px; transform: rotate(180deg); }
        .square-23 { top: 0; left: 280px; transform: rotate(180deg); }
        .square-24 { top: 0; left: 360px; transform: rotate(180deg); }
        .square-25 { top: 0; left: 440px; transform: rotate(180deg); }
        .square-26 { top: 0; left: 520px; transform: rotate(180deg); }
        .square-27 { top: 0; left: 600px; transform: rotate(180deg); }
        .square-28 { top: 0; left: 680px; transform: rotate(180deg); }
        .square-29 { top: 0; left: 760px; transform: rotate(180deg); }
        .square-30 { top: 0; right: 0; }

        /* الصف الأيمن */
        .square-31 { right: 0; top: 120px; transform: rotate(270deg); }
        .square-32 { right: 0; top: 200px; transform: rotate(270deg); }
        .square-33 { right: 0; top: 280px; transform: rotate(270deg); }
        .square-34 { right: 0; top: 360px; transform: rotate(270deg); }
        .square-35 { right: 0; top: 440px; transform: rotate(270deg); }
        .square-36 { right: 0; top: 520px; transform: rotate(270deg); }
        .square-37 { right: 0; top: 600px; transform: rotate(270deg); }
        .square-38 { right: 0; top: 680px; transform: rotate(270deg); }
        .square-39 { right: 0; top: 760px; transform: rotate(270deg); }

        /* ===========================================
           عناصر تحكم اللعبة
        =========================================== */
        .game-controls {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: var(--surface-glass);
            border-radius: var(--border-radius-large);
            backdrop-filter: blur(16px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .control-button {
            background: var(--gradient-red);
            color: var(--text-primary);
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: var(--border-radius-medium);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Cairo', sans-serif;
            box-shadow: var(--shadow-medium);
        }

        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-glow-red);
        }

        .control-button.green {
            background: var(--gradient-green);
        }

        .control-button.green:hover {
            box-shadow: var(--shadow-glow-green);
        }

        .control-button.gold {
            background: var(--gradient-gold);
            color: var(--text-dark);
        }

        .control-button.gold:hover {
            box-shadow: var(--shadow-glow-gold);
        }

        /* ===========================================
           معلومات اللاعبين
        =========================================== */
        .players-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .player-card {
            background: var(--surface-glass);
            border-radius: var(--border-radius-large);
            padding: 20px;
            backdrop-filter: blur(16px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition-normal);
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-large);
            border-color: var(--oman-red);
        }

        .player-card h3 {
            color: var(--accent-gold);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        /* ===========================================
           أدوات التحكم (مطابقة لباقي الأنشطة)
        =========================================== */
        .game-controls {
            background: var(--surface-glass);
            border-radius: var(--border-radius-xl);
            padding: 30px;
            margin: 30px 0;
            backdrop-filter: blur(16px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-large);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-medium);
            background: var(--surface-board);
            color: var(--text-dark);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: var(--transition-normal);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }

        .form-control:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .game-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-medium);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
            box-shadow: var(--shadow-medium);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-large);
        }

        .btn-primary {
            background: var(--gradient-red);
            color: var(--text-primary);
        }

        .btn-primary:not(:disabled):hover {
            box-shadow: var(--shadow-glow-red);
        }

        .btn-success {
            background: var(--gradient-green);
            color: var(--text-primary);
        }

        .btn-success:not(:disabled):hover {
            box-shadow: var(--shadow-glow-green);
        }

        .btn-warning {
            background: var(--gradient-gold);
            color: var(--text-dark);
        }

        .btn-warning:not(:disabled):hover {
            box-shadow: var(--shadow-glow-gold);
        }

        .btn-info {
            background: var(--gradient-red);
            color: var(--text-primary);
        }

        .btn-info:hover {
            box-shadow: var(--shadow-glow-red);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            box-shadow: 0 0 20px rgba(108, 117, 125, 0.4);
        }

        /* ===========================================
           واجهة اختيار اللاعبين الذكية
        =========================================== */
        .smart-player-selection {
            background: var(--surface-glass);
            border-radius: var(--border-radius-xl);
            padding: 0;
            margin: 30px 0;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-large);
            overflow: hidden;
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .selection-header {
            background: linear-gradient(135deg, var(--oman-red) 0%, #B71C1C 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .selection-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a" cx="50%" cy="50%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><circle cx="10" cy="10" r="10" fill="url(%23a)"><animate attributeName="cx" values="10;90;10" dur="3s" repeatCount="indefinite"/></circle></svg>');
            opacity: 0.3;
            animation: headerFlow 6s ease-in-out infinite;
        }

        @keyframes headerFlow {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .icon-wrapper {
            display: inline-block;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .icon-wrapper i {
            font-size: 2.5rem;
            color: white;
        }

        .selection-header h2 {
            margin: 0 0 10px 0;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold) 0%, #FFA000 100%);
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 3px;
        }

        .selection-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .selected-count {
            font-size: 1.8rem;
            color: var(--accent-gold);
            font-weight: 800;
        }

        .selection-modes {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .mode-switcher {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            padding: 12px 20px;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: var(--gradient-gold);
            border-color: var(--accent-gold);
            color: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-gold);
        }

        .smart-selection-container {
            padding: 30px;
        }

        .smart-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-medium);
            padding: 20px;
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: center;
        }

        .feature-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .feature-card.active {
            background: var(--gradient-green);
            border-color: var(--oman-green);
            color: white;
            transform: translateY(-3px);
            box-shadow: var(--shadow-glow-green);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
        }

        .feature-card.active .feature-icon {
            background: rgba(255, 255, 255, 0.2);
        }

        .feature-content h4 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .feature-content p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .search-and-sort {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-medium);
            background: var(--surface-board);
            color: var(--text-dark);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: var(--transition-normal);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }

        .students-interactive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            padding: 0 30px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 30px;
        }

        .student-interactive-card {
            background: var(--surface-board);
            border: 2px solid transparent;
            border-radius: var(--border-radius-medium);
            padding: 20px;
            cursor: pointer;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .student-interactive-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .student-interactive-card:hover::before {
            left: 100%;
        }

        .student-interactive-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            border-color: var(--oman-red);
        }

        .student-interactive-card.selected {
            background: var(--gradient-green);
            color: white;
            border-color: var(--oman-green);
            transform: translateY(-5px);
            box-shadow: var(--shadow-glow-green);
        }

        .student-interactive-card.selected .student-avatar {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        .student-avatar {
            width: 60px;
            height: 60px;
            background: var(--gradient-red);
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
            color: white;
            font-weight: 700;
        }

        .student-name {
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .student-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .student-interactive-card.selected .student-stats {
            opacity: 1;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .selected-players-preview {
            padding: 0 30px 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
        }

        .selected-players-preview h3 {
            color: var(--accent-gold);
            margin: 20px 0 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selected-players-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            min-height: 100px;
        }

        .selected-player-card {
            background: var(--gradient-green);
            color: white;
            border-radius: var(--border-radius-medium);
            padding: 15px;
            text-align: center;
            position: relative;
            animation: slideInScale 0.3s ease-out;
        }

        @keyframes slideInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .selected-player-card .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            color: white;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .selected-player-card .remove-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .manual-selection-container {
            padding: 30px;
        }

        .manual-selectors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .manual-selector {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-medium);
            padding: 20px;
        }

        .manual-selector label {
            display: block;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .selection-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.03);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn {
            padding: 15px 30px;
            border: none;
            border-radius: var(--border-radius-medium);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-btn:not(:disabled):hover {
            transform: translateY(-3px);
        }

        .action-btn.primary {
            background: var(--gradient-green);
            color: white;
        }

        .action-btn.primary:not(:disabled):hover {
            box-shadow: var(--shadow-glow-green);
        }

        .action-btn.secondary {
            background: var(--gradient-gold);
            color: var(--text-dark);
        }

        .action-btn.secondary:hover {
            box-shadow: var(--shadow-glow-gold);
        }

        .action-btn.danger {
            background: var(--gradient-red);
            color: white;
        }

        .action-btn.danger:hover {
            box-shadow: var(--shadow-glow-red);
        }

        .selection-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .selection-header h2 {
            color: var(--accent-gold);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .selection-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            align-items: end;
        }

        .class-selector, .student-select {
            background: var(--surface-board);
            border: 2px solid var(--oman-red);
            border-radius: var(--border-radius-medium);
            padding: 12px;
            font-size: 1rem;
            color: var(--text-dark);
            font-family: 'Cairo', sans-serif;
            width: 100%;
            transition: var(--transition-normal);
        }

        .class-selector:focus, .student-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }

        .selection-mode-controls {
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .mode-btn {
            background: var(--surface-glass);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }

        .mode-btn.active, .mode-btn:hover {
            background: var(--gradient-red);
            border-color: var(--oman-red);
            color: var(--oman-white);
        }

        .player-selectors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .player-selector {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: var(--border-radius-medium);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .students-grid-container {
            margin: 20px 0;
        }

        .selected-students {
            background: var(--surface-elevated);
            padding: 15px;
            border-radius: var(--border-radius-medium);
            margin-bottom: 20px;
            border: 2px solid var(--oman-green);
        }

        .selected-students h4 {
            color: var(--oman-green);
            margin-bottom: 10px;
        }

        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .selected-student {
            background: var(--gradient-green);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius-medium);
        }

        .student-card {
            background: var(--surface-board);
            color: var(--text-dark);
            padding: 15px;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            transition: var(--transition-normal);
            border: 2px solid transparent;
            text-align: center;
            font-weight: 600;
        }

        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
            border-color: var(--oman-red);
        }

        .student-card.selected {
            background: var(--gradient-green);
            color: white;
            border-color: var(--oman-green);
            box-shadow: var(--shadow-glow-green);
        }

        .selection-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        /* ===========================================
           النوافذ المنبثقة
        =========================================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--surface-board);
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius-xl);
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: var(--shadow-large);
            color: var(--text-dark);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close {
            color: var(--text-muted);
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .close:hover {
            color: var(--oman-red);
            transform: scale(1.1);
        }

        /* ===========================================
           الاستجابة للأجهزة المحمولة
        =========================================== */
        @media (max-width: 768px) {
            .monopoly-container {
                padding: 10px;
            }

            .game-title h1 {
                font-size: 2rem;
            }

            .game-title p {
                font-size: 1rem;
            }

            .game-board {
                max-width: 100%;
            }

            .corner-square {
                width: 80px;
                height: 80px;
            }

            .side-square {
                width: 50px;
                height: 80px;
            }

            .board-square {
                font-size: 0.6rem;
                padding: 3px;
            }

            /* إعادة تموضع المربعات للشاشات الصغيرة */
            .square-1 { right: 80px; }
            .square-2 { right: 130px; }
            .square-3 { right: 180px; }
            .square-4 { right: 230px; }
            .square-5 { right: 280px; }
            .square-6 { right: 330px; }
            .square-7 { right: 380px; }
            .square-8 { right: 430px; }
            .square-9 { right: 480px; }

            .control-button {
                padding: 12px 24px;
                font-size: 1rem;
                margin: 8px;
            }

            .players-info {
                grid-template-columns: 1fr;
            }

            /* أدوات التحكم للأجهزة المحمولة */
            .control-group {
                grid-template-columns: 1fr;
            }

            .game-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                min-width: auto;
            }

            /* واجهة اختيار اللاعبين للأجهزة المحمولة */
            .smart-features {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .feature-card {
                padding: 15px;
            }

            .feature-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                margin-bottom: 10px;
            }

            .search-and-sort {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .students-interactive-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 10px;
                padding: 0 15px;
            }

            .student-interactive-card {
                padding: 15px;
            }

            .student-avatar {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
                margin-bottom: 10px;
            }

            .selected-players-list {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .selection-actions {
                flex-direction: column;
                gap: 10px;
            }

            .action-btn {
                width: 100%;
                min-width: auto;
            }

            .mode-switcher {
                flex-direction: column;
                gap: 8px;
            }

            .mode-btn {
                min-width: auto;
            }

            /* واجهة اختيار الطلاب للأجهزة المحمولة */
            .selection-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .mode-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .player-selectors {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .students-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }

            .student-card {
                padding: 10px;
                font-size: 0.9rem;
            }

            .selection-actions {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                padding: 20px;
            }

            .game-title h1 {
                font-size: 1.5rem;
            }

            .corner-square {
                width: 60px;
                height: 60px;
            }

            .side-square {
                width: 40px;
                height: 60px;
            }

            .board-square {
                font-size: 0.5rem;
                padding: 2px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
                top: 10px;
            }

            #returnToIndex {
                right: 10px;
            }

            #soundToggle {
                right: 60px;
            }

            .student-selection-container {
                padding: 15px;
            }

            .students-grid {
                grid-template-columns: 1fr;
                max-height: 300px;
            }
        }

        /* تأثيرات مثيرة للمونوبولي */
        @keyframes landingEffect {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0.3); }
            100% { transform: scale(1); box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
        }

        .landing-effect {
            animation: landingEffect 1s ease-out;
        }

        @keyframes cardSlideIn {
            0% { 
                transform: translateY(-100vh) rotateX(90deg);
                opacity: 0;
            }
            50% {
                transform: translateY(0) rotateX(45deg);
                opacity: 0.7;
            }
            100% { 
                transform: translateY(0) rotateX(0deg);
                opacity: 1;
            }
        }

        @keyframes cardSlideOut {
            0% { 
                transform: translateY(0) rotateX(0deg);
                opacity: 1;
            }
            100% { 
                transform: translateY(100vh) rotateX(-90deg);
                opacity: 0;
            }
        }

        .card-modal {
            perspective: 1000px;
        }

        .card-content {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 20px;
            border: 3px solid;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            transform-style: preserve-3d;
        }

        .card-text {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 20px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }

        .card-player {
            margin: 15px 0;
            padding: 10px;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border-radius: 25px;
            font-weight: bold;
        }

        .btn-execute {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-execute:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .purchase-modal {
            backdrop-filter: blur(10px);
        }

        .purchase-content {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 450px;
            border: 3px solid #28a745;
        }

        .property-details {
            background: rgba(40, 167, 69, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        .property-details p {
            margin: 10px 0;
            font-weight: 500;
        }

        .purchase-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn-purchase, .btn-decline {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .btn-purchase {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-decline {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-purchase:hover, .btn-decline:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse-effect {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }

        .message-achievement {
            background: linear-gradient(135deg, #FFD700, #FFA500) !important;
            border-left: 5px solid #FF8C00 !important;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4) !important;
        }

        .message-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3) !important;
        }

        .message-error {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3) !important;
        }

        .game-board {
            position: relative;
            overflow: visible;
        }

        .fireworks {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1000;
        }

        /* لوحة القيادة المحترفة */
        .leaderboard-header {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .leaderboard-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }

        .leaderboard-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .leaderboard-player {
            background: white;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .leaderboard-player.first {
            border-color: #FFD700;
            background: linear-gradient(135deg, #fff9e6, #fff);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.2);
        }

        .leaderboard-player.second {
            border-color: #C0C0C0;
            background: linear-gradient(135deg, #f8f9fa, #fff);
        }

        .leaderboard-player.third {
            border-color: #CD7F32;
            background: linear-gradient(135deg, #fdf7f0, #fff);
        }

        .leaderboard-player.other {
            border-color: #6c757d;
        }

        .leaderboard-player.current-player {
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(0, 123, 255, 0.3);
            border-color: #007bff;
        }

        .leaderboard-player::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #0056b3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .leaderboard-player.current-player::before {
            opacity: 1;
        }

        .player-rank {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .rank-emoji {
            font-size: 2em;
        }

        .rank-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #666;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .player-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: #333;
        }

        .stat-value.total-worth {
            color: #28a745;
            font-size: 1.1em;
        }

        .player-achievements {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .achievement {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        @media (max-width: 768px) {
            .player-stats {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-stats {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>

<body>
    <!-- أزرار التحكم العلوية -->
    <button id="returnToIndex" class="control-btn" title="العودة للصفحة الرئيسية">
        <i class="fas fa-home"></i>
    </button>
    <button id="soundToggle" class="control-btn" title="تشغيل/إيقاف الصوت">
        <i class="fas fa-volume-up"></i>
    </button>

    <!-- الحاوية الرئيسية -->
    <div class="monopoly-container">
        <!-- العنوان الرئيسي -->
        <div class="game-title">
            <h1><i class="fas fa-building"></i> مونوبولي سلطنة عُمان</h1>
            <p>لعبة العقارات العُمانية التعليمية - استكشف معالم سلطنة عُمان الجميلة</p>
        </div>

        <!-- لوحة اللعبة -->
        <div class="game-board" id="gameBoard">
            <!-- مربعات اللوحة سيتم إنشاؤها بواسطة JavaScript -->
        </div>

        <!-- أدوات التحكم الرئيسية -->
        <div class="game-controls">
            <div class="control-group">
                <div class="form-group">
                    <label for="classSelect">📚 اختيار الصف</label>
                    <select id="classSelect" class="form-control">
                        <option value="">اختر الصف الدراسي</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="playersCount">👥 عدد اللاعبين</label>
                    <select id="playersCount" class="form-control">
                        <option value="2">👥 لاعبان</option>
                        <option value="3">👥👤 ثلاثة لاعبين</option>
                        <option value="4">👥👥 أربعة لاعبين</option>
                    </select>
                </div>
            </div>

            <!-- أزرار بدء اللعبة -->
            <div class="game-buttons">
                <button id="setupPlayersBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-users-cog"></i>
                    ⚙️ إعداد اللاعبين
                </button>
                <button id="startGameBtn" class="btn btn-success" disabled>
                    <i class="fas fa-play"></i>
                    🎲 بدء اللعبة
                </button>
                <button id="rollDice" class="btn btn-warning" disabled>
                    <i class="fas fa-dice"></i>
                    🎲 رمي النرد
                </button>
                <button id="endTurn" class="btn btn-info" disabled>
                    <i class="fas fa-exchange-alt"></i>
                    🔄 إنهاء الدور
                </button>
                <button id="showRules" class="btn btn-secondary">
                    <i class="fas fa-book"></i>
                    📖 قواعد اللعبة
                </button>
            </div>
        </div>

        <!-- واجهة اختيار اللاعبين المبسطة -->
        <div class="smart-player-selection" id="smartPlayerSelection" style="display: none;">
            <div class="selection-header">
                <div class="header-content">
                    <div class="icon-wrapper">
                        <i class="fas fa-users"></i>
                    </div>
                    <h2>اختيار اللاعبين</h2>
                    <p class="subtitle">انقر على الطلاب لاختيارهم في اللعبة</p>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="selectionProgress"></div>
                </div>
                <div class="selection-counter">
                    <span class="selected-count" id="selectedPlayersCount">0</span>
                    <span class="separator">/</span>
                    <span class="total-count" id="totalPlayersNeeded">2</span>
                    <span class="label">لاعبين محددين</span>
                </div>
            </div>

            <!-- شبكة الطلاب التفاعلية -->
            <div class="students-interactive-grid" id="studentsInteractiveGrid">
                <!-- سيتم ملؤها بواسطة JavaScript -->
            </div>

            <!-- عرض اللاعبين المختارين -->
            <div class="selected-players-preview" id="selectedPlayersPreview">
                <h3>
                    <i class="fas fa-check-circle"></i>
                    اللاعبون المختارون
                </h3>
                <div class="selected-players-list" id="selectedPlayersList">
                    <div class="empty-state">
                        <i class="fas fa-user-plus"></i>
                        <p>انقر على الطلاب لاختيارهم</p>
                    </div>
                </div>
            </div>

            <!-- أزرار التحكم -->
            <div class="selection-actions">
                <button class="action-btn secondary" id="clearSelection">
                    <i class="fas fa-undo"></i>
                    إعادة تعيين
                </button>
                <button class="action-btn primary" id="confirmPlayerSelection" disabled>
                    <i class="fas fa-check"></i>
                    تأكيد الاختيار
                </button>
                <button class="action-btn danger" id="cancelPlayerSelection">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>

        <!-- معلومات اللاعبين -->
        <div class="players-info" id="playersInfo">
            <!-- معلومات اللاعبين سيتم إنشاؤها بواسطة JavaScript -->
        </div>
    </div>

    <!-- النوافذ المنبثقة -->
    <!-- نافذة قواعد اللعبة -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <span class="close" data-modal="rulesModal">&times;</span>
            <h2><i class="fas fa-book"></i> قواعد لعبة مونوبولي عُمان</h2>
            <div style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                <h3>🎯 الهدف من اللعبة:</h3>
                <p>شراء العقارات العُمانية وتطويرها لتحقيق أكبر ربح ممكن.</p>
                
                <h3>🎲 كيفية اللعب:</h3>
                <ul>
                    <li>كل لاعب يبدأ بمبلغ 1500 ريال عُماني</li>
                    <li>ارمي النرد وتحرك على اللوحة</li>
                    <li>اشتر العقارات التي تهبط عليها</li>
                    <li>اجمع الإيجار من اللاعبين الآخرين</li>
                    <li>طور عقاراتك لزيادة الإيجار</li>
                </ul>
                
                <h3>🏠 أنواع المربعات:</h3>
                <ul>
                    <li><strong>العقارات:</strong> يمكن شراؤها وتطويرها</li>
                    <li><strong>المحطات:</strong> شركات النقل العُمانية</li>
                    <li><strong>المرافق:</strong> الكهرباء والمياه</li>
                    <li><strong>الضرائب:</strong> ادفع المبلغ المحدد</li>
                    <li><strong>الفرصة والصندوق:</strong> اسحب بطاقة</li>
                </ul>
                
                <h3>🏆 الفوز:</h3>
                <p>آخر لاعب يبقى في اللعبة (لم يفلس) يكون الفائز!</p>
            </div>
        </div>
    </div>

    <!-- نافذة معلومات العقار -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <span class="close" data-modal="propertyModal">&times;</span>
            <div id="propertyInfo">
                <!-- معلومات العقار سيتم عرضها هنا -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ===========================================
        // بيانات اللعبة الأساسية
        // ===========================================
        
        // بيانات العقارات العُمانية
        const omanProperties = [
            // الصف السفلي
            { id: 0, name: "البداية", type: "start", price: 0, color: "special" },
            { id: 1, name: "صحار", type: "property", price: 60, color: "brown", rent: [2, 10, 30, 90, 160, 250] },
            { id: 2, name: "صندوق المجتمع", type: "community", price: 0, color: "special" },
            { id: 3, name: "الرستاق", type: "property", price: 60, color: "brown", rent: [4, 20, 60, 180, 320, 450] },
            { id: 4, name: "ضريبة الدخل", type: "tax", price: 200, color: "special" },
            { id: 5, name: "مطار مسقط", type: "airport", price: 200, color: "railroad", rent: [25, 50, 100, 200] },
            { id: 6, name: "مطرح", type: "property", price: 100, color: "light-blue", rent: [6, 30, 90, 270, 400, 550] },
            { id: 7, name: "الفرصة", type: "chance", price: 0, color: "special" },
            { id: 8, name: "الخوير", type: "property", price: 100, color: "light-blue", rent: [6, 30, 90, 270, 400, 550] },
            { id: 9, name: "القرم", type: "property", price: 120, color: "light-blue", rent: [8, 40, 100, 300, 450, 600] },
            
            // الصف الأيسر
            { id: 10, name: "السجن/الزيارة", type: "jail", price: 0, color: "special" },
            { id: 11, name: "صلالة", type: "property", price: 140, color: "pink", rent: [10, 50, 150, 450, 625, 750] },
            { id: 12, name: "شركة الكهرباء", type: "utility", price: 150, color: "utility", rent: [4, 10] },
            { id: 13, name: "طاقة", type: "property", price: 140, color: "pink", rent: [10, 50, 150, 450, 625, 750] },
            { id: 14, name: "مرباط", type: "property", price: 160, color: "pink", rent: [12, 60, 180, 500, 700, 900] },
            { id: 15, name: "مطار صلالة", type: "airport", price: 200, color: "railroad", rent: [25, 50, 100, 200] },
            { id: 16, name: "نزوى", type: "property", price: 180, color: "orange", rent: [14, 70, 200, 550, 750, 950] },
            { id: 17, name: "صندوق المجتمع", type: "community", price: 0, color: "special" },
            { id: 18, name: "بهلا", type: "property", price: 180, color: "orange", rent: [14, 70, 200, 550, 750, 950] },
            { id: 19, name: "الحمراء", type: "property", price: 200, color: "orange", rent: [16, 80, 220, 600, 800, 1000] },
            
            // الصف العلوي
            { id: 20, name: "موقف مجاني", type: "free", price: 0, color: "special" },
            { id: 21, name: "صور", type: "property", price: 220, color: "red", rent: [18, 90, 250, 700, 875, 1050] },
            { id: 22, name: "الفرصة", type: "chance", price: 0, color: "special" },
            { id: 23, name: "الكامل والوافي", type: "property", price: 220, color: "red", rent: [18, 90, 250, 700, 875, 1050] },
            { id: 24, name: "جعلان بني بوعلي", type: "property", price: 240, color: "red", rent: [20, 100, 300, 750, 925, 1100] },
            { id: 25, name: "مطار صور", type: "airport", price: 200, color: "railroad", rent: [25, 50, 100, 200] },
            { id: 26, name: "الخابورة", type: "property", price: 260, color: "yellow", rent: [22, 110, 330, 800, 975, 1150] },
            { id: 27, name: "السويق", type: "property", price: 260, color: "yellow", rent: [22, 110, 330, 800, 975, 1150] },
            { id: 28, name: "شركة المياه", type: "utility", price: 150, color: "utility", rent: [4, 10] },
            { id: 29, name: "شناص", type: "property", price: 280, color: "yellow", rent: [24, 120, 360, 850, 1025, 1200] },
            
            // الصف الأيمن
            { id: 30, name: "اذهب للسجن", type: "go-to-jail", price: 0, color: "special" },
            { id: 31, name: "إبراء", type: "property", price: 300, color: "green", rent: [26, 130, 390, 900, 1100, 1275] },
            { id: 32, name: "القابل", type: "property", price: 300, color: "green", rent: [26, 130, 390, 900, 1100, 1275] },
            { id: 33, name: "صندوق المجتمع", type: "community", price: 0, color: "special" },
            { id: 34, name: "بدية", type: "property", price: 320, color: "green", rent: [28, 150, 450, 1000, 1200, 1400] },
            { id: 35, name: "مطار الدقم", type: "airport", price: 200, color: "railroad", rent: [25, 50, 100, 200] },
            { id: 36, name: "الفرصة", type: "chance", price: 0, color: "special" },
            { id: 37, name: "خصب", type: "property", price: 350, color: "dark-blue", rent: [35, 175, 500, 1100, 1300, 1500] },
            { id: 38, name: "ضريبة الترف", type: "tax", price: 100, color: "special" },
            { id: 39, name: "مسندم", type: "property", price: 400, color: "dark-blue", rent: [50, 200, 600, 1400, 1700, 2000] }
        ];

        // ===========================================
        // متغيرات اللعبة الرئيسية المطورة
        // ===========================================
        let gameState = {
            players: [],
            currentPlayer: 0,
            gameStarted: false,
            soundEnabled: true,
            turn: 1,
            doubles: 0,
            lastRoll: { dice1: 0, dice2: 0, total: 0 },
            gameMode: 'competitive', // تنافسي
            animations: true,
            leaderboard: [],
            achievements: {},
            gameHistory: []
        };

        let playerData = [];

        // ===========================================
        // أنظمة اللعبة الأساسية
        // ===========================================
        
        // نظام الصوت الاحترافي
        class SoundSystem {
            constructor() {
                this.sounds = {
                    dice: new Audio('../assets/media/sounds/Click.mp3'),
                    buy: new Audio('../assets/media/sounds/Notification.mp3'),
                    money: new Audio('../assets/media/sounds/select.mp3'),
                    win: new Audio('../assets/media/sounds/win.mp3'),
                    lose: new Audio('../assets/media/sounds/wrong_answer.mp3'),
                    select: new Audio('../assets/media/sounds/select.mp3'),
                    achievement: new Audio('../assets/media/sounds/kingdom-sounds/achievement-unlock.mp3'),
                    victory: new Audio('../assets/media/sounds/kingdom-sounds/battle-victory.mp3'),
                    bonus: new Audio('../assets/media/sounds/kingdom-sounds/bonus-collect.mp3'),
                    countdown: new Audio('../assets/media/sounds/kingdom-sounds/countdown-tick.mp3'),
                    explosion: new Audio('../assets/media/sounds/kingdom-sounds/cosmic-explosion.mp3'),
                    cheer: new Audio('../assets/media/sounds/kingdom-sounds/crowd-cheer.mp3'),
                    bell: new Audio('../assets/media/sounds/kingdom-sounds/ancient-bell.mp3')
                };
                this.enabled = true;
                this.volume = 0.7;
                this.setupVolume();
            }

            setupVolume() {
                Object.values(this.sounds).forEach(sound => {
                    sound.volume = this.volume;
                });
            }

            play(soundName, volume = 1.0) {
                if (this.enabled && this.sounds[soundName]) {
                    const sound = this.sounds[soundName];
                    sound.volume = this.volume * volume;
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log('خطأ في تشغيل الصوت:', e));
                }
            }

            playSequence(sounds, delay = 500) {
                sounds.forEach((sound, index) => {
                    setTimeout(() => this.play(sound), index * delay);
                });
            }

            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }

            setVolume(volume) {
                this.volume = Math.max(0, Math.min(1, volume));
                this.setupVolume();
            }
        }

        // نظام الرسائل الاحترافي
        class MessageSystem {
            static show(message, type = 'info', duration = 3000, isImportant = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `game-message ${type} ${isImportant ? 'important' : ''}`;
                
                // إضافة أيقونات للرسائل
                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️',
                    money: '💰',
                    achievement: '🏆',
                    dice: '🎲'
                };
                
                const icon = icons[type] || icons.info;
                messageDiv.innerHTML = `<span class="message-icon">${icon}</span><span class="message-text">${message}</span>`;
                
                messageDiv.style.cssText = `
                    position: fixed;
                    top: ${isImportant ? '50%' : '100px'};
                    ${isImportant ? 'left: 50%; transform: translateX(-50%) translateY(-50%);' : 'right: 20px;'}
                    background: ${isImportant ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'var(--surface-glass)'};
                    color: white;
                    padding: ${isImportant ? '25px 35px' : '15px 20px'};
                    border-radius: var(--border-radius-medium);
                    border: 2px solid var(--oman-${type === 'error' ? 'red' : 'green'});
                    backdrop-filter: blur(16px);
                    box-shadow: ${isImportant ? '0 20px 40px rgba(0,0,0,0.3)' : 'var(--shadow-medium)'};
                    z-index: ${isImportant ? '10002' : '10001'};
                    animation: ${isImportant ? 'bounceIn' : 'slideInRight'} 0.5s ease-out;
                    font-weight: 600;
                    font-size: ${isImportant ? '18px' : '14px'};
                    max-width: ${isImportant ? '400px' : '300px'};
                    text-align: center;
                `;

                document.body.appendChild(messageDiv);

                // تأثير خاص للرسائل المهمة
                if (isImportant) {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }

                setTimeout(() => {
                    messageDiv.style.animation = isImportant ? 'bounceOut 0.5s ease-in' : 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, isImportant ? 500 : 300);
                }, duration);
            }

            static showTurnAnnouncement(playerName, turnNumber) {
                this.show(`🎯 دور ${playerName} - الجولة ${turnNumber}`, 'info', 4000, true);
            }

            static showMoneyTransaction(player, amount, isReceiving = true) {
                const action = isReceiving ? 'حصل على' : 'دفع';
                const icon = isReceiving ? '💰⬆️' : '💰⬇️';
                this.show(`${icon} ${player} ${action} ${Math.abs(amount)} ر.ع`, 'money', 3000);
            }

            static showPropertyPurchase(player, property, price) {
                this.show(`🏠 ${player} اشترى ${property} مقابل ${price} ر.ع`, 'success', 4000);
            }

            static showRentPayment(payer, receiver, property, amount) {
                this.show(`🏘️ ${payer} دفع ${amount} ر.ع إيجار ${property} لـ ${receiver}`, 'warning', 4000);
            }
        }

        // إنشاء الأنظمة
        const soundSystem = new SoundSystem();

        // ===========================================
        // نظام الإنجازات والقيادة
        // ===========================================
        class AchievementSystem {
            static achievements = {
                'first_property': { name: 'أول عقار', description: 'اشتر أول عقار لك', icon: '🏠', unlocked: false },
                'monopoly_master': { name: 'سيد الاحتكار', description: 'امتلك مجموعة كاملة', icon: '👑', unlocked: false },
                'millionaire': { name: 'المليونير', description: 'احصل على 2000 ر.ع', icon: '💎', unlocked: false },
                'lucky_roller': { name: 'محظوظ النرد', description: 'احصل على زوجي 3 مرات متتالية', icon: '🎲', unlocked: false },
                'rent_collector': { name: 'جامع الإيجارات', description: 'اجمع 500 ر.ع من الإيجارات', icon: '💰', unlocked: false },
                'speed_buyer': { name: 'مشتري سريع', description: 'اشتر 3 عقارات في 3 أدوار', icon: '⚡', unlocked: false }
            };

            static checkAchievement(player, type, data = {}) {
                const playerId = player.name;
                if (!gameState.achievements[playerId]) {
                    gameState.achievements[playerId] = {};
                }

                switch (type) {
                    case 'first_property':
                        if (player.properties.length === 1 && !gameState.achievements[playerId].first_property) {
                            this.unlockAchievement(playerId, 'first_property');
                        }
                        break;
                    case 'millionaire':
                        if (player.money >= 2000 && !gameState.achievements[playerId].millionaire) {
                            this.unlockAchievement(playerId, 'millionaire');
                        }
                        break;
                    case 'monopoly_master':
                        if (this.hasMonopoly(player) && !gameState.achievements[playerId].monopoly_master) {
                            this.unlockAchievement(playerId, 'monopoly_master');
                        }
                        break;
                    case 'lucky_roller':
                        if (data.consecutiveDoubles >= 3 && !gameState.achievements[playerId].lucky_roller) {
                            this.unlockAchievement(playerId, 'lucky_roller');
                        }
                        break;
                }
            }

            static unlockAchievement(playerId, achievementId) {
                gameState.achievements[playerId][achievementId] = true;
                const achievement = this.achievements[achievementId];
                
                MessageSystem.show(`🏆 ${playerId} حصل على إنجاز: ${achievement.name}!`, 'achievement', 5000, true);
                soundSystem.play('achievement');
                
                // تأثير خاص للإنجاز
                confetti({
                    particleCount: 150,
                    spread: 120,
                    origin: { y: 0.6 },
                    colors: ['#FFD700', '#FFA500', '#FF6347']
                });
            }

            static hasMonopoly(player) {
                const colorGroups = {};
                player.properties.forEach(propId => {
                    const prop = omanProperties[propId];
                    if (prop.type === 'property') {
                        if (!colorGroups[prop.color]) colorGroups[prop.color] = 0;
                        colorGroups[prop.color]++;
                    }
                });

                const monopolyCounts = {
                    'brown': 2, 'light-blue': 3, 'pink': 3, 'orange': 3,
                    'red': 3, 'yellow': 3, 'green': 3, 'dark-blue': 2
                };

                return Object.keys(colorGroups).some(color => 
                    colorGroups[color] === monopolyCounts[color]
                );
            }
        }

        // نظام اللوحة القيادية المحترف
        class LeaderboardSystem {
            static updateLeaderboard() {
                const leaderboardDiv = document.getElementById('leaderboard');
                if (!leaderboardDiv) return;

                // حساب القيمة الصافية لكل لاعب
                const playersWithNetWorth = gameState.players.map((player, index) => {
                    const propertyValue = this.calculatePropertyValue(player);
                    const netWorth = player.money + propertyValue;
                    
                    return {
                        ...player,
                        index,
                        propertyValue,
                        netWorth,
                        propertiesCount: player.properties.length
                    };
                });

                // ترتيب اللاعبين حسب القيمة الصافية
                playersWithNetWorth.sort((a, b) => b.netWorth - a.netWorth);

                // إنشاء HTML للوحة القيادية
                leaderboardDiv.innerHTML = `
                    <div class="leaderboard-header">
                        <h3>🏆 لوحة القيادة</h3>
                        <div class="leaderboard-stats">
                            <span>المرحلة: ${gameState.currentRound}</span>
                            <span>اللاعب الحالي: ${gameState.players[gameState.currentPlayer]?.name}</span>
                        </div>
                    </div>
                    <div class="leaderboard-list">
                        ${playersWithNetWorth.map((player, rank) => this.createPlayerCard(player, rank)).join('')}
                    </div>
                `;

                // تحديث الأرقام في بطاقات اللاعبين
                this.updatePlayerCards();
            }

            static calculatePropertyValue(player) {
                return player.properties.reduce((total, propertyId) => {
                    const property = omanProperties[propertyId];
                    return total + (property ? property.price : 0);
                }, 0);
            }

            static createPlayerCard(player, rank) {
                const rankEmoji = ['🥇', '🥈', '🥉', '🏅'][rank] || '🏅';
                const rankClass = ['first', 'second', 'third', 'other'][rank] || 'other';
                
                return `
                    <div class="leaderboard-player ${rankClass}" data-player="${player.index}">
                        <div class="player-rank">
                            <span class="rank-emoji">${rankEmoji}</span>
                            <span class="rank-number">#${rank + 1}</span>
                        </div>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-stats">
                                <div class="stat">
                                    <span class="stat-label">💰 الأموال:</span>
                                    <span class="stat-value">${player.money} ر.ع</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">🏠 العقارات:</span>
                                    <span class="stat-value">${player.propertyValue} ر.ع</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">📊 القيمة الصافية:</span>
                                    <span class="stat-value total-worth">${player.netWorth} ر.ع</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">🏘️ عدد العقارات:</span>
                                    <span class="stat-value">${player.propertiesCount}</span>
                                </div>
                            </div>
                        </div>
                        <div class="player-achievements">
                            ${this.getPlayerAchievements(player)}
                        </div>
                    </div>
                `;
            }

            static getPlayerAchievements(player) {
                const achievements = [];
                
                if (player.properties.length >= 1) {
                    achievements.push('<span class="achievement">🏠 مالك عقار</span>');
                }
                
                if (player.money >= 1000) {
                    achievements.push('<span class="achievement">💰 مليونير</span>');
                }
                
                if (player.properties.length >= 5) {
                    achievements.push('<span class="achievement">🏘️ مطور عقاري</span>');
                }
                
                return achievements.join('');
            }

            static updatePlayerCards() {
                gameState.players.forEach((player, index) => {
                    const playerElement = document.querySelector(`[data-player="${index}"]`);
                    if (playerElement) {
                        // تحديث المعلومات في بطاقة اللاعب
                        const moneyElement = playerElement.querySelector('.money');
                        if (moneyElement) {
                            moneyElement.textContent = `💰 ${player.money} ر.ع`;
                        }
                        
                        const propertiesElement = playerElement.querySelector('.properties-count');
                        if (propertiesElement) {
                            propertiesElement.textContent = `🏠 ${player.properties.length}`;
                        }
                    }
                });
            }

            static highlightCurrentPlayer() {
                // إزالة التمييز من جميع اللاعبين
                document.querySelectorAll('.leaderboard-player').forEach(el => {
                    el.classList.remove('current-player');
                });
                
                // تمييز اللاعب الحالي
                const currentPlayerElement = document.querySelector(`[data-player="${gameState.currentPlayer}"]`);
                if (currentPlayerElement) {
                    currentPlayerElement.classList.add('current-player');
                }
            }

            static calculateNetWorth(player) {
                let netWorth = player.money;
                player.properties.forEach(propId => {
                    const prop = omanProperties[propId];
                    netWorth += prop.price;
                });
                return netWorth;
            }

            static showLeaderboard() {
                this.updateLeaderboard();
                const modal = document.getElementById('leaderboardModal');
                const content = document.getElementById('leaderboardContent');
                
                content.innerHTML = gameState.leaderboard.map(entry => `
                    <div class="leaderboard-entry rank-${entry.rank}">
                        <div class="rank">${entry.rank === 1 ? '👑' : entry.rank}</div>
                        <div class="player-name">${entry.name}</div>
                        <div class="net-worth">${entry.netWorth} ر.ع</div>
                        <div class="properties">${entry.properties} عقار</div>
                    </div>
                `).join('');
                
                modal.style.display = 'block';
            }
        }

        // ===========================================
        // تحميل بيانات الطلاب (مطابق لنشاط "من هو")
        // ===========================================
        async function loadStudentData() {
            try {
                console.log('🔄 محاولة تحميل بيانات الطلاب من الملف...');
                const response = await fetch('../data/studentData.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: فشل في تحميل بيانات الطلاب`);
                }
                const data = await response.json();
                
                if (!data || Object.keys(data).length === 0) {
                    throw new Error('لا توجد بيانات طلاب في الملف');
                }
                
                // تحويل البيانات من تنسيق الأسماء إلى تنسيق الكائنات
                const formattedData = {};
                for (const [className, students] of Object.entries(data)) {
                    formattedData[className] = students.map((studentName, index) => ({
                        name: studentName,
                        id: `${className.replace(/ /g, '_')}_${index + 1}`
                    }));
                }
                
                playerData = formattedData;
                console.log('🎉 تم تحميل بيانات الطلاب بنجاح!');
                console.log(`📊 إجمالي الصفوف: ${Object.keys(data).length}`);
                console.log(`👥 إجمالي الطلاب: ${Object.values(data).flat().length}`);
                
                // عرض عينة من البيانات لكل صف
                Object.keys(data).forEach(className => {
                    console.log(`📝 ${className}: ${data[className].length} طالب`);
                });
                
                // عرض عينة من الأسماء الحقيقية
                const firstClass = Object.keys(data)[0];
                console.log(`� عينة من أسماء ${firstClass}:`);
                data[firstClass].slice(0, 3).forEach((name, index) => {
                    console.log(`   ${index + 1}. ${name}`);
                });
                
                MessageSystem.show(`تم تحميل ${Object.values(data).flat().length} اسم طالب من ${Object.keys(data).length} صف! 🎓`, 'success', 5000);
                
                return playerData;
            } catch (error) {
                console.error('❌ خطأ في تحميل بيانات الطلاب:', error.message);
                MessageSystem.show('⚠️ لا يمكن تحميل بيانات الطلاب! تأكد من وجود ملف studentData.json', 'error', 8000);
                
                // لا توجد بيانات احتياطية - يجب استخدام البيانات الحقيقية فقط
                playerData = {};
                return playerData;
            }
        }

        // متغيرات اختيار اللاعبين المبسطة
        let selectedPlayers = [];
        let currentStudents = [];

        // ملء قائمة الصفوف (مطابق لباقي الأنشطة)
        function populateClassSelect() {
            const classSelect = document.getElementById('classSelect');
            classSelect.innerHTML = '<option value="">اختر الصف الدراسي</option>';
            
            if (playerData && Object.keys(playerData).length > 0) {
                Object.keys(playerData).forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            } else {
                // إذا لم تكن هناك بيانات، أضف رسالة تنبيه
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "لا توجد بيانات طلاب متاحة";
                option.disabled = true;
                classSelect.appendChild(option);
                
                MessageSystem.show('⚠️ لم يتم تحميل بيانات الطلاب! تأكد من وجود ملف studentData.json', 'error', 10000);
            }
            
            // إعداد حدث تغيير الصف
            classSelect.addEventListener('change', () => {
                const setupBtn = document.getElementById('setupPlayersBtn');
                setupBtn.disabled = !classSelect.value;
                
                if (classSelect.value) {
                    const studentCount = playerData[classSelect.value].length;
                    MessageSystem.show(`📚 تم اختيار "${classSelect.value}" - يحتوي على ${studentCount} طالب`, 'success', 3000);
                }
            });
        }

        // إعداد واجهة اختيار اللاعبين البسيطة
        function setupSmartPlayerSelection() {
            const classValue = document.getElementById('classSelect').value;
            console.log('🎯 إعداد اختيار اللاعبين للصف:', classValue);
            
            if (!classValue) {
                MessageSystem.show('يرجى اختيار الصف أولاً!', 'error');
                return;
            }

            if (!playerData || Object.keys(playerData).length === 0) {
                MessageSystem.show('⚠️ لا توجد بيانات طلاب! تأكد من وجود ملف studentData.json', 'error', 8000);
                return;
            }

            if (!playerData[classValue]) {
                console.error('❌ لا توجد بيانات للصف:', classValue);
                MessageSystem.show('لا توجد بيانات طلاب لهذا الصف!', 'error');
                return;
            }

            currentStudents = playerData[classValue];
            console.log(`📊 تم تحميل ${currentStudents.length} طالب من الصف ${classValue}`);
            
            if (currentStudents.length === 0) {
                MessageSystem.show('هذا الصف لا يحتوي على أي طلاب!', 'error');
                return;
            }
            
            selectedPlayers = [];
            
            // إظهار واجهة الاختيار
            const selectionDiv = document.getElementById('smartPlayerSelection');
            if (selectionDiv) {
                selectionDiv.style.display = 'block';
                console.log('✅ تم إظهار واجهة الاختيار');
            } else {
                console.error('❌ لم يتم العثور على عنصر smartPlayerSelection');
                return;
            }
            
            // تحديث عداد اللاعبين المطلوبين
            const playersNeeded = parseInt(document.getElementById('playersCount').value);
            const totalElement = document.getElementById('totalPlayersNeeded');
            if (totalElement) {
                totalElement.textContent = playersNeeded;
                console.log(`🎮 عدد اللاعبين المطلوب: ${playersNeeded}`);
            }
            
            // التأكد من أن عدد الطلاب كافٍ
            if (currentStudents.length < playersNeeded) {
                MessageSystem.show(`⚠️ الصف يحتوي على ${currentStudents.length} طالب فقط، لا يمكن اختيار ${playersNeeded} لاعبين!`, 'error', 8000);
                return;
            }
            
            // إنشاء شبكة الطلاب البسيطة
            createSimpleStudentsGrid();
            
            // التمرير إلى الواجهة
            setTimeout(() => {
                document.getElementById('smartPlayerSelection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 100);
        }

        // إنشاء شبكة الطلاب البسيطة
        function createSimpleStudentsGrid() {
            const grid = document.getElementById('studentsInteractiveGrid');
            console.log('🔍 إنشاء شبكة الطلاب:', currentStudents);
            
            if (!grid) {
                console.error('❌ لم يتم العثور على عنصر studentsInteractiveGrid');
                return;
            }
            
            if (!currentStudents || currentStudents.length === 0) {
                console.warn('⚠️ لا توجد بيانات طلاب لعرضها');
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: white; font-size: 18px; background: rgba(255,0,0,0.1); border-radius: 10px; border: 2px dashed #ff6b6b;">❌ لا توجد أسماء طلاب متاحة<br><small style="font-size: 14px; opacity: 0.8;">تأكد من وجود ملف studentData.json</small></div>';
                return;
            }
            
            grid.innerHTML = '';
            
            currentStudents.forEach((student, index) => {
                console.log(`➕ إضافة طالب: ${student.name}`);
                const card = createSimpleStudentCard(student, index);
                grid.appendChild(card);
            });
            
            console.log(`✅ تم إنشاء ${currentStudents.length} بطاقة طالب`);
            
            // تأثير ظهور متدرج
            setTimeout(() => {
                const cards = grid.querySelectorAll('.student-interactive-card');
                console.log(`🎨 تطبيق التأثيرات على ${cards.length} بطاقة`);
                
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        card.style.transition = 'all 0.3s ease-out';
                        
                        setTimeout(() => {
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 50);
                    }, index * 30);
                });
            }, 100);
        }

        // إنشاء بطاقة طالب بسيطة
        function createSimpleStudentCard(student, index) {
            const card = document.createElement('div');
            card.className = 'student-interactive-card';
            card.dataset.studentId = student.id || index;
            card.dataset.studentName = student.name;
            
            card.innerHTML = `
                <div class="student-avatar">
                    ${student.name.charAt(0)}
                </div>
                <div class="student-name">${student.name}</div>
                <div class="student-status">
                    <i class="fas fa-plus-circle"></i>
                    <span>انقر للاختيار</span>
                </div>
            `;
            
            // إضافة حدث النقر
            card.addEventListener('click', () => toggleSimpleStudentSelection(card, student));
            
            return card;
        }

        // تبديل اختيار الطالب البسيط
        function toggleSimpleStudentSelection(card, student) {
            const playersNeeded = parseInt(document.getElementById('totalPlayersNeeded').textContent);
            const isSelected = selectedPlayers.some(p => p.id === (student.id || student.name));
            
            if (isSelected) {
                // إزالة الطالب
                selectedPlayers = selectedPlayers.filter(p => p.id !== (student.id || student.name));
                card.classList.remove('selected');
                
                // تحديث حالة البطاقة
                const statusElement = card.querySelector('.student-status');
                statusElement.innerHTML = `
                    <i class="fas fa-plus-circle"></i>
                    <span>انقر للاختيار</span>
                `;
                
                soundSystem.play('Click');
            } else {
                // إضافة طالب
                if (selectedPlayers.length >= playersNeeded) {
                    MessageSystem.show(`يمكن اختيار ${playersNeeded} لاعبين فقط!`, 'error');
                    
                    // تأثير اهتزاز للبطاقة
                    card.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        card.style.animation = '';
                    }, 500);
                    return;
                }
                
                selectedPlayers.push({
                    id: student.id || student.name,
                    name: student.name
                });
                card.classList.add('selected');
                
                // تحديث حالة البطاقة
                const statusElement = card.querySelector('.student-status');
                statusElement.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>تم الاختيار</span>
                `;
                
                soundSystem.play('select');
                
                // تأثير انفجار الكونفيتي عند اكتمال الاختيار
                if (selectedPlayers.length === playersNeeded) {
                    confetti({
                        particleCount: 50,
                        spread: 50,
                        origin: { y: 0.7 }
                    });
                    
                    MessageSystem.show('🎉 تم اختيار جميع اللاعبين! سيتم إعداد اللعبة تلقائياً...', 'success');
                    
                    // إخفاء واجهة الاختيار تلقائياً بعد ثانيتين
                    setTimeout(() => {
                        confirmPlayerSelection();
                    }, 2000);
                }
            }
            
            updateSimpleSelectionUI();
        }

        // تحديث واجهة الاختيار البسيطة
        function updateSimpleSelectionUI() {
            const selectedCount = selectedPlayers.length;
            const totalNeeded = parseInt(document.getElementById('totalPlayersNeeded').textContent);
            
            // تحديث العداد
            document.getElementById('selectedPlayersCount').textContent = selectedCount;
            
            // تحديث شريط التقدم
            const progress = (selectedCount / totalNeeded) * 100;
            document.getElementById('selectionProgress').style.width = `${progress}%`;
            
            // تحديث زر التأكيد
            const confirmBtn = document.getElementById('confirmPlayerSelection');
            confirmBtn.disabled = selectedCount !== totalNeeded;
            
            // تحديث معاينة اللاعبين المختارين
            updateSimpleSelectedPlayersPreview();
        }

        // تحديث معاينة اللاعبين المختارين البسيطة
        function updateSimpleSelectedPlayersPreview() {
            const previewContainer = document.getElementById('selectedPlayersList');
            
            if (selectedPlayers.length === 0) {
                previewContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-plus"></i>
                        <p>انقر على الطلاب لاختيارهم</p>
                    </div>
                `;
                return;
            }
            
            previewContainer.innerHTML = '';
            selectedPlayers.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'selected-player-card';
                playerCard.innerHTML = `
                    <button class="remove-btn" onclick="removeSelectedPlayer('${player.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="student-avatar" style="width: 40px; height: 40px; margin: 0 auto 10px;">
                        ${player.name.charAt(0)}
                    </div>
                    <div class="student-name" style="font-size: 0.9rem;">${player.name}</div>
                    <div class="player-role">لاعب ${index + 1}</div>
                `;
                previewContainer.appendChild(playerCard);
            });
        }

        // إزالة لاعب مختار
        function removeSelectedPlayer(playerId) {
            selectedPlayers = selectedPlayers.filter(p => p.id !== playerId);
            
            // إزالة التحديد من البطاقة
            const cards = document.querySelectorAll('.student-interactive-card');
            cards.forEach(card => {
                if (card.dataset.studentId === playerId || card.dataset.studentName === playerId) {
                    card.classList.remove('selected');
                    
                    // تحديث حالة البطاقة
                    const statusElement = card.querySelector('.student-status');
                    statusElement.innerHTML = `
                        <i class="fas fa-plus-circle"></i>
                        <span>انقر للاختيار</span>
                    `;
                }
            });
            
            updateSimpleSelectionUI();
            soundSystem.play('Click');
        }

        // تأكيد اختيار اللاعبين
        function confirmPlayerSelection() {
            if (selectedPlayers.length === 0) {
                MessageSystem.show('يرجى اختيار اللاعبين أولاً!', 'error');
                return;
            }
            
            // إعداد اللعبة
            gameState.players = selectedPlayers.map((player, index) => ({
                name: player.name,
                money: 1500,
                position: 0,
                properties: []
            }));
            
            gameState.gameStarted = false;
            gameState.currentPlayer = 0;
            
            // إخفاء واجهة الاختيار مع تأثير انتقالي
            const selectionDiv = document.getElementById('smartPlayerSelection');
            selectionDiv.style.transform = 'scale(0.95)';
            selectionDiv.style.opacity = '0';
            
            setTimeout(() => {
                selectionDiv.style.display = 'none';
                selectionDiv.style.transform = 'scale(1)';
                selectionDiv.style.opacity = '1';
            }, 300);
            
            // تفعيل زر بدء اللعبة
            document.getElementById('startGameBtn').disabled = false;
            
            // تحديث عرض اللاعبين
            updatePlayersDisplay();
            
            // إشعار بالجاهزية للعب
            MessageSystem.show(`🎮 تم إعداد ${selectedPlayers.length} لاعبين بنجاح! اللعبة جاهزة للبدء`, 'success', 5000);
            soundSystem.play('win');
            
            // تأثير الكونفيتي الكبير
            confetti({
                particleCount: 200,
                spread: 120,
                origin: { y: 0.6 }
            });
            
            // التمرير إلى أزرار التحكم
            setTimeout(() => {
                document.querySelector('.game-controls').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 500);
        }

        // إلغاء اختيار اللاعبين
        function cancelPlayerSelection() {
            const selectionDiv = document.getElementById('smartPlayerSelection');
            selectionDiv.style.transform = 'scale(0.95)';
            selectionDiv.style.opacity = '0';
            
            setTimeout(() => {
                selectionDiv.style.display = 'none';
                selectionDiv.style.transform = 'scale(1)';
                selectionDiv.style.opacity = '1';
            }, 300);
            
            selectedPlayers = [];
            MessageSystem.show('تم إلغاء اختيار اللاعبين', 'info');
        }

        // مسح الاختيار الحالي
        function clearSelection() {
            selectedPlayers = [];
            
            // إزالة التحديد من جميع البطاقات
            const cards = document.querySelectorAll('.student-interactive-card');
            cards.forEach(card => {
                card.classList.remove('selected');
                
                // تحديث حالة البطاقة
                const statusElement = card.querySelector('.student-status');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <i class="fas fa-plus-circle"></i>
                        <span>انقر للاختيار</span>
                    `;
                }
            });
            
            updateSimpleSelectionUI();
            MessageSystem.show('تم مسح جميع الاختيارات', 'info');
            soundSystem.play('Click');
        }

        // بدء اللعبة مع الطلاب المختارين
        function startGameWithStudents() {
            const classValue = document.getElementById('classSelect').value;
            const playersCount = parseInt(document.getElementById('playersCount').value);

            if (!classValue) {
                MessageSystem.show('يرجى اختيار الصف أولاً!', 'error');
                return;
            }

            const studentsInClass = playerData[classValue];
            if (studentsInClass.length < playersCount) {
                MessageSystem.show(`الصف يحتوي على ${studentsInClass.length} طالب فقط، لا يمكن اختيار ${playersCount} لاعبين!`, 'error');
                return;
            }

            // اختيار طلاب عشوائيين من الصف
            const shuffled = [...studentsInClass].sort(() => 0.5 - Math.random());
            const selectedStudents = shuffled.slice(0, playersCount);

            // إعداد اللاعبين
            gameState.players = selectedStudents.map((student, index) => ({
                name: student.name,
                money: 1500,
                position: 0,
                properties: []
            }));

            gameState.gameStarted = true;
            gameState.currentPlayer = 0;
            
            // تحديث أزرار التحكم
            document.getElementById('startGameBtn').disabled = true;
            document.getElementById('rollDice').disabled = false;
            document.getElementById('endTurn').disabled = false;
            
            updatePlayersDisplay();
            MessageSystem.show(`بدأت اللعبة مع ${playersCount} لاعبين! حظاً موفقاً!`, 'success');
            soundSystem.play('win');
        }

        function showRules() {
            document.getElementById('rulesModal').style.display = 'block';
        }

        // ===========================================
        // إنشاء لوحة اللعبة
        // ===========================================
        function createGameBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';

            omanProperties.forEach((property, index) => {
                const square = document.createElement('div');
                square.className = `board-square ${property.color} ${index % 10 === 0 ? 'corner-square' : 'side-square'} square-${index}`;
                square.id = `square-${index}`;
                square.innerHTML = `
                    <div class="property-name">${property.name}</div>
                    ${property.price > 0 ? `<div class="property-price">${property.price} ر.ع</div>` : ''}
                `;
                
                square.addEventListener('click', () => showPropertyInfo(property));
                board.appendChild(square);
            });
        }

        // ===========================================
        // معلومات العقار
        // ===========================================
        function showPropertyInfo(property) {
            const modal = document.getElementById('propertyModal');
            const propertyInfo = document.getElementById('propertyInfo');
            
            let infoHTML = `
                <h2><i class="fas fa-building"></i> ${property.name}</h2>
                <div style="margin-top: 20px;">
            `;

            if (property.type === 'property') {
                infoHTML += `
                    <p><strong>النوع:</strong> عقار</p>
                    <p><strong>السعر:</strong> ${property.price} ريال عُماني</p>
                    <p><strong>المجموعة:</strong> ${getGroupName(property.color)}</p>
                    <h3>الإيجارات:</h3>
                    <ul>
                        <li>أرض فارغة: ${property.rent[0]} ر.ع</li>
                        <li>منزل واحد: ${property.rent[1]} ر.ع</li>
                        <li>منزلان: ${property.rent[2]} ر.ع</li>
                        <li>ثلاثة منازل: ${property.rent[3]} ر.ع</li>
                        <li>أربعة منازل: ${property.rent[4]} ر.ع</li>
                        <li>فندق: ${property.rent[5]} ر.ع</li>
                    </ul>
                `;
            } else if (property.type === 'airport') {
                infoHTML += `
                    <p><strong>النوع:</strong> مطار</p>
                    <p><strong>السعر:</strong> ${property.price} ريال عُماني</p>
                    <h3>الإيجارات:</h3>
                    <ul>
                        <li>مطار واحد: ${property.rent[0]} ر.ع</li>
                        <li>مطاران: ${property.rent[1]} ر.ع</li>
                        <li>ثلاثة مطارات: ${property.rent[2]} ر.ع</li>
                        <li>أربعة مطارات: ${property.rent[3]} ر.ع</li>
                    </ul>
                `;
            } else if (property.type === 'utility') {
                infoHTML += `
                    <p><strong>النوع:</strong> مرفق عام</p>
                    <p><strong>السعر:</strong> ${property.price} ريال عُماني</p>
                    <p><strong>الإيجار:</strong> 4 مرات نتيجة النرد (مرفق واحد) أو 10 مرات (مرفقان)</p>
                `;
            } else {
                infoHTML += `<p><strong>النوع:</strong> ${getSquareTypeName(property.type)}</p>`;
            }

            infoHTML += '</div>';
            propertyInfo.innerHTML = infoHTML;
            modal.style.display = 'block';
        }

        function getGroupName(color) {
            const groups = {
                'brown': 'المجموعة البنية',
                'light-blue': 'المجموعة الزرقاء الفاتحة',
                'pink': 'المجموعة الوردية',
                'orange': 'المجموعة البرتقالية',
                'red': 'المجموعة الحمراء',
                'yellow': 'المجموعة الصفراء',
                'green': 'المجموعة الخضراء',
                'dark-blue': 'المجموعة الزرقاء الداكنة',
                'railroad': 'المطارات',
                'utility': 'المرافق العامة'
            };
            return groups[color] || 'غير محدد';
        }

        function getSquareTypeName(type) {
            const types = {
                'start': 'نقطة البداية',
                'jail': 'السجن/الزيارة',
                'free': 'موقف مجاني',
                'go-to-jail': 'اذهب للسجن',
                'tax': 'ضريبة',
                'chance': 'الفرصة',
                'community': 'صندوق المجتمع'
            };
            return types[type] || 'غير محدد';
        }

        // ===========================================
        // إدارة اللاعبين
        // ===========================================
        function initializePlayers(playerNames = null) {
            if (playerNames && playerNames.length > 0) {
                // استخدام أسماء مخصصة
                gameState.players = playerNames.map((name, index) => ({
                    name: name || `اللاعب ${index + 1}`,
                    money: 1500,
                    position: 0,
                    properties: []
                }));
            } else {
                // إنشاء لاعبين افتراضيين
                gameState.players = [
                    { name: 'اللاعب الأول', money: 1500, position: 0, properties: [] },
                    { name: 'اللاعب الثاني', money: 1500, position: 0, properties: [] }
                ];
            }
            
            updatePlayersDisplay();
            MessageSystem.show(`تم إعداد ${gameState.players.length} لاعبين`, 'success');
        }

        function updatePlayersDisplay() {
            const playersInfo = document.getElementById('playersInfo');
            playersInfo.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${index === gameState.currentPlayer ? 'current-player' : ''}`;
                playerCard.innerHTML = `
                    <h3>${player.name} ${index === gameState.currentPlayer ? '👑' : ''}</h3>
                    <div class="player-info">
                        <span>المال:</span>
                        <span>${player.money} ر.ع</span>
                    </div>
                    <div class="player-info">
                        <span>الموقع:</span>
                        <span>${omanProperties[player.position].name}</span>
                    </div>
                    <div class="player-info">
                        <span>العقارات:</span>
                        <span>${player.properties.length}</span>
                    </div>
                `;
                playersInfo.appendChild(playerCard);
            });
        }

        // ===========================================
        // ميكانيكية اللعبة الاحترافية
        // ===========================================
        function rollDice() {
            if (!gameState.gameStarted) {
                MessageSystem.show('يجب بدء اللعبة أولاً!', 'error');
                return;
            }

            const player = gameState.players[gameState.currentPlayer];
            
            // تعطيل زر النرد أثناء الرمي
            document.getElementById('rollDice').disabled = true;
            
            // تأثير صوتي للترقب
            soundSystem.play('countdown');
            
            // أنيميشن رمي النرد
            showDiceAnimation(() => {
                const dice1 = Math.floor(Math.random() * 6) + 1;
                const dice2 = Math.floor(Math.random() * 6) + 1;
                const total = dice1 + dice2;
                const isDouble = dice1 === dice2;

                gameState.lastRoll = { dice1, dice2, total };

                // تحديث عرض النرد
                updateDiceDisplay(dice1, dice2);
                
                // تأثيرات صوتية مختلفة حسب النتيجة
                if (isDouble) {
                    soundSystem.play('bell');
                    gameState.doubles++;
                } else {
                    soundSystem.play('dice');
                    gameState.doubles = 0;
                }

                // عرض النتيجة مع تأثيرات
                let message = `🎲 ${player.name}: ${dice1} + ${dice2} = ${total}`;
                if (isDouble) {
                    message += ' - زوجي! 🎉';
                    confetti({
                        particleCount: 30,
                        spread: 60,
                        origin: { y: 0.8 }
                    });
                }
                
                MessageSystem.show(message, isDouble ? 'success' : 'dice', 4000);

                // فحص الزوجي الثلاثي (سجن)
                if (gameState.doubles >= 3) {
                    MessageSystem.show('🚨 ثلاثة زوجيات متتالية! اذهب للسجن!', 'error', 5000, true);
                    soundSystem.play('lose');
                    handleGoToJail(gameState.currentPlayer);
                    gameState.doubles = 0;
                    document.getElementById('rollDice').disabled = false;
                    return;
                }

                // فحص إنجاز النرد المحظوظ
                AchievementSystem.checkAchievement(player, 'lucky_roller', { consecutiveDoubles: gameState.doubles });

                // تحريك اللاعب
                setTimeout(() => {
                    movePlayer(gameState.currentPlayer, total);
                    
                    // إعادة تفعيل زر النرد
                    document.getElementById('rollDice').disabled = false;
                    
                    // إذا لم يكن زوجي، يمكن إنهاء الدور
                    if (!isDouble) {
                        document.getElementById('endTurn').disabled = false;
                    }
                }, 1000);
            });
        }

        function showDiceAnimation(callback) {
            const diceContainer = document.getElementById('diceContainer') || createDiceContainer();
            
            // أنيميشن الدوران
            diceContainer.classList.add('rolling');
            
            // محاكاة الرمي لمدة ثانيتين
            let rollCount = 0;
            const rollInterval = setInterval(() => {
                const tempDice1 = Math.floor(Math.random() * 6) + 1;
                const tempDice2 = Math.floor(Math.random() * 6) + 1;
                updateDiceDisplay(tempDice1, tempDice2);
                rollCount++;
                
                if (rollCount >= 20) {
                    clearInterval(rollInterval);
                    diceContainer.classList.remove('rolling');
                    callback();
                }
            }, 100);
        }

        function createDiceContainer() {
            const container = document.createElement('div');
            container.id = 'diceContainer';
            container.innerHTML = `
                <div class="dice-wrapper">
                    <div class="dice" id="dice1">⚀</div>
                    <div class="dice" id="dice2">⚀</div>
                </div>
            `;
            container.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1000;
                pointer-events: none;
            `;
            document.body.appendChild(container);
            return container;
        }

        function updateDiceDisplay(dice1, dice2) {
            const diceSymbols = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];
            const dice1Element = document.getElementById('dice1');
            const dice2Element = document.getElementById('dice2');
            
            if (dice1Element && dice2Element) {
                dice1Element.textContent = diceSymbols[dice1 - 1];
                dice2Element.textContent = diceSymbols[dice2 - 1];
            }
        }

        function movePlayer(playerIndex, steps) {
            const player = gameState.players[playerIndex];
            const oldPosition = player.position;
            
            // حساب الموقع الجديد
            let newPosition = (player.position + steps) % 40;
            let passedStart = newPosition < oldPosition;
            
            // أنيميشن الحركة التدريجية
            animatePlayerMovement(playerIndex, oldPosition, steps, () => {
                player.position = newPosition;
                
                // فحص المرور بنقطة البداية
                if (passedStart) {
                    player.money += 200;
                    MessageSystem.showMoneyTransaction(player.name, 200, true);
                    MessageSystem.show('🎯 مررت بنقطة البداية! حصلت على 200 ر.ع', 'success', 4000);
                    soundSystem.play('bonus');
                    
                    // تأثير خاص للمرور بالبداية
                    confetti({
                        particleCount: 80,
                        spread: 90,
                        origin: { y: 0.7 },
                        colors: ['#00FF00', '#32CD32', '#7FFF00']
                    });
                }

                updatePlayersDisplay();
                updatePlayerPosition(playerIndex);
                handleSquareLanding(playerIndex, player.position);
            });
        }

        function animatePlayerMovement(playerIndex, startPos, steps, callback) {
            let currentStep = 0;
            const player = gameState.players[playerIndex];
            
            const moveStep = () => {
                if (currentStep >= steps) {
                    callback();
                    return;
                }
                
                currentStep++;
                const tempPosition = (startPos + currentStep) % 40;
                
                // تحديث الموقع المؤقت
                updatePlayerPosition(playerIndex, tempPosition);
                
                // تأثير صوتي للحركة
                if (currentStep % 2 === 0) {
                    soundSystem.play('select', 0.3);
                }
                
                // تأثير بصري للمربع الحالي
                highlightSquare(tempPosition);
                
                setTimeout(moveStep, 300); // سرعة الحركة
            };
            
            moveStep();
        }

        function updatePlayerPosition(playerIndex, position = null) {
            const player = gameState.players[playerIndex];
            const pos = position !== null ? position : player.position;
            const square = document.getElementById(`square-${pos}`);
            
            if (square) {
                // إزالة اللاعب من المواقع السابقة
                document.querySelectorAll('.player-token').forEach(token => {
                    if (token.dataset.player === playerIndex.toString()) {
                        token.remove();
                    }
                });
                
                // إضافة اللاعب للموقع الجديد
                const token = document.createElement('div');
                token.className = 'player-token';
                token.dataset.player = playerIndex;
                token.style.cssText = `
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, 
                        ${getPlayerColor(playerIndex)}, 
                        ${getDarkerColor(getPlayerColor(playerIndex))});
                    border: 2px solid white;
                    position: absolute;
                    bottom: ${5 + (playerIndex * 25)}px;
                    right: 5px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    animation: bounceIn 0.5s ease-out;
                    z-index: 100;
                `;
                token.textContent = (playerIndex + 1);
                token.style.color = 'white';
                token.style.fontSize = '12px';
                token.style.fontWeight = 'bold';
                token.style.display = 'flex';
                token.style.alignItems = 'center';
                token.style.justifyContent = 'center';
                
                square.appendChild(token);
            }
        }

        function highlightSquare(position) {
            // إزالة التمييز السابق
            document.querySelectorAll('.square-highlight').forEach(el => el.classList.remove('square-highlight'));
            
            // إضافة التمييز للمربع الحالي
            const square = document.getElementById(`square-${position}`);
            if (square) {
                square.classList.add('square-highlight');
                setTimeout(() => square.classList.remove('square-highlight'), 300);
            }
        }

        function getPlayerColor(playerIndex) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#F4A460', '#98D8C8'];
            return colors[playerIndex % colors.length];
        }

        function getDarkerColor(color) {
            // تحويل اللون لدرجة أغمق
            const hex = color.replace('#', '');
            const r = Math.max(0, parseInt(hex.substr(0, 2), 16) - 50);
            const g = Math.max(0, parseInt(hex.substr(2, 2), 16) - 50);
            const b = Math.max(0, parseInt(hex.substr(4, 2), 16) - 50);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function handleSquareLanding(playerIndex, position) {
            const player = gameState.players[playerIndex];
            const property = omanProperties[position];

            // تأثير بصري خاص للنزول
            const square = document.getElementById(`square-${position}`);
            if (square) {
                square.classList.add('landing-effect');
                setTimeout(() => square.classList.remove('landing-effect'), 1000);
            }

            // رسالة الهبوط مع تأثير صوتي
            MessageSystem.show(`🎯 ${player.name} هبط على ${property.name}`, 'info', 3000);
            soundSystem.play('bell', 0.5);

            switch (property.type) {
                case 'property':
                case 'airport':
                case 'utility':
                    handlePropertyLanding(playerIndex, property);
                    break;
                case 'tax':
                    handleTax(playerIndex, property.price);
                    break;
                case 'chance':
                    handleChanceCard(playerIndex);
                    break;
                case 'community':
                    handleCommunityCard(playerIndex);
                    break;
                case 'go-to-jail':
                    handleGoToJail(playerIndex);
                    break;
                case 'start':
                    // تأثير خاص للهبوط على البداية
                    confetti({
                        particleCount: 60,
                        spread: 80,
                        origin: { y: 0.8 }
                    });
                    break;
                case 'jail':
                    MessageSystem.show('🏛️ مجرد زيارة للسجن!', 'info');
                    break;
                case 'free':
                    MessageSystem.show('🅿️ موقف مجاني - استرح!', 'success');
                    soundSystem.play('bonus', 0.7);
                    break;
            }

            // تحديث اللوحة القيادية
            LeaderboardSystem.updateLeaderboard();
        }

        function handlePropertyLanding(playerIndex, property) {
            const player = gameState.players[playerIndex];
            
            // التحقق من ملكية العقار
            const owner = gameState.players.find(p => p.properties.includes(property.id));
            
            if (!owner) {
                // العقار متاح للشراء
                showPropertyPurchaseDialog(player, property);
            } else if (owner !== player) {
                // دفع إيجار
                const rent = calculateRent(property, owner);
                handleRentPayment(player, owner, property, rent);
            } else {
                // العقار مملوك للاعب نفسه
                MessageSystem.show(`🏠 ${property.name} مملوك لك بالفعل!`, 'info');
                soundSystem.play('select', 0.5);
            }
        }

        function showPropertyPurchaseDialog(player, property) {
            if (player.money < property.price) {
                MessageSystem.show(`💸 ليس لديك مال كافٍ لشراء ${property.name}! تحتاج ${property.price} ر.ع`, 'error', 5000);
                soundSystem.play('lose');
                return;
            }

            // إنشاء نافذة شراء تفاعلية
            const modal = document.createElement('div');
            modal.className = 'purchase-modal';
            modal.innerHTML = `
                <div class="purchase-content">
                    <h2>🏠 شراء ${property.name}</h2>
                    <div class="property-details">
                        <p><strong>السعر:</strong> ${property.price} ر.ع</p>
                        <p><strong>المالك الحالي:</strong> غير مملوك</p>
                        <p><strong>رصيدك:</strong> ${player.money} ر.ع</p>
                        <p><strong>الرصيد بعد الشراء:</strong> ${player.money - property.price} ر.ع</p>
                    </div>
                    <div class="purchase-buttons">
                        <button onclick="purchaseProperty(${playerIndex}, ${property.id})" class="btn-purchase">
                            💰 شراء
                        </button>
                        <button onclick="closePurchaseModal()" class="btn-decline">
                            ❌ رفض
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;

            document.body.appendChild(modal);
            soundSystem.play('notification');
        }

        function purchaseProperty(playerIndex, propertyId) {
            const player = gameState.players[playerIndex];
            const property = omanProperties[propertyId];
            
            player.money -= property.price;
            player.properties.push(propertyId);
            
            // إغلاق النافذة
            closePurchaseModal();
            
            // رسائل وتأثيرات النجاح
            MessageSystem.showPropertyPurchase(player.name, property.name, property.price);
            soundSystem.playSequence(['buy', 'bonus'], 300);
            
            // تأثير بصري للشراء
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.7 },
                colors: ['#FFD700', '#FFA500', '#FF8C00']
            });

            // فحص الإنجازات
            AchievementSystem.checkAchievement(player, 'first_property');
            AchievementSystem.checkAchievement(player, 'millionaire');
            AchievementSystem.checkAchievement(player, 'monopoly_master');

            updatePlayersDisplay();
        }

        function closePurchaseModal() {
            const modal = document.querySelector('.purchase-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-in';
                setTimeout(() => modal.remove(), 300);
            }
        }

        function handleRentPayment(payer, receiver, property, rent) {
            payer.money -= rent;
            receiver.money += rent;
            
            MessageSystem.showRentPayment(payer.name, receiver.name, property.name, rent);
            soundSystem.play('lose');
            
            // تأثير بصري لدفع الإيجار
            const payerElement = document.querySelector(`[data-player="${gameState.players.indexOf(payer)}"]`);
            if (payerElement) {
                payerElement.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => payerElement.style.animation = '', 500);
            }

            updatePlayersDisplay();
        }

        function calculateRent(property, owner) {
            if (property.type === 'property') {
                return property.rent[0]; // إيجار أساسي (يمكن تطويره لاحقاً)
            } else if (property.type === 'airport') {
                const airportsOwned = owner.properties.filter(id => 
                    omanProperties[id].type === 'airport'
                ).length;
                return property.rent[airportsOwned - 1];
            } else if (property.type === 'utility') {
                const utilitiesOwned = owner.properties.filter(id => 
                    omanProperties[id].type === 'utility'
                ).length;
                return (utilitiesOwned === 1 ? 4 : 10) * (Math.floor(Math.random() * 6) + 1 + Math.floor(Math.random() * 6) + 1);
            }
            return 0;
        }

        function handleTax(playerIndex, amount) {
            const player = gameState.players[playerIndex];
            player.money -= amount;
            MessageSystem.show(`دفعت ${amount} ر.ع ضريبة`, 'error');
            soundSystem.play('lose');
            updatePlayersDisplay();
        }

        // بطاقات الصدفة والخزانة العامة
        const chanceCards = [
            { text: "🎉 تقدم إلى البداية واحصل على 200 ر.ع", action: "goToStart" },
            { text: "🏠 تقدم إلى مسقط العاصمة", action: "goToProperty", property: 1 },
            { text: "💰 احصل على 150 ر.ع مكافأة", action: "money", amount: 150 },
            { text: "📄 ادفع 50 ر.ع ضريبة", action: "money", amount: -50 },
            { text: "🚗 تقدم إلى أقرب مطار", action: "goToNearestAirport" },
            { text: "⬅️ ارجع 3 مربعات", action: "moveBack", spaces: 3 },
            { text: "🏛️ اذهب إلى السجن مباشرة", action: "goToJail" },
            { text: "🎁 احصل على 100 ر.ع من كل لاعب", action: "collectFromPlayers", amount: 100 },
            { text: "🔧 ادفع 40 ر.ع لكل منزل و 115 ر.ع لكل فندق", action: "payForBuildings" },
            { text: "🎯 تقدم إلى صلالة", action: "goToProperty", property: 11 },
            { text: "🏦 احصل على 200 ر.ع من البنك", action: "money", amount: 200 },
            { text: "🚫 ادفع غرامة 15 ر.ع", action: "money", amount: -15 }
        ];

        const communityCards = [
            { text: "🎓 حصلت على منحة دراسية - احصل على 200 ر.ع", action: "money", amount: 200 },
            { text: "🏥 ادفع فاتورة المستشفى 100 ر.ع", action: "money", amount: -100 },
            { text: "📈 أرباح استثمارك - احصل على 50 ر.ع", action: "money", amount: 50 },
            { text: "🎂 عيد ميلادك - احصل على 10 ر.ع من كل لاعب", action: "collectFromPlayers", amount: 10 },
            { text: "🚗 غرامة سرعة - ادفع 50 ر.ع", action: "money", amount: -50 },
            { text: "💼 مكافأة خدمات - احصل على 100 ر.ع", action: "money", amount: 100 },
            { text: "🏛️ اذهب إلى السجن مباشرة", action: "goToJail" },
            { text: "🎉 تقدم إلى البداية واحصل على 200 ر.ع", action: "goToStart" },
            { text: "🏠 ادفع 40 ر.ع لكل منزل و 115 ر.ع لكل فندق", action: "payForBuildings" },
            { text: "📄 ضريبة الدخل - ادفع 200 ر.ع", action: "money", amount: -200 },
            { text: "🎁 وراثة - احصل على 100 ر.ع", action: "money", amount: 100 },
            { text: "💳 خطأ بنكي لصالحك - احصل على 75 ر.ع", action: "money", amount: 75 }
        ];

        function handleChanceCard(playerIndex) {
            const card = chanceCards[Math.floor(Math.random() * chanceCards.length)];
            showCardModal(playerIndex, card, 'chance');
        }

        function handleCommunityCard(playerIndex) {
            const card = communityCards[Math.floor(Math.random() * communityCards.length)];
            showCardModal(playerIndex, card, 'community');
        }

        function showCardModal(playerIndex, card, type) {
            const player = gameState.players[playerIndex];
            const cardTitle = type === 'chance' ? '🎲 بطاقة الصدفة' : '🏛️ صندوق الخزانة العامة';
            const cardColor = type === 'chance' ? '#FF6B35' : '#4ECDC4';

            const modal = document.createElement('div');
            modal.className = 'card-modal';
            modal.innerHTML = `
                <div class="card-content" style="border-color: ${cardColor}">
                    <h2 style="color: ${cardColor}">${cardTitle}</h2>
                    <div class="card-text">
                        <p>${card.text}</p>
                    </div>
                    <div class="card-player">
                        <strong>${player.name}</strong>
                    </div>
                    <button onclick="executeCardAction(${playerIndex}, ${JSON.stringify(card).replace(/"/g, '&quot;')}, '${type}')" 
                            class="btn-execute" style="background: ${cardColor}">
                        ✨ تنفيذ
                    </button>
                </div>
            `;

            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: cardSlideIn 0.5s ease-out;
            `;

            document.body.appendChild(modal);
            soundSystem.play('reveal');
        }

        function executeCardAction(playerIndex, cardData, type) {
            const player = gameState.players[playerIndex];
            const card = JSON.parse(cardData.replace(/&quot;/g, '"'));

            // إغلاق النافذة
            const modal = document.querySelector('.card-modal');
            if (modal) modal.remove();

            switch (card.action) {
                case 'money':
                    handleMoneyChange(playerIndex, card.amount);
                    break;
                case 'goToStart':
                    movePlayerToPosition(playerIndex, 0);
                    player.money += 200; // مكافأة المرور من البداية
                    MessageSystem.show(`🎉 ${player.name} وصل للبداية وحصل على 200 ر.ع!`, 'success');
                    break;
                case 'goToProperty':
                    movePlayerToPosition(playerIndex, card.property);
                    break;
                case 'goToJail':
                    handleGoToJail(playerIndex);
                    break;
                case 'goToNearestAirport':
                    moveToNearestAirport(playerIndex);
                    break;
                case 'moveBack':
                    movePlayerBack(playerIndex, card.spaces);
                    break;
                case 'collectFromPlayers':
                    collectFromAllPlayers(playerIndex, card.amount);
                    break;
                case 'payForBuildings':
                    payForBuildings(playerIndex);
                    break;
            }

            updatePlayersDisplay();
        }

        function handleMoneyChange(playerIndex, amount) {
            const player = gameState.players[playerIndex];
            player.money += amount;

            if (amount > 0) {
                MessageSystem.show(`💰 ${player.name} حصل على ${amount} ر.ع!`, 'success');
                soundSystem.play('bonus');
                confetti({
                    particleCount: 50,
                    spread: 60,
                    origin: { y: 0.8 },
                    colors: ['#FFD700', '#32CD32']
                });
            } else {
                MessageSystem.show(`💸 ${player.name} دفع ${Math.abs(amount)} ر.ع!`, 'error');
                soundSystem.play('lose');
            }
        }

        function moveToNearestAirport(playerIndex) {
            const player = gameState.players[playerIndex];
            const airports = [5, 15, 25, 35]; // مواقع المطارات
            let nearestAirport = airports[0];
            let minDistance = Math.abs(player.position - airports[0]);

            airports.forEach(airport => {
                const distance = (airport - player.position + 40) % 40;
                if (distance < minDistance) {
                    nearestAirport = airport;
                    minDistance = distance;
                }
            });

            movePlayerToPosition(playerIndex, nearestAirport);
        }

        function collectFromAllPlayers(playerIndex, amount) {
            const player = gameState.players[playerIndex];
            let totalCollected = 0;

            gameState.players.forEach((otherPlayer, index) => {
                if (index !== playerIndex) {
                    const payment = Math.min(amount, otherPlayer.money);
                    otherPlayer.money -= payment;
                    totalCollected += payment;
                }
            });

            player.money += totalCollected;
            MessageSystem.show(`💰 ${player.name} جمع ${totalCollected} ر.ع من اللاعبين!`, 'success');
            soundSystem.play('win');
        }

        function handleSpecialCard(playerIndex, cardType) {
            if (cardType === 'chance') {
                handleChanceCard(playerIndex);
            } else {
                handleCommunityCard(playerIndex);
            }
        }

        function movePlayerBack(playerIndex, spaces) {
            const player = gameState.players[playerIndex];
            const newPosition = (player.position - spaces + 40) % 40;
            movePlayerToPosition(playerIndex, newPosition);
        }

        function movePlayerToPosition(playerIndex, targetPosition) {
            const player = gameState.players[playerIndex];
            const oldPosition = player.position;
            
            // إذا مر من البداية، احصل على 200 ر.ع
            if (targetPosition < oldPosition && targetPosition !== 0) {
                player.money += 200;
                MessageSystem.show(`💰 ${player.name} مر من البداية وحصل على 200 ر.ع!`, 'success');
            }
            
            player.position = targetPosition;
            animatePlayerMovement(playerIndex, oldPosition, targetPosition, () => {
                handleSquareLanding(playerIndex, targetPosition);
            });
        }

        function payForBuildings(playerIndex) {
            const player = gameState.players[playerIndex];
            // حساب تكلفة المباني (سيتم تطوير نظام البناء لاحقاً)
            const houseCost = 40;
            const hotelCost = 115;
            
            // للآن، سيتم دفع مبلغ ثابت
            const totalCost = 100;
            player.money -= totalCost;
            
            MessageSystem.show(`🏠 ${player.name} دفع ${totalCost} ر.ع رسوم صيانة!`, 'error');
            soundSystem.play('lose');
        }

        function handleTax(playerIndex, amount) {
            const player = gameState.players[playerIndex];
            player.money -= amount;
            
            MessageSystem.show(`📄 ${player.name} دفع ${amount} ر.ع ضريبة!`, 'error');
            soundSystem.play('lose');
            
            // تأثير بصري للضريبة
            const playerElement = document.querySelector(`[data-player="${playerIndex}"]`);
            if (playerElement) {
                playerElement.classList.add('shake');
                setTimeout(() => playerElement.classList.remove('shake'), 500);
            }
            
            updatePlayersDisplay();
        }

        function handleGoToJail(playerIndex) {
            const player = gameState.players[playerIndex];
            const oldPosition = player.position;
            player.position = 10; // موقع السجن
            player.inJail = true;
            player.jailTurns = 0;
            
            MessageSystem.show(`🏛️ ${player.name} ذهب إلى السجن!`, 'error');
            soundSystem.play('lose');
            
            // تحريك اللاعب إلى السجن مع تأثير خاص
            animatePlayerMovement(playerIndex, oldPosition, 10, () => {
                const jailSquare = document.getElementById('square-10');
                if (jailSquare) {
                    jailSquare.classList.add('pulse-effect');
                    setTimeout(() => jailSquare.classList.remove('pulse-effect'), 600);
                }
            });
            
            updatePlayersDisplay();
        }

        // نظام حساب الإيجار المحترف
        function calculateRent(property, owner) {
            let baseRent = property.rent;
            
            // إذا كان المالك يملك مجموعة كاملة
            if (hasMonopoly(owner, property)) {
                baseRent *= 2;
            }
            
            // إضافة تكلفة المباني (سيتم تطوير هذا لاحقاً)
            // baseRent += (property.houses * property.houseRent);
            // if (property.hotel) baseRent = property.hotelRent;
            
            return baseRent;
        }

        function hasMonopoly(player, property) {
            const colorGroup = getColorGroup(property.id);
            return colorGroup.every(propId => player.properties.includes(propId));
        }

        function getColorGroup(propertyId) {
            // مجموعات الألوان في المونوبولي العماني
            const colorGroups = {
                brown: [1, 3],
                lightBlue: [6, 8, 9],
                pink: [11, 13, 14],
                orange: [16, 18, 19],
                red: [21, 23, 24],
                yellow: [26, 27, 29],
                green: [31, 32, 34],
                blue: [37, 39]
            };
            
            for (const [color, properties] of Object.entries(colorGroups)) {
                if (properties.includes(propertyId)) {
                    return properties;
                }
            }
            return [];
        }

        // ====================================
        // نظام اللعب المحترف والتنافسي
        // ====================================

        function nextTurn() {
            // تحديث اللوحة القيادية
            LeaderboardSystem.updateLeaderboard();
            
            // فحص شرط الفوز
            const winner = checkWinCondition();
            if (winner) {
                handleGameWin(winner);
                return;
            }

            // الانتقال للاعب التالي
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            
            // إذا عاد للاعب الأول، زيادة المرحلة
            if (gameState.currentPlayer === 0) {
                gameState.currentRound++;
                MessageSystem.show(`🔄 بداية المرحلة ${gameState.currentRound}`, 'info', 3000);
                soundSystem.play('notification');
            }
            
            // تمييز اللاعب الحالي
            LeaderboardSystem.highlightCurrentPlayer();
            
            // إشعار بدور اللاعب الجديد
            const currentPlayer = gameState.players[gameState.currentPlayer];
            MessageSystem.show(`🎯 دور ${currentPlayer.name}`, 'success', 4000);
            soundSystem.play('select');
            
            // تأثير بصري لتمييز اللاعب الحالي
            highlightCurrentPlayerOnBoard();
            
            updatePlayersDisplay();
            updateGameInfo();
        }

        function checkWinCondition() {
            // فحص إذا كان هناك لاعب واحد فقط لم يفلس
            const activePlayers = gameState.players.filter(player => player.money >= 0);
            if (activePlayers.length === 1) {
                return activePlayers[0];
            }
            
            // فحص إذا وصلت اللعبة لحد زمني معين (مثلاً 20 مرحلة)
            if (gameState.currentRound >= 20) {
                // إرجاع اللاعب الأغنى
                return gameState.players.reduce((richest, player) => {
                    const playerNetWorth = LeaderboardSystem.calculateNetWorth(player);
                    const richestNetWorth = LeaderboardSystem.calculateNetWorth(richest);
                    return playerNetWorth > richestNetWorth ? player : richest;
                });
            }
            
            return null;
        }

        function handleGameWin(winner) {
            // تأثيرات الفوز الرائعة
            soundSystem.playSequence(['win', 'firework'], 1000);
            
            // عرض شاشة الفوز
            showWinnerScreen(winner);
            
            // تأثيرات بصرية للفوز
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 },
                        colors: ['#FFD700', '#FFA500', '#FF6B35', '#4ECDC4', '#45B7D1']
                    });
                }, i * 300);
            }
            
            // حفظ الإنجازات
            AchievementSystem.checkAchievement(winner, 'game_winner');
            AchievementSystem.saveProgress();
        }

        function showWinnerScreen(winner) {
            const modal = document.createElement('div');
            modal.className = 'winner-modal';
            modal.innerHTML = `
                <div class="winner-content">
                    <h1>🏆 مبروك الفوز! 🏆</h1>
                    <div class="winner-info">
                        <h2>${winner.name}</h2>
                        <p>الفائز بلعبة مونوبولي عُمان!</p>
                        <div class="winner-stats">
                            <div class="stat">
                                <span>💰 الأموال النهائية:</span>
                                <span>${winner.money} ر.ع</span>
                            </div>
                            <div class="stat">
                                <span>🏠 العقارات المملوكة:</span>
                                <span>${winner.properties.length}</span>
                            </div>
                            <div class="stat">
                                <span>📊 القيمة الصافية:</span>
                                <span>${LeaderboardSystem.calculateNetWorth(winner)} ر.ع</span>
                            </div>
                        </div>
                    </div>
                    <div class="winner-actions">
                        <button onclick="restartGame()" class="btn-restart">
                            🔄 لعبة جديدة
                        </button>
                        <button onclick="showFinalLeaderboard()" class="btn-leaderboard">
                            📊 النتائج النهائية
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.5s ease-out;
            `;
            
            document.body.appendChild(modal);
        }

        function highlightCurrentPlayerOnBoard() {
            // إزالة التمييز من جميع اللاعبين
            document.querySelectorAll('.player-token').forEach(token => {
                token.classList.remove('current-player-highlight');
            });
            
            // تمييز اللاعب الحالي على اللوحة
            const currentPlayerToken = document.querySelector(`[data-player="${gameState.currentPlayer}"]`);
            if (currentPlayerToken) {
                currentPlayerToken.classList.add('current-player-highlight');
            }
        }

        function updateGameInfo() {
            const gameInfoDiv = document.getElementById('game-info');
            if (!gameInfoDiv) return;
            
            const currentPlayer = gameState.players[gameState.currentPlayer];
            gameInfoDiv.innerHTML = `
                <div class="current-turn">
                    <h3>🎯 دور: ${currentPlayer.name}</h3>
                    <p>المرحلة: ${gameState.currentRound}</p>
                    <p>إجمالي اللاعبين: ${gameState.players.length}</p>
                </div>
            `;
        }

        function restartGame() {
            // إعادة تعيين حالة اللعبة
            gameState.currentPlayer = 0;
            gameState.currentRound = 1;
            gameState.players.forEach(player => {
                player.money = 1500;
                player.position = 0;
                player.properties = [];
                player.inJail = false;
                player.jailTurns = 0;
            });
            
            // إزالة شاشة الفوز
            const modal = document.querySelector('.winner-modal');
            if (modal) modal.remove();
            
            // إعادة تحديث الشاشة
            updatePlayersDisplay();
            LeaderboardSystem.updateLeaderboard();
            MessageSystem.show('🎮 بدأت لعبة جديدة!', 'success');
            soundSystem.play('startapp');
        }

        function showFinalLeaderboard() {
            LeaderboardSystem.showLeaderboard();
        }

        function endTurn() {
            if (!gameState.gameStarted) {
                MessageSystem.show('يجب بدء اللعبة أولاً!', 'error');
                return;
            }

            // تعطيل أزرار الدور الحالي
            document.getElementById('rollDice').disabled = true;
            document.getElementById('endTurn').disabled = true;
            
            // الانتقال للدور التالي
            nextTurn();
            
            // تفعيل زر رمي النرد للاعب الجديد
            setTimeout(() => {
                document.getElementById('rollDice').disabled = false;
            }, 1000);
        }

        // ===========================================
        // إدارة اللعبة
        // ===========================================
        function startGame() {
            if (gameState.gameStarted) {
                MessageSystem.show('اللعبة بدأت بالفعل!', 'error');
                return;
            }

            if (!gameState.players || gameState.players.length < 2) {
                MessageSystem.show('يجب إعداد اللاعبين أولاً!', 'error');
                return;
            }

            gameState.gameStarted = true;
            gameState.currentPlayer = 0;
            
            MessageSystem.show('بدأت اللعبة! حظاً موفقاً!', 'success');
            soundSystem.play('win');
            updatePlayersDisplay();
        }

        function showRules() {
            document.getElementById('rulesModal').style.display = 'block';
        }

        // ===========================================
        // معالجة الأحداث
        // ===========================================
        function setupEventListeners() {
            // أزرار التحكم الرئيسية
            document.getElementById('setupPlayersBtn').addEventListener('click', setupSmartPlayerSelection);
            document.getElementById('startGameBtn').addEventListener('click', startGameWithStudents);
            document.getElementById('rollDice').addEventListener('click', rollDice);
            document.getElementById('endTurn').addEventListener('click', endTurn);
            document.getElementById('showRules').addEventListener('click', showRules);

            // واجهة اختيار اللاعبين الذكية
            // أزرار طرق الاختيار
            // أزرار التحكم في الاختيار
            document.getElementById('confirmPlayerSelection').addEventListener('click', confirmPlayerSelection);
            document.getElementById('cancelPlayerSelection').addEventListener('click', cancelPlayerSelection);
            document.getElementById('clearSelection').addEventListener('click', clearSelection);

            // أزرار التحكم العلوية
            document.getElementById('returnToIndex').addEventListener('click', () => {
                if (confirm('هل تريد العودة للصفحة الرئيسية؟')) {
                    window.location.href = '../index.html';
                }
            });

            document.getElementById('soundToggle').addEventListener('click', () => {
                const enabled = soundSystem.toggle();
                const icon = document.querySelector('#soundToggle i');
                icon.className = enabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
                MessageSystem.show(enabled ? 'تم تشغيل الصوت' : 'تم إيقاف الصوت');
            });

            // إغلاق النوافذ المنبثقة
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', (e) => {
                    const modalId = e.target.getAttribute('data-modal');
                    document.getElementById(modalId).style.display = 'none';
                });
            });

            // إغلاق النوافذ عند النقر خارجها
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // اختصارات لوحة المفاتيح
            document.addEventListener('keydown', (e) => {
                if (e.key === ' ') {
                    e.preventDefault();
                    rollDice();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    endTurn();
                } else if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                    // إخفاء واجهة اختيار الطلاب أيضاً
                    document.getElementById('smartPlayerSelection').style.display = 'none';
                }
            });
        }

        // ===========================================
        // تهيئة اللعبة
        // ===========================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🎮 بدء تحميل مونوبولي عُمان...');

            try {
                // تحميل بيانات الطلاب
                await loadStudentData();
                
                // ملء قائمة الصفوف
                populateClassSelect();
                
                // إنشاء لوحة اللعبة
                createGameBoard();
                
                // إعداد معالجات الأحداث
                setupEventListeners();
                
                // إضافة أنماط الرسوم المتحركة والبطاقات التفاعلية
                const animationStyles = `
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            opacity: 1;
                            transform: translateX(0);
                        }
                        to {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                    }
                    
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        25% { transform: translateX(-5px); }
                        75% { transform: translateX(5px); }
                    }
                    
                    .current-player {
                        border: 3px solid var(--accent-gold) !important;
                        box-shadow: var(--shadow-glow-gold) !important;
                    }
                    
                    /* تحسين البطاقات التفاعلية */
                    .students-interactive-grid {
                        display: grid !important;
                        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important;
                        gap: 15px !important;
                        padding: 0 30px !important;
                        max-height: 500px !important;
                        overflow-y: auto !important;
                        margin-bottom: 30px !important;
                    }
                    
                    .student-interactive-card {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        border-radius: 12px !important;
                        padding: 15px !important;
                        text-align: center !important;
                        cursor: pointer !important;
                        transition: all 0.3s ease !important;
                        border: 2px solid transparent !important;
                        position: relative !important;
                        overflow: hidden !important;
                        color: white !important;
                        min-height: 140px !important;
                        display: flex !important;
                        flex-direction: column !important;
                        align-items: center !important;
                        justify-content: center !important;
                    }
                    
                    .student-interactive-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
                        z-index: 1;
                        transition: opacity 0.3s ease;
                    }
                    
                    .student-interactive-card:hover {
                        transform: translateY(-5px) !important;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
                        border-color: #ffd700 !important;
                    }
                    
                    .student-interactive-card:hover::before {
                        opacity: 0.8;
                    }
                    
                    .student-interactive-card.selected {
                        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
                        border-color: #ffd700 !important;
                        transform: translateY(-3px) !important;
                        box-shadow: 0 8px 20px rgba(17, 153, 142, 0.4) !important;
                    }
                    
                    .student-interactive-card.selected::before {
                        background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
                    }
                    
                    .student-avatar {
                        width: 50px !important;
                        height: 50px !important;
                        border-radius: 50% !important;
                        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        margin: 0 auto 10px !important;
                        font-size: 20px !important;
                        font-weight: bold !important;
                        color: #333 !important;
                        position: relative !important;
                        z-index: 2 !important;
                        box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4) !important;
                    }
                    
                    .student-name {
                        font-weight: bold !important;
                        color: white !important;
                        margin-bottom: 8px !important;
                        position: relative !important;
                        z-index: 2 !important;
                        font-size: 14px !important;
                    }
                    
                    .student-status {
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 5px !important;
                        color: rgba(255,255,255,0.9) !important;
                        font-size: 12px !important;
                        position: relative !important;
                        z-index: 2 !important;
                    }
                    
                    .student-status i {
                        font-size: 14px !important;
                    }
                    
                    .selected-player-card {
                        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
                        border-radius: 10px !important;
                        padding: 15px !important;
                        text-align: center !important;
                        position: relative !important;
                        color: white !important;
                        border: 2px solid #ffd700 !important;
                    }
                    
                    .selected-player-card .remove-btn {
                        position: absolute !important;
                        top: -8px !important;
                        right: -8px !important;
                        background: #ff4757 !important;
                        border: none !important;
                        border-radius: 50% !important;
                        width: 24px !important;
                        height: 24px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        cursor: pointer !important;
                        color: white !important;
                        font-size: 12px !important;
                        transition: all 0.3s ease !important;
                        z-index: 3 !important;
                    }
                    
                    .selected-player-card .remove-btn:hover {
                        background: #ff3838 !important;
                        transform: scale(1.1) !important;
                    }
                    
                    .player-role {
                        margin-top: 8px !important;
                        font-size: 11px !important;
                        color: rgba(255,255,255,0.8) !important;
                        font-weight: bold !important;
                    }
                `;
                
                const styleSheet = document.createElement('style');
                styleSheet.textContent = animationStyles;
                document.head.appendChild(styleSheet);
                
                MessageSystem.show('تم تحميل مونوبولي عُمان بنجاح! 🎉', 'success');
                console.log('✅ تم تحميل اللعبة بنجاح!');
                
            } catch (error) {
                console.error('❌ خطأ في تحميل اللعبة:', error);
                MessageSystem.show('حدث خطأ في تحميل اللعبة', 'error');
            }
        });
    </script>

    <!-- المساعد الاستجابي للأجهزة المحمولة -->
    <script src="../assets/js/responsive-helper.js"></script>
</body>
</html>
