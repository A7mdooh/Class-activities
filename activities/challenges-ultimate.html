<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🏆 مملكة التحديات الذكية | نظام التعلم التفاعلي المتقدم</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --dark-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);
      
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --text-light: #a0aec0;
      --bg-primary: #f7fafc;
      --bg-secondary: #edf2f7;
      --border-radius: 20px;
      --shadow-light: 0 10px 25px rgba(0,0,0,0.1);
      --shadow-heavy: 0 20px 40px rgba(0,0,0,0.15);
      
      --arabic-font: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--arabic-font);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
      color: var(--text-primary);
      overflow-x: hidden;
      position: relative;
      padding-top: 80px; /* مساحة لأزرار التحكم */
    }

    /* ===== PARTICLES BACKGROUND ===== */
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
    }

    /* ==== أزرار التحكم العلوية الاحترافية ==== */
    .cosmic-control-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 2px solid rgba(255, 215, 0, 0.5);
      padding: 1rem 2rem;
      z-index: 99999;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.7);
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .control-buttons-container {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
      height: 60px;
    }

    .app-title-cosmic {
      display: flex !important;
      align-items: center;
      gap: 1rem;
      color: white;
      visibility: visible !important;
    }

    .title-icon {
      font-size: 2rem;
      animation: cosmic-glow 2s ease-in-out infinite alternate;
    }

    .title-text {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(45deg, #ffd700, #00ffff, #ff69b4);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% 200%;
      animation: cosmic-text 3s ease-in-out infinite;
    }

    .version-badge {
      background: linear-gradient(45deg, #ff6b35, #f7931e);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      box-shadow: 0 2px 10px rgba(255, 107, 53, 0.4);
    }

    .control-group-cosmic {
      display: flex !important;
      gap: 0.8rem;
      align-items: center;
      visibility: visible !important;
    }

    .cosmic-control-btn {
      position: relative;
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid rgba(255, 215, 0, 0.5);
      color: white;
      padding: 0.8rem;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
      min-width: 4rem;
      height: 4rem;
      display: flex !important;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 99999;
      gap: 0.2rem;
      overflow: hidden;
    }

    .cosmic-control-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .cosmic-control-btn:hover::before {
      left: 100%;
    }

    .cosmic-control-btn:hover {
      background: rgba(255, 215, 0, 0.2);
      border-color: #ffd700;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
    }

    .cosmic-control-btn:active {
      transform: translateY(-1px) scale(1.02);
    }

    .btn-icon {
      font-size: 1.4rem;
      transition: transform 0.3s ease;
    }

    .cosmic-control-btn:hover .btn-icon {
      transform: scale(1.2);
    }

    .btn-tooltip {
      font-size: 0.7rem;
      font-weight: 600;
      opacity: 0.8;
    }

    @keyframes cosmic-glow {
      0% { text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700; }
      100% { text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700, 0 0 30px #ffd700; }
    }

    @keyframes cosmic-text {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* تحديث padding للمحتوى الرئيسي */
    .main-header {
      margin-top: 6rem !important;
    }

    /* ==== نوافذ الإعدادات والإحصائيات ==== */
    .settings-modal, .stats-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      z-index: 20000;
      backdrop-filter: blur(10px);
      align-items: center;
      justify-content: center;
    }

    .settings-modal.active, .stats-modal.active {
      display: flex;
    }

    .settings-content {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 2px solid #ffd700;
      border-radius: 20px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .stats-content {
      background: linear-gradient(135deg, #0f3460, #16537e);
      border: 2px solid #00ffff;
      border-radius: 20px;
      padding: 2rem;
      max-width: 800px;
      width: 95%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 255, 255, 0.3);
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
    }

    .settings-title {
      font-size: 1.8rem;
      font-weight: 900;
      color: #ffd700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0;
    }

    .close-settings {
      background: rgba(255, 69, 69, 0.2);
      border: 2px solid #ff4545;
      color: #ff4545;
      padding: 0.5rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }

    .close-settings:hover {
      background: #ff4545;
      color: white;
      transform: scale(1.1);
    }

    .setting-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .setting-item {
      margin-bottom: 1rem;
      color: white;
    }

    .setting-item label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    /* تبويبات الإعدادات */
    .settings-tab-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 215, 0, 0.3);
      color: rgba(255, 255, 255, 0.7);
      padding: 0.8rem 1.5rem;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .settings-tab-btn:hover {
      background: rgba(255, 215, 0, 0.2);
      color: #ffd700;
      border-color: #ffd700;
    }

    .settings-tab-btn.active {
      background: rgba(255, 215, 0, 0.3);
      color: #ffd700;
      border-color: #ffd700;
      border-bottom-color: transparent;
    }

    .settings-tab-content {
      display: none;
    }

    .settings-tab-content.active {
      display: block;
    }

    .setting-select {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      margin-top: 0.5rem;
    }

    .setting-select:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
    }

    /* تحسينات إضافية */
    .secondary {
      background: rgba(108, 117, 125, 0.2) !important;
      border-color: #6c757d !important;
    }

    .secondary:hover {
      background: rgba(108, 117, 125, 0.4) !important;
    }

    /* تأثيرات responsive */
    @media (max-width: 768px) {
      .control-group-cosmic {
        gap: 0.4rem;
      }
      
      .cosmic-control-btn {
        min-width: 3rem;
        height: 3rem;
        padding: 0.5rem;
      }
      
      .btn-tooltip {
        display: none;
      }
      
      .title-text {
        font-size: 1.2rem;
      }
      
      .cosmic-control-header {
        padding: 0.8rem 1rem;
      }
    }

    /* ===== GLASSMORPHISM CONTAINER ===== */
    .glass-container {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-heavy);
      padding: 2rem;
      margin: 1rem;
    }

    /* ===== MAIN HEADER ===== */
    .main-header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
    }

    .kingdom-title {
      font-size: 3rem;
      font-weight: 900;
      background: linear-gradient(45deg, #FFD700, #FFA500, #FF6347, #FF1493);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      0% { filter: drop-shadow(0 0 10px rgba(255,215,0,0.5)); }
      100% { filter: drop-shadow(0 0 20px rgba(255,215,0,0.8)); }
    }

    .subtitle {
      font-size: 1.2rem;
      color: rgba(255,255,255,0.9);
      font-weight: 600;
      margin-bottom: 2rem;
    }

    /* ===== INTERACTIVE DASHBOARD ===== */
    .kingdom-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .realm-card {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      border-radius: var(--border-radius);
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .realm-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: all 0.6s;
    }

    .realm-card:hover::before {
      left: 100%;
    }

    .realm-card:hover {
      transform: translateY(-10px) scale(1.05);
      border-color: rgba(255,255,255,0.5);
      box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    }

    .realm-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: iconPulse 2s ease-in-out infinite;
    }

    @keyframes iconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .realm-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      margin-bottom: 0.5rem;
    }

    .realm-description {
      color: rgba(255,255,255,0.8);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    /* ===== BATTLE ARENA ===== */
    .battle-arena {
      display: none;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 3rem;
      margin: 2rem 0;
      border: 2px solid rgba(255,215,0,0.5);
      position: relative;
      overflow: hidden;
    }

    .battle-arena::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%);
      animation: battleAura 4s linear infinite;
    }

    @keyframes battleAura {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .arena-header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
      z-index: 10;
    }

    .challenge-timer {
      font-size: 6rem;
      font-weight: 900;
      background: linear-gradient(45deg, #ff0000, #ff4500, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(255,0,0,0.5);
      animation: timerPulse 1s ease-in-out infinite;
    }

    @keyframes timerPulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.1); filter: brightness(1.3); }
    }

    /* ===== HOLOGRAPHIC TEAMS ===== */
    .teams-hologram {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin: 2rem 0;
    }

    .team-hologram {
      background: linear-gradient(135deg, rgba(0,255,255,0.1), rgba(255,0,255,0.1));
      border: 2px solid rgba(0,255,255,0.3);
      border-radius: var(--border-radius);
      padding: 2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
      transform-style: preserve-3d;
      transition: all 0.5s ease;
    }

    .team-hologram::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: holoScan 3s linear infinite;
    }

    @keyframes holoScan {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .team-avatar-3d {
      width: 120px;
      height: 120px;
      margin: 0 auto 1rem;
      border-radius: 50%;
      background: conic-gradient(from 0deg, #ff006e, #ffbe0b, #8338ec, #3a86ff, #06ffa5, #ff006e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: avatarFloat 3s ease-in-out infinite;
      position: relative;
    }

    @keyframes avatarFloat {
      0%, 100% { transform: translateY(0px) rotateY(0deg); }
      50% { transform: translateY(-10px) rotateY(180deg); }
    }

    .team-name-glow {
      font-size: 1.5rem;
      font-weight: 700;
      color: #00ffff;
      text-shadow: 0 0 20px #00ffff;
      margin-bottom: 1rem;
    }

    .score-crystal {
      font-size: 3rem;
      font-weight: 900;
      background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 10px rgba(255,215,0,0.8));
      animation: crystalGlow 2s ease-in-out infinite alternate;
    }

    @keyframes crystalGlow {
      0% { filter: drop-shadow(0 0 10px rgba(255,215,0,0.8)); }
      100% { filter: drop-shadow(0 0 20px rgba(255,215,0,1)); }
    }

    /* ===== NEURAL NETWORK BUTTONS ===== */
    .neural-button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      border-radius: 50px;
      padding: 1rem 2rem;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      margin: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .neural-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: all 0.5s;
    }

    .neural-button:hover::before {
      left: 100%;
    }

    .neural-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }

    .neural-button:active {
      transform: translateY(0);
    }

    /* ===== QUANTUM NOTIFICATIONS ===== */
    .quantum-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      color: white;
      border: 2px solid rgba(0,255,255,0.5);
      box-shadow: 0 10px 30px rgba(0,255,255,0.3);
      z-index: 10000;
      transform: translateX(400px);
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-width: 350px;
    }

    .quantum-notification.show {
      transform: translateX(0);
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .notification-icon {
      font-size: 1.5rem;
      animation: quantumSpin 2s linear infinite;
    }

    @keyframes quantumSpin {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.2); }
      100% { transform: rotate(360deg) scale(1); }
    }

    /* ===== COSMIC EFFECTS ===== */
    .cosmic-star {
      position: fixed;
      color: #ffd700;
      font-size: 20px;
      z-index: 1000;
      pointer-events: none;
      animation: cosmicFall 4s linear forwards;
    }

    @keyframes cosmicFall {
      0% {
        transform: translateY(-50px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    .cosmic-explosion {
      position: fixed;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
      animation: cosmicBlast 1s ease-out forwards;
      pointer-events: none;
      z-index: 1000;
    }

    @keyframes cosmicBlast {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      100% {
        transform: scale(10);
        opacity: 0;
      }
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 768px) {
      .kingdom-title {
        font-size: 2rem;
      }
      
      .glass-container {
        margin: 0.5rem;
        padding: 1rem;
      }
      
      .challenge-timer {
        font-size: 4rem;
      }
      
      .team-avatar-3d {
        width: 80px;
        height: 80px;
        font-size: 2rem;
      }
    }

    /* ===== SELECTION PANEL STYLES ===== */
    .selection-panel {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .class-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .class-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 215, 0, 0.5);
      box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
    }

    .class-card.selected {
      border-color: #ffd700;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 99, 71, 0.3));
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .class-card h4 {
      color: white;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .class-card .student-count {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
    }

    .student-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .student-card:hover {
      transform: translateY(-3px);
      border-color: rgba(0, 255, 255, 0.5);
      box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
    }

    .student-card.selected {
      border-color: #00ffff;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
      box-shadow: 
        0 0 15px rgba(0, 255, 255, 0.5),
        inset 0 0 10px rgba(0, 255, 255, 0.2);
      transform: scale(1.02);
      animation: selectedGlow 2s ease-in-out infinite alternate;
    }

    @keyframes selectedGlow {
      0% { 
        box-shadow: 
          0 0 15px rgba(0, 255, 255, 0.5),
          inset 0 0 10px rgba(0, 255, 255, 0.2);
      }
      100% { 
        box-shadow: 
          0 0 25px rgba(0, 255, 255, 0.8),
          inset 0 0 15px rgba(0, 255, 255, 0.4);
      }
    }

    .student-card .student-name {
      color: white;
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .student-card .selection-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .student-card.selected .selection-indicator {
      background: linear-gradient(135deg, #00ffff, #ff00ff);
      color: #000;
      font-weight: bold;
      transform: scale(1.2);
      animation: checkmarkPulse 0.5s ease-out;
    }

    @keyframes checkmarkPulse {
      0% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1.4); opacity: 1; }
      100% { transform: scale(1.2); opacity: 1; }
    }

    /* ===== TEACHER GUIDE MODAL ===== */
    .teacher-guide-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 100000;
      display: none;
      overflow-y: auto;
      padding: 2rem;
    }

    .guide-content {
      max-width: 1000px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      border-radius: var(--border-radius);
      padding: 2rem;
      border: 2px solid rgba(255, 215, 0, 0.3);
    }

    .guide-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .guide-section h3 {
      color: #ffd700;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .guide-section p, .guide-section li {
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }

    .guide-section ul {
      padding-right: 1.5rem;
    }

    /* ===== ENHANCED BUTTON STYLES ===== */
    .neural-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .neural-button:disabled:hover {
      transform: none !important;
      box-shadow: none !important;
    }

    /* ===== RESPONSIVE DESIGN ENHANCEMENTS ===== */
    @media (max-width: 768px) {
      .selection-panel {
        padding: 1rem;
      }
      
      .class-grid, .students-grid {
        grid-template-columns: 1fr;
      }
      
      .guide-content {
        padding: 1rem;
      }
    }

    /* ===== LOADING SCREEN ===== */
    .cosmic-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #000000, #1a1a2e, #16213e);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100000;
      transition: opacity 1s ease;
    }

    .loader-animation {
      width: 150px;
      height: 150px;
      border: 4px solid transparent;
      border-top: 4px solid #00ffff;
      border-right: 4px solid #ff00ff;
      border-radius: 50%;
      animation: cosmicSpin 2s linear infinite;
      margin-bottom: 2rem;
      position: relative;
    }

    .loader-animation::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      border: 2px solid transparent;
      border-bottom: 2px solid #ffd700;
      border-left: 2px solid #ff4500;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: cosmicSpin 1s linear infinite reverse;
    }

    @keyframes cosmicSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loader-text {
      color: #00ffff;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      animation: textPulse 2s ease-in-out infinite;
    }

    @keyframes textPulse {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.1); }
    }

    .loader-progress {
      width: 300px;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin-top: 2rem;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00ffff, #ff00ff, #ffd700);
      border-radius: 3px;
      width: 0%;
      transition: width 0.5s ease;
      animation: progressGlow 2s ease-in-out infinite;
    }

    @keyframes progressGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(0,255,255,0.5); }
      50% { box-shadow: 0 0 20px rgba(0,255,255,1); }
    }
  </style>
</head>
<body>
  <!-- Particles Background -->
  <div id="particles-js"></div>

  <!-- Cosmic Loading Screen -->
  <div class="cosmic-loader" id="cosmicLoader">
    <div class="loader-animation"></div>
    <div class="loader-text" id="loaderText">🌌 تهيئة مملكة التحديات الذكية...</div>
    <div class="loader-progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div class="glass-container" id="mainApp" style="display: none;">
    <!-- Class & Student Selection Panel -->
    <div class="selection-panel" id="selectionPanel">
      <div class="glass-container" style="background: rgba(0,0,0,0.8); border: 2px solid rgba(255,215,0,0.5);">
        <!-- عنوان محسن للوحة -->
        <div style="position: relative; margin-bottom: 2rem;">
          <h2 style="text-align: center; color: #ffd700; font-size: 2.5rem; margin-bottom: 0.5rem;">
            👥 إعداد مملكة التحديات
          </h2>
          <p style="text-align: center; color: rgba(255,255,255,0.8); font-size: 1.1rem;">
            ⚡ اختر صفك وطلابك لبدء الرحلة الملحمية
          </p>
          
          <!-- زر العودة للوحة الرئيسية -->
          <button class="cosmic-control-btn" onclick="backToMainDashboard()" 
                  style="position: absolute; top: 0; right: 0; background: rgba(255,69,69,0.2); border-color: #ff4545;">
            <span class="btn-icon">↩️</span>
            <span class="btn-tooltip">الوحة الرئيسية</span>
          </button>
        </div>
        
        <!-- Class Selection -->
        <div class="class-selection-section" style="margin-bottom: 3rem;">
          <h3 style="color: #00ffff; font-size: 1.8rem; margin-bottom: 1rem; text-align: center;">
            🏫 اختيار الصف
          </h3>
          <div class="class-grid" id="classGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <!-- Classes will be loaded dynamically -->
          </div>
        </div>

        <!-- Student Selection -->
        <div class="student-selection-section" id="studentSelectionSection" style="display: none;">
          <h3 style="color: #ff6347; font-size: 1.8rem; margin-bottom: 1rem; text-align: center;">
            🎯 اختيار المشاركين
          </h3>
          
          <!-- Selection Controls -->
          <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <button class="neural-button" onclick="selectAllStudents()">✅ اختيار الكل</button>
            <button class="neural-button" onclick="clearAllStudents()">❌ إلغاء الكل</button>
            <button class="neural-button" onclick="selectRandomStudents()">🎲 اختيار عشوائي</button>
            <button class="neural-button" onclick="quickSelectCount()">🔢 اختيار عدد محدد</button>
          </div>

          <!-- Student Grid -->
          <div class="students-grid" id="studentsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <!-- Students will be loaded dynamically -->
          </div>

          <!-- Selected Count Display -->
          <div style="text-align: center; margin-bottom: 2rem;">
            <div style="background: rgba(0,255,255,0.2); padding: 1rem; border-radius: 15px; display: inline-block;">
              <span style="color: #00ffff; font-size: 1.2rem; font-weight: 700;">
                المشاركين المختارين: <span id="selectedCount">0</span>
              </span>
            </div>
          </div>

          <!-- Start Game Button -->
          <div style="text-align: center;">
            <button class="neural-button" id="startGameBtn" onclick="startKingdomGame()" style="font-size: 1.3rem; padding: 1.5rem 3rem; background: linear-gradient(45deg, #ffd700, #ff6347);" disabled>
              🚀 بدء مملكة التحديات
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Game Interface (initially hidden) -->
    <div class="game-interface" id="gameInterface" style="display: none;">
      <!-- Back to Setup Button -->
      <div style="position: fixed; top: 20px; left: 20px; z-index: 1000;">
        <button class="neural-button" onclick="backToSetup()">🔙 العودة للإعداد</button>
      </div>
    <!-- أزرار التحكم العلوية الاحترافية -->
    <div class="cosmic-control-header">
        <div class="control-buttons-container">
            <div class="app-title-cosmic">
                <span class="title-icon">🏰</span>
                <span class="title-text">مملكة التحديات الذكية</span>
                <span class="version-badge">v2.0</span>
            </div>
            <div class="control-group-cosmic">
                <button class="cosmic-control-btn" id="homeBtn" title="العودة للصفحة الرئيسية">
                    <span class="btn-icon">🏠</span>
                    <span class="btn-tooltip">الرئيسية</span>
                </button>
                <button class="cosmic-control-btn" id="soundToggleBtn" title="التحكم في الصوت">
                    <span class="btn-icon">🔊</span>
                    <span class="btn-tooltip">الصوت</span>
                </button>
                <button class="cosmic-control-btn" id="teacherGuideBtn" title="دليل المعلم">
                    <span class="btn-icon">📖</span>
                    <span class="btn-tooltip">دليل المعلم</span>
                </button>
                <button class="cosmic-control-btn" id="settingsBtn" title="إعدادات اللعبة">
                    <span class="btn-icon">⚙️</span>
                    <span class="btn-tooltip">الإعدادات</span>
                </button>
                <button class="cosmic-control-btn" id="statsBtn" title="إحصائيات اللعبة">
                    <span class="btn-icon">📊</span>
                    <span class="btn-tooltip">الإحصائيات</span>
                </button>
                <button class="cosmic-control-btn" id="fullscreenBtn" title="وضع ملء الشاشة">
                    <span class="btn-icon">⛶</span>
                    <span class="btn-tooltip">ملء الشاشة</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Kingdom Header -->
    <header class="main-header">
      <h1 class="kingdom-title">🏆 مملكة التحديات الذكية</h1>
      <p class="subtitle">⚡ نظام التعلم التفاعلي المتقدم بتقنية الذكاء الاصطناعي</p>
      
      <!-- Real-time Stats -->
      <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 2rem;">
        <div style="text-align: center; color: white;">
          <div style="font-size: 2rem; font-weight: 900;">⏱️</div>
          <div>وقت الجلسة</div>
          <div id="sessionTime" style="font-weight: 700;">00:00</div>
        </div>
        <div style="text-align: center; color: white;">
          <div style="font-size: 2rem; font-weight: 900;">🎯</div>
          <div>التحديات المكتملة</div>
          <div id="completedChallenges" style="font-weight: 700;">0</div>
        </div>
        <div style="text-align: center; color: white;">
          <div style="font-size: 2rem; font-weight: 900;">⚡</div>
          <div>مستوى الطاقة</div>
          <div id="energyLevel" style="font-weight: 700;">100%</div>
        </div>
      </div>
    </header>

    <!-- Kingdom Dashboard -->
    <div class="kingdom-dashboard" id="kingdomDashboard">
      <!-- Lightning Challenge Realm -->
      <div class="realm-card" onclick="activateRealm('lightning')">
        <div class="realm-icon">⚡</div>
        <h3 class="realm-title">مملكة البرق</h3>
        <p class="realm-description">تحديات سريعة لاختبار سرعة التفكير والذكاء</p>
      </div>

      <!-- Wisdom Challenge Realm -->
      <div class="realm-card" onclick="activateRealm('wisdom')">
        <div class="realm-icon">🧠</div>
        <h3 class="realm-title">مملكة الحكمة</h3>
        <p class="realm-description">تحديات فكرية عميقة لتطوير الذكاء والإبداع</p>
      </div>

      <!-- Team Battle Realm -->
      <div class="realm-card" onclick="activateRealm('battle')">
        <div class="realm-icon">⚔️</div>
        <h3 class="realm-title">ساحة المعركة</h3>
        <p class="realm-description">معارك جماعية ملحمية بين الفرق</p>
      </div>

      <!-- Mystery Realm -->
      <div class="realm-card" onclick="activateRealm('mystery')">
        <div class="realm-icon">🔮</div>
        <h3 class="realm-title">مملكة الألغاز</h3>
        <p class="realm-description">ألغاز غامضة وتحديات استثنائية</p>
      </div>
    </div>

    <!-- Battle Arena -->
    <div class="battle-arena" id="battleArena">
      <div class="arena-header">
        <h2 style="color: #ffd700; font-size: 2rem; margin-bottom: 1rem;">⚔️ ساحة المعركة النشطة</h2>
        <div class="challenge-timer" id="challengeTimer">00:00</div>
        <p style="color: rgba(255,255,255,0.8); font-size: 1.1rem;">استعد للمعركة الأسطورية!</p>
      </div>

      <!-- Teams Hologram Display -->
      <div class="teams-hologram" id="teamsHologram">
        <!-- Teams will be generated dynamically -->
      </div>

      <!-- Battle Controls -->
      <div style="text-align: center; margin-top: 2rem;">
        <button class="neural-button" onclick="startBattle()">🚀 بدء المعركة</button>
        <button class="neural-button" onclick="pauseBattle()">⏸️ إيقاف مؤقت</button>
        <button class="neural-button" onclick="endBattle()">🏁 إنهاء المعركة</button>
        <button class="neural-button" onclick="resetArena()">🔄 إعادة تعيين</button>
      </div>
    </div>

    <!-- AI Coach Panel -->
    <div class="glass-container" style="margin-top: 2rem; border: 2px solid rgba(0,255,255,0.3);">
      <h3 style="color: #00ffff; text-align: center; margin-bottom: 1rem;">🤖 المدرب الذكي</h3>
      <div id="aiCoachMessages" style="min-height: 100px; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 10px; color: white;">
        <div style="opacity: 0.7;">المدرب الذكي جاهز لمساعدتك...</div>
      </div>
      <div style="text-align: center; margin-top: 1rem;">
        <button class="neural-button" onclick="getAITip()">💡 نصيحة ذكية</button>
        <button class="neural-button" onclick="analyzePerformance()">📊 تحليل الأداء</button>
      </div>
    </div>
  </div>

  <!-- Sound Control -->
  <div style="position: fixed; bottom: 20px; left: 20px; z-index: 1000;">
    <button class="neural-button" onclick="toggleSound()" id="soundToggle">🔊 الصوت</button>
  </div>

  <!-- Settings Panel -->
  <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <button class="neural-button" onclick="openSettings()">⚙️ الإعدادات</button>
  </div>

  <!-- Teacher Guide Modal -->
  <!-- نافذة الإعدادات المتقدمة الشاملة -->
  <div class="modal-overlay settings-modal" id="settingsModal">
      <div class="modal-content settings-content">
          <div class="modal-header settings-header">
              <h2 class="settings-title">
                  <span>⚙️</span>
                  إعدادات مملكة التحديات المتقدمة
              </h2>
              <button class="close-settings" onclick="closeSettingsModal()">✕</button>
          </div>
          
          <!-- تبويبات الإعدادات -->
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(255,215,0,0.3);">
              <button class="settings-tab-btn active" data-tab="game-settings">🎮 إعدادات اللعبة</button>
              <button class="settings-tab-btn" data-tab="audio-settings">🎵 الصوت</button>
              <button class="settings-tab-btn" data-tab="display-settings">🎨 العرض</button>
              <button class="settings-tab-btn" data-tab="class-settings">👥 الصفوف</button>
          </div>
          
          <!-- تبويب إعدادات اللعبة -->
          <div class="settings-tab-content active" id="game-settings-content">
              <div class="setting-section">
                  <h3 style="color: #ffd700; margin-bottom: 1rem;">🎯 إعدادات اللعبة الأساسية</h3>
                  
                  <div class="setting-item">
                      <label>📚 الصف الدراسي المختار:</label>
                      <select id="selectedClassDisplay" class="setting-select" disabled>
                          <option value="">-- لم يتم اختيار صف --</option>
                      </select>
                  </div>
                  
                  <div class="setting-item">
                      <label>⏱️ مدة التحدي (بالثواني):</label>
                      <select id="challengeDurationSelect" class="setting-select">
                          <option value="30">30 ثانية</option>
                          <option value="60" selected>60 ثانية</option>
                          <option value="90">90 ثانية</option>
                          <option value="120">120 ثانية</option>
                          <option value="180">180 ثانية</option>
                      </select>
                  </div>
                  
                  <div class="setting-item">
                      <label>🎯 مستوى الصعوبة:</label>
                      <select id="difficultySelect" class="setting-select">
                          <option value="easy">سهل 🟢 - للمبتدئين</option>
                          <option value="medium" selected>متوسط 🟡 - التوازن المثالي</option>
                          <option value="hard">صعب 🔴 - للخبراء</option>
                          <option value="mixed">مختلط 🌈 - تنوع الصعوبة</option>
                      </select>
                  </div>
                  
                  <div class="setting-item">
                      <label>🏆 نظام النقاط:</label>
                      <select id="scoringSystemSelect" class="setting-select">
                          <option value="standard" selected>نظام النقاط العادي</option>
                          <option value="bonus">نظام المكافآت المضاعفة</option>
                          <option value="penalty">نظام الخصم على الأخطاء</option>
                          <option value="time-based">نظام الوقت المتدرج</option>
                      </select>
                  </div>
              </div>
          </div>
          
          <!-- تبويب إعدادات الصوت -->
          <div class="settings-tab-content" id="audio-settings-content">
              <div class="setting-section">
                  <h3 style="color: #00ffff; margin-bottom: 1rem;">🎵 إعدادات الصوت المتقدمة</h3>
                  
                  <div class="setting-item">
                      <label>🔊 مستوى الصوت العام:</label>
                      <input type="range" id="masterVolumeSlider" min="0" max="100" value="50" 
                             style="width: 100%; margin-top: 0.5rem;">
                      <div style="text-align: center; color: #ffd700; margin-top: 0.5rem;">
                          <span id="volumeDisplay">50%</span>
                      </div>
                  </div>
                  
                  <div class="setting-item">
                      <label>🎼 أصوات التأثيرات:</label>
                      <input type="range" id="effectsVolumeSlider" min="0" max="100" value="70" 
                             style="width: 100%; margin-top: 0.5rem;">
                      <div style="text-align: center; color: #00ffff; margin-top: 0.5rem;">
                          <span id="effectsVolumeDisplay">70%</span>
                      </div>
                  </div>
                  
                  <div class="setting-item">
                      <label>🎵 الموسيقى الخلفية:</label>
                      <input type="range" id="musicVolumeSlider" min="0" max="100" value="30" 
                             style="width: 100%; margin-top: 0.5rem;">
                      <div style="text-align: center; color: #ff69b4; margin-top: 0.5rem;">
                          <span id="musicVolumeDisplay">30%</span>
                      </div>
                  </div>
                  
                  <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                      <button class="neural-button" onclick="testAllSounds()" style="flex: 1;">
                          🎼 اختبار جميع الأصوات
                      </button>
                      <button class="neural-button secondary" onclick="muteAllSounds()" style="flex: 1;">
                          🔇 كتم جميع الأصوات
                      </button>
                  </div>
              </div>
          </div>
          
          <!-- تبويب إعدادات العرض -->
          <div class="settings-tab-content" id="display-settings-content">
              <div class="setting-section">
                  <h3 style="color: #ff69b4; margin-bottom: 1rem;">🎨 إعدادات العرض والواجهة</h3>
                  
                  <div class="setting-item">
                      <label>
                          <input type="checkbox" id="particlesToggle" checked> 
                          🌌 تفعيل خلفية الجسيمات المتحركة
                      </label>
                  </div>
                  
                  <div class="setting-item">
                      <label>
                          <input type="checkbox" id="animationsToggle" checked> 
                          ✨ تفعيل التأثيرات المتحركة
                      </label>
                  </div>
                  
                  <div class="setting-item">
                      <label>
                          <input type="checkbox" id="notificationsToggle" checked> 
                          🔔 إظهار الإشعارات البصرية
                      </label>
                  </div>
                  
                  <div class="setting-item">
                      <label>
                          <input type="checkbox" id="fullscreenModeToggle"> 
                          ⛶ تفعيل وضع ملء الشاشة تلقائياً
                      </label>
                  </div>
                  
                  <div class="setting-item">
                      <label>🎨 نمط الألوان:</label>
                      <select id="colorThemeSelect" class="setting-select">
                          <option value="cosmic" selected>الكوني (افتراضي)</option>
                          <option value="ocean">المحيط الأزرق</option>
                          <option value="sunset">غروب الشمس</option>
                          <option value="forest">الغابة الخضراء</option>
                          <option value="royal">الملكي الذهبي</option>
                      </select>
                  </div>
              </div>
          </div>
          
          <!-- تبويب إعدادات الصفوف -->
          <div class="settings-tab-content" id="class-settings-content">
              <div class="setting-section">
                  <h3 style="color: #ffd700; margin-bottom: 1rem;">👥 إدارة الصفوف والطلاب</h3>
                  
                  <div class="setting-item">
                      <label>📊 إحصائيات البيانات المحملة:</label>
                      <div id="dataStatsDisplay" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px; margin-top: 0.5rem;">
                          <div>عدد الصفوف: <span id="classesCount">--</span></div>
                          <div>إجمالي الطلاب: <span id="totalStudentsCount">--</span></div>
                          <div>آخر تحديث: <span id="lastUpdateTime">--</span></div>
                      </div>
                  </div>
                  
                  <div class="setting-item">
                      <label>🔄 إدارة البيانات:</label>
                      <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                          <button class="neural-button" onclick="reloadStudentData()" style="flex: 1;">
                              🔄 إعادة تحميل البيانات
                          </button>
                          <button class="neural-button secondary" onclick="exportClassData()" style="flex: 1;">
                              � تصدير البيانات
                          </button>
                      </div>
                  </div>
                  
                  <div class="setting-item">
                      <label>⚡ إعدادات الاختيار السريع:</label>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                          <label><input type="checkbox" id="autoSelectAllStudents"> اختيار جميع الطلاب تلقائياً</label>
                          <label><input type="checkbox" id="randomizeStudentOrder"> ترتيب عشوائي للطلاب</label>
                          <label><input type="checkbox" id="enableQuickStart"> بدء سريع بدون إعداد</label>
                          <label><input type="checkbox" id="rememberLastSelection"> تذكر آخر اختيار</label>
                      </div>
                  </div>
              </div>
          </div>
          
          <!-- أزرار الحفظ والإجراءات -->
          <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid rgba(255,215,0,0.3);">
              <button class="neural-button" onclick="saveAllSettings()" style="flex: 2; background: linear-gradient(45deg, #4facfe, #00f2fe);">
                  💾 حفظ جميع الإعدادات
              </button>
              <button class="neural-button secondary" onclick="resetAllSettings()" style="flex: 1;">
                  🔄 إعادة تعيين الكل
              </button>
              <button class="neural-button" onclick="exportSettings()" style="flex: 1; background: linear-gradient(45deg, #43e97b, #38f9d7);">
                  📤 تصدير الإعدادات
              </button>
          </div>
      </div>
  </div>

  <!-- نافذة الإحصائيات -->
  <div class="modal-overlay stats-modal" id="statsModal">
      <div class="modal-content stats-content">
          <div class="modal-header">
              <h2 style="color: #00ffff; font-size: 1.8rem;">
                  <span>📊</span>
                  إحصائيات مملكة التحديات
              </h2>
              <button class="close-settings" onclick="closeStatsModal()">✕</button>
          </div>
          
          <div id="statsContent">
              <!-- سيتم ملء المحتوى ديناميكياً -->
          </div>
      </div>
  </div>

  <div class="teacher-guide-modal" id="teacherGuideModal">
    <div class="guide-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="color: #ffd700; font-size: 2.5rem;">📖 دليل المعلم - مملكة التحديات الذكية</h2>
        <button class="neural-button" onclick="closeTeacherGuide()" style="background: #ff4444;">✖️ إغلاق</button>
      </div>

      <div class="guide-section">
        <h3>🎯 نظرة عامة على النشاط</h3>
        <p>مملكة التحديات الذكية هي منصة تعليمية تفاعلية متطورة تهدف إلى تحفيز الطلاب وزيادة مشاركتهم في التعلم من خلال:</p>
        <ul>
          <li>نظام مماليك متنوعة (البرق، الحكمة، المعركة، الألغاز)</li>
          <li>تحديات تفاعلية مناسبة لمختلف أنماط التعلم</li>
          <li>نظام نقاط وإنجازات محفز</li>
          <li>مدرب ذكي يقدم النصائح والتحليلات</li>
          <li>تأثيرات بصرية وصوتية غامرة</li>
        </ul>
      </div>

      <div class="guide-section">
        <h3>🚀 خطوات البدء</h3>
        <p><strong>الخطوة 1: اختيار الصف</strong></p>
        <ul>
          <li>انقر على بطاقة الصف المطلوب من الشاشة الرئيسية</li>
          <li>ستظهر قائمة بجميع طلاب الصف المختار</li>
        </ul>
        
        <p><strong>الخطوة 2: اختيار الطلاب المشاركين</strong></p>
        <ul>
          <li><strong>اختيار الكل:</strong> لإشراك جميع طلاب الصف</li>
          <li><strong>اختيار عشوائي:</strong> للاختيار العشوائي السريع</li>
          <li><strong>اختيار عدد محدد:</strong> لتحديد عدد معين من الطلاب</li>
          <li><strong>اختيار يدوي:</strong> انقر على أسماء الطلاب المرغوبين</li>
        </ul>

        <p><strong>الخطوة 3: بدء النشاط</strong></p>
        <ul>
          <li>انقر على "بدء مملكة التحديات" بعد اختيار الطلاب</li>
          <li>ستظهر لوحة التحكم الرئيسية للنشاط</li>
        </ul>
      </div>

      <div class="guide-section">
        <h3>⚔️ أنواع التحديات</h3>
        
        <p><strong>⚡ مملكة البرق:</strong></p>
        <ul>
          <li>تحديات سريعة تركز على سرعة التفكير</li>
          <li>مدة قصيرة (30-60 ثانية)</li>
          <li>مناسبة للإحماء وكسر الجليد</li>
        </ul>

        <p><strong>🧠 مملكة الحكمة:</strong></p>
        <ul>
          <li>تحديات فكرية عميقة تتطلب التأمل</li>
          <li>تطوير مهارات التفكير النقدي</li>
          <li>وقت أطول للتفكير والمناقشة</li>
        </ul>

        <p><strong>⚔️ ساحة المعركة:</strong></p>
        <ul>
          <li>تحديات جماعية بين الفرق</li>
          <li>تعزيز روح التعاون والمنافسة الإيجابية</li>
          <li>نظام نقاط وطاقة تفاعلي</li>
        </ul>

        <p><strong>🔮 مملكة الألغاز:</strong></p>
        <ul>
          <li>ألغاز ومشاكل تتطلب حلول إبداعية</li>
          <li>تنمية مهارات حل المشكلات</li>
          <li>تحديات متدرجة الصعوبة</li>
        </ul>
      </div>

      <div class="guide-section">
        <h3>🎮 إدارة ساحة المعركة</h3>
        <p><strong>إنشاء الفرق:</strong></p>
        <ul>
          <li>يتم تكوين الفرق تلقائياً من الطلاب المختارين</li>
          <li>كل فريق له اسم وأيقونة مميزة</li>
          <li>نظام طاقة وصحة للفرق</li>
        </ul>

        <p><strong>إدارة النقاط:</strong></p>
        <ul>
          <li><strong>إضافة نقطة (⬆️):</strong> عند الإجابة الصحيحة أو المشاركة الإيجابية</li>
          <li><strong>خصم نقطة (⬇️):</strong> عند الإجابة الخاطئة أو السلوك غير المرغوب</li>
          <li><strong>النقاط المضاعفة:</strong> تحدث تلقائياً في الأحداث الخاصة</li>
        </ul>

        <p><strong>الأحداث العشوائية:</strong></p>
        <ul>
          <li>تحدث كل 30 ثانية أثناء المعركة النشطة</li>
          <li>تضيف عنصر المفاجأة والإثارة</li>
          <li>تشمل: طاقة إضافية، نقاط مضاعفة، مكافآت خاصة</li>
        </ul>
      </div>

      <div class="guide-section">
        <h3>🤖 المدرب الذكي</h3>
        <p>يقدم المدرب الذكي:</p>
        <ul>
          <li><strong>نصائح ذكية:</strong> توجيهات مفيدة أثناء النشاط</li>
          <li><strong>تحليل الأداء:</strong> إحصائيات مفصلة عن أداء الطلاب</li>
          <li><strong>تحفيز إيجابي:</strong> رسائل محفزة ومشجعة</li>
          <li><strong>اقتراحات تحسين:</strong> نصائح لتطوير الأداء</li>
        </ul>
      </div>

      <div class="guide-section">
        <h3>📊 التقييم والمتابعة</h3>
        <p><strong>مؤشرات الأداء:</strong></p>
        <ul>
          <li>وقت الجلسة الإجمالي</li>
          <li>عدد التحديات المكتملة</li>
          <li>مستوى طاقة الطلاب</li>
          <li>متوسط النقاط لكل دقيقة</li>
        </ul>

        <p><strong>نصائح للتقييم:</strong></p>
        <ul>
          <li>راقب مشاركة الطلاب وتفاعلهم</li>
          <li>لاحظ مستوى الحماس والانخراط</li>
          <li>استخدم النقاط كأداة تحفيزية وليس تقييمية فقط</li>
          <li>شجع التعاون والمساعدة المتبادلة</li>
        </ul>
      </div>

      <div class="guide-section">
        <h3>💡 نصائح للاستخدام الأمثل</h3>
        <ul>
          <li><strong>التحضير:</strong> تأكد من عمل الصوت وجودة الاتصال</li>
          <li><strong>إدارة الوقت:</strong> خصص 5-10 دقائق لكل تحدي</li>
          <li><strong>التنويع:</strong> استخدم مماليك مختلفة لتنويع التجربة</li>
          <li><strong>التفاعل:</strong> شارك مع الطلاب وكن متحمساً</li>
          <li><strong>المرونة:</strong> يمكن تعديل القواعد حسب احتياجات الصف</li>
          <li><strong>الختام:</strong> اختتم بتهنئة جميع المشاركين</li>
        </ul>
      </div>

      <div class="guide-section">
        <h3>🔧 استكشاف الأخطاء</h3>
        <p><strong>مشاكل شائعة وحلولها:</strong></p>
        <ul>
          <li><strong>عدم عمل الصوت:</strong> تحقق من إعدادات المتصفح والصوت</li>
          <li><strong>بطء في التحميل:</strong> تأكد من سرعة الإنترنت</li>
          <li><strong>عدم ظهور الطلاب:</strong> تحقق من ملف studentData.json</li>
          <li><strong>مشاكل في العرض:</strong> استخدم متصفح حديث (Chrome, Firefox, Edge)</li>
        </ul>
      </div>

      <div class="guide-section">
        <h3>🎯 أهداف تعليمية</h3>
        <p>يساعد هذا النشاط على تحقيق:</p>
        <ul>
          <li>زيادة الدافعية للتعلم</li>
          <li>تطوير مهارات التفكير النقدي</li>
          <li>تعزيز روح الفريق والتعاون</li>
          <li>تحسين الثقة بالنفس</li>
          <li>ربط التعلم بالمتعة والإثارة</li>
          <li>تطوير مهارات حل المشكلات</li>
        </ul>
      </div>
    </div>
  </div>

<script>
// ===== GLOBAL VARIABLES =====
let gameState = {
  currentRealm: null,
  isActive: false,
  sessionStartTime: Date.now(),
  completedChallenges: 0,
  energyLevel: 100,
  soundEnabled: true,
  teams: [],
  battleTimer: null,
  battleDuration: 0,
  selectedClass: null,
  selectedStudents: [],
  gameStarted: false
};

let studentData = {};
let selectedStudentsList = [];

// ===== ENHANCED STUDENT MANAGEMENT SYSTEM =====
function loadClassSelection() {
  console.log('🎓 بدء تحميل اختيار الصفوف');
  console.log('📊 بيانات الطلاب المتاحة:', Object.keys(studentData));
  
  // Hide main dashboard
  document.getElementById('kingdomContent').style.display = 'none';
  
  // Show selection panel
  document.getElementById('selectionPanel').style.display = 'block';
  
  const classGrid = document.getElementById('classGrid');
  if (!classGrid) {
    console.error('❌ لم يتم العثور على classGrid');
    return;
  }
  
  classGrid.innerHTML = '';
  
  // التحقق من وجود البيانات
  if (!studentData || Object.keys(studentData).length === 0) {
    console.warn('⚠️ لا توجد بيانات طلاب');
    classGrid.innerHTML = `
      <div style="text-align: center; color: #ff6b6b; padding: 2rem; grid-column: 1 / -1;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
        <h3>لم يتم تحميل بيانات الطلاب</h3>
        <p>جاري إعادة التحميل...</p>
        <button class="neural-button" onclick="reloadStudentData()" style="margin-top: 1rem;">
          🔄 إعادة التحميل
        </button>
      </div>
    `;
    
    // إعادة تحميل البيانات
    loadStudentData().then(() => {
      loadClassSelection(); // إعادة استدعاء الدالة بعد التحميل
    }).catch(error => {
      console.error('❌ فشل في إعادة تحميل البيانات:', error);
    });
    return;
  }
  
  const classNames = Object.keys(studentData);
  console.log(`📚 تحميل ${classNames.length} صفوف:`, classNames);
  
  classNames.forEach(className => {
    const classCard = document.createElement('div');
    classCard.className = 'class-card';
    classCard.style.cursor = 'pointer';
    
    // ربط الحدث بطريقة آمنة
    classCard.addEventListener('click', function() {
      console.log('🖱️ تم النقر على صف:', className);
      selectClass(className);
    });
    
    const studentCount = studentData[className].length;
    
    classCard.innerHTML = `
      <div style="font-size: 3rem; margin-bottom: 1rem;">🏫</div>
      <h4 style="margin: 0; color: #ffd700;">${className}</h4>
      <div class="student-count" style="color: #00ffff; margin-top: 0.5rem;">${studentCount} طالب</div>
    `;
    
    // إضافة تأثيرات hover
    classCard.addEventListener('mouseenter', () => {
      playCosmicSound('button-hover', { volume: 0.2 });
    });
    
    classGrid.appendChild(classCard);
  });
  
  playCosmicSound('panel-slide');
  
  // رسالة تأكيد تحميل الصفوف
  showQuantumNotification(
    `📚 تم تحميل ${Object.keys(studentData).length} صفوف`,
    'اختر صفك لبدء المغامرة',
    'success'
  );
  
  console.log('✅ تم تحميل بطاقات الصفوف بنجاح');
}

// إعادة تحميل بيانات الطلاب
async function reloadStudentData() {
  showQuantumNotification('🔄 جاري إعادة تحميل البيانات...', '', 'info');
  
  try {
    await loadStudentData();
    loadClassSelection();
    showQuantumNotification('✅ تم تحميل بيانات الطلاب بنجاح', '', 'success');
  } catch (error) {
    showQuantumNotification('❌ فشل في تحميل البيانات', 'سيتم استخدام البيانات الاحتياطية', 'error');
  }
}

function selectClass(className) {
  gameState.selectedClass = className;
  
  console.log('🎓 تم اختيار الصف:', className);
  
  // Update visual selection
  document.querySelectorAll('.class-card').forEach(card => {
    card.classList.remove('selected');
  });
  
  // Find and select the clicked card
  const clickedCard = Array.from(document.querySelectorAll('.class-card')).find(card => 
    card.textContent.includes(className)
  );
  if (clickedCard) {
    clickedCard.classList.add('selected');
  }
  
  // Load students for selected class
  loadStudentSelection(className);
  
  // Show student selection section
  const studentSection = document.getElementById('studentSelectionSection');
  if (studentSection) {
    studentSection.style.display = 'block';
    
    // Scroll to student selection
    studentSection.scrollIntoView({ 
      behavior: 'smooth' 
    });
  }
  
  // Play selection sound
  playCosmicSound('cosmic-click');
  
  // Show success notification
  showQuantumNotification(
    `✅ تم اختيار صف ${className}`,
    `${studentData[className]?.length || 0} طالب متاح`,
    'success'
  );
}

function loadStudentSelection(className) {
  console.log('📚 تحميل طلاب الصف:', className);
  console.log('📊 بيانات الطلاب:', studentData[className]);
  
  const studentsGrid = document.getElementById('studentsGrid');
  if (!studentsGrid) {
    console.error('❌ لم يتم العثور على studentsGrid');
    return;
  }
  
  studentsGrid.innerHTML = '';
  
  selectedStudentsList = []; // Reset selection
  updateSelectedCount();
  
  const students = studentData[className] || [];
  
  if (students.length === 0) {
    studentsGrid.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; color: #ff6b6b; padding: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
        <h3>لا توجد بيانات طلاب لهذا الصف</h3>
        <p>تحقق من ملف البيانات</p>
      </div>
    `;
    return;
  }
  
  console.log(`👥 تحميل ${students.length} طالب`);
  
  students.forEach((studentName, index) => {
    console.log(`👤 إنشاء بطاقة للطالب: ${studentName} (الفهرس: ${index})`);
    
    const studentCard = document.createElement('div');
    studentCard.className = 'student-card';
    studentCard.dataset.studentName = studentName;
    studentCard.dataset.studentIndex = index;
    
    // ربط الحدث بطريقة آمنة ومفصلة
    studentCard.addEventListener('click', function(event) {
      console.log('🖱️ تم النقر على بطاقة الطالب:', studentName);
      console.log('🎯 العنصر المنقور:', this);
      event.preventDefault();
      event.stopPropagation();
      toggleStudentSelection(this, studentName);
    });
    
    // إضافة تأثير hover
    studentCard.addEventListener('mouseenter', function() {
      console.log('🎭 مرور الماوس على بطاقة:', studentName);
      playCosmicSound('button-hover', { volume: 0.1 });
    });
    
    studentCard.innerHTML = `
      <div class="selection-indicator">○</div>
      <div class="student-name">${studentName}</div>
    `;
    
    console.log('✅ تم إنشاء بطاقة الطالب بنجاح');
    studentsGrid.appendChild(studentCard);
  });
  
  playCosmicSound('magic-sparkle');
  console.log('✅ تم تحميل بطاقات الطلاب بنجاح');
}

function toggleStudentSelection(cardElement, studentName) {
  console.log('🎯 بدء تبديل اختيار الطالب:', studentName);
  console.log('📋 عنصر البطاقة:', cardElement);
  
  if (!cardElement) {
    console.error('❌ عنصر البطاقة غير موجود');
    return;
  }
  
  if (!studentName) {
    console.error('❌ اسم الطالب غير موجود');
    return;
  }
  
  const isSelected = cardElement.classList.contains('selected');
  console.log('🔍 هل الطالب محدد حالياً؟', isSelected);
  
  const selectionIndicator = cardElement.querySelector('.selection-indicator');
  if (!selectionIndicator) {
    console.error('❌ لم يتم العثور على مؤشر الاختيار');
    return;
  }
  
  if (isSelected) {
    // Deselect
    console.log('➖ إلغاء تحديد الطالب');
    cardElement.classList.remove('selected');
    selectionIndicator.textContent = '○';
    selectedStudentsList = selectedStudentsList.filter(name => name !== studentName);
    playCosmicSound('button-hover');
  } else {
    // Select
    console.log('➕ تحديد الطالب');
    cardElement.classList.add('selected');
    selectionIndicator.textContent = '✓';
    selectedStudentsList.push(studentName);
    playCosmicSound('point-earn');
  }
  
  console.log('📊 القائمة الحالية للطلاب المحددين:', selectedStudentsList);
  updateSelectedCount();
  
  // إضافة تأثير بصري للتأكيد
  cardElement.style.transform = 'scale(1.05)';
  setTimeout(() => {
    cardElement.style.transform = '';
  }, 200);
}

function selectAllStudents() {
  const studentCards = document.querySelectorAll('.student-card');
  selectedStudentsList = [];
  
  studentCards.forEach(card => {
    card.classList.add('selected');
    card.querySelector('.selection-indicator').textContent = '✓';
    selectedStudentsList.push(card.dataset.studentName);
  });
  
  updateSelectedCount();
  playCosmicSound('achievement-unlock');
}

function clearAllStudents() {
  const studentCards = document.querySelectorAll('.student-card');
  selectedStudentsList = [];
  
  studentCards.forEach(card => {
    card.classList.remove('selected');
    card.querySelector('.selection-indicator').textContent = '○';
  });
  
  updateSelectedCount();
  playCosmicSound('cosmic-click');
}

function selectRandomStudents() {
  clearAllStudents();
  
  const studentCards = Array.from(document.querySelectorAll('.student-card'));
  const randomCount = Math.min(8, Math.max(4, Math.floor(studentCards.length * 0.4)));
  
  // Shuffle and select random students
  const shuffled = studentCards.sort(() => 0.5 - Math.random());
  const selected = shuffled.slice(0, randomCount);
  
  selected.forEach(card => {
    card.classList.add('selected');
    card.querySelector('.selection-indicator').textContent = '✓';
    selectedStudentsList.push(card.dataset.studentName);
  });
  
  updateSelectedCount();
  playSoundSequence(['cosmic-explosion', 'point-earn'], 300);
}

function quickSelectCount() {
  const studentCards = document.querySelectorAll('.student-card');
  const maxCount = studentCards.length;
  
  const count = parseInt(prompt(`كم عدد الطلاب المطلوب اختيارهم؟ (الحد الأقصى: ${maxCount})`, '6'));
  
  if (count && count > 0 && count <= maxCount) {
    clearAllStudents();
    
    const shuffled = Array.from(studentCards).sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, count);
    
    selected.forEach(card => {
      card.classList.add('selected');
      card.querySelector('.selection-indicator').textContent = '✓';
      selectedStudentsList.push(card.dataset.studentName);
    });
    
    updateSelectedCount();
    playCosmicSound('level-up');
  }
}

function updateSelectedCount() {
  console.log('🔢 تحديث عدد الطلاب المحددين...');
  
  const countElement = document.getElementById('selectedCount');
  const startBtn = document.getElementById('startGameBtn');
  
  if (!countElement) {
    console.error('❌ لم يتم العثور على عنصر العد selectedCount');
    return;
  }
  
  if (!startBtn) {
    console.error('❌ لم يتم العثور على زر البدء startGameBtn');
    return;
  }
  
  const selectedCount = selectedStudentsList.length;
  console.log(`👥 عدد الطلاب المختارين: ${selectedCount}`);
  console.log('📋 قائمة الطلاب المختارين:', selectedStudentsList);
  
  // تحديث النص مع تأثير بصري
  countElement.textContent = selectedCount;
  countElement.style.transform = 'scale(1.2)';
  countElement.style.color = selectedCount > 0 ? '#00ffff' : '#ffffff';
  
  setTimeout(() => {
    countElement.style.transform = 'scale(1)';
  }, 200);
  
  // Enable/disable start button
  if (selectedCount >= 2) {
    console.log('✅ تفعيل زر البدء - تم اختيار عدد كافي من الطلاب');
    startBtn.disabled = false;
    startBtn.style.opacity = '1';
    startBtn.style.cursor = 'pointer';
    startBtn.style.transform = 'scale(1.05)';
    
    // إشعار بصري للاستعداد
    showQuantumNotification(
      '🎯 جاهز للبدء!',
      `تم اختيار ${selectedCount} طالب`,
      'success'
    );
  } else {
    console.log('⚠️ تعطيل زر البدء - عدد الطلاب غير كافي');
    startBtn.disabled = true;
    startBtn.style.opacity = '0.5';
    startBtn.style.cursor = 'not-allowed';
    startBtn.style.transform = 'scale(1)';
    
    if (selectedCount === 1) {
      showQuantumNotification(
        '⏳ اختر طالب آخر',
        'يحتاج اللعبة إلى طالبين على الأقل',
        'info'
      );
    }
  }
  
  console.log(`🎮 حالة زر البدء: ${startBtn.disabled ? 'معطل' : 'مفعل'}`);
}

function startKingdomGame() {
  if (selectedStudentsList.length < 2) {
    showQuantumNotification('⚠️ تحذير', 'يجب اختيار طالبين على الأقل لبدء اللعبة', 'warning');
    return;
  }
  
  gameState.selectedStudents = [...selectedStudentsList];
  gameState.gameStarted = true;
  
  // Hide selection panel and show game interface
  document.getElementById('selectionPanel').style.display = 'none';
  document.getElementById('kingdomContent').style.display = 'block';
  document.getElementById('gameInterface').style.display = 'block';
  
  // Generate teams from selected students
  generateTeamsFromStudents();
  
  // Play epic start sequence
  playSoundSequence([
    'royal-fanfare',
    'kingdom-enter',
    'epic-charge'
  ], 1000);
  
  showQuantumNotification(
    '🏆 مملكة التحديات بدأت!', 
    `تم اختيار ${selectedStudentsList.length} مشارك من ${gameState.selectedClass}`, 
    'success'
  );
  
  // Show welcome message after selection
  setTimeout(() => {
    showWelcomeMessage();
  }, 2000);
}

function generateTeamsFromStudents() {
  const studentsCount = selectedStudentsList.length;
  const teamCount = Math.min(4, Math.max(2, Math.ceil(studentsCount / 3)));
  
  gameState.teams = [];
  const teamIcons = ['🦁', '🐉', '🦅', '🐺', '🦄', '🔥'];
  const teamNames = ['محاربو النور', 'فرسان الظلام', 'حماة السماء', 'أسياد الأرض', 'سحرة الزمن', 'عمالقة القوة'];
  
  // Shuffle students for random team assignment
  const shuffledStudents = [...selectedStudentsList].sort(() => 0.5 - Math.random());
  
  for (let i = 0; i < teamCount; i++) {
    const team = {
      id: i + 1,
      name: teamNames[i] || `الفريق ${i + 1}`,
      icon: teamIcons[i] || '⭐',
      score: 0,
      energy: 100,
      members: []
    };
    
    // Assign students to teams (round robin)
    for (let j = i; j < shuffledStudents.length; j += teamCount) {
      team.members.push(shuffledStudents[j]);
    }
    
    gameState.teams.push(team);
  }
  
  console.log('Generated teams:', gameState.teams);
}

function backToSetup() {
  if (confirm('هل أنت متأكد من العودة لإعداد النشاط؟ سيتم فقدان التقدم الحالي.')) {
    gameState.gameStarted = false;
    gameState.isActive = false;
    
    // Reset game state
    if (gameState.battleTimer) {
      clearInterval(gameState.battleTimer);
      gameState.battleTimer = null;
    }
    
    // Show selection panel and hide game interface
    document.getElementById('selectionPanel').style.display = 'block';
    document.getElementById('gameInterface').style.display = 'none';
    document.getElementById('kingdomDashboard').style.display = 'grid';
    document.getElementById('battleArena').style.display = 'none';
    
    playCosmicSound('panel-slide');
  }
}

// ===== TEACHER GUIDE FUNCTIONS =====
function openTeacherGuide() {
  document.getElementById('teacherGuideModal').style.display = 'block';
  playCosmicSound('menu-open');
}

function showTeacherGuide() {
  openTeacherGuide();
}

function closeTeacherGuide() {
  document.getElementById('teacherGuideModal').style.display = 'none';
  playCosmicSound('cosmic-click');
}
let aiCoachMessages = [
  "🌟 ممتاز! استمر في هذا الأداء المتميز",
  "💪 قوة التركيز هي سلاحك السري",
  "🧠 فكر خارج الصندوق لتجد الحل",
  "⚡ السرعة مهمة، لكن الدقة أهم",
  "🎯 ركز على الهدف ولا تدع شيئاً يشتت انتباهك",
  "🚀 أنت تتقدم بسرعة نحو النصر",
  "💎 كل تحدٍ تتغلب عليه يجعلك أقوى",
  "🔥 الحماس هو وقود النجاح"
];

// ===== INITIALIZATION =====
window.addEventListener('load', async () => {
  await initializeKingdom();
});

function initParticles() {
  particlesJS('particles-js', {
    particles: {
      number: { value: 100 },
      color: { value: ['#00ffff', '#ff00ff', '#ffd700'] },
      shape: { type: 'circle' },
      opacity: { value: 0.6, random: true },
      size: { value: 3, random: true },
      line_linked: { enable: true, distance: 150, color: '#ffffff', opacity: 0.4, width: 1 },
      move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
    },
    interactivity: {
      detect_on: 'canvas',
      events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
      modes: { grab: { distance: 400, line_linked: { opacity: 1 } }, bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 }, repulse: { distance: 200, duration: 0.4 }, push: { particles_nb: 4 }, remove: { particles_nb: 2 } }
    },
    retina_detect: true
  });
}

async function loadStudentData() {
  try {
    const response = await fetch('../data/studentData.json');
    if (response.ok) {
      studentData = await response.json();
      console.log('✅ تم تحميل بيانات الطلاب بنجاح:', Object.keys(studentData));
    } else {
      throw new Error('فشل تحميل البيانات');
    }
  } catch (error) {
    console.warn('⚠️ استخدام البيانات الاحتياطية:', error);
    // بيانات احتياطية أكثر تفصيلاً
    studentData = {
      "خامس 1": [
        "أحمد محمد السيابي", "فاطمة علي الحارثي", "عبدالله سالم الجابري", 
        "مريم أحمد البلوشي", "سعيد يوسف المحرمي", "نور حسن الرواحي",
        "خالد طارق البوسعيدي", "عائشة سليمان الفارسي"
      ],
      "خامس 2": [
        "سارة حسن اليحيائي", "محمد عمر الحديدي", "نور الدين المسافر", 
        "عائشة خالد الضامري", "راشد سالم الوهيبي", "زينب أحمد الحبسي",
        "عبدالرحمن ناصر البريكي", "لطيفة محمد الصبحي"
      ],
      "سادس 1": [
        "علي محمد الزدجالي", "حليمة أحمد العمري", "يوسف سعيد الخربوشي",
        "خديجة علي الحوسني", "طارق خليل البلوشي", "آمنة حمود الحضرمي"
      ],
      "سادس 2": [
        "إبراهيم سالم الليثي", "رقية محمد الرمضاني", "حمزة أحمد اليوسفي",
        "فاطمة سيف السعيدي", "عثمان ناصر الهطالي", "خولة عبدالله المسلمي"
      ]
    };
    console.log('📚 تم تحميل البيانات الاحتياطية:', Object.keys(studentData));
  }
}

// إعادة تحميل بيانات الطلاب عند الحاجة
async function reloadStudentData() {
  console.log('🔄 إعادة تحميل بيانات الطلاب...');
  
  try {
    showQuantumNotification('⏳ جاري إعادة التحميل...', 'يرجى الانتظار', 'info');
    
    const response = await fetch('../data/studentData.json?' + new Date().getTime());
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('📊 تم تحميل البيانات الجديدة:', Object.keys(data));
    
    studentData = data;
    
    showQuantumNotification(
      '✅ تم التحديث بنجاح',
      `تم تحميل ${Object.keys(data).length} صفوف`,
      'success'
    );
    
    // إعادة تحميل اختيار الصفوف
    setTimeout(() => {
      loadClassSelection();
    }, 1000);
    
  } catch (error) {
    console.error('❌ فشل في إعادة التحميل:', error);
    showQuantumNotification(
      '❌ فشل في التحميل',
      'يرجى التأكد من ملف البيانات',
      'error'
    );
  }
}

// دالة اختبار لنظام الاختيار (للتطوير والتشخيص)
function testSelectionSystem() {
  console.log('🧪 اختبار نظام الاختيار...');
  
  const studentCards = document.querySelectorAll('.student-card');
  console.log(`🔍 تم العثور على ${studentCards.length} بطاقة طالب`);
  
  if (studentCards.length === 0) {
    console.error('❌ لا توجد بطاقات طلاب للاختبار');
    showQuantumNotification(
      '❌ خطأ في الاختبار',
      'لا توجد بطاقات طلاب',
      'error'
    );
    return;
  }
  
  // اختبار اختيار الطالب الأول
  const firstCard = studentCards[0];
  const studentName = firstCard.dataset.studentName;
  
  console.log(`🎯 اختبار اختيار الطالب: ${studentName}`);
  
  // محاكاة النقر
  firstCard.click();
  
  setTimeout(() => {
    console.log('📊 نتائج الاختبار:');
    console.log('- عدد الطلاب المحددين:', selectedStudentsList.length);
    console.log('- قائمة الطلاب:', selectedStudentsList);
    console.log('- حالة البطاقة:', firstCard.classList.contains('selected') ? 'محددة' : 'غير محددة');
    
    const indicator = firstCard.querySelector('.selection-indicator');
    console.log('- نص المؤشر:', indicator ? indicator.textContent : 'غير موجود');
    
    if (selectedStudentsList.length > 0 && firstCard.classList.contains('selected')) {
      showQuantumNotification(
        '✅ نظام الاختيار يعمل',
        'تم اختبار النظام بنجاح',
        'success'
      );
    } else {
      showQuantumNotification(
        '❌ مشكلة في النظام',
        'فشل اختبار نظام الاختيار',
        'error'
      );
    }
  }, 500);
}

// إضافة الدالة للوحة التحكم العامة (للمطورين)
window.testSelectionSystem = testSelectionSystem;

// التأكد من ظهور أزرار التحكم
function ensureControlHeaderVisible() {
  console.log('🔧 التأكد من ظهور أزرار التحكم...');
  
  const controlHeader = document.querySelector('.cosmic-control-header');
  if (!controlHeader) {
    console.error('❌ لم يتم العثور على header التحكم');
    return;
  }
  
  // فرض ظهور العنصر
  controlHeader.style.display = 'flex';
  controlHeader.style.visibility = 'visible';
  controlHeader.style.opacity = '1';
  controlHeader.style.zIndex = '99999';
  controlHeader.style.position = 'fixed';
  controlHeader.style.top = '0';
  controlHeader.style.left = '0';
  controlHeader.style.right = '0';
  
  // فحص الأزرار الفردية
  const buttons = controlHeader.querySelectorAll('.cosmic-control-btn');
  console.log(`🎮 تم العثور على ${buttons.length} أزرار تحكم`);
  
  buttons.forEach((btn, index) => {
    btn.style.display = 'flex';
    btn.style.visibility = 'visible';
    btn.style.opacity = '1';
    console.log(`✅ زر ${index + 1} مرئي:`, btn.id || btn.textContent);
  });
  
  // إضافة مساحة للمحتوى تحت الشريط
  document.body.style.paddingTop = '80px';
  
  console.log('✅ تم التأكد من ظهور أزرار التحكم');
}

// ===== REALM ACTIVATION =====
function activateRealm(realmType) {
  gameState.currentRealm = realmType;
  
  createCosmicExplosion(event.target);
  
  // Enhanced realm-specific sound effects
  switch(realmType) {
    case 'lightning':
      playSoundSequence(['cosmic-portal', 'lightning-strike'], 300);
      break;
    case 'wisdom':
      playSoundSequence(['cosmic-portal', 'wisdom-chime'], 300);
      break;
    case 'battle':
      playSoundSequence(['cosmic-portal', 'war-drum'], 300);
      break;
    case 'mystery':
      playSoundSequence(['cosmic-portal', 'mystery-whisper'], 300);
      break;
  }
  
  setTimeout(() => {
    switch(realmType) {
      case 'lightning':
        startLightningChallenge();
        break;
      case 'wisdom':
        startWisdomChallenge();
        break;
      case 'battle':
        enterBattleArena();
        break;
      case 'mystery':
        startMysteryChallenge();
        break;
    }
  }, 500);
}

function enterBattleArena() {
  document.getElementById('kingdomDashboard').style.display = 'none';
  document.getElementById('battleArena').style.display = 'block';
  
  // Epic battle arena entrance
  playCosmicSound('battle-horn', { volume: 0.8 });
  setTimeout(() => playCosmicSound('epic-charge'), 1000);
  
  showQuantumNotification('⚔️ دخول ساحة المعركة', 'استعد للمعركة الأسطورية!', 'battle');
  generateTeams();
}

function generateTeams() {
  const teamsContainer = document.getElementById('teamsHologram');
  teamsContainer.innerHTML = '';
  
  // If no teams generated yet, generate from selected students
  if (gameState.teams.length === 0) {
    generateTeamsFromStudents();
  }
  
  gameState.teams.forEach(team => {
    const teamElement = document.createElement('div');
    teamElement.className = 'team-hologram';
    
    // Create members list display
    const membersDisplay = team.members.length > 0 
      ? `<div style="font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 0.5rem;">
           الأعضاء: ${team.members.slice(0, 2).join(', ')}${team.members.length > 2 ? '...' : ''}
         </div>`
      : '';
    
    teamElement.innerHTML = `
      <div class="team-avatar-3d">${team.icon}</div>
      <div class="team-name-glow">${team.name}</div>
      <div class="score-crystal" id="score-${team.id}">${team.score}</div>
      ${membersDisplay}
      <div style="margin-top: 1rem;">
        <button class="neural-button" onclick="addPointToTeam(${team.id})">⬆️ نقطة</button>
        <button class="neural-button" onclick="removePointFromTeam(${team.id})">⬇️ خصم</button>
      </div>
      <div style="margin-top: 0.5rem; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
        الطاقة: <span id="energy-${team.id}">${team.energy}%</span>
      </div>
    `;
    
    teamsContainer.appendChild(teamElement);
  });
}

// ===== BATTLE SYSTEM =====
function startBattle() {
  if (gameState.isActive) return;
  
  gameState.isActive = true;
  gameState.battleDuration = 0;
  
  // Epic battle start sequence
  playSoundSequence([
    'battle-horn',
    { type: 'timer-start', options: { volume: 0.6 } },
    { type: 'epic-charge', options: { volume: 0.8 } }
  ], 800);
  
  showQuantumNotification('🚀 بدء المعركة!', 'المعركة الأسطورية بدأت الآن!', 'success');
  
  gameState.battleTimer = setInterval(() => {
    gameState.battleDuration++;
    updateBattleTimer();
    
    // Random events during battle
    if (gameState.battleDuration % 30 === 0) {
      triggerRandomEvent();
    }
    
    // Countdown warning sounds
    if (gameState.battleDuration > 0 && gameState.battleDuration % 60 === 50) {
      playCosmicSound('time-warning');
    }
  }, 1000);
  
  // Start cosmic rain
  startCosmicRain();
}

function pauseBattle() {
  if (!gameState.isActive) return;
  
  gameState.isActive = false;
  clearInterval(gameState.battleTimer);
  
  playCosmicSound('timer-pause');
  showQuantumNotification('⏸️ معركة متوقفة', 'تم إيقاف المعركة مؤقتاً', 'warning');
}

function endBattle() {
  gameState.isActive = false;
  clearInterval(gameState.battleTimer);
  
  const winner = findWinner();
  
  // Victory sound sequence
  playSoundSequence([
    'battle-victory',
    'crown-ceremony',
    'crowd-cheer'
  ], 1000);
  
  celebrateVictory(winner);
  
  gameState.completedChallenges++;
  updateStats();
}

function resetArena() {
  gameState.isActive = false;
  clearInterval(gameState.battleTimer);
  gameState.battleDuration = 0;
  
  // Reset all teams
  gameState.teams.forEach(team => {
    team.score = 0;
    team.energy = 100;
    document.getElementById(`score-${team.id}`).textContent = '0';
    document.getElementById(`energy-${team.id}`).textContent = '100%';
  });
  
  updateBattleTimer();
  playCosmicSound('cosmic-click');
  showQuantumNotification('🔄 إعادة تعيين', 'تم إعادة تعيين ساحة المعركة', 'info');
}

// ===== TEAM MANAGEMENT =====
function addPointToTeam(teamId) {
  const team = gameState.teams.find(t => t.id === teamId);
  if (team) {
    team.score++;
    document.getElementById(`score-${team.id}`).textContent = team.score;
    
    // Energy boost
    team.energy = Math.min(100, team.energy + 5);
    document.getElementById(`energy-${team.id}`).textContent = team.energy + '%';
    
    createCosmicStars();
    
    // Enhanced point sound effects
    if (team.score % 10 === 0) {
      playCosmicSound('perfect-score');
    } else if (team.score % 5 === 0) {
      playCosmicSound('achievement-unlock');
    } else {
      playCosmicSound('point-earn');
    }
    
    // Combo system
    const comboCount = getTeamCombo(teamId);
    if (comboCount >= 3) {
      playCosmicSound('combo-hit');
      setTimeout(() => playCosmicSound('energy-boost'), 200);
    }
    
    // Check for achievement
    if (team.score % 5 === 0) {
      showQuantumNotification('🏆 إنجاز!', `${team.name} حقق ${team.score} نقاط!`, 'achievement');
      playCosmicSound('level-up');
    }
  }
}

function removePointFromTeam(teamId) {
  const team = gameState.teams.find(t => t.id === teamId);
  if (team && team.score > 0) {
    team.score--;
    document.getElementById(`score-${team.id}`).textContent = team.score;
    
    // Energy drain
    team.energy = Math.max(0, team.energy - 3);
    document.getElementById(`energy-${team.id}`).textContent = team.energy + '%';
    
    playCosmicSound('point-lose');
  }
}

// Helper function for combo system
function getTeamCombo(teamId) {
  // Simple combo tracking (can be enhanced)
  if (!gameState.teamCombos) gameState.teamCombos = {};
  if (!gameState.teamCombos[teamId]) gameState.teamCombos[teamId] = 0;
  gameState.teamCombos[teamId]++;
  
  // Reset combo after 5 seconds
  setTimeout(() => {
    if (gameState.teamCombos[teamId]) gameState.teamCombos[teamId] = 0;
  }, 5000);
  
  return gameState.teamCombos[teamId];
}

// ===== SPECIAL EFFECTS =====
function createCosmicExplosion(element) {
  const rect = element.getBoundingClientRect();
  const explosion = document.createElement('div');
  explosion.className = 'cosmic-explosion';
  explosion.style.left = (rect.left + rect.width / 2 - 100) + 'px';
  explosion.style.top = (rect.top + rect.height / 2 - 100) + 'px';
  document.body.appendChild(explosion);
  
  setTimeout(() => explosion.remove(), 1000);
}

function createCosmicStars() {
  for (let i = 0; i < 10; i++) {
    setTimeout(() => {
      const star = document.createElement('div');
      star.className = 'cosmic-star';
      star.textContent = ['⭐', '✨', '💫', '🌟'][Math.floor(Math.random() * 4)];
      star.style.left = Math.random() * window.innerWidth + 'px';
      star.style.top = '-50px';
      document.body.appendChild(star);
      
      setTimeout(() => star.remove(), 4000);
    }, i * 100);
  }
}

function startCosmicRain() {
  const rainInterval = setInterval(() => {
    if (!gameState.isActive) {
      clearInterval(rainInterval);
      return;
    }
    
    createCosmicStars();
  }, 2000);
}

// ===== AI COACH SYSTEM =====
function getAITip() {
  const tip = aiCoachMessages[Math.floor(Math.random() * aiCoachMessages.length)];
  const messagesContainer = document.getElementById('aiCoachMessages');
  
  const tipElement = document.createElement('div');
  tipElement.style.cssText = `
    background: linear-gradient(45deg, rgba(0,255,255,0.2), rgba(255,0,255,0.2));
    padding: 1rem;
    border-radius: 10px;
    margin: 0.5rem 0;
    border: 1px solid rgba(0,255,255,0.5);
    animation: fadeInUp 0.5s ease;
  `;
  tipElement.textContent = tip;
  
  messagesContainer.appendChild(tipElement);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // Enhanced AI coach sounds
  playSoundSequence([
    'ai-beep',
    'ai-notification'
  ], 300);
}

function analyzePerformance() {
  const analysis = generatePerformanceAnalysis();
  const messagesContainer = document.getElementById('aiCoachMessages');
  
  const analysisElement = document.createElement('div');
  analysisElement.style.cssText = `
    background: linear-gradient(45deg, rgba(255,215,0,0.2), rgba(255,105,180,0.2));
    padding: 1rem;
    border-radius: 10px;
    margin: 0.5rem 0;
    border: 1px solid rgba(255,215,0,0.5);
    animation: fadeInUp 0.5s ease;
  `;
  analysisElement.innerHTML = analysis;
  
  messagesContainer.appendChild(analysisElement);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // Data processing sound sequence
  playSoundSequence([
    'scanner-beep',
    'data-process',
    'ai-notification'
  ], 500);
}

function generatePerformanceAnalysis() {
  const sessionMinutes = Math.floor((Date.now() - gameState.sessionStartTime) / 60000);
  const avgPointsPerMinute = sessionMinutes > 0 ? (getTotalPoints() / sessionMinutes).toFixed(1) : 0;
  
  return `
    📊 <strong>تحليل الأداء:</strong><br>
    ⏱️ وقت الجلسة: ${sessionMinutes} دقيقة<br>
    🎯 التحديات المكتملة: ${gameState.completedChallenges}<br>
    ⚡ متوسط النقاط/دقيقة: ${avgPointsPerMinute}<br>
    💪 تقييم الأداء: ${getPerformanceRating(avgPointsPerMinute)}
  `;
}

function getPerformanceRating(avgPoints) {
  if (avgPoints >= 2) return "🔥 ممتاز";
  if (avgPoints >= 1) return "💪 جيد جداً";
  if (avgPoints >= 0.5) return "👍 جيد";
  return "📈 يمكن التحسن";
}

// ===== UTILITY FUNCTIONS =====
function updateBattleTimer() {
  const minutes = Math.floor(gameState.battleDuration / 60);
  const seconds = gameState.battleDuration % 60;
  document.getElementById('challengeTimer').textContent = 
    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startSessionTimer() {
  setInterval(() => {
    const elapsed = Math.floor((Date.now() - gameState.sessionStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('sessionTime').textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

function updateStats() {
  document.getElementById('completedChallenges').textContent = gameState.completedChallenges;
  
  // Update energy based on activity
  gameState.energyLevel = Math.max(50, gameState.energyLevel - 5);
  document.getElementById('energyLevel').textContent = gameState.energyLevel + '%';
}

function getTotalPoints() {
  return gameState.teams.reduce((total, team) => total + team.score, 0);
}

function findWinner() {
  return gameState.teams.reduce((winner, team) => 
    team.score > winner.score ? team : winner
  );
}

function celebrateVictory(winner) {
  // Massive confetti celebration
  confetti({
    particleCount: 200,
    spread: 100,
    origin: { y: 0.6 },
    colors: ['#FFD700', '#FF6347', '#00FFFF', '#FF00FF']
  });
  
  setTimeout(() => {
    confetti({
      particleCount: 150,
      spread: 120,
      origin: { x: 0.1, y: 0.7 }
    });
  }, 300);
  
  setTimeout(() => {
    confetti({
      particleCount: 150,
      spread: 120,
      origin: { x: 0.9, y: 0.7 }
    });
  }, 600);
  
  showQuantumNotification('👑 النصر!', `${winner.name} فاز بالمعركة الأسطورية!`, 'victory');
  
  // Ultimate victory sound sequence
  playSoundSequence([
    'ultimate-triumph',
    'fireworks-burst',
    'golden-confetti'
  ], 1500);
  
  createCosmicStars();
}

function triggerRandomEvent() {
  const events = [
    { 
      text: '⚡ عاصفة كونية! جميع الفرق تحصل على طاقة إضافية', 
      effect: 'energy_boost',
      sound: ['cosmic-explosion', 'energy-boost']
    },
    { 
      text: '🌟 نجم ساقط! نقطة مضاعفة للفريق التالي', 
      effect: 'double_points',
      sound: ['star-fall', 'bonus-collect']
    },
    { 
      text: '🌀 دوامة زمنية! الوقت يتباطأ', 
      effect: 'time_slow',
      sound: ['time-warp', 'mystic-wind']
    },
    { 
      text: '💎 كريستال سحري ظهر! مكافأة خاصة', 
      effect: 'bonus_crystal',
      sound: ['crystal-ping', 'crystal-bonus']
    },
    {
      text: '🔮 بوابة بُعدية فُتحت! طاقة سحرية تملأ الساحة',
      effect: 'portal_magic',
      sound: ['portal-open', 'spell-cast']
    },
    {
      text: '🏆 إنجاز ملكي! جميع الفرق تحصل على نقاط إضافية',
      effect: 'royal_bonus',
      sound: ['royal-fanfare', 'achievement-unlock']
    }
  ];
  
  const event = events[Math.floor(Math.random() * events.length)];
  showQuantumNotification('🎆 حدث خاص!', event.text, 'special');
  
  // Play event sound sequence
  if (event.sound) {
    playSoundSequence(event.sound, 800);
  }
  
  // Apply event effect
  switch(event.effect) {
    case 'energy_boost':
      gameState.teams.forEach(team => {
        team.energy = Math.min(100, team.energy + 20);
        document.getElementById(`energy-${team.id}`).textContent = team.energy + '%';
      });
      break;
      
    case 'double_points':
      gameState.doublePointsNext = true;
      setTimeout(() => gameState.doublePointsNext = false, 10000);
      break;
      
    case 'bonus_crystal':
      gameState.teams.forEach(team => {
        team.score += 2;
        document.getElementById(`score-${team.id}`).textContent = team.score;
      });
      break;
      
    case 'portal_magic':
      gameState.teams.forEach(team => {
        team.energy = 100;
        document.getElementById(`energy-${team.id}`).textContent = '100%';
      });
      break;
      
    case 'royal_bonus':
      gameState.teams.forEach(team => {
        team.score += 1;
        document.getElementById(`score-${team.id}`).textContent = team.score;
      });
      break;
  }
}

// ===== ADVANCED SOUND SYSTEM =====
let audioContext = null;
let masterVolume = 0.7;
let soundQueue = [];
let activeSounds = new Map();

// Initialize Web Audio Context for better sound control
function initAudioSystem() {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    console.log('🎵 نظام الصوت المتقدم جاهز!');
  } catch (error) {
    console.warn('⚠️ فشل في تهيئة نظام الصوت المتقدم، استخدام النظام التقليدي');
  }
}

function playCosmicSound(soundType, options = {}) {
  if (!gameState.soundEnabled) return;
  
  // Enhanced sound library with all kingdom sounds
  const sounds = {
    // Kingdom Core Sounds
    'kingdom-enter': '../assets/media/sounds/kingdom-sounds/kingdom-enter.mp3',
    'cosmic-portal': '../assets/media/sounds/kingdom-sounds/cosmic-portal.mp3',
    'magic-sparkle': '../assets/media/sounds/kingdom-sounds/magic-sparkle.mp3',
    'royal-fanfare': '../assets/media/sounds/kingdom-sounds/royal-fanfare.mp3',
    
    // Lightning Realm Sounds
    'lightning-strike': '../assets/media/sounds/kingdom-sounds/lightning-strike.mp3',
    'electric-charge': '../assets/media/sounds/kingdom-sounds/electric-charge.mp3',
    'thunder-rumble': '../assets/media/sounds/kingdom-sounds/thunder-rumble.mp3',
    'lightning-whoosh': '../assets/media/sounds/kingdom-sounds/lightning-whoosh.mp3',
    
    // Wisdom Realm Sounds
    'wisdom-chime': '../assets/media/sounds/kingdom-sounds/wisdom-chime.mp3',
    'brain-activate': '../assets/media/sounds/kingdom-sounds/brain-activate.mp3',
    'ancient-bell': '../assets/media/sounds/kingdom-sounds/ancient-bell.mp3',
    'knowledge-unlock': '../assets/media/sounds/kingdom-sounds/knowledge-unlock.mp3',
    
    // Battle Arena Sounds
    'battle-horn': '../assets/media/sounds/kingdom-sounds/battle-horn.mp3',
    'sword-clash': '../assets/media/sounds/kingdom-sounds/sword-clash.mp3',
    'armor-clank': '../assets/media/sounds/kingdom-sounds/armor-clank.mp3',
    'war-drum': '../assets/media/sounds/kingdom-sounds/war-drum.mp3',
    'epic-charge': '../assets/media/sounds/kingdom-sounds/epic-charge.mp3',
    'shield-block': '../assets/media/sounds/kingdom-sounds/shield-block.mp3',
    'battle-victory': '../assets/media/sounds/kingdom-sounds/battle-victory.mp3',
    
    // Mystery Realm Sounds
    'mystery-whisper': '../assets/media/sounds/kingdom-sounds/mystery-whisper.mp3',
    'crystal-ping': '../assets/media/sounds/kingdom-sounds/crystal-ping.mp3',
    'mystic-wind': '../assets/media/sounds/kingdom-sounds/mystic-wind.mp3',
    'spell-cast': '../assets/media/sounds/kingdom-sounds/spell-cast.mp3',
    'riddle-solved': '../assets/media/sounds/kingdom-sounds/riddle-solved.mp3',
    
    // AI Coach Sounds
    'ai-beep': '../assets/media/sounds/kingdom-sounds/ai-beep.mp3',
    'robot-voice': '../assets/media/sounds/kingdom-sounds/robot-voice.mp3',
    'data-process': '../assets/media/sounds/kingdom-sounds/data-process.mp3',
    'ai-notification': '../assets/media/sounds/kingdom-sounds/ai-notification.mp3',
    'scanner-beep': '../assets/media/sounds/kingdom-sounds/scanner-beep.mp3',
    
    // Points & Achievements
    'point-earn': '../assets/media/sounds/kingdom-sounds/point-earn.mp3',
    'point-lose': '../assets/media/sounds/kingdom-sounds/point-lose.mp3',
    'combo-hit': '../assets/media/sounds/kingdom-sounds/combo-hit.mp3',
    'achievement-unlock': '../assets/media/sounds/kingdom-sounds/achievement-unlock.mp3',
    'level-up': '../assets/media/sounds/kingdom-sounds/level-up.mp3',
    'bonus-collect': '../assets/media/sounds/kingdom-sounds/bonus-collect.mp3',
    'perfect-score': '../assets/media/sounds/kingdom-sounds/perfect-score.mp3',
    
    // Special Effects & Random Events
    'cosmic-explosion': '../assets/media/sounds/kingdom-sounds/cosmic-explosion.mp3',
    'star-fall': '../assets/media/sounds/kingdom-sounds/star-fall.mp3',
    'time-warp': '../assets/media/sounds/kingdom-sounds/time-warp.mp3',
    'energy-boost': '../assets/media/sounds/kingdom-sounds/energy-boost.mp3',
    'crystal-bonus': '../assets/media/sounds/kingdom-sounds/crystal-bonus.mp3',
    'portal-open': '../assets/media/sounds/kingdom-sounds/portal-open.mp3',
    'dimensional-shift': '../assets/media/sounds/kingdom-sounds/dimensional-shift.mp3',
    
    // Celebration & Victory
    'epic-victory': '../assets/media/sounds/kingdom-sounds/epic-victory.mp3',
    'crown-ceremony': '../assets/media/sounds/kingdom-sounds/crown-ceremony.mp3',
    'fireworks-burst': '../assets/media/sounds/kingdom-sounds/fireworks-burst.mp3',
    'crowd-cheer': '../assets/media/sounds/kingdom-sounds/crowd-cheer.mp3',
    'golden-confetti': '../assets/media/sounds/kingdom-sounds/golden-confetti.mp3',
    'ultimate-triumph': '../assets/media/sounds/kingdom-sounds/ultimate-triumph.mp3',
    
    // UI & Control Sounds
    'button-hover': '../assets/media/sounds/kingdom-sounds/button-hover.mp3',
    'panel-slide': '../assets/media/sounds/kingdom-sounds/panel-slide.mp3',
    'menu-open': '../assets/media/sounds/kingdom-sounds/menu-open.mp3',
    'setting-change': '../assets/media/sounds/kingdom-sounds/setting-change.mp3',
    'notification-pop': '../assets/media/sounds/kingdom-sounds/notification-pop.mp3',
    'cosmic-click': '../assets/media/sounds/kingdom-sounds/cosmic-click.mp3',
    
    // Timer & Countdown
    'countdown-tick': '../assets/media/sounds/kingdom-sounds/countdown-tick.mp3',
    'final-countdown': '../assets/media/sounds/kingdom-sounds/final-countdown.mp3',
    'time-warning': '../assets/media/sounds/kingdom-sounds/time-warning.mp3',
    'time-up': '../assets/media/sounds/kingdom-sounds/time-up.mp3',
    'timer-start': '../assets/media/sounds/kingdom-sounds/timer-start.mp3',
    'timer-pause': '../assets/media/sounds/kingdom-sounds/timer-pause.mp3',
    
    // Legacy sounds fallback
    'realm-activate': '../assets/media/sounds/kingdom-sounds/cosmic-portal.mp3',
    'battle-start': '../assets/media/sounds/kingdom-sounds/battle-horn.mp3',
    'battle-pause': '../assets/media/sounds/kingdom-sounds/timer-pause.mp3',
    'point-gained': '../assets/media/sounds/kingdom-sounds/point-earn.mp3',
    'point-lost': '../assets/media/sounds/kingdom-sounds/point-lose.mp3',
    'victory': '../assets/media/sounds/kingdom-sounds/epic-victory.mp3',
    'ai-tip': '../assets/media/sounds/kingdom-sounds/ai-notification.mp3',
    'analysis': '../assets/media/sounds/kingdom-sounds/data-process.mp3',
    'reset': '../assets/media/sounds/kingdom-sounds/cosmic-click.mp3'
  };
  
  const soundPath = sounds[soundType];
  if (soundPath) {
    const audio = new Audio(soundPath);
    
    // Apply options
    audio.volume = (options.volume || masterVolume) * (gameState.soundEnabled ? 1 : 0);
    
    // Advanced sound controls
    if (options.loop) audio.loop = true;
    if (options.delay) {
      setTimeout(() => audio.play().catch(e => console.log('Sound play failed:', e)), options.delay);
    } else {
      audio.play().catch(e => console.log('Sound play failed:', e));
    }
    
    // Track active sounds
    if (options.id) {
      activeSounds.set(options.id, audio);
    }
    
    // Auto cleanup
    audio.addEventListener('ended', () => {
      if (options.id) activeSounds.delete(options.id);
    });
    
    return audio;
  }
}

// Enhanced sound control functions
function stopSound(soundId) {
  const audio = activeSounds.get(soundId);
  if (audio) {
    audio.pause();
    audio.currentTime = 0;
    activeSounds.delete(soundId);
  }
}

function fadeOutSound(soundId, duration = 1000) {
  const audio = activeSounds.get(soundId);
  if (audio) {
    const startVolume = audio.volume;
    const fadeStep = startVolume / (duration / 50);
    
    const fadeInterval = setInterval(() => {
      audio.volume = Math.max(0, audio.volume - fadeStep);
      if (audio.volume <= 0) {
        clearInterval(fadeInterval);
        audio.pause();
        activeSounds.delete(soundId);
      }
    }, 50);
  }
}

function setMasterVolume(volume) {
  masterVolume = Math.max(0, Math.min(1, volume));
  activeSounds.forEach(audio => {
    audio.volume = masterVolume * (gameState.soundEnabled ? 1 : 0);
  });
}

// Play sound sequences
function playSoundSequence(sounds, interval = 500) {
  sounds.forEach((sound, index) => {
    setTimeout(() => {
      if (typeof sound === 'string') {
        playCosmicSound(sound);
      } else {
        playCosmicSound(sound.type, sound.options);
      }
    }, index * interval);
  });
}

function toggleSound() {
  gameState.soundEnabled = !gameState.soundEnabled;
  const button = document.getElementById('soundToggle');
  button.innerHTML = gameState.soundEnabled ? '🔊 الصوت' : '🔇 صامت';
  
  // Play sound toggle feedback
  if (gameState.soundEnabled) {
    setTimeout(() => playCosmicSound('setting-change'), 100);
  }
}

// ===== NOTIFICATIONS SYSTEM =====
function showQuantumNotification(title, message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = 'quantum-notification';
  
  const icons = {
    info: '💫',
    success: '✅',
    warning: '⚠️',
    error: '❌',
    battle: '⚔️',
    victory: '👑',
    achievement: '🏆',
    special: '🎆'
  };
  
  // Enhanced notification sounds
  const notificationSounds = {
    info: 'notification-pop',
    success: ['notification-pop', 'magic-sparkle'],
    warning: 'time-warning',
    error: 'cosmic-click',
    battle: ['notification-pop', 'war-drum'],
    victory: ['notification-pop', 'crown-ceremony'],
    achievement: ['notification-pop', 'achievement-unlock'],
    special: ['notification-pop', 'cosmic-explosion']
  };
  
  notification.innerHTML = `
    <div class="notification-header">
      <span class="notification-icon">${icons[type] || '💫'}</span>
      <strong>${title}</strong>
      <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:white;font-size:1.2rem;cursor:pointer;">×</button>
    </div>
    <div>${message}</div>
  `;
  
  document.body.appendChild(notification);
  
  // Play notification sound
  const sound = notificationSounds[type];
  if (Array.isArray(sound)) {
    playSoundSequence(sound, 300);
  } else {
    playCosmicSound(sound || 'notification-pop');
  }
  
  // Show animation
  setTimeout(() => notification.classList.add('show'), 100);
  
  // Auto remove
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 500);
  }, 5000);
}

function showWelcomeMessage() {
  // Welcome sequence with royal fanfare
  playSoundSequence([
    'kingdom-enter',
    'royal-fanfare',
    'magic-sparkle'
  ], 1000);
  
  showQuantumNotification(
    '🌟 مرحباً بك في مملكة التحديات!',
    'استعد لخوض أعظم المغامرات التعليمية في الكون!',
    'success'
  );
}

// ===== CHALLENGE TYPES =====
function startLightningChallenge() {
  // Lightning realm entrance
  playSoundSequence([
    'lightning-strike',
    'electric-charge',
    'thunder-rumble'
  ], 600);
  
  showQuantumNotification('⚡ تحدي البرق', 'تحدي سريع لمدة دقيقة واحدة!', 'battle');
  
  // Quick challenge implementation
  let lightningTimer = 60;
  const timerInterval = setInterval(() => {
    lightningTimer--;
    if (lightningTimer <= 10) {
      playCosmicSound('countdown-tick');
    }
    if (lightningTimer <= 0) {
      clearInterval(timerInterval);
      playCosmicSound('lightning-whoosh');
      showQuantumNotification('⚡ انتهى الوقت!', 'تحدي البرق اكتمل!', 'success');
    }
  }, 1000);
}

function startWisdomChallenge() {
  // Wisdom realm entrance
  playSoundSequence([
    'wisdom-chime',
    'ancient-bell',
    'brain-activate'
  ], 800);
  
  showQuantumNotification('🧠 تحدي الحكمة', 'تحدي فكري عميق ومعقد!', 'info');
  
  // Wisdom challenge with thinking time
  setTimeout(() => {
    playCosmicSound('knowledge-unlock');
    showQuantumNotification('💡 فكر بعمق', 'الحكمة تحتاج للتأمل والصبر', 'info');
  }, 3000);
}

function startMysteryChallenge() {
  // Mystery realm entrance
  playSoundSequence([
    'mystery-whisper',
    'mystic-wind',
    'spell-cast'
  ], 700);
  
  showQuantumNotification('🔮 تحدي الألغاز', 'لغز غامض ينتظر حله!', 'special');
  
  // Mystery challenge with suspense
  setTimeout(() => {
    playCosmicSound('crystal-ping');
    showQuantumNotification('🔍 ابحث عن الأدلة', 'الألغاز تحتاج لعين ثاقبة!', 'special');
  }, 2000);
  
  setTimeout(() => {
    const solved = Math.random() > 0.5;
    if (solved) {
      playCosmicSound('riddle-solved');
      showQuantumNotification('✅ حُل اللغز!', 'أحسنت! لقد كشفت الحقيقة', 'success');
    }
  }, 8000);
}

function openSettings() {
  playCosmicSound('menu-open');
  showQuantumNotification('⚙️ الإعدادات', 'لوحة الإعدادات المتقدمة قريباً!', 'info');
}

// ===== ENHANCED UI INTERACTIONS =====
// Add hover sound effects to buttons
document.addEventListener('DOMContentLoaded', () => {
  // Initialize audio system
  initAudioSystem();
  
  // Add hover effects to neural buttons after page load
  setTimeout(() => {
    const buttons = document.querySelectorAll('.neural-button, .realm-card');
    buttons.forEach(button => {
      button.addEventListener('mouseenter', () => {
        playCosmicSound('button-hover', { volume: 0.3 });
      });
      
      button.addEventListener('click', () => {
        playCosmicSound('cosmic-click', { volume: 0.5 });
      });
    });
  }, 1000);
});

// ===== INITIALIZATION =====
window.addEventListener('load', async () => {
  await initializeKingdom();
});

async function initializeKingdom() {
  console.log('🏰 بدء تهيئة المملكة...');
  
  const progressBar = document.getElementById('progressBar');
  const loaderText = document.getElementById('loaderText');
  
  // Initialize particles
  initParticles();
  
  // التأكد من ظهور أزرار التحكم فوراً
  setTimeout(() => {
    ensureControlHeaderVisible();
  }, 100);
  
  // Loading sequence with sound effects
  const loadingSteps = [
    { progress: 20, text: "� تحميل الأنظمة الكونية...", sound: 'cosmic-portal' },
    { progress: 40, text: "⚡ شحن محركات الذكاء الاصطناعي...", sound: 'ai-beep' },
    { progress: 60, text: "🏰 بناء المماليك السحرية...", sound: 'magic-sparkle' },
    { progress: 80, text: "👥 تحميل بيانات المحاربين...", sound: 'data-process' },
    { progress: 100, text: "🎉 مملكة التحديات جاهزة!", sound: 'kingdom-enter' }
  ];
  
  for (let step of loadingSteps) {
    await new Promise(resolve => setTimeout(resolve, 800));
    progressBar.style.width = step.progress + '%';
    loaderText.textContent = step.text;
    
    // Play loading sound
    if (step.sound) {
      playCosmicSound(step.sound, { volume: 0.4 });
    }
  }
  
  // Load student data with confirmation
  loaderText.textContent = "📚 تحميل بيانات الطلاب...";
  await loadStudentData();
  
  // Confirm data loaded
  const classCount = Object.keys(studentData).length;
  const totalStudents = Object.values(studentData).reduce((sum, students) => sum + students.length, 0);
  loaderText.textContent = `✅ تم تحميل ${classCount} صفوف مع ${totalStudents} طالب`;
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // Hide loader and show main app
  await new Promise(resolve => setTimeout(resolve, 1000));
  document.getElementById('cosmicLoader').style.opacity = '0';
  setTimeout(() => {
    document.getElementById('cosmicLoader').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    
    // التأكد من ظهور أزرار التحكم بعد تحميل التطبيق
    ensureControlHeaderVisible();
    
    // Additional visual confirmation
    setTimeout(() => {
      ensureControlHeaderVisible();
    }, 500);
    
    // Show class selection panel initially instead of welcome message
    loadClassSelection();
    
    // Debug info
    console.log('🎓 بيانات الطلاب المحملة:', studentData);
    console.log('📊 عدد الصفوف:', Object.keys(studentData).length);
    
    startSessionTimer();
    // showWelcomeMessage(); // Will be shown after student selection
  }, 1000);
}

// ===== وظائف أزرار التحكم العلوية =====

// تفعيل أزرار التحكم
function initializeControlButtons() {
  // زر الصفحة الرئيسية
  document.getElementById('homeBtn').addEventListener('click', function() {
    if (confirm('🏠 هل تريد العودة للصفحة الرئيسية؟\n\n⚠️ سيتم فقدان التقدم الحالي في اللعبة')) {
      playCosmicSound('ui-back');
      window.location.href = '../main.html';
    }
  });

  // زر التحكم في الصوت
  document.getElementById('soundToggleBtn').addEventListener('click', function() {
    gameState.soundEnabled = !gameState.soundEnabled;
    updateSoundButton();
    playCosmicSound('ui-click');
    showQuantumNotification(
      gameState.soundEnabled ? '🔊 تم تفعيل الصوت' : '🔇 تم كتم الصوت',
      '',
      'info'
    );
  });

  // زر دليل المعلم
  document.getElementById('teacherGuideBtn').addEventListener('click', function() {
    playCosmicSound('ui-click');
    showTeacherGuide();
  });

  // زر الإعدادات
  document.getElementById('settingsBtn').addEventListener('click', function() {
    playCosmicSound('ui-click');
    showSettingsModal();
  });

  // زر الإحصائيات
  document.getElementById('statsBtn').addEventListener('click', function() {
    playCosmicSound('ui-click');
    showStatsModal();
  });

  // زر ملء الشاشة
  document.getElementById('fullscreenBtn').addEventListener('click', function() {
    playCosmicSound('ui-click');
    toggleFullscreen();
  });
}

// تحديث زر الصوت
function updateSoundButton() {
  const soundBtn = document.getElementById('soundToggleBtn');
  const icon = soundBtn.querySelector('.btn-icon');
  icon.textContent = gameState.soundEnabled ? '🔊' : '🔇';
}

// إظهار نافذة الإعدادات
function showSettingsModal() {
  const modal = document.getElementById('settingsModal');
  modal.classList.add('active');
  
  // تحديث القيم الحالية
  updateSettingsDisplay();
  
  // تفعيل أول تبويب
  showSettingsTab('game-settings');
  
  // إعداد التبويبات
  setupSettingsTabs();
}

// إعداد التبويبات
function setupSettingsTabs() {
  const tabButtons = document.querySelectorAll('.settings-tab-btn');
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      showSettingsTab(tabId);
      
      // تحديث الأزرار النشطة
      tabButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
    });
  });
}

// إظهار تبويب معين
function showSettingsTab(tabId) {
  // إخفاء جميع التبويبات
  const allTabs = document.querySelectorAll('.settings-tab-content');
  allTabs.forEach(tab => tab.classList.remove('active'));
  
  // إظهار التبويب المحدد
  const targetTab = document.getElementById(tabId + '-content');
  if (targetTab) {
    targetTab.classList.add('active');
  }
}

// تحديث عرض الإعدادات
function updateSettingsDisplay() {
  // تحديث مستويات الصوت
  document.getElementById('masterVolumeSlider').value = (gameState.masterVolume || 0.5) * 100;
  document.getElementById('volumeDisplay').textContent = Math.round((gameState.masterVolume || 0.5) * 100) + '%';
  
  // تحديث الإعدادات الأخرى
  document.getElementById('particlesToggle').checked = gameState.particlesEnabled !== false;
  document.getElementById('animationsToggle').checked = gameState.animationsEnabled !== false;
  document.getElementById('notificationsToggle').checked = gameState.notificationsEnabled !== false;
  
  // تحديث معلومات الصف
  updateClassDataDisplay();
  
  // مراقبة تغيير مستوى الصوت
  setupVolumeSliders();
}

// إعداد أشرطة الصوت
function setupVolumeSliders() {
  const masterSlider = document.getElementById('masterVolumeSlider');
  const effectsSlider = document.getElementById('effectsVolumeSlider');
  const musicSlider = document.getElementById('musicVolumeSlider');
  
  masterSlider.addEventListener('input', function() {
    const volume = this.value / 100;
    gameState.masterVolume = volume;
    document.getElementById('volumeDisplay').textContent = this.value + '%';
    playCosmicSound('ui-click', { volume: volume });
  });
  
  effectsSlider.addEventListener('input', function() {
    const volume = this.value / 100;
    gameState.effectsVolume = volume;
    document.getElementById('effectsVolumeDisplay').textContent = this.value + '%';
    playCosmicSound('cosmic-click', { volume: volume });
  });
  
  musicSlider.addEventListener('input', function() {
    const volume = this.value / 100;
    gameState.musicVolume = volume;
    document.getElementById('musicVolumeDisplay').textContent = this.value + '%';
  });
}

// تحديث عرض بيانات الصفوف
function updateClassDataDisplay() {
  const classesCount = Object.keys(studentData).length;
  const totalStudents = Object.values(studentData).reduce((sum, students) => sum + students.length, 0);
  
  document.getElementById('classesCount').textContent = classesCount;
  document.getElementById('totalStudentsCount').textContent = totalStudents;
  document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('ar-SA');
  
  // تحديث الصف المختار
  const selectedClassSelect = document.getElementById('selectedClassDisplay');
  selectedClassSelect.innerHTML = '<option value="">-- لم يتم اختيار صف --</option>';
  Object.keys(studentData).forEach(className => {
    const option = document.createElement('option');
    option.value = className;
    option.textContent = className;
    if (gameState.selectedClass === className) {
      option.selected = true;
    }
    selectedClassSelect.appendChild(option);
  });
}

// اختبار جميع الأصوات
function testAllSounds() {
  const soundTests = [
    'cosmic-click', 'button-hover', 'achievement', 'magic-sparkle', 
    'epic-charge', 'victory-fanfare', 'ui-back'
  ];
  
  let index = 0;
  const interval = setInterval(() => {
    if (index < soundTests.length) {
      playCosmicSound(soundTests[index], { volume: 0.3 });
      showQuantumNotification(`🎵 اختبار الصوت: ${soundTests[index]}`, '', 'info');
      index++;
    } else {
      clearInterval(interval);
      showQuantumNotification('🎼 انتهى اختبار الأصوات!', '', 'success');
    }
  }, 1000);
}

// كتم جميع الأصوات
function muteAllSounds() {
  gameState.soundEnabled = false;
  gameState.masterVolume = 0;
  gameState.effectsVolume = 0;
  gameState.musicVolume = 0;
  
  document.getElementById('masterVolumeSlider').value = 0;
  document.getElementById('effectsVolumeSlider').value = 0;
  document.getElementById('musicVolumeSlider').value = 0;
  
  updateSoundButton();
  showQuantumNotification('🔇 تم كتم جميع الأصوات', '', 'info');
}

// حفظ جميع الإعدادات
function saveAllSettings() {
  const settings = {
    masterVolume: document.getElementById('masterVolumeSlider').value / 100,
    effectsVolume: document.getElementById('effectsVolumeSlider').value / 100,
    musicVolume: document.getElementById('musicVolumeSlider').value / 100,
    particlesEnabled: document.getElementById('particlesToggle').checked,
    animationsEnabled: document.getElementById('animationsToggle').checked,
    notificationsEnabled: document.getElementById('notificationsToggle').checked,
    fullscreenMode: document.getElementById('fullscreenModeToggle').checked,
    challengeDuration: document.getElementById('challengeDurationSelect').value,
    difficulty: document.getElementById('difficultySelect').value,
    scoringSystem: document.getElementById('scoringSystemSelect').value,
    colorTheme: document.getElementById('colorThemeSelect').value,
    autoSelectStudents: document.getElementById('autoSelectAllStudents').checked,
    randomizeOrder: document.getElementById('randomizeStudentOrder').checked,
    quickStart: document.getElementById('enableQuickStart').checked,
    rememberSelection: document.getElementById('rememberLastSelection').checked,
    timestamp: new Date().toISOString()
  };
  
  // تطبيق الإعدادات على الحالة العامة
  Object.assign(gameState, settings);
  
  // حفظ في التخزين المحلي
  localStorage.setItem('kingdomSettingsAdvanced', JSON.stringify(settings));
  
  playCosmicSound('achievement');
  showQuantumNotification('💾 تم حفظ جميع الإعدادات بنجاح!', 'الإعدادات نشطة الآن', 'success');
  closeSettingsModal();
}

// إعادة تعيين جميع الإعدادات
function resetAllSettings() {
  if (confirm('🔄 هل تريد إعادة تعيين جميع الإعدادات للقيم الافتراضية؟\n\nسيتم فقدان جميع الإعدادات المخصصة.')) {
    // القيم الافتراضية
    const defaultSettings = {
      masterVolume: 0.5,
      effectsVolume: 0.7,
      musicVolume: 0.3,
      particlesEnabled: true,
      animationsEnabled: true,
      notificationsEnabled: true,
      fullscreenMode: false,
      challengeDuration: 60,
      difficulty: 'medium',
      scoringSystem: 'standard',
      colorTheme: 'cosmic',
      autoSelectStudents: false,
      randomizeOrder: false,
      quickStart: false,
      rememberSelection: true
    };
    
    Object.assign(gameState, defaultSettings);
    localStorage.removeItem('kingdomSettingsAdvanced');
    
    updateSettingsDisplay();
    playCosmicSound('ui-reset');
    showQuantumNotification('🔄 تم إعادة تعيين جميع الإعدادات', 'القيم الافتراضية نشطة الآن', 'info');
  }
}

// تصدير الإعدادات
function exportSettings() {
  const settings = JSON.parse(localStorage.getItem('kingdomSettingsAdvanced') || '{}');
  const exportData = {
    appName: 'مملكة التحديات الذكية',
    version: '2.0',
    settings: settings,
    exportDate: new Date().toISOString(),
    exportedBy: 'نظام الإعدادات المتقدم'
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = `kingdom-settings-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  playCosmicSound('achievement');
  showQuantumNotification('📤 تم تصدير الإعدادات بنجاح', '', 'success');
}

// تصدير بيانات الصفوف
function exportClassData() {
  const exportData = {
    appName: 'مملكة التحديات الذكية',
    dataType: 'بيانات الصفوف والطلاب',
    classes: studentData,
    statistics: {
      totalClasses: Object.keys(studentData).length,
      totalStudents: Object.values(studentData).reduce((sum, students) => sum + students.length, 0)
    },
    exportDate: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = `kingdom-class-data-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  playCosmicSound('achievement');
  showQuantumNotification('📥 تم تصدير بيانات الصفوف بنجاح', '', 'success');
}

// إغلاق نافذة الإعدادات
function closeSettingsModal() {
  const modal = document.getElementById('settingsModal');
  modal.classList.remove('active');
  playCosmicSound('ui-back');
}

// حفظ الإعدادات (للتوافق مع النظام القديم)
function saveSettings() {
  saveAllSettings();
}

// إعادة تعيين الإعدادات (للتوافق مع النظام القديم)
function resetSettings() {
  resetAllSettings();
}

// إظهار نافذة الإحصائيات
function showStatsModal() {
  const modal = document.getElementById('statsModal');
  const content = document.getElementById('statsContent');
  
  content.innerHTML = `
    <div style="display: grid; gap: 1.5rem;">
      <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 15px;">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">🎮 إحصائيات اللعب</h3>
        <div>عدد الألعاب: ${gameState.totalGames || 0}</div>
        <div>النقاط المكتسبة: ${gameState.totalPoints || 0}</div>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 15px;">
        <h3 style="color: #00ffff; margin-bottom: 1rem;">👥 إحصائيات الطلاب</h3>
        <div>عدد الطلاب المشاركين: ${gameState.selectedStudents?.length || 0}</div>
        <div>الصف المختار: ${gameState.selectedClass || 'غير محدد'}</div>
      </div>
    </div>
  `;
  
  modal.classList.add('active');
}

// إغلاق نافذة الإحصائيات
function closeStatsModal() {
  const modal = document.getElementById('statsModal');
  modal.classList.remove('active');
  playCosmicSound('ui-back');
}

// وضع ملء الشاشة
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().then(() => {
      showQuantumNotification('⛶ وضع ملء الشاشة مفعل', '', 'info');
    });
  } else {
    document.exitFullscreen().then(() => {
      showQuantumNotification('⛶ تم إلغاء ملء الشاشة', '', 'info');
    });
  }
}

// العودة للوحة الرئيسية
function backToMainDashboard() {
  // إخفاء لوحة الاختيار
  document.getElementById('selectionPanel').style.display = 'none';
  
  // إظهار المحتوى الرئيسي
  document.getElementById('kingdomContent').style.display = 'block';
  
  // تشغيل صوت العودة
  playCosmicSound('ui-back');
  
  // إظهار رسالة ترحيب
  showWelcomeMessage();
  
  showQuantumNotification(
    '🏰 مرحباً بك في مملكة التحديات',
    'اختر التحدي المناسب لبدء الرحلة',
    'info'
  );
}

// تحميل الإعدادات المحفوظة
function loadSavedSettings() {
  // تحميل الإعدادات المتقدمة الجديدة
  const advancedSettings = localStorage.getItem('kingdomSettingsAdvanced');
  if (advancedSettings) {
    const settings = JSON.parse(advancedSettings);
    Object.assign(gameState, settings);
    console.log('✅ تم تحميل الإعدادات المتقدمة');
    return;
  }
  
  // تحميل الإعدادات القديمة للتوافق
  const oldSettings = localStorage.getItem('kingdomSettings');
  if (oldSettings) {
    const settings = JSON.parse(oldSettings);
    gameState.masterVolume = settings.masterVolume || 0.5;
    gameState.particlesEnabled = settings.particlesEnabled !== false;
    gameState.animationsEnabled = settings.animationsEnabled !== false;
    gameState.soundEnabled = settings.soundEnabled !== false;
    console.log('✅ تم تحميل الإعدادات القديمة وترقيتها');
  } else {
    // الإعدادات الافتراضية
    gameState.masterVolume = 0.5;
    gameState.effectsVolume = 0.7;
    gameState.musicVolume = 0.3;
    gameState.particlesEnabled = true;
    gameState.animationsEnabled = true;
    gameState.notificationsEnabled = true;
    console.log('📋 تم تطبيق الإعدادات الافتراضية');
  }
}

// ===== FINAL INITIALIZATION =====
console.log('🏆 مملكة التحديات الذكية - تحميل مكتمل!');
console.log('🎵 نظام الصوت المتقدم مع 61 تأثير صوتي جاهز!');
console.log('⚡ جميع المماليك والتحديات جاهزة للعمل!');

// Initialize the enhanced audio system
initAudioSystem();

// تفعيل أزرار التحكم العلوية
initializeControlButtons();

// تحميل الإعدادات المحفوظة
loadSavedSettings();

// تحديث زر الصوت
updateSoundButton();
</script>
</body>
</html>
