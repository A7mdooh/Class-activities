<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ مملكة البرق | تحدي الطلاب المتنافسين</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --lightning-primary: #FFD700;
            --lightning-secondary: #FF6B35;
            --lightning-dark: #1a1a2e;
            --lightning-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --lightning-glow: 0 0 30px rgba(255, 215, 0, 0.3);
            --student-card-bg: rgba(255, 255, 255, 0.1);
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--lightning-bg);
            min-height: 100vh;
            color: white;
            direction: rtl;
        }

        .kingdom-header {
            text-align: center;
            padding: 2rem;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        .kingdom-title {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .kingdom-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 1rem 2rem;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 900;
            color: var(--lightning-primary);
        }

        .game-arena {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            backdrop-filter: blur(15px);
        }

        .question-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .question-text {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .timer-display {
            font-size: 2rem;
            color: var(--lightning-primary);
            margin: 1rem 0;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .control-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn {
            background: linear-gradient(45deg, #00f260, #0575e6);
            color: white;
        }

        .pause-btn {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .answer-btn {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .back-btn {
            background: linear-gradient(45deg, #fa709a, #fee140);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .score-display {
            text-align: center;
            margin: 1rem 0;
            font-size: 1.2rem;
        }

        .leaderboard {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 15px;
            margin-top: 2rem;
        }

        .leaderboard h3 {
            text-align: center;
            margin-bottom: 1rem;
            color: var(--lightning-primary);
        }

        .player-score {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .progress-indicator {
            text-align: center;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--lightning-primary), var(--lightning-secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ===== STUDENT COMPETITION STYLES ===== */
        .competition-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .timer-section {
            text-align: center;
            margin-bottom: 2rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 2rem;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid var(--lightning-primary);
            box-shadow: var(--lightning-glow);
        }

        .main-timer {
            font-size: 4rem;
            font-weight: 900;
            color: var(--lightning-primary);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin: 1rem 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .current-student-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 107, 53, 0.2));
            border: 3px solid var(--lightning-primary);
            border-radius: 25px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
            box-shadow: var(--lightning-glow);
            backdrop-filter: blur(20px);
        }

        .student-spotlight {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            margin-bottom: 1rem;
            animation: glow 3s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7), 0 0 10px var(--lightning-primary); }
            to { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7), 0 0 30px var(--lightning-primary); }
        }

        .teacher-instructions {
            font-size: 1.3rem;
            color: #fff;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border-left: 5px solid var(--lightning-primary);
        }

        .evaluation-buttons {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .eval-btn {
            padding: 1.5rem 3rem;
            border: none;
            border-radius: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 180px;
        }

        .eval-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .eval-btn.excellent {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
        }

        .eval-btn.good {
            background: linear-gradient(45deg, #2196f3, #03dac6);
            color: white;
        }

        .eval-btn.weak {
            background: linear-gradient(45deg, #ff9800, #ffc107);
            color: white;
        }

        .eval-btn.fail {
            background: linear-gradient(45deg, #f44336, #e91e63);
            color: white;
        }

        .competition-controls {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .start-competition {
            background: linear-gradient(45deg, #00f260, #0575e6);
            color: white;
        }

        .pause-competition {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .end-competition {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .back-to-kingdoms {
            background: linear-gradient(45deg, #fa709a, #fee140);
            color: white;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid var(--lightning-primary);
            border-radius: 25px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            animation: modalSlideIn 0.5s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-title {
            font-size: 2rem;
            color: var(--lightning-primary);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .modal-message {
            font-size: 1.2rem;
            color: white;
            margin: 1.5rem 0;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: var(--lightning-primary);
            color: #000;
        }

        .modal-btn.secondary {
            background: transparent;
            color: var(--lightning-primary);
            border: 2px solid var(--lightning-primary);
        }

        .students-queue {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .queue-title {
            text-align: center;
            font-size: 1.3rem;
            color: var(--lightning-primary);
            margin-bottom: 1rem;
        }

        .students-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .student-card {
            background: var(--student-card-bg);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 1rem;
            min-width: 120px;
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .student-card.current {
            border-color: var(--lightning-primary);
            background: rgba(255, 215, 0, 0.2);
            box-shadow: var(--lightning-glow);
            transform: scale(1.05);
        }

        .student-card.completed {
            border-color: var(--success-color);
            background: rgba(76, 175, 80, 0.2);
            opacity: 0.7;
        }

        .student-card.eliminated {
            border-color: var(--danger-color);
            background: rgba(244, 67, 54, 0.2);
            opacity: 0.5;
        }

        .student-name {
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .student-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .status-waiting {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
        }

        .status-current {
            background: rgba(255, 215, 0, 0.3);
            color: var(--lightning-primary);
        }

        .status-completed {
            background: rgba(76, 175, 80, 0.3);
            color: var(--success-color);
        }

        .status-eliminated {
            background: rgba(244, 67, 54, 0.3);
            color: var(--danger-color);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .main-timer {
                font-size: 3rem;
            }
            
            .student-spotlight {
                font-size: 2rem;
            }
            
            .evaluation-buttons {
                gap: 1rem;
            }
            
            .eval-btn {
                padding: 1rem 2rem;
                font-size: 1.1rem;
                min-width: 140px;
            }
            
            .competition-controls {
                gap: 1rem;
            }
            
            .modal-content {
                padding: 2rem;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="kingdom-header">
        <div class="kingdom-title">⚡ مملكة البرق</div>
        <p>تحدي الطلاب المتنافسين - 5 دقائق من الإثارة والتنافس</p>
        
        <div class="kingdom-stats">
            <div class="stat-card">
                <div class="stat-number" id="activeStudents">0</div>
                <div>الطلاب النشطون</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedStudents">0</div>
                <div>تم تقييمهم</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="timeRemaining">5:00</div>
                <div>الوقت المتبقي</div>
            </div>
        </div>
    </div>

    <div class="competition-container">
        <!-- Timer Section -->
        <div class="timer-section">
            <div class="main-timer" id="mainTimer">5:00</div>
            <div class="timer-label">⏰ وقت التحدي</div>
        </div>

        <!-- Current Student Section -->
        <div class="current-student-section" id="studentSection" style="display: none;">
            <div class="student-spotlight" id="currentStudentName">اسم الطالب</div>
            <div class="teacher-instructions">
                <i class="fas fa-microphone"></i> 
                وجه سؤالاً شفوياً للطالب واستمع للإجابة
            </div>
            
            <div class="evaluation-buttons">
                <button class="eval-btn excellent" onclick="evaluateStudent('excellent')">
                    <i class="fas fa-star"></i>
                    ممتاز (100 نقطة)
                </button>
                <button class="eval-btn good" onclick="evaluateStudent('good')">
                    <i class="fas fa-thumbs-up"></i>
                    جيد (75 نقطة)
                </button>
                <button class="eval-btn weak" onclick="evaluateStudent('weak')">
                    <i class="fas fa-hand-paper"></i>
                    ضعيف (50 نقطة)
                </button>
                <button class="eval-btn fail" onclick="evaluateStudent('fail')">
                    <i class="fas fa-times"></i>
                    راسب (0 نقطة)
                </button>
            </div>
        </div>

        <!-- Students Queue -->
        <div class="students-queue">
            <div class="queue-title">📋 قائمة الطلاب المتنافسين</div>
            <div class="students-list" id="studentsList">
                <!-- سيتم ملؤها بـ JavaScript -->
            </div>
        </div>

        <!-- Competition Controls -->
        <div class="competition-controls">
            <button class="control-btn start-competition" onclick="startCompetition()">
                <i class="fas fa-play"></i>
                بدء المنافسة
            </button>
            <button class="control-btn pause-competition" onclick="pauseCompetition()">
                <i class="fas fa-pause"></i>
                إيقاف مؤقت
            </button>
            <button class="control-btn end-competition" onclick="endCompetition()">
                <i class="fas fa-stop"></i>
                إنهاء المنافسة
            </button>
            <button class="control-btn back-to-kingdoms" onclick="goBackToKingdoms()">
                <i class="fas fa-home"></i>
                العودة للممالك
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">تقييم الطالب</div>
            <div class="modal-message" id="modalMessage">تم تقييم الطالب بنجاح!</div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeModal()">متابعة</button>
            </div>
        </div>
    </div>

    <div class="modal" id="competitionEndModal">
        <div class="modal-content">
            <div class="modal-title">🏆 انتهت المنافسة!</div>
            <div class="modal-message" id="finalResults">نتائج المنافسة</div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="returnToKingdomsCenter()">العودة لمركز الممالك</button>
                <button class="modal-btn secondary" onclick="startNewCompetition()">منافسة جديدة</button>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let competitionData = {
            students: [],
            currentStudentIndex: 0,
            totalTime: 5 * 60, // 5 minutes in seconds
            remainingTime: 5 * 60,
            isRunning: false,
            isPaused: false,
            results: [],
            completedStudents: 0
        };

        let competitionTimer;
        let audioEnabled = true;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentsData();
            updateDisplay();
            setupSoundSystem();
        });

        // ===== LOAD STUDENTS DATA =====
        function loadStudentsData() {
            // Load from kingdoms center data
            const transferData = localStorage.getItem('kingdomTransferData');
            const kingdomData = localStorage.getItem('kingdomGameState');
            const playersData = localStorage.getItem('squidGamePlayers');

            let studentsFound = false;

            // Try different data sources
            if (transferData) {
                try {
                    const data = JSON.parse(transferData);
                    if (data.selectedStudents && data.selectedStudents.length > 0) {
                        competitionData.students = data.selectedStudents.map((name, index) => ({
                            id: index + 1,
                            name: name,
                            status: 'waiting', // waiting, current, completed, eliminated
                            score: 0,
                            evaluation: null,
                            timestamp: null
                        }));
                        studentsFound = true;
                    }
                } catch (e) {
                    console.log('Error loading transfer data:', e);
                }
            }

            // Fallback to kingdom game state
            if (!studentsFound && kingdomData) {
                try {
                    const data = JSON.parse(kingdomData);
                    if (data.selectedStudents && data.selectedStudents.length > 0) {
                        const students = Array.isArray(data.selectedStudents) ? 
                                       data.selectedStudents : Object.values(data.selectedStudents);
                        competitionData.students = students.map((name, index) => ({
                            id: index + 1,
                            name: name,
                            status: 'waiting',
                            score: 0,
                            evaluation: null,
                            timestamp: null
                        }));
                        studentsFound = true;
                    }
                } catch (e) {
                    console.log('Error loading kingdom data:', e);
                }
            }

            // Filter out eliminated students from previous games
            if (studentsFound && playersData) {
                try {
                    const players = JSON.parse(playersData);
                    competitionData.students = competitionData.students.filter(student => {
                        const player = players.find(p => p.name === student.name);
                        return !player || player.status === 'alive';
                    });
                } catch (e) {
                    console.log('Error filtering eliminated students:', e);
                }
            }

            // Default students if none found
            if (!studentsFound || competitionData.students.length === 0) {
                competitionData.students = [
                    { id: 1, name: 'طالب تجريبي 1', status: 'waiting', score: 0, evaluation: null, timestamp: null },
                    { id: 2, name: 'طالب تجريبي 2', status: 'waiting', score: 0, evaluation: null, timestamp: null },
                    { id: 3, name: 'طالب تجريبي 3', status: 'waiting', score: 0, evaluation: null, timestamp: null }
                ];
            }

            // Shuffle students for random order
            competitionData.students = shuffleArray(competitionData.students);
            
            console.log('✅ تم تحميل بيانات الطلاب:', competitionData.students);
            displayStudentsList();
        }

        // ===== UTILITY FUNCTIONS =====
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function playSound(soundType) {
            if (!audioEnabled) return;
            
            try {
                const audio = new Audio();
                const soundMap = {
                    'start': '../assets/media/sounds/kingdom-sounds/battle-horn.mp3',
                    'success': '../assets/media/sounds/kingdom-sounds/achievement-unlock.mp3',
                    'excellent': '../assets/media/sounds/kingdom-sounds/epic-victory.mp3',
                    'good': '../assets/media/sounds/kingdom-sounds/level-up.mp3',
                    'weak': '../assets/media/sounds/kingdom-sounds/notification-pop.mp3',
                    'fail': '../assets/media/sounds/kingdom-sounds/wrong_answer.mp3',
                    'next': '../assets/media/sounds/kingdom-sounds/cosmic-click.mp3',
                    'end': '../assets/media/sounds/kingdom-sounds/crown-ceremony.mp3',
                    'pause': '../assets/media/sounds/kingdom-sounds/button-hover.mp3',
                    'warning': '../assets/media/sounds/kingdom-sounds/countdown-tick.mp3'
                };
                
                audio.src = soundMap[soundType] || soundMap['success'];
                audio.volume = 0.6;
                audio.play().catch(e => console.log('تعذر تشغيل الصوت:', e));
            } catch (e) {
                console.log('خطأ في تشغيل الصوت:', e);
            }
        }

        function setupSoundSystem() {
            // Test audio support
            try {
                const testAudio = new Audio();
                testAudio.src = '../assets/media/sounds/kingdom-sounds/cosmic-click.mp3';
                testAudio.volume = 0.1;
                testAudio.play().then(() => {
                    testAudio.pause();
                    console.log('✅ نظام الصوت جاهز');
                }).catch(() => {
                    console.log('⚠️ تعذر تشغيل الأصوات');
                    audioEnabled = false;
                });
            } catch (e) {
                audioEnabled = false;
            }
        }

        // ===== DISPLAY FUNCTIONS =====
        function updateDisplay() {
            document.getElementById('activeStudents').textContent = competitionData.students.filter(s => s.status === 'waiting').length;
            document.getElementById('completedStudents').textContent = competitionData.completedStudents;
            document.getElementById('timeRemaining').textContent = formatTime(competitionData.remainingTime);
            document.getElementById('mainTimer').textContent = formatTime(competitionData.remainingTime);
            
            // Update timer color based on remaining time
            const timerElement = document.getElementById('mainTimer');
            if (competitionData.remainingTime <= 60) {
                timerElement.style.color = '#f44336';
                if (competitionData.remainingTime <= 30) {
                    timerElement.style.animation = 'pulse 1s infinite';
                }
            } else if (competitionData.remainingTime <= 120) {
                timerElement.style.color = '#ff9800';
            } else {
                timerElement.style.color = 'var(--lightning-primary)';
            }
        }

        function displayStudentsList() {
            const container = document.getElementById('studentsList');
            container.innerHTML = '';
            
            competitionData.students.forEach((student, index) => {
                const studentCard = document.createElement('div');
                studentCard.className = `student-card ${student.status}`;
                studentCard.innerHTML = `
                    <div class="student-name">${student.name}</div>
                    <div class="student-status status-${student.status}">
                        ${getStatusText(student.status)}
                    </div>
                    ${student.score > 0 ? `<div style="color: var(--lightning-primary); font-weight: 700; margin-top: 0.5rem;">${student.score} نقطة</div>` : ''}
                `;
                container.appendChild(studentCard);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'waiting': 'في الانتظار',
                'current': 'الدور الحالي',
                'completed': 'تم تقييمه',
                'eliminated': 'مُستبعد'
            };
            return statusMap[status] || status;
        }

        function showCurrentStudent() {
            if (competitionData.currentStudentIndex >= competitionData.students.length) {
                endCompetition();
                return;
            }

            const currentStudent = competitionData.students[competitionData.currentStudentIndex];
            
            // Skip eliminated students
            if (currentStudent.status === 'eliminated') {
                competitionData.currentStudentIndex++;
                showCurrentStudent();
                return;
            }

            // Update student status
            competitionData.students.forEach(s => {
                if (s.status === 'current') s.status = 'waiting';
            });
            currentStudent.status = 'current';

            // Display current student
            document.getElementById('currentStudentName').textContent = currentStudent.name;
            document.getElementById('studentSection').style.display = 'block';
            
            displayStudentsList();
            playSound('next');

            // Show modal for new student
            showStudentModal(currentStudent);
        }

        function showStudentModal(student) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            title.innerHTML = '🎯 الطالب الحالي';
            message.innerHTML = `
                <div style="font-size: 1.5rem; color: var(--lightning-primary); margin-bottom: 1rem;">
                    <i class="fas fa-user"></i> ${student.name}
                </div>
                <div style="color: #fff;">
                    <i class="fas fa-microphone"></i> وجه سؤالاً شفوياً للطالب<br>
                    <i class="fas fa-clock"></i> استمع للإجابة وقم بالتقييم
                </div>
            `;
            
            modal.style.display = 'flex';
            playSound('start');
            
            setTimeout(() => {
                closeModal();
            }, 3000);
        }

        // ===== COMPETITION CONTROL FUNCTIONS =====
        function startCompetition() {
            if (competitionData.students.length === 0) {
                alert('لا توجد بيانات طلاب! يرجى العودة لمركز الممالك وتحديد الطلاب.');
                return;
            }

            competitionData.isRunning = true;
            competitionData.isPaused = false;
            competitionData.currentStudentIndex = 0;
            competitionData.remainingTime = competitionData.totalTime;
            
            // Reset all students to waiting
            competitionData.students.forEach(student => {
                if (student.status !== 'eliminated') {
                    student.status = 'waiting';
                }
            });

            startTimer();
            showCurrentStudent();
            playSound('start');

            // Update button
            const startBtn = document.querySelector('.start-competition');
            startBtn.innerHTML = '<i class="fas fa-refresh"></i> إعادة البدء';
        }

        function pauseCompetition() {
            if (!competitionData.isRunning) return;
            
            competitionData.isPaused = !competitionData.isPaused;
            const pauseBtn = document.querySelector('.pause-competition');
            
            if (competitionData.isPaused) {
                clearInterval(competitionTimer);
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> متابعة';
                playSound('pause');
            } else {
                startTimer();
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> إيقاف مؤقت';
            }
        }

        function endCompetition() {
            competitionData.isRunning = false;
            clearInterval(competitionTimer);
            
            // Hide current student section
            document.getElementById('studentSection').style.display = 'none';
            
            // Calculate final results
            const results = competitionData.students
                .filter(s => s.status === 'completed')
                .sort((a, b) => b.score - a.score);
            
            // Show final results modal
            showFinalResults(results);
            
            // Save results to kingdoms center
            saveResultsToKingdomsCenter(results);
            
            playSound('end');
        }

        function startTimer() {
            competitionTimer = setInterval(() => {
                if (!competitionData.isPaused) {
                    competitionData.remainingTime--;
                    updateDisplay();
                    
                    // Warning sounds
                    if (competitionData.remainingTime === 60 || competitionData.remainingTime === 30) {
                        playSound('warning');
                    }
                    
                    if (competitionData.remainingTime <= 0) {
                        endCompetition();
                    }
                }
            }, 1000);
        }

        // ===== EVALUATION FUNCTIONS =====
        function evaluateStudent(evaluation) {
            if (!competitionData.isRunning || competitionData.isPaused) return;
            
            const currentStudent = competitionData.students[competitionData.currentStudentIndex];
            if (!currentStudent) return;

            // Set evaluation and score
            currentStudent.evaluation = evaluation;
            currentStudent.status = 'completed';
            currentStudent.timestamp = new Date().toISOString();
            
            const scoreMap = {
                'excellent': 100,
                'good': 75,
                'weak': 50,
                'fail': 0
            };
            
            currentStudent.score = scoreMap[evaluation];
            competitionData.completedStudents++;

            // Show evaluation result
            showEvaluationResult(currentStudent, evaluation);
            
            // Play appropriate sound
            playSound(evaluation);
            
            // Move to next student
            competitionData.currentStudentIndex++;
            
            setTimeout(() => {
                if (competitionData.currentStudentIndex < competitionData.students.length && competitionData.remainingTime > 0) {
                    showCurrentStudent();
                } else {
                    endCompetition();
                }
            }, 2000);
            
            displayStudentsList();
            updateDisplay();
        }

        function showEvaluationResult(student, evaluation) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            const evaluationMap = {
                'excellent': { text: 'ممتاز!', icon: '🌟', color: '#4caf50' },
                'good': { text: 'جيد!', icon: '👍', color: '#2196f3' },
                'weak': { text: 'ضعيف', icon: '👋', color: '#ff9800' },
                'fail': { text: 'راسب', icon: '❌', color: '#f44336' }
            };
            
            const evalData = evaluationMap[evaluation];
            
            title.innerHTML = `${evalData.icon} ${evalData.text}`;
            title.style.color = evalData.color;
            
            message.innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem;">
                    الطالب: <strong>${student.name}</strong>
                </div>
                <div style="font-size: 1.5rem; color: ${evalData.color}; font-weight: 700;">
                    النقاط: ${student.score}
                </div>
            `;
            
            modal.style.display = 'flex';
            
            setTimeout(() => {
                closeModal();
            }, 2000);
        }

        // ===== MODAL FUNCTIONS =====
        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
            document.getElementById('competitionEndModal').style.display = 'none';
        }

        function showFinalResults(results) {
            const modal = document.getElementById('competitionEndModal');
            const message = document.getElementById('finalResults');
            
            let resultsHTML = `
                <div style="margin-bottom: 2rem;">
                    <div style="font-size: 1.2rem; margin-bottom: 1rem;">
                        🏁 انتهت المنافسة! 
                    </div>
                    <div style="color: var(--lightning-primary);">
                        تم تقييم ${competitionData.completedStudents} طالب
                    </div>
                </div>
            `;
            
            if (results.length > 0) {
                resultsHTML += '<div style="text-align: right; margin: 1rem 0;"><strong>🏆 أفضل النتائج:</strong></div>';
                
                results.slice(0, 3).forEach((student, index) => {
                    const medals = ['🥇', '🥈', '🥉'];
                    const medal = medals[index] || '🏅';
                    
                    resultsHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin: 0.5rem 0; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <span>${medal} ${student.name}</span>
                            <span style="color: var(--lightning-primary); font-weight: 700;">${student.score} نقطة</span>
                        </div>
                    `;
                });
            }
            
            message.innerHTML = resultsHTML;
            modal.style.display = 'flex';
        }

        // ===== NAVIGATION FUNCTIONS =====
        function returnToKingdomsCenter() {
            // Update kingdoms center with results
            saveResultsToKingdomsCenter();
            window.location.href = 'kingdoms-center.html';
        }

        function startNewCompetition() {
            // Reset competition data
            competitionData.currentStudentIndex = 0;
            competitionData.remainingTime = competitionData.totalTime;
            competitionData.completedStudents = 0;
            competitionData.isRunning = false;
            competitionData.isPaused = false;
            
            // Reset students
            competitionData.students.forEach(student => {
                if (student.status !== 'eliminated') {
                    student.status = 'waiting';
                    student.score = 0;
                    student.evaluation = null;
                    student.timestamp = null;
                }
            });
            
            // Shuffle again
            competitionData.students = shuffleArray(competitionData.students);
            
            closeModal();
            displayStudentsList();
            updateDisplay();
            
            document.getElementById('studentSection').style.display = 'none';
            document.querySelector('.start-competition').innerHTML = '<i class="fas fa-play"></i> بدء المنافسة';
        }

        function goBackToKingdoms() {
            if (competitionData.isRunning) {
                if (confirm('المنافسة جارية! هل تريد العودة وحفظ النتائج؟')) {
                    saveResultsToKingdomsCenter();
                    window.location.href = 'kingdoms-center.html';
                }
            } else {
                window.location.href = 'kingdoms-center.html';
            }
        }

        // ===== SAVE RESULTS =====
        function saveResultsToKingdomsCenter() {
            try {
                // Save competition results
                const competitionResults = {
                    kingdom: 'lightning',
                    timestamp: new Date().toISOString(),
                    totalStudents: competitionData.students.length,
                    completedStudents: competitionData.completedStudents,
                    duration: competitionData.totalTime - competitionData.remainingTime,
                    results: competitionData.students.filter(s => s.status === 'completed')
                };
                
                localStorage.setItem('lightning-kingdom-results', JSON.stringify(competitionResults));
                
                // Update individual student records for kingdoms center
                const playersData = localStorage.getItem('squidGamePlayers');
                if (playersData) {
                    const players = JSON.parse(playersData);
                    
                    competitionData.students.forEach(student => {
                        const player = players.find(p => p.name === student.name);
                        if (player && student.status === 'completed') {
                            // Update player stats based on performance
                            if (student.evaluation === 'excellent') {
                                // Record victory and correct answer for excellent performance
                                player.gamesWon = (player.gamesWon || 0) + 1;
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                player.correctAnswers = (player.correctAnswers || 0) + 1;
                                player.currentStreak = (player.currentStreak || 0) + 1;
                                if (player.currentStreak > (player.bestStreak || 0)) {
                                    player.bestStreak = player.currentStreak;
                                }
                            } else if (student.evaluation === 'good') {
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                player.correctAnswers = (player.correctAnswers || 0) + 1;
                            } else if (student.evaluation === 'weak') {
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                // No correct answer added for weak performance
                            } else if (student.evaluation === 'fail') {
                                player.gamesLost = (player.gamesLost || 0) + 1;
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                player.currentStreak = 0; // Reset streak
                            }
                            
                            // Add score and experience
                            player.score = (player.score || 0) + student.score;
                            player.experiencePoints = (player.experiencePoints || 0) + student.score;
                            
                            // Update level based on experience
                            const newLevel = Math.floor(player.experiencePoints / 100) + 1;
                            if (newLevel > (player.level || 1)) {
                                player.level = newLevel;
                                player.score += newLevel * 50; // Level up bonus
                            }
                            
                            // Update activity
                            player.lastActivity = new Date().toISOString();
                        }
                    });
                    
                    localStorage.setItem('squidGamePlayers', JSON.stringify(players));
                }
                
                console.log('✅ تم حفظ نتائج المنافسة');
            } catch (e) {
                console.error('خطأ في حفظ النتائج:', e);
            }
        }
    </script>
</body>
</html>
