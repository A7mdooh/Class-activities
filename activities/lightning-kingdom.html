<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¨Ø±Ù‚ | ØªØ­Ø¯ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --lightning-primary: #FFD700;
            --lightning-secondary: #FF6B35;
            --lightning-dark: #1a1a2e;
            --lightning-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --lightning-glow: 0 0 30px rgba(255, 215, 0, 0.3);
            --student-card-bg: rgba(255, 255, 255, 0.1);
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--lightning-bg);
            min-height: 100vh;
            color: white;
            direction: rtl;
        }

        .kingdom-header {
            text-align: center;
            padding: 2rem;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        .kingdom-title {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .kingdom-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 1rem 2rem;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 900;
            color: var(--lightning-primary);
        }

        .game-arena {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            backdrop-filter: blur(15px);
        }

        .question-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .question-text {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .timer-display {
            font-size: 2rem;
            color: var(--lightning-primary);
            margin: 1rem 0;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .control-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn {
            background: linear-gradient(45deg, #00f260, #0575e6);
            color: white;
        }

        .pause-btn {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .answer-btn {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .back-btn {
            background: linear-gradient(45deg, #fa709a, #fee140);
            color: white;
        }

        .settings-btn {
            background: linear-gradient(45deg, #9c27b0, #673ab7);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .settings-btn:hover {
            background: linear-gradient(45deg, #673ab7, #9c27b0);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(156, 39, 176, 0.4);
        }

        .settings-btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .settings-btn:hover:before {
            width: 100%;
            height: 100%;
        }

        /* ===== SETTINGS MODAL STYLES ===== */
        .settings-section {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border-left: 4px solid var(--lightning-primary);
            backdrop-filter: blur(10px);
        }

        .settings-section h4 {
            color: var(--lightning-primary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .setting-group {
            margin: 1.5rem 0;
        }

        .setting-group label {
            display: block;
            color: #fff;
            margin-bottom: 0.8rem;
            font-weight: 600;
            font-size: 1rem;
        }

        .setting-group input[type="range"] {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .setting-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--lightning-primary);
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            border: 3px solid #fff;
        }

        .setting-group input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--lightning-primary);
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            border: 3px solid #fff;
        }

        .slider-value {
            text-align: center;
            margin-top: 1rem;
            font-size: 1.5rem;
            color: var(--lightning-primary);
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .setting-group select {
            width: 100%;
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid var(--lightning-primary);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .setting-group select:focus {
            outline: none;
            border-color: var(--lightning-secondary);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .setting-group input[type="number"] {
            width: 120px;
            padding: 0.8rem;
            border-radius: 8px;
            border: 2px solid var(--lightning-primary);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .setting-group input[type="checkbox"] {
            margin-left: 1rem;
            transform: scale(1.5);
            accent-color: var(--lightning-primary);
        }

        .competition-preview {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 2px solid var(--lightning-primary);
            backdrop-filter: blur(10px);
        }

        .preview-title {
            color: var(--lightning-primary);
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .phase-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--lightning-secondary);
        }

        .phase-info:last-child {
            border-left-color: #4caf50;
            background: rgba(76, 175, 80, 0.2);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .score-display {
            text-align: center;
            margin: 1rem 0;
            font-size: 1.2rem;
        }

        .leaderboard {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 15px;
            margin-top: 2rem;
        }

        .leaderboard h3 {
            text-align: center;
            margin-bottom: 1rem;
            color: var(--lightning-primary);
        }

        .player-score {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .progress-indicator {
            text-align: center;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--lightning-primary), var(--lightning-secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ===== STUDENT COMPETITION STYLES ===== */
        .competition-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .timer-section {
            text-align: center;
            margin-bottom: 2rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 2rem;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid var(--lightning-primary);
            box-shadow: var(--lightning-glow);
        }

        .main-timer {
            font-size: 4rem;
            font-weight: 900;
            color: var(--lightning-primary);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin: 1rem 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .current-student-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 107, 53, 0.2));
            border: 3px solid var(--lightning-primary);
            border-radius: 25px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
            box-shadow: var(--lightning-glow);
            backdrop-filter: blur(20px);
        }

        .student-spotlight {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            margin-bottom: 1rem;
            animation: glow 3s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7), 0 0 10px var(--lightning-primary); }
            to { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7), 0 0 30px var(--lightning-primary); }
        }

        .teacher-instructions {
            font-size: 1.3rem;
            color: #fff;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border-left: 5px solid var(--lightning-primary);
        }

        .evaluation-buttons {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .eval-btn {
            padding: 1.5rem 3rem;
            border: none;
            border-radius: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 180px;
        }

        .eval-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .eval-btn.excellent {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
        }

        .eval-btn.very-good {
            background: linear-gradient(45deg, #00bcd4, #4caf50);
            color: white;
        }

        .eval-btn.good {
            background: linear-gradient(45deg, #2196f3, #03dac6);
            color: white;
        }

        .eval-btn.weak {
            background: linear-gradient(45deg, #ff9800, #ffc107);
            color: white;
        }

        .competition-controls {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .start-competition {
            background: linear-gradient(45deg, #00f260, #0575e6);
            color: white;
        }

        .pause-competition {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .end-competition {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .back-to-kingdoms {
            background: linear-gradient(45deg, #fa709a, #fee140);
            color: white;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid var(--lightning-primary);
            border-radius: 25px;
            padding: 3rem;
            max-width: 700px;
            max-height: 90vh;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            animation: modalSlideIn 0.5s ease-out;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-title {
            font-size: 2rem;
            color: var(--lightning-primary);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .modal-message {
            font-size: 1.2rem;
            color: white;
            margin: 1.5rem 0;
            line-height: 1.6;
            text-align: right;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: var(--lightning-primary);
            color: #000;
        }

        .modal-btn.secondary {
            background: transparent;
            color: var(--lightning-primary);
            border: 2px solid var(--lightning-primary);
        }

        .students-queue {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .queue-title {
            text-align: center;
            font-size: 1.3rem;
            color: var(--lightning-primary);
            margin-bottom: 1rem;
        }

        .students-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .student-card {
            background: var(--student-card-bg);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 1rem;
            min-width: 120px;
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .student-card.current {
            border-color: var(--lightning-primary);
            background: rgba(255, 215, 0, 0.2);
            box-shadow: var(--lightning-glow);
            transform: scale(1.05);
        }

        .student-card.completed {
            border-color: var(--success-color);
            background: rgba(76, 175, 80, 0.2);
            opacity: 0.7;
        }

        .student-card.eliminated {
            border-color: var(--danger-color);
            background: rgba(244, 67, 54, 0.2);
            opacity: 0.5;
        }

        .student-name {
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .student-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .status-waiting {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
        }

        .status-current {
            background: rgba(255, 215, 0, 0.3);
            color: var(--lightning-primary);
        }

        .status-completed {
            background: rgba(76, 175, 80, 0.3);
            color: var(--success-color);
        }

        .status-eliminated {
            background: rgba(244, 67, 54, 0.3);
            color: var(--danger-color);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .main-timer {
                font-size: 3rem;
            }
            
            .student-spotlight {
                font-size: 2rem;
            }
            
            .evaluation-buttons {
                gap: 1rem;
            }
            
            .eval-btn {
                padding: 1rem 2rem;
                font-size: 1.1rem;
                min-width: 140px;
            }
            
            .competition-controls {
                gap: 1rem;
            }
            
            .modal-content {
                padding: 2rem;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="kingdom-header">
        <div class="kingdom-title">âš¡ Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¨Ø±Ù‚</div>
        <p>ØªØ­Ø¯ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ† - 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø«Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ†Ø§ÙØ³</p>
        
        <div class="kingdom-stats">
            <div class="stat-card">
                <div class="stat-number" id="activeStudents">0</div>
                <div>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedStudents">0</div>
                <div>ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡Ù…</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="timeRemaining">5:00</div>
                <div>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
            </div>
        </div>
    </div>

    <div class="competition-container">
        <!-- Timer Section -->
        <div class="timer-section">
            <div class="main-timer" id="mainTimer">5:00</div>
            <div class="timer-label">â° ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠ</div>
        </div>

        <!-- Current Student Section -->
        <div class="current-student-section" id="studentSection" style="display: none;">
            <div class="student-spotlight" id="currentStudentName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
            <div class="teacher-instructions">
                <i class="fas fa-microphone"></i> 
                ÙˆØ¬Ù‡ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø´ÙÙˆÙŠØ§Ù‹ Ù„Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©
            </div>
            
            <div class="evaluation-buttons">
                <button class="eval-btn excellent" onclick="evaluateStudent('excellent')">
                    <i class="fas fa-star"></i>
                    Ù…Ù…ØªØ§Ø² (100 Ù†Ù‚Ø·Ø©)
                </button>
                <button class="eval-btn very-good" onclick="evaluateStudent('very-good')">
                    <i class="fas fa-thumbs-up"></i>
                    Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ (85 Ù†Ù‚Ø·Ø©)
                </button>
                <button class="eval-btn good" onclick="evaluateStudent('good')">
                    <i class="fas fa-check"></i>
                    Ø¬ÙŠØ¯ (70 Ù†Ù‚Ø·Ø©)
                </button>
                <button class="eval-btn weak" onclick="evaluateStudent('weak')">
                    <i class="fas fa-hand-paper"></i>
                    Ø¶Ø¹ÙŠÙ (40 Ù†Ù‚Ø·Ø©)
                </button>
            </div>
            
            <div class="elimination-section" style="margin-top: 1.5rem; text-align: center;">
                <button class="eval-btn" onclick="eliminateStudent()" style="background: linear-gradient(45deg, #8e44ad, #e74c3c); color: white; padding: 1rem 2rem;">
                    <i class="fas fa-user-times"></i>
                    Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
                </button>
            </div>
        </div>

        <!-- Students Queue -->
        <div class="students-queue">
            <div class="queue-title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†</div>
            <div class="students-list" id="studentsList">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ù€ JavaScript -->
            </div>
        </div>

        <!-- Competition Controls -->
        <div class="competition-controls">
            <button class="control-btn settings-btn" onclick="showCompetitionSettings()">
                <i class="fas fa-cog"></i>
                Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©
            </button>
            <button class="control-btn start-competition" onclick="startCompetition()">
                <i class="fas fa-play"></i>
                Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©
            </button>
            <button class="control-btn pause-competition" onclick="pauseCompetition()">
                <i class="fas fa-pause"></i>
                Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª
            </button>
            <button class="control-btn end-competition" onclick="endCompetition()">
                <i class="fas fa-stop"></i>
                Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©
            </button>
            <button class="control-btn back-to-kingdoms" onclick="goBackToKingdoms()">
                <i class="fas fa-home"></i>
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù…Ø§Ù„Ùƒ
            </button>
        </div>
    </div>

    <!-- Competition Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div>
            <div class="modal-message">
                <div class="settings-section">
                    <h4>ğŸ¯ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Øµ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨</h4>
                    <div class="setting-group">
                        <label>Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Øµ Ø§Ù„ØªÙŠ Ø³ÙŠØ­ØµÙ„ Ø¹Ù„ÙŠÙ‡Ø§ ÙƒÙ„ Ø·Ø§Ù„Ø¨:</label>
                        <input type="range" id="opportunitiesSlider" min="1" max="3" value="2" oninput="updateOpportunities(this.value)">
                        <div class="slider-value">
                            <span id="opportunitiesValue">2</span> ÙØ±ØµØ© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
                        </div>
                        <div style="font-size: 0.9rem; color: #ccc; margin-top: 0.5rem;">
                            ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯ØŒ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø£ÙƒØ«Ø± Ø¹Ø¯Ø§Ù„Ø©
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4>ğŸ“Š Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ</h4>
                    <div class="setting-group">
                        <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©:</label>
                        <select id="eliminationPercentage" onchange="updateSettingsPreview()">
                            <option value="25">25% - Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø®ÙÙŠÙ (Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</option>
                            <option value="33">33% - Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù…ØªÙˆØ³Ø· (Ù…ØªÙˆØ§Ø²Ù†)</option>
                            <option value="50" selected>50% - Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù‚ÙˆÙŠ (ØªÙ†Ø§ÙØ³ÙŠ)</option>
                            <option value="66">66% - Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø´Ø¯ÙŠØ¯ (Ù„Ù„Ø£Ù‚ÙˆÙŠØ§Ø¡ ÙÙ‚Ø·)</option>
                        </select>
                        <div style="font-size: 0.9rem; color: #ccc; margin-top: 0.5rem;">
                            ÙŠØ­Ø¯Ø¯ ÙƒÙ… Ø·Ø§Ù„Ø¨ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ù… ÙÙŠ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label>
                            <input type="checkbox" id="autoCalculateThreshold" checked onchange="toggleManualThreshold()">
                            Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¹ØªØ¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø­Ø³Ø¨ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨
                        </label>
                        <div style="font-size: 0.9rem; color: #ccc; margin-top: 0.5rem;">
                            ÙŠÙ†ØµØ­ Ø¨ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                        </div>
                    </div>
                    
                    <div class="setting-group" id="manualThresholdGroup" style="display: none;">
                        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ù†Ø¬Ø§Ø­:</label>
                        <input type="number" id="manualThreshold" min="30" max="100" value="70" step="5">
                        <div style="font-size: 0.9rem; color: #ccc; margin-top: 0.5rem;">
                            Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† ÙŠØ­ØµÙ„ÙˆÙ† Ø¹Ù„Ù‰ Ø£Ù‚Ù„ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø¯ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ù…
                        </div>
                    </div>
                </div>
                
                <div class="competition-preview" id="competitionPreview">
                    <div class="preview-title">ğŸ“‹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</div>
                    <div style="text-align: center; color: #ff9800;">
                        Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="applySettings()">
                    <i class="fas fa-check"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©
                </button>
                <button class="modal-btn secondary" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
            <div class="modal-message" id="modalMessage">ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeModal()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
            </div>
        </div>
    </div>
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
            <div class="modal-message" id="modalMessage">ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeModal()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
            </div>
        </div>
    </div>

    <div class="modal" id="competitionEndModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ† Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©!</div>
            <div class="modal-message" id="finalResults">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="returnToKingdomsCenter()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ù…Ø§Ù„Ùƒ</button>
                <button class="modal-btn secondary" onclick="startNewCompetition()">Ù…Ù†Ø§ÙØ³Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let competitionData = {
            students: [],
            currentStudentIndex: 0,
            totalTime: 5 * 60, // 5 minutes in seconds
            remainingTime: 5 * 60,
            isRunning: false,
            isPaused: false,
            results: [],
            completedStudents: 0,
            currentRound: 1,
            maxRounds: 2, // Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
            studentsPerRound: [],
            eliminationSettings: {
                opportunitiesPerStudent: 2, // 1-3 ÙØ±Øµ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
                eliminationPercentage: 50, // Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©
                minimumPassingScore: 70, // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ù†Ø¬Ø§Ø­
                autoCalculateThreshold: true // Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¹ØªØ¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            },
            phases: [], // Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯
            currentPhase: 1,
            totalPhases: 1
        };

        let competitionTimer;
        let audioEnabled = true;

        // ===== COMPETITION SETTINGS =====
        function showCompetitionSettings() {
            // Show modal first
            document.getElementById('settingsModal').style.display = 'flex';
            
            // Set current values
            document.getElementById('opportunitiesSlider').value = competitionData.eliminationSettings.opportunitiesPerStudent;
            document.getElementById('opportunitiesValue').textContent = competitionData.eliminationSettings.opportunitiesPerStudent;
            document.getElementById('eliminationPercentage').value = competitionData.eliminationSettings.eliminationPercentage;
            document.getElementById('autoCalculateThreshold').checked = competitionData.eliminationSettings.autoCalculateThreshold;
            document.getElementById('manualThreshold').value = competitionData.eliminationSettings.minimumPassingScore;
            
            // Update display
            toggleManualThreshold();
            
            // Update preview after a short delay to ensure DOM is ready
            setTimeout(() => {
                updateSettingsPreview();
            }, 100);
            
            // Play settings sound
            playSound('modal-open');
            setTimeout(() => {
                playSound('cosmic-click');
            }, 200);
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
            playSound('modal-close');
        }

        function updateOpportunities(value) {
            document.getElementById('opportunitiesValue').textContent = value;
            // Update preview after a short delay for smooth UI
            setTimeout(() => {
                updateSettingsPreview();
            }, 50);
        }

        function toggleManualThreshold() {
            const isAuto = document.getElementById('autoCalculateThreshold').checked;
            document.getElementById('manualThresholdGroup').style.display = isAuto ? 'none' : 'block';
            updateSettingsPreview();
        }

        function applySettings() {
            // Apply settings
            competitionData.eliminationSettings.opportunitiesPerStudent = parseInt(document.getElementById('opportunitiesSlider').value);
            competitionData.eliminationSettings.eliminationPercentage = parseInt(document.getElementById('eliminationPercentage').value);
            competitionData.eliminationSettings.autoCalculateThreshold = document.getElementById('autoCalculateThreshold').checked;
            competitionData.eliminationSettings.minimumPassingScore = parseInt(document.getElementById('manualThreshold').value);
            
            // Update max rounds
            competitionData.maxRounds = competitionData.eliminationSettings.opportunitiesPerStudent;
            
            // Calculate elimination phases
            calculateEliminationPhases();
            
            closeSettingsModal();
            displayStudentsList();
            
            // Show confirmation
            showNotification('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }

        function updateSettingsPreview() {
            const totalStudents = competitionData.students.length;
            const opportunities = parseInt(document.getElementById('opportunitiesSlider')?.value || competitionData.eliminationSettings.opportunitiesPerStudent);
            const eliminationRate = parseInt(document.getElementById('eliminationPercentage')?.value || competitionData.eliminationSettings.eliminationPercentage);
            
            if (totalStudents === 0) {
                document.getElementById('competitionPreview').innerHTML = `
                    <div class="preview-title">ğŸ“‹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</div>
                    <div style="text-align: center; color: #ff9800; padding: 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i><br>
                        <strong>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</strong><br>
                        <span style="font-size: 0.9rem;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ù…Ø§Ù„Ùƒ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹</span>
                    </div>
                `;
                return;
            }
            
            // Calculate phases
            const phases = calculatePreviewPhases(totalStudents, eliminationRate);
            
            let previewHTML = `
                <div class="preview-title">ğŸ“‹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
                <div style="margin-bottom: 1.5rem; text-align: center; background: rgba(255,215,0,0.1); padding: 1rem; border-radius: 10px;">
                    <div style="font-size: 1.1rem; color: var(--lightning-primary); margin-bottom: 0.5rem;">
                        <i class="fas fa-users"></i> <strong>${totalStudents}</strong> Ø·Ø§Ù„Ø¨ Ù…ØªÙ†Ø§ÙØ³
                    </div>
                    <div style="font-size: 1rem; color: #fff;">
                        <i class="fas fa-redo"></i> <strong>${opportunities}</strong> ÙØ±ØµØ© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
                    </div>
                </div>
                
                <div style="text-align: right; margin-bottom: 1rem;">
                    <strong style="color: var(--lightning-primary);">ğŸŸï¸ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©:</strong>
                </div>
            `;
            
            phases.forEach((phase, index) => {
                const isWinner = index === phases.length - 1;
                const eliminatedCount = index < phases.length - 1 ? phase.starting - phases[index + 1].starting : 0;
                
                previewHTML += `
                    <div class="phase-info">
                        <div>
                            <span style="font-weight: 700;">
                                ${isWinner ? 'ğŸ† Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠÙˆÙ†' : `âš¡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${index + 1}`}
                            </span>
                            ${!isWinner && eliminatedCount > 0 ? 
                                `<div style="font-size: 0.8rem; color: #ff9800; margin-top: 0.25rem;">
                                    Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ${eliminatedCount} Ø·Ø§Ù„Ø¨
                                </div>` : ''}
                        </div>
                        <div style="text-align: left;">
                            <span style="color: ${isWinner ? '#4caf50' : '#FFD700'}; font-weight: 700; font-size: 1.1rem;">
                                ${phase.remaining} Ø·Ø§Ù„Ø¨
                            </span>
                            <div style="font-size: 0.8rem; color: #ccc;">
                                ${isWinner ? 'Ù…Ø¤Ù‡Ù„ÙˆÙ† Ù„Ù„ÙÙˆØ²' : 'ÙŠÙ†ØªÙ‚Ù„ÙˆÙ† Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add summary
            const totalEliminated = totalStudents - phases[phases.length - 1].remaining;
            const winnerPercentage = Math.round((phases[phases.length - 1].remaining / totalStudents) * 100);
            
            previewHTML += `
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 10px; text-align: center;">
                    <div style="color: #ff9800; margin-bottom: 0.5rem;">
                        <i class="fas fa-chart-pie"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
                    </div>
                    <div style="font-size: 0.9rem; color: #ccc;">
                        Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ <strong style="color: #f44336;">${totalEliminated}</strong> Ø·Ø§Ù„Ø¨<br>
                        Ø³ÙŠÙÙˆØ² <strong style="color: #4caf50;">${phases[phases.length - 1].remaining}</strong> Ø·Ø§Ù„Ø¨ (${winnerPercentage}%)
                    </div>
                </div>
            `;
            
            document.getElementById('competitionPreview').innerHTML = previewHTML;
        }

        function calculatePreviewPhases(totalStudents, eliminationRate) {
            const phases = [];
            let currentStudents = totalStudents;
            let phaseNumber = 1;
            
            while (currentStudents > Math.ceil(totalStudents * 0.1) && phaseNumber <= 5) { // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 5 Ù…Ø±Ø§Ø­Ù„ Ø£Ùˆ 10% Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
                phases.push({
                    phase: phaseNumber,
                    starting: currentStudents,
                    remaining: currentStudents
                });
                
                // Calculate elimination for next phase
                const toEliminate = Math.floor(currentStudents * (eliminationRate / 100));
                currentStudents = Math.max(1, currentStudents - toEliminate);
                phaseNumber++;
            }
            
            // Final winners
            phases.push({
                phase: phaseNumber,
                starting: currentStudents,
                remaining: currentStudents,
                isFinal: true
            });
            
            return phases;
        }

        // ===== SMART ELIMINATION ALGORITHM =====
        function calculateEliminationPhases() {
            const totalStudents = competitionData.students.length;
            const eliminationRate = competitionData.eliminationSettings.eliminationPercentage;
            
            competitionData.phases = [];
            competitionData.totalPhases = 1;
            
            if (totalStudents <= 4) {
                // Small groups - no elimination, just ranking
                competitionData.phases = [{
                    phaseNumber: 1,
                    studentsAtStart: totalStudents,
                    studentsAtEnd: totalStudents,
                    eliminationThreshold: 0,
                    isRanking: true
                }];
                return;
            }
            
            let currentStudents = totalStudents;
            let phaseNumber = 1;
            const targetWinners = Math.max(2, Math.ceil(totalStudents * 0.1)); // 10% ÙØ§Ø¦Ø²ÙŠÙ† ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰
            
            while (currentStudents > targetWinners && phaseNumber <= 5) {
                const toEliminate = Math.floor(currentStudents * (eliminationRate / 100));
                const studentsRemaining = Math.max(targetWinners, currentStudents - toEliminate);
                
                competitionData.phases.push({
                    phaseNumber: phaseNumber,
                    studentsAtStart: currentStudents,
                    studentsAtEnd: studentsRemaining,
                    toEliminate: currentStudents - studentsRemaining,
                    eliminationThreshold: 0, // Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
                    isActive: phaseNumber === 1
                });
                
                currentStudents = studentsRemaining;
                phaseNumber++;
            }
            
            competitionData.totalPhases = competitionData.phases.length;
            competitionData.currentPhase = 1;
            
            console.log('ğŸ“Š Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯:', competitionData.phases);
        }

        function calculateDynamicThreshold() {
            if (!competitionData.eliminationSettings.autoCalculateThreshold) {
                return competitionData.eliminationSettings.minimumPassingScore;
            }
            
            const currentPhaseData = competitionData.phases[competitionData.currentPhase - 1];
            if (!currentPhaseData) return 70;
            
            // Get current scores of all active students
            const activeStudents = competitionData.students.filter(s => s.status !== 'eliminated');
            const scores = activeStudents.map(s => s.score || 0).sort((a, b) => b - a);
            
            if (scores.length === 0) return 70;
            
            // Calculate threshold based on target elimination
            const targetRemaining = currentPhaseData.studentsAtEnd;
            const thresholdIndex = Math.min(targetRemaining - 1, scores.length - 1);
            
            // Dynamic threshold with some flexibility
            const dynamicThreshold = scores[thresholdIndex] || 0;
            const minThreshold = Math.max(40, dynamicThreshold * 0.8); // Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 40 Ù†Ù‚Ø·Ø©
            const maxThreshold = Math.min(95, dynamicThreshold * 1.2); // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 95 Ù†Ù‚Ø·Ø©
            
            return Math.max(minThreshold, Math.min(maxThreshold, dynamicThreshold));
        }

        function checkPhaseElimination() {
            const currentPhaseData = competitionData.phases[competitionData.currentPhase - 1];
            if (!currentPhaseData || currentPhaseData.isRanking) return;
            
            // Check if all students have completed their opportunities for this phase
            const activeStudents = competitionData.students.filter(s => s.status !== 'eliminated');
            const allCompleted = activeStudents.every(student => 
                (student.attempts || 0) >= competitionData.eliminationSettings.opportunitiesPerStudent
            );
            
            if (!allCompleted) return;
            
            // Calculate elimination threshold
            const threshold = calculateDynamicThreshold();
            
            // Sort students by score and eliminate bottom performers
            const sortedStudents = activeStudents.sort((a, b) => (b.score || 0) - (a.score || 0));
            const studentsToKeep = Math.min(currentPhaseData.studentsAtEnd, sortedStudents.length);
            
            // Eliminate students below threshold
            sortedStudents.slice(studentsToKeep).forEach(student => {
                eliminateStudentPhase(student, `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${competitionData.currentPhase} - Ø£Ù‚Ù„ Ù…Ù† ${threshold} Ù†Ù‚Ø·Ø©`);
            });
            
            // Move to next phase if there are more phases
            if (competitionData.currentPhase < competitionData.totalPhases) {
                setTimeout(() => {
                    startNextPhase();
                }, 3000);
            } else {
                // Competition ended
                setTimeout(() => {
                    endCompetition();
                }, 2000);
            }
        }

        function eliminateStudentPhase(student, reason) {
            student.status = 'eliminated';
            student.eliminationReason = reason;
            student.eliminationPhase = competitionData.currentPhase;
            student.score = Math.max(0, (student.score || 0) - 20); // Small penalty
            
            showPhaseEliminationResult(student, reason);
            
            // Play elimination sound sequence
            playSound('elimination');
            setTimeout(() => {
                playSound('thunder');
            }, 600);
        }

        function showPhaseEliminationResult(student, reason) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            title.innerHTML = 'âš¡ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø©';
            title.style.color = '#ff9800';
            
            message.innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem; color: #ff9800;">
                    <i class="fas fa-lightning-bolt"></i> ${student.name}
                </div>
                <div style="font-size: 1rem; color: #fff; margin-bottom: 1rem;">
                    ${reason}
                </div>
                <div style="font-size: 0.9rem; color: #ccc;">
                    Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù‚ÙˆÙŠØ© ÙÙŠ Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¨Ø±Ù‚!<br>
                    ÙØ±ØµØ© Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                </div>
            `;
            
            modal.style.display = 'flex';
            
            setTimeout(() => {
                closeModal();
            }, 2500);
        }

        function startNextPhase() {
            competitionData.currentPhase++;
            competitionData.currentRound = 1;
            competitionData.currentStudentIndex = 0;
            
            // Reset attempts for remaining students
            competitionData.students.forEach(student => {
                if (student.status !== 'eliminated') {
                    student.attempts = 0;
                    student.status = 'waiting';
                }
            });
            
            showPhaseTransitionModal();
            
            // Play phase transition sound sequence
            playSequentialSounds(['phase-transition', 'lightning', 'thunder'], 400);
            
            setTimeout(() => {
                closeModal();
                showCurrentStudent();
            }, 3500);
        }

        function showPhaseTransitionModal() {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            const currentPhaseData = competitionData.phases[competitionData.currentPhase - 1];
            const remainingStudents = competitionData.students.filter(s => s.status !== 'eliminated').length;
            
            title.innerHTML = `ğŸ”¥ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${competitionData.currentPhase}`;
            title.style.color = '#FFD700';
            
            message.innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem; color: var(--lightning-primary);">
                    <i class="fas fa-bolt"></i> Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¨Ø±Ù‚!
                </div>
                <div style="font-size: 1.1rem; color: #fff; margin-bottom: 1rem;">
                    ${remainingStudents} Ø·Ø§Ù„Ø¨ Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©
                </div>
                <div style="font-size: 1rem; color: #ff9800;">
                    Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© ØªØ²Ø¯Ø§Ø¯ Ø´Ø±Ø§Ø³Ø©...<br>
                    ÙÙ‚Ø· Ø§Ù„Ø£ÙØ¶Ù„ Ø³ÙŠØªØ£Ù‡Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©!
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Play epic phase transition sound
            playSound('phase-transition');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                z-index: 2000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentsData();
            updateDisplay();
            setupSoundSystem();
            
            // Setup event listeners for settings
            if (document.getElementById('autoCalculateThreshold')) {
                document.getElementById('autoCalculateThreshold').addEventListener('change', toggleManualThreshold);
            }
            if (document.getElementById('eliminationPercentage')) {
                document.getElementById('eliminationPercentage').addEventListener('change', updateSettingsPreview);
            }
            
            // Hide any modals that might be open
            closeModal();
            closeSettingsModal();
        });

        // ===== LOAD STUDENTS DATA =====
        function loadStudentsData() {
            // Load from kingdoms center data
            const transferData = localStorage.getItem('kingdomTransferData');
            const kingdomData = localStorage.getItem('kingdomGameState');
            const playersData = localStorage.getItem('squidGamePlayers');

            let studentsFound = false;

            // Try different data sources
            if (transferData) {
                try {
                    const data = JSON.parse(transferData);
                    if (data.selectedStudents && data.selectedStudents.length > 0) {
                        competitionData.students = data.selectedStudents.map((name, index) => ({
                            id: index + 1,
                            name: name,
                            status: 'waiting', // waiting, current, completed, eliminated
                            score: 0,
                            evaluation: null,
                            timestamp: null
                        }));
                        studentsFound = true;
                    }
                } catch (e) {
                    console.log('Error loading transfer data:', e);
                }
            }

            // Fallback to kingdom game state
            if (!studentsFound && kingdomData) {
                try {
                    const data = JSON.parse(kingdomData);
                    if (data.selectedStudents && data.selectedStudents.length > 0) {
                        const students = Array.isArray(data.selectedStudents) ? 
                                       data.selectedStudents : Object.values(data.selectedStudents);
                        competitionData.students = students.map((name, index) => ({
                            id: index + 1,
                            name: name,
                            status: 'waiting',
                            score: 0,
                            evaluation: null,
                            timestamp: null
                        }));
                        studentsFound = true;
                    }
                } catch (e) {
                    console.log('Error loading kingdom data:', e);
                }
            }

            // Filter out eliminated students from previous games
            if (studentsFound && playersData) {
                try {
                    const players = JSON.parse(playersData);
                    competitionData.students = competitionData.students.filter(student => {
                        const player = players.find(p => p.name === student.name);
                        return !player || player.status === 'alive';
                    });
                } catch (e) {
                    console.log('Error filtering eliminated students:', e);
                }
            }

            // Default students if none found
            if (!studentsFound || competitionData.students.length === 0) {
                competitionData.students = [
                    { id: 1, name: 'Ø·Ø§Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ 1', status: 'waiting', score: 0, evaluation: null, timestamp: null },
                    { id: 2, name: 'Ø·Ø§Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ 2', status: 'waiting', score: 0, evaluation: null, timestamp: null },
                    { id: 3, name: 'Ø·Ø§Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ 3', status: 'waiting', score: 0, evaluation: null, timestamp: null }
                ];
            }

            // Shuffle students for random order
            competitionData.students = shuffleArray(competitionData.students);
            
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨:', competitionData.students);
            
            // Calculate elimination phases after loading students
            calculateEliminationPhases();
            
            displayStudentsList();
        }

        // ===== UTILITY FUNCTIONS =====
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function playSound(soundType) {
            if (!audioEnabled) return;
            
            try {
                const audio = new Audio();
                const soundMap = {
                    // Competition sounds
                    'start': '../assets/media/sounds/kingdom-sounds/battle-horn.mp3',
                    'success': '../assets/media/sounds/kingdom-sounds/achievement-unlock.mp3',
                    'end': '../assets/media/sounds/kingdom-sounds/crown-ceremony.mp3',
                    'pause': '../assets/media/sounds/kingdom-sounds/button-hover.mp3',
                    'warning': '../assets/media/sounds/kingdom-sounds/countdown-tick.mp3',
                    
                    // Evaluation sounds
                    'excellent': '../assets/media/sounds/kingdom-sounds/epic-victory.mp3',
                    'very-good': '../assets/media/sounds/kingdom-sounds/achievement-unlock.mp3',
                    'good': '../assets/media/sounds/kingdom-sounds/level-up.mp3',
                    'weak': '../assets/media/sounds/kingdom-sounds/notification-pop.mp3',
                    'fail': '../assets/media/sounds/wrong_answer.mp3',
                    
                    // Student and round transition sounds
                    'next-student': '../assets/media/sounds/kingdom-sounds/cosmic-click.mp3',
                    'new-round': '../assets/media/sounds/kingdom-sounds/dimensional-shift.mp3',
                    'phase-transition': '../assets/media/sounds/kingdom-sounds/epic-charge.mp3',
                    'elimination': '../assets/media/sounds/kingdom-sounds/lightning-strike.mp3',
                    
                    // UI interaction sounds
                    'cosmic-click': '../assets/media/sounds/kingdom-sounds/cosmic-click.mp3',
                    'hover': '../assets/media/sounds/kingdom-sounds/button-hover.mp3',
                    'modal-open': '../assets/media/sounds/kingdom-sounds/mystic-wind.mp3',
                    'modal-close': '../assets/media/sounds/kingdom-sounds/crystal-ping.mp3',
                    
                    // Special effects
                    'lightning': '../assets/media/sounds/kingdom-sounds/lightning-whoosh.mp3',
                    'thunder': '../assets/media/sounds/kingdom-sounds/electric-charge.mp3',
                    'magic': '../assets/media/sounds/kingdom-sounds/magic-sparkle.mp3',
                    'victory': '../assets/media/sounds/kingdom-sounds/fireworks-burst.mp3'
                };
                
                audio.src = soundMap[soundType] || soundMap['cosmic-click'];
                audio.volume = getSoundVolume(soundType);
                
                // Add fade in effect for some sounds
                if (['start', 'phase-transition', 'new-round'].includes(soundType)) {
                    audio.volume = 0;
                    audio.play().then(() => {
                        fadeInAudio(audio, getSoundVolume(soundType));
                    });
                } else {
                    audio.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', soundType, e));
                }
                
            } catch (e) {
                console.log('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
            }
        }

        function getSoundVolume(soundType) {
            const volumeMap = {
                'start': 0.8,
                'excellent': 0.9,
                'very-good': 0.7,
                'good': 0.6,
                'weak': 0.5,
                'elimination': 0.8,
                'phase-transition': 0.9,
                'new-round': 0.7,
                'next-student': 0.4,
                'cosmic-click': 0.3,
                'hover': 0.2,
                'modal-open': 0.5,
                'modal-close': 0.4,
                'lightning': 0.8,
                'thunder': 0.9,
                'magic': 0.6,
                'victory': 1.0
            };
            return volumeMap[soundType] || 0.6;
        }

        function fadeInAudio(audio, targetVolume, duration = 1000) {
            const steps = 20;
            const stepTime = duration / steps;
            const volumeStep = targetVolume / steps;
            let currentStep = 0;
            
            const fadeInterval = setInterval(() => {
                currentStep++;
                audio.volume = Math.min(volumeStep * currentStep, targetVolume);
                
                if (currentStep >= steps) {
                    clearInterval(fadeInterval);
                }
            }, stepTime);
        }

        function playSequentialSounds(sounds, delay = 500) {
            sounds.forEach((sound, index) => {
                setTimeout(() => {
                    playSound(sound);
                }, index * delay);
            });
        }

        function playRandomLightningEffect() {
            const effects = ['lightning', 'thunder', 'magic'];
            const randomEffect = effects[Math.floor(Math.random() * effects.length)];
            playSound(randomEffect);
        }

        function setupSoundSystem() {
            // Test audio support
            try {
                const testAudio = new Audio();
                testAudio.src = '../assets/media/sounds/kingdom-sounds/cosmic-click.mp3';
                testAudio.volume = 0.1;
                testAudio.play().then(() => {
                    testAudio.pause();
                    audioEnabled = true;
                    console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø¬Ø§Ù‡Ø² - Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¨Ø±Ù‚');
                    
                    // Play welcome sound
                    setTimeout(() => {
                        playSound('modal-open');
                    }, 500);
                    
                }).catch(() => {
                    console.log('âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª - ÙˆØ¶Ø¹ ØµØ§Ù…Øª');
                    audioEnabled = false;
                });
            } catch (e) {
                audioEnabled = false;
                console.log('âŒ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªØ§Ø­');
            }
            
            // Add hover sounds to buttons
            addHoverSounds();
        }

        function addHoverSounds() {
            // Add hover sounds to all buttons
            const buttons = document.querySelectorAll('.control-btn, .eval-btn, .modal-btn');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    if (audioEnabled) {
                        playSound('hover');
                    }
                });
                
                button.addEventListener('click', () => {
                    if (audioEnabled) {
                        playSound('cosmic-click');
                    }
                });
            });
        }

        // ===== DISPLAY FUNCTIONS =====
        function updateDisplay() {
            document.getElementById('activeStudents').textContent = competitionData.students.filter(s => s.status === 'waiting').length;
            document.getElementById('completedStudents').textContent = competitionData.completedStudents;
            document.getElementById('timeRemaining').textContent = formatTime(competitionData.remainingTime);
            document.getElementById('mainTimer').textContent = formatTime(competitionData.remainingTime);
            
            // Update timer color based on remaining time
            const timerElement = document.getElementById('mainTimer');
            if (competitionData.remainingTime <= 60) {
                timerElement.style.color = '#f44336';
                if (competitionData.remainingTime <= 30) {
                    timerElement.style.animation = 'pulse 1s infinite';
                }
            } else if (competitionData.remainingTime <= 120) {
                timerElement.style.color = '#ff9800';
            } else {
                timerElement.style.color = 'var(--lightning-primary)';
            }
        }

        function displayStudentsList() {
            const container = document.getElementById('studentsList');
            container.innerHTML = '';
            
            competitionData.students.forEach((student, index) => {
                const studentCard = document.createElement('div');
                studentCard.className = `student-card ${student.status}`;
                
                // Count total attempts for this student
                const attempts = (student.attempts || 0) + (student.status === 'completed' ? 1 : 0);
                
                studentCard.innerHTML = `
                    <div class="student-name">${student.name}</div>
                    <div class="student-status status-${student.status}">
                        ${getStatusText(student.status)}
                    </div>
                    <div style="font-size: 0.7rem; color: #ccc; margin-top: 0.25rem;">
                        Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${attempts}/${competitionData.eliminationSettings.opportunitiesPerStudent}
                        ${competitionData.currentPhase > 1 ? ` | Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${competitionData.currentPhase}` : ''}
                    </div>
                    ${student.score > 0 ? `<div style="color: var(--lightning-primary); font-weight: 700; margin-top: 0.5rem;">${student.score} Ù†Ù‚Ø·Ø©</div>` : ''}
                `;
                container.appendChild(studentCard);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'waiting': 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                'current': 'Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ',
                'completed': 'ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡',
                'eliminated': 'Ù…ÙØ³ØªØ¨Ø¹Ø¯'
            };
            return statusMap[status] || status;
        }

        function showCurrentStudent() {
            // Check if we need to start a new round
            if (competitionData.currentStudentIndex >= competitionData.students.length) {
                if (competitionData.currentRound < competitionData.maxRounds) {
                    startNewRound();
                    return;
                } else {
                    endCompetition();
                    return;
                }
            }

            const currentStudent = competitionData.students[competitionData.currentStudentIndex];
            
            // Skip eliminated students
            if (currentStudent.status === 'eliminated') {
                competitionData.currentStudentIndex++;
                showCurrentStudent();
                return;
            }

            // Update student status
            competitionData.students.forEach(s => {
                if (s.status === 'current') s.status = 'waiting';
            });
            currentStudent.status = 'current';

            // Display current student with round info and phase
            const phaseInfo = competitionData.currentPhase > 1 ? ` - Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${competitionData.currentPhase}` : '';
            document.getElementById('currentStudentName').textContent = 
                `${currentStudent.name} - Ø§Ù„Ø¬ÙˆÙ„Ø© ${competitionData.currentRound}${phaseInfo}`;
            document.getElementById('studentSection').style.display = 'block';
            
            displayStudentsList();
            
            // Play student transition sound with lightning effect
            playSound('next-student');
            setTimeout(() => {
                playRandomLightningEffect();
            }, 300);

            // Show modal for new student
            showStudentModal(currentStudent);
        }

        function startNewRound() {
            competitionData.currentRound++;
            competitionData.currentStudentIndex = 0;
            
            // Reset students for new round (except eliminated ones)
            competitionData.students.forEach(student => {
                if (student.status !== 'eliminated') {
                    student.status = 'waiting';
                    // Keep previous scores but allow new attempts
                }
            });
            
            // Check if round exceeds opportunities per student
            if (competitionData.currentRound > competitionData.eliminationSettings.opportunitiesPerStudent) {
                checkPhaseElimination();
                return;
            }
            
            // Shuffle again for new round
            const availableStudents = competitionData.students.filter(s => s.status !== 'eliminated');
            const shuffledStudents = shuffleArray(availableStudents);
            
            // Replace available students in original array with shuffled order
            let shuffleIndex = 0;
            for (let i = 0; i < competitionData.students.length; i++) {
                if (competitionData.students[i].status !== 'eliminated') {
                    competitionData.students[i] = shuffledStudents[shuffleIndex];
                    shuffleIndex++;
                }
            }
            
            showRoundStartModal();
            setTimeout(() => {
                closeModal();
                showCurrentStudent();
            }, 2500);
            
            // Play new round sound sequence
            playSound('new-round');
            setTimeout(() => {
                playSound('thunder');
            }, 800);
        }

        function showRoundStartModal() {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            const activeStudents = competitionData.students.filter(s => s.status !== 'eliminated').length;
            const currentPhaseData = competitionData.phases[competitionData.currentPhase - 1];
            
            title.innerHTML = `ğŸ”„ Ø§Ù„Ø¬ÙˆÙ„Ø© ${competitionData.currentRound}`;
            message.innerHTML = `
                <div style="font-size: 1.3rem; color: var(--lightning-primary); margin-bottom: 1rem;">
                    <i class="fas fa-refresh"></i> Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©!
                </div>
                <div style="color: #fff;">
                    ${activeStudents} Ø·Ø§Ù„Ø¨ Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${competitionData.currentPhase}<br>
                    ${competitionData.eliminationSettings.opportunitiesPerStudent - competitionData.currentRound + 1} ÙØ±ØµØ© Ù…ØªØ¨Ù‚ÙŠØ© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨<br>
                    Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¬Ø§Ù‡Ø²
                </div>
                ${currentPhaseData && !currentPhaseData.isRanking ? `
                    <div style="color: #ff9800; margin-top: 1rem; font-size: 0.9rem;">
                        Ø§Ù„Ù‡Ø¯Ù: ${currentPhaseData.studentsAtEnd} Ø·Ø§Ù„Ø¨ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                    </div>
                ` : ''}
            `;
            
            modal.style.display = 'flex';
            
            // Play round start sound
            playSound('new-round');
        }

        function showStudentModal(student) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            title.innerHTML = 'ğŸ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ';
            message.innerHTML = `
                <div style="font-size: 1.5rem; color: var(--lightning-primary); margin-bottom: 1rem;">
                    <i class="fas fa-user"></i> ${student.name}
                </div>
                <div style="color: #fff;">
                    <i class="fas fa-microphone"></i> ÙˆØ¬Ù‡ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø´ÙÙˆÙŠØ§Ù‹ Ù„Ù„Ø·Ø§Ù„Ø¨<br>
                    <i class="fas fa-clock"></i> Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙˆÙ‚Ù… Ø¨Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Play student modal sound
            playSound('modal-open');
            
            setTimeout(() => {
                closeModal();
            }, 3000);
        }

        // ===== COMPETITION CONTROL FUNCTIONS =====
        function startCompetition() {
            if (competitionData.students.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨! ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ù…Ø§Ù„Ùƒ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨.');
                return;
            }

            // Show settings first if not configured
            if (!competitionData.phases || competitionData.phases.length === 0) {
                showCompetitionSettings();
                return;
            }

            competitionData.isRunning = true;
            competitionData.isPaused = false;
            competitionData.currentStudentIndex = 0;
            competitionData.remainingTime = competitionData.totalTime;
            competitionData.currentRound = 1;
            competitionData.currentPhase = 1;
            competitionData.studentsPerRound = [];
            
            // Reset all students to waiting and clear previous scores/attempts
            competitionData.students.forEach(student => {
                student.status = 'waiting';
                student.score = 0;
                student.attempts = 0;
                student.weakCount = 0;
                student.eliminationReason = null;
                student.eliminationPhase = null;
            });

            startTimer();
            showCompetitionStartModal();
            
            setTimeout(() => {
                closeModal();
                showCurrentStudent();
            }, 3500);
            
            // Play epic start sequence
            playSequentialSounds(['start', 'lightning', 'thunder'], 600);

            // Update button
            const startBtn = document.querySelector('.start-competition');
            startBtn.innerHTML = '<i class="fas fa-refresh"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø¡';
        }

        function showCompetitionStartModal() {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            const totalStudents = competitionData.students.length;
            const opportunities = competitionData.eliminationSettings.opportunitiesPerStudent;
            const phases = competitionData.phases.length;
            
            title.innerHTML = 'âš¡ Ø¨Ø¯Ø§ÙŠØ© Ù…Ø¹Ø±ÙƒØ© Ø§Ù„Ø¨Ø±Ù‚!';
            title.style.color = '#FFD700';
            
            message.innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem; color: #FFD700;">
                    <i class="fas fa-bolt"></i> Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø§Ù„Ø¢Ù† Ù…Ø¨Ø§Ø´Ø±Ø©!
                </div>
                <div style="font-size: 1.1rem; color: #fff; margin-bottom: 1rem;">
                    ${totalStudents} Ø·Ø§Ù„Ø¨ Ù…ØªÙ†Ø§ÙØ³<br>
                    ${opportunities} ÙØ±ØµØ© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨<br>
                    ${phases} Ù…Ø±Ø­Ù„Ø© Ø§Ø³ØªØ¨Ø¹Ø§Ø¯
                </div>
                <div style="font-size: 1rem; color: #ff9800;">
                    ÙÙ‚Ø· Ø§Ù„Ø£Ù‚ÙˆÙ‰ Ø³ÙŠÙ†Ø¬Ùˆ Ù…Ù† Ù…Ø¹Ø±ÙƒØ© Ø§Ù„Ø¨Ø±Ù‚!
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function pauseCompetition() {
            if (!competitionData.isRunning) return;
            
            competitionData.isPaused = !competitionData.isPaused;
            const pauseBtn = document.querySelector('.pause-competition');
            
            if (competitionData.isPaused) {
                clearInterval(competitionTimer);
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> Ù…ØªØ§Ø¨Ø¹Ø©';
                playSound('pause');
            } else {
                startTimer();
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
                playSound('cosmic-click');
            }
        }

        function endCompetition() {
            competitionData.isRunning = false;
            clearInterval(competitionTimer);
            
            // Hide current student section
            document.getElementById('studentSection').style.display = 'none';
            
            // Calculate final results (include all students with scores)
            const results = competitionData.students
                .filter(s => s.score > 0 || s.status === 'completed')
                .sort((a, b) => (b.score || 0) - (a.score || 0));
            
            // Show final results modal
            showFinalResults(results);
            
            // Save results to kingdoms center
            saveResultsToKingdomsCenter(results);
            
            // Play end competition sound sequence
            playSequentialSounds(['end', 'victory', 'magic'], 500);
        }

        function startTimer() {
            competitionTimer = setInterval(() => {
                if (!competitionData.isPaused) {
                    competitionData.remainingTime--;
                    updateDisplay();
                    
                    // Warning sounds
                    if (competitionData.remainingTime === 60 || competitionData.remainingTime === 30) {
                        playSound('warning');
                    }
                    
                    if (competitionData.remainingTime <= 0) {
                        endCompetition();
                    }
                }
            }, 1000);
        }

        // ===== EVALUATION FUNCTIONS =====
        function evaluateStudent(evaluation) {
            if (!competitionData.isRunning || competitionData.isPaused) return;
            
            const currentStudent = competitionData.students[competitionData.currentStudentIndex];
            if (!currentStudent) return;

            // Track attempts
            if (!currentStudent.attempts) currentStudent.attempts = 0;
            currentStudent.attempts++;

            // Set evaluation and score
            currentStudent.evaluation = evaluation;
            currentStudent.status = 'completed';
            currentStudent.timestamp = new Date().toISOString();
            
            const scoreMap = {
                'excellent': 100,
                'very-good': 85,
                'good': 70,
                'weak': 40
            };
            
            // Add to existing score
            const newScore = scoreMap[evaluation];
            currentStudent.score = (currentStudent.score || 0) + newScore;
            
            // Track weak performances for auto-elimination
            if (!currentStudent.weakCount) currentStudent.weakCount = 0;
            if (evaluation === 'weak') {
                currentStudent.weakCount++;
                
                // Auto-eliminate after 3 weak performances
                if (currentStudent.weakCount >= 3) {
                    showAutoEliminationWarning(currentStudent);
                    setTimeout(() => {
                        eliminateStudentAuto(currentStudent, 'Ø«Ù„Ø§Ø« Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¶Ø¹ÙŠÙØ© Ù…ØªØªØ§Ù„ÙŠØ©');
                    }, 2000);
                    return;
                }
            } else if (evaluation === 'excellent' || evaluation === 'very-good') {
                // Reset weak count on good performance
                currentStudent.weakCount = 0;
            }
            
            competitionData.completedStudents++;

            // Show evaluation result with round info
            showEvaluationResult(currentStudent, evaluation);
            
            // Play appropriate sound with effects
            if (evaluation === 'excellent') {
                playSound('excellent');
                setTimeout(() => playSound('victory'), 500);
            } else if (evaluation === 'very-good') {
                playSound('very-good');
                setTimeout(() => playSound('magic'), 300);
            } else if (evaluation === 'good') {
                playSound('good');
            } else if (evaluation === 'weak') {
                playSound('weak');
            }
            
            // Move to next student
            competitionData.currentStudentIndex++;
            
            setTimeout(() => {
                if (competitionData.currentStudentIndex < competitionData.students.length && competitionData.remainingTime > 0) {
                    showCurrentStudent();
                } else if (competitionData.currentRound < competitionData.eliminationSettings.opportunitiesPerStudent && competitionData.remainingTime > 0) {
                    startNewRound();
                } else {
                    // Check for phase elimination
                    checkPhaseElimination();
                }
            }, 2000);
            
            displayStudentsList();
            updateDisplay();
        }

        function showAutoEliminationWarning(student) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            title.innerHTML = 'âš ï¸ ØªØ­Ø°ÙŠØ± Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ';
            title.style.color = '#ff9800';
            
            message.innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem; color: #ff9800;">
                    <i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø·Ø§Ù„Ø¨ ${student.name}
                </div>
                <div style="font-size: 1.1rem; color: #fff;">
                    Ø­ØµÙ„ Ø¹Ù„Ù‰ 3 ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¶Ø¹ÙŠÙØ© Ù…ØªØªØ§Ù„ÙŠØ©<br>
                    Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...
                </div>
            `;
            
            modal.style.display = 'flex';
            playSound('warning');
        }

        function eliminateStudentAuto(student, reason) {
            student.status = 'eliminated';
            student.evaluation = 'auto-eliminated';
            student.eliminationReason = reason;
            student.score = -30; // Less penalty for auto-elimination
            student.timestamp = new Date().toISOString();

            showAutoEliminationResult(student, reason);
            
            competitionData.currentStudentIndex++;
            
            setTimeout(() => {
                if (competitionData.currentStudentIndex < competitionData.students.length && competitionData.remainingTime > 0) {
                    showCurrentStudent();
                } else {
                    endCompetition();
                }
            }, 3000);
            
            displayStudentsList();
            updateDisplay();
        }

        function showAutoEliminationResult(student, reason) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            title.innerHTML = 'ğŸ¤– Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ';
            title.style.color = '#ff5722';
            
            message.innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem; color: #ff5722;">
                    <i class="fas fa-robot"></i> ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                </div>
                <div style="font-size: 1.2rem; margin-bottom: 1rem;">
                    <strong>${student.name}</strong>
                </div>
                <div style="font-size: 1rem; color: #ff9800;">
                    Ø§Ù„Ø³Ø¨Ø¨: ${reason}
                </div>
                <div style="font-size: 1rem; color: #ff9800; margin-top: 0.5rem;">
                    ØªÙ… Ø®ØµÙ… 30 Ù†Ù‚Ø·Ø© ÙƒØ¹Ù‚ÙˆØ¨Ø©
                </div>
            `;
            
            modal.style.display = 'flex';
            
            setTimeout(() => {
                closeModal();
            }, 3000);
        }

        function eliminateStudent() {
            if (!competitionData.isRunning || competitionData.isPaused) return;
            
            const currentStudent = competitionData.students[competitionData.currentStudentIndex];
            if (!currentStudent) return;

            // Confirm elimination
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ "${currentStudent.name}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) {
                return;
            }

            // Set as eliminated
            currentStudent.status = 'eliminated';
            currentStudent.evaluation = 'eliminated';
            currentStudent.score = -50; // Penalty for elimination
            currentStudent.timestamp = new Date().toISOString();

            // Show elimination result
            showEliminationResult(currentStudent);
            
            // Play elimination sound
            playSound('fail');
            
            // Move to next student
            competitionData.currentStudentIndex++;
            
            setTimeout(() => {
                if (competitionData.currentStudentIndex < competitionData.students.length && competitionData.remainingTime > 0) {
                    showCurrentStudent();
                } else {
                    endCompetition();
                }
            }, 3000);
            
            displayStudentsList();
            updateDisplay();
        }

        function showEliminationResult(student) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            title.innerHTML = 'ğŸš« ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯';
            title.style.color = '#f44336';
            
            message.innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem; color: #f44336;">
                    <i class="fas fa-user-times"></i> ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨
                </div>
                <div style="font-size: 1.2rem; margin-bottom: 1rem;">
                    <strong>${student.name}</strong>
                </div>
                <div style="font-size: 1rem; color: #ff9800;">
                    ØªÙ… Ø®ØµÙ… 50 Ù†Ù‚Ø·Ø© ÙƒØ¹Ù‚ÙˆØ¨Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯
                </div>
                <div style="font-size: 0.9rem; color: #ccc; margin-top: 1rem;">
                    Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù†Ø´Ø·Ø©
                </div>
            `;
            
            modal.style.display = 'flex';
            
            setTimeout(() => {
                closeModal();
            }, 3000);
        }

        function showEvaluationResult(student, evaluation) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            
            const evaluationMap = {
                'excellent': { text: 'Ù…Ù…ØªØ§Ø²!', icon: 'ğŸŒŸ', color: '#4caf50' },
                'very-good': { text: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹!', icon: 'âœ¨', color: '#00bcd4' },
                'good': { text: 'Ø¬ÙŠØ¯!', icon: 'ï¿½', color: '#2196f3' },
                'weak': { text: 'Ø¶Ø¹ÙŠÙ', icon: 'ğŸ‘‹', color: '#ff9800' }
            };
            
            const evalData = evaluationMap[evaluation];
            const currentScore = student.score || 0;
            const attempts = student.attempts || 1;
            
            title.innerHTML = `${evalData.icon} ${evalData.text}`;
            title.style.color = evalData.color;
            
            message.innerHTML = `
                <div style="font-size: 1.3rem; margin-bottom: 1rem;">
                    Ø§Ù„Ø·Ø§Ù„Ø¨: <strong>${student.name}</strong>
                </div>
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #666;">
                    Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${attempts} - Ø§Ù„Ø¬ÙˆÙ„Ø© ${competitionData.currentRound}/${competitionData.eliminationSettings.opportunitiesPerStudent}
                    ${competitionData.currentPhase > 1 ? ` - Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${competitionData.currentPhase}` : ''}
                </div>
                <div style="font-size: 1.5rem; color: ${evalData.color}; font-weight: 700;">
                    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·: ${currentScore}
                </div>
                ${evaluation === 'weak' && student.weakCount >= 3 ? 
                    '<div style="color: #f44336; margin-top: 0.5rem; font-weight: bold;">âš ï¸ Ø®Ø·Ø± Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯!</div>' : ''}
            `;
            
            modal.style.display = 'flex';
            
            setTimeout(() => {
                closeModal();
            }, 2000);
        }

        // ===== MODAL FUNCTIONS =====
        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
            document.getElementById('competitionEndModal').style.display = 'none';
            playSound('modal-close');
        }

        function showFinalResults(results) {
            const modal = document.getElementById('competitionEndModal');
            const message = document.getElementById('finalResults');
            
            const eliminatedStudents = competitionData.students.filter(s => s.status === 'eliminated');
            
            let resultsHTML = `
                <div style="margin-bottom: 2rem;">
                    <div style="font-size: 1.2rem; margin-bottom: 1rem;">
                        ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©! 
                    </div>
                    <div style="color: var(--lightning-primary);">
                        ØªÙ… ØªÙ‚ÙŠÙŠÙ… ${competitionData.completedStudents} Ø·Ø§Ù„Ø¨
                    </div>
                    ${eliminatedStudents.length > 0 ? `
                        <div style="color: #f44336; margin-top: 0.5rem;">
                            ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ${eliminatedStudents.length} Ø·Ø§Ù„Ø¨
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (results.length > 0) {
                resultsHTML += '<div style="text-align: right; margin: 1rem 0;"><strong>ğŸ† Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</strong></div>';
                
                results.slice(0, 3).forEach((student, index) => {
                    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                    const medal = medals[index] || 'ğŸ…';
                    
                    resultsHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin: 0.5rem 0; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <span>${medal} ${student.name}</span>
                            <span style="color: var(--lightning-primary); font-weight: 700;">${student.score} Ù†Ù‚Ø·Ø©</span>
                        </div>
                    `;
                });
            }
            
            // Show eliminated students
            if (eliminatedStudents.length > 0) {
                resultsHTML += '<div style="text-align: right; margin: 1rem 0; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 1rem;"><strong>ğŸš« Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙˆÙ†:</strong></div>';
                
                eliminatedStudents.forEach(student => {
                    resultsHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin: 0.5rem 0; background: rgba(244,67,54,0.2); border-radius: 8px; border-left: 3px solid #f44336;">
                            <span>âŒ ${student.name}</span>
                            <span style="color: #f44336; font-weight: 700;">Ù…ÙØ³ØªØ¨Ø¹Ø¯</span>
                        </div>
                    `;
                });
            }
            
            message.innerHTML = resultsHTML;
            modal.style.display = 'flex';
        }

        // ===== NAVIGATION FUNCTIONS =====
        function returnToKingdomsCenter() {
            // Update kingdoms center with results
            saveResultsToKingdomsCenter();
            window.location.href = 'kingdoms-center.html';
        }

        function startNewCompetition() {
            // Reset competition data
            competitionData.currentStudentIndex = 0;
            competitionData.remainingTime = competitionData.totalTime;
            competitionData.completedStudents = 0;
            competitionData.isRunning = false;
            competitionData.isPaused = false;
            
            // Reset students
            competitionData.students.forEach(student => {
                if (student.status !== 'eliminated') {
                    student.status = 'waiting';
                    student.score = 0;
                    student.evaluation = null;
                    student.timestamp = null;
                }
            });
            
            // Shuffle again
            competitionData.students = shuffleArray(competitionData.students);
            
            closeModal();
            displayStudentsList();
            updateDisplay();
            
            document.getElementById('studentSection').style.display = 'none';
            document.querySelector('.start-competition').innerHTML = '<i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©';
        }

        function goBackToKingdoms() {
            if (competitionData.isRunning) {
                if (confirm('Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø¬Ø§Ø±ÙŠØ©! Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŸ')) {
                    saveResultsToKingdomsCenter();
                    window.location.href = 'kingdoms-center.html';
                }
            } else {
                window.location.href = 'kingdoms-center.html';
            }
        }

        // ===== SAVE RESULTS =====
        function saveResultsToKingdomsCenter() {
            try {
                // Save competition results
                const competitionResults = {
                    kingdom: 'lightning',
                    timestamp: new Date().toISOString(),
                    totalStudents: competitionData.students.length,
                    completedStudents: competitionData.completedStudents,
                    eliminatedStudents: competitionData.students.filter(s => s.status === 'eliminated').length,
                    duration: competitionData.totalTime - competitionData.remainingTime,
                    results: competitionData.students.filter(s => s.status === 'completed' || s.status === 'eliminated')
                };
                
                localStorage.setItem('lightning-kingdom-results', JSON.stringify(competitionResults));
                
                // Update individual student records for kingdoms center
                const playersData = localStorage.getItem('squidGamePlayers');
                if (playersData) {
                    const players = JSON.parse(playersData);
                    
                    competitionData.students.forEach(student => {
                        const player = players.find(p => p.name === student.name);
                        if (player && (student.status === 'completed' || student.status === 'eliminated')) {
                            
                            // Handle elimination
                            if (student.status === 'eliminated') {
                                player.status = 'eliminated';
                                player.eliminationReason = 'Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù…Ù† Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¨Ø±Ù‚';
                                player.eliminationDate = new Date().toISOString();
                                player.score = Math.max(0, (player.score || 0) + student.score); // Add penalty (negative score)
                                player.gamesLost = (player.gamesLost || 0) + 1;
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                player.currentStreak = 0; // Reset streak
                                player.isEliminated = true;
                                player.lastActivity = new Date().toISOString();
                                return; // Skip further processing for eliminated students
                            }
                            
                            // Update player stats based on performance for completed students
                            if (student.evaluation === 'excellent') {
                                player.gamesWon = (player.gamesWon || 0) + 1;
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                player.correctAnswers = (player.correctAnswers || 0) + 1;
                                player.currentStreak = (player.currentStreak || 0) + 1;
                                if (player.currentStreak > (player.bestStreak || 0)) {
                                    player.bestStreak = player.currentStreak;
                                }
                            } else if (student.evaluation === 'very-good') {
                                player.gamesWon = (player.gamesWon || 0) + 1;
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                player.correctAnswers = (player.correctAnswers || 0) + 1;
                                player.currentStreak = (player.currentStreak || 0) + 1;
                                if (player.currentStreak > (player.bestStreak || 0)) {
                                    player.bestStreak = player.currentStreak;
                                }
                            } else if (student.evaluation === 'good') {
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                player.correctAnswers = (player.correctAnswers || 0) + 1;
                            } else if (student.evaluation === 'weak') {
                                player.questionsAnswered = (player.questionsAnswered || 0) + 1;
                                // No correct answer added for weak performance
                                player.currentStreak = Math.max(0, (player.currentStreak || 0) - 1);
                            }
                            
                            // Add score and experience (only for non-eliminated)
                            player.score = (player.score || 0) + student.score;
                            player.experiencePoints = (player.experiencePoints || 0) + Math.max(0, student.score);
                            
                            // Update level based on experience
                            const newLevel = Math.floor(player.experiencePoints / 100) + 1;
                            if (newLevel > (player.level || 1)) {
                                player.level = newLevel;
                                player.score += newLevel * 50; // Level up bonus
                            }
                            
                            // Update activity
                            player.lastActivity = new Date().toISOString();
                        }
                    });
                    
                    localStorage.setItem('squidGamePlayers', JSON.stringify(players));
                }
                
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯');
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', e);
            }
        }
    </script>
</body>
</html>
