<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ Ø³Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¹ØµØ±ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
        <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --tower-gradient: linear-gradient(45deg, #ffd700 0%, #ff6b35 50%, #ffd700 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-gold: linear-gradient(90deg, #FFD700 0%, #fff 100%);
            --glass: rgba(255,255,255,0.10);
            --shadow: 0 4px 24px #0006;
            --accent-gold: #FFD700;
            --oman-green: #11998e;
            --oman-red: #fc466b;
            --oman-white: #fff;
            --cosmic-bg: linear-gradient(45deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --success-color: #11998e;
            --danger-color: #fc466b;
            --warning-color: #f5576c;
            --neon-cyan: #00f5ff;
            --neon-pink: #ff073a;
            --border-radius: 15px;
            --border-radius-small: 10px;
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 20px;
            --spacing-lg: 30px;
            --spacing-xl: 40px;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            --elastic-timing: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --cosmic-timing: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-light: rgba(255, 255, 255, 0.9);
            --glow-gold: 0 0 16px #FFD70099;
        }
        html, body {
            height: 100%;
            font-family: 'Cairo', system-ui, sans-serif;
            background: var(--cosmic-bg);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        body {
            position: relative;
        }
        .container, .arena {
            margin-top: 90px !important;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            padding: 24px 12px 0 12px;
            background: var(--glass);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .header {
            margin-top: 110px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: var(--glow-gold);
        }
        .header p {
            font-size: 1.2rem;
            color: #fff;
            margin-top: 8px;
        }
        /* --- Toolbar Styles (copied from tower-game) --- */
        .top-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 50%, rgba(0, 0, 0, 0.8) 100%);
            backdrop-filter: blur(25px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-lg);
            z-index: 10000;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: toolbarSlideDown 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes toolbarSlideDown {
            0% { opacity: 0; transform: translateY(-100%); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .game-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-family: 'Orbitron', 'Cairo', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--tower-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
        }
        .game-logo::before {
            content: 'ğŸ‘‘';
            font-size: 2rem;
            animation: logoFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
        }
        .game-logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.8));
        }
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(10deg); }
        }
        .toolbar-icons {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }
        .toolbar-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--elastic-timing);
            position: relative;
            overflow: hidden;
            font-size: 1.3rem;
            color: var(--text-light);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .toolbar-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(0, 245, 255, 0.3), transparent, rgba(255, 7, 58, 0.3), transparent);
            opacity: 0;
            transition: all 0.6s ease;
            animation: iconAura 8s linear infinite;
        }
        @keyframes iconAura {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toolbar-icon:hover {
            transform: translateY(-3px) scale(1.1);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 15px 40px rgba(0, 245, 255, 0.4), 0 0 30px var(--neon-cyan), inset 0 2px 5px rgba(255, 255, 255, 0.3);
            text-shadow: 0 0 15px currentColor;
        }
        .toolbar-icon:hover::before {
            opacity: 1;
        }
        .toolbar-icon:active {
            transform: translateY(-1px) scale(1.05);
        }
        .home-icon {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-color: rgba(102, 126, 234, 0.5);
        }
        .home-icon:hover {
            border-color: rgba(102, 126, 234, 1);
            color: rgba(102, 126, 234, 1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5), 0 0 30px rgba(102, 126, 234, 1);
        }
        .sound-icon {
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.3) 0%, rgba(56, 239, 125, 0.3) 100%);
            border-color: rgba(17, 153, 142, 0.5);
        }
        .sound-icon:hover {
            border-color: var(--success-color);
            color: var(--success-color);
            box-shadow: 0 15px 40px rgba(17, 153, 142, 0.5), 0 0 30px var(--success-color);
        }
        .sound-icon.muted {
            background: linear-gradient(135deg, rgba(252, 70, 107, 0.3) 0%, rgba(63, 94, 251, 0.3) 100%);
            border-color: rgba(252, 70, 107, 0.5);
            color: var(--danger-color);
        }
        .sound-icon.muted:hover {
            border-color: var(--danger-color);
            box-shadow: 0 15px 40px rgba(252, 70, 107, 0.5), 0 0 30px var(--danger-color);
        }
        .settings-icon {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.3) 0%, rgba(75, 0, 130, 0.3) 100%);
            border-color: rgba(138, 43, 226, 0.5);
        }
        .settings-icon:hover {
            border-color: rgba(138, 43, 226, 1);
            color: rgba(138, 43, 226, 1);
            box-shadow: 0 15px 40px rgba(138, 43, 226, 0.5), 0 0 30px rgba(138, 43, 226, 1);
        }
        .settings-icon i {
            animation: settingsRotate 3s linear infinite;
        }
        .settings-icon:hover i {
            animation: settingsRotate 0.5s linear infinite;
        }
        @keyframes settingsRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fullscreen-icon {
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.3) 0%, rgba(245, 87, 108, 0.3) 100%);
            border-color: rgba(240, 147, 251, 0.5);
        }
        .fullscreen-icon:hover {
            border-color: var(--warning-color);
            color: var(--warning-color);
            box-shadow: 0 15px 40px rgba(240, 147, 251, 0.5), 0 0 30px var(--warning-color);
        }
        .guide-icon {
            position: relative;
            overflow: visible;
        }
        .guide-icon::before {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #11998e;
            border-radius: 50%;
            animation: guideIndicator 2s infinite;
        }
        @keyframes guideIndicator {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
        }
    .container { margin-top: 70px; }
    /* --- End Toolbar Styles --- */
        .toolbar-btn {
            background: var(--glass);
            border: none;
            color: var(--accent-gold);
            font-size: 1.3rem;
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px #FFD70033;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .toolbar-btn:hover {
            background: var(--accent-gold);
            color: #fff;
            box-shadow: 0 4px 16px #FFD70055;
        }
        .header {
            margin-top: 90px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.3rem;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: var(--glow-gold);
        }
        .header p {
            font-size: 1.2rem;
            color: #fff;
            margin-top: 8px;
        }
        .arena {
            margin: 32px auto 0 auto;
            max-width: 900px;
            padding: 0 12px;
        }
        .teams-row {
            display: flex;
            gap: 18px;
            justify-content: center;
            margin-bottom: 32px;
        }
        .team-card {
            background: var(--glass);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 24px 18px 18px 18px;
            min-width: 180px;
            text-align: center;
            border: 2.5px solid #FFD70055;
            position: relative;
            transition: box-shadow 0.3s, border 0.3s;
        }
        .team-card.active-turn {
            border: 3.5px solid var(--accent-gold);
            box-shadow: 0 0 24px #FFD70099;
        }
        .team-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }
        .team-progress {
            background: #fff2;
            border-radius: 12px;
            height: 18px;
            margin: 10px 0 8px 0;
            overflow: hidden;
            position: relative;
        }
        .team-progress-bar {
            background: var(--gradient-gold);
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s cubic-bezier(.4,0,.2,1);
        }
        .team-score {
            color: var(--oman-green);
            font-weight: bold;
            margin-top: 6px;
        }
        .team-icon {
            font-size: 1.7rem;
            color: var(--accent-gold);
            margin-top: 10px;
            transition: transform 0.5s cubic-bezier(.4,0,.2,1);
        }
        .arena-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 18px;
        }
        .arena-btn {
            background: var(--accent-gold);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 10px 24px;
            box-shadow: 0 2px 8px #FFD70033;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .arena-btn:hover {
            background: #fff;
            color: var(--accent-gold);
            box-shadow: 0 4px 16px #FFD70055;
        }
        .modal-overlay {
            position: fixed; inset: 0; background: #181a23cc; z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s; backdrop-filter: blur(8px);
        }
        .modal-overlay[hidden] { display: none !important; }
        .modal-content {
            background: var(--glass);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 36px 32px 28px 32px;
            min-width: 320px; max-width: 95vw;
            color: var(--accent-gold);
            border: 2px solid #FFD70055;
            text-align: center;
            font-size: 1.15rem;
            position: relative;
            animation: modalPop 0.5s cubic-bezier(.4,0,.2,1);
        }
        @keyframes modalPop {
            0% { transform: scale(0.8) translateY(40px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .modal-content h2 {
            color: var(--accent-gold);
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 18px;
            text-shadow: var(--glow-gold);
        }
        .modal-content ul {
            text-align: right;
            margin: 0 0 18px 0;
            padding: 0 18px;
            color: var(--oman-white);
            font-size: 1.05rem;
        }
        .modal-content button {
            margin-top: 18px;
        }
        #statsPanel, #honorBoard {
            font-family: 'Cairo', system-ui, sans-serif;
        }
    </style>
</head>
<body>
        <!-- Advanced Toolbar copied from tower-game.html -->
        <div class="top-toolbar">
            <div class="game-logo" id="gameLogo">
                <span>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ©</span>
            </div>
            <div class="toolbar-icons">
                <div class="toolbar-icon home-icon" id="homeIcon" data-tooltip="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
                    <i class="fas fa-home"></i>
                </div>
                <div class="toolbar-icon sound-icon" id="soundIcon" data-tooltip="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª">
                    <i class="fas fa-volume-up"></i>
                </div>
                <div class="toolbar-icon settings-icon" id="settingsIcon" data-tooltip="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="toolbar-icon guide-icon" id="guideIcon" data-tooltip="Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="toolbar-icon fullscreen-icon" id="fullscreenIcon" data-tooltip="Ù…Ù„Ø¦ Ø§Ù„Ø´Ø§Ø´Ø©">
                    <i class="fas fa-expand"></i>
                </div>
            </div>
        </div>
        <!-- End Advanced Toolbar -->
    <header class="header">
        <h1>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ©</h1>
        <p>Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ† ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø¨Ø§Ù‚!</p>
    </header>
    <section class="arena" id="arena">
        <div id="setupSection" style="width:100%;max-width:500px;margin:0 auto 32px auto;">
            <div style="margin-bottom:18px;">
                <label for="classSelect" style="font-weight:bold;font-size:1.1rem;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ:</label>
                <select id="classSelect" style="width:100%;padding:10px 12px;border-radius:12px;border:1.5px solid var(--accent-gold);background:var(--glass);color:var(--accent-gold);font-size:1.1rem;outline:none;margin-top:8px;">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
                </select>
            </div>
            <div id="studentsSection" style="display:none;">
                <label style="font-weight:bold;font-size:1.1rem;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†:</label>
                <div style="display:flex;gap:12px;margin:12px 0;">
                    <button class="arena-btn" id="randomSelectBtn" style="flex:1;">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
                    <button class="arena-btn" id="manualSelectBtn" style="flex:1;">Ø§Ù†ØªÙ‚Ø§Ø¦ÙŠ</button>
                </div>
                <div id="manualStudentsList" style="display:none;"></div>
                <button class="arena-btn" id="confirmCompetitorsBtn" style="width:100%;margin-top:12px;display:none;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†</button>
            </div>
        </div>
        <div class="teams-row" id="teamsRow" style="display:none;"></div>
        <div class="arena-controls" id="arenaControls" style="display:none;">
            <button class="arena-btn" id="startRaceBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
            <button class="arena-btn" id="nextQuestionBtn">Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
            <button class="arena-btn" id="correctBtn">Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</button>
            <button class="arena-btn" id="wrongBtn">Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©</button>
            <button class="arena-btn" id="pauseBtn">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
        </div>
    </section>
        <!-- Sound Settings Modal (copied from tower-game.html) -->
        <div class="sound-settings-modal" id="soundSettingsModal">
            <div class="sound-settings-panel">
                <div class="settings-header">
                    <div class="settings-title">
                        <i class="fas fa-sliders-h"></i>
                        Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
                    </div>
                    <button class="settings-close" id="settingsCloseBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="settings-group">
                    <div class="settings-group-title">
                        <i class="fas fa-volume-up"></i>
                        Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ø§Ù…
                    </div>
                    <div class="volume-control">
                        <div class="volume-label">
                            <span>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª:</span>
                            <span class="volume-value" id="volumeValue">70%</span>
                        </div>
                        <input type="range" class="volume-slider" id="masterVolumeSlider" min="0" max="100" value="70">
                    </div>
                </div>
                <div class="settings-group">
                    <div class="settings-group-title">
                        <i class="fas fa-music"></i>
                        Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£ØµÙˆØ§Øª
                    </div>
                    <div class="sound-toggles">
                        <div class="sound-toggle-item">
                            <div class="sound-toggle-info">
                                <div class="sound-toggle-icon"><i class="fas fa-mouse-pointer"></i></div>
                                <div class="sound-toggle-details"><h4>Ø£ØµÙˆØ§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h4><p>Ø§Ù„Ù†Ù‚Ø± ÙˆØ§Ù„ØªÙ…Ø±ÙŠØ± ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±</p></div>
                            </div>
                            <div class="toggle-switch active" data-sound="ui"></div>
                        </div>
                        <div class="sound-toggle-item">
                            <div class="sound-toggle-info">
                                <div class="sound-toggle-icon"><i class="fas fa-gamepad"></i></div>
                                <div class="sound-toggle-details"><h4>Ø£ØµÙˆØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h4><p>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„Ø®Ø§Ø·Ø¦Ø©</p></div>
                            </div>
                            <div class="toggle-switch active" data-sound="game"></div>
                        </div>
                        <div class="sound-toggle-item">
                            <div class="sound-toggle-info">
                                <div class="sound-toggle-icon"><i class="fas fa-trophy"></i></div>
                                <div class="sound-toggle-details"><h4>Ø£ØµÙˆØ§Øª Ø§Ù„Ø§Ù†ØªØµØ§Ø±</h4><p>Ø§Ù„ÙÙˆØ² ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</p></div>
                            </div>
                            <div class="toggle-switch active" data-sound="victory"></div>
                        </div>
                        <div class="sound-toggle-item">
                            <div class="sound-toggle-info">
                                <div class="sound-toggle-icon"><i class="fas fa-bell"></i></div>
                                <div class="sound-toggle-details"><h4>Ø£ØµÙˆØ§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h4><p>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª</p></div>
                            </div>
                            <div class="toggle-switch active" data-sound="notifications"></div>
                        </div>
                    </div>
                </div>
                <div class="settings-actions">
                    <button class="settings-btn secondary" id="resetSettingsBtn"><i class="fas fa-undo"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                    <button class="settings-btn primary" id="saveSettingsBtn"><i class="fas fa-save"></i>Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>
            </div>
        </div>
        <script>
        // ResponsiveHelper (keep as is)
        class ResponsiveHelper {
            constructor() {
                this.breakpoints = { mobile: 576, tablet: 768, desktop: 992, large: 1200 };
                this.currentDevice = this.detectDevice();
                this.orientation = this.getOrientation();
                this.init();
            }
            init() {
                window.addEventListener('resize', this.debounce(() => { this.handleResize(); }, 250));
                window.addEventListener('orientationchange', () => { setTimeout(() => { this.handleOrientationChange(); }, 100); });
            }
            detectDevice() {
                const width = window.innerWidth;
                if (width < this.breakpoints.mobile) return 'small-mobile';
                if (width < this.breakpoints.tablet) return 'mobile';
                if (width < this.breakpoints.desktop) return 'tablet';
                if (width < this.breakpoints.large) return 'desktop';
                return 'large-desktop';
            }
            getOrientation() { return window.innerHeight > window.innerWidth ? 'portrait' : 'landscape'; }
            isMobile() { return ['small-mobile', 'mobile'].includes(this.currentDevice); }
            isTablet() { return this.currentDevice === 'tablet'; }
            isTouchDevice() { return 'ontouchstart' in window || navigator.maxTouchPoints > 0; }
            handleResize() {
                const newDevice = this.detectDevice();
                const newOrientation = this.getOrientation();
                if (newDevice !== this.currentDevice) { this.currentDevice = newDevice; }
                if (newOrientation !== this.orientation) { this.orientation = newOrientation; }
            }
            handleOrientationChange() { this.orientation = this.getOrientation(); }
                    debounce(func, wait) {
                        let timeout;
                        return function (...args) {
                            clearTimeout(timeout);
                            timeout = setTimeout(() => func.apply(this, args), wait);
                        };
                    }
        }

            // --- AudioManager, SoundSettingsManager, ToolbarManager (copied from tower-game.html) ---
            class AudioManager {
                constructor() {
                    this.sounds = {};
                    this.volume = 0.7;
                    this.enabled = true;
                    this.soundCategories = {
                        ui: { enabled: true, volume: 1.0 },
                        game: { enabled: true, volume: 1.0 },
                        victory: { enabled: true, volume: 1.0 },
                        notifications: { enabled: true, volume: 1.0 }
                    };
                    this.loadSettings();
                    this.init();
                }
                async init() {
                    const soundFiles = {
                        'ui-click': { file: 'cosmic-click.mp3', category: 'ui' },
                        'ui-hover': { file: 'button-hover.mp3', category: 'ui' },
                        'toolbar-click': { file: 'ai-beep.mp3', category: 'ui' },
                        'home-click': { file: 'panel-slide.mp3', category: 'ui' },
                        'step-correct': { file: 'bonus-collect.mp3', category: 'game' },
                        'step-wrong': { file: 'cosmic-explosion.mp3', category: 'game' },
                        'step-hover': { file: 'crystal-bonus.mp3', category: 'game' },
                        'player-change': { file: 'character-intro.mp3', category: 'game' },
                        'game-start': { file: 'adventure-theme.mp3', category: 'game' },
                        'tower-complete': { file: 'battle-victory.mp3', category: 'victory' },
                        'achievement': { file: 'perfect-score.mp3', category: 'victory' },
                        'sound-toggle': { file: 'ai-notification.mp3', category: 'notifications' },
                        'fullscreen-toggle': { file: 'cosmic-portal.mp3', category: 'notifications' },
                        'settings-open': { file: 'book-open.mp3', category: 'notifications' },
                        'settings-close': { file: 'book-close.mp3', category: 'notifications' }
                    };
                    for (const [key, soundData] of Object.entries(soundFiles)) {
                        try {
                            const audio = new Audio(`../assets/media/sounds/kingdom-sounds/${soundData.file}`);
                            audio.volume = this.volume;
                            this.sounds[key] = { audio, category: soundData.category };
                        } catch (error) {
                            console.log(`Failed to load sound: ${soundData.file}`);
                        }
                    }
                }
                play(soundKey, options = {}) {
                    if (!this.enabled || !this.sounds[soundKey]) return;
                    const soundData = this.sounds[soundKey];
                    const category = soundData.category;
                    if (!this.soundCategories[category]?.enabled) return;
                    try {
                        const sound = soundData.audio;
                        sound.currentTime = 0;
                        const categoryVolume = this.soundCategories[category]?.volume || 1.0;
                        const finalVolume = (options.volume || 1) * this.volume * categoryVolume;
                        sound.volume = Math.max(0, Math.min(1, finalVolume));
                        sound.play().catch(() => {});
                    } catch (error) {
                        console.log('Sound play error:', error);
                    }
                }
                setVolume(volume) {
                    this.volume = Math.max(0, Math.min(1, volume));
                    Object.values(this.sounds).forEach(soundData => {
                        soundData.audio.volume = this.volume;
                    });
                    this.saveSettings();
                }
                setCategoryEnabled(category, enabled) {
                    if (this.soundCategories[category]) {
                        this.soundCategories[category].enabled = enabled;
                        this.saveSettings();
                    }
                }
                setCategoryVolume(category, volume) {
                    if (this.soundCategories[category]) {
                        this.soundCategories[category].volume = Math.max(0, Math.min(1, volume));
                        this.saveSettings();
                    }
                }
                isCategoryEnabled(category) {
                    return this.soundCategories[category]?.enabled || false;
                }
                toggle() {
                    this.enabled = !this.enabled;
                    this.saveSettings();
                    return this.enabled;
                }
                isEnabled() {
                    return this.enabled;
                }
                getVolume() {
                    return this.volume;
                }
                resetSettings() {
                    this.volume = 0.7;
                    this.enabled = true;
                    this.soundCategories = {
                        ui: { enabled: true, volume: 1.0 },
                        game: { enabled: true, volume: 1.0 },
                        victory: { enabled: true, volume: 1.0 },
                        notifications: { enabled: true, volume: 1.0 }
                    };
                    this.saveSettings();
                }
                saveSettings() {
                    const settings = {
                        volume: this.volume,
                        enabled: this.enabled,
                        categories: this.soundCategories
                    };
                    localStorage.setItem('knowledgeRace_audioSettings', JSON.stringify(settings));
                }
                loadSettings() {
                    try {
                        const saved = localStorage.getItem('knowledgeRace_audioSettings');
                        if (saved) {
                            const settings = JSON.parse(saved);
                            this.volume = settings.volume || 0.7;
                            this.enabled = settings.enabled !== undefined ? settings.enabled : true;
                            this.soundCategories = { ...this.soundCategories, ...settings.categories };
                        }
                    } catch (error) {
                        console.log('Error loading audio settings:', error);
                    }
                }
            }

            class SoundSettingsManager {
                constructor(audioManager) {
                    this.audio = audioManager;
                    this.initElements();
                    this.setupEvents();
                    this.loadSettings();
                }
                initElements() {
                    this.elements = {
                        modal: document.getElementById('soundSettingsModal'),
                        closeBtn: document.getElementById('settingsCloseBtn'),
                        volumeSlider: document.getElementById('masterVolumeSlider'),
                        volumeValue: document.getElementById('volumeValue'),
                        saveBtn: document.getElementById('saveSettingsBtn'),
                        resetBtn: document.getElementById('resetSettingsBtn'),
                        toggleSwitches: document.querySelectorAll('.toggle-switch')
                    };
                }
                setupEvents() {
                    this.elements.closeBtn?.addEventListener('click', () => {
                        this.closeModal();
                    });
                    this.elements.modal?.addEventListener('click', (e) => {
                        if (e.target === this.elements.modal) {
                            this.closeModal();
                        }
                    });
                    this.elements.volumeSlider?.addEventListener('input', (e) => {
                        const volume = parseInt(e.target.value) / 100;
                        this.updateVolumeDisplay(parseInt(e.target.value));
                        this.audio.setVolume(volume);
                        this.audio.play('ui-click', { volume: 0.5 });
                    });
                    this.elements.toggleSwitches?.forEach(toggle => {
                        toggle.addEventListener('click', () => {
                            this.toggleSoundCategory(toggle);
                        });
                    });
                    this.elements.saveBtn?.addEventListener('click', () => {
                        this.saveSettings();
                    });
                    this.elements.resetBtn?.addEventListener('click', () => {
                        this.resetSettings();
                    });
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.isOpen()) {
                            this.closeModal();
                        }
                    });
                }
                openModal() {
                    this.elements.modal?.classList.add('show');
                    this.loadSettings();
                    this.audio.play('settings-open');
                    setTimeout(() => {
                        this.elements.volumeSlider?.focus();
                    }, 300);
                }
                closeModal() {
                    this.elements.modal?.classList.remove('show');
                    this.audio.play('settings-close');
                }
                isOpen() {
                    return this.elements.modal?.classList.contains('show');
                }
                loadSettings() {
                    const volume = Math.round(this.audio.getVolume() * 100);
                    if (this.elements.volumeSlider) {
                        this.elements.volumeSlider.value = volume;
                    }
                    this.updateVolumeDisplay(volume);
                    this.elements.toggleSwitches?.forEach(toggle => {
                        const category = toggle.dataset.sound;
                        const isEnabled = this.audio.isCategoryEnabled(category);
                        toggle.classList.toggle('active', isEnabled);
                    });
                }
                updateVolumeDisplay(volume) {
                    if (this.elements.volumeValue) {
                        this.elements.volumeValue.textContent = `${volume}%`;
                        if (volume === 0) {
                            this.elements.volumeValue.style.background = 'var(--danger-gradient)';
                        } else if (volume < 30) {
                            this.elements.volumeValue.style.background = 'var(--warning-gradient)';
                        } else {
                            this.elements.volumeValue.style.background = 'var(--success-gradient)';
                        }
                    }
                    if (this.elements.volumeSlider) {
                        const percentage = volume;
                        this.elements.volumeSlider.style.background = `linear-gradient(90deg, var(--success-color) 0%, var(--success-color) ${percentage}%, rgba(255,255,255,0.1) ${percentage}%, rgba(255,255,255,0.1) 100%)`;
                    }
                }
                toggleSoundCategory(toggleElement) {
                    const category = toggleElement.dataset.sound;
                    const isCurrentlyActive = toggleElement.classList.contains('active');
                    toggleElement.classList.toggle('active');
                    const newState = !isCurrentlyActive;
                    this.audio.setCategoryEnabled(category, newState);
                    if (newState) {
                        this.audio.play('ui-click');
                    }
                    this.animateToggle(toggleElement, newState);
                }
                animateToggle(toggleElement, isActive) {
                    toggleElement.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        toggleElement.style.transform = 'scale(1)';
                        if (isActive) {
                            toggleElement.style.boxShadow = '0 0 20px rgba(17, 153, 142, 0.6)';
                            setTimeout(() => {
                                toggleElement.style.boxShadow = '';
                            }, 1000);
                        }
                    }, 100);
                }
                saveSettings() {
                    this.audio.play('ui-click');
                    this.showSaveConfirmation();
                    setTimeout(() => {
                        this.closeModal();
                    }, 1500);
                }
                resetSettings() {
                    const confirmed = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ');
                    if (confirmed) {
                        this.audio.resetSettings();
                        this.loadSettings();
                        this.audio.play('ui-click');
                        this.showResetConfirmation();
                    }
                }
                showSaveConfirmation() {
                    const saveBtn = this.elements.saveBtn;
                    const originalText = saveBtn?.innerHTML;
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸';
                        saveBtn.style.background = 'var(--success-gradient)';
                        saveBtn.disabled = true;
                        setTimeout(() => {
                            saveBtn.innerHTML = originalText;
                            saveBtn.style.background = '';
                            saveBtn.disabled = false;
                        }, 1500);
                    }
                }
                showResetConfirmation() {
                    const resetBtn = this.elements.resetBtn;
                    const originalText = resetBtn?.innerHTML;
                    if (resetBtn) {
                        resetBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†';
                        resetBtn.style.background = 'var(--warning-gradient)';
                        resetBtn.disabled = true;
                        setTimeout(() => {
                            resetBtn.innerHTML = originalText;
                            resetBtn.style.background = '';
                            resetBtn.disabled = false;
                        }, 1500);
                    }
                }
            }

            class ToolbarManager {
                constructor(audioManager) {
                    this.audio = audioManager;
                    this.isFullscreen = false;
                    this.soundSettings = new SoundSettingsManager(audioManager);
                    this.initElements();
                    this.setupEvents();
                    this.setupFullscreenListener();
                }
                initElements() {
                    this.elements = {
                        gameLogo: document.getElementById('gameLogo'),
                        homeIcon: document.getElementById('homeIcon'),
                        soundIcon: document.getElementById('soundIcon'),
                        settingsIcon: document.getElementById('settingsIcon'),
                        guideIcon: document.getElementById('guideIcon'),
                        fullscreenIcon: document.getElementById('fullscreenIcon')
                    };
                }
                setupEvents() {
                    this.elements.homeIcon?.addEventListener('click', () => { this.handleHomeClick(); });
                    this.elements.soundIcon?.addEventListener('click', () => { this.handleSoundToggle(); });
                    this.elements.settingsIcon?.addEventListener('click', () => { this.handleSettingsClick(); });
                    this.elements.guideIcon?.addEventListener('click', () => { this.handleGuideClick(); });
                    this.elements.fullscreenIcon?.addEventListener('click', () => { this.handleFullscreenToggle(); });
                    this.elements.gameLogo?.addEventListener('click', () => { this.handleLogoClick(); });
                    Object.values(this.elements).forEach(element => {
                        element?.addEventListener('mouseenter', () => {
                            this.audio.play('ui-hover', { volume: 0.3 });
                        });
                    });
                }
                handleSettingsClick() {
                    this.audio.play('toolbar-click');
                    this.animateClick(this.elements.settingsIcon);
                    this.soundSettings.openModal();
                }
                handleGuideClick() {
                    this.audio.play('cosmic-click');
                    this.animateClick(this.elements.guideIcon);
                    alert('Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…: Ø³Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ©\n\n- Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†\n- Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø¨Ø§Ù‚ ÙˆØ§Ø·Ø±Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©\n- Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª\n- Ø£ÙˆÙ„ Ù…ØªØ³Ø§Ø¨Ù‚ ÙŠØµÙ„ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠÙÙˆØ²!');
                }
                handleHomeClick() {
                    this.audio.play('home-click');
                    this.animateClick(this.elements.homeIcon);
                    const confirmed = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ\nØ³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©.');
                    if (confirmed) {
                        document.body.style.transition = 'opacity 0.5s ease';
                        document.body.style.opacity = '0';
                        setTimeout(() => {
                            window.location.href = '../main.html';
                        }, 500);
                    }
                }
                handleSoundToggle() {
                    const isEnabled = this.audio.toggle();
                    this.updateSoundIcon(isEnabled);
                    if (isEnabled) {
                        this.audio.play('sound-toggle');
                    }
                    this.animateClick(this.elements.soundIcon);
                    this.showNotification(isEnabled ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š' : 'ØªÙ… ÙƒØªÙ… Ø§Ù„ØµÙˆØª ğŸ”‡');
                }
                handleFullscreenToggle() {
                    this.audio.play('fullscreen-toggle');
                    this.animateClick(this.elements.fullscreenIcon);
                    if (!this.isFullscreen) {
                        this.enterFullscreen();
                    } else {
                        this.exitFullscreen();
                    }
                }
                handleLogoClick() {
                    this.audio.play('toolbar-click');
                    this.elements.gameLogo.style.transform = 'scale(1.1) rotate(360deg)';
                    setTimeout(() => {
                        this.elements.gameLogo.style.transform = '';
                    }, 600);
                    this.showGameInfo();
                }
                updateSoundIcon(isEnabled) {
                    const icon = this.elements.soundIcon.querySelector('i');
                    const element = this.elements.soundIcon;
                    if (isEnabled) {
                        icon.className = 'fas fa-volume-up';
                        element.classList.remove('muted');
                        element.setAttribute('data-tooltip', 'ÙƒØªÙ… Ø§Ù„ØµÙˆØª');
                    } else {
                        icon.className = 'fas fa-volume-mute';
                        element.classList.add('muted');
                        element.setAttribute('data-tooltip', 'ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª');
                    }
                }
                updateFullscreenIcon() {
                    const icon = this.elements.fullscreenIcon.querySelector('i');
                    const element = this.elements.fullscreenIcon;
                    if (this.isFullscreen) {
                        icon.className = 'fas fa-compress';
                        element.setAttribute('data-tooltip', 'Ø¥ØºÙ„Ø§Ù‚ Ù…Ù„Ø¦ Ø§Ù„Ø´Ø§Ø´Ø©');
                    } else {
                        icon.className = 'fas fa-expand';
                        element.setAttribute('data-tooltip', 'Ù…Ù„Ø¦ Ø§Ù„Ø´Ø§Ø´Ø©');
                    }
                }
                enterFullscreen() {
                    try {
                        const element = document.documentElement;
                        if (element.requestFullscreen) {
                            element.requestFullscreen();
                        } else if (element.webkitRequestFullscreen) {
                            element.webkitRequestFullscreen();
                        } else if (element.msRequestFullscreen) {
                            element.msRequestFullscreen();
                        }
                    } catch (error) {
                        console.log('Fullscreen not supported');
                        this.showNotification('Ù…Ù„Ø¦ Ø§Ù„Ø´Ø§Ø´Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
                    }
                }
                exitFullscreen() {
                    try {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        }
                    } catch (error) {
                        console.log('Exit fullscreen error');
                    }
                }
                setupFullscreenListener() {
                    const fullscreenEvents = [
                        'fullscreenchange',
                        'webkitfullscreenchange',
                        'mozfullscreenchange',
                        'MSFullscreenChange'
                    ];
                    fullscreenEvents.forEach(eventName => {
                        document.addEventListener(eventName, () => {
                            this.isFullscreen = !!(
                                document.fullscreenElement ||
                                document.webkitFullscreenElement ||
                                document.mozFullScreenElement ||
                                document.msFullscreenElement
                            );
                            this.updateFullscreenIcon();
                        });
                    });
                }
                animateClick(element) {
                    element.style.transform = 'scale(0.95)';
                    element.style.transition = 'transform 0.1s ease';
                    setTimeout(() => {
                        element.style.transform = '';
                        setTimeout(() => {
                            element.style.transition = '';
                        }, 200);
                    }, 100);
                }
                showNotification(message) {
                    const notification = document.createElement('div');
                    notification.className = 'toolbar-notification';
                    notification.textContent = message;
                    notification.style.cssText = `
                        position: fixed;
                        top: 90px;
                        right: 30px;
                        background: linear-gradient(135deg, rgba(0, 245, 255, 0.9) 0%, rgba(255, 7, 58, 0.9) 100%);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 25px;
                        font-weight: 600;
                        font-size: 1rem;
                        z-index: 10001;
                        transform: translateX(300px);
                        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                    `;
                    document.body.appendChild(notification);
                    setTimeout(() => {
                        notification.style.transform = 'translateX(0)';
                    }, 100);
                    setTimeout(() => {
                        notification.style.transform = 'translateX(300px)';
                        setTimeout(() => {
                            notification.remove();
                        }, 300);
                    }, 3000);
                }
                showGameInfo() {
                    const info = `\nğŸ Ø³Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ© - Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙ†Ø§ÙØ³ÙŠØ© Ø¹ØµØ±ÙŠØ© ğŸ\n\nğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø©: Ø³Ø¨Ø§Ù‚ Ù…Ø¹Ø±ÙØ© ØªÙØ§Ø¹Ù„ÙŠ\nğŸ¯ Ø§Ù„Ù‡Ø¯Ù: Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© ÙˆØ§Ù„ÙÙˆØ²\nğŸ… Ù†Ø¸Ø§Ù… ØªÙ†Ø§ÙØ³ÙŠ\nğŸ® Ø§Ù„ØªØ­ÙƒÙ…: Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ©\n\nğŸ”§ Ø§Ù„Ù…Ø·ÙˆØ±: Ù†Ø¸Ø§Ù… ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…ØªÙ‚Ø¯Ù…\nğŸ“… Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 2025`;
                    alert(info);
                }
            }

            // Initialize toolbar and sound system after DOMContentLoaded
            document.addEventListener('DOMContentLoaded', () => {
                window.audioManager = new AudioManager();
                window.toolbarManager = new ToolbarManager(window.audioManager);
                // Set initial sound icon state
                setTimeout(() => {
                    window.toolbarManager.updateSoundIcon(window.audioManager.isEnabled());
                }, 500);
            });
document.addEventListener('DOMContentLoaded', () => {

    window.responsiveHelper = new ResponsiveHelper();
    loadStudentsData();
});

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ù…Ù„Ù JSON
let studentsData = {};
async function loadStudentsData() {
    try {
        const response = await fetch('../data/studentData.json');
        if (response.ok) {
            studentsData = await response.json();
            populateClassSelect();
            showSmartMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
        } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    } catch (error) {
        console.log('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨:', error);
        studentsData = {};
        showSmartMessage('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨!');
    }
}

function populateClassSelect() {
    classSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>';
    Object.keys(studentsData).forEach(className => {
        const opt = document.createElement('option');
        opt.value = className;
        opt.textContent = className;
        classSelect.appendChild(opt);
    });
}

// Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ (ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹)
let selectedClass = null;
let selectedCompetitors = [];
let selectionMode = null; // 'random' or 'manual'

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
const classSelect = document.getElementById('classSelect');
const studentsSection = document.getElementById('studentsSection');
const randomSelectBtn = document.getElementById('randomSelectBtn');
const manualSelectBtn = document.getElementById('manualSelectBtn');
const manualStudentsList = document.getElementById('manualStudentsList');
const confirmCompetitorsBtn = document.getElementById('confirmCompetitorsBtn');
const teamsRow = document.getElementById('teamsRow');
const arenaControls = document.getElementById('arenaControls');
const homeBtn = document.getElementById('homeBtn');
const infoBtn = document.getElementById('infoBtn');
const instructionsModal = document.getElementById('instructionsModal');

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ


classSelect.addEventListener('change', () => {
    selectedClass = classSelect.value;
    if (selectedClass) {
        studentsSection.style.display = '';
        selectionMode = null;
        selectedCompetitors = [];
        manualStudentsList.style.display = 'none';
        confirmCompetitorsBtn.style.display = 'none';
    } else {
        studentsSection.style.display = 'none';
    }
});

randomSelectBtn.addEventListener('click', () => {
    selectionMode = 'random';
    manualStudentsList.style.display = 'none';
    confirmCompetitorsBtn.style.display = '';
    const classStudents = (studentsData[selectedClass] || []).map((name, idx) => ({ id: 'stu'+idx, name, classId: selectedClass }));
    const n = Math.min(4, classStudents.length);
    selectedCompetitors = shuffle(classStudents).slice(0, n);
});

manualSelectBtn.addEventListener('click', () => {
    selectionMode = 'manual';
    manualStudentsList.style.display = '';
    confirmCompetitorsBtn.style.display = '';
    renderManualStudentsList();
});

function renderManualStudentsList() {
    manualStudentsList.innerHTML = '';
    const classStudents = (studentsData[selectedClass] || []).map((name, idx) => ({ id: 'stu'+idx, name, classId: selectedClass }));
    classStudents.forEach(stu => {
        const div = document.createElement('div');
        div.className = 'student-checkbox';
        div.innerHTML = `<input type="checkbox" value="${stu.id}" id="stu_${stu.id}"> <label for="stu_${stu.id}">${stu.name}</label>`;
        manualStudentsList.appendChild(div);
    });
}

confirmCompetitorsBtn.addEventListener('click', () => {
    if (selectionMode === 'manual') {
        const classStudents = (studentsData[selectedClass] || []).map((name, idx) => ({ id: 'stu'+idx, name, classId: selectedClass }));
        const checked = manualStudentsList.querySelectorAll('input[type=checkbox]:checked');
        if (checked.length < 2) {
            showSmartMessage('Ø§Ø®ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†!');
            return;
        }
        selectedCompetitors = Array.from(checked).map(chk => {
            return classStudents.find(s => s.id == chk.value);
        });
    }
    if (selectedCompetitors.length < 2) {
        showSmartMessage('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ØªÙ†Ø§ÙØ³ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!');
        return;
    }
    document.getElementById('setupSection').style.display = 'none';
    teamsRow.style.display = '';
    arenaControls.style.display = '';
    renderCompetitorsArena();
    showSmartMessage('Ø§Ø³ØªØ¹Ø¯ÙˆØ§ Ù„Ù„Ø³Ø¨Ø§Ù‚!');
});

function renderCompetitorsArena() {
    teamsRow.innerHTML = '';
    selectedCompetitors.forEach((stu, idx) => {
        const card = document.createElement('div');
        card.className = 'team-card';
        card.innerHTML = `
            <div class="team-name">${stu.name}</div>
            <div class="team-progress"><div class="team-progress-bar" id="progress_${stu.id}" style="width:0%"></div></div>
            <div class="team-score" id="score_${stu.id}">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
            <div class="team-icon"><i class="fas fa-rocket"></i></div>
        `;
        teamsRow.appendChild(card);
    });
}

function showSmartMessage(msg) {
    let el = document.getElementById('smartMsg');
    if (!el) {
        el = document.createElement('div');
        el.id = 'smartMsg';
        el.style.position = 'fixed';
        el.style.top = '32px';
        el.style.left = '50%';
        el.style.transform = 'translateX(-50%)';
        el.style.background = 'rgba(255,255,255,0.95)';
        el.style.color = 'var(--accent-gold)';
        el.style.fontWeight = 'bold';
        el.style.fontSize = '1.3rem';
        el.style.padding = '16px 32px';
        el.style.borderRadius = '18px';
        el.style.boxShadow = '0 4px 24px 0 #0002';
        el.style.zIndex = 9999;
        document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.display = '';
    setTimeout(() => { el.style.display = 'none'; }, 2000);
}

function shuffle(arr) {
    return arr.map(a => [Math.random(), a]).sort().map(a => a[1]);
}

// Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø¨Ø§Ù‚
let raceActive = false;
let racePaused = false;
let scores = {};
let progress = {};
let stats = {};
const raceDistance = 10;
const startRaceBtn = document.getElementById('startRaceBtn');
const nextQuestionBtn = document.getElementById('nextQuestionBtn');
const correctBtn = document.getElementById('correctBtn');
const wrongBtn = document.getElementById('wrongBtn');
const pauseBtn = document.getElementById('pauseBtn');
let currentTurn = 0;

function setArenaControlsState(state) {
    // state: 'setup', 'active', 'paused', 'finished'
    if (state === 'setup') {
        startRaceBtn.disabled = false;
        nextQuestionBtn.disabled = true;
        correctBtn.disabled = true;
        wrongBtn.disabled = true;
        pauseBtn.disabled = true;
        pauseBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
    } else if (state === 'active') {
        startRaceBtn.disabled = true;
        nextQuestionBtn.disabled = false;
        correctBtn.disabled = false;
        wrongBtn.disabled = false;
        pauseBtn.disabled = false;
        pauseBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
    } else if (state === 'paused') {
        startRaceBtn.disabled = true;
        nextQuestionBtn.disabled = true;
        correctBtn.disabled = true;
        wrongBtn.disabled = true;
        pauseBtn.disabled = false;
        pauseBtn.textContent = 'Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø³Ø¨Ø§Ù‚';
    } else if (state === 'finished') {
        startRaceBtn.disabled = true;
        nextQuestionBtn.disabled = true;
        correctBtn.disabled = true;
        wrongBtn.disabled = true;
        pauseBtn.disabled = true;
        pauseBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
    }
}

startRaceBtn.addEventListener('click', () => {
    if (raceActive) return;
    raceActive = true;
    racePaused = false;
    scores = {};
    progress = {};
    stats = {};
    selectedCompetitors.forEach(stu => {
        scores[stu.id] = 0;
        progress[stu.id] = 0;
        stats[stu.id] = { correct: 0, wrong: 0 };
        document.getElementById('progress_' + stu.id).style.width = '0%';
        document.getElementById('score_' + stu.id).textContent = 'Ø§Ù„Ù†Ù‚Ø§Ø·: 0';
        document.querySelectorAll('.team-card').forEach(card => card.classList.remove('winner'));
    });
    currentTurn = 0;
    showStatsPanel();
    showSmartMessage('Ø§Ù†Ø·Ù„Ù‚ Ø§Ù„Ø³Ø¨Ø§Ù‚!');
    playSound('start');
    highlightCurrent();
    setArenaControlsState('active');
});

pauseBtn.addEventListener('click', () => {
    if (!raceActive) return;
    racePaused = !racePaused;
    if (racePaused) {
        setArenaControlsState('paused');
        showSmartMessage('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ø¤Ù‚ØªØ§Ù‹');
    } else {
        setArenaControlsState('active');
        showSmartMessage('Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø³Ø¨Ø§Ù‚!');
    }
});

nextQuestionBtn.addEventListener('click', () => {
    if (!raceActive || racePaused) return;
    currentTurn = (currentTurn + 1) % selectedCompetitors.length;
    highlightCurrent();
    showSmartMessage(randomEncourage());
});

correctBtn.addEventListener('click', () => {
    if (!raceActive || racePaused) return;
    const stu = selectedCompetitors[currentTurn];
    scores[stu.id] += 1;
    stats[stu.id].correct += 1;
    updateProgress(stu.id);
    playSound('correct');
    showSmartMessage('Ø£Ø­Ø³Ù†Øª ÙŠØ§ ' + stu.name + '!');
    updateStatsPanel();
    animateCard(stu.id, 'success');
    if (scores[stu.id] >= raceDistance) {
        finishRace(stu);
    } else {
        nextQuestionBtn.click();
    }
});

wrongBtn.addEventListener('click', () => {
    if (!raceActive || racePaused) return;
    const stu = selectedCompetitors[currentTurn];
    stats[stu.id].wrong += 1;
    playSound('wrong');
    showSmartMessage('Ø­Ø¸Ø§Ù‹ Ø£ÙˆÙØ± ÙŠØ§ ' + stu.name + '!');
    updateStatsPanel();
    animateCard(stu.id, 'fail');
    nextQuestionBtn.click();
});

function updateProgress(stuId) {
    const percent = Math.min(100, (scores[stuId] / raceDistance) * 100);
    document.getElementById('progress_' + stuId).style.width = percent + '%';
    document.getElementById('score_' + stuId).textContent = 'Ø§Ù„Ù†Ù‚Ø§Ø·: ' + scores[stuId];
    animateRocket(stuId, percent);
}

function highlightCurrent() {
    document.querySelectorAll('.team-card').forEach(card => card.classList.remove('active-turn'));
    const stu = selectedCompetitors[currentTurn];
    const card = Array.from(document.querySelectorAll('.team-card')).find(c => c.querySelector('.team-name').textContent === stu.name);
    if (card) card.classList.add('active-turn');
}

function finishRace(winner) {
    raceActive = false;
    setArenaControlsState('finished');
    showSmartMessage('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø²: ' + winner.name + ' ğŸ‰');
    playSound('win');
    confettiEffect();
    // ØªÙ…ÙŠÙŠØ² Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ§Ø¦Ø²
    const card = Array.from(document.querySelectorAll('.team-card')).find(c => c.querySelector('.team-name').textContent === winner.name);
    if (card) card.classList.add('winner');
    showHonorBoard();
}
// Ù…Ø¤Ø«Ø±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
function animateCard(stuId, type) {
    const card = Array.from(document.querySelectorAll('.team-card')).find(c => c.querySelector('.team-name').textContent === (students.find(s=>s.id===stuId)?.name));
    if (!card) return;
    if (type === 'success') {
        card.style.boxShadow = '0 0 32px 8px #28a74599';
        card.style.transform = 'scale(1.05)';
        setTimeout(()=>{card.style.boxShadow='';card.style.transform='';}, 600);
    } else if (type === 'fail') {
        card.style.boxShadow = '0 0 32px 8px #dc143c99';
        card.style.transform = 'scale(0.97)';
        setTimeout(()=>{card.style.boxShadow='';card.style.transform='';}, 600);
    }
}

function showStatsPanel() {
    let panel = document.getElementById('statsPanel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'statsPanel';
        panel.style.position = 'fixed';
        panel.style.bottom = '24px';
        panel.style.left = '24px';
        panel.style.background = 'rgba(255,255,255,0.92)';
        panel.style.color = 'var(--oman-red)';
        panel.style.borderRadius = '18px';
        panel.style.boxShadow = '0 4px 24px #FFD70033';
        panel.style.padding = '18px 28px';
        panel.style.fontSize = '1.1rem';
        panel.style.zIndex = 1000;
        document.body.appendChild(panel);
    }
    updateStatsPanel();
}

function updateStatsPanel() {
    const panel = document.getElementById('statsPanel');
    if (!panel) return;
    let html = '<b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</b><br><table style="margin-top:8px;font-size:1rem;min-width:180px;">';
    html += '<tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>ØµØ­ÙŠØ­</th><th>Ø®Ø·Ø£</th></tr>';
    selectedCompetitors.forEach(stu => {
        html += `<tr><td>${stu.name}</td><td style="color:green">${stats[stu.id]?.correct||0}</td><td style="color:#b00">${stats[stu.id]?.wrong||0}</td></tr>`;
    });
    html += '</table>';
    panel.innerHTML = html;
}

function showHonorBoard() {
    let board = document.getElementById('honorBoard');
    if (board) board.remove();
    board = document.createElement('div');
    board.id = 'honorBoard';
    board.style.position = 'fixed';
    board.style.top = '50%';
    board.style.left = '50%';
    board.style.transform = 'translate(-50%,-50%)';
    board.style.background = 'linear-gradient(135deg,#fffbe6 60%,#ffe7b2 100%)';
    board.style.color = '#b8860b';
    board.style.border = '4px solid #FFD700';
    board.style.borderRadius = '32px';
    board.style.boxShadow = '0 8px 48px #FFD70055';
    board.style.padding = '38px 48px 32px 48px';
    board.style.textAlign = 'center';
    board.style.zIndex = 2000;
    board.innerHTML = `<h2 style="font-size:2.2rem;margin-bottom:18px;">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h2>`;
    const sorted = [...selectedCompetitors].sort((a,b)=>scores[b.id]-scores[a.id]);
    sorted.forEach((stu,idx)=>{
        board.innerHTML += `<div style="font-size:1.3rem;margin:10px 0;"><b>${idx+1}. ${stu.name}</b> <span style="color:green">(${scores[stu.id]} Ù†Ù‚Ø·Ø©)</span></div>`;
    });
    board.innerHTML += `<div style="margin-top:22px;"><button onclick="document.getElementById('honorBoard').remove()" style="background:var(--accent-gold);color:#fff;font-size:1.1rem;padding:10px 28px;border:none;border-radius:12px;box-shadow:0 2px 8px #FFD70033;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button></div>`;
    document.body.appendChild(board);
    confettiEffect();
}

function randomEncourage() {
    const msgs = [
        'Ù…Ù†Ø§ÙØ³Ø© Ù…Ø´ØªØ¹Ù„Ø©!','Ù…Ù† ÙŠØªÙ‚Ø¯Ù…ØŸ','Ù…Ù† Ø³ÙŠÙÙˆØ²ØŸ','Ø´Ø¯ÙˆØ§ Ø§Ù„Ù‡Ù…Ø©!','Ø£Ø¬ÙˆØ§Ø¡ Ø­Ù…Ø§Ø³ÙŠØ©!','Ø§Ù„Ø³Ø¨Ø§Ù‚ ÙŠØ²Ø¯Ø§Ø¯ Ø¥Ø«Ø§Ø±Ø©!','Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆÙ‰ Ø§Ù„ÙŠÙˆÙ…ØŸ','Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù„ÙÙˆØ²ØŸ'
    ];
    return msgs[Math.floor(Math.random() * msgs.length)];
}

function playSound(type) {
    const sounds = {
        start: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b6.mp3',
        correct: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b7.mp3',
        wrong: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b8.mp3',
        win: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b9.mp3',
        click: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b5.mp3'
    };
    if (sounds[type]) {
        const audio = new Audio(sounds[type]);
        audio.play();
    }
}
[startRaceBtn, nextQuestionBtn, correctBtn, wrongBtn, pauseBtn].forEach(btn => {
    btn.addEventListener('click', () => playSound('click'));
});

function confettiEffect() {
    if (window.confetti) {
        confetti({
            particleCount: 200,
            spread: 90,
            origin: { y: 0.6 }
        });
    }
}
function animateRocket(stuId, percent) {
    const bar = document.getElementById('progress_' + stuId);
    const icon = bar.parentElement.parentElement.querySelector('.team-icon');
    icon.style.transform = `translateX(${percent}%) scale(1.2)`;
    setTimeout(() => { icon.style.transform = 'translateX(0) scale(1)'; }, 700);
}
// ØªØ¹Ù„ÙŠÙ…Ø§Øª
infoBtn.onclick = () => instructionsModal.removeAttribute('hidden');
homeBtn.onclick = () => {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡
    document.getElementById('setupSection').style.display = '';
    document.getElementById('teamsRow').style.display = 'none';
    document.getElementById('arenaControls').style.display = 'none';
    if (document.getElementById('statsPanel')) document.getElementById('statsPanel').remove();
    if (document.getElementById('honorBoard')) document.getElementById('honorBoard').remove();
    selectedClass = null;
    selectedCompetitors = [];
    selectionMode = null;
    classSelect.value = '';
    studentsSection.style.display = 'none';
    setArenaControlsState('setup');
};
// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø²Ø± Esc
window.addEventListener('keydown',e=>{if(e.key==='Escape'){instructionsModal.setAttribute('hidden','')}});
// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
setArenaControlsState('setup');
    </script>
</html>
