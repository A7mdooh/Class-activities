<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ Ø³Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¹ØµØ±ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --oman-red: #DC143C;
            --oman-green: #228B22;
            --oman-white: #fff;
            --accent-gold: #FFD700;
            --gradient-danger: linear-gradient(90deg, #DC143C 0%, #FFD700 100%);
            --gradient-safe: linear-gradient(90deg, #228B22 0%, #FFD700 100%);
            --gradient-warning: linear-gradient(90deg, #FFD700 0%, #DC143C 100%);
            --gradient-gold: linear-gradient(90deg, #FFD700 0%, #fff 100%);
            --gradient-dark: linear-gradient(135deg, #181a23 0%, #23243a 100%);
            --gradient-background: radial-gradient(ellipse at 70% 0%, #23243a 0%, #181a23 100%);
            --glass: rgba(255,255,255,0.08);
            --shadow: 0 4px 24px #0006;
            --glow-gold: 0 0 16px #FFD70099;
            --glow-red: 0 0 16px #DC143C99;
            --glow-green: 0 0 16px #228B2299;
            --info-card-border: 2px solid var(--accent-gold);
            --info-card-shadow: 0 2px 8px #FFD70033;
        }
        html, body {
            height: 100%;
            font-family: 'Cairo', system-ui, sans-serif;
            background: var(--gradient-background);
            color: var(--oman-white);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background: radial-gradient(circle at 80% 10%, #FFD70022 0, transparent 60%),
                        radial-gradient(circle at 20% 90%, #DC143C22 0, transparent 60%),
                        radial-gradient(circle at 50% 50%, #228B2222 0, transparent 70%);
            animation: bgMove 12s linear infinite alternate;
        }
        @keyframes bgMove {
            0% { background-position: 80% 10%, 20% 90%, 50% 50%; }
            100% { background-position: 70% 20%, 30% 80%, 60% 60%; }
        }
        .top-toolbar {
            position: fixed; top: 0; left: 0; right: 0; height: 68px;
            background: var(--gradient-dark);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 100;
            box-shadow: 0 2px 16px #0002;
            padding: 0 32px;
        }
        .toolbar-btn {
            background: var(--glass);
            border: none;
            color: var(--accent-gold);
            font-size: 1.3rem;
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 6px;
            cursor: pointer;
            box-shadow: 0 2px 8px #FFD70033;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .toolbar-btn:hover {
            background: var(--accent-gold);
            color: #fff;
            box-shadow: 0 4px 16px #FFD70055;
        }
        .header {
            margin-top: 90px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.3rem;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: var(--glow-gold);
        }
        .header p {
            font-size: 1.2rem;
            color: #fff;
            margin-top: 8px;
        }
        .arena {
            margin: 32px auto 0 auto;
            max-width: 900px;
            padding: 0 12px;
        }
        .teams-row {
            display: flex;
            gap: 18px;
            justify-content: center;
            margin-bottom: 32px;
        }
        .team-card {
            background: var(--glass);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 24px 18px 18px 18px;
            min-width: 180px;
            text-align: center;
            border: 2.5px solid #FFD70055;
            position: relative;
            transition: box-shadow 0.3s, border 0.3s;
        }
        .team-card.active-turn {
            border: 3.5px solid var(--accent-gold);
            box-shadow: 0 0 24px #FFD70099;
        }
        .team-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }
        .team-progress {
            background: #fff2;
            border-radius: 12px;
            height: 18px;
            margin: 10px 0 8px 0;
            overflow: hidden;
            position: relative;
        }
        .team-progress-bar {
            background: var(--gradient-gold);
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s cubic-bezier(.4,0,.2,1);
        }
        .team-score {
            color: var(--oman-green);
            font-weight: bold;
            margin-top: 6px;
        }
        .team-icon {
            font-size: 1.7rem;
            color: var(--accent-gold);
            margin-top: 10px;
            transition: transform 0.5s cubic-bezier(.4,0,.2,1);
        }
        .arena-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 18px;
        }
        .arena-btn {
            background: var(--accent-gold);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 10px 24px;
            box-shadow: 0 2px 8px #FFD70033;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .arena-btn:hover {
            background: #fff;
            color: var(--accent-gold);
            box-shadow: 0 4px 16px #FFD70055;
        }
        .modal-overlay {
            position: fixed; inset: 0; background: #181a23cc; z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s; backdrop-filter: blur(8px);
        }
        .modal-overlay[hidden] { display: none !important; }
        .modal-content {
            background: var(--glass);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 36px 32px 28px 32px;
            min-width: 320px; max-width: 95vw;
            color: var(--accent-gold);
            border: 2px solid #FFD70055;
            text-align: center;
            font-size: 1.15rem;
            position: relative;
            animation: modalPop 0.5s cubic-bezier(.4,0,.2,1);
        }
        @keyframes modalPop {
            0% { transform: scale(0.8) translateY(40px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .modal-content h2 {
            color: var(--accent-gold);
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 18px;
            text-shadow: var(--glow-gold);
        }
        .modal-content ul {
            text-align: right;
            margin: 0 0 18px 0;
            padding: 0 18px;
            color: var(--oman-white);
            font-size: 1.05rem;
        }
        .modal-content button {
            margin-top: 18px;
        }
        #statsPanel, #honorBoard {
            font-family: 'Cairo', system-ui, sans-serif;
        }
    </style>
</head>
<body>
    <nav class="top-toolbar">
        <button class="toolbar-btn" id="homeBtn" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><i class="fas fa-home"></i></button>
        <div style="font-size:1.3rem;font-weight:bold;color:var(--accent-gold);">Ø³Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ©</div>
        <button class="toolbar-btn" id="infoBtn" title="ØªØ¹Ù„ÙŠÙ…Ø§Øª"><i class="fas fa-info-circle"></i></button>
    </nav>
    <header class="header">
        <h1>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙØ©</h1>
        <p>Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ† ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø¨Ø§Ù‚!</p>
    </header>
    <section class="arena" id="arena">
        <div id="setupSection" style="width:100%;max-width:500px;margin:0 auto 32px auto;">
            <div style="margin-bottom:18px;">
                <label for="classSelect" style="font-weight:bold;font-size:1.1rem;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ:</label>
                <select id="classSelect" style="width:100%;padding:10px 12px;border-radius:12px;border:1.5px solid var(--accent-gold);background:var(--glass);color:var(--accent-gold);font-size:1.1rem;outline:none;margin-top:8px;">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
                </select>
            </div>
            <div id="studentsSection" style="display:none;">
                <label style="font-weight:bold;font-size:1.1rem;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†:</label>
                <div style="display:flex;gap:12px;margin:12px 0;">
                    <button class="arena-btn" id="randomSelectBtn" style="flex:1;">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
                    <button class="arena-btn" id="manualSelectBtn" style="flex:1;">Ø§Ù†ØªÙ‚Ø§Ø¦ÙŠ</button>
                </div>
                <div id="manualStudentsList" style="display:none;"></div>
                <button class="arena-btn" id="confirmCompetitorsBtn" style="width:100%;margin-top:12px;display:none;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†</button>
            </div>
        </div>
        <div class="teams-row" id="teamsRow" style="display:none;"></div>
        <div class="arena-controls" id="arenaControls" style="display:none;">
            <button class="arena-btn" id="startRaceBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
            <button class="arena-btn" id="nextQuestionBtn">Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
            <button class="arena-btn" id="correctBtn">Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</button>
            <button class="arena-btn" id="wrongBtn">Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©</button>
            <button class="arena-btn" id="pauseBtn">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
        </div>
    </section>
    <div class="modal-overlay" id="instructionsModal" hidden>
        <div class="modal-content">
            <button class="modal-close" onclick="this.closest('.modal-overlay').setAttribute('hidden','')" title="Ø¥ØºÙ„Ø§Ù‚"><i class="fas fa-times"></i></button>
            <h2>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            <ul>
                <li>Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø«Ù… Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ† (Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø£Ùˆ Ø§Ù†ØªÙ‚Ø§Ø¦ÙŠ).</li>
                <li>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø¨Ø§Ù‚ ÙˆØ§Ø·Ø±Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ† Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹.</li>
                <li>Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª.</li>
                <li>Ø£ÙˆÙ„ Ù…ØªØ³Ø§Ø¨Ù‚ ÙŠØµÙ„ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠÙÙˆØ²!</li>
            </ul>
            <button onclick="this.closest('.modal-overlay').setAttribute('hidden','')" class="arena-btn">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
    <script>
        // ResponsiveHelper (ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨)
class ResponsiveHelper {
    constructor() {
        this.breakpoints = { mobile: 576, tablet: 768, desktop: 992, large: 1200 };
        this.currentDevice = this.detectDevice();
        this.orientation = this.getOrientation();
        this.init();
    }
    init() {
        window.addEventListener('resize', this.debounce(() => { this.handleResize(); }, 250));
        window.addEventListener('orientationchange', () => { setTimeout(() => { this.handleOrientationChange(); }, 100); });
    }
    detectDevice() {
        const width = window.innerWidth;
        if (width < this.breakpoints.mobile) return 'small-mobile';
        if (width < this.breakpoints.tablet) return 'mobile';
        if (width < this.breakpoints.desktop) return 'tablet';
        if (width < this.breakpoints.large) return 'desktop';
        return 'large-desktop';
    }
    getOrientation() { return window.innerHeight > window.innerWidth ? 'portrait' : 'landscape'; }
    isMobile() { return ['small-mobile', 'mobile'].includes(this.currentDevice); }
    isTablet() { return this.currentDevice === 'tablet'; }
    isTouchDevice() { return 'ontouchstart' in window || navigator.maxTouchPoints > 0; }
    handleResize() {
        const newDevice = this.detectDevice();
        const newOrientation = this.getOrientation();
        if (newDevice !== this.currentDevice) { this.currentDevice = newDevice; }
        if (newOrientation !== this.orientation) { this.orientation = newOrientation; }
    }
    handleOrientationChange() { this.orientation = this.getOrientation(); }
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}
document.addEventListener('DOMContentLoaded', () => {
    window.responsiveHelper = new ResponsiveHelper();
});

// Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ (ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹)
const classes = [
    { id: '1', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³' },
    { id: '2', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³' },
    { id: '3', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹' }
];
const students = [
    { id: 'a', name: 'Ø£Ø­Ù…Ø¯', classId: '1' },
    { id: 'b', name: 'Ø³Ø§Ø±Ø©', classId: '1' },
    { id: 'c', name: 'Ù…Ø­Ù…Ø¯', classId: '1' },
    { id: 'd', name: 'Ù†ÙˆØ±Ø©', classId: '2' },
    { id: 'e', name: 'Ø®Ø§Ù„Ø¯', classId: '2' },
    { id: 'f', name: 'Ù…Ù‡Ø§', classId: '2' },
    { id: 'g', name: 'Ø³Ù„Ù…Ø§Ù†', classId: '3' },
    { id: 'h', name: 'Ø±ÙŠÙ…', classId: '3' },
    { id: 'i', name: 'ÙŠÙˆØ³Ù', classId: '3' }
];
let selectedClass = null;
let selectedCompetitors = [];
let selectionMode = null; // 'random' or 'manual'

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
const classSelect = document.getElementById('classSelect');
const studentsSection = document.getElementById('studentsSection');
const randomSelectBtn = document.getElementById('randomSelectBtn');
const manualSelectBtn = document.getElementById('manualSelectBtn');
const manualStudentsList = document.getElementById('manualStudentsList');
const confirmCompetitorsBtn = document.getElementById('confirmCompetitorsBtn');
const teamsRow = document.getElementById('teamsRow');
const arenaControls = document.getElementById('arenaControls');
const homeBtn = document.getElementById('homeBtn');
const infoBtn = document.getElementById('infoBtn');
const instructionsModal = document.getElementById('instructionsModal');

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ
classes.forEach(cls => {
    const opt = document.createElement('option');
    opt.value = cls.id;
    opt.textContent = cls.name;
    classSelect.appendChild(opt);
});

classSelect.addEventListener('change', () => {
    selectedClass = classSelect.value;
    if (selectedClass) {
        studentsSection.style.display = '';
        selectionMode = null;
        selectedCompetitors = [];
        manualStudentsList.style.display = 'none';
        confirmCompetitorsBtn.style.display = 'none';
    } else {
        studentsSection.style.display = 'none';
    }
});

randomSelectBtn.addEventListener('click', () => {
    selectionMode = 'random';
    manualStudentsList.style.display = 'none';
    confirmCompetitorsBtn.style.display = '';
    const classStudents = students.filter(s => s.classId == selectedClass);
    const n = Math.min(4, classStudents.length);
    selectedCompetitors = shuffle(classStudents).slice(0, n);
});

manualSelectBtn.addEventListener('click', () => {
    selectionMode = 'manual';
    manualStudentsList.style.display = '';
    confirmCompetitorsBtn.style.display = '';
    renderManualStudentsList();
});

function renderManualStudentsList() {
    manualStudentsList.innerHTML = '';
    const classStudents = students.filter(s => s.classId == selectedClass);
    classStudents.forEach(stu => {
        const div = document.createElement('div');
        div.className = 'student-checkbox';
        div.innerHTML = `<input type="checkbox" value="${stu.id}" id="stu_${stu.id}"> <label for="stu_${stu.id}">${stu.name}</label>`;
        manualStudentsList.appendChild(div);
    });
}

confirmCompetitorsBtn.addEventListener('click', () => {
    if (selectionMode === 'manual') {
        const checked = manualStudentsList.querySelectorAll('input[type=checkbox]:checked');
        if (checked.length < 2) {
            showSmartMessage('Ø§Ø®ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†!');
            return;
        }
        selectedCompetitors = Array.from(checked).map(chk => {
            return students.find(s => s.id == chk.value);
        });
    }
    if (selectedCompetitors.length < 2) {
        showSmartMessage('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ØªÙ†Ø§ÙØ³ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!');
        return;
    }
    document.getElementById('setupSection').style.display = 'none';
    teamsRow.style.display = '';
    arenaControls.style.display = '';
    renderCompetitorsArena();
    showSmartMessage('Ø§Ø³ØªØ¹Ø¯ÙˆØ§ Ù„Ù„Ø³Ø¨Ø§Ù‚!');
});

function renderCompetitorsArena() {
    teamsRow.innerHTML = '';
    selectedCompetitors.forEach((stu, idx) => {
        const card = document.createElement('div');
        card.className = 'team-card';
        card.innerHTML = `
            <div class="team-name">${stu.name}</div>
            <div class="team-progress"><div class="team-progress-bar" id="progress_${stu.id}" style="width:0%"></div></div>
            <div class="team-score" id="score_${stu.id}">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
            <div class="team-icon"><i class="fas fa-rocket"></i></div>
        `;
        teamsRow.appendChild(card);
    });
}

function showSmartMessage(msg) {
    let el = document.getElementById('smartMsg');
    if (!el) {
        el = document.createElement('div');
        el.id = 'smartMsg';
        el.style.position = 'fixed';
        el.style.top = '32px';
        el.style.left = '50%';
        el.style.transform = 'translateX(-50%)';
        el.style.background = 'rgba(255,255,255,0.95)';
        el.style.color = 'var(--accent-gold)';
        el.style.fontWeight = 'bold';
        el.style.fontSize = '1.3rem';
        el.style.padding = '16px 32px';
        el.style.borderRadius = '18px';
        el.style.boxShadow = '0 4px 24px 0 #0002';
        el.style.zIndex = 9999;
        document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.display = '';
    setTimeout(() => { el.style.display = 'none'; }, 2000);
}

function shuffle(arr) {
    return arr.map(a => [Math.random(), a]).sort().map(a => a[1]);
}

// Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø¨Ø§Ù‚
let raceActive = false;
let racePaused = false;
let scores = {};
let progress = {};
let stats = {};
const raceDistance = 10;
const startRaceBtn = document.getElementById('startRaceBtn');
const nextQuestionBtn = document.getElementById('nextQuestionBtn');
const correctBtn = document.getElementById('correctBtn');
const wrongBtn = document.getElementById('wrongBtn');
const pauseBtn = document.getElementById('pauseBtn');
let currentTurn = 0;

startRaceBtn.addEventListener('click', () => {
    if (raceActive) return;
    raceActive = true;
    racePaused = false;
    scores = {};
    progress = {};
    stats = {};
    selectedCompetitors.forEach(stu => {
        scores[stu.id] = 0;
        progress[stu.id] = 0;
        stats[stu.id] = { correct: 0, wrong: 0 };
        document.getElementById('progress_' + stu.id).style.width = '0%';
        document.getElementById('score_' + stu.id).textContent = 'Ø§Ù„Ù†Ù‚Ø§Ø·: 0';
    });
    currentTurn = 0;
    showStatsPanel();
    showSmartMessage('Ø§Ù†Ø·Ù„Ù‚ Ø§Ù„Ø³Ø¨Ø§Ù‚!');
    playSound('start');
    highlightCurrent();
});

pauseBtn.addEventListener('click', () => {
    if (!raceActive) return;
    racePaused = !racePaused;
    showSmartMessage(racePaused ? 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³Ø¨Ø§Ù‚ Ù…Ø¤Ù‚ØªØ§Ù‹' : 'Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø³Ø¨Ø§Ù‚!');
});

nextQuestionBtn.addEventListener('click', () => {
    if (!raceActive || racePaused) return;
    currentTurn = (currentTurn + 1) % selectedCompetitors.length;
    highlightCurrent();
    showSmartMessage(randomEncourage());
});

correctBtn.addEventListener('click', () => {
    if (!raceActive || racePaused) return;
    const stu = selectedCompetitors[currentTurn];
    scores[stu.id] += 1;
    stats[stu.id].correct += 1;
    updateProgress(stu.id);
    playSound('correct');
    showSmartMessage('Ø£Ø­Ø³Ù†Øª ÙŠØ§ ' + stu.name + '!");
    updateStatsPanel();
    if (scores[stu.id] >= raceDistance) {
        finishRace(stu);
    } else {
        nextQuestionBtn.click();
    }
});

wrongBtn.addEventListener('click', () => {
    if (!raceActive || racePaused) return;
    const stu = selectedCompetitors[currentTurn];
    stats[stu.id].wrong += 1;
    playSound('wrong');
    showSmartMessage('Ø­Ø¸Ø§Ù‹ Ø£ÙˆÙØ± ÙŠØ§ ' + stu.name + '!");
    updateStatsPanel();
    nextQuestionBtn.click();
});

function updateProgress(stuId) {
    const percent = Math.min(100, (scores[stuId] / raceDistance) * 100);
    document.getElementById('progress_' + stuId).style.width = percent + '%';
    document.getElementById('score_' + stuId).textContent = 'Ø§Ù„Ù†Ù‚Ø§Ø·: ' + scores[stuId];
    animateRocket(stuId, percent);
}

function highlightCurrent() {
    document.querySelectorAll('.team-card').forEach(card => card.classList.remove('active-turn'));
    const stu = selectedCompetitors[currentTurn];
    const card = Array.from(document.querySelectorAll('.team-card')).find(c => c.querySelector('.team-name').textContent === stu.name);
    if (card) card.classList.add('active-turn');
}

function finishRace(winner) {
    raceActive = false;
    showSmartMessage('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø²: ' + winner.name + ' ğŸ‰');
    playSound('win');
    confettiEffect();
    showHonorBoard();
}

function showStatsPanel() {
    let panel = document.getElementById('statsPanel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'statsPanel';
        panel.style.position = 'fixed';
        panel.style.bottom = '24px';
        panel.style.left = '24px';
        panel.style.background = 'rgba(255,255,255,0.92)';
        panel.style.color = 'var(--oman-red)';
        panel.style.borderRadius = '18px';
        panel.style.boxShadow = '0 4px 24px #FFD70033';
        panel.style.padding = '18px 28px';
        panel.style.fontSize = '1.1rem';
        panel.style.zIndex = 1000;
        document.body.appendChild(panel);
    }
    updateStatsPanel();
}

function updateStatsPanel() {
    const panel = document.getElementById('statsPanel');
    if (!panel) return;
    let html = '<b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</b><br><table style="margin-top:8px;font-size:1rem;min-width:180px;">';
    html += '<tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>ØµØ­ÙŠØ­</th><th>Ø®Ø·Ø£</th></tr>';
    selectedCompetitors.forEach(stu => {
        html += `<tr><td>${stu.name}</td><td style="color:green">${stats[stu.id]?.correct||0}</td><td style="color:#b00">${stats[stu.id]?.wrong||0}</td></tr>`;
    });
    html += '</table>';
    panel.innerHTML = html;
}

function showHonorBoard() {
    let board = document.getElementById('honorBoard');
    if (board) board.remove();
    board = document.createElement('div');
    board.id = 'honorBoard';
    board.style.position = 'fixed';
    board.style.top = '50%';
    board.style.left = '50%';
    board.style.transform = 'translate(-50%,-50%)';
    board.style.background = 'linear-gradient(135deg,#fffbe6 60%,#ffe7b2 100%)';
    board.style.color = '#b8860b';
    board.style.border = '4px solid #FFD700';
    board.style.borderRadius = '32px';
    board.style.boxShadow = '0 8px 48px #FFD70055';
    board.style.padding = '38px 48px 32px 48px';
    board.style.textAlign = 'center';
    board.style.zIndex = 2000;
    board.innerHTML = `<h2 style="font-size:2.2rem;margin-bottom:18px;">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h2>`;
    const sorted = [...selectedCompetitors].sort((a,b)=>scores[b.id]-scores[a.id]);
    sorted.forEach((stu,idx)=>{
        board.innerHTML += `<div style="font-size:1.3rem;margin:10px 0;"><b>${idx+1}. ${stu.name}</b> <span style="color:green">(${scores[stu.id]} Ù†Ù‚Ø·Ø©)</span></div>`;
    });
    board.innerHTML += `<div style="margin-top:22px;"><button onclick="document.getElementById('honorBoard').remove()" style="background:var(--accent-gold);color:#fff;font-size:1.1rem;padding:10px 28px;border:none;border-radius:12px;box-shadow:0 2px 8px #FFD70033;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button></div>`;
    document.body.appendChild(board);
    confettiEffect();
}

function randomEncourage() {
    const msgs = [
        'Ù…Ù†Ø§ÙØ³Ø© Ù…Ø´ØªØ¹Ù„Ø©!','Ù…Ù† ÙŠØªÙ‚Ø¯Ù…ØŸ','Ù…Ù† Ø³ÙŠÙÙˆØ²ØŸ','Ø´Ø¯ÙˆØ§ Ø§Ù„Ù‡Ù…Ø©!','Ø£Ø¬ÙˆØ§Ø¡ Ø­Ù…Ø§Ø³ÙŠØ©!','Ø§Ù„Ø³Ø¨Ø§Ù‚ ÙŠØ²Ø¯Ø§Ø¯ Ø¥Ø«Ø§Ø±Ø©!','Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆÙ‰ Ø§Ù„ÙŠÙˆÙ…ØŸ','Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù„ÙÙˆØ²ØŸ'
    ];
    return msgs[Math.floor(Math.random() * msgs.length)];
}

function playSound(type) {
    const sounds = {
        start: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b6.mp3',
        correct: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b7.mp3',
        wrong: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b8.mp3',
        win: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b9.mp3',
        click: 'https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b6b6b5.mp3'
    };
    if (sounds[type]) {
        const audio = new Audio(sounds[type]);
        audio.play();
    }
}
[startRaceBtn, nextQuestionBtn, correctBtn, wrongBtn, pauseBtn].forEach(btn => {
    btn.addEventListener('click', () => playSound('click'));
});

function confettiEffect() {
    if (window.confetti) {
        confetti({
            particleCount: 200,
            spread: 90,
            origin: { y: 0.6 }
        });
    }
}
function animateRocket(stuId, percent) {
    const bar = document.getElementById('progress_' + stuId);
    const icon = bar.parentElement.parentElement.querySelector('.team-icon');
    icon.style.transform = `translateX(${percent}%) scale(1.2)`;
    setTimeout(() => { icon.style.transform = 'translateX(0) scale(1)'; }, 700);
}
// ØªØ¹Ù„ÙŠÙ…Ø§Øª
infoBtn.onclick = () => instructionsModal.removeAttribute('hidden');
homeBtn.onclick = () => location.reload();
// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø²Ø± Esc
window.addEventListener('keydown',e=>{if(e.key==='Escape'){instructionsModal.setAttribute('hidden','')}});
    </script>
</body>
</html>
