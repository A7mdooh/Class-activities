<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>سباق المعرفة التفاعلي</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    body { background: linear-gradient(135deg, #23243a 0%, #18192b 100%); color: #FFD700; font-family: 'Cairo', sans-serif; }
    .main-container { max-width: 700px; margin: 40px auto; background: rgba(35,36,58,0.97); border-radius: 18px; box-shadow: 0 4px 32px #FFD70022; padding: 32px 24px; }
    .title { text-align: center; font-size: 2.2rem; font-weight: bold; color: #FFD700; margin-bottom: 18px; }
    .subtitle { text-align: center; color: #DC143C; font-size: 1.1rem; margin-bottom: 24px; }
    .select-row { display: flex; gap: 12px; margin-bottom: 18px; justify-content: center; }
    select, button { font-family: inherit; font-size: 1.1rem; border-radius: 10px; border: 2px solid #FFD70055; padding: 10px 18px; margin: 0 4px; }
    button { background: var(--gradient-gold, linear-gradient(90deg,#FFD700,#fffbe6 80%,#FFD700)); color: #23243a; font-weight: bold; cursor: pointer; transition: background .2s; }
    button:active { filter: brightness(0.95); }
    .student-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 18px; }
    .student-chip { background: #FFD70022; color: #FFD700; border-radius: 8px; padding: 8px 16px; font-weight: 700; cursor: pointer; border: 2px solid #FFD70055; transition: background .2s, color .2s; }
    .student-chip.selected, .student-chip:hover { background: #FFD700; color: #23243a; }
    .big-student { text-align: center; font-size: 2.1rem; font-weight: bold; color: #FFD700; margin: 24px 0 12px 0; }
    .scoreboard { margin: 24px auto 0 auto; max-width: 400px; background: #18192b; border-radius: 14px; padding: 18px; box-shadow: 0 2px 8px #FFD70022; }
    .score-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 1.1rem; }
    .score-row .name { font-weight: bold; }
    .score-row .score { color: #228B22; font-weight: bold; }
    .notif { text-align: center; background: linear-gradient(90deg,#FFD700,#DC143C); color: #23243a; font-size: 1.3rem; font-weight: 900; padding: 14px 32px; border-radius: 18px; box-shadow: 0 8px 32px #000a,0 0 24px #FFD70099; margin-bottom: 18px; display: none; }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="title">🏆 سباق المعرفة التفاعلي</div>
    <div class="subtitle">اختر الصف، ثم اختر طالبًا عشوائيًا أو يدويًا، واسأل سؤالًا شفويًا وقيّم الإجابة!</div>
    <div class="notif" id="notif"></div>
    <div class="select-row">
      <label for="classSelect">الصف:</label>
      <select id="classSelect"><option value="">— اختر الصف —</option></select>
      <button id="chooseStudentsBtn">اختيار الطلاب</button>
    </div>
    <!-- نافذة اختيار الطلاب المطورة -->
    <div id="chooseStudentsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,30,40,0.85);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:linear-gradient(135deg,#23243a 80%,#FFD70022 100%);border-radius:22px;box-shadow:0 8px 48px #000a,0 0 32px #FFD70099;padding:36px 32px 28px 32px;min-width:340px;max-width:98vw;color:#FFD700;position:relative;text-align:center;">
        <button id="closeChooseStudents" style="position:absolute;top:12px;left:18px;background:none;border:none;color:#FFD700;font-size:2rem;font-weight:bold;cursor:pointer;">×</button>
        <h2 style="color:#FFD700;font-size:1.5rem;font-weight:900;margin-bottom:18px;">اختيار الطلاب المشاركين</h2>
        <div style="display:flex;justify-content:center;gap:10px;margin-bottom:16px;">
          <button class="mode-btn" id="modeRandom" style="padding:7px 18px;">عشوائي</button>
          <button class="mode-btn" id="modeManual" style="padding:7px 18px;">يدوي</button>
          <button class="mode-btn" id="modeAll" style="padding:7px 18px;">الكل</button>
        </div>
        <div id="studentCountSection" style="display:none;margin-bottom:12px;align-items:center;justify-content:center;gap:8px;">
          <button id="countMinus" style="font-size:1.3rem;padding:2px 10px;">-</button>
          <span id="studentCountDisplay" style="font-size:1.2rem;font-weight:bold;min-width:32px;display:inline-block;">3</span>
          <button id="countPlus" style="font-size:1.3rem;padding:2px 10px;">+</button>
          <span style="font-size:1rem;">طالب</span>
        </div>
        <div id="chooseStudentsList" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:18px;"></div>
        <button id="confirmStudentsBtn" class="oman-btn gold" style="font-size:1.1rem;">ابدأ اللعبة</button>
      </div>
    </div>
    <div class="student-list" id="studentList"></div>
    <div style="text-align:center; margin-bottom:18px;">
    </div>
  <div class="big-student" id="currentStudent"></div>
    <div style="text-align:center; margin-bottom:18px;">
      <button id="correctBtn" style="background:linear-gradient(90deg,#228B22,#FFD700);color:#fff;">إجابة صحيحة ✅</button>
      <button id="wrongBtn" style="background:linear-gradient(90deg,#DC143C,#FFD700);color:#fff;">إجابة خاطئة ❌</button>
    </div>
    <div class="scoreboard" id="scoreboard"></div>
  </div>
  <script>
    let studentsData = {};
    let currentClass = null;
    let students = [];
    let scores = {};
    let picked = null;

    // تحميل بيانات الطلاب من JSON
    async function loadStudentsData() {
      try {
        const res = await fetch('../data/studentData.json');
        studentsData = await res.json();
      } catch {
        studentsData = { 'الصف الأول': ['طالب1','طالب2'], 'الصف الثاني': ['طالب3','طالب4'] };
      }
    }

    function showNotif(msg, color) {
      const n = document.getElementById('notif');
      n.textContent = msg;
      n.style.display = 'block';
      n.style.background = color || 'linear-gradient(90deg,#FFD700,#DC143C)';
      setTimeout(()=>{ n.style.display = 'none'; }, 2000);
    }

    function fillClassSelect() {
      const sel = document.getElementById('classSelect');
      sel.innerHTML = '<option value="">— اختر الصف —</option>';
      Object.keys(studentsData).forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls; opt.textContent = cls;
        sel.appendChild(opt);
      });
    }

    function renderStudentList() {
      const list = document.getElementById('studentList');
      list.innerHTML = '';
      students.forEach((name,i)=>{
        const chip = document.createElement('div');
        chip.className = 'student-chip';
        chip.textContent = name;
        chip.onclick = ()=>pickStudent(i);
        list.appendChild(chip);
      });
    }

    function pickStudent(idx) {
      picked = idx;
      document.querySelectorAll('.student-chip').forEach((el,i)=>{
        el.classList.toggle('selected', i===idx);
      });
      document.getElementById('currentStudent').textContent = students[idx];
    }

    function pickRandomStudent() {
      if(!students.length) return;
      let idx;
      do { idx = Math.floor(Math.random()*students.length); } while(idx===picked && students.length>1);
      pickStudent(idx);
      showNotif('تم اختيار الطالب عشوائيًا!','linear-gradient(90deg,#6aa6ff,#FFD700)');
    }

    function updateScoreboard() {
      const board = document.getElementById('scoreboard');
      if(!students.length) { board.innerHTML = ''; return; }
      let arr = students.map((name,i)=>({name,score:scores[name]||0}));
      arr.sort((a,b)=>b.score-a.score);
      board.innerHTML = arr.map(s=>`<div class='score-row'><span class='name'>${s.name}</span><span class='score'>${s.score} نقطة</span></div>`).join('');
    }

    // منطق اختيار الطلاب المطور
    let selectMode = 'random';
    let targetCount = 3;
    let manualSelected = new Set();
    document.getElementById('chooseStudentsBtn').onclick = function() {
      if(!currentClass || !(studentsData[currentClass]||[]).length) return showNotif('اختر الصف أولاً!','#DC143C');
      selectMode = 'random';
      targetCount = Math.min(3, studentsData[currentClass].length);
      manualSelected = new Set();
      updateModeBtns();
      updateStudentCountSection();
      renderChooseStudentsList();
      document.getElementById('chooseStudentsModal').style.display = 'flex';
    };
    function updateModeBtns() {
      ['modeRandom','modeManual','modeAll'].forEach(id=>{
        document.getElementById(id).classList.remove('selected');
      });
      document.getElementById('mode'+capitalize(selectMode)).classList.add('selected');
    }
    function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}
    document.getElementById('modeRandom').onclick = function(){ selectMode='random'; updateModeBtns(); updateStudentCountSection(); renderChooseStudentsList(); };
    document.getElementById('modeManual').onclick = function(){ selectMode='manual'; updateModeBtns(); updateStudentCountSection(); renderChooseStudentsList(); };
    document.getElementById('modeAll').onclick = function(){ selectMode='all'; updateModeBtns(); updateStudentCountSection(); renderChooseStudentsList(); };
    function updateStudentCountSection() {
      const sec = document.getElementById('studentCountSection');
      if(selectMode==='all') { sec.style.display='none'; return; }
      sec.style.display='flex';
      document.getElementById('studentCountDisplay').textContent = targetCount;
    }
    document.getElementById('countMinus').onclick = function(){
      if(targetCount>2) { targetCount--; document.getElementById('studentCountDisplay').textContent=targetCount; renderChooseStudentsList(); }
    };
    document.getElementById('countPlus').onclick = function(){
      const max = studentsData[currentClass].length;
      if(targetCount<max) { targetCount++; document.getElementById('studentCountDisplay').textContent=targetCount; renderChooseStudentsList(); }
    };
    document.getElementById('closeChooseStudents').onclick = function() {
      document.getElementById('chooseStudentsModal').style.display = 'none';
    };

    function renderChooseStudentsList() {
      const list = document.getElementById('chooseStudentsList');
      list.innerHTML = '';
      const all = studentsData[currentClass]||[];
      if(selectMode==='all') {
        all.forEach((name,i)=>{
          const div = document.createElement('div');
          div.className = 'student-chip selected';
          div.textContent = name;
          list.appendChild(div);
        });
        return;
      }
      if(selectMode==='random') {
        // اختيار عشوائي بدون تكرار
        const shuffled = all.slice();
        for(let i=shuffled.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]]; }
        const selected = shuffled.slice(0,targetCount);
        selected.forEach((name,i)=>{
          const div = document.createElement('div');
          div.className = 'student-chip selected';
          div.textContent = name;
          list.appendChild(div);
        });
        return;
      }
      // يدوي
      all.forEach((name,i)=>{
        const div = document.createElement('div');
        div.className = 'student-chip';
        div.textContent = name;
        div.onclick = function(){
          if(manualSelected.has(name)) { manualSelected.delete(name); div.classList.remove('selected'); }
          else if(manualSelected.size<targetCount) { manualSelected.add(name); div.classList.add('selected'); }
        };
        if(manualSelected.has(name)) div.classList.add('selected');
        list.appendChild(div);
      });
    }

    document.getElementById('randomSelectBtn').onclick = function() {
      const all = studentsData[currentClass]||[];
      let n = parseInt(document.getElementById('randomCount').value)||3;
      n = Math.max(2, Math.min(n, all.length));
      // اختيار عشوائي بدون تكرار
      const shuffled = all.slice();
      for(let i=shuffled.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]]; }
      // حدد فقط أول n
      document.querySelectorAll('#chooseStudentsList input[type=checkbox]').forEach((el,idx)=>{
        el.checked = shuffled.slice(0,n).includes(all[idx]);
      });
    };

  // ...existing code...
    document.getElementById('classSelect').onchange = function() {
      currentClass = this.value;
      students = [];
      scores = {};
      picked = null;
      renderStudentList();
      document.getElementById('currentStudent').textContent = '';
      updateScoreboard();
      // إذا كانت نافذة اختيار الطلاب مفتوحة، حدث القائمة مباشرة
      if(document.getElementById('chooseStudentsModal').style.display === 'flex') {
        renderChooseStudentsList();
        setTimeout(()=>{
          document.querySelectorAll('#chooseStudentsList input[type=checkbox]').forEach(el=>el.checked = true);
        }, 0);
      }
    };

    document.getElementById('confirmStudentsBtn').onclick = function() {
      let chosen = [];
      const all = studentsData[currentClass]||[];
      if(selectMode==='all') {
        chosen = all.slice();
      } else if(selectMode==='random') {
        const shuffled = all.slice();
        for(let i=shuffled.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]]; }
        chosen = shuffled.slice(0,targetCount);
      } else {
        chosen = Array.from(manualSelected);
        if(chosen.length!==targetCount) return showNotif('اختر العدد المطلوب يدويًا!','#DC143C');
      }
      if(chosen.length<2) return showNotif('اختر على الأقل طالبين!','#DC143C');
      students = chosen;
      scores = {};
      picked = null;
      renderStudentList();
      document.getElementById('currentStudent').textContent = '';
      document.getElementById('chooseStudentsModal').style.display = 'none';
      if (students.length > 0) {
        pickStudent(0);
        showNotif('تم اعتماد الطلاب المختارين! بدأت اللعبة.','linear-gradient(90deg,#228B22,#FFD700)');
      }
      updateScoreboard();
    };

    // متغيرات حركة العجلة
    let pickerInterval = null;
    let pickerCurrent = 0;
    let pickerOrder = [];

    function renderPickerNames() {
      const el = document.getElementById('pickerNames');
      pickerOrder = students.slice();
      shuffleArray(pickerOrder);
      el.innerHTML = pickerOrder.map((n,i)=>`<span style="margin:0 18px;${i===0?'color:#FFD700;text-shadow:0 0 8px #FFD700;':''}">${n}</span>`).join('');
    }
    function shuffleArray(arr) {
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    }
    function resetPickerUI() {
      document.getElementById('startPicker').style.display = '';
      document.getElementById('stopPicker').style.display = 'none';
    }
    function startPickerAnim() {
      if(!pickerOrder.length) return;
      pickerCurrent = 0;
      pickerInterval = setInterval(()=>{
        pickerCurrent = (pickerCurrent+1)%pickerOrder.length;
        updatePickerHighlight();
      }, 80);
      document.getElementById('startPicker').style.display = 'none';
      document.getElementById('stopPicker').style.display = '';
    }
    function stopPickerAnim() {
      if(pickerInterval) clearInterval(pickerInterval);
      pickerInterval = null;
      document.getElementById('startPicker').style.display = '';
      document.getElementById('stopPicker').style.display = 'none';
    }
    function updatePickerHighlight() {
      const el = document.getElementById('pickerNames');
      el.innerHTML = pickerOrder.map((n,i)=>`<span style="margin:0 18px;${i===pickerCurrent?'color:#FFD700;text-shadow:0 0 8px #FFD700;font-size:1.7rem;':''}">${n}</span>`).join('');
    }
    document.getElementById('startPicker').onclick = function() {
      startPickerAnim();
    };
    document.getElementById('stopPicker').onclick = function() {
      if(!pickerInterval) return;
      stopPickerAnim();
      // مؤثر توقف احترافي
      updatePickerHighlight();
      setTimeout(()=>{
        // إعلان الفائز
        const idx = students.indexOf(pickerOrder[pickerCurrent]);
        pickStudent(idx);
        document.getElementById('pickerModal').style.display = 'none';
        showNotif('🎉 تم اختيار المتسابق!','linear-gradient(90deg,#FFD700,#228B22)');
      }, 400);
    };
    document.getElementById('correctBtn').onclick = ()=>{
      if(picked==null) return showNotif('اختر طالبًا أولاً!','#DC143C');
      const name = students[picked];
      scores[name] = (scores[name]||0)+1;
      showNotif('أحسنت! نقطة للطالب','linear-gradient(90deg,#228B22,#FFD700)');
      updateScoreboard();
      picked = null;
      document.getElementById('currentStudent').textContent = '';
      document.querySelectorAll('.student-chip').forEach(el=>el.classList.remove('selected'));
    };
    document.getElementById('wrongBtn').onclick = ()=>{
      if(picked==null) return showNotif('اختر طالبًا أولاً!','#DC143C');
      showNotif('حظًا أوفر!','linear-gradient(90deg,#DC143C,#FFD700)');
      picked = null;
      document.getElementById('currentStudent').textContent = '';
      document.querySelectorAll('.student-chip').forEach(el=>el.classList.remove('selected'));
    };
    // تحميل تلقائي عند الفتح
    loadStudentsData().then(()=>{
      fillClassSelect();
      // تأكد من إعادة تعيين currentClass عند إعادة تعبئة القائمة
      currentClass = document.getElementById('classSelect').value;
    });
  </script>
</body>
</html>
