<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>من هو؟ - لعبة التفاعل الصفي</title>
  
  <!-- خطوط Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap');
    
    :root {
      /* الألوان الأساسية */
      --primary-color: #2c5aa0;
      --secondary-color: #34a85a;
      --accent-color: #f39c12;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --success-color: #27ae60;
      --info-color: #3498db;
      --text-color: #2c3e50;
      --white: #ffffff;
      
      /* ألوان التدرج */
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --gradient-royal: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-mystic: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-cosmic: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      
      /* ألوان البطاقات */
      --card-bg: #ffffff;
      --card-shadow: rgba(0, 0, 0, 0.1);
      --card-hover-shadow: rgba(0, 0, 0, 0.2);
      --card-border: #e1e8ed;
      
      /* متغيرات الحركة */
      --animation-speed: 0.3s;
      --bounce-animation: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --smooth-animation: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* الظلال المتقدمة */
      --neumorphism-light: #ffffff;
      --neumorphism-dark: #d1d9e6;
      --neumorphism-inset: inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #ffffff;
      --neumorphism-outset: 5px 5px 10px #d1d9e6, -5px -5px 10px #ffffff;
      
      /* ألوان الخلفية المتدرجة */
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --card-gradient: linear-gradient(145deg, #f0f2f5 0%, #ffffff 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      color: var(--text-color);
    }

    /* خلفية متحركة */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      animation: backgroundShift 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(180deg); }
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* زر العودة المتطور */
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--gradient-primary);
      color: var(--white);
      padding: 15px 25px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      box-shadow: var(--neumorphism-outset);
      transition: all var(--animation-speed) var(--bounce-animation);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .back-button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        var(--neumorphism-outset),
        0 15px 30px rgba(0,0,0,0.2);
    }

    /* تصميم العنوان المتطور */
    .header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }

    .main-title {
      font-size: clamp(2.5rem, 5vw, 4rem);
      font-weight: 800;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      animation: titleGlow 3s ease-in-out infinite;
      position: relative;
    }

    @keyframes titleGlow {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.05); filter: brightness(1.2); }
    }

    .subtitle {
      font-size: 1.3rem;
      color: #5a6c7d;
      font-weight: 500;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    /* بطاقة التحكم الرئيسية */
    .controls {
      background: var(--card-gradient);
      border-radius: 25px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--neumorphism-outset);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      transition: all var(--animation-speed) var(--smooth-animation);
      position: relative;
      overflow: hidden;
    }

    .controls::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-royal);
      border-radius: 25px 25px 0 0;
    }

    .controls:hover {
      transform: translateY(-5px);
      box-shadow: 
        var(--neumorphism-outset),
        0 20px 40px rgba(0,0,0,0.1);
    }

    /* مجموعات التحكم */
    .control-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      background: rgba(255,255,255,0.7);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--neumorphism-inset);
      transition: all var(--animation-speed) var(--bounce-animation);
    }

    .form-group:hover {
      transform: scale(1.02);
      background: rgba(255,255,255,0.9);
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    select, .form-control {
      width: 100%;
      padding: 12px 18px;
      border: 2px solid transparent;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      background: rgba(255,255,255,0.9);
      box-shadow: var(--neumorphism-inset);
      transition: all var(--animation-speed) var(--smooth-animation);
      font-weight: 500;
      color: var(--text-color);
    }

    select:focus, .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 
        var(--neumorphism-inset),
        0 0 0 3px rgba(44, 90, 160, 0.1);
      transform: scale(1.02);
    }

    /* أزرار اللعبة المتطورة */
    .game-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    button, .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      font-family: 'Cairo', sans-serif;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: var(--neumorphism-outset);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    button::before, .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    button:hover::before, .btn:hover::before {
      left: 100%;
    }

    button:hover:not(:disabled), .btn:hover:not(:disabled) {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        var(--neumorphism-outset),
        0 15px 30px rgba(0,0,0,0.2);
    }

    button:active, .btn:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--white);
    }

    .btn-success {
      background: var(--gradient-success);
      color: var(--white);
    }

    .btn-warning {
      background: var(--gradient-warning);
      color: #2c3e50;
    }

    .btn-royal {
      background: var(--gradient-royal);
      color: var(--white);
    }

    .btn-mystic {
      background: var(--gradient-mystic);
      color: var(--white);
    }

    .btn-cosmic {
      background: var(--gradient-cosmic);
      color: #2c3e50;
    }

    /* بطاقات الاختيار المتطورة */
    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
      margin-top: 30px;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .student-card {
      background: var(--card-gradient);
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: var(--neumorphism-outset);
      position: relative;
      overflow: hidden;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .student-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-royal);
      transform: scaleX(0);
      transition: transform var(--animation-speed) var(--smooth-animation);
    }

    .student-card:hover::before {
      transform: scaleX(1);
    }

    .student-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 
        var(--neumorphism-outset),
        0 25px 50px rgba(0,0,0,0.15);
      border-color: var(--primary-color);
    }

    .student-card.selected {
      background: var(--gradient-success);
      color: var(--white);
      transform: scale(1.05);
      box-shadow: 
        0 20px 40px rgba(79, 172, 254, 0.3),
        inset 0 0 20px rgba(255,255,255,0.2);
    }

    .student-card.correct {
      background: var(--gradient-success);
      color: var(--white);
      animation: correctPulse 0.6s ease-in-out;
    }

    .student-card.wrong {
      background: var(--gradient-secondary);
      color: var(--white);
      animation: wrongShake 0.6s ease-in-out;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .student-name {
      font-size: 1.2rem;
      font-weight: 600;
      line-height: 1.4;
      position: relative;
      z-index: 2;
    }

    /* منطقة اللعبة */
    .game-area {
      background: var(--card-gradient);
      border-radius: 25px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--neumorphism-outset);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .current-student {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      padding: 20px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: var(--neumorphism-inset);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    /* نظام الرسائل المتطور */
    .messages {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }

    .message {
      background: var(--card-gradient);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: var(--neumorphism-outset);
      border-left: 5px solid var(--primary-color);
      backdrop-filter: blur(10px);
      animation: messageSlide 0.5s var(--bounce-animation);
      position: relative;
      overflow: hidden;
    }

    @keyframes messageSlide {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .message.success {
      border-left-color: var(--success-color);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.error {
      border-left-color: var(--danger-color);
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.warning {
      border-left-color: var(--warning-color);
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.info {
      border-left-color: var(--info-color);
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    /* شاشة التحميل المتطورة */
    .loading-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }

    .loading-area.active {
      display: flex;
    }

    .loading-content {
      text-align: center;
      color: var(--white);
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* النتائج */
    .result-display {
      background: var(--gradient-success);
      color: var(--white);
      padding: 2rem;
      border-radius: 20px;
      margin: 2rem 0;
      font-size: 1.2rem;
      font-weight: 600;
      box-shadow: var(--neumorphism-outset);
      animation: celebrate 1s ease-in-out;
      text-align: center;
      line-height: 1.6;
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .game-interface {
      width: 100%;
    }

    .student-card.correct::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      color: var(--white);
      font-weight: 900;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
      animation: checkMark 1.2s ease-out;
      z-index: 10;
    }

    @keyframes checkMark {
      0% { 
        transform: translate(-50%, -50%) scale(0) rotateZ(-180deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2) rotateZ(-90deg);
        opacity: 1;
      }
      100% { 
        transform: translate(-50%, -50%) scale(1) rotateZ(0deg);
        opacity: 1;
      }
    }

    .student-card.wrong::after {
      content: '✗';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      color: var(--white);
      font-weight: 900;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
      animation: wrongMark 1s ease-out;
      z-index: 10;
    }

    @keyframes wrongMark {
      0% { 
        transform: translate(-50%, -50%) scale(0) rotateZ(180deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2) rotateZ(90deg);
        opacity: 1;
      }
      100% { 
        transform: translate(-50%, -50%) scale(1) rotateZ(0deg);
        opacity: 1;
      }
    }

    /* الفئات المساعدة */
    .hidden {
      display: none !important;
    }

    /* تحسينات الاستجابة */
    @media (max-width: 768px) {
      .main-container {
        padding: 15px;
      }

      .main-title {
        font-size: 2.5rem;
      }

      .controls {
        padding: 20px;
      }

      .control-group {
        grid-template-columns: 1fr;
      }

      .students-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
      }

      .student-card {
        padding: 20px;
        min-height: 120px;
      }

      .messages {
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .back-button {
        top: 10px;
        left: 10px;
        padding: 12px 20px;
      }
    }

    @media (max-width: 480px) {
      .main-title {
        font-size: 2rem;
      }

      .students-grid {
        grid-template-columns: 1fr;
      }

      .student-card {
        min-height: 100px;
      }

      .current-student {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- شاشة التحميل -->
  <div class="loading-area" id="loadingArea">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">جاري التحميل...</div>
    </div>
  </div>

  <!-- نظام الرسائل -->
  <div class="messages" id="messages"></div>

  <!-- زر العودة -->
  <a href="../index.html" class="back-button">
    <i class="fas fa-arrow-right"></i>
    العودة للقائمة الرئيسية
  </a>

  <!-- الحاوية الرئيسية -->
  <div class="main-container">
    <!-- رأس الصفحة -->
    <div class="header">
      <h1 class="main-title">🎯 من هو؟</h1>
      <p class="subtitle">لعبة تفاعلية لتخمين هوية الطلاب مع النظام الصوتي المتقدم</p>
    </div>

    <!-- أدوات التحكم الرئيسية -->
    <div class="controls">
      <div class="control-group">
        <div class="form-group">
          <label for="classSelect">📚 اختيار الصف</label>
          <select id="classSelect" class="form-control">
            <option value="">اختر الصف الدراسي</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="modeSelect">🎮 وضع اللعبة</label>
          <select id="modeSelect" class="form-control">
            <option value="random">🎲 فردي عشوائي</option>
            <option value="manual">🎯 فردي انتقائي</option>
            <option value="challenge">⏰ تحدي زمني</option>
            <option value="survival">🔥 وضع البقاء</option>
            <option value="team">👥 فريق ضد فريق</option>
          </select>
        </div>
      </div>

      <div class="control-group">
        <div class="form-group">
          <label for="timeSelect">⏱️ الوقت المحدد</label>
          <select id="timeSelect" class="form-control">
            <option value="0">🚫 بلا وقت محدد</option>
            <option value="30">⚡ 30 ثانية</option>
            <option value="60">🟢 60 ثانية</option>
            <option value="120">🟡 120 ثانية</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="livesSelect">❤️ عدد المحاولات</label>
          <select id="livesSelect" class="form-control">
            <option value="1">❤️ محاولة واحدة</option>
            <option value="3">💕 3 محاولات</option>
            <option value="5">💖 5 محاولات</option>
            <option value="-1">💝 محاولات لا نهائية</option>
          </select>
        </div>
      </div>

      <!-- أزرار بدء اللعبة -->
      <div class="game-buttons">
        <button id="startGameBtn" class="btn btn-primary" disabled>
          <i class="fas fa-play"></i>
          🎲 بدء اللعبة
        </button>
        <button id="settingsBtn" class="btn btn-cosmic">
          <i class="fas fa-cog"></i>
          ⚙️ الإعدادات
        </button>
      </div>
    </div>

    <!-- منطقة الرسائل -->
    <div id="messageArea"></div>

    <!-- منطقة اللعبة -->
    <div class="game-area" id="gameArea">
      <p><i class="fas fa-info-circle"></i> اختر الصف ونمط اللعبة لبدء التحدي</p>
    </div>
  </div>

  <script>
    // نظام الصوتيات المتقدم
    class SoundSystem {
      constructor() {
        this.sounds = {};
        this.musicEnabled = true;
        this.soundEnabled = true;
        this.volume = 0.6;
        this.initializeSounds();
      }

      initializeSounds() {
        this.soundMap = {
          'click': 'cosmic-click.mp3',
          'correct': 'epic-victory.mp3',
          'wrong': 'point-lose.mp3',
          'reveal': 'knowledge-unlock.mp3',
          'notification': 'ai-notification.mp3',
          'success': 'crystal-bonus.mp3',
          'error': 'shield-block.mp3'
        };

        this.sounds = {};
        Object.keys(this.soundMap).forEach(key => {
          this.sounds[key] = this.createAudioElement(this.soundMap[key]);
        });
      }

      createAudioElement(filename) {
        const audio = new Audio(`../assets/media/sounds/kingdom-sounds/${filename}`);
        audio.volume = this.volume;
        audio.preload = 'auto';
        
        audio.addEventListener('error', (e) => {
          console.warn(`فشل في تحميل الصوت: ${filename}`);
        });
        
        return audio;
      }

      play(soundName, options = {}) {
        if (!this.soundEnabled) return;
        
        const audio = this.sounds[soundName];
        if (!audio) {
          console.warn(`الصوت غير موجود: ${soundName}`);
          return;
        }

        try {
          audio.currentTime = 0;
          audio.volume = options.volume || this.volume;
          
          const playPromise = audio.play();
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                if (options.onComplete) {
                  audio.addEventListener('ended', options.onComplete, { once: true });
                }
              })
              .catch(e => console.warn(`خطأ في تشغيل الصوت ${soundName}:`, e));
          }
        } catch (error) {
          console.warn(`فشل في تشغيل الصوت ${soundName}:`, error);
        }
      }
    }

    // نظام إدارة الحالة
    class GameState {
      constructor() {
        this.studentData = null;
        this.currentClass = '';
        this.gameMode = '';
        this.timeLimit = 60;
        this.maxLives = 3;
        this.targetStudent = '';
        this.allStudents = [];
        this.usedStudents = [];
        this.isLoading = false;
        
        this.stats = {
          score: 0,
          correctAnswers: 0,
          wrongAnswers: 0,
          streak: 0,
          lives: 3,
          gamesPlayed: 0
        };
      }

      reset() {
        this.currentClass = '';
        this.gameMode = '';
        this.targetStudent = '';
        this.allStudents = [];
        this.usedStudents = [];
        this.stats.lives = this.maxLives;
        this.stats.streak = 0;
      }

      updateStats(isCorrect, timeUsed = 0) {
        this.stats.gamesPlayed++;

        if (isCorrect) {
          this.stats.correctAnswers++;
          this.stats.streak++;
          this.stats.score += 10;
        } else {
          this.stats.wrongAnswers++;
          this.stats.streak = 0;
          this.stats.lives--;
        }
      }

      getSuccessRate() {
        if (this.stats.gamesPlayed === 0) return 0;
        return Math.round((this.stats.correctAnswers / this.stats.gamesPlayed) * 100);
      }
    }

    // نظام إدارة الرسائل
    class MessageSystem {
      constructor() {
        this.container = document.getElementById('messageArea');
      }

      show(message, type = 'info', duration = 5000) {
        this.clear();

        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        messageEl.innerHTML = message;

        this.container.appendChild(messageEl);

        if (duration > 0) {
          setTimeout(() => {
            this.clear();
          }, duration);
        }

        return messageEl;
      }

      clear() {
        this.container.innerHTML = '';
      }
    }

    // الفئة الرئيسية للعبة
    class WhoIsItGame {
      constructor() {
        this.state = new GameState();
        this.messages = new MessageSystem();
        this.soundSystem = new SoundSystem();
        this.init();
      }

      async init() {
        try {
          this.showLoading(true);
          await this.loadStudentData();
          this.setupEventListeners();
          this.showLoading(false);
          this.messages.show('✅ تم تحميل النظام بنجاح', 'success');
          this.soundSystem.play('notification');
        } catch (error) {
          this.showLoading(false);
          console.error('خطأ في تحميل البيانات:', error);
          this.messages.show('❌ لا يمكن تشغيل النشاط بدون ملف البيانات!', 'error');
          this.soundSystem.play('error');
        }
      }

      showLoading(show) {
        const loadingArea = document.getElementById('loadingArea');
        this.state.isLoading = show;
        
        if (show) {
          loadingArea.classList.add('active');
        } else {
          loadingArea.classList.remove('active');
        }
      }

      async loadStudentData() {
        try {
          this.messages.show('جاري تحميل بيانات الطلاب...', 'info', 10000);
          
          const res = await fetch('../data/studentData.json');
          if (!res.ok) {
            throw new Error('فشل في تحميل ملف البيانات');
          }
          this.state.studentData = await res.json();
          
          this.populateClassSelect();
          this.messages.clear();
          this.messages.show('تم تحميل بيانات الطلاب بنجاح! 🎓', 'success');
          
        } catch (error) {
          this.messages.show('خطأ في تحميل بيانات الطلاب: ' + error.message, 'error');
          this.soundSystem.play('wrong');
          
          // إضافة بيانات تجريبية في حالة فشل التحميل
          this.state.studentData = {
            "الأول": ["أحمد محمد سالم", "فاطمة علي خالد", "سالم خالد أحمد", "مريم سعيد محمد", "يوسف حمد علي"],
            "الثاني": ["نورا أحمد سالم", "محمد سالم يوسف", "آمنة يوسف حمد", "خالد محمد أحمد", "هناء علي سعيد"],
            "الثالث": ["عبدالله سعيد محمد", "زينب محمد علي", "طارق أحمد خالد", "رقية سالم يوسف", "حمد علي أحمد"],
            "الرابع": ["سعاد خالد محمد", "عمر محمد سالم", "ليلى أحمد علي", "ناصر سعيد حمد", "عائشة حمد يوسف"],
            "الخامس": ["إبراهيم علي سالم", "خديجة محمد أحمد", "سليمان خالد علي", "وردة سعيد محمد", "راشد حمد خالد"],
            "السادس": ["منى يوسف سالم", "عيسى محمد علي", "جميلة أحمد خالد", "بدر سعيد محمد", "نجاة علي حمد"]
          };
          
          this.populateClassSelect();
          this.messages.show('تم تحميل بيانات تجريبية بدلاً من الملف الأصلي', 'warning');
        }
      }

      populateClassSelect() {
        const classSelect = document.getElementById('classSelect');
        const startBtn = document.getElementById('startGameBtn');
        
        classSelect.innerHTML = '<option value="">اختر الصف</option>';

        const classes = Object.keys(this.state.studentData);

        classes.forEach(className => {
          const studentCount = this.state.studentData[className].length;
          const option = document.createElement('option');
          option.value = className;
          option.textContent = `${className} (${studentCount} طالب)`;
          classSelect.appendChild(option);
        });

        classSelect.addEventListener('change', () => {
          startBtn.disabled = !classSelect.value;
          
          if (classSelect.value) {
            const studentCount = this.state.studentData[classSelect.value].length;
            this.messages.show(`📚 تم اختيار "${classSelect.value}" - يحتوي على ${studentCount} طالب`, 'info', 3000);
          }
        });
      }

      setupEventListeners() {
        const startBtn = document.getElementById('startGameBtn');
        const classSelect = document.getElementById('classSelect');
        const modeSelect = document.getElementById('modeSelect');
        const timeSelect = document.getElementById('timeSelect');
        const livesSelect = document.getElementById('livesSelect');

        startBtn.addEventListener('click', () => this.startGame());

        timeSelect.addEventListener('change', () => {
          this.state.timeLimit = parseInt(timeSelect.value);
        });

        livesSelect.addEventListener('change', () => {
          this.state.maxLives = parseInt(livesSelect.value);
        });

        classSelect.addEventListener('change', () => {
          startBtn.disabled = !classSelect.value;
          
          if (classSelect.value) {
            const studentCount = this.state.studentData[classSelect.value].length;
            this.messages.show(`📚 تم اختيار "${classSelect.value}" - يحتوي على ${studentCount} طالب`, 'info', 3000);
          }
        });
      }

      startGame() {
        const classValue = document.getElementById('classSelect').value;
        const modeValue = document.getElementById('modeSelect').value;

        if (!classValue || !modeValue) {
          this.messages.show('⚠️ يرجى اختيار الصف ونمط اللعبة', 'warning');
          return;
        }

        this.state.currentClass = classValue;
        this.state.gameMode = modeValue;
        this.state.allStudents = this.state.studentData[classValue] || [];

        this.soundSystem.play('click');
        this.messages.show('🎯 بدء اللعبة...', 'info', 2000);
        
        setTimeout(() => {
          this.newRound();
        }, 1000);
      }

      newRound() {
        if (this.state.allStudents.length === 0) {
          this.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        const targetStudent = this.state.allStudents[Math.floor(Math.random() * this.state.allStudents.length)];
        this.state.targetStudent = targetStudent;

        this.displayGameInterface();
      }

      displayGameInterface() {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="current-student">
            من هو الطالب المُختار؟
          </div>
          
          <div class="students-grid">
            ${this.generateStudentOptions()}
          </div>
          
          <div class="game-buttons" style="margin-top: 20px;">
            <button onclick="game.newRound()" class="btn btn-primary">
              🔄 جولة جديدة
            </button>
            <button onclick="game.endGame()" class="btn btn-warning">
              🏁 إنهاء اللعبة
            </button>
          </div>
        `;

        this.soundSystem.play('reveal');
        this.messages.show(`🎯 اعثر على: ${this.state.targetStudent}`, 'info', 5000);
      }

      generateStudentOptions() {
        const shuffled = [...this.state.allStudents].sort(() => Math.random() - 0.5);
        const options = shuffled.slice(0, Math.min(8, shuffled.length));
        
        if (!options.includes(this.state.targetStudent)) {
          options[0] = this.state.targetStudent;
          options.sort(() => Math.random() - 0.5);
        }

        return options.map(student => `
          <div class="student-card" onclick="game.checkAnswer('${student}')">
            <div class="student-name">${student}</div>
          </div>
        `).join('');
      }

      checkAnswer(selectedStudent) {
        const isCorrect = selectedStudent === this.state.targetStudent;
        
        // تأثير بصري
        const cards = document.querySelectorAll('.student-card');
        cards.forEach(card => {
          const cardName = card.querySelector('.student-name').textContent;
          if (cardName === selectedStudent) {
            card.classList.add(isCorrect ? 'correct' : 'wrong');
          }
          if (cardName === this.state.targetStudent && !isCorrect) {
            card.classList.add('correct');
          }
        });

        if (isCorrect) {
          this.soundSystem.play('correct');
          this.state.updateStats(true);
          this.messages.show('🎉 ممتاز! إجابة صحيحة', 'success', 3000);
        } else {
          this.soundSystem.play('wrong');
          this.state.updateStats(false);
          this.messages.show(`❌ خطأ! الإجابة الصحيحة: ${this.state.targetStudent}`, 'error', 5000);
        }

        setTimeout(() => {
          if (this.state.stats.lives > 0) {
            this.newRound();
          } else {
            this.endGame();
          }
        }, 3000);
      }

      endGame() {
        this.soundSystem.play('notification');
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="result-display">
            🏆 انتهت اللعبة!
            <br><br>
            النقاط: ${this.state.stats.score}
            <br>
            الإجابات الصحيحة: ${this.state.stats.correctAnswers}
            <br>
            الإجابات الخاطئة: ${this.state.stats.wrongAnswers}
            <br>
            معدل النجاح: ${this.state.getSuccessRate()}%
          </div>
          
          <div class="game-buttons">
            <button onclick="game.resetGame()" class="btn btn-primary">
              🔄 لعبة جديدة
            </button>
          </div>
        `;
      }

      resetGame() {
        this.state.reset();
        const gameArea = document.getElementById('gameArea');
        gameArea.innerHTML = '<p><i class="fas fa-info-circle"></i> اختر الصف ونمط اللعبة لبدء التحدي</p>';
        this.messages.show('🎮 جاهز للعبة جديدة!', 'info', 3000);
      }
    }

    // إنشاء مثيل اللعبة
    let game;

    // بدء اللعبة عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      game = new WhoIsItGame();
      
      // إضافة تأثيرات تفاعلية
      document.addEventListener('click', (e) => {
        if (game && game.soundSystem) {
          game.soundSystem.play('click');
        }
      });
    });
  </script>
</body>
</html>
