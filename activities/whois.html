<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>من هو؟ - لعبة التفاعل الصفي</title>
  
  <!-- خطوط Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap');
    
    :root {
      /* الألوان الأساسية */
      --primary-color: #2c5aa0;
      --secondary-color: #34a85a;
      --accent-color: #f39c12;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --success-color: #27ae60;
      --info-color: #3498db;
      --text-color: #2c3e50;
      --white: #ffffff;
      
      /* ألوان التدرج */
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --gradient-royal: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-mystic: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-cosmic: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      
      /* ألوان البطاقات */
      --card-bg: #ffffff;
      --card-shadow: rgba(0, 0, 0, 0.1);
      --card-hover-shadow: rgba(0, 0, 0, 0.2);
      --card-border: #e1e8ed;
      
      /* متغيرات الحركة */
      --animation-speed: 0.3s;
      --bounce-animation: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --smooth-animation: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* الظلال المتقدمة */
      --neumorphism-light: #ffffff;
      --neumorphism-dark: #d1d9e6;
      --neumorphism-inset: inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #ffffff;
      --neumorphism-outset: 5px 5px 10px #d1d9e6, -5px -5px 10px #ffffff;
      
      /* ألوان الخلفية المتدرجة */
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --card-gradient: linear-gradient(145deg, #f0f2f5 0%, #ffffff 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      color: var(--text-color);
    }

    /* خلفية متحركة */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      animation: backgroundShift 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(180deg); }
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* زر العودة المتطور */
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--gradient-primary);
      color: var(--white);
      padding: 15px 25px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      box-shadow: var(--neumorphism-outset);
      transition: all var(--animation-speed) var(--bounce-animation);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .back-button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        var(--neumorphism-outset),
        0 15px 30px rgba(0,0,0,0.2);
    }

    /* تصميم العنوان المتطور */
    .header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }

    .main-title {
      font-size: clamp(2.5rem, 5vw, 4rem);
      font-weight: 800;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      animation: titleGlow 3s ease-in-out infinite;
      position: relative;
    }

    @keyframes titleGlow {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.05); filter: brightness(1.2); }
    }

    .subtitle {
      font-size: 1.3rem;
      color: #5a6c7d;
      font-weight: 500;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    /* بطاقة التحكم الرئيسية */
    .controls {
      background: var(--card-gradient);
      border-radius: 25px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--neumorphism-outset);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      transition: all var(--animation-speed) var(--smooth-animation);
      position: relative;
      overflow: hidden;
    }

    .controls::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-royal);
      border-radius: 25px 25px 0 0;
    }

    .controls:hover {
      transform: translateY(-5px);
      box-shadow: 
        var(--neumorphism-outset),
        0 20px 40px rgba(0,0,0,0.1);
    }

    /* مجموعات التحكم */
    .control-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      background: rgba(255,255,255,0.7);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--neumorphism-inset);
      transition: all var(--animation-speed) var(--bounce-animation);
    }

    .form-group:hover {
      transform: scale(1.02);
      background: rgba(255,255,255,0.9);
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    select, .form-control {
      width: 100%;
      padding: 12px 18px;
      border: 2px solid transparent;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      background: rgba(255,255,255,0.9);
      box-shadow: var(--neumorphism-inset);
      transition: all var(--animation-speed) var(--smooth-animation);
      font-weight: 500;
      color: var(--text-color);
    }

    select:focus, .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 
        var(--neumorphism-inset),
        0 0 0 3px rgba(44, 90, 160, 0.1);
      transform: scale(1.02);
    }

    /* أزرار اللعبة المتطورة */
    .game-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    button, .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      font-family: 'Cairo', sans-serif;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: var(--neumorphism-outset);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    button::before, .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    button:hover::before, .btn:hover::before {
      left: 100%;
    }

    button:hover:not(:disabled), .btn:hover:not(:disabled) {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        var(--neumorphism-outset),
        0 15px 30px rgba(0,0,0,0.2);
    }

    button:active, .btn:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: var(--white);
    }

    .btn-success {
      background: var(--gradient-success);
      color: var(--white);
    }

    .btn-warning {
      background: var(--gradient-warning);
      color: #2c3e50;
    }

    .btn-royal {
      background: var(--gradient-royal);
      color: var(--white);
    }

    .btn-mystic {
      background: var(--gradient-mystic);
      color: var(--white);
    }

    .btn-cosmic {
      background: var(--gradient-cosmic);
      color: #2c3e50;
    }

    /* بطاقات الاختيار المتطورة */
    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
      margin-top: 30px;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .student-card {
      background: var(--card-gradient);
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: var(--neumorphism-outset);
      position: relative;
      overflow: hidden;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .student-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-royal);
      transform: scaleX(0);
      transition: transform var(--animation-speed) var(--smooth-animation);
    }

    .student-card:hover::before {
      transform: scaleX(1);
    }

    .student-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 
        var(--neumorphism-outset),
        0 25px 50px rgba(0,0,0,0.15);
      border-color: var(--primary-color);
    }

    .student-card.selected {
      background: var(--gradient-success);
      color: var(--white);
      transform: scale(1.05);
      box-shadow: 
        0 20px 40px rgba(79, 172, 254, 0.3),
        inset 0 0 20px rgba(255,255,255,0.2);
    }

    .student-card.correct {
      background: var(--gradient-success);
      color: var(--white);
      animation: correctPulse 0.6s ease-in-out;
    }

    .student-card.wrong {
      background: var(--gradient-secondary);
      color: var(--white);
      animation: wrongShake 0.6s ease-in-out;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .student-name {
      font-size: 1.2rem;
      font-weight: 600;
      line-height: 1.4;
      position: relative;
      z-index: 2;
    }

    /* منطقة اللعبة */
    .game-area {
      background: var(--card-gradient);
      border-radius: 25px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--neumorphism-outset);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .current-student {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      padding: 20px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: var(--neumorphism-inset);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    /* نظام الرسائل المتطور */
    .messages {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }

    .message {
      background: var(--card-gradient);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: var(--neumorphism-outset);
      border-left: 5px solid var(--primary-color);
      backdrop-filter: blur(10px);
      animation: messageSlide 0.5s var(--bounce-animation);
      position: relative;
      overflow: hidden;
    }

    @keyframes messageSlide {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .message.success {
      border-left-color: var(--success-color);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.error {
      border-left-color: var(--danger-color);
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.warning {
      border-left-color: var(--warning-color);
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    .message.info {
      border-left-color: var(--info-color);
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(255,255,255,0.9) 100%);
    }

    /* شاشة التحميل المتطورة */
    .loading-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }

    .loading-area.active {
      display: flex;
    }

    .loading-content {
      text-align: center;
      color: var(--white);
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* النتائج */
    .result-display {
      background: var(--gradient-success);
      color: var(--white);
      padding: 2rem;
      border-radius: 20px;
      margin: 2rem 0;
      font-size: 1.2rem;
      font-weight: 600;
      box-shadow: var(--neumorphism-outset);
      animation: celebrate 1s ease-in-out;
      text-align: center;
      line-height: 1.6;
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .game-interface {
      width: 100%;
    }

    .student-card.correct::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      color: var(--white);
      font-weight: 900;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
      animation: checkMark 1.2s ease-out;
      z-index: 10;
    }

    @keyframes checkMark {
      0% { 
        transform: translate(-50%, -50%) scale(0) rotateZ(-180deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2) rotateZ(-90deg);
        opacity: 1;
      }
      100% { 
        transform: translate(-50%, -50%) scale(1) rotateZ(0deg);
        opacity: 1;
      }
    }

    .student-card.wrong::after {
      content: '✗';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      color: var(--white);
      font-weight: 900;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
      animation: wrongMark 1s ease-out;
      z-index: 10;
    }

    @keyframes wrongMark {
      0% { 
        transform: translate(-50%, -50%) scale(0) rotateZ(180deg);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2) rotateZ(90deg);
        opacity: 1;
      }
      100% { 
        transform: translate(-50%, -50%) scale(1) rotateZ(0deg);
        opacity: 1;
      }
    }

    /* الفئات المساعدة */
    .hidden {
      display: none !important;
    }

    /* واجهة تجميع الأسماء */
    .assemble-interface {
      text-align: center;
      padding: 20px;
    }

    .assemble-title {
      font-size: 2rem;
      font-weight: 700;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      padding: 15px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: var(--neumorphism-inset);
    }

    .level-indicator {
      background: var(--gradient-success);
      color: var(--white);
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
      margin-bottom: 20px;
      display: inline-block;
      box-shadow: var(--neumorphism-outset);
    }

    .name-parts-container {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 30px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .original-name {
      font-size: 1.5rem;
      font-weight: 600;
      color: #5a6c7d;
      margin-bottom: 20px;
      opacity: 0.7;
    }

    .shuffled-parts {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      min-height: 100px;
      padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      border: 2px dashed rgba(255,255,255,0.3);
    }

    .ordered-parts {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      min-height: 100px;
      padding: 20px;
      background: rgba(79, 172, 254, 0.1);
      border-radius: 15px;
      border: 2px dashed var(--primary-color);
    }

    .name-part {
      background: var(--card-gradient);
      border: 2px solid var(--primary-color);
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: grab;
      transition: all var(--animation-speed) var(--bounce-animation);
      box-shadow: var(--neumorphism-outset);
      user-select: none;
      position: relative;
      min-width: 100px;
      text-align: center;
    }

    .name-part:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        var(--neumorphism-outset),
        0 10px 20px rgba(0,0,0,0.15);
      border-color: var(--success-color);
    }

    .name-part:active {
      cursor: grabbing;
      transform: scale(0.95);
    }

    .name-part.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }

    .drop-zone {
      min-height: 80px;
      border: 2px dashed var(--primary-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
      transition: all var(--animation-speed) var(--smooth-animation);
      background: rgba(255,255,255,0.05);
    }

    .drop-zone.dragover {
      border-color: var(--success-color);
      background: rgba(79, 172, 254, 0.1);
      transform: scale(1.02);
    }

    .assemble-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient-success);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }

    .stats-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-item {
      background: var(--card-gradient);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      box-shadow: var(--neumorphism-inset);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #5a6c7d;
      margin-top: 5px;
    }

    /* واجهة اختيار الطلاب - الوضع الانتقائي */
    .student-selection-interface {
      text-align: center;
      padding: 20px;
      width: 100%;
    }

    .selection-title {
      font-size: 2.2rem;
      font-weight: 700;
      background: var(--gradient-royal);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      padding: 15px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: var(--neumorphism-inset);
    }

    .selection-subtitle {
      font-size: 1.1rem;
      color: #5a6c7d;
      margin-bottom: 30px;
      font-weight: 500;
    }

    .selection-methods {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .method-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 25px;
    }

    .method-tab {
      background: rgba(255,255,255,0.7);
      border: 2px solid transparent;
      border-radius: 25px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      font-family: 'Cairo', sans-serif;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      box-shadow: var(--neumorphism-outset);
    }

    .method-tab:hover {
      transform: translateY(-2px);
      box-shadow: 
        var(--neumorphism-outset),
        0 10px 20px rgba(0,0,0,0.15);
    }

    .method-tab.active {
      background: var(--gradient-primary);
      color: var(--white);
      border-color: var(--primary-color);
      transform: scale(1.05);
    }

    .selection-content {
      min-height: 300px;
      padding: 20px;
    }

    /* بطاقات اختيار الطلاب */
    .student-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      padding: 10px;
    }

    .student-selection-card {
      background: var(--card-gradient);
      border-radius: 18px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-animation);
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: var(--neumorphism-outset);
      position: relative;
      overflow: hidden;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .student-selection-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-success);
      transform: scaleX(0);
      transition: transform var(--animation-speed) var(--smooth-animation);
    }

    .student-selection-card:hover::before {
      transform: scaleX(1);
    }

    .student-selection-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 
        var(--neumorphism-outset),
        0 25px 50px rgba(0,0,0,0.15);
      border-color: var(--success-color);
    }

    .student-avatar {
      width: 60px;
      height: 60px;
      background: var(--gradient-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      color: var(--white);
      font-size: 1.8rem;
      box-shadow: var(--neumorphism-outset);
    }

    .student-selection-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .selection-badge {
      background: var(--gradient-success);
      color: var(--white);
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0.8;
      transition: all var(--animation-speed) var(--smooth-animation);
    }

    .student-selection-card:hover .selection-badge {
      opacity: 1;
      transform: scale(1.1);
    }

    /* قائمة اختيار الطلاب */
    .student-selection-list {
      background: rgba(255,255,255,0.7);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--neumorphism-inset);
      max-height: 400px;
      overflow-y: auto;
    }

    .list-header {
      background: var(--gradient-primary);
      color: var(--white);
      padding: 15px 20px;
      font-weight: 600;
      font-size: 1.1rem;
      text-align: center;
    }

    .student-count {
      background: rgba(255,255,255,0.2);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .student-list-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.5);
      cursor: pointer;
      transition: all var(--animation-speed) var(--smooth-animation);
      position: relative;
    }

    .student-list-item:hover {
      background: rgba(79, 172, 254, 0.1);
      transform: translateX(5px);
    }

    .student-list-item:last-child {
      border-bottom: none;
    }

    .student-number {
      width: 40px;
      height: 40px;
      background: var(--gradient-royal);
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      margin-left: 15px;
      box-shadow: var(--neumorphism-outset);
    }

    .student-list-name {
      flex: 1;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
      text-align: right;
    }

    .select-button {
      background: var(--gradient-success);
      color: var(--white);
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all var(--animation-speed) var(--bounce-animation);
      box-shadow: var(--neumorphism-outset);
    }

    .student-list-item:hover .select-button {
      transform: scale(1.1);
      box-shadow: 
        var(--neumorphism-outset),
        0 10px 20px rgba(0,0,0,0.15);
    }

    .selection-controls {
      margin-top: 25px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* واجهة الوضع الانتقائي */
    .manual-game-interface {
      width: 100%;
      padding: 20px;
    }

    .target-student-display {
      background: var(--gradient-royal);
      color: var(--white);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: var(--neumorphism-outset);
      animation: pulse 2s infinite;
    }

    .target-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 15px;
      opacity: 0.9;
    }

    .target-name {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .target-instruction {
      font-size: 1.1rem;
      opacity: 0.8;
      font-weight: 500;
    }

    /* واجهة إخفاء الطالب المستهدف */
    .hidden-target {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      border: 2px dashed rgba(255, 255, 255, 0.3);
    }

    .secret-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      opacity: 0.7;
    }

    .secret-text {
      font-size: 1.2rem;
      margin-bottom: 15px;
      opacity: 0.8;
      font-weight: 500;
    }

    .reveal-btn, .hide-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: var(--white);
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--animation-speed) var(--smooth-animation);
      font-family: 'Cairo', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .reveal-btn:hover, .hide-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .revealed-target {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .revealed-target .target-name {
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 12px;
    }

    .hide-btn {
      background: rgba(231, 76, 60, 0.2);
      border-color: rgba(231, 76, 60, 0.3);
    }

    .hide-btn:hover {
      background: rgba(231, 76, 60, 0.3);
    }

    .game-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-gradient);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: var(--neumorphism-outset);
      transition: all var(--animation-speed) var(--bounce-animation);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 
        var(--neumorphism-outset),
        0 15px 30px rgba(0,0,0,0.15);
    }

    .stat-card.lives {
      border-left: 5px solid var(--danger-color);
    }

    .stat-card.attempts {
      border-left: 5px solid var(--info-color);
    }

    .stat-card.correct {
      border-left: 5px solid var(--success-color);
    }

    .stat-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .stat-card .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stat-card .stat-label {
      font-size: 0.9rem;
      color: #5a6c7d;
      font-weight: 500;
    }

    .manual-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    /* النوافذ المنبثقة الاحترافية */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .modal-content {
      background: var(--card-gradient);
      border-radius: 25px;
      padding: 40px;
      text-align: center;
      box-shadow: 
        var(--neumorphism-outset),
        0 30px 60px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      max-width: 500px;
      width: 90%;
      animation: modalSlideIn 0.4s var(--bounce-animation);
    }

    @keyframes modalSlideIn {
      from {
        transform: scale(0.7) translateY(-50px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    /* نافذة النجاح */
    .success-content {
      background: linear-gradient(135deg, var(--success-color) 0%, var(--primary-color) 100%);
      color: var(--white);
    }

    .success-animation {
      position: relative;
      margin-bottom: 25px;
    }

    .success-icon {
      font-size: 4rem;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-20px);
      }
      60% {
        transform: translateY(-10px);
      }
    }

    .success-confetti {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 2px, transparent 2px);
      background-size: 20px 20px;
      animation: confettiRain 2s infinite;
    }

    @keyframes confettiRain {
      0% {
        transform: translateX(-50%) translateY(-20px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateX(-50%) translateY(100px) rotate(360deg);
        opacity: 0;
      }
    }

    .success-title {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .winner-name {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 15px;
    }

    .success-message {
      font-size: 1.2rem;
      margin-bottom: 25px;
      opacity: 0.9;
    }

    /* نافذة الكشف */
    .reveal-content {
      background: linear-gradient(135deg, var(--warning-color) 0%, var(--danger-color) 100%);
      color: var(--white);
    }

    .reveal-animation {
      margin-bottom: 25px;
    }

    .reveal-icon {
      font-size: 4rem;
      animation: reveal 2s ease-in-out;
    }

    @keyframes reveal {
      0%, 100% {
        transform: scale(1) rotate(0deg);
      }
      25% {
        transform: scale(1.1) rotate(-10deg);
      }
      75% {
        transform: scale(1.1) rotate(10deg);
      }
    }

    .reveal-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .revealed-name {
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.2);
      padding: 15px 25px;
      border-radius: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .reveal-message {
      font-size: 1.1rem;
      margin-bottom: 25px;
      opacity: 0.9;
    }

    /* إحصائيات النوافذ */
    .success-stats, .reveal-stats {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .success-stats .stat, .reveal-stats .stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .success-stats .stat:last-child, .reveal-stats .stat:last-child {
      margin-bottom: 0;
    }

    .stat-label {
      font-weight: 500;
    }

    .stat-value {
      font-weight: 700;
    }

    /* أزرار النوافذ */
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .modal-buttons .btn {
      min-width: 150px;
    }

    /* تحسينات الاستجابة */
    @media (max-width: 768px) {
      .main-container {
        padding: 15px;
      }

      .main-title {
        font-size: 2.5rem;
      }

      .controls {
        padding: 20px;
      }

      .control-group {
        grid-template-columns: 1fr;
      }

      .students-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
      }

      .student-card {
        padding: 20px;
        min-height: 120px;
      }

      .messages {
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .back-button {
        top: 10px;
        left: 10px;
        padding: 12px 20px;
      }

      /* تحسينات تجميع الأسماء للهواتف */
      .assemble-title {
        font-size: 1.5rem;
      }

      .shuffled-parts, .ordered-parts {
        flex-direction: column;
        align-items: center;
      }

      .name-part {
        width: 90%;
        max-width: 200px;
      }

      .assemble-controls {
        flex-direction: column;
        gap: 10px;
      }

      .assemble-controls .btn {
        width: 100%;
        max-width: 300px;
      }

      .stats-display {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      /* تحسينات واجهة اختيار الطلاب للهواتف */
      .selection-title {
        font-size: 1.6rem;
      }

      .method-tabs {
        flex-direction: column;
        gap: 8px;
      }

      .method-tab {
        width: 100%;
        max-width: 250px;
        margin: 0 auto;
      }

      .student-selection-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
      }

      .student-selection-card {
        padding: 15px;
        min-height: 140px;
      }

      .student-avatar {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }

      .student-list-item {
        padding: 12px 15px;
      }

      .student-number {
        width: 35px;
        height: 35px;
        font-size: 0.8rem;
      }

      .student-list-name {
        font-size: 1rem;
      }

      .select-button {
        padding: 6px 15px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .main-title {
        font-size: 2rem;
      }

      .students-grid {
        grid-template-columns: 1fr;
      }

      .student-card {
        min-height: 100px;
      }

      .current-student {
        font-size: 2rem;
      }

      .assemble-title {
        font-size: 1.3rem;
      }

      .name-part {
        font-size: 1rem;
        padding: 10px 15px;
      }

      .level-indicator {
        font-size: 0.9rem;
        padding: 8px 15px;
      }

      /* تحسينات إضافية لواجهة اختيار الطلاب */
      .selection-title {
        font-size: 1.4rem;
      }

      .student-selection-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .student-selection-card {
        min-height: 120px;
        padding: 12px;
      }

      .student-avatar {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
        margin-bottom: 10px;
      }

      .student-selection-name {
        font-size: 1rem;
      }

      .selection-badge {
        font-size: 0.8rem;
        padding: 5px 12px;
      }

      .student-selection-list {
        max-height: 300px;
      }

      .list-header {
        padding: 12px 15px;
        font-size: 1rem;
      }

      .student-count {
        font-size: 0.8rem;
        padding: 4px 12px;
      }

      /* تحسينات النوافذ للهواتف */
      .modal-content {
        padding: 25px;
        max-width: 95%;
      }

      .success-title, .reveal-title {
        font-size: 2rem;
      }

      .winner-name, .revealed-name {
        font-size: 1.6rem;
        padding: 8px 15px;
      }

      .success-message, .reveal-message {
        font-size: 1rem;
      }

      .modal-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .modal-buttons .btn {
        width: 100%;
        min-width: auto;
      }

      .target-name {
        font-size: 2rem;
      }

      .game-stats {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .manual-controls {
        flex-direction: column;
        gap: 15px;
      }

      .manual-controls .btn {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
      }

      /* تحسينات إخفاء الطالب للهواتف */
      .hidden-target, .revealed-target {
        padding: 15px;
        margin: 10px 0;
      }

      .secret-icon {
        font-size: 2.5rem;
      }

      .secret-text {
        font-size: 1rem;
      }

      .reveal-btn, .hide-btn {
        padding: 8px 15px;
        font-size: 0.8rem;
      }

      .revealed-target .target-name {
        font-size: 1.8rem;
        padding: 8px 15px;
      }
    }
  </style>
</head>
<body>
  <!-- شاشة التحميل -->
  <div class="loading-area" id="loadingArea">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">جاري التحميل...</div>
    </div>
  </div>

  <!-- نظام الرسائل -->
  <div class="messages" id="messages"></div>

  <!-- زر العودة -->
  <a href="../index.html" class="back-button">
    <i class="fas fa-arrow-right"></i>
    العودة للقائمة الرئيسية
  </a>

  <!-- الحاوية الرئيسية -->
  <div class="main-container">
    <!-- رأس الصفحة -->
    <div class="header">
      <h1 class="main-title">🎯 من هو؟</h1>
      <p class="subtitle">لعبة تفاعلية لتخمين هوية الطلاب مع النظام الصوتي المتقدم</p>
    </div>

    <!-- أدوات التحكم الرئيسية -->
    <div class="controls">
      <div class="control-group">
        <div class="form-group">
          <label for="classSelect">📚 اختيار الصف</label>
          <select id="classSelect" class="form-control">
            <option value="">اختر الصف الدراسي</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="modeSelect">🎮 وضع اللعبة</label>
          <select id="modeSelect" class="form-control">
            <option value="random">🎲 فردي عشوائي</option>
            <option value="manual">🎯 فردي انتقائي</option>
            <option value="challenge">⏰ تحدي زمني</option>
            <option value="survival">🔥 وضع البقاء</option>
            <option value="team">👥 فريق ضد فريق</option>
            <option value="assemble">🧩 تجميع أجزاء الاسم</option>
          </select>
        </div>
      </div>

      <div class="control-group">
        <div class="form-group">
          <label for="timeSelect">⏱️ الوقت المحدد</label>
          <select id="timeSelect" class="form-control">
            <option value="0">🚫 بلا وقت محدد</option>
            <option value="30">⚡ 30 ثانية</option>
            <option value="60">🟢 60 ثانية</option>
            <option value="120">🟡 120 ثانية</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="livesSelect">❤️ عدد المحاولات</label>
          <select id="livesSelect" class="form-control">
            <option value="1">❤️ محاولة واحدة</option>
            <option value="3">💕 3 محاولات</option>
            <option value="5">💖 5 محاولات</option>
            <option value="-1">💝 محاولات لا نهائية</option>
          </select>
        </div>
      </div>

      <!-- أزرار بدء اللعبة -->
      <div class="game-buttons">
        <button id="startGameBtn" class="btn btn-primary" disabled>
          <i class="fas fa-play"></i>
          🎲 بدء اللعبة
        </button>
        <button id="settingsBtn" class="btn btn-cosmic">
          <i class="fas fa-cog"></i>
          ⚙️ الإعدادات
        </button>
      </div>
    </div>

    <!-- منطقة الرسائل -->
    <div id="messageArea"></div>

    <!-- منطقة اللعبة -->
    <div class="game-area" id="gameArea">
      <p><i class="fas fa-info-circle"></i> اختر الصف ونمط اللعبة لبدء التحدي</p>
    </div>
  </div>

  <script>
    // نظام الصوتيات المتقدم
    class SoundSystem {
      constructor() {
        this.sounds = {};
        this.musicEnabled = true;
        this.soundEnabled = true;
        this.volume = 0.6;
        this.initializeSounds();
      }

      initializeSounds() {
        this.soundMap = {
          'click': 'cosmic-click.mp3',
          'correct': 'epic-victory.mp3',
          'wrong': 'point-lose.mp3',
          'reveal': 'knowledge-unlock.mp3',
          'notification': 'ai-notification.mp3',
          'success': 'crystal-bonus.mp3',
          'error': 'shield-block.mp3'
        };

        this.sounds = {};
        Object.keys(this.soundMap).forEach(key => {
          this.sounds[key] = this.createAudioElement(this.soundMap[key]);
        });
      }

      createAudioElement(filename) {
        const audio = new Audio(`../assets/media/sounds/kingdom-sounds/${filename}`);
        audio.volume = this.volume;
        audio.preload = 'auto';
        
        audio.addEventListener('error', (e) => {
          console.warn(`فشل في تحميل الصوت: ${filename}`);
        });
        
        return audio;
      }

      play(soundName, options = {}) {
        if (!this.soundEnabled) return;
        
        const audio = this.sounds[soundName];
        if (!audio) {
          console.warn(`الصوت غير موجود: ${soundName}`);
          return;
        }

        try {
          audio.currentTime = 0;
          audio.volume = options.volume || this.volume;
          
          const playPromise = audio.play();
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                if (options.onComplete) {
                  audio.addEventListener('ended', options.onComplete, { once: true });
                }
              })
              .catch(e => console.warn(`خطأ في تشغيل الصوت ${soundName}:`, e));
          }
        } catch (error) {
          console.warn(`فشل في تشغيل الصوت ${soundName}:`, error);
        }
      }
    }

    // نظام إدارة الحالة
    class GameState {
      constructor() {
        this.studentData = null;
        this.currentClass = '';
        this.gameMode = '';
        this.timeLimit = 60;
        this.maxLives = 3;
        this.targetStudent = '';
        this.allStudents = [];
        this.usedStudents = [];
        this.isLoading = false;
        
        this.stats = {
          score: 0,
          correctAnswers: 0,
          wrongAnswers: 0,
          streak: 0,
          lives: 3,
          gamesPlayed: 0
        };
      }

      reset() {
        this.currentClass = '';
        this.gameMode = '';
        this.targetStudent = '';
        this.allStudents = [];
        this.usedStudents = [];
        this.stats.lives = this.maxLives;
        this.stats.streak = 0;
      }

      updateStats(isCorrect, timeUsed = 0) {
        this.stats.gamesPlayed++;

        if (isCorrect) {
          this.stats.correctAnswers++;
          this.stats.streak++;
          this.stats.score += 10;
        } else {
          this.stats.wrongAnswers++;
          this.stats.streak = 0;
          this.stats.lives--;
        }
      }

      getSuccessRate() {
        if (this.stats.gamesPlayed === 0) return 0;
        return Math.round((this.stats.correctAnswers / this.stats.gamesPlayed) * 100);
      }
    }

    // نظام إدارة الرسائل
    class MessageSystem {
      constructor() {
        this.container = document.getElementById('messageArea');
      }

      show(message, type = 'info', duration = 5000) {
        this.clear();

        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        messageEl.innerHTML = message;

        this.container.appendChild(messageEl);

        if (duration > 0) {
          setTimeout(() => {
            this.clear();
          }, duration);
        }

        return messageEl;
      }

      clear() {
        this.container.innerHTML = '';
      }
    }

    // نظام تجميع الأسماء
    class NameAssemblyGame {
      constructor(gameInstance) {
        this.game = gameInstance;
        this.currentLevel = 1;
        this.maxLevel = 3;
        this.currentName = '';
        this.nameParts = [];
        this.shuffledParts = [];
        this.orderedParts = [];
        this.correctAnswers = 0;
        this.totalAttempts = 0;
        this.requiredCorrectForNext = 3;
        
        this.draggedElement = null;
      }

      start() {
        this.currentLevel = 1;
        this.correctAnswers = 0;
        this.totalAttempts = 0;
        this.setupNewRound();
      }

      setupNewRound() {
        // اختيار اسم عشوائي
        const students = this.game.state.allStudents;
        if (!students || students.length === 0) {
          this.game.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        this.currentName = students[Math.floor(Math.random() * students.length)];
        this.generateNameParts();
        this.displayInterface();
      }

      generateNameParts() {
        const fullNameParts = this.currentName.trim().split(/\s+/);
        
        // إزالة كلمات "بن" و "بنت" من أجزاء الاسم
        const filteredParts = fullNameParts.filter(part => 
          part !== 'بن' && part !== 'بنت' && part.trim() !== ''
        );
        
        // تحديد أجزاء الاسم حسب المستوى
        switch(this.currentLevel) {
          case 1: // الاسم الأول + الثاني
            this.nameParts = filteredParts.slice(0, 2);
            break;
          case 2: // الاسم الأول + الثاني + الثالث
            this.nameParts = filteredParts.slice(0, 3);
            break;
          case 3: // الاسم الكامل (بدون بن/بنت)
            this.nameParts = filteredParts;
            break;
        }

        // التأكد من وجود أجزاء كافية
        if (this.nameParts.length === 0) {
          // في حالة عدم وجود أجزاء صالحة، استخدم الاسم الأصلي
          this.nameParts = [this.currentName];
        }

        // خلط الأجزاء
        this.shuffledParts = [...this.nameParts].sort(() => Math.random() - 0.5);
        this.orderedParts = [];
      }

      displayInterface() {
        const gameArea = document.getElementById('gameArea');
        
        // إنشاء عرض الاسم الأصلي مع إزالة بن/بنت للتوضيح
        const filteredName = this.currentName.split(/\s+/)
          .filter(part => part !== 'بن' && part !== 'بنت' && part.trim() !== '')
          .join(' ');
        
        gameArea.innerHTML = `
          <div class="assemble-interface">
            <div class="assemble-title">🧩 جمع أجزاء الاسم</div>
            
            <div class="level-indicator">
              المرحلة ${this.currentLevel} من ${this.maxLevel}
              ${this.getLevelDescription()}
            </div>

            <div class="stats-display">
              <div class="stat-item">
                <div class="stat-value">${this.correctAnswers}</div>
                <div class="stat-label">إجابات صحيحة</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${this.totalAttempts}</div>
                <div class="stat-label">إجمالي المحاولات</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${this.requiredCorrectForNext - this.correctAnswers}</div>
                <div class="stat-label">متبقي للمرحلة التالية</div>
              </div>
            </div>

            <div class="progress-bar">
              <div class="progress-fill" style="width: ${(this.correctAnswers / this.requiredCorrectForNext) * 100}%"></div>
            </div>

            <div class="name-parts-container">
              <div class="original-name">رتب الأجزاء لتكوين الاسم الصحيح</div>
              
              <div class="shuffled-parts" id="shuffledParts">
                ${this.shuffledParts.map((part, index) => 
                  `<div class="name-part" draggable="true" data-part="${part}" data-index="${index}">
                    ${part}
                  </div>`
                ).join('')}
              </div>

              <div class="ordered-parts" id="orderedParts"></div>
            </div>

            <div class="assemble-controls">
              <button onclick="nameAssembly.checkOrder()" class="btn btn-success">
                <i class="fas fa-check"></i>
                ✅ تحقق من الترتيب
              </button>
              <button onclick="nameAssembly.resetOrder()" class="btn btn-warning">
                <i class="fas fa-undo"></i>
                🔄 إعادة ترتيب
              </button>
              <button onclick="nameAssembly.skipRound()" class="btn btn-cosmic">
                <i class="fas fa-forward"></i>
                ⏭️ تخطي
              </button>
              <button onclick="game.resetGame()" class="btn btn-primary">
                <i class="fas fa-home"></i>
                🏠 العودة للقائمة
              </button>
            </div>
          </div>
        `;

        this.setupDragAndDrop();
        this.game.soundSystem.play('reveal');
        this.game.messages.show(`🎯 رتب أجزاء الاسم: ${filteredName}`, 'info', 5000);
      }

      getLevelDescription() {
        switch(this.currentLevel) {
          case 1: return '(الاسم الأول + الثاني)';
          case 2: return '(الاسم الأول + الثاني + الثالث)';
          case 3: return '(الاسم الكامل)';
          default: return '';
        }
      }

      setupDragAndDrop() {
        const shuffledContainer = document.getElementById('shuffledParts');
        const orderedContainer = document.getElementById('orderedParts');

        // إعداد الأجزاء القابلة للسحب
        const parts = shuffledContainer.querySelectorAll('.name-part');
        parts.forEach(part => {
          part.addEventListener('dragstart', (e) => {
            this.draggedElement = e.target;
            e.target.classList.add('dragging');
            this.game.soundSystem.play('click');
          });

          part.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            this.draggedElement = null;
          });

          // إضافة دعم اللمس للأجهزة المحمولة
          part.addEventListener('click', () => {
            this.handlePartClick(part);
          });
        });

        // إعداد منطقة الإسقاط
        [shuffledContainer, orderedContainer].forEach(container => {
          container.addEventListener('dragover', (e) => {
            e.preventDefault();
            container.classList.add('dragover');
          });

          container.addEventListener('dragleave', () => {
            container.classList.remove('dragover');
          });

          container.addEventListener('drop', (e) => {
            e.preventDefault();
            container.classList.remove('dragover');
            
            if (this.draggedElement && container === orderedContainer) {
              this.movePartToOrdered(this.draggedElement);
            } else if (this.draggedElement && container === shuffledContainer) {
              this.movePartToShuffled(this.draggedElement);
            }
          });
        });
      }

      handlePartClick(part) {
        this.game.soundSystem.play('click');
        
        if (part.parentElement.id === 'shuffledParts') {
          this.movePartToOrdered(part);
        } else {
          this.movePartToShuffled(part);
        }
      }

      movePartToOrdered(part) {
        const orderedContainer = document.getElementById('orderedParts');
        const partText = part.dataset.part;
        
        if (!this.orderedParts.includes(partText)) {
          this.orderedParts.push(partText);
          orderedContainer.appendChild(part.cloneNode(true));
          part.remove();
          
          // إعادة إعداد الأحداث للعنصر الجديد
          const newPart = orderedContainer.lastElementChild;
          newPart.addEventListener('click', () => {
            this.handlePartClick(newPart);
          });
          
          this.game.soundSystem.play('notification');
        }
      }

      movePartToShuffled(part) {
        const shuffledContainer = document.getElementById('shuffledParts');
        const partText = part.dataset.part;
        
        // إزالة من المرتب
        this.orderedParts = this.orderedParts.filter(p => p !== partText);
        shuffledContainer.appendChild(part.cloneNode(true));
        part.remove();
        
        // إعادة إعداد الأحداث للعنصر الجديد
        const newPart = shuffledContainer.lastElementChild;
        newPart.addEventListener('click', () => {
          this.handlePartClick(newPart);
        });
        
        this.game.soundSystem.play('click');
      }

      checkOrder() {
        if (this.orderedParts.length === 0) {
          this.game.messages.show('⚠️ يرجى ترتيب أجزاء الاسم أولاً', 'warning');
          return;
        }

        const userOrder = this.orderedParts.join(' ');
        const correctOrder = this.nameParts.join(' ');
        const isCorrect = userOrder === correctOrder;
        
        this.totalAttempts++;

        if (isCorrect) {
          this.correctAnswers++;
          this.game.soundSystem.play('correct');
          this.game.messages.show('🎉 ممتاز! الترتيب صحيح', 'success', 3000);
          
          // تأثير بصري للنجاح
          this.celebrateSuccess();
          
          if (this.correctAnswers >= this.requiredCorrectForNext) {
            setTimeout(() => {
              this.levelUp();
            }, 2000);
          } else {
            setTimeout(() => {
              this.setupNewRound();
            }, 2000);
          }
        } else {
          this.game.soundSystem.play('wrong');
          
          // إنشاء عرض الاسم المفلتر للرسالة
          const filteredName = this.currentName.split(/\s+/)
            .filter(part => part !== 'بن' && part !== 'بنت' && part.trim() !== '')
            .join(' ');
          
          this.game.messages.show(`❌ خطأ! الترتيب الصحيح: ${correctOrder}`, 'error', 5000);
          
          // إظهار الإجابة الصحيحة
          setTimeout(() => {
            this.showCorrectAnswer();
          }, 1000);
          
          setTimeout(() => {
            this.setupNewRound();
          }, 4000);
        }
      }

      celebrateSuccess() {
        // إضافة تأثير الاحتفال
        const parts = document.querySelectorAll('#orderedParts .name-part');
        parts.forEach((part, index) => {
          setTimeout(() => {
            part.style.animation = 'correctPulse 0.6s ease-in-out';
          }, index * 100);
        });

        // إطلاق الألعاب النارية إذا كانت متوفرة
        if (typeof confetti !== 'undefined') {
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
          });
        }
      }

      showCorrectAnswer() {
        const orderedContainer = document.getElementById('orderedParts');
        orderedContainer.innerHTML = this.nameParts.map(part => 
          `<div class="name-part" style="background: var(--gradient-success); color: white;">
            ${part}
          </div>`
        ).join('');
      }

      resetOrder() {
        this.orderedParts = [];
        const orderedContainer = document.getElementById('orderedParts');
        const shuffledContainer = document.getElementById('shuffledParts');
        
        // إعادة جميع الأجزاء للحاوية المخلوطة
        orderedContainer.innerHTML = '';
        shuffledContainer.innerHTML = this.shuffledParts.map((part, index) => 
          `<div class="name-part" draggable="true" data-part="${part}" data-index="${index}">
            ${part}
          </div>`
        ).join('');
        
        this.setupDragAndDrop();
        this.game.soundSystem.play('notification');
        this.game.messages.show('🔄 تم إعادة ترتيب الأجزاء', 'info', 2000);
      }

      skipRound() {
        this.game.soundSystem.play('click');
        this.game.messages.show('⏭️ تم تخطي الجولة', 'info', 2000);
        this.setupNewRound();
      }

      levelUp() {
        if (this.currentLevel < this.maxLevel) {
          this.currentLevel++;
          this.correctAnswers = 0;
          this.game.soundSystem.play('success');
          this.game.messages.show(`🎊 تهانينا! انتقلت للمرحلة ${this.currentLevel}`, 'success', 4000);
          
          setTimeout(() => {
            this.setupNewRound();
          }, 2000);
        } else {
          this.completeGame();
        }
      }

      completeGame() {
        this.game.soundSystem.play('success');
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="result-display">
            🏆 تهانينا! أكملت جميع المراحل!
            <br><br>
            إجمالي الإجابات الصحيحة: ${this.correctAnswers + (this.requiredCorrectForNext * (this.maxLevel - 1))}
            <br>
            إجمالي المحاولات: ${this.totalAttempts}
            <br>
            معدل النجاح: ${Math.round(((this.correctAnswers + (this.requiredCorrectForNext * (this.maxLevel - 1))) / this.totalAttempts) * 100)}%
          </div>
          
          <div class="game-buttons">
            <button onclick="nameAssembly.start()" class="btn btn-primary">
              🔄 لعب مرة أخرى
            </button>
            <button onclick="game.resetGame()" class="btn btn-cosmic">
              🏠 العودة للقائمة
            </button>
          </div>
        `;

        // إطلاق احتفال كبير
        if (typeof confetti !== 'undefined') {
          confetti({
            particleCount: 200,
            spread: 100,
            origin: { y: 0.4 }
          });
        }
      }
    }

    // الفئة الرئيسية للعبة
    class WhoIsItGame {
      constructor() {
        this.state = new GameState();
        this.messages = new MessageSystem();
        this.soundSystem = new SoundSystem();
        this.nameAssembly = new NameAssemblyGame(this);
        this.init();
      }

      async init() {
        try {
          this.showLoading(true);
          await this.loadStudentData();
          this.setupEventListeners();
          this.showLoading(false);
          this.messages.show('✅ تم تحميل النظام بنجاح', 'success');
          this.soundSystem.play('notification');
        } catch (error) {
          this.showLoading(false);
          console.error('خطأ في تحميل البيانات:', error);
          this.messages.show('❌ لا يمكن تشغيل النشاط بدون ملف البيانات!', 'error');
          this.soundSystem.play('error');
        }
      }

      showLoading(show) {
        const loadingArea = document.getElementById('loadingArea');
        this.state.isLoading = show;
        
        if (show) {
          loadingArea.classList.add('active');
        } else {
          loadingArea.classList.remove('active');
        }
      }

      async loadStudentData() {
        try {
          this.messages.show('جاري تحميل بيانات الطلاب...', 'info', 10000);
          
          const res = await fetch('../data/studentData.json');
          if (!res.ok) {
            throw new Error('فشل في تحميل ملف البيانات');
          }
          this.state.studentData = await res.json();
          
          this.populateClassSelect();
          this.messages.clear();
          this.messages.show('تم تحميل بيانات الطلاب بنجاح! 🎓', 'success');
          
        } catch (error) {
          this.messages.show('خطأ في تحميل بيانات الطلاب: ' + error.message, 'error');
          this.soundSystem.play('wrong');
          
          // إضافة بيانات تجريبية في حالة فشل التحميل
          this.state.studentData = {
            "الأول": ["أحمد محمد سالم", "فاطمة علي خالد", "سالم خالد أحمد", "مريم سعيد محمد", "يوسف حمد علي"],
            "الثاني": ["نورا أحمد سالم", "محمد سالم يوسف", "آمنة يوسف حمد", "خالد محمد أحمد", "هناء علي سعيد"],
            "الثالث": ["عبدالله سعيد محمد", "زينب محمد علي", "طارق أحمد خالد", "رقية سالم يوسف", "حمد علي أحمد"],
            "الرابع": ["سعاد خالد محمد", "عمر محمد سالم", "ليلى أحمد علي", "ناصر سعيد حمد", "عائشة حمد يوسف"],
            "الخامس": ["إبراهيم علي سالم", "خديجة محمد أحمد", "سليمان خالد علي", "وردة سعيد محمد", "راشد حمد خالد"],
            "السادس": ["منى يوسف سالم", "عيسى محمد علي", "جميلة أحمد خالد", "بدر سعيد محمد", "نجاة علي حمد"]
          };
          
          this.populateClassSelect();
          this.messages.show('تم تحميل بيانات تجريبية بدلاً من الملف الأصلي', 'warning');
        }
      }

      populateClassSelect() {
        const classSelect = document.getElementById('classSelect');
        const startBtn = document.getElementById('startGameBtn');
        
        classSelect.innerHTML = '<option value="">اختر الصف</option>';

        const classes = Object.keys(this.state.studentData);

        classes.forEach(className => {
          const studentCount = this.state.studentData[className].length;
          const option = document.createElement('option');
          option.value = className;
          option.textContent = `${className} (${studentCount} طالب)`;
          classSelect.appendChild(option);
        });

        classSelect.addEventListener('change', () => {
          startBtn.disabled = !classSelect.value;
          
          if (classSelect.value) {
            const studentCount = this.state.studentData[classSelect.value].length;
            this.messages.show(`📚 تم اختيار "${classSelect.value}" - يحتوي على ${studentCount} طالب`, 'info', 3000);
          }
        });
      }

      setupEventListeners() {
        const startBtn = document.getElementById('startGameBtn');
        const classSelect = document.getElementById('classSelect');
        const modeSelect = document.getElementById('modeSelect');
        const timeSelect = document.getElementById('timeSelect');
        const livesSelect = document.getElementById('livesSelect');

        startBtn.addEventListener('click', () => this.startGame());

        timeSelect.addEventListener('change', () => {
          this.state.timeLimit = parseInt(timeSelect.value);
        });

        livesSelect.addEventListener('change', () => {
          this.state.maxLives = parseInt(livesSelect.value);
        });

        classSelect.addEventListener('change', () => {
          startBtn.disabled = !classSelect.value;
          
          if (classSelect.value) {
            const studentCount = this.state.studentData[classSelect.value].length;
            this.messages.show(`📚 تم اختيار "${classSelect.value}" - يحتوي على ${studentCount} طالب`, 'info', 3000);
          }
        });
      }

      startGame() {
        const classValue = document.getElementById('classSelect').value;
        const modeValue = document.getElementById('modeSelect').value;

        if (!classValue || !modeValue) {
          this.messages.show('⚠️ يرجى اختيار الصف ونمط اللعبة', 'warning');
          return;
        }

        this.state.currentClass = classValue;
        this.state.gameMode = modeValue;
        this.state.allStudents = this.state.studentData[classValue] || [];

        this.soundSystem.play('click');
        this.messages.show('🎯 بدء اللعبة...', 'info', 2000);
        
        setTimeout(() => {
          if (modeValue === 'assemble') {
            this.nameAssembly.start();
          } else if (modeValue === 'manual') {
            this.showStudentSelection();
          } else {
            this.newRound();
          }
        }, 1000);
      }

      newRound() {
        if (this.state.allStudents.length === 0) {
          this.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        const targetStudent = this.state.allStudents[Math.floor(Math.random() * this.state.allStudents.length)];
        this.state.targetStudent = targetStudent;

        this.displayGameInterface();
      }

      showStudentSelection() {
        if (this.state.allStudents.length === 0) {
          this.messages.show('⚠️ لا توجد بيانات طلاب متاحة', 'warning');
          return;
        }

        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="student-selection-interface">
            <div class="selection-title">🎯 الوضع الانتقائي - اختر الطالب</div>
            <div class="selection-subtitle">اختر الطالب الذي تريد أن يخمنه باقي الطلاب</div>
            
            <div class="selection-methods">
              <div class="method-tabs">
                <button onclick="game.showSelectionMode('cards')" class="method-tab active" id="cardsTab">
                  🃏 بطاقات الطلاب
                </button>
                <button onclick="game.showSelectionMode('list')" class="method-tab" id="listTab">
                  📋 قائمة الطلاب
                </button>
              </div>
              
              <div class="selection-content" id="selectionContent">
                ${this.generateStudentCards()}
              </div>
            </div>

            <div class="selection-controls">
              <button onclick="game.resetGame()" class="btn btn-cosmic">
                <i class="fas fa-arrow-left"></i>
                🔙 العودة للإعدادات
              </button>
            </div>
          </div>
        `;

        this.soundSystem.play('reveal');
        this.messages.show('🎯 اختر الطالب المطلوب من القائمة أو البطاقات', 'info', 5000);
      }

      showSelectionMode(mode) {
        const cardsTab = document.getElementById('cardsTab');
        const listTab = document.getElementById('listTab');
        const content = document.getElementById('selectionContent');

        // تحديث التبويبات
        cardsTab.classList.toggle('active', mode === 'cards');
        listTab.classList.toggle('active', mode === 'list');

        if (mode === 'cards') {
          content.innerHTML = this.generateStudentCards();
        } else {
          content.innerHTML = this.generateStudentList();
        }

        this.soundSystem.play('click');
      }

      generateStudentCards() {
        return `
          <div class="student-selection-grid">
            ${this.state.allStudents.map(student => `
              <div class="student-selection-card" onclick="game.selectTargetStudent('${student}')">
                <div class="student-avatar">
                  <i class="fas fa-user-graduate"></i>
                </div>
                <div class="student-selection-name">${student}</div>
                <div class="selection-badge">اختر</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      generateStudentList() {
        return `
          <div class="student-selection-list">
            <div class="list-header">
              <span class="student-count">عدد الطلاب: ${this.state.allStudents.length}</span>
            </div>
            ${this.state.allStudents.map((student, index) => `
              <div class="student-list-item" onclick="game.selectTargetStudent('${student}')">
                <div class="student-number">${index + 1}</div>
                <div class="student-list-name">${student}</div>
                <div class="select-button">
                  <i class="fas fa-check-circle"></i>
                  اختر
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      selectTargetStudent(studentName) {
        this.state.targetStudent = studentName;
        this.soundSystem.play('success');
        this.messages.show(`✅ تم اختيار الطالب: ${studentName}`, 'success', 3000);
        
        // تهيئة إعدادات الوضع الانتقائي
        this.state.stats.lives = this.state.maxLives;
        this.state.stats.correctAnswers = 0;
        this.state.stats.wrongAnswers = 0;
        this.state.stats.gamesPlayed = 0;
        
        // انتظار قصير ثم بدء اللعبة
        setTimeout(() => {
          this.displayManualGameInterface();
        }, 1500);
      }

      displayManualGameInterface() {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="manual-game-interface">
            <div class="target-student-display">
              <div class="target-title">🎯 الطالب المستهدف</div>
              <div class="hidden-target" id="hiddenTarget">
                <div class="secret-icon">🔒</div>
                <div class="secret-text">مخفي عن الطلاب</div>
                <button onclick="game.revealTarget()" class="reveal-btn">
                  <i class="fas fa-eye"></i>
                  كشف للمعلم
                </button>
              </div>
              <div class="target-instruction">على الطلاب تخمين من هو هذا الطالب</div>
            </div>

            <div class="game-stats">
              <div class="stat-card lives">
                <div class="stat-icon">❤️</div>
                <div class="stat-value">${this.state.stats.lives}</div>
                <div class="stat-label">المحاولات المتبقية</div>
              </div>
              <div class="stat-card attempts">
                <div class="stat-icon">🎮</div>
                <div class="stat-value">${this.state.stats.gamesPlayed}</div>
                <div class="stat-label">إجمالي المحاولات</div>
              </div>
              <div class="stat-card correct">
                <div class="stat-icon">✅</div>
                <div class="stat-value">${this.state.stats.correctAnswers}</div>
                <div class="stat-label">إجابات صحيحة</div>
              </div>
            </div>
            
            <div class="students-grid">
              ${this.generateStudentOptions()}
            </div>

            <div class="manual-controls">
              <button onclick="game.newManualRound()" class="btn btn-primary">
                🔄 طالب جديد
              </button>
              <button onclick="game.resetGame()" class="btn btn-cosmic">
                🏠 العودة للقائمة
              </button>
            </div>
          </div>
        `;

        this.soundSystem.play('reveal');
        this.messages.show(`🎯 ابدأ التخمين! الطالب مخفي للحفاظ على عدالة اللعبة`, 'info', 5000);
      }

      displayGameInterface() {
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="current-student">
            من هو الطالب المُختار؟
          </div>
          
          <div class="students-grid">
            ${this.generateStudentOptions()}
          </div>
          
          <div class="game-buttons" style="margin-top: 20px;">
            <button onclick="game.newRound()" class="btn btn-primary">
              🔄 جولة جديدة
            </button>
            <button onclick="game.endGame()" class="btn btn-warning">
              🏁 إنهاء اللعبة
            </button>
          </div>
        `;

        this.soundSystem.play('reveal');
        this.messages.show(`🎯 اعثر على: ${this.state.targetStudent}`, 'info', 5000);
      }

      generateStudentOptions() {
        const shuffled = [...this.state.allStudents].sort(() => Math.random() - 0.5);
        const options = shuffled.slice(0, Math.min(8, shuffled.length));
        
        if (!options.includes(this.state.targetStudent)) {
          options[0] = this.state.targetStudent;
          options.sort(() => Math.random() - 0.5);
        }

        return options.map(student => `
          <div class="student-card" onclick="game.checkAnswer('${student}')">
            <div class="student-name">${student}</div>
          </div>
        `).join('');
      }

      checkAnswer(selectedStudent) {
        if (this.state.gameMode === 'manual') {
          this.checkManualAnswer(selectedStudent);
        } else {
          this.checkRegularAnswer(selectedStudent);
        }
      }

      checkManualAnswer(selectedStudent) {
        const isCorrect = selectedStudent === this.state.targetStudent;
        
        // إزالة التأثيرات البصرية أثناء الاختيار للحفاظ على السرية
        // لا نعرض الإجابة الصحيحة أو الخاطئة على البطاقات
        
        this.state.stats.gamesPlayed++;

        if (isCorrect) {
          // إجابة صحيحة - عرض نافذة احترافية للفوز
          this.state.stats.correctAnswers++;
          this.soundSystem.play('correct');
          this.showSuccessModal(selectedStudent);
        } else {
          // إجابة خاطئة - تقليل المحاولات
          this.state.stats.wrongAnswers++;
          this.state.stats.lives--;
          this.soundSystem.play('wrong');
          
          if (this.state.stats.lives <= 0) {
            // نفدت المحاولات - عرض نافذة احترافية للكشف
            this.showRevealModal();
          } else {
            this.messages.show(`❌ إجابة خاطئة! المحاولات المتبقية: ${this.state.stats.lives}`, 'error', 3000);
            // تحديث العرض
            setTimeout(() => {
              this.updateManualStats();
            }, 1500);
          }
        }
      }

      checkRegularAnswer(selectedStudent) {
        const isCorrect = selectedStudent === this.state.targetStudent;
        
        // تأثير بصري
        const cards = document.querySelectorAll('.student-card');
        cards.forEach(card => {
          const cardName = card.querySelector('.student-name').textContent;
          if (cardName === selectedStudent) {
            card.classList.add(isCorrect ? 'correct' : 'wrong');
          }
          if (cardName === this.state.targetStudent && !isCorrect) {
            card.classList.add('correct');
          }
        });

        if (isCorrect) {
          this.soundSystem.play('correct');
          this.state.updateStats(true);
          this.messages.show('🎉 ممتاز! إجابة صحيحة', 'success', 3000);
        } else {
          this.soundSystem.play('wrong');
          this.state.updateStats(false);
          this.messages.show(`❌ خطأ! الإجابة الصحيحة: ${this.state.targetStudent}`, 'error', 5000);
        }

        setTimeout(() => {
          if (this.state.stats.lives > 0) {
            this.newRound();
          } else {
            this.endGame();
          }
        }, 3000);
      }

      endGame() {
        this.soundSystem.play('notification');
        const gameArea = document.getElementById('gameArea');
        
        gameArea.innerHTML = `
          <div class="result-display">
            🏆 انتهت اللعبة!
            <br><br>
            النقاط: ${this.state.stats.score}
            <br>
            الإجابات الصحيحة: ${this.state.stats.correctAnswers}
            <br>
            الإجابات الخاطئة: ${this.state.stats.wrongAnswers}
            <br>
            معدل النجاح: ${this.state.getSuccessRate()}%
          </div>
          
          <div class="game-buttons">
            <button onclick="game.resetGame()" class="btn btn-primary">
              🔄 لعبة جديدة
            </button>
          </div>
        `;
      }

      resetGame() {
        this.state.reset();
        const gameArea = document.getElementById('gameArea');
        gameArea.innerHTML = '<p><i class="fas fa-info-circle"></i> اختر الصف ونمط اللعبة لبدء التحدي</p>';
        this.messages.show('🎮 جاهز للعبة جديدة!', 'info', 3000);
      }

      showSuccessModal(winnerName) {
        const modal = document.createElement('div');
        modal.className = 'success-modal modal-overlay';
        modal.innerHTML = `
          <div class="modal-content success-content">
            <div class="success-animation">
              <div class="success-icon">🏆</div>
              <div class="success-confetti"></div>
            </div>
            <div class="success-title">مبروك!</div>
            <div class="winner-name">${winnerName}</div>
            <div class="success-message">تمكن من العثور على الطالب المستهدف!</div>
            <div class="success-stats">
              <div class="stat">
                <span class="stat-label">المحاولات المستخدمة:</span>
                <span class="stat-value">${this.state.stats.gamesPlayed}</span>
              </div>
            </div>
            <div class="modal-buttons">
              <button onclick="game.newManualRound(); game.closeModal()" class="btn btn-primary">
                🔄 جولة جديدة
              </button>
              <button onclick="game.resetGame(); game.closeModal()" class="btn btn-cosmic">
                🏠 إنهاء اللعبة
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        this.soundSystem.play('success');
        
        // إطلاق الألعاب النارية
        if (typeof confetti !== 'undefined') {
          confetti({
            particleCount: 200,
            spread: 100,
            origin: { y: 0.4 }
          });
        }
      }

      showRevealModal() {
        const modal = document.createElement('div');
        modal.className = 'reveal-modal modal-overlay';
        modal.innerHTML = `
          <div class="modal-content reveal-content">
            <div class="reveal-animation">
              <div class="reveal-icon">🎭</div>
            </div>
            <div class="reveal-title">انتهت المحاولات!</div>
            <div class="revealed-name">${this.state.targetStudent}</div>
            <div class="reveal-message">هذا هو الطالب المستهدف</div>
            <div class="reveal-stats">
              <div class="stat">
                <span class="stat-label">إجمالي المحاولات:</span>
                <span class="stat-value">${this.state.stats.gamesPlayed}</span>
              </div>
              <div class="stat">
                <span class="stat-label">الإجابات الصحيحة:</span>
                <span class="stat-value">${this.state.stats.correctAnswers}</span>
              </div>
            </div>
            <div class="modal-buttons">
              <button onclick="game.newManualRound(); game.closeModal()" class="btn btn-primary">
                🔄 جولة جديدة
              </button>
              <button onclick="game.resetGame(); game.closeModal()" class="btn btn-cosmic">
                🏠 إنهاء اللعبة
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        this.soundSystem.play('reveal');
      }

      closeModal() {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
          modal.style.animation = 'fadeOut 0.3s ease-out';
          setTimeout(() => {
            if (modal.parentNode) {
              modal.parentNode.removeChild(modal);
            }
          }, 300);
        });
      }

      newManualRound() {
        // إعادة تعيين المحاولات للجولة الجديدة
        this.state.stats.lives = this.state.maxLives;
        this.state.stats.gamesPlayed = 0;
        this.state.stats.correctAnswers = 0;
        this.state.stats.wrongAnswers = 0;
        
        // عرض نافذة اختيار طالب جديد
        this.showStudentSelection();
      }

      updateManualStats() {
        // تحديث الإحصائيات في الواجهة
        const livesElement = document.querySelector('.stat-card.lives .stat-value');
        const attemptsElement = document.querySelector('.stat-card.attempts .stat-value');
        const correctElement = document.querySelector('.stat-card.correct .stat-value');
        
        if (livesElement) livesElement.textContent = this.state.stats.lives;
        if (attemptsElement) attemptsElement.textContent = this.state.stats.gamesPlayed;
        if (correctElement) correctElement.textContent = this.state.stats.correctAnswers;
      }

      revealTarget() {
        const hiddenTarget = document.getElementById('hiddenTarget');
        if (hiddenTarget) {
          hiddenTarget.innerHTML = `
            <div class="revealed-target">
              <div class="target-name">${this.state.targetStudent}</div>
              <button onclick="game.hideTarget()" class="hide-btn">
                <i class="fas fa-eye-slash"></i>
                إخفاء مرة أخرى
              </button>
            </div>
          `;
          this.soundSystem.play('notification');
        }
      }

      hideTarget() {
        const hiddenTarget = document.getElementById('hiddenTarget');
        if (hiddenTarget) {
          hiddenTarget.innerHTML = `
            <div class="secret-icon">🔒</div>
            <div class="secret-text">مخفي عن الطلاب</div>
            <button onclick="game.revealTarget()" class="reveal-btn">
              <i class="fas fa-eye"></i>
              كشف للمعلم
            </button>
          `;
          this.soundSystem.play('click');
        }
      }
    }

    // إنشاء مثيل اللعبة
    let game;
    let nameAssembly;

    // بدء اللعبة عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      game = new WhoIsItGame();
      nameAssembly = game.nameAssembly;
      
      // إضافة تأثيرات تفاعلية
      document.addEventListener('click', (e) => {
        if (game && game.soundSystem) {
          game.soundSystem.play('click');
        }
      });
    });
  </script>
</body>
</html>
