<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🌟 مملكة السرد الشفوي الإبداعي - نشاط تفاعلي ذكي</title>
  
  <!-- الخطوط والأيقونات -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- المكتبات الخارجية -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  
  <!-- الأنماط والسكريبت الموحد -->
  <link rel="stylesheet" href="../assets/css/responsive.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <script src="../assets/css/style.css" type="text/javascript"></script>
  
  <style>
    /* تحسينات خاصة بنشاط إنشاء القصة */
    
    /* تأثيرات النصوص الجديدة */
    .main-title {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .main-subtitle {
      font-size: 1.3rem;
      margin-bottom: 20px;
      opacity: 0.9;
    }
    
    .glow-text {
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    .pulse-text {
      animation: pulse 2s infinite;
    }
    
    .text-gradient {
      background: linear-gradient(45deg, #d32f2f, #ff9800, #4caf50, #2196f3);
      background-size: 400% 400%;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientAnimation 3s ease infinite;
    }
    
    .animate-bounce {
      animation: bounce 2s infinite;
    }
    
    .sparkle {
      animation: sparkle 1.5s ease-in-out infinite;
    }
    
    /* إشعارات الترحيب */
    .welcome-notifications {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    
    .notification-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transform: translateY(0);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .notification-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .notification-item.success {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(129, 199, 132, 0.2));
      border: 2px solid rgba(76, 175, 80, 0.3);
      color: #2e7d32;
    }
    
    .notification-item.info {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(100, 181, 246, 0.2));
      border: 2px solid rgba(33, 150, 243, 0.3);
      color: #1565c0;
    }
    
    /* تحسين الأزرار */
    .enhanced-btn {
      position: relative;
      overflow: hidden;
      background: linear-gradient(45deg, #d32f2f, #f44336);
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
    }
    
    .enhanced-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);
    }
    
    .enhanced-btn:active {
      transform: translateY(0);
    }
    
    .enhanced-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .enhanced-btn:hover::before {
      left: 100%;
    }
    
    /* تأثيرات الحركة */
    @keyframes glow {
      from { text-shadow: 0 0 10px rgba(211, 47, 47, 0.5); }
      to { text-shadow: 0 0 20px rgba(211, 47, 47, 0.8), 0 0 30px rgba(211, 47, 47, 0.6); }
    }
    
    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    /* تحسينات التعليمات */
    .instructions-welcome {
      margin: 20px 0;
      text-align: center;
    }
    
    .instructions-sections {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    .instruction-section {
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border-radius: 15px;
      padding: 20px;
      border: 2px solid rgba(211, 47, 47, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .instruction-section h4 {
      color: #d32f2f;
      margin-bottom: 15px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .enhanced-list {
      list-style: none;
      padding: 0;
    }
    
    .enhanced-list li {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .enhanced-list li:hover {
      background: rgba(211, 47, 47, 0.1);
      transform: translateX(5px);
    }
    
    .enhanced-list li i {
      color: #d32f2f;
      font-size: 1.1rem;
    }
    
    .special-tips {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.1));
      border: 2px solid rgba(255, 193, 7, 0.3);
    }
    
    .special-tips h4 {
      color: #ff9800;
    }
    
    .special-tips .enhanced-list li i {
      color: #ff9800;
    }
    
    /* تحسينات الأزرار المحسنة */
    .enhanced-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 8px 0;
      min-height: 50px;
      font-size: 1rem;
    }
    
    .enhanced-btn.btn-secondary {
      background: linear-gradient(45deg, #607d8b, #78909c);
      box-shadow: 0 4px 15px rgba(96, 125, 139, 0.3);
    }
    
    .enhanced-btn.btn-secondary:hover {
      box-shadow: 0 6px 20px rgba(96, 125, 139, 0.4);
    }
    
    .enhanced-btn.btn-info {
      background: linear-gradient(45deg, #00bcd4, #26c6da);
      box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3);
    }
    
    .enhanced-btn.btn-info:hover {
      box-shadow: 0 6px 20px rgba(0, 188, 212, 0.4);
    }
    
    .enhanced-btn.btn-success {
      background: linear-gradient(45deg, #4caf50, #66bb6a);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .enhanced-btn.btn-success:hover {
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    .enhanced-btn.btn-warning {
      background: linear-gradient(45deg, #ff9800, #ffb74d);
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }
    
    .enhanced-btn.btn-warning:hover {
      box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
    }
    
    .enhanced-btn.btn-danger {
      background: linear-gradient(45deg, #f44336, #ef5350);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }
    
    .enhanced-btn.btn-danger:hover {
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Cairo', sans-serif;
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .page-header {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-icon {
      font-size: 3rem;
      color: #667eea;
      animation: bounceIn 1s ease-out;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    .header-text h1 {
      margin: 0;
      color: #2d3748;
      font-size: 2.5rem;
      font-weight: 700;
    }

    .header-text p {
      margin: 5px 0 0 0;
      color: #718096;
      font-size: 1.1rem;
    }

    .game-settings-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      animation: slideInRight 0.8s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .settings-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      color: #2d3748;
    }

    .settings-header i {
      font-size: 1.5rem;
      color: #667eea;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      color: #2d3748;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: white;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      font-family: 'Cairo', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #8b4513;
      box-shadow: 0 4px 15px rgba(252, 182, 159, 0.4);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(252, 182, 159, 0.6);
    }

    .btn-success {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: #2d5016;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(132, 250, 176, 0.6);
    }

    /* منطقة عرض القصة المُنشأة */
    .generated-story-area {
      animation: fadeInScale 0.8s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .story-display-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .story-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
    }

    .story-header h3 {
      color: #2d3748;
      font-size: 1.8rem;
      margin: 0 0 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .story-author {
      color: #667eea;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .story-content {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 15%, #ffecd2 100%);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      line-height: 1.8;
      font-size: 1.2rem;
      color: #2d3748;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
      animation: typewriter 2s ease-out;
    }

    @keyframes typewriter {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .story-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    /* تحسينات للأجهزة المحمولة */
    @media (max-width: 768px) {
      .main-container {
        padding: 15px;
      }

      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .header-text h1 {
        font-size: 2rem;
      }

      .story-actions {
        grid-template-columns: 1fr;
      }
    }

    /* تأثيرات احتفالية */
    .celebration-effect {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      color: #ffd700;
      z-index: 1000;
      animation: celebrationPulse 2s ease-out;
    }

    @keyframes celebrationPulse {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }

    /* تحسينات اختيار الطلاب */
    .students-selection-area {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      animation: slideInLeft 0.8s ease-out;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .student-selection-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
    }

    .student-selection-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.6);
    }

    .student-selection-card.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transform: scale(1.05);
    }

    .student-avatar {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .student-name {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* تصميم النشاط الشفوي الجديد */
    .oral-story-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 25px;
      padding: 30px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(15px);
      animation: slideInUp 1s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .current-speaker-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      text-align: center;
      animation: speakerPulse 3s infinite ease-in-out;
    }

    @keyframes speakerPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3); }
      50% { transform: scale(1.02); box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5); }
    }

    .speaker-avatar {
      font-size: 4rem;
      margin-bottom: 15px;
      animation: avatarBounce 2s infinite;
    }

    @keyframes avatarBounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .speaker-label {
      font-size: 1rem;
      opacity: 0.9;
      display: block;
      margin-bottom: 5px;
    }

    .speaker-name-text {
      font-size: 1.8rem;
      font-weight: 700;
      display: block;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .story-role {
      margin-top: 15px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .timer-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      padding: 20px;
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border-radius: 20px;
    }

    .timer-info {
      text-align: center;
    }

    .time-remaining {
      font-size: 2.5rem;
      font-weight: 700;
      color: #d63384;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .timer-label {
      font-size: 1rem;
      color: #6c757d;
      margin-top: 5px;
    }

    .story-info-panel {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .story-topic {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 15px;
    }

    .story-progress {
      text-align: center;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #20c997);
      transition: width 0.5s ease;
      border-radius: 4px;
    }

    .progress-text {
      font-size: 1rem;
      color: #6c757d;
      font-weight: 500;
    }

    .story-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin: 25px 0;
    }

    .motivation-messages {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      animation: motivationGlow 4s infinite ease-in-out;
    }

    @keyframes motivationGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(132, 250, 176, 0.3); }
      50% { box-shadow: 0 0 30px rgba(132, 250, 176, 0.6); }
    }

    .motivation-text {
      font-size: 1.2rem;
      font-weight: 600;
      color: #155724;
    }

    /* منطقة المشاركين */
    .participants-area {
      animation: fadeInLeft 0.8s ease-out;
    }

    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .participants-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .participants-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .participant-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .participant-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .participant-card.active {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
    }

    .participant-card.done {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      opacity: 0.7;
    }

    .waiting-list {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e9ecef;
    }

    .waiting-students {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .waiting-student {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.9rem;
      color: #495057;
    }

    /* تأثيرات خاصة */
    .speaker-highlight {
      animation: speakerHighlight 2s ease-in-out;
    }

    @keyframes speakerHighlight {
      0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
      50% { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
    }

    .time-warning {
      animation: timeWarning 1s infinite;
    }

    @keyframes timeWarning {
      0%, 100% { color: #d63384; }
      50% { color: #dc3545; }
    }

    /* تحسينات للأجهزة المحمولة */
    @media (max-width: 768px) {
      .timer-section {
        flex-direction: column;
        gap: 15px;
      }

      .story-controls {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .participants-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
      }

      .speaker-name-text {
        font-size: 1.4rem;
      }

      .time-remaining {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- أزرار التحكم الموحدة -->
  <div class="control-buttons-container mobile-grid-4">
    <button class="control-btn touch-target" id="backBtn" title="العودة للصفحة الرئيسية">
      <i class="fas fa-home"></i>
    </button>
    <button class="control-btn touch-target" id="muteBtn" title="كتم الصوت">
      <i class="fas fa-volume-up"></i>
    </button>
    <button class="control-btn touch-target" id="instructionsBtn" title="تعليمات النشاط">
      <i class="fas fa-question-circle"></i>
    </button>
    <button class="control-btn touch-target" id="fullscreenBtn" title="ملء الشاشة">
      <i class="fas fa-expand"></i>
    </button>
  </div>

  <!-- نافذة تعليمات النشاط -->
  <div class="instructions-overlay responsive-modal" id="instructionsModal">
    <div class="instructions-content mobile-full-height">
      <button class="close-btn touch-target" onclick="closeInstructions()" title="إغلاق">
        <i class="fas fa-times"></i>
      </button>
      <div class="instructions-title">
        <i class="fas fa-magic sparkle"></i> 
        <span class="glow-text">دليل المعلم لمملكة السرد الإبداعي</span>
        <i class="fas fa-book-open pulse"></i>
      </div>
      
      <div class="instructions-welcome">
        <div class="notification-item success">
          <i class="fas fa-star sparkle"></i>
          <span>مرحباً بك في تجربة سردية تفاعلية مبتكرة!</span>
        </div>
      </div>
      
      <div class="instructions-sections">
        <div class="instruction-section">
          <h4><i class="fas fa-cog"></i> خطوات البدء السريع:</h4>
          <ul class="instructions-list enhanced-list">
            <li><i class="fas fa-graduation-cap"></i> اختر الصف الدراسي من القائمة المنسدلة</li>
            <li><i class="fas fa-route"></i> حدد طريقة السرد: متسلسل، عشوائي، إبداعي، أو اختيار المجموعة</li>
            <li><i class="fas fa-book"></i> اختر موضوع القصة أو اختر "قصة حرة" لموضوع مفتوح</li>
            <li><i class="fas fa-clock"></i> حدد الوقت المخصص لكل طالب (30-90 ثانية)</li>
            <li><i class="fas fa-lightbulb"></i> في الأنماط الإبداعية، يمكنك كتابة بداية للقصة (اختياري)</li>
          </ul>
        </div>
        
        <div class="instruction-section">
          <h4><i class="fas fa-play-circle"></i> أثناء النشاط:</h4>
          <ul class="instructions-list enhanced-list">
            <li><i class="fas fa-user-friends"></i> سيظهر اسم الطالب ودوره في القصة تلقائياً</li>
            <li><i class="fas fa-forward"></i> استخدم "المتحدث التالي" للانتقال قبل انتهاء الوقت</li>
            <li><i class="fas fa-magic"></i> اضغط "إلهام سردي" لإعطاء أفكار للطالب المتحدث</li>
            <li><i class="fas fa-pause"></i> يمكن إيقاف المؤقت مؤقتاً عند الحاجة</li>
            <li><i class="fas fa-microphone"></i> النشاط شفوي بالكامل - الطلاب يتحدثون ولا يكتبون!</li>
          </ul>
        </div>
        
        <div class="instruction-section special-tips">
          <h4><i class="fas fa-gem sparkle"></i> نصائح للمعلم المبدع:</h4>
          <ul class="instructions-list enhanced-list">
            <li><i class="fas fa-heart"></i> شجع الطلاب على استخدام التفاصيل الحسية (ماذا يرون/يسمعون/يشعرون؟)</li>
            <li><i class="fas fa-link"></i> ساعد الطلاب على ربط أجزاء القصة ببعضها البعض</li>
            <li><i class="fas fa-comments"></i> حفز إضافة الحوار بين الشخصيات</li>
            <li><i class="fas fa-surprise"></i> لا تخف من المفاجآت والمنعطفات المثيرة!</li>
          </ul>
        </div>
      </div>
      <button class="btn btn-primary touch-target mobile-full-width" onclick="closeInstructions()">
        <i class="fas fa-check"></i> فهمت
      </button>
    </div>
  </div>

  <!-- نافذة النتائج النهائية -->
  <div class="victory-modal responsive-modal" id="thankYouModal">
    <div class="victory-content mobile-full-height">
      <button class="close-btn touch-target" id="closeModalBtn" title="إغلاق">
        <i class="fas fa-times"></i>
      </button>
      <div class="victory-fireworks">
        <i class="fas fa-star"></i> <i class="fas fa-star"></i> <i class="fas fa-star"></i>
      </div>
      <div class="victory-trophy">
        <i class="fas fa-trophy"></i>
      </div>
      <div class="victory-team">شكراً لمشاركتكم الرائعة!</div>
      <div class="victory-names">المشاركون في القصة:</div>
      <div class="honor-board-section">
        <ul class="honor-list" id="participantList"></ul>
      </div>
      <button class="btn btn-primary touch-target mobile-full-width" id="modalBackBtn">
        <i class="fas fa-redo"></i> نشاط جديد
      </button>
    </div>
  </div>

  <!-- المحتوى الرئيسي -->
  <div class="main-container mobile-full-width">
    <div class="page-header mobile-text-center">
      <div class="header-content">
        <div class="header-icon animate-bounce">
          <i class="fas fa-book-open text-gradient"></i>
        </div>
        <div class="header-text">
          <h1 class="main-title glow-text">🌟 مملكة السرد الشفوي الإبداعي 🌟</h1>
          <p class="main-subtitle pulse-text">رحلة سردية تفاعلية لإطلاق خيالك وتطوير قدراتك الإبداعية</p>
          <div class="welcome-notifications">
            <div class="notification-item success">
              <i class="fas fa-magic sparkle"></i>
              <span>مرحباً بك في عالم الحكايات السحرية!</span>
            </div>
            <div class="notification-item info">
              <i class="fas fa-users"></i>
              <span>تفاعل مع زملائك وأبدع قصصاً لا تُنسى</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- نموذج الإعدادات -->
    <div class="game-settings-card mobile-full-width" id="settingsCard">
      <div class="settings-header">
        <i class="fas fa-cog"></i>
        <h3>إعدادات النشاط</h3>
      </div>
      <form class="story-settings-form" id="storySettingsForm">
        <div class="form-group mobile-full-width">
          <label for="classSelect">
            <i class="fas fa-graduation-cap"></i> الصف الدراسي
          </label>
          <select id="classSelect" class="form-input mobile-full-width" required>
            <option value="">-- اختر الصف --</option>
          </select>
        </div>
        
        <div class="form-group mobile-full-width">
          <label for="modeSelect">
            <i class="fas fa-users"></i> طريقة السرد
          </label>
          <select id="modeSelect" class="form-input mobile-full-width" required>
            <option value="">-- اختر طريقة السرد --</option>
            <option value="sequential">سرد متسلسل (كل طالب يكمل الجملة)</option>
            <option value="random">سرد عشوائي (اختيار عشوائي لكل دور)</option>
            <option value="creative">سرد إبداعي (كل طالب يضيف عنصر جديد)</option>
            <option value="select-group">اختيار الطلاب المشاركين</option>
          </select>
        </div>

        <div class="form-group mobile-full-width">
          <label for="storyTypeSelect">
            <i class="fas fa-magic"></i> موضوع القصة
          </label>
          <select id="storyTypeSelect" class="form-input mobile-full-width" required>
            <option value="">-- اختر موضوع القصة --</option>
            <option value="adventure">مغامرة شيقة</option>
            <option value="fantasy">خيال وسحر</option>
            <option value="space">استكشاف الفضاء</option>
            <option value="school">حياة مدرسية</option>
            <option value="mystery">لغز ومغامرة</option>
            <option value="friendship">صداقة وتعاون</option>
            <option value="custom">قصة حرة (بدون موضوع محدد)</option>
          </select>
        </div>

        <div class="form-group mobile-full-width">
          <label for="timePerStudent">
            <i class="fas fa-clock"></i> وقت كل طالب (بالثواني)
          </label>
          <select id="timePerStudent" class="form-input mobile-full-width">
            <option value="30">30 ثانية</option>
            <option value="45" selected>45 ثانية</option>
            <option value="60">دقيقة واحدة</option>
            <option value="90">دقيقة ونصف</option>
          </select>
        </div>

        <div class="form-group mobile-full-width" id="storyStarterGroup" style="display: none;">
          <label for="storyStarter">
            <i class="fas fa-lightbulb"></i> بداية القصة (اختياري)
          </label>
          <textarea id="storyStarter" class="form-input mobile-full-width" rows="2" 
                    placeholder="ابدأ القصة بجملة أو فكرة... (مثل: في يوم مشمس، قرر أحمد...)"></textarea>
        </div>
        
        <div class="button-group">
          <button type="submit" class="enhanced-btn btn-primary touch-target mobile-full-width" id="startBtn">
            <i class="fas fa-rocket sparkle"></i>
            <span>🎬 ابدأ المغامرة السردية</span>
            <i class="fas fa-arrow-right"></i>
          </button>
          <button type="button" class="enhanced-btn btn-secondary touch-target mobile-full-width" id="previewModeBtn">
            <i class="fas fa-eye"></i>
            <span>👀 استكشف طرق السرد</span>
            <i class="fas fa-question-circle"></i>
          </button>
          <button type="button" class="enhanced-btn btn-info touch-target mobile-full-width" id="helpBtn">
            <i class="fas fa-life-ring sparkle"></i>
            <span>💡 دليل المعلم الذكي</span>
            <i class="fas fa-graduation-cap"></i>
          </button>
        </div>
      </form>
    </div>

    <!-- منطقة اختيار الطلاب -->
    <div class="students-selection-area mobile-full-width" id="studentSelection"></div>

    <!-- منطقة النشاط الشفوي -->
    <div class="story-activity-area mobile-full-width" id="storyContainer">
      <div class="oral-story-card mobile-text-center">
        <!-- عرض الطالب الحالي -->
        <div class="current-speaker-section">
          <div class="speaker-avatar">
            <i class="fas fa-user-graduate"></i>
          </div>
          <div class="speaker-name" id="currentSpeaker">
            <span class="speaker-label">دور السرد الآن:</span>
            <span class="speaker-name-text" id="speakerName">اختر طالب للبدء</span>
          </div>
          <div class="story-role" id="storyRole">
            <i class="fas fa-microphone"></i>
            <span id="roleText">ابدأ القصة بجملة مثيرة!</span>
          </div>
        </div>

        <!-- مؤقت السرد -->
        <div class="timer-section">
          <canvas id="timerCanvas" width="120" height="120"></canvas>
          <div class="timer-info">
            <div class="time-remaining" id="timeRemaining">45</div>
            <div class="timer-label">ثانية متبقية</div>
          </div>
        </div>

        <!-- معلومات القصة -->
        <div class="story-info-panel">
          <div class="story-topic" id="storyTopic">
            <i class="fas fa-bookmark"></i>
            <span>موضوع القصة: <span id="topicText">مغامرة</span></span>
          </div>
          <div class="story-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text">
              <span id="currentRound">الدور 1</span> من <span id="totalRounds">5</span>
            </div>
          </div>
        </div>

        <!-- أزرار التحكم -->
        <div class="story-controls">
          <button class="enhanced-btn btn-success touch-target" id="nextSpeakerBtn">
            <i class="fas fa-forward sparkle"></i>
            <span>⭐ المتحدث التالي</span>
          </button>
          <button class="enhanced-btn btn-warning touch-target" id="pauseBtn">
            <i class="fas fa-pause"></i>
            <span>⏸️ استراحة فكرية</span>
          </button>
          <button class="enhanced-btn btn-info touch-target" id="hintBtn">
            <i class="fas fa-magic sparkle"></i>
            <span>💡 إلهام سردي</span>
          </button>
          <button class="enhanced-btn btn-danger touch-target" id="finishStoryBtn">
            <i class="fas fa-trophy sparkle"></i>
            <span>🏆 اختتم الإبداع</span>
          </button>
        </div>

        <!-- رسائل تحفيزية -->
        <div class="motivation-messages" id="motivationArea">
          <div class="motivation-text" id="motivationText">
            🌟 استعد لسرد رائع! اجعل القصة مثيرة ومشوقة!
          </div>
        </div>
      </div>
    </div>

    <!-- منطقة الطلاب المشاركين -->
    <div class="participants-area mobile-full-width" id="participantsContainer" style="display: none;">
      <div class="participants-card">
        <h3><i class="fas fa-users"></i> الطلاب المشاركون</h3>
        <div class="participants-grid" id="participantsGrid"></div>
        <div class="waiting-list">
          <h4>قائمة الانتظار:</h4>
          <div class="waiting-students" id="waitingStudents"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // نظام الألوان العماني المتقدم
    const OmaniColors = {
      red: '#DC143C',
      green: '#228B22', 
      gold: '#FFD700',
      white: '#F8F9FA',
      black: '#1A1A1A'
    };

    let ActivityManager;
    
    // تهيئة النشاط
    document.addEventListener('DOMContentLoaded', function() {
      // محاولة تهيئة ActivityManager مع fallback
      try {
        ActivityManager = new ActivityUtils({
          activityName: 'create-story',
          primaryColor: OmaniColors.red,
          secondaryColor: OmaniColors.green,
          sounds: {
            click: '../assets/media/sounds/Click.mp3',
            success: '../assets/media/sounds/name-start.mp3',
            celebration: '../assets/media/sounds/clap.mp3',
            win: '../assets/media/sounds/win.mp3'
          }
        });
      } catch (error) {
        console.warn('ActivityUtils غير متوفر، سيتم استخدام بدائل بسيطة');
        // بديل بسيط لـ ActivityManager
        ActivityManager = {
          playSound: (sound) => console.log('تشغيل صوت:', sound),
          showNotification: (message, type) => {
            console.log(`${type}: ${message}`);
            alert(message);
          },
          toggleMute: () => console.log('تغيير حالة الصوت'),
          toggleFullscreen: () => {
            if (document.fullscreenElement) {
              document.exitFullscreen();
            } else {
              document.documentElement.requestFullscreen();
            }
          },
          isMuted: () => false
        };
      }

      initializeStoryActivity();
    });

    // المتغيرات العامة للنشاط الشفوي
    let students = [];
    let currentStudentList = [];
    let usedStudents = [];
    let selectedManualStudents = [];
    let timerInterval;
    let currentTime = 45; // الوقت الافتراضي
    let totalTime = 45;
    let currentMode = '';
    let currentStoryType = '';
    let currentRound = 1;
    let totalRounds = 5;
    let isPaused = false;
    let storyParts = []; // لحفظ أجزاء القصة
    let currentSpeakerIndex = 0;

    // نظام الأصوات الذكي والإشعارات التفاعلية
    const smartSoundSystem = {
      // أصوات الترحيب والبداية
      welcome: {
        sounds: ['startapp.mp3', 'achievement-unlock.mp3', 'brain-activate.mp3'],
        messages: [
          "🌟 أهلاً وسهلاً بك في مملكة السرد الإبداعي!",
          "🎭 استعد لرحلة سردية مليئة بالخيال والإبداع!",
          "✨ دع قلمك يرقص مع الكلمات والأفكار!"
        ]
      },
      
      // أصوات بداية النشاط
      gameStart: {
        sounds: ['epic-charge.mp3', 'battle-horn.mp3', 'cosmic-portal.mp3'],
        messages: [
          "🚀 لقد انطلقت المغامرة السردية! حان وقت الإبداع!",
          "🎬 أضواء... كاميرا... سرد! دعوا الحكاية تبدأ!",
          "⭐ الآن حان دوركم لتنسجوا خيوط القصة الذهبية!"
        ]
      },
      
      // أصوات التشجيع والتحفيز
      encouragement: {
        sounds: ['level-up.mp3', 'bonus-collect.mp3', 'magic-sparkle.mp3', 'crystal-bonus.mp3'],
        messages: [
          "🌟 إبداع رائع! أضف المزيد من التفاصيل المدهشة!",
          "🎨 ممتاز! دع خيالك يحلق في سماء الإبداع!",
          "⚡ مذهل! اربط الأحداث بطريقة مبتكرة!",
          "🦋 أحسنت! أضف لمسة سحرية للقصة!",
          "🌈 رائع! اجعل الشخصيات تنبض بالحياة!",
          "🔥 إبداع متقد! استمر في هذا المستوى الرائع!"
        ]
      },
      
      // أصوات التنبيه اللطيف
      gentleAlert: {
        sounds: ['notification-pop.mp3', 'cosmic-click.mp3', 'crystal-ping.mp3'],
        messages: [
          "⏰ الوقت ينساب كالحكايات... فكر في خاتمة مناسبة!",
          "💡 لحظة تأمل... ما رأيك في إضافة منعطف مثير؟",
          "🤔 توقف قليلاً... كيف يمكن ربط هذا الجزء بما سبق؟"
        ]
      },
      
      // أصوات الإنجاز والنجاح
      achievement: {
        sounds: ['epic-victory.mp3', 'battle-victory.mp3', 'fireworks-burst.mp3', 'crowd-cheer.mp3'],
        messages: [
          "🏆 تحفة فنية! لقد أبدعتم قصة رائعة!",
          "👏 أداء مذهل! قصتكم ستبقى في الذاكرة!",
          "🎉 إنجاز استثنائي! أنتم محترفو السرد!",
          "⭐ قصة تستحق النشر! إبداع فوق الخيال!"
        ]
      },
      
      // أصوات الأخطاء اللطيفة
      softError: {
        sounds: ['button-hover.mp3', 'menu-open.mp3'],
        messages: [
          "🤗 لا بأس، دعونا نعيد المحاولة بطريقة أفضل!",
          "💭 فكرة جميلة، لكن هيا نطورها أكثر!",
          "🌱 كل بداية تحتاج لمساعدة... هيا نتعلم معاً!"
        ]
      },
      
      // دالة تشغيل صوت ذكي مع رسالة
      play: function(category, showNotification = true) {
        const categoryData = this[category];
        if (!categoryData) return;
        
        const randomSound = categoryData.sounds[Math.floor(Math.random() * categoryData.sounds.length)];
        const randomMessage = categoryData.messages[Math.floor(Math.random() * categoryData.messages.length)];
        
        // تشغيل الصوت
        if (typeof ActivityManager !== 'undefined' && ActivityManager.playSound) {
          ActivityManager.playSound(randomSound.replace('.mp3', ''));
        }
        
        // عرض الإشعار
        if (showNotification && typeof ActivityManager !== 'undefined' && ActivityManager.showNotification) {
          ActivityManager.showNotification(randomMessage, 'success');
        }
        
        // عرض رسالة تحفيزية في المنطقة المخصصة
        this.showMotivationMessage(randomMessage);
        
        return { sound: randomSound, message: randomMessage };
      },
      
      // عرض رسالة تحفيزية
      showMotivationMessage: function(message) {
        const motivationArea = document.getElementById('motivationText');
        if (motivationArea) {
          motivationArea.innerHTML = message;
          motivationArea.parentElement.style.display = 'block';
          
          // إخفاء الرسالة بعد 5 ثوان
          setTimeout(() => {
            motivationArea.parentElement.style.display = 'none';
          }, 5000);
        }
      }
    };

    // نظام الإشعارات التفاعلية المتقدم
    const interactiveNotifications = {
      // إشعار الترحيب
      welcome: function() {
        setTimeout(() => {
          smartSoundSystem.play('welcome');
        }, 500);
      },
      
      // إشعار بداية النشاط
      gameStart: function() {
        smartSoundSystem.play('gameStart');
        
        // إشعار إضافي بعد 3 ثوان
        setTimeout(() => {
          const tips = [
            "💡 نصيحة: استخدم التفاصيل الحسية لجعل القصة أكثر حيوية!",
            "🎯 نصيحة: اربط كل جزء بما قاله زملاؤك السابقون!",
            "✨ نصيحة: لا تخف من الإبداع والخيال الواسع!"
          ];
          const randomTip = tips[Math.floor(Math.random() * tips.length)];
          ActivityManager.showNotification && ActivityManager.showNotification(randomTip, 'info');
        }, 3000);
      },
      
      // تشجيع منتظم أثناء السرد
      encourageDuringStory: function() {
        const randomDelay = Math.random() * 15000 + 10000; // بين 10-25 ثانية
        setTimeout(() => {
          smartSoundSystem.play('encouragement');
        }, randomDelay);
      },
      
      // تنبيه لطيف قبل انتهاء الوقت
      timeWarning: function(secondsLeft) {
        if (secondsLeft === 15) {
          smartSoundSystem.play('gentleAlert');
        }
      },
      
      // احتفال بالإنجاز
      celebrate: function() {
        smartSoundSystem.play('achievement');
        
        // تأثيرات بصرية إضافية
        setTimeout(() => {
          if (typeof confetti !== 'undefined') {
            confetti({
              particleCount: 150,
              spread: 90,
              origin: { y: 0.6 },
              colors: ['#d32f2f', '#ff9800', '#4caf50', '#2196f3', '#9c27b0']
            });
          }
        }, 500);
      }
    };

    // قوالب الأدوار والاقتراحات حسب النوع
    const storyRoles = {
      adventure: [
        "ابدأ المغامرة! أين ومتى تحدث؟",
        "أضف شخصية جديدة للمغامرة",
        "ما التحدي الذي واجهوه؟",
        "كيف حلوا المشكلة؟",
        "اختتم المغامرة بنهاية مثيرة!"
      ],
      fantasy: [
        "اخلق العالم السحري! صف المكان",
        "أضف شخصية سحرية مميزة",
        "ما القوة السحرية التي ظهرت؟",
        "ما التحدي السحري الذي واجهوه؟",
        "كيف انتهت القصة السحرية؟"
      ],
      space: [
        "انطلق للفضاء! صف الرحلة",
        "أضف كائن فضائي ودود",
        "ما الكوكب الذي اكتشفوه؟",
        "ما المفاجأة التي وجدوها؟",
        "كيف عادوا للأرض؟"
      ],
      school: [
        "ابدأ اليوم المدرسي! ماذا حدث؟",
        "أضف صديق جديد أو معلم مميز",
        "ما النشاط المثير الذي شاركوا فيه؟",
        "ما المشكلة التي حلوها معاً؟",
        "كيف انتهى اليوم المدرسي؟"
      ],
      mystery: [
        "ابدأ اللغز! ماذا اكتشفوا؟",
        "أضف دليل مهم للقصة",
        "ما الاكتشاف المثير الذي توصلوا إليه؟",
        "كيف حلوا اللغز؟",
        "ما السر الذي كشفوه؟"
      ],
      friendship: [
        "ابدأ بشخصيتين! كيف التقيا؟",
        "أضف موقف يظهر الصداقة",
        "ما التحدي الذي واجها معاً؟",
        "كيف ساعد كل منهما الآخر؟",
        "كيف قوت الصداقة بينهما؟"
      ],
      custom: [
        "ابدأ القصة! اختر الشخصيات والمكان",
        "أضف تطور مثير للأحداث",
        "أضف تحدي أو مشكلة",
        "كيف سيحل الأبطال هذا التحدي؟",
        "اختتم القصة بنهاية رائعة!"
      ]
    };

    // رسائل تحفيزية متنوعة
    const motivationMessages = [
      "🌟 رائع! أضف المزيد من التفاصيل المثيرة!",
      "🎭 ممتاز! اجعل الشخصيات تتفاعل أكثر!",
      "🚀 إبداع رائع! ما رأيك في إضافة مفاجأة؟",
      "✨ أحسنت! استخدم خيالك لجعل القصة أكثر تشويقاً!",
      "🎨 مذهل! أضف تفاصيل حسية (ماذا يرون/يسمعون/يشعرون؟)",
      "🌈 عظيم! اربط الأحداث بما قاله زملاؤك!",
      "⭐ ممتاز! أضف حوار بين الشخصيات!",
      "🎪 رائع! اجعل الأحداث أكثر إثارة!"
    ];

    // اقتراحات الربط بين الأجزاء
    const connectionSuggestions = [
      "بعد ذلك...",
      "فجأة...",
      "في هذه الأثناء...",
      "لكن...",
      "وعندما...",
      "ثم حدث شيء غير متوقع...",
      "في تلك اللحظة...",
      "وهكذا..."
    ];

    // تحميل بيانات الطلاب مع النظام الذكي
    async function loadStudentData() {
      try {
        // إشعار بداية التحميل
        ActivityManager.showNotification && ActivityManager.showNotification('🔄 جاري تحميل بيانات الطلاب...', 'info');
        
        const response = await fetch('../data/studentData.json');
        const data = await response.json();
        
        // تحويل البيانات من البنية الحالية إلى البنية المطلوبة
        students = [];
        Object.keys(data).forEach(className => {
          if (Array.isArray(data[className])) {
            data[className].forEach(studentName => {
              students.push({
                name: studentName,
                class: className
              });
            });
          }
        });
        
        populateClassSelect();
        
        // إشعار نجاح التحميل مع تأثيرات صوتية
        smartSoundSystem.play('achievement', false);
        const successMessage = `✅ تم تحميل ${students.length} طالب من ${Object.keys(data).length} صف بنجاح!`;
        ActivityManager.showNotification && ActivityManager.showNotification(successMessage, 'success');
        
        console.log('تم تحميل', students.length, 'طالب من', Object.keys(data).length, 'صف');
      } catch (error) {
        console.error('خطأ في تحميل بيانات الطلاب:', error);
        
        // إشعار الخطأ مع صوت لطيف
        smartSoundSystem.play('softError', false);
        
        // بيانات احتياطية للاختبار
        students = [
          { name: "أحمد محمد", class: "خامس 1" },
          { name: "فاطمة علي", class: "خامس 1" },
          { name: "عمر سالم", class: "خامس 1" },
          { name: "عائشة حسن", class: "خامس 2" },
          { name: "محمد خالد", class: "خامس 2" },
          { name: "نور الدين", class: "خامس 2" }
        ];
        populateClassSelect();
        
        const fallbackMessage = '⚠️ تم استخدام بيانات تجريبية للاختبار. تحقق من ملف البيانات.';
        ActivityManager.showNotification && ActivityManager.showNotification(fallbackMessage, 'warning');
        
        // اقتراح حل المشكلة
        setTimeout(() => {
          const helpMessage = '💡 تأكد من وجود ملف studentData.json في مجلد data';
          ActivityManager.showNotification && ActivityManager.showNotification(helpMessage, 'info');
        }, 3000);
      }
    }

    // ملء قائمة الصفوف
    function populateClassSelect() {
      const classSelect = document.getElementById('classSelect');
      const classes = [...new Set(students.map(s => s.class))];
      
      classSelect.innerHTML = '<option value="">-- اختر الصف --</option>';
      classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classSelect.appendChild(option);
      });
    }

    // معالجة تغيير طريقة السرد
    function handleModeChange() {
      ActivityManager.playSound('click');
      const container = document.getElementById('studentSelection');
      container.innerHTML = '';
      container.style.display = 'none';
      
      // إظهار/إخفاء خيارات إضافية حسب النوع
      const mode = document.getElementById('modeSelect').value;
      const storyStarterGroup = document.getElementById('storyStarterGroup');
      
      if (mode === 'creative' || mode === 'select-group') {
        storyStarterGroup.style.display = 'block';
      } else {
        storyStarterGroup.style.display = 'none';
      }
    }

    // معاينة طريقة اللعب
    function previewGameMode() {
      const mode = document.getElementById('modeSelect').value;
      if (!mode) {
        ActivityManager.showNotification('يرجى اختيار طريقة السرد أولاً', 'warning');
        return;
      }

      let description = '';
      switch(mode) {
        case 'sequential':
          description = `🔄 السرد المتسلسل:\n• كل طالب يكمل جملة أو فقرة\n• الانتقال بترتيب الجلوس\n• كل طالب له ${document.getElementById('timePerStudent').value} ثانية\n• يربط كل طالب قصته بما قاله السابق`;
          break;
        case 'random':
          description = `🎲 السرد العشوائي:\n• اختيار عشوائي للطالب في كل دور\n• كل طالب يضيف جزء جديد\n• أكثر إثارة وتشويق\n• يحفز الانتباه لدى الجميع`;
          break;
        case 'creative':
          description = `🎨 السرد الإبداعي:\n• كل طالب يضيف عنصر مميز (شخصية، مكان، حدث)\n• حرية أكبر في الإبداع\n• يمكن البدء بفكرة من المعلم\n• تطوير مهارات التفكير الإبداعي`;
          break;
        case 'select-group':
          description = `👥 اختيار المجموعة:\n• المعلم يختار الطلاب المشاركين\n• مناسب للمجموعات الصغيرة\n• تحكم أكبر في المشاركة\n• يضمن مشاركة طلاب محددين`;
          break;
      }
      
      ActivityManager.showNotification(description, 'info');
    }

    // بدء النشاط الشفوي
    function startOralStoryActivity() {
      const className = document.getElementById('classSelect').value;
      const mode = document.getElementById('modeSelect').value;
      const storyType = document.getElementById('storyTypeSelect').value;
      const timePerStudent = parseInt(document.getElementById('timePerStudent').value);
      
      if (!className || !mode || !storyType) {
        ActivityManager.showNotification('يرجى اختيار جميع الخيارات المطلوبة', 'warning');
        return;
      }
      
      const classStudents = students.filter(s => s.class === className);
      if (classStudents.length === 0) {
        ActivityManager.showNotification('لا توجد طلاب في هذا الصف', 'error');
        return;
      }
      
      // تهيئة المتغيرات
      currentMode = mode;
      currentStoryType = storyType;
      totalTime = timePerStudent;
      currentTime = timePerStudent;
      currentRound = 1;
      storyParts = [];
      
      // تحديد الطلاب حسب الطريقة
      if (mode === 'select-group') {
        selectedManualStudents = [];
        showStudentSelection(className, mode);
        return;
      } else {
        currentStudentList = [...classStudents.map(s => s.name)];
        totalRounds = Math.min(currentStudentList.length, 8); // حد أقصى 8 أدوار
      }
      
      startOralStorySession();
    }

    // بدء جلسة السرد الشفوي
    function startOralStorySession() {
      // إخفاء الإعدادات وإظهار منطقة النشاط
      document.getElementById('settingsCard').style.display = 'none';
      document.getElementById('studentSelection').style.display = 'none';
      document.getElementById('storyContainer').style.display = 'block';
      document.getElementById('participantsContainer').style.display = 'block';
      
      // تحديث واجهة المعلومات
      updateStoryInfo();
      displayParticipants();
      
      // بدء مع الطالب الأول
      nextSpeaker();
      
      // تفعيل النظام الصوتي الذكي
      interactiveNotifications.gameStart();
      
      // بدء التشجيع المنتظم
      interactiveNotifications.encourageDuringStory();
    }

    // تحديث معلومات القصة
    function updateStoryInfo() {
      const topicNames = {
        adventure: 'مغامرة شيقة',
        fantasy: 'خيال وسحر', 
        space: 'استكشاف الفضاء',
        school: 'حياة مدرسية',
        mystery: 'لغز ومغامرة',
        friendship: 'صداقة وتعاون',
        custom: 'قصة حرة'
      };
      
      document.getElementById('topicText').textContent = topicNames[currentStoryType] || 'قصة إبداعية';
      document.getElementById('totalRounds').textContent = totalRounds;
    }

    // عرض المشاركين
    function displayParticipants() {
      const grid = document.getElementById('participantsGrid');
      const waiting = document.getElementById('waitingStudents');
      
      grid.innerHTML = '';
      waiting.innerHTML = '';
      
      // عرض المشاركين النشطين
      const activeStudents = currentStudentList.slice(0, totalRounds);
      activeStudents.forEach((student, index) => {
        const card = document.createElement('div');
        card.className = 'participant-card';
        card.innerHTML = `
          <div><i class="fas fa-user"></i></div>
          <div>${student}</div>
          <div>الدور ${index + 1}</div>
        `;
        if (index === currentSpeakerIndex) {
          card.classList.add('active');
        }
        if (index < currentRound - 1) {
          card.classList.add('done');
        }
        grid.appendChild(card);
      });
      
      // عرض قائمة الانتظار
      const waitingStudents = currentStudentList.slice(totalRounds);
      waitingStudents.forEach(student => {
        const span = document.createElement('span');
        span.className = 'waiting-student';
        span.textContent = student;
        waiting.appendChild(span);
      });
    }

    // الانتقال للطالب التالي
    function nextSpeaker() {
      if (currentRound > totalRounds) {
        finishOralStory();
        return;
      }
      
      // تحديد الطالب حسب الطريقة
      let selectedStudent;
      
      switch(currentMode) {
        case 'sequential':
          selectedStudent = currentStudentList[currentSpeakerIndex];
          currentSpeakerIndex++;
          break;
          
        case 'random':
          const availableStudents = currentStudentList.filter(s => !usedStudents.includes(s));
          if (availableStudents.length === 0) {
            finishOralStory();
            return;
          }
          const randomIndex = Math.floor(Math.random() * availableStudents.length);
          selectedStudent = availableStudents[randomIndex];
          usedStudents.push(selectedStudent);
          break;
          
        case 'creative':
        case 'select-group':
          selectedStudent = currentStudentList[currentSpeakerIndex];
          currentSpeakerIndex++;
          break;
      }
      
      // تحديث الواجهة
      updateCurrentSpeaker(selectedStudent);
      updateStoryRole();
      displayParticipants();
      
      // تشغيل صوت تشجيعي للمتحدث الجديد
      smartSoundSystem.play('encouragement', false);
      
      // رسالة ترحيب شخصية
      setTimeout(() => {
        const welcomeMessages = [
          `🌟 حان دورك يا ${selectedStudent}! أطلق العنان لإبداعك!`,
          `⭐ ${selectedStudent}، الكلمة لك الآن! اجعلنا نعيش القصة!`,
          `🎭 ${selectedStudent}، نحن متحمسون لسماع جزئك من الحكاية!`,
          `✨ ${selectedStudent}، دورك لإضافة السحر للقصة!`
        ];
        const randomWelcome = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
        ActivityManager.showNotification && ActivityManager.showNotification(randomWelcome, 'success');
      }, 500);
      
      // بدء المؤقت
      startOralTimer();
      
      // تشجيع منتظم خلال دور الطالب
      interactiveNotifications.encourageDuringStory();
      
      // تأثيرات بصرية
      highlightCurrentSpeaker();
      showMotivationMessage();
      
      ActivityManager.playSound('click');
    }

    // تحديث الطالب الحالي
    function updateCurrentSpeaker(studentName) {
      document.getElementById('speakerName').textContent = studentName;
      document.getElementById('currentRound').textContent = `الدور ${currentRound}`;
      
      // تحديث شريط التقدم
      const progress = ((currentRound - 1) / totalRounds) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
    }

    // تحديث دور القصة
    function updateStoryRole() {
      const roles = storyRoles[currentStoryType] || storyRoles.custom;
      const roleIndex = Math.min(currentRound - 1, roles.length - 1);
      const roleText = roles[roleIndex];
      
      document.getElementById('roleText').innerHTML = `<i class="fas fa-microphone"></i> ${roleText}`;
      
      // إضافة اقتراح الربط للأدوار غير الأولى
      if (currentRound > 1 && Math.random() > 0.5) {
        const connection = connectionSuggestions[Math.floor(Math.random() * connectionSuggestions.length)];
        document.getElementById('roleText').innerHTML += `<br><small style="opacity: 0.8;">💡 يمكنك البدء بـ: "${connection}"</small>`;
      }
    }

    // بدء مؤقت السرد
    function startOralTimer() {
      if (timerInterval) clearInterval(timerInterval);
      
      currentTime = totalTime;
      isPaused = false;
      
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        if (!isPaused) {
          currentTime--;
          updateTimerDisplay();
          
          if (currentTime <= 10 && currentTime > 0) {
            // تحذير الوقت
            document.getElementById('timeRemaining').classList.add('time-warning');
            if (currentTime <= 5) {
              ActivityManager.playSound('click');
            }
          }
          
          if (currentTime <= 0) {
            timeUp();
          }
        }
      }, 1000);
    }

    // تحديث عرض المؤقت
    function updateTimerDisplay() {
      const canvas = document.getElementById('timerCanvas');
      const ctx = canvas.getContext('2d');
      const timeElement = document.getElementById('timeRemaining');
      
      // تنظيف الكانفاس
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // رسم الدائرة الخارجية
      ctx.beginPath();
      ctx.arc(60, 60, 50, 0, 2 * Math.PI);
      ctx.strokeStyle = '#e9ecef';
      ctx.lineWidth = 8;
      ctx.stroke();
      
      // رسم التقدم
      const progress = currentTime / totalTime;
      const startAngle = -Math.PI / 2;
      const endAngle = startAngle + (2 * Math.PI * progress);
      
      ctx.beginPath();
      ctx.arc(60, 60, 50, startAngle, endAngle);
      
      if (currentTime <= 10) {
        ctx.strokeStyle = '#dc3545'; // أحمر للتحذير
      } else if (currentTime <= 20) {
        ctx.strokeStyle = '#ffc107'; // أصفر للتنبيه
      } else {
        ctx.strokeStyle = '#28a745'; // أخضر عادي
      }
      
      ctx.lineWidth = 8;
      ctx.lineCap = 'round';
      ctx.stroke();
      
      // تحديث النص
      timeElement.textContent = currentTime;
      timeElement.className = currentTime <= 10 ? 'time-remaining time-warning' : 'time-remaining';
      
      // تفعيل النظام الصوتي الذكي
      if (currentTime === 15) {
        interactiveNotifications.timeWarning(15);
      }
    }

    // انتهاء الوقت
    function timeUp() {
      clearInterval(timerInterval);
      document.getElementById('timeRemaining').classList.remove('time-warning');
      
      ActivityManager.playSound('win');
      
      // إضافة جزء القصة
      const currentSpeaker = document.getElementById('speakerName').textContent;
      storyParts.push({
        speaker: currentSpeaker,
        round: currentRound,
        role: document.getElementById('roleText').textContent
      });
      
      // الانتقال للدور التالي
      currentRound++;
      
      setTimeout(() => {
        nextSpeaker();
      }, 1500);
    }

    // توقف مؤقت
    function pauseTimer() {
      isPaused = !isPaused;
      const pauseBtn = document.getElementById('pauseBtn');
      
      if (isPaused) {
        pauseBtn.innerHTML = '<i class="fas fa-play"></i> استئناف';
        pauseBtn.className = 'btn btn-info touch-target';
        ActivityManager.showNotification('تم إيقاف المؤقت مؤقتاً', 'info');
      } else {
        pauseBtn.innerHTML = '<i class="fas fa-pause"></i> توقف مؤقت';
        pauseBtn.className = 'btn btn-warning touch-target';
        ActivityManager.showNotification('تم استئناف المؤقت', 'success');
      }
    }

    // إظهار اقتراح إبداعي ذكي
    function showHint() {
      // تشغيل صوت تحفيزي
      smartSoundSystem.play('encouragement');
      
      // اقتراحات حسب نوع القصة والدور الحالي
      const roleText = document.getElementById('roleText').textContent;
      const storyType = currentStoryType;
      
      let specificHints = [];
      
      // اقتراحات حسب الدور
      if (roleText.includes('البطل')) {
        specificHints = [
          "🦸‍♂️ فكر في تحدي جديد يواجه البطل!",
          "⚡ ما القوة الخاصة التي يكتشفها البطل الآن؟",
          "🎯 كيف سيحل البطل هذه المشكلة بطريقة مبتكرة؟"
        ];
      } else if (roleText.includes('الحكيم')) {
        specificHints = [
          "🧙‍♂️ أعط نصيحة حكيمة أو معلومة مهمة!",
          "📚 شارك معرفة قديمة تساعد في الحل!",
          "🔮 تنبأ بشيء مهم سيحدث في القصة!"
        ];
      } else if (roleText.includes('المساعد')) {
        specificHints = [
          "🤝 كيف ستساعد الأبطال في هذه اللحظة؟",
          "💡 اقترح فكرة ذكية لحل المشكلة!",
          "🛠️ ما الأداة أو المهارة التي ستقدمها؟"
        ];
      } else {
        // اقتراحات عامة
        specificHints = [
          "✨ أضف تفصيلاً حسياً (ماذا يُسمع/يُرى/يُشم؟)",
          "🎭 اجعل الشخصية تتفاعل مع ما حدث سابقاً",
          "🌟 أضف عنصر مفاجأة مثير!",
          "💬 استخدم حواراً بين الشخصيات",
          "🌈 اربط قصتك بتفاصيل من حياتنا الحقيقية"
        ];
      }
      
      const randomHint = specificHints[Math.floor(Math.random() * specificHints.length)];
      
      // عرض الاقتراح مع تأثير بصري
      ActivityManager.showNotification(randomHint, 'info');
      
      // رسالة تشجيعية إضافية بعد ثانيتين
      setTimeout(() => {
        const encouragement = [
          "🎨 لا توجد فكرة خاطئة في عالم الإبداع!",
          "🚀 دع خيالك يحلق عالياً!",
          "⭐ كل كلمة تقولها تُثري القصة!"
        ];
        const randomEncouragement = encouragement[Math.floor(Math.random() * encouragement.length)];
        smartSoundSystem.showMotivationMessage(randomEncouragement);
      }, 2000);
    }

    // تمييز الطالب الحالي
    function highlightCurrentSpeaker() {
      const speakerSection = document.querySelector('.current-speaker-section');
      speakerSection.classList.add('speaker-highlight');
      
      setTimeout(() => {
        speakerSection.classList.remove('speaker-highlight');
      }, 2000);
    }

    // إظهار رسالة تحفيزية
    function showMotivationMessage() {
      const motivationElement = document.getElementById('motivationText');
      const messages = motivationMessages;
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      
      motivationElement.textContent = randomMessage;
      
      // تأثير ظهور
      motivationElement.style.opacity = '0';
      setTimeout(() => {
        motivationElement.style.opacity = '1';
      }, 500);
    }

    // إنهاء السرد الشفوي
    function finishOralStory() {
      clearInterval(timerInterval);
      
      // تفعيل نظام الاحتفال الذكي
      interactiveNotifications.celebrate();
      
      setTimeout(() => {
        showOralStoryResults();
      }, 2000);
    }

    // عرض نتائج السرد الشفوي
    function showOralStoryResults() {
      const modal = document.getElementById('thankYouModal');
      const participantList = document.getElementById('participantList');
      
      // تنظيف القائمة
      participantList.innerHTML = '';
      
      // إضافة المشاركين مع أدوارهم
      storyParts.forEach((part, index) => {
        const li = document.createElement('li');
        li.className = 'honor-item';
        li.innerHTML = `
          <span class="honor-rank">${part.round}</span>
          <span class="honor-team">${part.speaker}</span>
          <span class="honor-names">مشارك في السرد</span>
        `;
        participantList.appendChild(li);
      });
      
      // تحديث عنوان النافذة
      document.querySelector('.victory-team').textContent = '🎭 شكراً لسردكم الرائع!';
      document.querySelector('.victory-names').textContent = 'المشاركون في السرد الشفوي:';
      
      modal.style.display = 'flex';
    }

    // إنشاء قصة تلقائية
    function generateAutomaticStory() {
      const className = document.getElementById('classSelect').value;
      const storyType = document.getElementById('storyTypeSelect').value;
      const storyIdea = document.getElementById('storyIdea').value.trim();
      
      if (!className || !storyType) {
        ActivityManager.showNotification('يرجى اختيار الصف ونوع القصة أولاً', 'warning');
        return;
      }
      
      const classStudents = students.filter(s => s.class === className);
      if (classStudents.length === 0) {
        ActivityManager.showNotification('لا توجد طلاب في هذا الصف', 'error');
        return;
      }
      
      // اختيار طالب عشوائي
      const randomStudent = classStudents[Math.floor(Math.random() * classStudents.length)];
      
      // إنشاء القصة
      const story = createStory(randomStudent.name, storyType, storyIdea);
      
      // عرض القصة
      displayGeneratedStory(story, randomStudent.name, storyType);
      
      // تأثيرات الاحتفال
      playStoryGenerationEffects();
    }

    // إنشاء القصة بناءً على المعطيات
    function createStory(studentName, storyType, customIdea = '') {
      const template = storyTemplates[storyType];
      if (!template) return 'نوع القصة غير متوفر.';
      
      // اختيار عناصر عشوائية من القالب
      const beginning = template.beginnings[Math.floor(Math.random() * template.beginnings.length)];
      const middle = template.middles[Math.floor(Math.random() * template.middles.length)];
      const end = template.ends[Math.floor(Math.random() * template.ends.length)];
      
      let story = beginning.replace('{name}', studentName) + ' ' + middle + '. ';
      
      // إضافة الفكرة المخصصة إذا توفرت
      if (customIdea) {
        story += `وكما خطط ${studentName}، ${customIdea}. `;
      }
      
      story += end.replace('{name}', studentName);
      
      return story;
    }

    // عرض القصة المُنشأة
    function displayGeneratedStory(story, authorName, storyType) {
      // إخفاء منطقة الإعدادات
      document.getElementById('settingsCard').style.display = 'none';
      document.getElementById('studentSelection').style.display = 'none';
      document.getElementById('storyContainer').style.display = 'none';
      
      // إظهار منطقة القصة
      const container = document.getElementById('generatedStoryContainer');
      container.style.display = 'block';
      
      // تحديث محتوى القصة
      document.getElementById('storyAuthor').textContent = `بقلم: ${authorName}`;
      document.getElementById('storyContent').textContent = story;
      
      // حفظ القصة في السجل
      generatedStories.push({
        author: authorName,
        type: storyType,
        content: story,
        timestamp: new Date()
      });
    }

    // تأثيرات إنشاء القصة
    function playStoryGenerationEffects() {
      ActivityManager.playSound('success');
      
      // إنشاء تأثير احتفالي
      const celebrationElement = document.createElement('div');
      celebrationElement.className = 'celebration-effect';
      celebrationElement.innerHTML = '✨📖✨';
      document.body.appendChild(celebrationElement);
      
      setTimeout(() => {
        celebrationElement.remove();
      }, 2000);
      
      // تأثير Confetti
      setTimeout(() => {
        confetti({
          particleCount: 80,
          spread: 60,
          origin: { y: 0.7 },
          colors: ['#667eea', '#764ba2', '#ffecd2', '#fcb69f']
        });
        
        ActivityManager.playSound('celebration');
      }, 500);
      
      // رسالة تحفيزية
      setTimeout(() => {
        ActivityManager.showNotification('🎉 تم إنشاء قصة رائعة! أحسنت!', 'success');
      }, 1000);
    }

    // إعادة إنشاء قصة جديدة
    function regenerateStory() {
      const className = document.getElementById('classSelect').value;
      const storyType = document.getElementById('storyTypeSelect').value;
      const storyIdea = document.getElementById('storyIdea').value.trim();
      
      // اختيار طالب مختلف
      const classStudents = students.filter(s => s.class === className);
      const availableStudents = classStudents.filter(s => 
        !generatedStories.some(story => story.author === s.name)
      );
      
      let selectedStudent;
      if (availableStudents.length > 0) {
        selectedStudent = availableStudents[Math.floor(Math.random() * availableStudents.length)];
      } else {
        selectedStudent = classStudents[Math.floor(Math.random() * classStudents.length)];
      }
      
      const story = createStory(selectedStudent.name, storyType, storyIdea);
      displayGeneratedStory(story, selectedStudent.name, storyType);
      playStoryGenerationEffects();
    }

    // مشاركة القصة
    function shareStory() {
      const storyContent = document.getElementById('storyContent').textContent;
      const storyAuthor = document.getElementById('storyAuthor').textContent;
      
      const shareText = `${storyAuthor}\n\n${storyContent}\n\n#قصتي_الرائعة #إبداع_الطلاب`;
      
      if (navigator.share) {
        navigator.share({
          title: 'قصتي الرائعة',
          text: shareText
        }).catch(() => {
          copyToClipboard(shareText);
        });
      } else {
        copyToClipboard(shareText);
      }
    }

    // نسخ النص للحافظة
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          ActivityManager.showNotification('تم نسخ القصة للحافظة!', 'success');
        });
      } else {
        // Fallback للمتصفحات القديمة
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        ActivityManager.showNotification('تم نسخ القصة للحافظة!', 'success');
      }
    }

    // العودة للإعدادات من منطقة القصة
    function backToSettings() {
      document.getElementById('settingsCard').style.display = 'block';
      document.getElementById('generatedStoryContainer').style.display = 'none';
      document.getElementById('storyContainer').style.display = 'none';
      document.getElementById('studentSelection').style.display = 'none';
    }

    // عرض منطقة اختيار الطلاب
    function showStudentSelection(className, mode) {
      const container = document.getElementById('studentSelection');
      const classStudents = students.filter(s => s.class === className);
      
      container.innerHTML = '';
      container.style.display = 'block';
      
      // إنشاء عنوان المنطقة
      const header = document.createElement('div');
      header.className = 'students-selection-header mobile-text-center';
      header.innerHTML = `
        <h3><i class="fas fa-users"></i> اختر الطلاب المشاركين في السرد الشفوي</h3>
        <p>انقر على الطلاب لاختيارهم ${mode === 'select-single' ? '(طالب واحد فقط)' : '(عدة طلاب)'}</p>
      `;
      container.appendChild(header);
      
      // إنشاء بطاقات الطلاب
      const cardsContainer = document.createElement('div');
      cardsContainer.className = 'student-cards-grid mobile-grid-2';
      
      classStudents.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-selection-card touch-target';
        card.innerHTML = `
          <div class="student-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="student-name">${student.name}</div>
        `;
        
        card.addEventListener('click', () => {
          ActivityManager.playSound('click');
          
          if (mode === 'select-single') {
            // إزالة التحديد من جميع الطلاب
            document.querySelectorAll('.student-selection-card').forEach(c => 
              c.classList.remove('selected'));
            selectedManualStudents = [student.name];
            card.classList.add('selected');
          } else {
            // وضع متعدد الطلاب
            if (selectedManualStudents.includes(student.name)) {
              selectedManualStudents = selectedManualStudents.filter(n => n !== student.name);
              card.classList.remove('selected');
            } else {
              selectedManualStudents.push(student.name);
              card.classList.add('selected');
            }
          }
        });
        
        cardsContainer.appendChild(card);
      });
      
      container.appendChild(cardsContainer);
      
      // زر بدء السرد
      const startButton = document.createElement('button');
      startButton.className = 'btn btn-primary start-story-btn touch-target mobile-full-width';
      startButton.innerHTML = '<i class="fas fa-play"></i> بدء السرد الشفوي';
      startButton.addEventListener('click', () => {
        if (selectedManualStudents.length === 0) {
          ActivityManager.showNotification('يرجى اختيار طالب واحد على الأقل', 'warning');
          return;
        }
        
        currentStudentList = [...selectedManualStudents];
        totalRounds = Math.min(currentStudentList.length, 8);
        usedStudents = [];
        startOralStorySession();
      });
      
      container.appendChild(startButton);
    }

    // بدء المؤقت (للنظام المرئي الجديد)
    function startTimer() {
      const canvas = document.getElementById('timerCanvas');
      const ctx = canvas.getContext('2d');
      secondsPassed = 0;

      function drawTimer() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // رسم الدائرة الخارجية
        ctx.beginPath();
        ctx.arc(75, 75, 65, 0, 2 * Math.PI);
        ctx.strokeStyle = '#E0E0E0';
        ctx.lineWidth = 10;
        ctx.stroke();

        // رسم التقدم
        const progress = (secondsPassed % 300) / 300; // كل 5 دقائق
        ctx.beginPath();
        ctx.arc(75, 75, 65, -Math.PI / 2, (2 * Math.PI * progress) - Math.PI / 2);
        ctx.strokeStyle = OmaniColors.red;
        ctx.lineWidth = 10;
        ctx.stroke();

        // عرض الوقت
        ctx.fillStyle = OmaniColors.black;
        ctx.font = 'bold 18px Cairo';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const minutes = Math.floor(secondsPassed / 60);
        const seconds = secondsPassed % 60;
        const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        ctx.fillText(timeText, 75, 75);
      }

      drawTimer();
      timerInterval = setInterval(() => {
        secondsPassed++;
        drawTimer();
      }, 1000);
    }

    // إيقاف المؤقت
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // إعادة تعيين النشاط
    function resetStoryActivity() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      currentStudentList = [];
      usedStudents = [];
      selectedManualStudents = [];
      storyParts = [];
      currentRound = 1;
      currentSpeakerIndex = 0;
      currentTime = 45;
      totalTime = 45;
      isPaused = false;
      currentMode = '';
      currentStoryType = '';
      
      // إعادة عرض الإعدادات
      document.getElementById('settingsCard').style.display = 'block';
      document.getElementById('studentSelection').style.display = 'none';
      document.getElementById('storyContainer').style.display = 'none';
      document.getElementById('participantsContainer').style.display = 'none';
      document.getElementById('thankYouModal').style.display = 'none';
      
      // إعادة تعيين النموذج
      document.getElementById('storySettingsForm').reset();
      document.getElementById('studentSelection').innerHTML = '';
      
      // إخفاء العناصر الاختيارية
      document.getElementById('storyStarterGroup').style.display = 'none';
      
      // إعادة تعيين أزرار التحكم
      const pauseBtn = document.getElementById('pauseBtn');
      pauseBtn.innerHTML = '<i class="fas fa-pause"></i> توقف مؤقت';
      pauseBtn.className = 'btn btn-warning touch-target';
      
      document.getElementById('timeRemaining').classList.remove('time-warning');
      
      ActivityManager.showNotification('تم إعادة تعيين النشاط', 'success');
    }

    // تهيئة النشاط
    function initializeStoryActivity() {
      loadStudentData();
      
      // معالج أزرار التحكم
      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = '../main.html';
      });
      
      document.getElementById('muteBtn').addEventListener('click', () => {
        ActivityManager.toggleMute();
        const icon = document.querySelector('#muteBtn i');
        icon.className = ActivityManager.isMuted() ? 'fas fa-volume-mute' : 'fas fa-volume-up';
      });
      
      document.getElementById('instructionsBtn').addEventListener('click', () => {
        document.getElementById('instructionsModal').style.display = 'flex';
      });
      
      document.getElementById('fullscreenBtn').addEventListener('click', () => {
        ActivityManager.toggleFullscreen();
      });
      
      // معالج نموذج الإعدادات
      document.getElementById('storySettingsForm').addEventListener('submit', (e) => {
        e.preventDefault();
        startOralStoryActivity();
      });
      
      // معالج تغيير طريقة السرد
      document.getElementById('modeSelect').addEventListener('change', handleModeChange);
      
      // معالج زر معاينة طريقة اللعب
      document.getElementById('previewModeBtn').addEventListener('click', previewGameMode);
      
      // معالج زر دليل المعلم الذكي
      document.getElementById('helpBtn').addEventListener('click', () => {
        smartSoundSystem.play('encouragement', false);
        showSmartTeacherGuide();
      });
      
      // معالج أزرار النشاط الشفوي
      document.getElementById('nextSpeakerBtn').addEventListener('click', () => {
        if (timerInterval) {
          clearInterval(timerInterval);
          timeUp();
        }
      });
      
      document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
      document.getElementById('hintBtn').addEventListener('click', showHint);
      document.getElementById('finishStoryBtn').addEventListener('click', () => {
        if (confirm('هل أنت متأكد من إنهاء السرد؟')) {
          finishOralStory();
        }
      });
      
      // معالج أزرار النتائج
      document.getElementById('closeModalBtn').addEventListener('click', () => {
        document.getElementById('thankYouModal').style.display = 'none';
      });
      
      document.getElementById('modalBackBtn').addEventListener('click', resetStoryActivity);
      
      // تفعيل إشعار الترحيب
      interactiveNotifications.welcome();
    }

    // إغلاق نافذة التعليمات
    function closeInstructions() {
      document.getElementById('instructionsModal').style.display = 'none';
    }

    // دليل المعلم الذكي
    function showSmartTeacherGuide() {
      const tips = [
        {
          title: "💡 نصائح تفاعلية أثناء السرد",
          content: "شجع الطلاب على استخدام أسماء الشخصيات، وأوصاف المكان، والمشاعر الحقيقية للشخصيات"
        },
        {
          title: "🎭 تحفيز الإبداع",
          content: "استخدم عبارات مثل: 'ماذا لو حدث...؟' أو 'كيف شعرت الشخصية عندما...؟' لإثارة التفكير"
        },
        {
          title: "🔗 ربط الأجزاء",
          content: "ساعد الطلاب على ربط جزئهم بما قاله السابقون باستخدام عبارات مثل: 'بناءً على ما قاله أحمد...'"
        },
        {
          title: "⏰ إدارة الوقت",
          content: "إذا توقف الطالب، امنحه وقتاً للتفكير ثم قدم اقتراحاً لطيفاً لمساعدته على المتابعة"
        }
      ];
      
      const randomTip = tips[Math.floor(Math.random() * tips.length)];
      
      ActivityManager.showNotification(
        `${randomTip.title}\n${randomTip.content}`, 
        'info'
      );
      
      // إظهار نصيحة إضافية بعد 3 ثوان
      setTimeout(() => {
        const encouragementPhrases = [
          "🌟 ذكر الطلاب بأن كل فكرة مميزة ومفيدة!",
          "🎨 شجع الطلاب على استخدام الخيال بحرية!",
          "🤝 امدح الطلاب عندما يبنون على أفكار بعضهم البعض!",
          "🔥 اجعل الطلاب يشعرون بالحماس لسماع ما سيقوله زملاؤهم!"
        ];
        
        const randomEncouragement = encouragementPhrases[Math.floor(Math.random() * encouragementPhrases.length)];
        ActivityManager.showNotification(randomEncouragement, 'success');
      }, 3000);
    }

    // إضافة مستمعي الأحداث للوحة المفاتيح
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeInstructions();
        document.getElementById('thankYouModal').style.display = 'none';
      }
    });
  </script>
  
  <!-- Responsive JavaScript Helper -->
  <script src="../assets/js/responsive-helper.js"></script>
</body>
</html>
