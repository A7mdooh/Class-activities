<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>كوّن قصة - نشاط إنشاء القصص التفاعلية</title>
  
  <!-- الخطوط والأيقونات -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- المكتبات الخارجية -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  
  <!-- الأنماط والسكريبت الموحد -->
  <link rel="stylesheet" href="../assets/css/responsive.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <script src="../assets/css/style.css" type="text/javascript"></script>
  
  <style>
    /* تحسينات خاصة بنشاط إنشاء القصة */
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Cairo', sans-serif;
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .page-header {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-icon {
      font-size: 3rem;
      color: #667eea;
      animation: bounceIn 1s ease-out;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    .header-text h1 {
      margin: 0;
      color: #2d3748;
      font-size: 2.5rem;
      font-weight: 700;
    }

    .header-text p {
      margin: 5px 0 0 0;
      color: #718096;
      font-size: 1.1rem;
    }

    .game-settings-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      animation: slideInRight 0.8s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .settings-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      color: #2d3748;
    }

    .settings-header i {
      font-size: 1.5rem;
      color: #667eea;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      color: #2d3748;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: white;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      font-family: 'Cairo', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #8b4513;
      box-shadow: 0 4px 15px rgba(252, 182, 159, 0.4);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(252, 182, 159, 0.6);
    }

    .btn-success {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: #2d5016;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(132, 250, 176, 0.6);
    }

    /* منطقة عرض القصة المُنشأة */
    .generated-story-area {
      animation: fadeInScale 0.8s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .story-display-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .story-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
    }

    .story-header h3 {
      color: #2d3748;
      font-size: 1.8rem;
      margin: 0 0 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .story-author {
      color: #667eea;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .story-content {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 15%, #ffecd2 100%);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      line-height: 1.8;
      font-size: 1.2rem;
      color: #2d3748;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
      animation: typewriter 2s ease-out;
    }

    @keyframes typewriter {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .story-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    /* تحسينات للأجهزة المحمولة */
    @media (max-width: 768px) {
      .main-container {
        padding: 15px;
      }

      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .header-text h1 {
        font-size: 2rem;
      }

      .story-actions {
        grid-template-columns: 1fr;
      }
    }

    /* تأثيرات احتفالية */
    .celebration-effect {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      color: #ffd700;
      z-index: 1000;
      animation: celebrationPulse 2s ease-out;
    }

    @keyframes celebrationPulse {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }

    /* تحسينات اختيار الطلاب */
    .students-selection-area {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      animation: slideInLeft 0.8s ease-out;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .student-selection-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
    }

    .student-selection-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.6);
    }

    .student-selection-card.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transform: scale(1.05);
    }

    .student-avatar {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .student-name {
      font-size: 1.2rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- أزرار التحكم الموحدة -->
  <div class="control-buttons-container mobile-grid-4">
    <button class="control-btn touch-target" id="backBtn" title="العودة للصفحة الرئيسية">
      <i class="fas fa-home"></i>
    </button>
    <button class="control-btn touch-target" id="muteBtn" title="كتم الصوت">
      <i class="fas fa-volume-up"></i>
    </button>
    <button class="control-btn touch-target" id="instructionsBtn" title="تعليمات النشاط">
      <i class="fas fa-question-circle"></i>
    </button>
    <button class="control-btn touch-target" id="fullscreenBtn" title="ملء الشاشة">
      <i class="fas fa-expand"></i>
    </button>
  </div>

  <!-- نافذة تعليمات النشاط -->
  <div class="instructions-overlay responsive-modal" id="instructionsModal">
    <div class="instructions-content mobile-full-height">
      <button class="close-btn touch-target" onclick="closeInstructions()" title="إغلاق">
        <i class="fas fa-times"></i>
      </button>
      <div class="instructions-title">
        <i class="fas fa-book-open"></i> تعليمات نشاط كوّن قصة
      </div>
      <ul class="instructions-list">
        <li>اختر الصف الدراسي من القائمة المنسدلة.</li>
        <li>حدد نوع النشاط: فردي أو جماعي، عشوائي أو انتقائي.</li>
        <li>اختر نوع القصة: مغامرة، خيال، فضاء، أو حياة مدرسية.</li>
        <li>في الوضع الفردي، يمكنك إدخال فكرة أولية للقصة (اختياري).</li>
        <li>اضغط "إنشاء قصة تلقائية" لإنتاج قصة فورية مع طالب عشوائي.</li>
        <li>أو اختر "ابدأ النشاط" للوضع التفاعلي مع المؤقت.</li>
        <li>في الوضع الانتقائي، اختر الطلاب المشاركين من البطاقات.</li>
        <li>استخدم زر "التالي" للانتقال للطالب التالي في الوضع الجماعي.</li>
        <li>يمكنك مشاركة القصص المُنشأة أو إعادة إنشاء قصص جديدة.</li>
      </ul>
      <button class="btn btn-primary touch-target mobile-full-width" onclick="closeInstructions()">
        <i class="fas fa-check"></i> فهمت
      </button>
    </div>
  </div>

  <!-- نافذة النتائج النهائية -->
  <div class="victory-modal responsive-modal" id="thankYouModal">
    <div class="victory-content mobile-full-height">
      <button class="close-btn touch-target" id="closeModalBtn" title="إغلاق">
        <i class="fas fa-times"></i>
      </button>
      <div class="victory-fireworks">
        <i class="fas fa-star"></i> <i class="fas fa-star"></i> <i class="fas fa-star"></i>
      </div>
      <div class="victory-trophy">
        <i class="fas fa-trophy"></i>
      </div>
      <div class="victory-team">شكراً لمشاركتكم الرائعة!</div>
      <div class="victory-names">المشاركون في القصة:</div>
      <div class="honor-board-section">
        <ul class="honor-list" id="participantList"></ul>
      </div>
      <button class="btn btn-primary touch-target mobile-full-width" id="modalBackBtn">
        <i class="fas fa-redo"></i> نشاط جديد
      </button>
    </div>
  </div>

  <!-- المحتوى الرئيسي -->
  <div class="main-container mobile-full-width">
    <div class="page-header mobile-text-center">
      <div class="header-content">
        <div class="header-icon">
          <i class="fas fa-book-open"></i>
        </div>
        <div class="header-text">
          <h1>نشاط كوّن قصة</h1>
          <p>اختر الصف ونوع القصة لبدء التفاعل الإبداعي</p>
        </div>
      </div>
    </div>

    <!-- نموذج الإعدادات -->
    <div class="game-settings-card mobile-full-width" id="settingsCard">
      <div class="settings-header">
        <i class="fas fa-cog"></i>
        <h3>إعدادات النشاط</h3>
      </div>
      <form class="story-settings-form" id="storySettingsForm">
        <div class="form-group mobile-full-width">
          <label for="classSelect">
            <i class="fas fa-graduation-cap"></i> الصف الدراسي
          </label>
          <select id="classSelect" class="form-input mobile-full-width" required>
            <option value="">-- اختر الصف --</option>
          </select>
        </div>
        
        <div class="form-group mobile-full-width">
          <label for="modeSelect">
            <i class="fas fa-users"></i> نوع القصة
          </label>
          <select id="modeSelect" class="form-input mobile-full-width" required>
            <option value="">-- اختر نوع القصة --</option>
            <option value="single">فردية عشوائية</option>
            <option value="group">جماعية عشوائية</option>
            <option value="select-single">فردية انتقائية</option>
            <option value="select-group">جماعية انتقائية</option>
          </select>
        </div>

        <div class="form-group mobile-full-width">
          <label for="storyTypeSelect">
            <i class="fas fa-magic"></i> نوع القصة
          </label>
          <select id="storyTypeSelect" class="form-input mobile-full-width" required>
            <option value="">-- اختر نوع القصة --</option>
            <option value="adventure">مغامرة شيقة</option>
            <option value="fantasy">خيال وسحر</option>
            <option value="space">استكشاف الفضاء</option>
            <option value="school">حياة مدرسية</option>
            <option value="mystery">لغز ومغامرة</option>
            <option value="friendship">صداقة وتعاون</option>
          </select>
        </div>

        <div class="form-group mobile-full-width" id="storyIdeaGroup" style="display: none;">
          <label for="storyIdea">
            <i class="fas fa-lightbulb"></i> فكرة القصة (اختياري)
          </label>
          <textarea id="storyIdea" class="form-input mobile-full-width" rows="3" 
                    placeholder="اكتب فكرة أولية للقصة... (مثل: رحلة إلى الغابة، اكتشاف كنز مفقود، مساعدة صديق...)"></textarea>
        </div>
        
        <div class="button-group">
          <button type="submit" class="btn btn-primary touch-target mobile-full-width" id="startBtn">
            <i class="fas fa-play"></i> ابدأ النشاط
          </button>
          <button type="button" class="btn btn-secondary touch-target mobile-full-width" id="generateStoryBtn" style="display: none;">
            <i class="fas fa-magic"></i> إنشاء قصة تلقائية
          </button>
        </div>
      </form>
    </div>

    <!-- منطقة اختيار الطلاب -->
    <div class="students-selection-area mobile-full-width" id="studentSelection"></div>

    <!-- منطقة النشاط -->
    <div class="story-activity-area mobile-full-width" id="storyContainer">
      <div class="current-student-card mobile-text-center">
        <div class="student-name-display" id="studentName"></div>
        <div class="timer-container mobile-text-center">
          <canvas id="timerCanvas" width="150" height="150"></canvas>
          <div class="timer-label">مؤقت السرد</div>
        </div>
        <div class="story-controls mobile-grid-2">
          <button class="btn btn-success touch-target mobile-full-width" id="nextBtn" style="display:none">
            <i class="fas fa-arrow-left"></i> التالي
          </button>
          <button class="btn btn-danger touch-target mobile-full-width" id="finishBtn">
            <i class="fas fa-stop"></i> إنهاء القصة
          </button>
        </div>
        <div class="celebration-message" id="celebration">
          <i class="fas fa-star"></i> أحسنت! <i class="fas fa-star"></i>
        </div>
      </div>
    </div>

    <!-- منطقة عرض القصة المُنشأة -->
    <div class="generated-story-area mobile-full-width" id="generatedStoryContainer" style="display: none;">
      <div class="story-display-card">
        <div class="story-header">
          <h3><i class="fas fa-book-open"></i> قصتك الرائعة</h3>
          <div class="story-author" id="storyAuthor"></div>
        </div>
        <div class="story-content" id="storyContent"></div>
        <div class="story-actions">
          <button class="btn btn-primary touch-target mobile-full-width" id="regenerateStoryBtn">
            <i class="fas fa-sync-alt"></i> إنشاء قصة جديدة
          </button>
          <button class="btn btn-success touch-target mobile-full-width" id="shareStoryBtn">
            <i class="fas fa-share"></i> مشاركة القصة
          </button>
          <button class="btn btn-secondary touch-target mobile-full-width" id="backToSettingsBtn">
            <i class="fas fa-arrow-right"></i> العودة للإعدادات
          </button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // نظام الألوان العماني المتقدم
    const OmaniColors = {
      red: '#DC143C',
      green: '#228B22', 
      gold: '#FFD700',
      white: '#F8F9FA',
      black: '#1A1A1A'
    };

    let ActivityManager;
    
    // تهيئة النشاط
    document.addEventListener('DOMContentLoaded', function() {
      ActivityManager = new ActivityUtils({
        activityName: 'create-story',
        primaryColor: OmaniColors.red,
        secondaryColor: OmaniColors.green,
        sounds: {
          click: '../assets/media/sounds/Click.mp3',
          success: '../assets/media/sounds/name-start.mp3',
          celebration: '../assets/media/sounds/clap.mp3',
          win: '../assets/media/sounds/win.mp3'
        }
      });

      initializeStoryActivity();
    });

    // المتغيرات العامة للنشاط
    let students = [];
    let currentStudentList = [];
    let usedStudents = [];
    let selectedManualStudents = [];
    let timerInterval;
    let secondsPassed = 0;
    let currentMode = '';
    let currentStoryType = '';
    let generatedStories = [];

    // قوالب القصص حسب النوع
    const storyTemplates = {
      adventure: {
        beginnings: [
          "في يوم مشرق، قرر {name} الذهاب في مغامرة استكشافية إلى",
          "بينما كان {name} يتجول في الحديقة، اكتشف طريقاً غامضاً يؤدي إلى",
          "استيقظ {name} على صوت غريب، وعندما نظر من النافذة رأى",
          "وجد {name} خريطة قديمة في العلية تشير إلى كنز مدفون في"
        ],
        middles: [
          "غابة مليئة بالأشجار العملاقة والأصوات الغريبة",
          "كهف مضيء بأحجار كريمة ملونة",
          "جزيرة صغيرة وسط بحيرة زرقاء صافية",
          "قلعة قديمة محاطة بحديقة من الورود الملونة",
          "وادي سحري تطير فيه الفراشات الذهبية"
        ],
        ends: [
          "وبعد مغامرة مثيرة، عاد {name} إلى المنزل محملاً بذكريات جميلة وأصدقاء جدد.",
          "اكتشف {name} أن أعظم كنز هو الصداقات التي كوّنها في رحلته.",
          "تعلم {name} أن الشجاعة والذكاء يمكنهما حل أي مشكلة.",
          "عاد {name} وهو يحمل في قلبه حب المغامرة والاستكشاف."
        ]
      },
      fantasy: {
        beginnings: [
          "في عالم سحري بعيد، كان {name} ساحراً صغيراً يتعلم",
          "اكتشف {name} أنه يملك قوة سحرية خاصة تمكنه من",
          "في مملكة الجنيات، التقى {name} بجنية صغيرة طلبت منه",
          "بينما كان {name} يقرأ كتاباً سحرياً، انفتح باب سري إلى"
        ],
        middles: [
          "فنون السحر الأبيض لمساعدة الآخرين",
          "التحدث مع الحيوانات وفهم لغتهم",
          "أن يساعدها في العثور على نجمة مفقودة",
          "عالم مليء بالمخلوقات السحرية الودودة",
          "تحويل الأشياء العادية إلى أشياء مفيدة وجميلة"
        ],
        ends: [
          "وهكذا أصبح {name} ساحراً محبوباً يساعد الجميع بسحره الطيب.",
          "تعلم {name} أن السحر الحقيقي يكمن في العطاء ومساعدة الآخرين.",
          "شكرته الجنية وأهدته قلادة سحرية تحميه من الأذى.",
          "عاد {name} إلى عالمه وهو يحمل سر السحر في قلبه."
        ]
      },
      space: {
        beginnings: [
          "في المستقبل البعيد، كان {name} رائد فضاء شجاعاً يستكشف",
          "بينما كان {name} ينظر إلى النجوم، رأى سفينة فضاء تهبط في",
          "اخترع {name} صاروخاً صغيراً وقرر السفر إلى",
          "في محطة الفضاء الدولية، التقى {name} بكائن فضائي ودود من"
        ],
        middles: [
          "كواكب جديدة بحثاً عن حياة ذكية",
          "الحديقة الخلفية لمنزله",
          "القمر لزراعة أول حديقة فضائية",
          "كوكب بعيد يحب السلام والعلم",
          "المجرات البعيدة لاكتشاف أسرار الكون"
        ],
        ends: [
          "وعاد {name} إلى الأرض ليشارك اكتشافاته المذهلة مع العالم.",
          "تعلم {name} أن الكون مليء بالأصدقاء في انتظار التعارف.",
          "أصبح {name} أول مزارع في الفضاء وألهم الجميع.",
          "كوّن {name} صداقات فضائية ستدوم إلى الأبد."
        ]
      },
      school: {
        beginnings: [
          "في أول يوم دراسي، كان {name} متحمساً لأنه سيلتقي",
          "اكتشف {name} في المكتبة المدرسية كتاباً سحرياً يحكي عن",
          "نظم {name} مع أصدقائه مسابقة علمية ممتعة حول",
          "في رحلة مدرسية، اكتشف {name} وزملاؤه"
        ],
        middles: [
          "بأصدقاء جدد ومعلمين رائعين",
          "مغامرات طلاب في مدارس مختلفة حول العالم",
          "اختراعات بسيطة تساعد في الحياة اليومية",
          "حديقة مخفية خلف المدرسة مليئة بالنباتات النادرة",
          "مكتبة سرية تحتوي على أقدم الكتب في العالم"
        ],
        ends: [
          "وهكذا أصبحت المدرسة مكان {name} المفضل للتعلم والمرح.",
          "تعلم {name} أن المعرفة أجمل هدية يمكن الحصول عليها.",
          "فاز {name} وفريقه بالمسابقة وتقدير جميع المعلمين.",
          "قرر {name} أن يصبح معلماً ليشارك حبه للتعلم مع الآخرين."
        ]
      },
      mystery: {
        beginnings: [
          "اكتشف {name} لغزاً غريباً في منزل جدته القديم",
          "بينما كان {name} يلعب في الحديقة، وجد مفتاحاً غامضاً",
          "سمع {name} أصواتاً غريبة تأتي من العلية كل ليلة",
          "عثر {name} على رسالة قديمة مكتوبة بحبر اختفى تقريباً"
        ],
        middles: [
          "يؤدي إلى صندوق خشبي مملوء بالأسرار",
          "لا يفتح إلا باب غرفة مهجورة منذ سنوات",
          "تكشف عن وجود ممر سري يؤدي إلى كنز مخفي",
          "تحتوي على خريطة تشير إلى مكان مهم في المدينة"
        ],
        ends: [
          "وحل {name} اللغز بذكائه وصبره، مكتشفاً سراً عائلياً جميلاً.",
          "تبين أن اللغز كان لعبة ذكية تركها الجد للأحفاد.",
          "اكتشف {name} أن أفضل الألغاز هي التي تجمع العائلة.",
          "شارك {name} حل اللغز مع الجميع وأصبح محقق المستقبل."
        ]
      },
      friendship: {
        beginnings: [
          "التقى {name} بطفل جديد في الحي وأراد أن يصبحا صديقين",
          "كان {name} خجولاً ولكنه قرر أن يقترب من زملائه",
          "ساعد {name} زميله الذي كان يواجه صعوبة في",
          "نظم {name} حفلة صغيرة لصديقه الذي كان حزيناً"
        ],
        middles: [
          "فدعاه للعب معه ومشاركة الألعاب الممتعة",
          "في فرصة الغداء وتشاركوا الطعام والضحك",
          "واجبه المدرسي فقضوا وقتاً ممتعاً في الدراسة",
          "لأنه انتقل من مدينة أخرى ويفتقد أصدقاءه القدامى"
        ],
        ends: [
          "وهكذا كوّن {name} صداقة قوية ستدوم طوال العمر.",
          "تعلم {name} أن الصداقة تحتاج إلى عطاء وتضحية.",
          "شكره صديقه وأصبحا أفضل الأصدقاء في المدرسة.",
          "أدرك {name} أن إسعاد الآخرين يجلب السعادة له أيضاً."
        ]
      }
    };

    // تحميل بيانات الطلاب
    async function loadStudentData() {
      try {
        const response = await fetch('../data/studentData.json');
        const data = await response.json();
        students = data.students || [];
        populateClassSelect();
      } catch (error) {
        console.error('خطأ في تحميل بيانات الطلاب:', error);
        ActivityManager.showNotification('فشل في تحميل بيانات الطلاب', 'error');
      }
    }

    // ملء قائمة الصفوف
    function populateClassSelect() {
      const classSelect = document.getElementById('classSelect');
      const classes = [...new Set(students.map(s => s.class))];
      
      classSelect.innerHTML = '<option value="">-- اختر الصف --</option>';
      classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classSelect.appendChild(option);
      });
    }

    // معالجة تغيير نوع القصة
    function handleModeChange() {
      ActivityManager.playSound('click');
      const container = document.getElementById('studentSelection');
      container.innerHTML = '';
      container.style.display = 'none';
      
      // إظهار/إخفاء خيارات إضافية حسب النوع
      const mode = document.getElementById('modeSelect').value;
      const storyIdeaGroup = document.getElementById('storyIdeaGroup');
      const generateBtn = document.getElementById('generateStoryBtn');
      
      if (mode.includes('single')) {
        storyIdeaGroup.style.display = 'block';
        generateBtn.style.display = 'inline-flex';
      } else {
        storyIdeaGroup.style.display = 'none';
        generateBtn.style.display = 'none';
      }
    }

    // إنشاء قصة تلقائية
    function generateAutomaticStory() {
      const className = document.getElementById('classSelect').value;
      const storyType = document.getElementById('storyTypeSelect').value;
      const storyIdea = document.getElementById('storyIdea').value.trim();
      
      if (!className || !storyType) {
        ActivityManager.showNotification('يرجى اختيار الصف ونوع القصة أولاً', 'warning');
        return;
      }
      
      const classStudents = students.filter(s => s.class === className);
      if (classStudents.length === 0) {
        ActivityManager.showNotification('لا توجد طلاب في هذا الصف', 'error');
        return;
      }
      
      // اختيار طالب عشوائي
      const randomStudent = classStudents[Math.floor(Math.random() * classStudents.length)];
      
      // إنشاء القصة
      const story = createStory(randomStudent.name, storyType, storyIdea);
      
      // عرض القصة
      displayGeneratedStory(story, randomStudent.name, storyType);
      
      // تأثيرات الاحتفال
      playStoryGenerationEffects();
    }

    // إنشاء القصة بناءً على المعطيات
    function createStory(studentName, storyType, customIdea = '') {
      const template = storyTemplates[storyType];
      if (!template) return 'نوع القصة غير متوفر.';
      
      // اختيار عناصر عشوائية من القالب
      const beginning = template.beginnings[Math.floor(Math.random() * template.beginnings.length)];
      const middle = template.middles[Math.floor(Math.random() * template.middles.length)];
      const end = template.ends[Math.floor(Math.random() * template.ends.length)];
      
      let story = beginning.replace('{name}', studentName) + ' ' + middle + '. ';
      
      // إضافة الفكرة المخصصة إذا توفرت
      if (customIdea) {
        story += `وكما خطط ${studentName}، ${customIdea}. `;
      }
      
      story += end.replace('{name}', studentName);
      
      return story;
    }

    // عرض القصة المُنشأة
    function displayGeneratedStory(story, authorName, storyType) {
      // إخفاء منطقة الإعدادات
      document.getElementById('settingsCard').style.display = 'none';
      document.getElementById('studentSelection').style.display = 'none';
      document.getElementById('storyContainer').style.display = 'none';
      
      // إظهار منطقة القصة
      const container = document.getElementById('generatedStoryContainer');
      container.style.display = 'block';
      
      // تحديث محتوى القصة
      document.getElementById('storyAuthor').textContent = `بقلم: ${authorName}`;
      document.getElementById('storyContent').textContent = story;
      
      // حفظ القصة في السجل
      generatedStories.push({
        author: authorName,
        type: storyType,
        content: story,
        timestamp: new Date()
      });
    }

    // تأثيرات إنشاء القصة
    function playStoryGenerationEffects() {
      ActivityManager.playSound('success');
      
      // إنشاء تأثير احتفالي
      const celebrationElement = document.createElement('div');
      celebrationElement.className = 'celebration-effect';
      celebrationElement.innerHTML = '✨📖✨';
      document.body.appendChild(celebrationElement);
      
      setTimeout(() => {
        celebrationElement.remove();
      }, 2000);
      
      // تأثير Confetti
      setTimeout(() => {
        confetti({
          particleCount: 80,
          spread: 60,
          origin: { y: 0.7 },
          colors: ['#667eea', '#764ba2', '#ffecd2', '#fcb69f']
        });
        
        ActivityManager.playSound('celebration');
      }, 500);
      
      // رسالة تحفيزية
      setTimeout(() => {
        ActivityManager.showNotification('🎉 تم إنشاء قصة رائعة! أحسنت!', 'success');
      }, 1000);
    }

    // إعادة إنشاء قصة جديدة
    function regenerateStory() {
      const className = document.getElementById('classSelect').value;
      const storyType = document.getElementById('storyTypeSelect').value;
      const storyIdea = document.getElementById('storyIdea').value.trim();
      
      // اختيار طالب مختلف
      const classStudents = students.filter(s => s.class === className);
      const availableStudents = classStudents.filter(s => 
        !generatedStories.some(story => story.author === s.name)
      );
      
      let selectedStudent;
      if (availableStudents.length > 0) {
        selectedStudent = availableStudents[Math.floor(Math.random() * availableStudents.length)];
      } else {
        selectedStudent = classStudents[Math.floor(Math.random() * classStudents.length)];
      }
      
      const story = createStory(selectedStudent.name, storyType, storyIdea);
      displayGeneratedStory(story, selectedStudent.name, storyType);
      playStoryGenerationEffects();
    }

    // مشاركة القصة
    function shareStory() {
      const storyContent = document.getElementById('storyContent').textContent;
      const storyAuthor = document.getElementById('storyAuthor').textContent;
      
      const shareText = `${storyAuthor}\n\n${storyContent}\n\n#قصتي_الرائعة #إبداع_الطلاب`;
      
      if (navigator.share) {
        navigator.share({
          title: 'قصتي الرائعة',
          text: shareText
        }).catch(() => {
          copyToClipboard(shareText);
        });
      } else {
        copyToClipboard(shareText);
      }
    }

    // نسخ النص للحافظة
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          ActivityManager.showNotification('تم نسخ القصة للحافظة!', 'success');
        });
      } else {
        // Fallback للمتصفحات القديمة
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        ActivityManager.showNotification('تم نسخ القصة للحافظة!', 'success');
      }
    }

    // العودة للإعدادات من منطقة القصة
    function backToSettings() {
      document.getElementById('settingsCard').style.display = 'block';
      document.getElementById('generatedStoryContainer').style.display = 'none';
      document.getElementById('storyContainer').style.display = 'none';
      document.getElementById('studentSelection').style.display = 'none';
    }

    // عرض منطقة اختيار الطلاب
    function showStudentSelection(className, mode) {
      const container = document.getElementById('studentSelection');
      const classStudents = students.filter(s => s.class === className);
      
      container.innerHTML = '';
      container.style.display = 'block';
      
      // إنشاء عنوان المنطقة
      const header = document.createElement('div');
      header.className = 'students-selection-header mobile-text-center';
      header.innerHTML = `
        <h3><i class="fas fa-users"></i> اختر الطلاب المشاركين</h3>
        <p>انقر على الطلاب لاختيارهم ${mode === 'select-single' ? '(طالب واحد فقط)' : '(عدة طلاب)'}</p>
      `;
      container.appendChild(header);
      
      // إنشاء بطاقات الطلاب
      const cardsContainer = document.createElement('div');
      cardsContainer.className = 'student-cards-grid mobile-grid-2';
      
      classStudents.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-selection-card touch-target';
        card.innerHTML = `
          <div class="student-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="student-name">${student.name}</div>
        `;
        
        card.addEventListener('click', () => {
          ActivityManager.playSound('click');
          
          if (mode === 'select-single') {
            // إزالة التحديد من جميع الطلاب
            document.querySelectorAll('.student-selection-card').forEach(c => 
              c.classList.remove('selected'));
            selectedManualStudents = [student.name];
            card.classList.add('selected');
          } else {
            // وضع متعدد الطلاب
            if (selectedManualStudents.includes(student.name)) {
              selectedManualStudents = selectedManualStudents.filter(n => n !== student.name);
              card.classList.remove('selected');
            } else {
              selectedManualStudents.push(student.name);
              card.classList.add('selected');
            }
          }
        });
        
        cardsContainer.appendChild(card);
      });
      
      container.appendChild(cardsContainer);
      
      // زر بدء السرد
      const startButton = document.createElement('button');
      startButton.className = 'btn btn-primary start-story-btn touch-target mobile-full-width';
      startButton.innerHTML = '<i class="fas fa-play"></i> بدء السرد';
      startButton.addEventListener('click', () => {
        if (selectedManualStudents.length === 0) {
          ActivityManager.showNotification('يرجى اختيار طالب واحد على الأقل', 'warning');
          return;
        }
        
        currentStudentList = [...selectedManualStudents];
        usedStudents = [];
        currentMode = mode;
        startStoryActivity();
      });
      
      container.appendChild(startButton);
    }

    // بدء النشاط
    function startStoryActivity() {
      // إخفاء الإعدادات وإظهار منطقة النشاط
      document.getElementById('settingsCard').style.display = 'none';
      document.getElementById('studentSelection').style.display = 'none';
      document.getElementById('storyContainer').style.display = 'block';
      
      // إظهار زر التالي في الوضع الجماعي
      const nextBtn = document.getElementById('nextBtn');
      nextBtn.style.display = currentMode.includes('group') ? 'inline-block' : 'none';
      
      // بدء مع الطالب الأول
      nextStudent();
      startTimer();
      
      ActivityManager.playSound('success');
      ActivityManager.showNotification('بدأ النشاط! حان وقت السرد', 'success');
    }

    // الانتقال للطالب التالي
    function nextStudent() {
      if (currentStudentList.length === 0) {
        ActivityManager.showNotification('انتهى جميع الطلاب!', 'info');
        return;
      }
      
      const randomIndex = Math.floor(Math.random() * currentStudentList.length);
      const selectedStudent = currentStudentList.splice(randomIndex, 1)[0];
      usedStudents.push(selectedStudent);
      
      document.getElementById('studentName').innerHTML = `
        <i class="fas fa-user-edit"></i> ابدأ السرد يا ${selectedStudent}
      `;
      
      ActivityManager.playSound('click');
    }

    // بدء المؤقت
    function startTimer() {
      const canvas = document.getElementById('timerCanvas');
      const ctx = canvas.getContext('2d');
      secondsPassed = 0;

      function drawTimer() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // رسم الدائرة الخارجية
        ctx.beginPath();
        ctx.arc(75, 75, 65, 0, 2 * Math.PI);
        ctx.strokeStyle = '#E0E0E0';
        ctx.lineWidth = 10;
        ctx.stroke();

        // رسم التقدم
        const progress = (secondsPassed % 300) / 300; // كل 5 دقائق
        ctx.beginPath();
        ctx.arc(75, 75, 65, -Math.PI / 2, (2 * Math.PI * progress) - Math.PI / 2);
        ctx.strokeStyle = OmaniColors.red;
        ctx.lineWidth = 10;
        ctx.stroke();

        // عرض الوقت
        ctx.fillStyle = OmaniColors.black;
        ctx.font = 'bold 18px Cairo';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const minutes = Math.floor(secondsPassed / 60);
        const seconds = secondsPassed % 60;
        const timeText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        ctx.fillText(timeText, 75, 75);
      }

      drawTimer();
      timerInterval = setInterval(() => {
        secondsPassed++;
        drawTimer();
      }, 1000);
    }

    // إيقاف المؤقت
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // إنهاء القصة
    function finishStory() {
      stopTimer();
      
      // إظهار رسالة الاحتفال
      const celebration = document.getElementById('celebration');
      celebration.style.display = 'block';
      celebration.style.opacity = '1';
      
      // تأثيرات الاحتفال
      ActivityManager.playSound('celebration');
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
        colors: [OmaniColors.red, OmaniColors.green, OmaniColors.gold]
      });
      
      // إخفاء الاحتفال وإظهار النتائج
      setTimeout(() => {
        celebration.style.opacity = '0';
        setTimeout(() => {
          celebration.style.display = 'none';
          showFinalResults();
        }, 500);
      }, 3000);
    }

    // إظهار النتائج النهائية
    function showFinalResults() {
      const modal = document.getElementById('thankYouModal');
      const participantList = document.getElementById('participantList');
      
      // تنظيف القائمة
      participantList.innerHTML = '';
      
      // إضافة المشاركين
      usedStudents.forEach((name, index) => {
        const li = document.createElement('li');
        li.className = 'honor-item';
        li.innerHTML = `
          <span class="honor-rank">${index + 1}</span>
          <span class="honor-team">${name}</span>
          <span class="honor-names">مشارك في القصة</span>
        `;
        participantList.appendChild(li);
      });
      
      modal.style.display = 'flex';
    }

    // إعادة تعيين النشاط
    function resetStoryActivity() {
      stopTimer();
      
      currentStudentList = [];
      usedStudents = [];
      selectedManualStudents = [];
      generatedStories = [];
      secondsPassed = 0;
      currentMode = '';
      currentStoryType = '';
      
      // إعادة عرض الإعدادات
      document.getElementById('settingsCard').style.display = 'block';
      document.getElementById('studentSelection').style.display = 'none';
      document.getElementById('storyContainer').style.display = 'none';
      document.getElementById('generatedStoryContainer').style.display = 'none';
      document.getElementById('thankYouModal').style.display = 'none';
      
      // إعادة تعيين النموذج
      document.getElementById('storySettingsForm').reset();
      document.getElementById('studentSelection').innerHTML = '';
      document.getElementById('storyContent').textContent = '';
      document.getElementById('storyAuthor').textContent = '';
      
      // إخفاء العناصر الاختيارية
      document.getElementById('storyIdeaGroup').style.display = 'none';
      document.getElementById('generateStoryBtn').style.display = 'none';
      
      ActivityManager.showNotification('تم إعادة تعيين النشاط', 'success');
    }

    // تهيئة النشاط
    function initializeStoryActivity() {
      loadStudentData();
      
      // معالج أزرار التحكم
      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = '../main.html';
      });
      
      document.getElementById('muteBtn').addEventListener('click', () => {
        ActivityManager.toggleMute();
        const icon = document.querySelector('#muteBtn i');
        icon.className = ActivityManager.isMuted() ? 'fas fa-volume-mute' : 'fas fa-volume-up';
      });
      
      document.getElementById('instructionsBtn').addEventListener('click', () => {
        document.getElementById('instructionsModal').style.display = 'flex';
      });
      
      document.getElementById('fullscreenBtn').addEventListener('click', () => {
        ActivityManager.toggleFullscreen();
      });
      
      // معالج نموذج الإعدادات
      document.getElementById('storySettingsForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const className = document.getElementById('classSelect').value;
        const mode = document.getElementById('modeSelect').value;
        const storyType = document.getElementById('storyTypeSelect').value;
        
        if (!className || !mode || !storyType) {
          ActivityManager.showNotification('يرجى اختيار جميع الخيارات المطلوبة', 'warning');
          return;
        }
        
        const classStudents = students.filter(s => s.class === className);
        currentMode = mode;
        currentStoryType = storyType;
        
        if (mode.includes('select')) {
          // الوضع الانتقائي
          selectedManualStudents = [];
          showStudentSelection(className, mode);
        } else {
          // الوضع العشوائي
          currentStudentList = classStudents.map(s => s.name);
          usedStudents = [];
          startStoryActivity();
        }
      });
      
      // معالج تغيير نوع القصة
      document.getElementById('modeSelect').addEventListener('change', handleModeChange);
      
      // معالج زر إنشاء القصة التلقائية
      document.getElementById('generateStoryBtn').addEventListener('click', generateAutomaticStory);
      
      // معالج أزرار النشاط
      document.getElementById('nextBtn').addEventListener('click', nextStudent);
      document.getElementById('finishBtn').addEventListener('click', finishStory);
      
      // معالج أزرار منطقة القصة المُنشأة
      document.getElementById('regenerateStoryBtn').addEventListener('click', regenerateStory);
      document.getElementById('shareStoryBtn').addEventListener('click', shareStory);
      document.getElementById('backToSettingsBtn').addEventListener('click', backToSettings);
      
      // معالج أزرار النتائج
      document.getElementById('closeModalBtn').addEventListener('click', () => {
        document.getElementById('thankYouModal').style.display = 'none';
      });
      
      document.getElementById('modalBackBtn').addEventListener('click', resetStoryActivity);
    }

    // إغلاق نافذة التعليمات
    function closeInstructions() {
      document.getElementById('instructionsModal').style.display = 'none';
    }

    // إضافة مستمعي الأحداث للوحة المفاتيح
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeInstructions();
        document.getElementById('thankYouModal').style.display = 'none';
      }
    });
  </script>
  
  <!-- Responsive JavaScript Helper -->
  <script src="../assets/js/responsive-helper.js"></script>
</body>
</html>
