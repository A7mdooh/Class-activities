<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª ğŸ”¥</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="../config/unified-styles-template.css">
<style>
    /* ØªØ®ØµÙŠØµ Ù†Ø´Ø§Ø· Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª */
    .activity-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .challenge-header {
      background: var(--gradient-primary);
      color: white;
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: var(--shadow-large);
    }

    .challenge-header h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .challenge-controls {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--shadow-medium);
      margin-bottom: 2rem;
    }

    .control-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .control-group label {
      font-weight: 600;
      color: var(--text-color);
      min-width: 100px;
    }

    .control-group select,
    .control-group button {
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      border: 2px solid var(--primary-color);
      font-size: 1rem;
      font-weight: 600;
    }

    .control-group select {
      background: white;
      color: var(--primary-color);
      min-width: 150px;
    }

    .challenge-area {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--shadow-medium);
      display: none;
      text-align: center;
    }

    .turn-display {
      background: var(--gradient-accent);
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-medium);
    }

    .timer-container {
      position: relative;
      width: 150px;
      height: 150px;
      margin: 2rem auto;
    }

    .timer-circle {
      width: 150px;
      height: 150px;
    }

    .timer-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-color);
    }

    .timer-container.shake {
      animation: shake 0.5s infinite;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin: 2rem 0;
    }

    .team-card {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--shadow-medium);
      border: 3px solid var(--primary-color);
      transition: all 0.3s ease;
    }

    .team-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-large);
    }

    .team-card h3 {
      color: var(--primary-color);
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .team-score {
      font-size: 3rem;
      font-weight: 700;
      color: var(--accent-color);
      margin: 1rem 0;
    }

    .score-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .score-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      font-size: 1.5rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .score-btn.plus {
      background: var(--gradient-success);
      color: white;
    }

    .score-btn.minus {
      background: var(--gradient-danger);
      color: white;
    }

    .score-btn:hover {
      transform: scale(1.1);
    }

    .challenge-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
      flex-wrap: wrap;
    }

    .winner-display {
      background: var(--gradient-accent);
      color: white;
      padding: 2rem;
      border-radius: 15px;
      font-size: 2rem;
      font-weight: 700;
      margin-top: 2rem;
      box-shadow: var(--shadow-large);
      display: none;
    }

    .manual-selection {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem 0;
      border: 2px dashed var(--primary-color);
      display: none;
    }

    .multi-team-options {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem 0;
      border: 2px dashed var(--primary-color);
      display: none;
    }

    .instruction-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      max-width: 600px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow-extra-large);
      position: relative;
    }

    .modal-content h2 {
      color: var(--primary-color);
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }

    .modal-content p {
      font-size: 1.3rem;
      line-height: 1.8;
      color: var(--text-color);
      margin-bottom: 2rem;
    }

    .time-up-popup {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 2rem 3rem;
      border-radius: 20px;
      box-shadow: var(--shadow-extra-large);
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-color);
      z-index: 10000;
      display: none;
      border: 4px solid var(--accent-color);
    }

    .fireworks-effect {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: url('../assets/media/sounds/firework.gif') center center no-repeat;
      background-size: cover;
      z-index: 9999;
      display: none;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
    @media (max-width: 768px) {
      .challenge-header h1 {
        font-size: 2rem;
      }

      .control-group {
        flex-direction: column;
        text-align: center;
      }

      .teams-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .timer-container {
        width: 120px;
        height: 120px;
      }

      .timer-circle {
        width: 120px;
        height: 120px;
      }

      .challenge-actions {
        flex-direction: column;
        align-items: center;
      }
    }

    @media (max-width: 480px) {
      .activity-container {
        padding: 10px;
      }

      .challenge-header,
      .challenge-controls,
      .challenge-area {
        padding: 1rem;
      }

      .team-score {
        font-size: 2.5rem;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(5px, 0); }
      50% { transform: translate(0, 5px); }
      75% { transform: translate(-5px, 0); }
    }
</style>
</head>
<body>
<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ­Ø¯Ø© -->
<div class="control-buttons">
  <button class="control-btn" id="backBtn" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
    <i class="fas fa-home"></i>
  </button>
  <button class="control-btn" id="fullscreenBtn" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">
    <i class="fas fa-expand"></i>
  </button>
  <button class="control-btn" id="muteBtn" title="ÙƒØªÙ…/ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª">
    <i class="fas fa-volume-up"></i>
  </button>
</div>

<!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div id="notification-container"></div>

<div class="activity-container">
  <!-- Ø±Ø£Ø³ Ø§Ù„ØªØ­Ø¯ÙŠ -->
  <div class="challenge-header">
    <h1><i class="fas fa-fire"></i> Ù†Ø´Ø§Ø· Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª <i class="fas fa-fire"></i></h1>
    <p>Ø§Ø®ØªØ¨Ø± Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙˆØªÙ†Ø§ÙØ³ Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ ØªØ­Ø¯ÙŠØ§Øª Ù…Ø«ÙŠØ±Ø©!</p>
  </div>

  <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… -->
  <div class="challenge-controls">
    <div class="control-group">
      <label><i class="fas fa-users"></i> Ø§Ø®ØªØ± Ø§Ù„ØµÙ:</label>
      <select id="classSelect">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
      </select>
    </div>

    <div class="control-group">
      <label><i class="fas fa-gamepad"></i> Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠ:</label>
      <select id="mode" onchange="handleModeChange()">
        <option value="random">Ø·Ø§Ù„Ø¨ Ø¶Ø¯ Ø·Ø§Ù„Ø¨ (Ø¹Ø´ÙˆØ§Ø¦ÙŠ)</option>
        <option value="manual">Ø·Ø§Ù„Ø¨ Ø¶Ø¯ Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
        <option value="teams">ÙØ±ÙŠÙ‚ Ø¶Ø¯ ÙØ±ÙŠÙ‚</option>
        <option value="multiTeams">ØªØ­Ø¯ÙŠ Ø¨ÙŠÙ† ÙØ±Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø©</option>
      </select>
    </div>

    <div id="manualSelection" class="manual-selection">
      <h4><i class="fas fa-hand-pointer"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ†</h4>
      <div class="control-group">
        <label>Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„:</label>
        <select id="student1Select"></select>
      </div>
      <div class="control-group">
        <label>Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ:</label>
        <select id="student2Select"></select>
      </div>
    </div>

    <div id="multiTeamOptions" class="multi-team-options">
      <h4><i class="fas fa-users-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©</h4>
      <div class="control-group">
        <label>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚:</label>
        <select id="teamCountSelect">
          <option value="3">3 ÙØ±Ù‚</option>
          <option value="4">4 ÙØ±Ù‚</option>
          <option value="5">5 ÙØ±Ù‚</option>
          <option value="6">6 ÙØ±Ù‚</option>
          <option value="7">7 ÙØ±Ù‚</option>
          <option value="8">8 ÙØ±Ù‚</option>
        </select>
      </div>
    </div>

    <div class="control-group">
      <label><i class="fas fa-clock"></i> Ø§Ù„Ù…Ø¯Ø©:</label>
      <select id="duration">
        <option value="30">30 Ø«Ø§Ù†ÙŠØ©</option>
        <option value="60">1 Ø¯Ù‚ÙŠÙ‚Ø©</option>
        <option value="120">2 Ø¯Ù‚Ø§Ø¦Ù‚</option>
        <option value="180">3 Ø¯Ù‚Ø§Ø¦Ù‚</option>
        <option value="240">4 Ø¯Ù‚Ø§Ø¦Ù‚</option>
        <option value="300">5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
        <option value="600">10 Ø¯Ù‚Ø§Ø¦Ù‚</option>
      </select>
    </div>

    <div class="control-group">
      <button onclick="prepareChallenge()" class="btn btn-accent">
        <i class="fas fa-rocket"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ
      </button>
    </div>
  </div>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠ -->
  <div id="challengeArea" class="challenge-area">
    <div id="turnLabel" class="turn-display">
      <i class="fas fa-user-clock"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...
    </div>

    <div id="timerWrapper" class="timer-container">
      <svg class="timer-circle" viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="50" fill="none" stroke="#eee" stroke-width="8"></circle>
        <circle cx="60" cy="60" r="50" fill="none" id="progress" stroke="var(--accent-color)" 
                stroke-dasharray="314" stroke-dashoffset="0" stroke-width="8" 
                transform="rotate(-90 60 60)"></circle>
      </svg>
      <div id="timerTextSec" class="timer-text">0s</div>
    </div>

    <div class="teams-grid" id="teamsContainer"></div>

    <div class="challenge-actions">
      <button onclick="nextTurn()" class="btn btn-primary">
        <i class="fas fa-arrow-right"></i> Ø§Ù„ØªØ§Ù„ÙŠ
      </button>
      <button onclick="endChallenge()" class="btn btn-success">
        <i class="fas fa-trophy"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ
      </button>
      <button onclick="resetChallenge()" class="btn btn-secondary">
        <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
      </button>
    </div>

    <div id="winnerDisplay" class="winner-display"></div>
  </div>
</div>
<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="instructionModal" class="instruction-modal">
  <div class="modal-content">
    <h2><i class="fas fa-info-circle"></i> ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠ</h2>
    <p id="instructionText"></p>
    <button onclick="closeInstructionModal()" class="btn btn-primary">
      <i class="fas fa-check"></i> ÙÙ‡Ù…Øª
    </button>
  </div>
</div>

<!-- Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ© -->
<div id="fireworks" class="fireworks-effect"></div>
<div id="timeUpPopup" class="time-up-popup">
  <i class="fas fa-clock"></i> Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!
</div>
<script src="../config/unified-scripts-template.js"></script>
<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ActivityUtils
  const activity = new ActivityUtils('Ù†Ø´Ø§Ø· Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª', '../assets/media/sounds/');
  
  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·
  let studentData = {}, currentList = [], timer, timeLeft = 0;
  let currentTurn = 1, usedStudents = [];
  let teamScores = {};

  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
  async function loadStudents() {
    try {
      const res = await fetch('https://raw.githubusercontent.com/A7mdooh/entertainment-app/main/data/studentData.json');
      studentData = await res.json();
      
      const classSelect = document.getElementById('classSelect');
      Object.keys(studentData).forEach(cls => {
        const option = document.createElement('option');
        option.value = cls;
        option.textContent = `Ø§Ù„ØµÙ ${cls}`;
        classSelect.appendChild(option);
      });

      classSelect.addEventListener('change', () => {
        populateStudentSelectors(classSelect.value);
      });

      if (classSelect.options.length > 1) {
        classSelect.selectedIndex = 1;
        populateStudentSelectors(classSelect.value);
      }

      // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ
      document.getElementById('student1Select').addEventListener('change', () => {
        populateStudentSelectors(classSelect.value);
      });

      document.getElementById('student2Select').addEventListener('change', () => {
        populateStudentSelectors(classSelect.value);
      });

      activity.showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    } catch (error) {
      activity.showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨', 'error');
    }
  }

  // ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ
  function populateStudentSelectors(cls) {
    const s1 = document.getElementById('student1Select');
    const s2 = document.getElementById('student2Select');
    const students = studentData[cls] || [];
    const selected1 = s1.value;
    const selected2 = s2.value;

    s1.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„</option>';
    s2.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>';

    students.forEach(stu => {
      if (stu !== selected2) {
        const opt1 = document.createElement('option');
        opt1.value = stu;
        opt1.textContent = stu;
        s1.appendChild(opt1);
      }
      if (stu !== selected1) {
        const opt2 = document.createElement('option');
        opt2.value = stu;
        opt2.textContent = stu;
        s2.appendChild(opt2);
      }
    });

    if (selected1 && [...s1.options].some(o => o.value === selected1)) s1.value = selected1;
    if (selected2 && [...s2.options].some(o => o.value === selected2)) s2.value = selected2;
  }

  // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ù†Ù…Ø· Ø§Ù„ØªØ­Ø¯ÙŠ
  function handleModeChange() {
    const mode = document.getElementById('mode').value;
    
    activity.playSound('Click.mp3');
    
    const manualSelection = document.getElementById('manualSelection');
    const multiTeamOptions = document.getElementById('multiTeamOptions');
    
    manualSelection.style.display = (mode === 'manual') ? 'block' : 'none';
    multiTeamOptions.style.display = (mode === 'multiTeams') ? 'block' : 'none';

    if (mode === 'manual') {
      const currentClass = document.getElementById('classSelect').value;
      if (currentClass) {
        populateStudentSelectors(currentClass);
        activity.showNotification('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ÙŠÙ† Ù„Ù„ØªØ­Ø¯ÙŠ', 'info');
      }
    }
  }

  // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
  function showInstructionModal(mode) {
    const modal = document.getElementById('instructionModal');
    const text = document.getElementById('instructionText');
    let instructions = '';

    switch (mode) {
      case 'random':
        instructions = 'Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„ØªØ­Ø¯ÙŠ. ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ù„Ù‡ Ø¯ÙˆØ± ÙˆØ²Ù…Ù† Ù…Ø­Ø¯Ø¯. Ø§Ù„Ù…Ø¹Ù„Ù… ÙŠØ³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø²Ø±Ø§Ø± + Ùˆ -.';
        break;
      case 'manual':
        instructions = 'ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ÙŠÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ù„Ù‡ ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø£Ø¯Ø§Ø¡. ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹.';
        break;
      case 'teams':
        instructions = 'ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨ÙŠÙ† ÙØ±ÙŠÙ‚ÙŠÙ†. ÙƒÙ„ ÙØ±ÙŠÙ‚ ÙŠÙ…ÙƒÙ†Ù‡ ÙƒØ³Ø¨ Ø£Ùˆ Ø®Ø³Ø§Ø±Ø© Ù†Ù‚Ø§Ø·. Ø§Ù„Ù‡Ø¯Ù Ù‡Ùˆ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ÙˆØ§Ù„ØªÙ†Ø§ÙØ³ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ.';
        break;
      case 'multiTeams':
        instructions = 'Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¯Ø© ÙØ±Ù‚ (Ù…Ù† 3 Ø¥Ù„Ù‰ 8) Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø±Ùƒ. ÙƒÙ„ ÙØ±ÙŠÙ‚ Ù„Ù‡ Ø¯ÙˆØ±Ù‡ ÙˆÙ†Ù‚Ø§Ø·Ù‡ Ø§Ù„Ø®Ø§ØµØ©. Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©.';
        break;
    }

    text.textContent = instructions;
    modal.style.display = 'flex';
    activity.playSound('name-start.mp3');
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
  function closeInstructionModal() {
    document.getElementById('instructionModal').style.display = 'none';
    prepareChallengeContinue();
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ
  function prepareChallenge() {
    const cls = document.getElementById('classSelect').value;
    const mode = document.getElementById('mode').value;

    if (!cls) {
      activity.showModal('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ Ø£ÙˆÙ„Ø§Ù‹', false);
      return;
    }

    if (!mode) {
      activity.showModal('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠ', false);
      return;
    }

    activity.playSound('start-timer.mp3');
    showInstructionModal(mode);
  }

  // Ù…ØªØ§Ø¨Ø¹Ø© ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
  function prepareChallengeContinue() {
    const cls = document.getElementById('classSelect').value;
    const mode = document.getElementById('mode').value;
    timeLeft = parseInt(document.getElementById('duration').value);
    currentList = [...(studentData[cls] || [])];

    if (mode === 'multiTeams') {
      setupMultiTeams();
      return;
    }

    if (currentList.length < 2) {
      activity.showModal('Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ØµÙ Ø¨Ù‡ Ø·Ù„Ø§Ø¨ ÙƒØ§ÙÙŠÙŠÙ†', false);
      return;
    }

    let name1 = 'ÙØ±ÙŠÙ‚ 1', name2 = 'ÙØ±ÙŠÙ‚ 2';

    if (mode === 'random') {
      const remaining = currentList.filter(s => !usedStudents.includes(s));
      if (remaining.length < 2) {
        activity.showModal('ØªÙ†Ø¨ÙŠÙ‡', 'ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.', false);
        usedStudents = [];
        const shuffled = [...currentList].sort(() => 0.5 - Math.random());
        name1 = shuffled[0];
        name2 = shuffled[1];
      } else {
        const shuffled = [...remaining].sort(() => 0.5 - Math.random());
        name1 = shuffled[0];
        name2 = shuffled[1];
      }
      usedStudents.push(name1, name2);
    } else if (mode === 'manual') {
      name1 = document.getElementById('student1Select').value;
      name2 = document.getElementById('student2Select').value;
      if (!name1 || !name2) {
        activity.showModal('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ÙŠÙ†', false);
        return;
      }
      if (name1 === name2) {
        activity.showModal('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†', false);
        return;
      }
    }

    setupTwoPlayerChallenge(name1, name2);
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ­Ø¯ÙŠ Ø¨ÙŠÙ† Ù„Ø§Ø¹Ø¨ÙŠÙ†
  function setupTwoPlayerChallenge(name1, name2) {
    const container = document.getElementById('teamsContainer');
    container.innerHTML = `
      <div class="team-card">
        <h3 id="name1"><i class="fas fa-user"></i> ${name1}</h3>
        <div class="team-score" id="score1">0</div>
        <div class="score-controls">
          <button class="score-btn plus" onclick="adjustScore(1, 1)">
            <i class="fas fa-plus"></i>
          </button>
          <button class="score-btn minus" onclick="adjustScore(1, -1)">
            <i class="fas fa-minus"></i>
          </button>
        </div>
      </div>
      <div class="team-card">
        <h3 id="name2"><i class="fas fa-user"></i> ${name2}</h3>
        <div class="team-score" id="score2">0</div>
        <div class="score-controls">
          <button class="score-btn plus" onclick="adjustScore(2, 1)">
            <i class="fas fa-plus"></i>
          </button>
          <button class="score-btn minus" onclick="adjustScore(2, -1)">
            <i class="fas fa-minus"></i>
          </button>
        </div>
      </div>
    `;

    teamScores = { '1': 0, '2': 0 };
    currentTurn = 1;

    document.getElementById('challengeArea').style.display = 'block';
    document.getElementById('winnerDisplay').style.display = 'none';
    
    activity.showNotification(`Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨ÙŠÙ† ${name1} Ùˆ ${name2}!`, 'success');
    nextTurn();
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ­Ø¯ÙŠ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
  function setupMultiTeams() {
    const teamCount = parseInt(document.getElementById('teamCountSelect').value);
    const container = document.getElementById('teamsContainer');
    container.innerHTML = '';

    teamScores = {};

    for (let i = 1; i <= teamCount; i++) {
      const div = document.createElement('div');
      div.className = 'team-card';
      div.innerHTML = `
        <h3 id="name${i}"><i class="fas fa-users"></i> ÙØ±ÙŠÙ‚ ${i}</h3>
        <div class="team-score" id="score${i}">0</div>
        <div class="score-controls">
          <button class="score-btn plus" onclick="adjustScore(${i}, 1)">
            <i class="fas fa-plus"></i>
          </button>
          <button class="score-btn minus" onclick="adjustScore(${i}, -1)">
            <i class="fas fa-minus"></i>
          </button>
        </div>
      `;
      container.appendChild(div);
      teamScores[i.toString()] = 0;
    }

    currentTurn = 1;
    document.getElementById('challengeArea').style.display = 'block';
    document.getElementById('winnerDisplay').style.display = 'none';
    
    activity.showNotification(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${teamCount} ÙØ±Ù‚ Ù„Ù„ØªØ­Ø¯ÙŠ!`, 'success');
    nextTurn();
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ù‚Øª
  function updateTimer() {
    const secText = document.getElementById('timerTextSec');
    const circle = document.getElementById('progress');
    const wrapper = document.getElementById('timerWrapper');

    const total = parseInt(document.getElementById('duration').value);
    const percent = timeLeft / total;
    const offset = 314 * (1 - percent);

    circle.style.strokeDashoffset = offset;
    secText.innerHTML = `<i class="fas fa-clock"></i><br>${timeLeft}s`;

    if (timeLeft <= 10 && timeLeft > 0) {
      wrapper.classList.add('shake');
      activity.playSound('countdown-beep.mp3');
    } else {
      wrapper.classList.remove('shake');
    }
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
  function startTimer() {
    updateTimer();
    timer = setInterval(() => {
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0) {
        clearInterval(timer);
        activity.playSound('long-beep.mp3');
        showTimeUpPopup();
      }
    }, 1000);
  }

  // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
  function showTimeUpPopup() {
    const popup = document.getElementById('timeUpPopup');
    popup.style.display = 'block';
    
    setTimeout(() => {
      popup.style.display = 'none';
      nextTurn();
    }, 2000);
  }

  // Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ
  function nextTurn() {
    activity.playSound('vs.mp3');
    clearInterval(timer);
    
    const mode = document.getElementById('mode').value;
    const turnLabel = document.getElementById('turnLabel');

    if (mode === 'multiTeams') {
      const count = parseInt(document.getElementById('teamCountSelect').value);
      turnLabel.innerHTML = `<i class="fas fa-users"></i> Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: ÙØ±ÙŠÙ‚ ${currentTurn}`;
      timeLeft = parseInt(document.getElementById('duration').value);
      startTimer();
      currentTurn = currentTurn >= count ? 1 : currentTurn + 1;
      return;
    }

    // Ù„Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø®Ø±Ù‰
    const currentPlayerName = currentTurn === 1 ? 
      document.getElementById('name1').textContent : 
      document.getElementById('name2').textContent;
    
    turnLabel.innerHTML = `<i class="fas fa-user-clock"></i> Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: ${currentPlayerName.replace('ğŸ‘¤ ', '')}`;
    timeLeft = parseInt(document.getElementById('duration').value);
    startTimer();
    currentTurn = currentTurn === 1 ? 2 : 1;
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·
  function adjustScore(team, val) {
    activity.playSound('Click.mp3');
    
    const scoreElement = document.getElementById(`score${team}`);
    let score = parseInt(scoreElement.textContent) + val;
    score = Math.max(0, score);
    scoreElement.textContent = score;
    teamScores[team.toString()] = score;

    // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·
    scoreElement.style.transform = 'scale(1.2)';
    setTimeout(() => {
      scoreElement.style.transform = 'scale(1)';
    }, 200);
  }

  // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ
  function endChallenge() {
    clearInterval(timer);
    activity.playSound('end-timer.mp3');
    
    const mode = document.getElementById('mode').value;
    const winnerDisplay = document.getElementById('winnerDisplay');

    if (mode === 'multiTeams') {
      const count = parseInt(document.getElementById('teamCountSelect').value);
      let maxScore = -1;
      let winners = [];

      for (let i = 1; i <= count; i++) {
        const score = parseInt(document.getElementById(`score${i}`).textContent);
        if (score > maxScore) {
          maxScore = score;
          winners = [`ÙØ±ÙŠÙ‚ ${i}`];
        } else if (score === maxScore) {
          winners.push(`ÙØ±ÙŠÙ‚ ${i}`);
        }
      }

      const result = winners.length > 1 ? 
        `<i class="fas fa-handshake"></i> ØªØ¹Ø§Ø¯Ù„ Ø¨ÙŠÙ†: ${winners.join(' Ùˆ ')}` : 
        `<i class="fas fa-trophy"></i> Ø§Ù„ÙØ§Ø¦Ø²: ${winners[0]}`;
      
      winnerDisplay.innerHTML = result;
      showCelebration(winners.length === 1);
    } else {
      // Ù„Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø®Ø±Ù‰
      const name1 = document.getElementById('name1').textContent.replace('ğŸ‘¤ ', '');
      const name2 = document.getElementById('name2').textContent.replace('ğŸ‘¤ ', '');
      const score1 = parseInt(document.getElementById('score1').textContent);
      const score2 = parseInt(document.getElementById('score2').textContent);

      let result;
      if (score1 > score2) {
        result = `<i class="fas fa-trophy"></i> Ø§Ù„ÙØ§Ø¦Ø²: ${name1}`;
        showCelebration(true);
      } else if (score2 > score1) {
        result = `<i class="fas fa-trophy"></i> Ø§Ù„ÙØ§Ø¦Ø²: ${name2}`;
        showCelebration(true);
      } else {
        result = '<i class="fas fa-handshake"></i> ØªØ¹Ø§Ø¯Ù„!';
        showCelebration(false);
      }

      winnerDisplay.innerHTML = result;
    }

    winnerDisplay.style.display = 'block';
    activity.showNotification('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ!', 'success');
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø­ØªÙØ§Ù„
  function showCelebration(isWin) {
    if (isWin) {
      activity.playSound('win.mp3');
      setTimeout(() => activity.playSound('clap.mp3'), 1000);
    } else {
      activity.playSound('draw.mp3');
    }

    const fireworks = document.getElementById('fireworks');
    fireworks.style.display = 'block';
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙˆÙ†ÙÙŠØªÙŠ
    if (window.confetti) {
      confetti({ 
        particleCount: 200, 
        spread: 120, 
        origin: { y: 0.6 },
        colors: ['#DC143C', '#228B22', '#FFD700']
      });
    }

    setTimeout(() => {
      fireworks.style.display = 'none';
    }, 4000);
  }

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ­Ø¯ÙŠ
  function resetChallenge() {
    activity.playSound('Click.mp3');
    clearInterval(timer);
    
    document.getElementById('challengeArea').style.display = 'none';
    document.getElementById('winnerDisplay').style.display = 'none';
    document.getElementById('teamsContainer').innerHTML = '';
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    currentTurn = 1;
    teamScores = {};
    timeLeft = 0;
    
    activity.showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ­Ø¯ÙŠ', 'info');
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  window.onload = async () => {
    activity.init();
    await loadStudents();
  };
</script>
</body>
</html>
