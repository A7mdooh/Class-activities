<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>التحديات 🔥</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="../assets/css/responsive.css">
<link rel="stylesheet" href="../config/unified-styles-template.css">
  <style>
    /* ثيم صفحة التحميل العُماني */
    :root {
      /* ألوان صفحة التحميل */
      --primary-color: #00796B;
      --primary-light: #4DB6AC;
      --primary-dark: #004D40;
      --secondary-color: #FF5722;
      --accent-color: #26a69a;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      --error-color: #F44336;
      
      /* تدرجات متطابقة مع صفحة التحميل */
      --primary-gradient: linear-gradient(135deg, #26a69a 0%, #00796B 100%);
      --primary-gradient-start: #26a69a;
      --primary-gradient-end: #00796B;
      --secondary-gradient: linear-gradient(135deg, #FF5722 0%, #FF7043 100%);
      --success-gradient: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
      --warning-gradient: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);
      
      /* ألوان النص والخلفية */
      --text-dark: #212121;
      --text-light: #757575;
      --bg-light: #FAFAFA;
      
      /* ظلال */
      --shadow-soft: 0 10px 30px rgba(0,121,107,0.1);
      --shadow-medium: 0 15px 35px rgba(0,121,107,0.15);
      --shadow-large: 0 20px 40px rgba(0,121,107,0.2);
      --border-radius: 20px;
    }

    /* تصميم أزرار التحكم العلوية */
    .control-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .control-btn {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(0, 121, 107, 0.2);
    }

    .control-btn:hover {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0, 121, 107, 0.3);
    }

    .control-btn:active {
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      .control-buttons {
        top: 10px;
        right: 10px;
        gap: 8px;
      }
      
      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
      }
    }

    body {
      background: linear-gradient(135deg,
        #e0f7fa 0%,
        #b2dfdb 25%,
        #80cbc4 50%,
        #4db6ac 75%,
        #26a69a 100%);
      background-attachment: fixed;
      min-height: 100vh;
      font-family: 'Cairo', sans-serif;
    }

    /* تخصيص نشاط التحديات */
    .activity-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .challenge-header {
      background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1));
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 2.5rem;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: var(--shadow-large);
    }

    .challenge-header h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      background: linear-gradient(45deg, #fff, #f0f0f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .challenge-controls {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 2.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      margin-bottom: 2rem;
    }

    .control-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
      justify-content: center;
      margin-bottom: 1.5rem;
    }    .control-group label {
      font-weight: 700;
      color: var(--text-dark);
      min-width: 120px;
      font-size: 1.1rem;
    }

    .control-group select,
    .control-group button {
      padding: 1rem 1.5rem;
      border-radius: 15px;
      border: none;
      font-size: 1rem;
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: var(--shadow-soft);
    }

    .control-group select {
      background: white;
      color: var(--text-dark);
      min-width: 180px;
      border: 2px solid #e2e8f0;
    }

    .control-group select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: var(--primary-gradient);
      color: white;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transform: translateY(0);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-medium);
    }

    .btn-accent {
      background: var(--primary-gradient);
    }

    .btn-info {
      background: var(--success-gradient);
    }

    .btn-success {
      background: var(--warning-gradient);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d, #495057);
    }

    .challenge-area {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 2.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      display: none;
      text-align: center;
    }

    .turn-display {
      background: var(--primary-gradient);
      color: white;
      padding: 1.5rem 2.5rem;
      border-radius: 15px;
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-medium);
      backdrop-filter: blur(10px);
    }

    .timer-container {
      position: relative;
      width: 150px;
      height: 150px;
      margin: 2rem auto;
    }

    .timer-circle {
      width: 150px;
      height: 150px;
    }

    .timer-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-color);
    }

    .timer-container.shake {
      animation: shake 0.5s infinite;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin: 2rem 0;
    }

    .team-card {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--shadow-medium);
      border: 3px solid var(--primary-color);
      transition: all 0.3s ease;
    }

    .team-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-large);
    }

    .team-card h3 {
      color: var(--primary-color);
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .team-score {
      font-size: 3rem;
      font-weight: 700;
      color: var(--accent-color);
      margin: 1rem 0;
    }

    .score-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .score-btn {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      border: 3px solid transparent;
      font-size: 1.6rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .score-btn.plus {
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8);
      color: white;
      border-color: #20c997;
    }

    .score-btn.plus::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .score-btn.plus:hover::before {
      left: 100%;
    }

    .score-btn.minus {
      background: linear-gradient(135deg, #dc3545, #fd7e14, #ffc107);
      color: white;
      border-color: #fd7e14;
    }

    .score-btn.minus::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .score-btn.minus:hover::before {
      left: 100%;
    }

    .score-btn:hover {
      transform: scale(1.15) rotate(5deg);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .score-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
    }

    .score-btn.plus:hover {
      background: linear-gradient(135deg, #20c997, #17a2b8, #007bff);
      border-color: #17a2b8;
      animation: plusGlow 0.6s ease-in-out infinite alternate;
    }

    .score-btn.minus:hover {
      background: linear-gradient(135deg, #fd7e14, #ffc107, #e83e8c);
      border-color: #ffc107;
      animation: minusGlow 0.6s ease-in-out infinite alternate;
    }

    @keyframes plusGlow {
      0% { box-shadow: 0 8px 25px rgba(32, 201, 151, 0.4); }
      100% { box-shadow: 0 8px 35px rgba(32, 201, 151, 0.7); }
    }

    @keyframes minusGlow {
      0% { box-shadow: 0 8px 25px rgba(253, 126, 20, 0.4); }
      100% { box-shadow: 0 8px 35px rgba(253, 126, 20, 0.7); }
    }

    .challenge-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
      flex-wrap: wrap;
    }

    .winner-display {
      background: var(--gradient-accent);
      color: white;
      padding: 2rem;
      border-radius: 15px;
      font-size: 2rem;
      font-weight: 700;
      margin-top: 2rem;
      box-shadow: var(--shadow-large);
      display: none;
    }

    .manual-selection {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem 0;
      border: 2px dashed var(--primary-color);
      display: none;
    }

    .multi-team-options {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem 0;
      border: 2px dashed var(--primary-color);
      display: none;
    }

    .instruction-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      max-width: 600px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow-extra-large);
      position: relative;
    }

    .modal-content h2 {
      color: var(--primary-color);
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }

    .modal-content p {
      font-size: 1.3rem;
      line-height: 1.8;
      color: var(--text-color);
      margin-bottom: 2rem;
    }

    .time-up-popup {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 2rem 3rem;
      border-radius: 20px;
      box-shadow: var(--shadow-extra-large);
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-color);
      z-index: 10000;
      display: none;
      border: 4px solid var(--accent-color);
    }

    .fireworks-effect {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: url('../assets/media/sounds/firework.gif') center center no-repeat;
      background-size: cover;
      z-index: 9999;
      display: none;
    }

    /* تحسينات الاستجابة */
    @media (max-width: 768px) {
      .challenge-header h1 {
        font-size: 2rem;
      }

      .control-group {
        flex-direction: column;
        text-align: center;
      }

      .teams-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .timer-container {
        width: 120px;
        height: 120px;
      }

      .timer-circle {
        width: 120px;
        height: 120px;
      }

      .challenge-actions {
        flex-direction: column;
        align-items: center;
      }
    }

    @media (max-width: 480px) {
      .activity-container {
        padding: 10px;
      }

      .challenge-header,
      .challenge-controls,
      .challenge-area {
        padding: 1rem;
      }

      .team-score {
        font-size: 2.5rem;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(5px, 0); }
      50% { transform: translate(0, 5px); }
      75% { transform: translate(-5px, 0); }
    }

    /* تحسينات للإشعارات المتقدمة */
    .advanced-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 15px;
      padding: 1rem 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 10000;
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.3s ease;
      min-width: 300px;
      border-left: 5px solid var(--primary-color);
    }

    .advanced-notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .advanced-notification.success { border-left-color: #28a745; }
    .advanced-notification.warning { border-left-color: #ffc107; }
    .advanced-notification.error { border-left-color: #dc3545; }
    .advanced-notification.challenge { border-left-color: #ff6b35; }
    .advanced-notification.timer { border-left-color: #17a2b8; }
    .advanced-notification.trophy { border-left-color: #ffd700; }
    .advanced-notification.loading { border-left-color: #6f42c1; }
    .advanced-notification.celebration { border-left-color: #fd7e14; }

    .notification-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .notification-close {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 0.2rem;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .notification-close:hover {
      background: #f0f0f0;
      color: #666;
    }

    .notification-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: var(--primary-color);
      border-radius: 0 0 15px 15px;
    }

    @keyframes progress {
      from { width: 100%; }
      to { width: 0%; }
    }

    /* إشعارات عائمة */
    .floating-tip {
      position: fixed;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      font-size: 0.9rem;
      z-index: 10001;
      transform: translateY(10px);
      opacity: 0;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    .floating-tip.show {
      transform: translateY(0);
      opacity: 1;
    }

    .tip-content {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tip-content i {
      color: #ffd700;
    }

    /* تحسينات إضافية للواجهة */
    .control-group button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .team-card:hover .team-avatar {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(0,0,0,0.3);
    }

    .score-btn:hover {
      transform: scale(1.15);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* تأثيرات انتقالية محسنة */
    .challenge-area {
      animation: slideInUp 0.6s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* تحسينات استجابة */
    @media (max-width: 768px) {
      .floating-tip {
        position: fixed;
        top: 20px !important;
        left: 20px !important;
        right: 20px !important;
        width: auto !important;
      }
    }

    .notification-icon {
      font-size: 1.2rem;
    }

    .notification-message {
      color: var(--text-color);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* تأثير النجوم المتساقطة */
    .star {
      position: fixed;
      color: #ffd700;
      font-size: 20px;
      z-index: 1000;
      pointer-events: none;
      animation: fallingStar 3s linear forwards;
      text-shadow: 0 0 10px #ffd700;
    }

    /* تحسينات للفرق */
    .team-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .team-status {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      padding: 0.3rem 0.8rem;
      background: #f8f9fa;
      border-radius: 15px;
      text-align: center;
    }

    .vs-divider {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 1rem;
    }

    .vs-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--gradient-accent);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      animation: pulse 2s infinite;
    }

    .vs-circle i {
      font-size: 1.2rem;
      margin-bottom: 0.2rem;
    }

    .multi-team {
      position: relative;
      overflow: hidden;
    }

    .multi-team::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-color);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @media (max-width: 768px) {
      .vs-divider {
        margin: 1rem 0;
      }
      
      .vs-circle {
        width: 60px;
        height: 60px;
        font-size: 0.8rem;
      }
      
      .advanced-notification {
        right: 10px;
        left: 10px;
        min-width: auto;
        transform: translateY(-100px);
      }
      
      .advanced-notification.show {
        transform: translateY(0);
      }
    }

    /* تحسينات إضافية */
    @keyframes scoreFloat {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-30px) scale(1.2);
        opacity: 0;
      }
    }

    .final-results {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }

    .result-item {
      padding: 0.5rem;
      margin: 0.3rem 0;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
    }

    .result-item.winner {
      background: rgba(255,215,0,0.3);
      border: 2px solid #ffd700;
    }

    .match-summary {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }

    .score-breakdown {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .player-result {
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      font-weight: 600;
    }

    .player-result.winner {
      background: rgba(40,167,69,0.2);
      border: 2px solid #28a745;
      color: #28a745;
    }

    .player-result.loser {
      background: rgba(220,53,69,0.2);
      border: 2px solid #dc3545;
      color: #dc3545;
    }

    .player-result.tie {
      background: rgba(255,193,7,0.2);
      border: 2px solid #ffc107;
      color: #856404;
    }

    .stats-container {
      text-align: left;
      margin: 1rem 0;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px solid #eee;
    }

    .stat-value {
      font-weight: 700;
      color: var(--accent-color);
    }

    .winner-stat {
      padding: 0.8rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      background: #f8f9fa;
      border-left: 4px solid var(--primary-color);
    }

    .winner-stat.top-winner {
      background: rgba(255,215,0,0.1);
      border-left-color: #ffd700;
      font-weight: 700;
    }

    /* دليل المعلم */
    .teacher-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #eee;
    }

    .tab-btn {
      padding: 0.8rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--text-color);
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: var(--primary-color);
      color: white;
      transform: translateY(2px);
    }

    .tab-content {
      display: none;
      padding: 1rem 0;
    }

    .tab-content.active {
      display: block;
    }

    .rule-card, .tip-card, .strategy-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin: 1rem 0;
      border-left: 4px solid var(--primary-color);
    }

    .rule-card h4, .tip-card h4, .strategy-card h4 {
      color: var(--primary-color);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .rule-card ul, .tip-card ul, .strategy-card ul {
      padding-right: 1.5rem;
      line-height: 1.6;
    }

    .rule-card li, .tip-card li, .strategy-card li {
      margin: 0.5rem 0;
    }

    .question-type {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 1px solid #ddd;
    }

    .question-type h5 {
      color: var(--accent-color);
      margin-bottom: 0.5rem;
    }

    /* تحسينات دليل المعلم المحدثة */
    .modal-content-enhanced {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
      animation: modalSlideIn 0.4s ease-out;
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      text-align: center;
      padding: 20px 20px 15px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      margin-bottom: 20px;
      position: relative;
    }

    .modal-header h2 {
      color: var(--primary-gradient-start);
      font-size: 1.8rem;
      margin: 0 0 5px 0;
      font-weight: 700;
    }

    .modal-subtitle {
      color: #666;
      font-size: 0.95rem;
      margin: 0;
      font-weight: 400;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      background: rgba(255, 0, 0, 0.1);
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 20px;
      color: #ff4757;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255, 0, 0, 0.2);
      transform: scale(1.1);
    }

    .teacher-tabs-enhanced {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0 20px 20px;
      border-radius: 15px;
      background: rgba(102, 126, 234, 0.1);
      padding: 8px;
    }

    .tab-btn-enhanced {
      flex: 1;
      min-width: 120px;
      background: transparent;
      border: none;
      padding: 12px 8px;
      border-radius: 10px;
      color: #666;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .tab-btn-enhanced.active {
      background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .tab-btn-enhanced:hover:not(.active) {
      background: rgba(102, 126, 234, 0.2);
      color: var(--primary-gradient-start);
    }

    .tab-btn-enhanced i {
      font-size: 1.1rem;
    }

    .tab-content-container {
      padding: 0 20px;
      min-height: 400px;
    }

    .tab-content-enhanced {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .tab-content-enhanced.active {
      display: block;
    }

    /* نظرة عامة */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .overview-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .overview-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .card-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .overview-card h3 {
      color: var(--primary-gradient-start);
      font-size: 1.1rem;
      margin: 10px 0;
      font-weight: 600;
    }

    .overview-card p {
      color: #666;
      font-size: 0.9rem;
      line-height: 1.5;
      margin: 0;
    }

    .quick-start-guide {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(0, 184, 148, 0.1));
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(46, 213, 115, 0.3);
    }

    .quick-start-guide h3 {
      color: #00b894;
      margin: 0 0 15px 0;
      font-size: 1.2rem;
    }

    .steps-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .step-number {
      background: linear-gradient(135deg, #00b894, #55a3ff);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .step-text {
      color: #2d3436;
      font-weight: 500;
    }

    /* قواعد النشاط */
    .rule-card-enhanced {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .rule-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .rule-header i {
      color: var(--primary-gradient-start);
      font-size: 1.3rem;
    }

    .rule-header h4 {
      color: var(--primary-gradient-start);
      margin: 0;
      font-size: 1.2rem;
    }

    .challenge-types {
      display: grid;
      gap: 15px;
    }

    .challenge-type {
      background: rgba(102, 126, 234, 0.05);
      border-radius: 10px;
      padding: 15px;
      border-left: 4px solid var(--primary-gradient-start);
    }

    .challenge-type h5 {
      color: #2d3436;
      margin: 0 0 8px 0;
      font-size: 1rem;
    }

    .challenge-type p {
      color: #636e72;
      margin: 0 0 5px 0;
      font-size: 0.9rem;
    }

    .challenge-type small {
      color: #74b9ff;
      font-weight: 500;
    }

    /* إدارة الصف */
    .management-timeline {
      position: relative;
    }

    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 25px;
      position: relative;
    }

    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 22px;
      top: 45px;
      width: 2px;
      height: calc(100% + 10px);
      background: linear-gradient(180deg, var(--primary-gradient-start), var(--primary-gradient-end));
      opacity: 0.3;
    }

    .timeline-icon {
      background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
      color: white;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .timeline-content {
      flex: 1;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      padding: 20px;
    }

    .timeline-content h4 {
      color: var(--primary-gradient-start);
      margin: 0 0 10px 0;
      font-size: 1.1rem;
    }

    .timeline-content ul {
      margin: 0;
      padding-right: 20px;
      list-style: none;
    }

    .timeline-content li {
      color: #636e72;
      margin-bottom: 8px;
      padding-right: 15px;
      position: relative;
    }

    .timeline-content li::before {
      content: '✓';
      position: absolute;
      right: 0;
      color: #00b894;
      font-weight: bold;
    }

    /* استراتيجيات التقييم */
    .strategies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .strategy-card-enhanced {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      padding: 20px;
    }

    .strategy-card-enhanced h4 {
      color: var(--primary-gradient-start);
      margin: 0 0 15px 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .points-system, .timing-guide {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .point-rule, .time-slot {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      background: rgba(102, 126, 234, 0.05);
      border-radius: 10px;
    }

    .points {
      background: linear-gradient(135deg, #00b894, #55a3ff);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      min-width: 35px;
      text-align: center;
    }

    .duration {
      background: linear-gradient(135deg, #fdcb6e, #e17055);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .description, .usage {
      color: #636e72;
      font-size: 0.9rem;
    }

    /* نصائح متقدمة */
    .tips-masonry {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
    }

    .tip-card-enhanced {
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: transform 0.3s ease;
    }

    .tip-card-enhanced:hover {
      transform: translateY(-3px);
    }

    .tip-card-enhanced.success {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(0, 184, 148, 0.05));
      border-color: rgba(46, 213, 115, 0.3);
    }

    .tip-card-enhanced.info {
      background: linear-gradient(135deg, rgba(116, 185, 255, 0.1), rgba(102, 126, 234, 0.05));
      border-color: rgba(116, 185, 255, 0.3);
    }

    .tip-card-enhanced.warning {
      background: linear-gradient(135deg, rgba(253, 203, 110, 0.1), rgba(225, 112, 85, 0.05));
      border-color: rgba(253, 203, 110, 0.3);
    }

    .tip-card-enhanced.primary {
      background: linear-gradient(135deg, rgba(162, 155, 254, 0.1), rgba(116, 185, 255, 0.05));
      border-color: rgba(162, 155, 254, 0.3);
    }

    .tip-card-enhanced i {
      font-size: 1.5rem;
      margin-bottom: 10px;
      display: block;
    }

    .tip-card-enhanced.success i { color: #00b894; }
    .tip-card-enhanced.info i { color: #74b9ff; }
    .tip-card-enhanced.warning i { color: #fdcb6e; }
    .tip-card-enhanced.primary i { color: #a29bfe; }

    .tip-card-enhanced h4 {
      margin: 10px 0;
      font-size: 1.1rem;
      color: #2d3436;
    }

    .tip-card-enhanced p {
      color: #636e72;
      font-size: 0.9rem;
      line-height: 1.6;
      margin: 0;
    }

    .modal-footer {
      text-align: center;
      padding: 20px;
      border-top: 2px solid rgba(102, 126, 234, 0.2);
      margin-top: 20px;
    }

    .btn-close-enhanced {
      background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-close-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    @media (max-width: 768px) {
      .teacher-tabs-enhanced {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .tab-btn-enhanced {
        font-size: 0.8rem;
        padding: 10px 6px;
      }
      
      .overview-grid {
        grid-template-columns: 1fr;
      }
      
      .strategies-grid {
        grid-template-columns: 1fr;
      }
      
      .tips-masonry {
        grid-template-columns: 1fr;
      }
    }

    .question-type p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* مؤشر التحميل */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .loading-indicator.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      margin: 0 auto 2rem;
      animation: spin 1s linear infinite;
    }

    .loading-content h3 {
      font-size: 2rem;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .loading-content p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fallingStar {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s ease-in-out;
    }
</style>
</head>
<body>
<!-- أزرار التحكم المحدثة -->
<div class="control-buttons mobile-grid-3">
  <button class="control-btn touch-target" id="activitiesBtn" title="العودة للأنشطة" onclick="goToActivities()">
    <i class="fas fa-book"></i>
  </button>
  <button class="control-btn touch-target" id="fullscreenBtn" title="ملء الشاشة">
    <i class="fas fa-expand-arrows-alt"></i>
  </button>
  <button class="control-btn touch-target" id="settingsBtn" title="الإعدادات" onclick="showSettings()">
    <i class="fas fa-cog"></i>
  </button>
</div>

<!-- منطقة الإشعارات -->
<div id="notification-container"></div>

<!-- مؤشر التحميل مع زر إخفاء طارئ -->
<div id="loadingIndicator" class="loading-indicator">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <h3><i class="fas fa-fire"></i> جاري تحميل نشاط التحديات</h3>
    <p id="loadingText">يرجى الانتظار...</p>
    <button onclick="hideLoadingIndicator(); challengeEnhancer.showToast('✅ تم', 'تم إخفاء شاشة التحميل يدوياً', 'success')" 
            style="margin-top: 20px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
      <i class="fas fa-times"></i> إخفاء شاشة التحميل
    </button>
  </div>
</div>

<div class="activity-container mobile-full-width">
  <!-- رأس التحدي -->
  <div class="challenge-header mobile-text-center">
    <h1><i class="fas fa-fire"></i> نشاط التحديات <i class="fas fa-fire"></i></h1>
    <p>اختبر مهاراتك وتنافس مع زملائك في تحديات مثيرة!</p>
  </div>

  <!-- أدوات التحكم -->
  <div class="challenge-controls mobile-full-width">
    <div class="control-group mobile-full-width">
      <label><i class="fas fa-users"></i> اختر الصف:</label>
      <select id="classSelect" class="mobile-full-width">
        <option value="">اختر الصف</option>
      </select>
    </div>

    <div class="control-group mobile-full-width">
      <label><i class="fas fa-gamepad"></i> نوع التحدي:</label>
      <select id="mode" onchange="handleModeChange()" class="mobile-full-width">
        <option value="random">طالب ضد طالب (عشوائي)</option>
        <option value="manual">طالب ضد طالب (اختياري)</option>
        <option value="teams">فريق ضد فريق</option>
        <option value="multiTeams">تحدي بين فرق متعددة</option>
      </select>
    </div>

    <div id="manualSelection" class="manual-selection mobile-full-width">
      <h4><i class="fas fa-hand-pointer"></i> اختر المتنافسين</h4>
      <div class="control-group mobile-full-width">
        <label>الطالب الأول:</label>
        <select id="student1Select" class="mobile-full-width"></select>
      </div>
      <div class="control-group mobile-full-width">
        <label>الطالب الثاني:</label>
        <select id="student2Select" class="mobile-full-width"></select>
      </div>
    </div>

    <div id="multiTeamOptions" class="multi-team-options mobile-full-width">
      <h4><i class="fas fa-users-cog"></i> إعداد الفرق المتعددة</h4>
      <div class="control-group mobile-full-width">
        <label>عدد الفرق:</label>
        <select id="teamCountSelect" class="mobile-full-width">
          <option value="3">3 فرق</option>
          <option value="4">4 فرق</option>
          <option value="5">5 فرق</option>
          <option value="6">6 فرق</option>
          <option value="7">7 فرق</option>
          <option value="8">8 فرق</option>
        </select>
      </div>
    </div>

    <div class="control-group mobile-full-width">
      <label><i class="fas fa-clock"></i> المدة:</label>
      <select id="duration" class="mobile-full-width">
        <option value="30">30 ثانية</option>
        <option value="60">1 دقيقة</option>
        <option value="120">2 دقائق</option>
        <option value="180">3 دقائق</option>
        <option value="240">4 دقائق</option>
        <option value="300">5 دقائق</option>
        <option value="600">10 دقائق</option>
      </select>
    </div>

    <div class="control-group mobile-grid-2">
      <button onclick="prepareChallenge()" class="btn btn-accent touch-target mobile-full-width">
        <i class="fas fa-rocket"></i> بدء التحدي
      </button>
      <button onclick="showTeacherGuide()" class="btn btn-info touch-target mobile-full-width">
        <i class="fas fa-chalkboard-teacher"></i> دليل المعلم
      </button>
    </div>
  </div>

  <!-- منطقة التحدي -->
  <div id="challengeArea" class="challenge-area mobile-full-width">
    <div id="turnLabel" class="turn-display mobile-text-center">
      <i class="fas fa-user-clock"></i> جاري التحضير...
    </div>

    <div id="timerWrapper" class="timer-container mobile-text-center">
      <svg class="timer-circle" viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="50" fill="none" stroke="#eee" stroke-width="8"></circle>
        <circle cx="60" cy="60" r="50" fill="none" id="progress" stroke="var(--accent-color)" 
                stroke-dasharray="314" stroke-dashoffset="0" stroke-width="8" 
                transform="rotate(-90 60 60)"></circle>
      </svg>
      <div id="timerTextSec" class="timer-text">0s</div>
    </div>

    <div class="teams-grid mobile-grid-2" id="teamsContainer"></div>

    <div class="challenge-actions mobile-grid-3">
      <button onclick="nextTurn()" class="btn btn-primary touch-target mobile-full-width">
        <i class="fas fa-arrow-right"></i> التالي
      </button>
      <button onclick="endChallenge()" class="btn btn-success touch-target mobile-full-width">
        <i class="fas fa-trophy"></i> إنهاء التحدي
      </button>
      <button onclick="resetChallenge()" class="btn btn-secondary touch-target mobile-full-width">
        <i class="fas fa-redo"></i> إعادة تعيين
      </button>
    </div>

    <div id="winnerDisplay" class="winner-display"></div>
  </div>
</div>
<!-- نافذة التعليمات المنبثقة -->
<div id="instructionModal" class="instruction-modal responsive-modal">
  <div class="modal-content mobile-full-height">
    <h2><i class="fas fa-info-circle"></i> تعليمات التحدي</h2>
    <p id="instructionText"></p>
    <button onclick="closeInstructionModal()" class="btn btn-primary touch-target mobile-full-width">
      <i class="fas fa-check"></i> فهمت
    </button>
  </div>
</div>

<!-- دليل المعلم التفاعلي المحسن -->
<div id="teacherGuideModal" class="instruction-modal responsive-modal">
  <div class="modal-content-enhanced mobile-full-height">
    <div class="modal-header">
      <h2><i class="fas fa-graduation-cap"></i> دليل المعلم المطور</h2>
      <p class="modal-subtitle">دليلك الشامل لإدارة نشاط التحديات بفعالية</p>
      <button onclick="closeTeacherGuide()" class="close-btn">&times;</button>
    </div>
    
    <div class="teacher-tabs-enhanced">
      <button class="tab-btn-enhanced active" data-tab="overview">
        <i class="fas fa-eye"></i>
        <span>نظرة عامة</span>
      </button>
      <button class="tab-btn-enhanced" data-tab="rules">
        <i class="fas fa-list-ol"></i>
        <span>قواعد النشاط</span>
      </button>
      <button class="tab-btn-enhanced" data-tab="management">
        <i class="fas fa-users-cog"></i>
        <span>إدارة الصف</span>
      </button>
      <button class="tab-btn-enhanced" data-tab="strategies">
        <i class="fas fa-trophy"></i>
        <span>استراتيجيات التقييم</span>
      </button>
      <button class="tab-btn-enhanced" data-tab="tips">
        <i class="fas fa-lightbulb"></i>
        <span>نصائح متقدمة</span>
      </button>
    </div>
    
    <div class="tab-content-container">
      <!-- نظرة عامة -->
      <div id="overview-content" class="tab-content-enhanced active">
        <div class="overview-grid">
          <div class="overview-card">
            <div class="card-icon">🎯</div>
            <h3>الهدف الرئيسي</h3>
            <p>تحفيز التعلم التفاعلي والتنافس الإيجابي بين الطلاب مع تطوير مهارات التفكير النقدي والعمل الجماعي.</p>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">⏱️</div>
            <h3>المدة المقترحة</h3>
            <p>15-45 دقيقة حسب حجم الصف ونوع النشاط. يمكن تقسيمها على عدة جلسات قصيرة.</p>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">👥</div>
            <h3>حجم الصف المناسب</h3>
            <p>من 10 إلى 40 طالب. النشاط قابل للتكيف مع أحجام الصفوف المختلفة.</p>
          </div>
          
          <div class="overview-card">
            <div class="card-icon">📚</div>
            <h3>المواد المطلوبة</h3>
            <p>جهاز عرض، أسئلة محضرة مسبقاً، ورقة وقلم لتسجيل الملاحظات (اختياري).</p>
          </div>
        </div>
        
        <div class="quick-start-guide">
          <h3><i class="fas fa-rocket"></i> البدء السريع</h3>
          <div class="steps-list">
            <div class="step">
              <span class="step-number">1</span>
              <span class="step-text">اختر الصف من القائمة المنسدلة</span>
            </div>
            <div class="step">
              <span class="step-number">2</span>
              <span class="step-text">حدد نوع التحدي المناسب لهدفك</span>
            </div>
            <div class="step">
              <span class="step-number">3</span>
              <span class="step-text">اضبط المدة الزمنية للدور الواحد</span>
            </div>
            <div class="step">
              <span class="step-number">4</span>
              <span class="step-text">اضغط "بدء التحدي" واستمتع بالتفاعل!</span>
            </div>
          </div>
        </div>
      </div>

      <!-- قواعد النشاط -->
      <div id="rules-content" class="tab-content-enhanced">
        <div class="rules-section">
          <div class="rule-card-enhanced">
            <div class="rule-header">
              <i class="fas fa-gamepad"></i>
              <h4>أنواع التحديات المتاحة</h4>
            </div>
            <div class="challenge-types">
              <div class="challenge-type">
                <h5>🎲 طالب ضد طالب (عشوائي)</h5>
                <p>مثالي للمراجعة السريعة وضمان مشاركة جميع الطلاب</p>
                <small>الاستخدام: مراجعة، تنشيط، كسر الملل</small>
              </div>
              <div class="challenge-type">
                <h5>🎯 طالب ضد طالب (اختياري)</h5>
                <p>لاستهداف طلاب محددين أو تحفيز الطلاب الخجولين</p>
                <small>الاستخدام: التقييم الفردي، التشجيع المباشر</small>
              </div>
              <div class="challenge-type">
                <h5>👥 فريق ضد فريق</h5>
                <p>تطوير العمل الجماعي ومهارات التواصل</p>
                <small>الاستخدام: مشاريع، حل المشكلات الجماعي</small>
              </div>
              <div class="challenge-type">
                <h5>🏆 فرق متعددة</h5>
                <p>للأنشطة الكبيرة والمسابقات الشاملة</p>
                <small>الاستخدام: الحفلات، المسابقات الكبرى</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- إدارة الصف -->
      <div id="management-content" class="tab-content-enhanced">
        <div class="management-timeline">
          <div class="timeline-item">
            <div class="timeline-icon">🎯</div>
            <div class="timeline-content">
              <h4>قبل البدء</h4>
              <ul>
                <li>جهز أسئلة متنوعة ومناسبة للمستوى</li>
                <li>تأكد من وضوح قواعد اللعبة للطلاب</li>
                <li>اختبر الصوت والعرض</li>
              </ul>
            </div>
          </div>
          
          <div class="timeline-item">
            <div class="timeline-icon">🎮</div>
            <div class="timeline-content">
              <h4>أثناء التحدي</h4>
              <ul>
                <li>استخدم أزرار +/- لتسجيل النقاط فوراً</li>
                <li>شجع التفاعل الإيجابي من الطلاب</li>
                <li>راقب الوقت واستفد من التنبيهات</li>
              </ul>
            </div>
          </div>
          
          <div class="timeline-item">
            <div class="timeline-icon">🏁</div>
            <div class="timeline-content">
              <h4>بعد الانتهاء</h4>
              <ul>
                <li>راجع النتائج مع الطلاب</li>
                <li>قدم تغذية راجعة إيجابية</li>
                <li>اربط النتائج بالأهداف التعليمية</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- استراتيجيات التقييم -->
      <div id="strategies-content" class="tab-content-enhanced">
        <div class="strategies-grid">
          <div class="strategy-card-enhanced">
            <h4><i class="fas fa-medal"></i> نظام النقاط المرن</h4>
            <div class="points-system">
              <div class="point-rule">
                <span class="points">+1</span>
                <span class="description">إجابة صحيحة أساسية</span>
              </div>
              <div class="point-rule">
                <span class="points">+2</span>
                <span class="description">إجابة مفصلة ودقيقة</span>
              </div>
              <div class="point-rule">
                <span class="points">+3</span>
                <span class="description">إجابة إبداعية أو سرعة استثنائية</span>
              </div>
            </div>
          </div>
          
          <div class="strategy-card-enhanced">
            <h4><i class="fas fa-clock"></i> دليل التوقيت</h4>
            <div class="timing-guide">
              <div class="time-slot">
                <span class="duration">30-60 ثانية</span>
                <span class="usage">أسئلة سريعة، حقائق، تعاريف</span>
              </div>
              <div class="time-slot">
                <span class="duration">1-3 دقائق</span>
                <span class="usage">تحليل، مقارنات، حل مشكلات</span>
              </div>
              <div class="time-slot">
                <span class="duration">3-10 دقائق</span>
                <span class="usage">مشاريع صغيرة، عروض، إبداع</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- نصائح متقدمة -->
      <div id="tips-content" class="tab-content-enhanced">
        <div class="tips-masonry">
          <div class="tip-card-enhanced success">
            <i class="fas fa-heart"></i>
            <h4>تعزيز الثقة</h4>
            <p>ابدأ بأسئلة سهلة لبناء الثقة، ثم تدرج في الصعوبة. احتفل بكل نجاح مهما كان صغيراً.</p>
          </div>
          
          <div class="tip-card-enhanced info">
            <i class="fas fa-brain"></i>
            <h4>التنويع في الأسئلة</h4>
            <p>امزج بين الأسئلة النظرية والعملية، واستخدم الصور والأمثلة البصرية لزيادة التفاعل.</p>
          </div>
          
          <div class="tip-card-enhanced warning">
            <i class="fas fa-balance-scale"></i>
            <h4>الحفاظ على العدالة</h4>
            <p>تأكد من توزيع الفرص بعدالة. استخدم النمط العشوائي لضمان مشاركة الجميع.</p>
          </div>
          
          <div class="tip-card-enhanced primary">
            <i class="fas fa-magic"></i>
            <h4>خلق الإثارة</h4>
            <p>استخدم التعليقات المشجعة والأصوات والتأثيرات لخلق جو مليء بالحماس والطاقة الإيجابية.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button onclick="closeTeacherGuide()" class="btn-close-enhanced">
        <i class="fas fa-check-circle"></i> فهمت - لنبدأ التحدي!
      </button>
    </div>
  </div>
</div>

<!-- المؤثرات البصرية -->
<div id="fireworks" class="fireworks-effect"></div>
<div id="timeUpPopup" class="time-up-popup">
  <i class="fas fa-clock"></i> انتهى الوقت!
</div>
<script src="../config/unified-scripts-template.js"></script>
<script>
  // ==== ChallengeEnhancer Pro - مدمج في الصفحة ====
  /**
   * 💡 ChallengeEnhancer Pro
   * النسخة الاحترافية من نظام تعزيز تجربة التحديات الصفية
   * تشمل: إشعارات فورية، أصوات ذكية، مؤثرات احتفالية، وتعليقات صوتية تفاعلية
   */
  class ChallengeEnhancer {
    constructor(activityName = 'نشاط التحديات') {
      this.name = activityName;
      this.soundEnabled = true;
      this.voiceHintsEnabled = true;
      this.soundsPath = '../assets/media/sounds/';
      this.kingdomSoundsPath = '../assets/media/sounds/kingdom-sounds/';
      this.voicePhrases = [
        'أداء رائع!',
        'أنت على الطريق الصحيح!',
        'المنافسة تشتعل!',
        'لا تتوقف الآن!',
        'حافظ على هذا المستوى!',
        'أعطي كل ما لديك!',
        'تحدي نفسك أكثر!',
        'الفوز في متناول يدك!'
      ];
      this.motivationalCycleId = null;
      this.toastQueue = [];
      this.isProcessingToasts = false;
      this.lastInteractionTime = Date.now();
      
      // إضافة CSS للتوست
      this.injectCSS();
      
      console.log(`🎮 تم تهيئة ChallengeEnhancer للنشاط: ${this.name}`);
    }

    // حقن CSS للتوست والتأثيرات
    injectCSS() {
      if (document.getElementById('challenge-enhancer-styles')) return;
      
      const style = document.createElement('style');
      style.id = 'challenge-enhancer-styles';
      style.textContent = `
        .toast {
          min-width: 300px;
          max-width: 400px;
          margin-bottom: 10px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          opacity: 0;
          transform: translateX(100%);
          transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .toast.show {
          opacity: 1;
          transform: translateX(0);
        }
        
        .toast-success {
          background: linear-gradient(135deg, rgba(40, 167, 69, 0.95), rgba(25, 135, 84, 0.95));
          color: white;
          border-left: 4px solid #28a745;
        }
        
        .toast-info {
          background: linear-gradient(135deg, rgba(13, 202, 240, 0.95), rgba(13, 110, 253, 0.95));
          color: white;
          border-left: 4px solid #17a2b8;
        }
        
        .toast-warning {
          background: linear-gradient(135deg, rgba(255, 193, 7, 0.95), rgba(255, 143, 0, 0.95));
          color: #212529;
          border-left: 4px solid #ffc107;
        }
        
        .toast-error {
          background: linear-gradient(135deg, rgba(220, 53, 69, 0.95), rgba(157, 35, 49, 0.95));
          color: white;
          border-left: 4px solid #dc3545;
        }
        
        .toast-header {
          padding: 12px 16px 8px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-weight: 600;
          font-size: 1rem;
        }
        
        .toast-body {
          padding: 0 16px 12px;
          font-size: 0.9rem;
          line-height: 1.4;
          white-space: pre-line;
        }
        
        .toast button {
          background: none;
          border: none;
          color: inherit;
          font-size: 1.2rem;
          font-weight: bold;
          cursor: pointer;
          opacity: 0.7;
          transition: opacity 0.2s;
          padding: 4px;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
        }
        
        .toast button:hover {
          opacity: 1;
          background: rgba(255, 255, 255, 0.2);
        }
        
        .celebration-burst {
          position: fixed;
          pointer-events: none;
          z-index: 10000;
          animation: celebrationBurst 2s ease-out forwards;
        }
        
        @keyframes celebrationBurst {
          0% {
            transform: scale(0) rotate(0deg);
            opacity: 1;
          }
          50% {
            transform: scale(1.5) rotate(180deg);
            opacity: 0.8;
          }
          100% {
            transform: scale(3) rotate(360deg);
            opacity: 0;
          }
        }
        
        .motivational-pulse {
          animation: motivationalPulse 2s ease-in-out infinite;
        }
        
        @keyframes motivationalPulse {
          0%, 100% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .hover-sound-enabled {
          transition: all 0.2s ease;
        }
        
        .hover-sound-enabled:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
          .toast {
            min-width: 280px;
            max-width: 95vw;
            margin: 5px;
            right: 10px !important;
          }
          
          .toast-header {
            padding: 10px 12px 6px;
            font-size: 0.9rem;
          }
          
          .toast-body {
            padding: 0 12px 10px;
            font-size: 0.85rem;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // تشغيل ملف صوتي من المسار المخصص مع نظام احتياطي
    playSound(filename, volume = 0.7, useKingdomSounds = false) {
      if (!this.soundEnabled) return;
      
      const basePath = useKingdomSounds ? this.kingdomSoundsPath : this.soundsPath;
      const fullPath = basePath + filename;
      
      try {
        const audio = new Audio(fullPath);
        audio.volume = Math.min(Math.max(volume, 0), 1);
        
        // نظام احتياطي في حالة فشل التحميل
        audio.addEventListener('error', () => {
          console.warn(`فشل في تحميل الصوت: ${fullPath}`);
          // جرب الصوت الاحتياطي
          const fallbackAudio = new Audio(this.soundsPath + 'Click.mp3');
          fallbackAudio.volume = volume * 0.5;
          fallbackAudio.play().catch(() => {});
        });
        
        const playPromise = audio.play();
        if (playPromise !== undefined) {
          playPromise.catch(e => {
            console.warn('فشل في تشغيل الصوت:', e);
          });
        }
      } catch (e) {
        console.warn('خطأ في إنشاء كائن الصوت:', e);
      }
    }

    // وظيفة مساعدة لتشغيل أصوات Kingdom بسهولة
    playKingdomSound(filename, volume = 0.7) {
      this.playSound(filename, volume, true);
    }

    // قراءة صوتية عشوائية مع دعم العربية
    speakRandomHint() {
      if (!this.voiceHintsEnabled || !window.speechSynthesis) return;
      
      // إيقاف أي كلام سابق
      speechSynthesis.cancel();
      
      const msg = new SpeechSynthesisUtterance();
      msg.lang = 'ar-SA';
      msg.rate = 0.9;
      msg.pitch = 1.1;
      msg.volume = 0.8;
      msg.text = this.voicePhrases[Math.floor(Math.random() * this.voicePhrases.length)];
      
      // التعامل مع الأخطاء
      msg.onerror = (e) => {
        console.warn('خطأ في التحدث:', e);
      };
      
      speechSynthesis.speak(msg);
    }

    // إشعار تفاعلي محسن مع نظام طابور
    showToast(title, body, type = 'info', duration = 4000) {
      const toast = {
        title,
        body,
        type,
        duration,
        id: Date.now() + Math.random()
      };
      
      this.toastQueue.push(toast);
      
      if (!this.isProcessingToasts) {
        this.processToastQueue();
      }
    }

    // معالج طابور التوست لتجنب التراكم
    processToastQueue() {
      if (this.toastQueue.length === 0) {
        this.isProcessingToasts = false;
        return;
      }
      
      this.isProcessingToasts = true;
      const toast = this.toastQueue.shift();
      this.displayToast(toast);
      
      // معالجة التوست التالي بعد فترة قصيرة
      setTimeout(() => {
        this.processToastQueue();
      }, 500);
    }

    // عرض التوست الفعلي
    displayToast(toastData) {
      const toastEl = document.createElement('div');
      toastEl.className = `toast toast-${toastData.type}`;
      toastEl.innerHTML = `
        <div class="toast-header">
          <strong>${toastData.title}</strong>
          <button onclick="this.closest('.toast').remove()" title="إغلاق">&times;</button>
        </div>
        <div class="toast-body">${toastData.body}</div>
      `;
      
      // تحديد موقع التوست
      Object.assign(toastEl.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        zIndex: 9999
      });
      
      // حساب الموضع بناءً على التوستات الموجودة
      const existingToasts = document.querySelectorAll('.toast');
      let topOffset = 20;
      existingToasts.forEach(existing => {
        topOffset += existing.offsetHeight + 10;
      });
      toastEl.style.top = topOffset + 'px';
      
      document.body.appendChild(toastEl);
      
      // تأثير الظهور
      requestAnimationFrame(() => {
        toastEl.classList.add('show');
      });
      
      // إزالة تلقائية
      setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => {
          if (toastEl.parentNode) {
            toastEl.remove();
          }
        }, 300);
      }, toastData.duration);
    }

    // مؤثر احتفالي متكامل مع تأثيرات بصرية
    celebrateWin(playerName) {
      // تشغيل الأصوات
      this.playSound('win.mp3');
      setTimeout(() => {
        this.playSound('fireworks-burst.mp3', 0.6, true);
      }, 500);
      
      // تعليق صوتي
      setTimeout(() => {
        this.speakRandomHint();
      }, 1000);
      
      // إشعار التهنئة
      this.showToast('🏆 تهانينا!', `${playerName} فاز بالتحدي!\nأداء استثنائي ومبهر!`, 'success', 6000);
      
      // تأثير الانفجار البصري
      this.createCelebrationBurst();
      
      // مؤثر الكونفيتي إذا كان متاحاً
      if (window.confetti) {
        confetti({
          particleCount: 150,
          spread: 100,
          origin: { y: 0.7 },
          colors: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4']
        });
        
        // انفجار ثاني بعد ثانية
        setTimeout(() => {
          confetti({
            particleCount: 100,
            spread: 120,
            origin: { y: 0.6 },
            colors: ['#FFA726', '#EF5350', '#42A5F5', '#66BB6A']
          });
        }, 1000);
      }
    }

    // إنشاء انفجار احتفالي مخصص
    createCelebrationBurst() {
      const emojis = ['🎉', '🎊', '⭐', '✨', '🌟', '🏆', '👏', '🎯'];
      for (let i = 0; i < 12; i++) {
        setTimeout(() => {
          const burst = document.createElement('div');
          burst.className = 'celebration-burst';
          burst.innerHTML = emojis[Math.floor(Math.random() * emojis.length)];
          burst.style.left = Math.random() * window.innerWidth + 'px';
          burst.style.top = Math.random() * window.innerHeight + 'px';
          burst.style.fontSize = (Math.random() * 30 + 20) + 'px';
          
          document.body.appendChild(burst);
          
          setTimeout(() => {
            if (burst.parentNode) {
              burst.remove();
            }
          }, 2000);
        }, i * 150);
      }
    }

    // تحفيز بناءً على النقاط مع منطق محسن
    checkMilestones(score, playerName) {
      if (score === 0) {
        this.showToast('🚀 تشجيع!', `${playerName}، البداية صعبة لكن النهاية جميلة!\nكل خبير كان مبتدئاً يوماً ما`, 'warning', 4000);
        this.playSound('notification-pop.mp3', 0.4, true);
      } else if (score === 1) {
        this.showToast('🌟 البداية!', `${playerName} حصل على أول نقطة!\nالرحلة بدأت بخطوة واحدة`, 'info', 3500);
        this.playSound('crystal-ping.mp3', 0.5, true);
      } else if (score === 3) {
        this.showToast('🔥 تقدم رائع!', `${playerName} يشق طريقه للنجاح!\nالثبات على الهدف سر النجاح`, 'info', 4000);
        this.playSound('level-up.mp3', 0.6, true);
      } else if (score === 5) {
        this.showToast('⚡ نصف الطريق!', `${playerName} وصل إلى ${score} نقاط!\nالعزيمة القوية تحقق المعجزات`, 'info', 4500);
        this.playSound('achievement-unlock.mp3', 0.7, true);
        this.speakRandomHint();
      } else if (score === 8) {
        this.showToast('🎯 قريب جداً!', `${playerName} على وشك تحقيق إنجاز عظيم!\nالخط الأخير هو الأصعب والأهم`, 'warning', 5000);
        this.playSound('epic-charge.mp3', 0.8, true);
      } else if (score >= 10) {
        this.celebrateWin(playerName);
      }
    }

    // اهتزاز الأزرار عند المرور عليها مع أصوات
    attachHoverSound(buttonSelector = '.btn, button, .clickable') {
      document.querySelectorAll(buttonSelector).forEach(btn => {
        btn.classList.add('hover-sound-enabled');
        
        btn.addEventListener('mouseenter', () => {
          this.playSound('button-hover.mp3', 0.2, true);
        });
        
        btn.addEventListener('click', () => {
          this.playSound('cosmic-click.mp3', 0.3, true);
        });
      });
    }

    // إظهار إشعار متسلسل للتحفيز مع ذكاء
    startMotivationalCycle(interval = 30000) {
      if (this.motivationalCycleId) {
        clearInterval(this.motivationalCycleId);
      }
      
      const phrases = [
        '💡 تذكر: النقطة القادمة قد تغير النتيجة!\nكل لحظة فرصة للتميز',
        '📊 تابع تقدمك على لوحة النتائج!\nالإحصائيات تحكي قصة نجاحك',
        '🧠 ركز، فأنت قريب من الفوز!\nالتركيز هو سلاح الأبطال',
        '⚡ التحدي لا ينتهي إلا مع آخر ثانية!\nاللحظات الأخيرة تحدد الفائز',
        '🎯 كل محاولة تقربك أكثر من الهدف!\nالمثابرة طريق التفوق',
        '🔥 الإصرار هو مفتاح النجاح!\nالعزيمة تكسر كل الحواجز',
        '⭐ أنت أقوى مما تعتقد!\nالثقة بالنفس نصف الطريق',
        '🌟 التحدي الحقيقي مع نفسك!\nتجاوز حدودك واكتشف قدراتك'
      ];
      
      let phraseIndex = 0;
      
      this.motivationalCycleId = setInterval(() => {
        // تجنب الإشعارات أثناء النشاط المكثف
        const isUserActive = document.hasFocus() && 
                            (Date.now() - this.lastInteractionTime < 10000);
        
        if (!isUserActive) return;
        
        const text = phrases[phraseIndex % phrases.length];
        this.showToast('💡 تحفيز ذكي', text, 'info', 6000);
        this.playSound('mystic-wind.mp3', 0.25, true);
        
        phraseIndex++;
      }, interval);
    }

    // إيقاف دورة التحفيز
    stopMotivationalCycle() {
      if (this.motivationalCycleId) {
        clearInterval(this.motivationalCycleId);
        this.motivationalCycleId = null;
      }
    }

    // تتبع التفاعل الأخير
    trackUserInteraction() {
      this.lastInteractionTime = Date.now();
    }

    // تفعيل/إيقاف الأصوات
    toggleSounds() {
      this.soundEnabled = !this.soundEnabled;
      const status = this.soundEnabled ? 'تم تفعيل' : 'تم إيقاف';
      this.showToast('🔊 إعدادات الصوت', `${status} الأصوات`, 'info', 2000);
      return this.soundEnabled;
    }

    // تفعيل/إيقاف التعليقات الصوتية
    toggleVoiceHints() {
      this.voiceHintsEnabled = !this.voiceHintsEnabled;
      const status = this.voiceHintsEnabled ? 'تم تفعيل' : 'تم إيقاف';
      this.showToast('🗣️ التعليقات الصوتية', `${status} التعليقات الصوتية`, 'info', 2000);
      return this.voiceHintsEnabled;
    }

    // إضافة تأثير النبض التحفيزي لعنصر
    addMotivationalPulse(element) {
      if (typeof element === 'string') {
        element = document.querySelector(element);
      }
      if (element) {
        element.classList.add('motivational-pulse');
        setTimeout(() => {
          element.classList.remove('motivational-pulse');
        }, 4000);
      }
    }

    // رسالة ترحيب مخصصة
    showWelcomeMessage(playerName) {
      this.showToast(
        `🎮 مرحباً ${playerName}!`,
        'استعد لتحدي مثير ومليء بالمفاجآت!\nأظهر مهاراتك وحقق أفضل النتائج',
        'info',
        5000
      );
      this.playSound('startapp.mp3', 0.6);
      setTimeout(() => {
        this.speakRandomHint();
      }, 2000);
    }

    // تنظيف الموارد
    destroy() {
      this.stopMotivationalCycle();
      
      // إزالة جميع التوستات
      document.querySelectorAll('.toast').forEach(toast => {
        toast.remove();
      });
      
      // إيقاف التحدث
      if (window.speechSynthesis) {
        speechSynthesis.cancel();
      }
      
      console.log(`🎮 تم تنظيف موارد ChallengeEnhancer للنشاط: ${this.name}`);
    }
  }

  // ==== تهيئة النشاط مع ChallengeEnhancer المدمج ====
  const activityName = 'نشاط التحديات';
  const soundsPath = '../assets/media/sounds/';
  
  // تهيئة نظام تعزيز التحديات المدمج
  const challengeEnhancer = new ChallengeEnhancer(activityName);
  
  // كائن النشاط المحلي المحسن مع ChallengeEnhancer
  const activity = {
    name: activityName,
    soundEnabled: true,
    soundsPath: soundsPath,
    enhancer: challengeEnhancer,
    
    init() {
      console.log(`🎯 تهيئة ${this.name}...`);
      
      // بدء تحميل بيانات الطلاب فوراً
      this.loadStudentData().catch(error => {
        console.error('❌ خطأ في تحميل البيانات:', error);
        // إخفاء شاشة التحميل في حالة الخطأ
        setTimeout(() => {
          hideLoadingIndicator();
        }, 2000);
      });
      
      // تهيئة النشاط الأساسي
      try {
        if (typeof ActivityUtils !== 'undefined') {
          ActivityUtils.init(this.name);
        }
      } catch (error) {
        console.warn('تحذير: لم يتم العثور على ActivityUtils، النشاط سيعمل بالوضع المستقل');
      }
      
      // تفعيل الميزات المحسنة
      this.enhancer.attachHoverSound('.btn, button, .challenge-card, .clickable');
      this.enhancer.startMotivationalCycle(30000); // كل 30 ثانية
      
      // رسالة ترحيب بعد تحميل البيانات
      setTimeout(() => {
        this.enhancer.showToast(
          '🎮 أهلاً وسهلاً!',
          'استعد لتحديات مثيرة ومليئة بالمرح والتعلم!',
          'info',
          5000
        );
        this.enhancer.playSound('startapp.mp3');
      }, 1000);
      
      // تتبع تفاعل المستخدم
      document.addEventListener('click', () => {
        this.enhancer.trackUserInteraction();
      });
      
      document.addEventListener('keydown', () => {
        this.enhancer.trackUserInteraction();
      });
    },
    
    // تحميل بيانات الطلاب
    async loadStudentData() {
      console.log('📚 بدء تحميل بيانات الطلاب...');
      
      // استدعاء وظيفة التحميل الموجودة
      try {
        await loadStudents();
        console.log('✅ تم تحميل بيانات الطلاب بنجاح');
      } catch (error) {
        console.error('❌ خطأ في تحميل بيانات الطلاب:', error);
        // في حالة الفشل، إخفاء شاشة التحميل
        setTimeout(() => {
          hideLoadingIndicator();
          this.enhancer.showToast(
            '⚠️ تحذير',
            'فشل في تحميل بيانات الطلاب. سيتم استخدام البيانات الاحتياطية.',
            'warning'
          );
        }, 1000);
      }
    },
    
    playSound(filename, volume = 0.7) {
      // استخدام النظام المحسن للأصوات
      this.enhancer.playSound(filename, volume);
    },
    
    // إضافة تعليق محفز للاعب
    motivatePlayer(playerName, score) {
      this.enhancer.checkMilestones(score, playerName);
    },
    
    // احتفال بالفوز مع تأثيرات
    celebrateWin(playerName) {
      this.enhancer.celebrateWin(playerName);
    },
    
    // إظهار إشعار مخصص
    showNotification(title, message, type = 'info') {
      this.enhancer.showToast(title, message, type);
    },
    
    // تنظيف الموارد
    cleanup() {
      this.enhancer.destroy();
    }
  };
  
  // ==== نظام الأصوات المتقدم والذكي ====
  const challengeSounds = {
    start: '../assets/media/sounds/start-timer.mp3',
    win: '../assets/media/sounds/win.mp3',
    winBlockbusters: '../assets/media/sounds/win-Blockbusters.mp3',
    celebration: '../assets/media/sounds/clap.mp3',
    timeUp: '../assets/media/sounds/long-beep.mp3',
    countdown: '../assets/media/sounds/countdown-beep.mp3',
    click: '../assets/media/sounds/Click.mp3',
    select: '../assets/media/sounds/select.mp3',
    reveal: '../assets/media/sounds/reveal.mp3',
    vs: '../assets/media/sounds/vs.mp3',
    draw: '../assets/media/sounds/draw.mp3',
    end: '../assets/media/sounds/end-timer.mp3',
    nameStart: '../assets/media/sounds/name-start.mp3',
    nameStop: '../assets/media/sounds/name-stop.mp3'
  };
  
  // تشغيل تسلسل أصوات الفوز المحسن
  function playWinSoundSequence(playerName = 'الفائز') {
    if (!activity.soundEnabled) return;
    
    console.log('🎵 بدء تسلسل أصوات الفوز المحسن...');
    
    // استخدام نظام ChallengeEnhancer للاحتفال الكامل
    activity.celebrateWin(playerName);
    
    // تأثيرات إضافية مخصصة للتحديات
    setTimeout(() => {
      activity.playSound('win-Blockbusters.mp3');
      activity.enhancer.showToast(
        '🏆 إنجاز رائع!', 
        `${playerName} أثبت مهاراته في التحدي!`, 
        'success', 
        6000
      );
    }, 1500);
    
    // تشغيل صوت التصفيق مع تعليق صوتي
    setTimeout(() => {
      activity.playSound('clap.mp3');
      activity.enhancer.speakRandomHint();
    }, 3000);
    
    // إضافة تأثيرات بصرية متزامنة محسنة
    showCelebrationEffectsEnhanced(playerName);
  }
  
  // تأثيرات الاحتفال المرئية المحسنة مع ChallengeEnhancer
  function showCelebrationEffectsEnhanced(playerName = 'الفائز') {
    const fireworks = document.getElementById('fireworks');
    if (fireworks) {
      fireworks.style.display = 'block';
    }
    
    // تفعيل انفجار الاحتفال المخصص من ChallengeEnhancer
    activity.enhancer.createCelebrationBurst();
    
    // كونفيتي متقدم متعدد المراحل
    if (window.confetti) {
      // انفجار مركزي مطور
      confetti({ 
        particleCount: 150, 
        spread: 90, 
        origin: { y: 0.6 },
        colors: ['#DC143C', '#228B22', '#FFD700', '#4169E1', '#8A2BE2', '#FF6B6B', '#4ECDC4']
      });
      
      // انفجارات جانبية متطورة
      setTimeout(() => {
        confetti({ 
          particleCount: 80, 
          spread: 140, 
          origin: { x: 0.1, y: 0.7 },
          colors: ['#FF6347', '#32CD32', '#FFD700', '#87CEEB']
        });
        confetti({ 
          particleCount: 80, 
          spread: 140, 
          origin: { x: 0.9, y: 0.7 },
          colors: ['#DDA0DD', '#98FB98', '#F0E68C', '#FFA07A']
        });
      }, 800);
      
      // انفجار نهائي من الأعلى
      setTimeout(() => {
        confetti({ 
          particleCount: 200, 
          spread: 160, 
          origin: { y: 0.1 },
          colors: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD']
        });
      }, 1500);
    }
    
    // تأثير النجوم المتساقطة المحسن
    createFallingStarsEnhanced();
    
    // إضافة تأثير الشاشة المهتزة
    document.body.style.animation = 'shake 0.5s ease-in-out 2';
    
    // إزالة التأثيرات بعد فترة
    setTimeout(() => {
      if (fireworks) {
        fireworks.style.display = 'none';
      }
      document.body.style.animation = '';
    }, 5000);
  }
  
  // النسخة المحسنة من الدالة الأصلية للتوافق
  function showCelebrationEffects() {
    showCelebrationEffectsEnhanced();
  }
  
  // نجوم متساقطة محسنة
  function createFallingStarsEnhanced() {
    for (let i = 0; i < 15; i++) {
      setTimeout(() => {
        const star = document.createElement('div');
        const starTypes = ['⭐', '🌟', '✨', '💫', '🎇'];
        star.innerHTML = starTypes[Math.floor(Math.random() * starTypes.length)];
        star.style.cssText = `
          position: fixed;
          font-size: ${Math.random() * 1.5 + 1.5}rem;
          left: ${Math.random() * 100}%;
          top: -50px;
          z-index: 10000;
          pointer-events: none;
          animation: fallingStar 3s linear forwards;
        `;
        
        document.body.appendChild(star);
        
        setTimeout(() => {
          if (star.parentNode) {
            star.remove();
          }
        }, 3000);
      }, i * 200);
    }
  }
  
  // النسخة الأصلية للتوافق
  function createFallingStars() {
    createFallingStarsEnhanced();
  }

  // تحكم صوتي ذكي محسن
  function playSmartSound(soundKey, options = {}) {
    const { volume = 0.7, delay = 0, loop = false } = options;
    
    setTimeout(() => {
      const soundPath = challengeSounds[soundKey];
      if (soundPath && activity.soundEnabled) {
        // استخدام النظام المحسن
        activity.enhancer.playSound(soundPath.split('/').pop(), volume);
      }
    }, delay);
  }
  
// ==== متغيرات النشاط ====
let studentData = {}, currentList = [], timer, timeLeft = 0;
let currentTurn = 1, usedStudents = [];
let teamScores = {};
let challengeStats = {
  totalChallenges: 0,
  completedChallenges: 0,
  teamWins: {},
  averageTime: 0,
  bestStreak: 0,
  currentStreak: 0,
  sessionStart: Date.now(),
  dailyStats: {},
  favoriteMode: '',
  totalPlayTime: 0
};

// ==== نظام حفظ التقدم المتقدم ====
function saveProgress() {
  try {
    const progressData = {
      stats: challengeStats,
      lastPlayed: Date.now(),
      version: '2.0'
    };
    localStorage.setItem('challengesProgress', JSON.stringify(progressData));
    console.log('💾 تم حفظ التقدم بنجاح');
  } catch (error) {
    console.warn('⚠️ فشل في حفظ التقدم:', error);
  }
}

function loadProgress() {
  try {
    const saved = localStorage.getItem('challengesProgress');
    if (saved) {
      const progressData = JSON.parse(saved);
      challengeStats = { ...challengeStats, ...progressData.stats };
      
      // تحديث الإحصائيات اليومية
      const today = new Date().toDateString();
      if (!challengeStats.dailyStats[today]) {
        challengeStats.dailyStats[today] = {
          challenges: 0,
          timeSpent: 0,
          wins: {}
        };
      }
      
      console.log('📊 تم تحميل التقدم المحفوظ');
      return true;
    }
  } catch (error) {
    console.warn('⚠️ خطأ في تحميل التقدم:', error);
  }
  return false;
}

// ==== نظام تتبع الأداء الذكي ====
function updatePerformanceStats(winner, timeSpent, mode) {
  const today = new Date().toDateString();
  
  // تحديث الإحصائيات العامة
  challengeStats.totalChallenges++;
  challengeStats.completedChallenges++;
  challengeStats.totalPlayTime += timeSpent;
  challengeStats.averageTime = challengeStats.totalPlayTime / challengeStats.completedChallenges;
  
  // تحديث إحصائيات الفوز
  if (winner) {
    challengeStats.teamWins[winner] = (challengeStats.teamWins[winner] || 0) + 1;
    challengeStats.currentStreak++;
    challengeStats.bestStreak = Math.max(challengeStats.bestStreak, challengeStats.currentStreak);
  } else {
    challengeStats.currentStreak = 0;
  }
  
  // تحديث النمط المفضل
  const modes = JSON.parse(localStorage.getItem('challengesModes') || '{}');
  modes[mode] = (modes[mode] || 0) + 1;
  localStorage.setItem('challengesModes', JSON.stringify(modes));
  
  const favoriteMode = Object.keys(modes).reduce((a, b) => modes[a] > modes[b] ? a : b);
  challengeStats.favoriteMode = favoriteMode;
  
  // تحديث الإحصائيات اليومية
  if (!challengeStats.dailyStats[today]) {
    challengeStats.dailyStats[today] = { challenges: 0, timeSpent: 0, wins: {} };
  }
  
  challengeStats.dailyStats[today].challenges++;
  challengeStats.dailyStats[today].timeSpent += timeSpent;
  
  if (winner) {
    challengeStats.dailyStats[today].wins[winner] = (challengeStats.dailyStats[today].wins[winner] || 0) + 1;
  }
  
  // حفظ التقدم
  saveProgress();
  
  // إشعار تحفيزي
  if (challengeStats.currentStreak > 0 && challengeStats.currentStreak % 5 === 0) {
    showAdvancedNotification(
      '🔥 إنجاز رائع!',
      `سلسلة انتصارات ${challengeStats.currentStreak} متتالية!`,
      'celebration',
      5000
    );
  }
}

// ==== وظائف مؤشر التحميل ====
function showLoadingIndicator(message = 'يرجى الانتظار...') {
  const indicator = document.getElementById('loadingIndicator');
  const text = document.getElementById('loadingText');
  if (indicator) {
    indicator.classList.remove('hidden');
    if (text) text.textContent = message;
  }
}

function hideLoadingIndicator() {
  const indicator = document.getElementById('loadingIndicator');
  if (indicator) {
    indicator.classList.add('hidden');
  }
}

function updateLoadingProgress(message) {
  const text = document.getElementById('loadingText');
  if (text) text.textContent = message;
}

// ==== تحميل بيانات الطلاب المحسن والذكي ====
async function loadStudents() {
    // عرض مؤشر التحميل
    showLoadingIndicator('📚 جاري تحميل بيانات الطلاب...');
    updateLoadingProgress('محاولة الاتصال بقاعدة البيانات...');
    
    // إعداد timeout للتحميل السريع (5 ثواني)
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('انتهت مهلة التحميل')), 5000)
    );
    
    try {
      console.log('🔄 بدء تحميل بيانات الطلاب...');
      updateLoadingProgress('جاري التحميل من الخادم المحلي...');
      
      // محاولة التحميل مع timeout
      const response = await Promise.race([
        fetch('../data/studentData.json', {
          method: 'GET',
          cache: 'no-cache',
          headers: {
            'Content-Type': 'application/json',
          }
        }),
        timeoutPromise
      ]);
      
      if (!response.ok) {
        throw new Error(`خطأ HTTP: ${response.status}`);
      }
      
      updateLoadingProgress('معالجة البيانات...');
      const data = await response.json();
      
      if (!data || typeof data !== 'object') {
        throw new Error('تنسيق البيانات غير صحيح');
      }
      
      // تعيين البيانات
      studentData = data;
      
      updateLoadingProgress('تحديث الواجهة...');
      
      // تحديث واجهة الصفوف
      populateClassSelect();
      setupEventListeners();
      
      const classCount = Object.keys(studentData).length;
      const totalStudents = Object.values(studentData).reduce((sum, students) => sum + students.length, 0);
      
      console.log(`✅ تم تحميل ${totalStudents} طالب من ${classCount} صف`);
      
      updateLoadingProgress('✅ تم التحميل بنجاح!');
      
      // إخفاء مؤشر التحميل
      setTimeout(() => {
        hideLoadingIndicator();
        if (window.challengeEnhancer && typeof challengeEnhancer.showToast === 'function') {
          challengeEnhancer.showToast(
            '✅ تحميل ناجح!',
            `تم تحميل ${totalStudents} طالب من ${classCount} صف بنجاح`,
            'success',
            4000
          );
        }
      }, 1000);
      
    } catch (error) {
      console.warn('⚠️ فشل تحميل البيانات الأساسية، استخدام البيانات الاحتياطية:', error);
      
      updateLoadingProgress('تحميل البيانات الاحتياطية...');
      
      // بيانات احتياطية محسنة من studentData.json الفعلي
      studentData = {
        'خامس 1': [
          'أحمد بن ماجد بن محفوظ منصور السيابي',
          'ابراهيم بن خليل بن ابراهيم رحمت البلوشي',
          'العز بن طارق بن عبدالمجيد سعيد البلوشي',
          'المهلب بن فهد بن ناصر محمد البوسعيدي',
          'الياس بن عيسى بن خلفان سالم الجابري'
        ],
        'خامس 2': [
          'آدم بن محمد بن أحمد خليل الفارسي',
          'أنس بن أحمد بن محمد عبدالرحمن الزدجالي',
          'أنور محمد عارف البلوشي',
          'أوّاب بن ناصر بن مال الله حمدان العمري'
        ],
        'سادس 1': [
          'أحمد سالم الكندي',
          'فاطمة علي البلوشي',
          'محمد خالد الهنائي',
          'مريم سعيد الرواحي'
        ],
        'سادس 2': [
          'عبدالله أحمد المعمري',
          'خديجة محمد الزدجالي',
          'طلال سالم الشحي',
          'نورا علي البوسعيدي'
        ]
      };
      
      populateClassSelect();
      setupEventListeners();
      
      const classCount = Object.keys(studentData).length;
      const totalStudents = Object.values(studentData).reduce((sum, students) => sum + students.length, 0);
      
      updateLoadingProgress('⚠️ تم استخدام البيانات الاحتياطية');
      
      // إخفاء مؤشر التحميل
      setTimeout(() => {
        hideLoadingIndicator();
        if (window.challengeEnhancer && typeof challengeEnhancer.showToast === 'function') {
          challengeEnhancer.showToast(
            '⚠️ بيانات احتياطية',
            `تم استخدام البيانات الاحتياطية (${totalStudents} طالب من ${classCount} صف)`,
            'warning',
            4000
          );
        }
      }, 1000);
    }
  }
  
  // تحديث قائمة الصفوف
  function populateClassSelect() {
    const classSelect = document.getElementById('classSelect');
    classSelect.innerHTML = '<option value="">اختر الصف</option>';
    
    Object.keys(studentData).forEach(cls => {
      const option = document.createElement('option');
      option.value = cls;
      option.textContent = `الصف ${cls}`;
      classSelect.appendChild(option);
    });
    
    // تحديد أول صف افتراضياً
    if (classSelect.options.length > 1) {
      classSelect.selectedIndex = 1;
      populateStudentSelectors(classSelect.value);
    }
  }
  
  // إعداد مستمعي الأحداث
  function setupEventListeners() {
    const classSelect = document.getElementById('classSelect');
    
    classSelect.addEventListener('change', () => {
      populateStudentSelectors(classSelect.value);
      activity.playSound('Click.mp3');
    });

    // ربط أحداث الاختيار اليدوي
    document.getElementById('student1Select').addEventListener('change', () => {
      populateStudentSelectors(classSelect.value);
      activity.playSound('select.mp3');
    });

    document.getElementById('student2Select').addEventListener('change', () => {
      populateStudentSelectors(classSelect.value);
      activity.playSound('select.mp3');
    });
  }

  // ==== نظام الإشعارات المتقدم والذكي ====
  function showAdvancedNotification(title, message, type = 'info', duration = 4000) {
    const notification = document.createElement('div');
    notification.className = `advanced-notification ${type}`;
    
    const icons = {
      success: '✅',
      warning: '⚠️',
      error: '❌',
      info: 'ℹ️',
      challenge: '🔥',
      timer: '⏰',
      trophy: '🏆',
      loading: '🔄',
      celebration: '🎉'
    };
    
    notification.innerHTML = `
      <div class="notification-header">
        <span class="notification-icon">${icons[type] || 'ℹ️'}</span>
        <span class="notification-title">${title}</span>
        <button class="notification-close" onclick="this.closest('.advanced-notification').remove()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="notification-message">${message}</div>
      <div class="notification-progress"></div>
    `;
    
    // إضافة الإشعار للحاوية
    const container = document.getElementById('notification-container') || document.body;
    container.appendChild(notification);
    
    // تأثير الظهور
    setTimeout(() => notification.classList.add('show'), 100);
    
    // شريط التقدم
    const progressBar = notification.querySelector('.notification-progress');
    progressBar.style.animation = `progress ${duration}ms linear`;
    
    // إزالة الإشعار تلقائياً
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, duration);
    
    // تشغيل صوت مناسب
    activity.playSound('reveal.mp3');
    
    return notification;
  }

  // إشعار عائم للنصائح
  function showFloatingTip(message, element) {
    const tip = document.createElement('div');
    tip.className = 'floating-tip';
    tip.innerHTML = `
      <div class="tip-content">
        <i class="fas fa-lightbulb"></i>
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(tip);
    
    // موقع الإشعار
    const rect = element.getBoundingClientRect();
    tip.style.left = rect.left + 'px';
    tip.style.top = (rect.top - 60) + 'px';
    
    setTimeout(() => tip.classList.add('show'), 100);
    
    setTimeout(() => {
      tip.classList.remove('show');
      setTimeout(() => {
        if (tip.parentNode) tip.parentNode.removeChild(tip);
      }, 300);
    }, 3000);
  }

  // نظام نصائح ذكية
  function showGameTips() {
    const tips = [
      '💡 استخدم الفرق المتعددة للأنشطة الكبيرة',
      '⚡ اضبط الوقت حسب صعوبة الأسئلة',
      '🎯 راقب الإحصائيات لتحسين الأداء',
      '🔥 شجع التنافس الإيجابي بين الطلاب',
      '📊 استخدم دليل المعلم للحصول على نصائح',
      '🎮 جرب أنماط مختلفة لتنويع التجربة'
    ];
    
    const randomTip = tips[Math.floor(Math.random() * tips.length)];
    
    setTimeout(() => {
      showAdvancedNotification(
        '💡 نصيحة ذكية',
        randomTip,
        'info',
        6000
      );
    }, Math.random() * 10000 + 15000); // بين 15-25 ثانية
  }

  // ==== نظام المؤقت المحسن ====
  function updateTimer() {
    const secText = document.getElementById('timerTextSec');
    const circle = document.getElementById('progress');
    const wrapper = document.getElementById('timerWrapper');

    const total = parseInt(document.getElementById('duration').value);
    const percent = timeLeft / total;
    const offset = 314 * (1 - percent);

    circle.style.strokeDashoffset = offset;
    
    // تحسين عرض الوقت
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const timeDisplay = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${timeLeft}s`;
    
    secText.innerHTML = `<i class="fas fa-clock"></i><br>${timeDisplay}`;

    // تأثيرات التحذير المحسنة مع أصوات Kingdom
    if (timeLeft <= 10 && timeLeft > 0) {
      wrapper.classList.add('shake');
      circle.style.stroke = '#ff4444'; // أحمر للتحذير
      secText.style.color = '#ff4444';
      
      // أصوات تحذيرية مخصصة
      if (timeLeft <= 3) {
        // العد التنازلي النهائي
        activity.enhancer.playKingdomSound('final-countdown.mp3', 0.8);
        secText.style.animation = 'pulse 0.3s infinite';
        secText.style.fontSize = '1.4rem';
        secText.style.fontWeight = 'bold';
      } else if (timeLeft <= 5) {
        // تحذير شديد
        activity.enhancer.playKingdomSound('time-warning.mp3', 0.7);
        secText.style.animation = 'pulse 0.5s infinite';
        secText.style.fontSize = '1.3rem';
      } else {
        // تحذير عادي
        activity.enhancer.playKingdomSound('countdown-tick.mp3', 0.6);
        secText.style.animation = 'pulse 0.8s infinite';
      }
    } else if (timeLeft <= 30) {
      circle.style.stroke = '#ff8800'; // برتقالي للتنبيه
      secText.style.color = '#ff8800';
      wrapper.classList.remove('shake');
      secText.style.animation = 'none';
      secText.style.fontSize = '1.2rem';
      secText.style.fontWeight = 'normal';
      
      // صوت تنبيه خفيف كل 10 ثواني
      if (timeLeft % 10 === 0) {
        activity.enhancer.playKingdomSound('time-warp.mp3', 0.4);
      }
    } else {
      circle.style.stroke = 'var(--accent-color)';
      secText.style.color = 'var(--accent-color)';
      wrapper.classList.remove('shake');
      secText.style.animation = 'none';
      secText.style.fontSize = '1.2rem';
      secText.style.fontWeight = 'normal';
    }
  }
  function populateStudentSelectors(cls) {
    const s1 = document.getElementById('student1Select');
    const s2 = document.getElementById('student2Select');
    const students = studentData[cls] || [];
    const selected1 = s1.value;
    const selected2 = s2.value;

    s1.innerHTML = '<option value="">اختر الطالب الأول</option>';
    s2.innerHTML = '<option value="">اختر الطالب الثاني</option>';

    students.forEach(stu => {
      if (stu !== selected2) {
        const opt1 = document.createElement('option');
        opt1.value = stu;
        opt1.textContent = stu;
        s1.appendChild(opt1);
      }
      if (stu !== selected1) {
        const opt2 = document.createElement('option');
        opt2.value = stu;
        opt2.textContent = stu;
        s2.appendChild(opt2);
      }
    });

    if (selected1 && [...s1.options].some(o => o.value === selected1)) s1.value = selected1;
    if (selected2 && [...s2.options].some(o => o.value === selected2)) s2.value = selected2;
  }

  // التعامل مع تغيير نمط التحدي
  function handleModeChange() {
    const mode = document.getElementById('mode').value;
    
    activity.playSound('Click.mp3');
    
    const manualSelection = document.getElementById('manualSelection');
    const multiTeamOptions = document.getElementById('multiTeamOptions');
    
    manualSelection.style.display = (mode === 'manual') ? 'block' : 'none';
    multiTeamOptions.style.display = (mode === 'multiTeams') ? 'block' : 'none';

    if (mode === 'manual') {
      const currentClass = document.getElementById('classSelect').value;
      if (currentClass) {
        populateStudentSelectors(currentClass);
        activity.showNotification('اختر الطالبين للتحدي', 'info');
      }
    }
  }

  // عرض نافذة التعليمات
  function showInstructionModal(mode) {
    const modal = document.getElementById('instructionModal');
    const text = document.getElementById('instructionText');
    let instructions = '';

    switch (mode) {
      case 'random':
        instructions = 'سيتم اختيار طالبين بشكل عشوائي للتحدي. كل طالب له دور وزمن محدد. المعلم يسجل النقاط يدوياً باستخدام أزرار + و -.';
        break;
      case 'manual':
        instructions = 'يمكن اختيار الطالبين يدوياً من القائمة. كل طالب له وقت محدد للأداء. يتم تسجيل النقاط يدوياً.';
        break;
      case 'teams':
        instructions = 'يتم التحدي بين فريقين. كل فريق يمكنه كسب أو خسارة نقاط. الهدف هو التفاعل الجماعي والتنافس الإيجابي.';
        break;
      case 'multiTeams':
        instructions = 'سيتم إنشاء عدة فرق (من 3 إلى 8) حسب اختيارك. كل فريق له دوره ونقاطه الخاصة. مثالي للأنشطة الجماعية الكبيرة.';
        break;
    }

    text.textContent = instructions;
    modal.style.display = 'flex';
    activity.playSound('name-start.mp3');
  }

  // إغلاق نافذة التعليمات
  function closeInstructionModal() {
    document.getElementById('instructionModal').style.display = 'none';
    prepareChallengeContinue();
  }

  // بدء التحدي المحسن مع ChallengeEnhancer
  function prepareChallenge() {
    const cls = document.getElementById('classSelect').value;
    const mode = document.getElementById('mode').value;

    if (!cls) {
      activity.enhancer.showToast(
        '⚠️ تنبيه', 
        'يرجى اختيار الصف أولاً قبل البدء!', 
        'warning'
      );
      activity.enhancer.playSound('ancient-bell.mp3', 0.5, true);
      return;
    }

    if (!mode) {
      activity.enhancer.showToast(
        '⚠️ تنبيه', 
        'يرجى اختيار نوع التحدي المناسب!', 
        'warning'
      );
      activity.enhancer.playSound('ancient-bell.mp3', 0.5, true);
      return;
    }

    // تشغيل أصوات وتأثيرات البداية مع Kingdom Sounds
    activity.enhancer.playKingdomSound('epic-charge.mp3', 0.8);
    activity.enhancer.showToast(
      '🚀 جاري التحضير!', 
      'استعدوا للتحدي المثير... القوة في الاستعداد!', 
      'info',
      3000
    );
    
    // إضافة تأثير النبض للأزرار النشطة
    activity.enhancer.addMotivationalPulse('#challengeControls');
    
    // صوت إضافي للترقب
    setTimeout(() => {
      activity.enhancer.playKingdomSound('war-drum.mp3', 0.4);
    }, 1000);
    
    showInstructionModal(mode);
  }

  // متابعة تحضير التحدي بعد التعليمات مع التحسينات
  function prepareChallengeContinue() {
    const cls = document.getElementById('classSelect').value;
    const mode = document.getElementById('mode').value;
    timeLeft = parseInt(document.getElementById('duration').value);
    currentList = [...(studentData[cls] || [])];

    // رسالة تشجيعية لبداية التحدي
    activity.enhancer.showToast(
      '⚡ انطلاق التحدي!', 
      `بدأ تحدي ${mode} لمدة ${timeLeft} ثانية!`, 
      'success',
      4000
    );
    
    activity.enhancer.playSound('battle-horn.mp3', 0.7, true);

    if (mode === 'multiTeams') {
      activity.enhancer.showToast(
        '👥 وضع الفرق المتعددة', 
        'استعدوا للمنافسة الجماعية!', 
        'info'
      );
      setupMultiTeams();
      return;
    }

    if (currentList.length < 2) {
      activity.showModal('خطأ', 'يجب اختيار صف به طلاب كافيين', false);
      return;
    }

    let name1 = 'فريق 1', name2 = 'فريق 2';

    if (mode === 'random') {
      const remaining = currentList.filter(s => !usedStudents.includes(s));
      if (remaining.length < 2) {
        activity.showModal('تنبيه', 'تم استخدام جميع الطلاب. سيتم إعادة تعيين القائمة.', false);
        usedStudents = [];
        const shuffled = [...currentList].sort(() => 0.5 - Math.random());
        name1 = shuffled[0];
        name2 = shuffled[1];
      } else {
        const shuffled = [...remaining].sort(() => 0.5 - Math.random());
        name1 = shuffled[0];
        name2 = shuffled[1];
      }
      usedStudents.push(name1, name2);
    } else if (mode === 'manual') {
      name1 = document.getElementById('student1Select').value;
      name2 = document.getElementById('student2Select').value;
      if (!name1 || !name2) {
        activity.showModal('تنبيه', 'يرجى اختيار الطالبين', false);
        return;
      }
      if (name1 === name2) {
        activity.showModal('تنبيه', 'يرجى اختيار طالبين مختلفين', false);
        return;
      }
    }

    setupTwoPlayerChallenge(name1, name2);
  }

  // ==== إعداد تحدي محسن بين لاعبين ====
  function setupTwoPlayerChallenge(name1, name2) {
    const container = document.getElementById('teamsContainer');
    
    // إضافة تأثير انتقالي
    container.style.opacity = '0';
    container.style.transform = 'translateY(20px)';
    
    container.innerHTML = `
      <div class="team-card" data-team="1">
        <div class="team-avatar">
          <i class="fas fa-user-graduate"></i>
        </div>
        <h3 id="name1"><i class="fas fa-star"></i> ${name1}</h3>
        <div class="team-score" id="score1">0</div>
        <div class="score-controls">
          <button class="score-btn plus" onclick="adjustScore(1, 1)" title="إضافة نقطة">
            <i class="fas fa-plus"></i>
          </button>
          <button class="score-btn minus" onclick="adjustScore(1, -1)" title="خصم نقطة">
            <i class="fas fa-minus"></i>
          </button>
        </div>
        <div class="team-status" id="status1">جاهز للتحدي</div>
      </div>
      <div class="vs-divider">
        <div class="vs-circle">
          <i class="fas fa-bolt"></i>
          <span>VS</span>
        </div>
      </div>
      <div class="team-card" data-team="2">
        <div class="team-avatar">
          <i class="fas fa-user-graduate"></i>
        </div>
        <h3 id="name2"><i class="fas fa-star"></i> ${name2}</h3>
        <div class="team-score" id="score2">0</div>
        <div class="score-controls">
          <button class="score-btn plus" onclick="adjustScore(2, 1)" title="إضافة نقطة">
            <i class="fas fa-plus"></i>
          </button>
          <button class="score-btn minus" onclick="adjustScore(2, -1)" title="خصم نقطة">
            <i class="fas fa-minus"></i>
          </button>
        </div>
        <div class="team-status" id="status2">جاهز للتحدي</div>
      </div>
    `;

    // تأثير الظهور
    setTimeout(() => {
      container.style.transition = 'all 0.5s ease';
      container.style.opacity = '1';
      container.style.transform = 'translateY(0)';
    }, 100);

    teamScores = { '1': 0, '2': 0 };
    currentTurn = 1;

    document.getElementById('challengeArea').style.display = 'block';
    document.getElementById('winnerDisplay').style.display = 'none';
    
    showAdvancedNotification(
      '🔥 بدء التحدي!',
      `المواجهة بين ${name1} و ${name2}`,
      'challenge',
      3000
    );
    
    // تأخير قصير ثم بدء الدور الأول
    setTimeout(() => {
      nextTurn();
    }, 1500);
  }

  // ==== إعداد الفرق المتعددة المحسن ====
  function setupMultiTeams() {
    const teamCount = parseInt(document.getElementById('teamCountSelect').value);
    const container = document.getElementById('teamsContainer');
    
    // تأثير انتقالي
    container.style.opacity = '0';
    container.innerHTML = '';

    teamScores = {};
    const teamColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe'];

    for (let i = 1; i <= teamCount; i++) {
      const div = document.createElement('div');
      div.className = 'team-card multi-team';
      div.style.borderColor = teamColors[i - 1] || '#007bff';
      
      div.innerHTML = `
        <div class="team-avatar" style="background: ${teamColors[i - 1] || '#007bff'}">
          <i class="fas fa-users"></i>
        </div>
        <h3 id="name${i}"><i class="fas fa-flag"></i> فريق ${i}</h3>
        <div class="team-score" id="score${i}">0</div>
        <div class="score-controls">
          <button class="score-btn plus" onclick="adjustScore(${i}, 1)" title="إضافة نقطة">
            <i class="fas fa-plus"></i>
          </button>
          <button class="score-btn minus" onclick="adjustScore(${i}, -1)" title="خصم نقطة">
            <i class="fas fa-minus"></i>
          </button>
        </div>
        <div class="team-status" id="status${i}">في الانتظار</div>
      `;
      
      container.appendChild(div);
      teamScores[i.toString()] = 0;
    }

    // تأثير الظهور المتسلسل
    setTimeout(() => {
      container.style.transition = 'all 0.5s ease';
      container.style.opacity = '1';
    }, 100);

    currentTurn = 1;
    document.getElementById('challengeArea').style.display = 'block';
    document.getElementById('winnerDisplay').style.display = 'none';
    
    showAdvancedNotification(
      '🏆 فرق متعددة جاهزة!',
      `تم إنشاء ${teamCount} فرق للتحدي الكبير`,
      'success',
      3000
    );
    
    setTimeout(() => {
      nextTurn();
    }, 1500);
  }

  // تحديث المؤقت
  function updateTimer() {
    const secText = document.getElementById('timerTextSec');
    const circle = document.getElementById('progress');
    const wrapper = document.getElementById('timerWrapper');

    const total = parseInt(document.getElementById('duration').value);
    const percent = timeLeft / total;
    const offset = 314 * (1 - percent);

    circle.style.strokeDashoffset = offset;
    secText.innerHTML = `<i class="fas fa-clock"></i><br>${timeLeft}s`;

    if (timeLeft <= 10 && timeLeft > 0) {
      wrapper.classList.add('shake');
      activity.playSound('countdown-beep.mp3');
    } else {
      wrapper.classList.remove('shake');
    }
  }

  // بدء المؤقت مع أصوات Kingdom محسنة
  function startTimer() {
    // صوت بداية قوي ومحفز
    activity.enhancer.playKingdomSound('timer-start.mp3', 0.8);
    
    updateTimer();
    timer = setInterval(() => {
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0) {
        clearInterval(timer);
        // صوت نهاية بسيط ومناسب
        activity.enhancer.playKingdomSound('ancient-bell.mp3', 0.6);
        showTimeUpPopup();
      }
    }, 1000);
  }

  // عرض نافذة انتهاء الوقت مع تأثيرات مناسبة
  function showTimeUpPopup() {
    const popup = document.getElementById('timeUpPopup');
    popup.style.display = 'block';
    
    // تأثير اهتزاز خفيف للشاشة
    document.body.style.animation = 'shake 0.3s ease-in-out 1';
    
    setTimeout(() => {
      popup.style.display = 'none';
      document.body.style.animation = 'none';
      nextTurn();
    }, 1500); // تقليل المدة
  }

  // ==== الدور التالي المحسن مع ChallengeEnhancer ====
  function nextTurn() {
    activity.playSound('vs.mp3');
    clearInterval(timer);
    
    const mode = document.getElementById('mode').value;
    const turnLabel = document.getElementById('turnLabel');

    if (mode === 'multiTeams') {
      const count = parseInt(document.getElementById('teamCountSelect').value);
      const teamName = `فريق ${currentTurn}`;
      
      turnLabel.innerHTML = `<i class="fas fa-users"></i> الدور على: ${teamName}`;
      
      // تحديث حالة الفرق
      updateTeamTurnStatus(currentTurn, count);
      
      // إشعار محسن للدور الجديد
      activity.enhancer.showToast(
        '🔄 دور جديد!',
        `حان دور ${teamName} - أعطوا كل ما لديكم!`,
        'info',
        3000
      );
      activity.enhancer.playSound('notification-pop.mp3', 0.6, true);
      
      timeLeft = parseInt(document.getElementById('duration').value);
      startTimer();
      currentTurn = currentTurn >= count ? 1 : currentTurn + 1;
      return;
    }

    // للأنماط الأخرى (طالب ضد طالب) مع تحسينات
    const currentPlayerName = currentTurn === 1 ? 
      document.getElementById('name1').textContent : 
      document.getElementById('name2').textContent;
    
    const cleanName = currentPlayerName.replace('⭐ ', '');
    
    // رسالة تشجيعية للاعب القادم
    activity.enhancer.showToast(
      '🎯 دورك الآن!',
      `${cleanName} - أظهر مهاراتك!`,
      'warning',
      3000
    );
    activity.enhancer.playSound('brain-activate.mp3', 0.7, true);
    turnLabel.innerHTML = `<i class="fas fa-user-clock"></i> الدور على: ${cleanName}`;
    
    // تحديث حالة اللاعبين
    updatePlayerTurnStatus(currentTurn);
    
    showAdvancedNotification(
      '⚡ دورك الآن!',
      `حان دور ${cleanName}`,
      'timer',
      2000
    );
    
    timeLeft = parseInt(document.getElementById('duration').value);
    startTimer();
    currentTurn = currentTurn === 1 ? 2 : 1;
  }

  // تحديث حالة الفرق
  function updateTeamTurnStatus(activeTurn, totalTeams) {
    for (let i = 1; i <= totalTeams; i++) {
      const statusElement = document.getElementById(`status${i}`);
      const teamCard = document.querySelector(`[data-team="${i}"]`);
      
      if (statusElement) {
        if (i === activeTurn) {
          statusElement.textContent = '🎯 دوره الآن!';
          statusElement.style.background = 'rgba(255, 193, 7, 0.3)';
          statusElement.style.color = '#856404';
          if (teamCard) {
            teamCard.style.transform = 'scale(1.02)';
            teamCard.style.borderColor = '#ffc107';
            teamCard.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.4)';
          }
        } else {
          statusElement.textContent = 'في الانتظار...';
          statusElement.style.background = '#f8f9fa';
          statusElement.style.color = 'var(--text-secondary)';
          if (teamCard) {
            teamCard.style.transform = 'scale(1)';
            teamCard.style.borderColor = 'var(--primary-color)';
            teamCard.style.boxShadow = 'var(--shadow-medium)';
          }
        }
      }
    }
  }

  // تحديث حالة اللاعبين
  function updatePlayerTurnStatus(activeTurn) {
    for (let i = 1; i <= 2; i++) {
      const statusElement = document.getElementById(`status${i}`);
      const teamCard = document.querySelector(`[data-team="${i}"]`);
      
      if (statusElement) {
        if (i === activeTurn) {
          statusElement.textContent = '🎯 دوره الآن!';
          statusElement.style.background = 'rgba(255, 193, 7, 0.3)';
          statusElement.style.color = '#856404';
          if (teamCard) {
            teamCard.style.transform = 'scale(1.02)';
            teamCard.style.borderColor = '#ffc107';
            teamCard.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.4)';
          }
        } else {
          statusElement.textContent = 'في الانتظار...';
          statusElement.style.background = '#f8f9fa';
          statusElement.style.color = 'var(--text-secondary)';
          if (teamCard) {
            teamCard.style.transform = 'scale(1)';
            teamCard.style.borderColor = 'var(--primary-color)';
            teamCard.style.boxShadow = 'var(--shadow-medium)';
          }
        }
      }
    }
  }

  // ==== تعديل النقاط المحسن مع ChallengeEnhancer وأصوات Kingdom ====
  function adjustScore(team, val) {
    const scoreElement = document.getElementById(`score${team}`);
    const statusElement = document.getElementById(`status${team}`);
    const teamCard = document.querySelector(`[data-team="${team}"]`);
    const playerName = document.getElementById(`name${team}`)?.textContent?.replace('⭐ ', '') || `الفريق ${team}`;
    
    let score = parseInt(scoreElement.textContent) + val;
    score = Math.max(0, score); // منع النقاط السالبة
    
    const oldScore = parseInt(scoreElement.textContent);
    scoreElement.textContent = score;
    teamScores[team.toString()] = score;

    // تأثيرات وأصوات محسنة باستخدام Kingdom Sounds
    if (val > 0) {
      scoreElement.style.color = '#28a745';
      scoreElement.style.transform = 'scale(1.3)';
      if (statusElement) statusElement.textContent = '+' + val + ' نقطة!';
      
      // تحفيز اللاعب بناءً على النقاط الجديدة
      activity.motivatePlayer(playerName, score);
      
      // أصوات إيجابية من Kingdom مع منطق ذكي
      if (score >= 10) {
        activity.enhancer.playKingdomSound('perfect-score.mp3', 0.8);
      } else if (score >= 5) {
        activity.enhancer.playKingdomSound('crystal-bonus.mp3', 0.7);
      } else if (val >= 2) {
        activity.enhancer.playKingdomSound('bonus-collect.mp3', 0.6);
      } else {
        activity.enhancer.playKingdomSound('point-earn.mp3', 0.5);
      }
      
      // تأثير الجسيمات للنقاط الإيجابية
      createScoreParticles(scoreElement, '+' + val, '#28a745');
      
    } else if (val < 0) {
      scoreElement.style.color = '#dc3545';
      scoreElement.style.transform = 'scale(0.8)';
      if (statusElement) statusElement.textContent = val + ' نقطة';
      
      // رسالة تشجيعية عند خسارة النقاط
      activity.enhancer.showToast(
        '💪 لا تيأس!',
        `${playerName} - المحاولة القادمة ستكون أفضل!`,
        'warning',
        2500
      );
      
      // صوت تشجيعي بدلاً من محبط
      activity.enhancer.playKingdomSound('wisdom-chime.mp3', 0.4);
      
      // تأثير الاهتزاز للنقاط السالبة
      if (teamCard) {
        teamCard.classList.add('shake');
        setTimeout(() => teamCard.classList.remove('shake'), 500);
      }
    }

    // إعادة تعيين التأثيرات
    setTimeout(() => {
      scoreElement.style.color = 'var(--accent-color)';
      scoreElement.style.transform = 'scale(1)';
      if (statusElement) {
        statusElement.textContent = score > 5 ? 'أداء ممتاز!' : 
                                  score > 2 ? 'يتقدم بثبات' : 
                                  score > 0 ? 'بداية جيدة' : 'جاهز للبداية';
      }
    }, 1000);

    // تحديث الترتيب في الفرق المتعددة
    updateTeamRanking();
  }

  // إنشاء تأثير الجسيمات للنقاط
  function createScoreParticles(element, text, color) {
    const particle = document.createElement('div');
    particle.style.cssText = `
      position: absolute;
      color: ${color};
      font-weight: bold;
      font-size: 1.2rem;
      pointer-events: none;
      z-index: 1000;
      animation: scoreFloat 1s ease-out forwards;
    `;
    particle.textContent = text;
    
    const rect = element.getBoundingClientRect();
    particle.style.left = rect.left + 'px';
    particle.style.top = rect.top + 'px';
    
    document.body.appendChild(particle);
    
    setTimeout(() => {
      if (particle.parentNode) {
        particle.parentNode.removeChild(particle);
      }
    }, 1000);
  }

  // تحديث ترتيب الفرق
  function updateTeamRanking() {
    const teams = Object.keys(teamScores).map(team => ({
      id: team,
      score: teamScores[team],
      element: document.getElementById(`score${team}`)
    })).sort((a, b) => b.score - a.score);

    // تحديث المراكز
    teams.forEach((team, index) => {
      const statusElement = document.getElementById(`status${team.id}`);
      if (statusElement && teams.length > 2) {
        const position = index + 1;
        const positionText = position === 1 ? '🥇 المركز الأول' :
                           position === 2 ? '🥈 المركز الثاني' :
                           position === 3 ? '🥉 المركز الثالث' :
                           `📍 المركز ${position}`;
        statusElement.textContent = positionText;
      }
    });
  }

  // ==== نظام الإحصائيات ====
  function showStatsButton() {
    const winnerDisplay = document.getElementById('winnerDisplay');
    if (winnerDisplay && winnerDisplay.style.display === 'block') {
      const statsBtn = document.createElement('button');
      statsBtn.className = 'btn btn-info';
      statsBtn.style.marginTop = '1rem';
      statsBtn.innerHTML = '<i class="fas fa-chart-pie"></i> عرض الإحصائيات';
      statsBtn.onclick = showDetailedStats;
      winnerDisplay.appendChild(statsBtn);
    }
  }

  function showDetailedStats() {
    const modal = document.createElement('div');
    modal.className = 'instruction-modal';
    modal.style.display = 'flex';
    
    const totalGames = challengeStats.totalChallenges;
    const winData = Object.entries(challengeStats.teamWins)
      .map(([name, wins]) => ({ name, wins, percentage: Math.round((wins / totalGames) * 100) }))
      .sort((a, b) => b.wins - a.wins);
    
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <h2><i class="fas fa-chart-pie"></i> إحصائيات التحديات</h2>
        <div class="stats-container">
          <div class="stat-row">
            <span>إجمالي التحديات:</span>
            <span class="stat-value">${totalGames}</span>
          </div>
          <div class="stat-row">
            <span>التحديات المكتملة:</span>
            <span class="stat-value">${challengeStats.completedChallenges}</span>
          </div>
          ${winData.length > 0 ? `
            <h3><i class="fas fa-trophy"></i> سجل الانتصارات</h3>
            ${winData.map((player, index) => `
              <div class="winner-stat ${index === 0 ? 'top-winner' : ''}">
                ${index === 0 ? '🏆' : index === 1 ? '🥈' : index === 2 ? '🥉' : '📊'} 
                ${player.name}: ${player.wins} انتصار (${player.percentage}%)
              </div>
            `).join('')}
          ` : '<p>لا توجد إحصائيات انتصارات بعد</p>'}
        </div>
        <button onclick="this.closest('.instruction-modal').remove()" class="btn btn-primary">
          <i class="fas fa-check"></i> إغلاق
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
    activity.playSound('reveal.mp3');
  }

  // تحميل الإحصائيات المحفوظة
  function loadSavedStats() {
    try {
      const saved = localStorage.getItem('challengeStats');
      if (saved) {
        challengeStats = { ...challengeStats, ...JSON.parse(saved) };
      }
    } catch (error) {
      console.log('⚠️ خطأ في تحميل الإحصائيات:', error);
    }
  }

  // ==== إنهاء التحدي المحسن مع Kingdom Sounds ====
  function endChallenge() {
    clearInterval(timer);
    
    // صوت نهاية احتفالي
    activity.enhancer.playKingdomSound('battle-victory.mp3', 0.9);
    
    const mode = document.getElementById('mode').value;
    const winnerDisplay = document.getElementById('winnerDisplay');
    
    // تحديث الإحصائيات
    challengeStats.totalChallenges++;
    challengeStats.completedChallenges++;

    // إضافة تأثيرات احتفالية
    setTimeout(() => {
      activity.enhancer.playKingdomSound('royal-fanfare.mp3', 0.7);
      activity.enhancer.createCelebrationBurst();
    }, 500);

    if (mode === 'multiTeams') {
      const count = parseInt(document.getElementById('teamCountSelect').value);
      let maxScore = -1;
      let winners = [];
      let results = [];

      for (let i = 1; i <= count; i++) {
        const score = parseInt(document.getElementById(`score${i}`).textContent);
        results.push({ team: `فريق ${i}`, score: score });
        
        if (score > maxScore) {
          maxScore = score;
          winners = [`فريق ${i}`];
        } else if (score === maxScore) {
          winners.push(`فريق ${i}`);
        }
      }

      // ترتيب النتائج
      results.sort((a, b) => b.score - a.score);
      
      const isWin = winners.length === 1;
      const result = isWin ? 
        `<i class="fas fa-trophy"></i> الفائز: ${winners[0]} بـ ${maxScore} نقطة` : 
        `<i class="fas fa-handshake"></i> تعادل بين: ${winners.join(' و ')} بـ ${maxScore} نقطة`;
      
      winnerDisplay.innerHTML = `
        ${result}
        <div class="final-results">
          <h4><i class="fas fa-chart-bar"></i> النتائج النهائية:</h4>
          ${results.map((r, index) => 
            `<div class="result-item ${index === 0 ? 'winner' : ''}">
              ${index + 1}. ${r.team}: ${r.score} نقطة
            </div>`
          ).join('')}
        </div>
      `;
      
      // تحديث إحصائيات الفوز
      if (isWin) {
        challengeStats.teamWins[winners[0]] = (challengeStats.teamWins[winners[0]] || 0) + 1;
      }
      
      showAdvancedNotification(
        isWin ? '🏆 لدينا فائز!' : '🤝 تعادل مثير!',
        isWin ? `${winners[0]} يحصل على المركز الأول` : `تعادل رائع بين ${winners.length} فرق`,
        isWin ? 'trophy' : 'success',
        5000
      );
      
      playWinSoundSequence();
      
    } else {
      // للأنماط الأخرى (طالب ضد طالب)
      const name1 = document.getElementById('name1').textContent.replace('⭐ ', '');
      const name2 = document.getElementById('name2').textContent.replace('⭐ ', '');
      const score1 = parseInt(document.getElementById('score1').textContent);
      const score2 = parseInt(document.getElementById('score2').textContent);

      let result;
      let winnerName = '';
      
      if (score1 > score2) {
        result = `<i class="fas fa-trophy"></i> الفائز: ${name1} بـ ${score1} نقطة`;
        winnerName = name1;
        showAdvancedNotification('🏆 لدينا فائز!', `${name1} يفوز بالتحدي!`, 'trophy', 5000);
        playWinSoundSequence();
      } else if (score2 > score1) {
        result = `<i class="fas fa-trophy"></i> الفائز: ${name2} بـ ${score2} نقطة`;
        winnerName = name2;
        showAdvancedNotification('🏆 لدينا فائز!', `${name2} يفوز بالتحدي!`, 'trophy', 5000);
        playWinSoundSequence();
      } else {
        result = `<i class="fas fa-handshake"></i> تعادل! النتيجة ${score1} - ${score2}`;
        showAdvancedNotification('🤝 تعادل مثير!', 'مباراة متوازنة تماماً!', 'success', 5000);
        activity.playSound('draw.mp3');
      }

      winnerDisplay.innerHTML = `
        ${result}
        <div class="match-summary">
          <div class="score-breakdown">
            <div class="player-result ${score1 > score2 ? 'winner' : score1 === score2 ? 'tie' : 'loser'}">
              ${name1}: ${score1} نقطة
            </div>
            <div class="player-result ${score2 > score1 ? 'winner' : score1 === score2 ? 'tie' : 'loser'}">
              ${name2}: ${score2} نقطة
            </div>
          </div>
        </div>
      `;
      
      // تحديث إحصائيات الفوز
      if (winnerName) {
        challengeStats.teamWins[winnerName] = (challengeStats.teamWins[winnerName] || 0) + 1;
      }
    }

    winnerDisplay.style.display = 'block';
    
    // حفظ الإحصائيات
    localStorage.setItem('challengeStats', JSON.stringify(challengeStats));
    
    // عرض زر إحصائيات إضافي
    setTimeout(() => {
      showStatsButton();
    }, 2000);
  }

  // عرض الاحتفال
  function showCelebration(isWin) {
    if (isWin) {
      activity.playSound('win.mp3');
      setTimeout(() => activity.playSound('clap.mp3'), 1000);
    } else {
      activity.playSound('draw.mp3');
    }

    const fireworks = document.getElementById('fireworks');
    fireworks.style.display = 'block';
    
    // إضافة النجوم المتساقطة
    createFallingStars();
    
    // إضافة كونفيتي
    if (window.confetti) {
      confetti({ 
        particleCount: 200, 
        spread: 120, 
        origin: { y: 0.6 },
        colors: ['#DC143C', '#228B22', '#FFD700']
      });
    }

    setTimeout(() => {
      fireworks.style.display = 'none';
    }, 4000);
  }

  // ==== إعادة تعيين التحدي المحسن ====
  function resetChallenge() {
    activity.playSound('Click.mp3');
    
    // إيقاف المؤقت
    clearInterval(timer);
    
    // إخفاء المناطق
    document.getElementById('challengeArea').style.display = 'none';
    document.getElementById('winnerDisplay').style.display = 'none';
    
    // تنظيف الحاوية بتأثير انتقالي
    const container = document.getElementById('teamsContainer');
    container.style.opacity = '0';
    container.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
      container.innerHTML = '';
      container.style.opacity = '1';
      container.style.transform = 'translateY(0)';
    }, 300);
    
    // إعادة تعيين المتغيرات
    currentTurn = 1;
    teamScores = {};
    timeLeft = 0;
    usedStudents = [];
    
    // إعادة تعيين النماذج
    document.getElementById('classSelect').selectedIndex = 0;
    document.getElementById('mode').selectedIndex = 0;
    document.getElementById('duration').selectedIndex = 1; // 1 دقيقة افتراضياً
    
    // إخفاء خيارات الاختيار
    document.getElementById('manualSelection').style.display = 'none';
    document.getElementById('multiTeamOptions').style.display = 'none';
    
    showAdvancedNotification(
      '🔄 تم إعادة التعيين',
      'النشاط جاهز لتحدي جديد!',
      'info',
      3000
    );
    
    console.log('🔄 تم إعادة تعيين التحدي بنجاح');
  }

  // ==== تهيئة النشاط المحسنة ====
  window.onload = async () => {
    console.log('🔥 بدء تحميل نشاط التحديات المتقدم...');
    
    try {
      // تهيئة النشاط الأساسي (الذي سيبدأ تحميل البيانات)
      console.log('🎯 بدء تهيئة النشاط...');
      activity.init();
      console.log('✅ تم تهيئة النشاط الأساسي بنجاح');
      
      // تحميل الإحصائيات المحفوظة
      try {
        loadSavedStats();
        console.log('✅ تم تحميل الإحصائيات بنجاح');
      } catch (statsError) {
        console.warn('⚠️ خطأ في تحميل الإحصائيات:', statsError);
      }
      
    } catch (error) {
      console.error('❌ خطأ في تهيئة النشاط:', error);
      
      // إخفاء مؤشر التحميل
      setTimeout(() => {
        hideLoadingIndicator();
        if (window.challengeEnhancer && typeof challengeEnhancer.showToast === 'function') {
          challengeEnhancer.showToast(
            '❌ خطأ في التحميل',
            'حدث خطأ في تحميل النشاط. يرجى إعادة تحميل الصفحة.',
            'error'
          );
        }
      }, 1000);
    }
  };

  // ==== دليل المعلم ====
  function showTeacherGuide() {
    const modal = document.getElementById('teacherGuideModal');
    modal.style.display = 'flex';
    activity.playSound('reveal.mp3');
    setupTeacherTabs();
  }

  function closeTeacherGuide() {
    const modal = document.getElementById('teacherGuideModal');
    modal.style.display = 'none';
    activity.playSound('Click.mp3');
  }

  function setupTeacherTabs() {
    // إعداد الألسنة القديمة
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.getAttribute('data-tab');
        
        // إزالة الحالة النشطة من جميع التبويبات
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // تفعيل التبويب المختار
        button.classList.add('active');
        const targetContent = document.getElementById(`${targetTab}-content`);
        if (targetContent) {
          targetContent.classList.add('active');
        }
        
        // تأثير صوتي
        activity.playSound('Click.mp3');
      });
    });

    // إعداد الألسنة المحسنة الجديدة
    const enhancedTabButtons = document.querySelectorAll('.tab-btn-enhanced');
    const enhancedTabContents = document.querySelectorAll('.tab-content-enhanced');
    
    enhancedTabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.getAttribute('data-tab');
        
        // إزالة الحالة النشطة من جميع التبويبات المحسنة
        enhancedTabButtons.forEach(btn => btn.classList.remove('active'));
        enhancedTabContents.forEach(content => content.classList.remove('active'));
        
        // تفعيل التبويب المختار
        button.classList.add('active');
        const targetContent = document.getElementById(`${targetTab}-content`);
        if (targetContent) {
          targetContent.classList.add('active');
        }
        
        // تأثير صوتي محسن
        activity.playSound('cosmic-click.mp3');
      });
    });
  }

  // ==== وظائف ChallengeEnhancer الإضافية ====
  function showEnhancerStats() {
    const stats = {
      totalToasts: 0, // يمكن إضافة عداد في ChallengeEnhancer
      soundsPlayed: 0,
      celebrationsTriggered: 0,
      motivationCycleActive: challengeEnhancer.motivationalCycleId !== null
    };
    
    challengeEnhancer.showToast(
      '📊 إحصائيات النظام',
      `دورة التحفيز: ${stats.motivationCycleActive ? 'نشطة' : 'متوقفة'}\nالأصوات: ${challengeEnhancer.soundEnabled ? 'مفعلة' : 'معطلة'}\nالتعليقات: ${challengeEnhancer.voiceHintsEnabled ? 'مفعلة' : 'معطلة'}`,
      'info',
      6000
    );
  }
  
  function updateToggleButtons() {
    const soundBtn = document.getElementById('soundToggleBtn');
    const voiceBtn = document.getElementById('voiceToggleBtn');
    
    if (soundBtn) {
      soundBtn.innerHTML = challengeEnhancer.soundEnabled ? 
        '<i class="fas fa-volume-up"></i> الأصوات: مفعل' : 
        '<i class="fas fa-volume-mute"></i> الأصوات: معطل';
    }
    
    if (voiceBtn) {
      voiceBtn.innerHTML = challengeEnhancer.voiceHintsEnabled ? 
        '<i class="fas fa-microphone"></i> التعليقات الصوتية: مفعل' : 
        '<i class="fas fa-microphone-slash"></i> التعليقات الصوتية: معطل';
    }
  }

  // ==== تهيئة النظام الكامل مع إخفاء آمن لمؤشر التحميل ====
  
  // إضافة آلية طوارئ شاملة لمنع تعليق التحميل
  const emergencyLoadingFix = () => {
    console.log('🚑 تفعيل آلية الطوارئ الشاملة');
    
    // إخفاء شاشة التحميل فوراً
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) {
      loadingIndicator.style.display = 'none';
      loadingIndicator.style.opacity = '0';
    }
    
    // تفعيل ChallengeEnhancer إذا لم يكن مفعلاً
    if (!window.challengeEnhancer) {
      try {
        window.challengeEnhancer = new ChallengeEnhancer();
        console.log('✅ تم تفعيل ChallengeEnhancer بواسطة آلية الطوارئ');
      } catch (error) {
        console.error('❌ فشل في تفعيل ChallengeEnhancer:', error);
      }
    }
    
    // عرض رسالة نجاح
    setTimeout(() => {
      if (window.challengeEnhancer && typeof challengeEnhancer.showToast === 'function') {
        challengeEnhancer.showToast(
          '🚑 تم إنقاذ التحميل!',
          'تم تجاوز مشكلة التحميل - النظام جاهز الآن للاستخدام',
          'success'
        );
      }
    }, 500);
  };

  // مؤقت طوارئ لمنع التعليق الدائم (10 ثواني كحد أقصى)
  const emergencyTimeout = setTimeout(() => {
    console.warn('⏰ انتهت مهلة التحميل القصوى - تفعيل آلية الطوارئ');
    emergencyLoadingFix();
  }, 10000);

  // تحديث أزرار التحكم عند تحميل الصفحة
  document.addEventListener('DOMContentLoaded', function() {
    console.log('📱 DOM جاهز - تحديث أزرار التحكم...');
    
    // إلغاء مؤقت الطوارئ عند بدء التحميل الطبيعي
    clearTimeout(emergencyTimeout);
    
    try {
      // تحديث أزرار التحكم فقط (بدون تهيئة النشاط مرة أخرى)
      setTimeout(() => {
        updateToggleButtons();
      }, 2000); // بعد أن يكون النشاط قد تم تهيئته في window.onload
      
      // إضافة مستمعات الأحداث للأزرار الجديدة
      const soundToggleBtn = document.getElementById('soundToggleBtn');
      const voiceToggleBtn = document.getElementById('voiceToggleBtn');
      
      if (soundToggleBtn) {
        soundToggleBtn.addEventListener('click', updateToggleButtons);
      }
      
      if (voiceToggleBtn) {
        voiceToggleBtn.addEventListener('click', updateToggleButtons);
      }
      
      // رسالة ترحيب محسنة
      setTimeout(() => {
        if (window.challengeEnhancer && typeof challengeEnhancer.showToast === 'function') {
          challengeEnhancer.showToast(
            '🎉 نظام التحفيز جاهز!',
            'تم تفعيل جميع الميزات التفاعلية والصوتية بنجاح',
            'success',
            5000
          );
        }
      }, 2000);
      
    } catch (error) {
      console.error('❌ خطأ في تهيئة النشاط:', error);
      emergencyLoadingFix(); // استخدام آلية الطوارئ عند الخطأ
      hideLoadingIndicator();
      
      // عرض رسالة خطأ ودية للمستخدم
      setTimeout(() => {
        challengeEnhancer.showToast(
          '⚠️ تنبيه',
          'تم تحميل النشاط بنجاح، لكن قد تكون بعض الميزات محدودة',
          'warning',
          4000
        );
      }, 1000);
    }
  });

  // تنظيف الموارد عند إغلاق الصفحة
  window.addEventListener('beforeunload', function() {
    if (activity && activity.cleanup) {
      activity.cleanup();
    }
  });

  // وظائف الأزرار المحدثة
  function goToActivities() {
    activity.playSound('cosmic-click.mp3');
    window.location.href = '../index.html';
  }

  function showSettings() {
    activity.playSound('cosmic-click.mp3');
    // يمكن إضافة نافذة إعدادات هنا لاحقاً
    alert('قريباً: نافذة الإعدادات المتقدمة');
  }

  // تحسين وظيفة ملء الشاشة
  document.getElementById('fullscreenBtn').addEventListener('click', function() {
    activity.playSound('cosmic-click.mp3');
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(err => {
        console.log('خطأ في ملء الشاشة:', err);
      });
      this.innerHTML = '<i class="fas fa-compress-arrows-alt"></i>';
      this.title = 'الخروج من ملء الشاشة';
    } else {
      document.exitFullscreen();
      this.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
      this.title = 'ملء الشاشة';
    }
  });

  // رسالة تأكيد تحميل النشاط المدمج
  console.log('🎯 تم تحميل نشاط التحديات المحسن مع ChallengeEnhancer مدمج - جاهز للتشغيل!');
  console.log('📊 المميزات المتاحة: ChallengeEnhancer Pro مدمج، إشعارات تفاعلية، أصوات ذكية، تأثيرات احتفالية');
  console.log('🎮 استخدم لوحة التحكم الجديدة لإدارة الميزات التفاعلية');
  console.log('✅ النظام الآن صفحة واحدة مستقلة - لا حاجة لملفات خارجية!');
</script>

<!-- Responsive JavaScript Helper -->
<script src="../assets/js/responsive-helper.js"></script>
</body>
</html>
