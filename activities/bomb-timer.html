
<!-- القنبلة الذكية | صفحة متكاملة: اختيار الصف/الطلاب + لعبة القنبلة الذكية -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>💣 القنبلة الذكية | تحدي تفاعلي متكامل</title>
	<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
	<style>
		body {
			font-family: 'Cairo', system-ui, sans-serif;
			background: radial-gradient(ellipse at 70% 0%, #1a1a2e 0%, #0e0f14 100%);
			color: #ffe066;
			margin: 0;
			min-height: 100vh;
			overflow-x: hidden;
		}
		.top-toolbar {
			position: fixed; top: 0; left: 0; right: 0; height: 70px;
			background: linear-gradient(135deg,rgba(0,0,0,0.85) 0%,rgba(0,0,0,0.6) 50%,rgba(0,0,0,0.85) 100%);
			backdrop-filter: blur(18px); border-bottom: 2px solid #ffd70033;
			display: flex; align-items: center; justify-content: space-between; padding: 0 36px; z-index: 1000;
			box-shadow: 0 8px 30px #000a, inset 0 1px 0 #ffd70022;
			animation: toolbarSlideDown 1s cubic-bezier(0.25,0.46,0.45,0.94);
		}
		@keyframes toolbarSlideDown { 0%{opacity:0;transform:translateY(-100%);} 100%{opacity:1;transform:translateY(0);} }
		.game-logo { display: flex; align-items: center; gap: 12px; font-size: 2rem; font-weight: 900; color: #ffd700; letter-spacing: 1px; cursor: pointer; }
		.game-logo i { font-size: 2.2rem; animation: bombFloat 2.5s ease-in-out infinite; }
		@keyframes bombFloat { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-7px);} }
		.container { max-width: 1200px; margin: 0 auto; padding: 90px 12px 32px 12px; }
		.main-title { text-align: center; margin-bottom: 32px; }
		.main-title h1 { font-size: 3.2rem; font-weight: 900; color: #ffd700; letter-spacing: 2px; text-shadow: 0 0 24px #ffd70055; }
		.main-title p { font-size: 1.2rem; color: #ffe066; opacity: 0.85; }
		.class-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1.2rem; margin-bottom: 2rem; }
		.class-card { background: #23243a; border-radius: 18px; box-shadow: 0 2px 8px #0008; padding: 1.2rem 0.5rem; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.25s cubic-bezier(.4,0,.2,1); font-size: 1.1rem; font-weight: 700; color: #fff; }
		.class-card.selected, .class-card:hover { border-color: #ffd700; background: #ffd70022; color: #ffd700; transform: scale(1.04); }
		.students-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
		.student-card { background: #23243a; border-radius: 12px; padding: 0.8rem 0.2rem; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.25s cubic-bezier(.4,0,.2,1); font-size: 1rem; font-weight: 600; color: #fff; user-select: none; }
		.student-card.selected, .student-card:hover { border-color: #00e676; background: #ffd70022; color: #00e676; transform: scale(1.05); box-shadow: 0 2px 12px #00e67633; }
		.start-btn { background: #ffd700; color: #23243a; border: none; border-radius: 30px; padding: 1rem 2.5rem; font-size: 1.3rem; font-weight: 900; cursor: pointer; margin: 1.5rem auto 0 auto; display: block; box-shadow: 0 4px 16px #ffd70044; transition: 0.25s cubic-bezier(.4,0,.2,1); outline: none; }
		.start-btn:hover { background: #fff; color: #ff4757; box-shadow: 0 8px 32px #ffd70066; transform: scale(1.05); }
		.bomb-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }
		.bomb-visual { width: 180px; height: 180px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ffd700 0,#0e1328 60%); box-shadow:0 0 0 4px #0c1125 inset,0 0 32px #000a; position:relative; display:flex; align-items:center; justify-content:center; font-size:5rem; color:#ffd700; transition:transform .4s,filter .4s; }
		.fuse { position:absolute;top:-36px;left:50%;transform:translateX(-50%);width:3px;height:60px;background:linear-gradient(#ffd700,#ff9800,#b45309); }
		.spark { position:absolute;top:-44px;left:calc(50% + 8px);width:14px;height:14px;border-radius:50%;background:#ffd43b;filter:drop-shadow(0 0 8px #ffd43b);animation:spark 1s linear infinite; }
		.countdown { margin-top:18px;font-size:3.5rem;font-weight:900;letter-spacing:2px;text-shadow:0 0 10px #000a;color:#fff; }
		.heat { width:320px;height:14px;border-radius:30px;border:1px solid #ffd70055;background:#12152a;overflow:hidden;margin:18px auto 0 auto; }
		#heatFill { display:block;height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444);transition:width .5s; }
		.notif-bar { position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#23243aee;color:#ffd700;border-radius:16px;box-shadow:0 4px 24px #0008;padding:1rem 2.2rem;font-size:1.2rem;z-index:2000;display:none;align-items:center;gap:0.7rem; }
		.confetti { position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999; }
		.flash { position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:9998; }
	</style>
</head>
<body>
	<div class="top-toolbar">
		<div class="game-logo"><i class="fa-solid fa-bomb"></i> القنبلة الذكية</div>
	</div>
	<div class="container">
		<div class="main-title">
			<h1>💣 القنبلة الذكية</h1>
			<p>تحدي تفاعلي متكامل — اختيار الصف والطلاب ثم لعبة القنبلة الذكية المتقدمة</p>
		</div>
		<!-- شاشة اختيار الصف والطلاب -->
		<div id="setupScreen">
			<div class="step-title">1️⃣ اختر الصف</div>
			<div class="class-grid" id="classGrid"></div>
			<div class="step-title" id="studentStepTitle" style="display:none;">2️⃣ اختر الطلاب المشاركين</div>
			<div class="students-grid" id="studentsGrid" style="display:none;"></div>
			<button class="start-btn" id="startBtn" style="display:none;">ابدأ التحدي 💥</button>
		</div>
		<!-- شاشة اللعبة -->
		<div id="gameScreen" style="display:none">
			<div class="bomb-area">
				<div class="bomb-visual" id="bombVisual">
					<div class="fuse"></div>
					<div class="spark"></div>
					💣
				</div>
				<div class="countdown" id="countdown">—</div>
				<div class="heat"><i id="heatFill"></i></div>
				<div class="students" id="selectedChips" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:18px 0 0 0;"></div>
				<div id="turnStatus" style="margin:18px 0 0 0;font-size:1.2rem;color:#ffd700;font-weight:700;"></div>
				<div style="margin:18px 0 0 0;display:flex;gap:12px;">
					<button id="pauseBtn" style="padding:10px 22px;border-radius:8px;background:#ffd700;color:#23243a;font-weight:700;font-size:1.1rem;">⏸️ إيقاف مؤقت</button>
					<button id="add5Btn" style="padding:10px 22px;border-radius:8px;background:#22c55e;color:#fff;font-weight:700;font-size:1.1rem;">+5 ثوانٍ</button>
					<button id="successBtn" style="padding:10px 22px;border-radius:8px;background:#22c55e;color:#fff;font-weight:700;font-size:1.1rem;">✅ نجاح</button>
					<button id="failBtn" style="padding:10px 22px;border-radius:8px;background:#ef4444;color:#fff;font-weight:700;font-size:1.1rem;">💥 انفجار</button>
				</div>
			</div>
			<div class="confetti" id="confetti"></div>
			<div class="flash" id="flash"></div>
			<div class="notif-bar" id="notifBar2"><span id="notifMsg2"></span></div>
		</div>
		<!-- شاشة النتائج -->
		<div id="resultsScreen" style="display:none;text-align:center;margin-top:60px;">
			<div id="resultIcon" style="font-size:4rem;margin-bottom:18px;"></div>
			<div id="resultTitle" style="font-size:2.2rem;font-weight:900;color:#ffd700;margin-bottom:10px;"></div>
			<div id="resultText" style="font-size:1.2rem;color:#ffe066;margin-bottom:18px;"></div>
			<div id="resultBadges" style="margin-bottom:18px;"></div>
			<button id="closeResults" style="padding:12px 32px;border-radius:10px;background:#ffd700;color:#23243a;font-weight:900;font-size:1.2rem;">جولة جديدة</button>
		</div>
	</div>
	<!-- الأصوات -->
	<audio id="successSound" src="../assets/media/sounds/win.mp3"></audio>
	<audio id="failSound" src="../assets/media/sounds/wrong_answer.mp3"></audio>
	<audio id="tickSound" src="../assets/media/sounds/countdown-beep.mp3"></audio>
	<audio id="notifSound" src="../assets/media/sounds/Notification.mp3"></audio>
	<audio id="confettiSound" src="../assets/media/sounds/kingdom-sounds/cosmic-explosion.mp3"></audio>
	<audio id="bonusSound" src="../assets/media/sounds/kingdom-sounds/bonus-collect.mp3"></audio>
	<script>
		// ========== جلب بيانات الصفوف والطلاب من data/studentData.json ==========
		let classData = [];
		let studentData = {};
		let selectedClass = null;
		let selectedStudents = [];
		let roundStudents = [];
		let roundIndex = 0;
		let timer = null, timeLeft = 35, totalTime = 35, state = 'IDLE';
		// جلب البيانات
		fetch('../data/studentData.json').then(r=>r.json()).then(data=>{
			classData = data.classes;
			studentData = data.students;
			buildClassGrid();
		}).catch(()=>{
			document.getElementById('classGrid').innerHTML = '<div style="color:#ff4757;font-weight:700">تعذر تحميل بيانات الصفوف/الطلاب</div>';
		});
		// بناء واجهة اختيار الصف
		function buildClassGrid() {
			const grid = document.getElementById('classGrid');
			grid.innerHTML = '';
			classData.forEach(c=>{
				const card = document.createElement('div');
				card.className = 'class-card';
				card.textContent = c.name;
				card.onclick = ()=> selectClass(c.id, card);
				grid.appendChild(card);
			});
		}
		function selectClass(classId, card) {
			selectedClass = classId;
			// تمييز الكارد
			document.querySelectorAll('.class-card').forEach(c=>c.classList.remove('selected'));
			card.classList.add('selected');
			// إظهار اختيار الطلاب
			document.getElementById('studentStepTitle').style.display = '';
			document.getElementById('studentsGrid').style.display = '';
			buildStudentsGrid();
		}
		function buildStudentsGrid() {
			const grid = document.getElementById('studentsGrid');
			grid.innerHTML = '';
			selectedStudents = [];
			(studentData[selectedClass]||[]).forEach(s=>{
				const btn = document.createElement('div');
				btn.className = 'student-card';
				btn.textContent = (s.avatar||'👤')+' '+s.name;
				btn.onclick = ()=>{
					if(selectedStudents.includes(s)){
						selectedStudents = selectedStudents.filter(x=>x!==s);
						btn.classList.remove('selected');
					} else {
						selectedStudents.push(s);
						btn.classList.add('selected');
					}
					document.getElementById('startBtn').style.display = selectedStudents.length>0?'':'none';
				};
				grid.appendChild(btn);
			});
			document.getElementById('startBtn').style.display = 'none';
		}
		// بدء اللعبة
		document.getElementById('startBtn').onclick = function() {
			if(selectedStudents.length < 1){ alert('اختر الطلاب المشاركين أولاً'); return; }
			document.getElementById('setupScreen').style.display = 'none';
			document.getElementById('gameScreen').style.display = 'block';
			document.getElementById('resultsScreen').style.display = 'none';
			roundIndex = 0;
			nextRound();
		};
		// ========== منطق لعبة القنبلة الذكية ==========
		function nextRound() {
			if(selectedStudents.length === 0){ showResults('END'); return; }
			roundStudents = selectedStudents.slice(0, 3); // 3 طلاب في كل جولة
			selectedStudents = selectedStudents.slice(3);
			document.getElementById('selectedChips').innerHTML = roundStudents.map(s=>`<div class='chip' style='background:#ffd70022;color:#ffd700;padding:8px 14px;border-radius:999px;margin:0 4px;font-weight:700;'>${s.avatar||'👤'} ${s.name}</div>`).join('');
			document.getElementById('turnStatus').textContent = `جولة ${roundIndex+1} — ${roundStudents.length} مشاركين`;
			startGame();
		}
		function playSound(id) { try{ document.getElementById(id).currentTime=0; document.getElementById(id).play(); }catch{} }
		function showNotif2(msg, type='info', sec=2) {
			const bar = document.getElementById('notifBar2');
			document.getElementById('notifMsg2').textContent = msg;
			bar.style.display = 'flex';
			setTimeout(()=>bar.style.display='none', sec*1000);
			playSound('notifSound');
		}
		function confettiBlast() {
			if(window.confetti) window.confetti({particleCount:120,spread:90,origin:{y:0.7}});
			playSound('confettiSound');
		}
		function doFlash() {
			const flash = document.getElementById('flash');
			flash.style.opacity = 1;
			setTimeout(()=>flash.style.opacity=0, 350);
		}
		function startGame() {
			state = 'RUNNING';
			timeLeft = 35;
			totalTime = 35;
			updateBombVisual();
			if(timer) clearInterval(timer);
			timer = setInterval(()=>{
				timeLeft--;
				updateBombVisual();
				if (timeLeft === 10) { showNotif2('⚠️ آخر 10 ثوانٍ!','warn',2); playSound('notifSound'); document.getElementById('bombVisual').classList.add('yellow'); }
				if (timeLeft === 3) { showNotif2('🚨 اقترب الانفجار!','danger',2); playSound('failSound'); document.getElementById('bombVisual').classList.add('red','shake'); document.getElementById('countdown').classList.add('mega','danger'); doFlash(); }
				if (timeLeft <= 0) { clearInterval(timer); endGame(false); }
				else if (timeLeft < 10) playSound('tickSound');
				else playSound('tickSound');
			},1000);
		}
		function updateBombVisual() {
			document.getElementById('countdown').textContent = timeLeft > 0 ? timeLeft : '—';
			const fill = document.getElementById('heatFill');
			fill.style.width = ((1-(timeLeft/totalTime))*100)+'%';
		}
		function endGame(success) {
			state = success ? 'SUCCESS' : 'FAIL';
			if (success) {
				showNotif2('🎉 نجاح! أحسنت!');
				confettiBlast();
				playSound('successSound');
				showResults('SUCCESS');
			} else {
				showNotif2('💥 انفجرت القنبلة!');
				doFlash();
				playSound('failSound');
				showResults('FAIL');
			}
			document.getElementById('bombVisual').classList.remove('yellow','red','shake');
			document.getElementById('countdown').classList.remove('mega','danger');
		}
		document.getElementById('pauseBtn').onclick = ()=>{
			if(state==='RUNNING'){ clearInterval(timer); state='PAUSED'; showNotif2('⏸️ تم الإيقاف المؤقت','info',2); }
			else if(state==='PAUSED'){ startGame(); showNotif2('▶️ استئناف','info',1); }
		};
		document.getElementById('add5Btn').onclick = ()=>{ timeLeft+=5; showNotif2('⏫ +5 ثوانٍ!','success',1); updateBombVisual(); playSound('bonusSound'); };
		document.getElementById('successBtn').onclick = ()=>{ clearInterval(timer); endGame(true); };
		document.getElementById('failBtn').onclick = ()=>{ clearInterval(timer); endGame(false); };
		window.addEventListener('keydown',e=>{
			if(state==='RUNNING'){
				if(e.key===' '){ document.getElementById('pauseBtn').click(); }
				if(e.key==='Enter'){ document.getElementById('successBtn').click(); }
				if(e.key==='Escape'){ document.getElementById('failBtn').click(); }
				if(e.key==='ArrowUp'){ document.getElementById('add5Btn').click(); }
			} else if(state==='PAUSED' && e.key===' '){ document.getElementById('pauseBtn').click(); }
		});
		function showResults(type) {
			document.getElementById('gameScreen').style.display = 'none';
			document.getElementById('resultsScreen').style.display = 'block';
			let icon = '', title = '', text = '', badges = '';
			if(type==='SUCCESS'){
				icon = '🎉';
				title = 'ممتاز!';
				text = 'تمت المهمة بنجاح.';
				badges = '<span style="background:#22c55e;color:#fff;padding:8px 18px;border-radius:999px;margin:0 4px;font-weight:700;">🏅 سريع الرد</span>';
			} else if(type==='FAIL'){
				icon = '💥';
				title = 'انفجرت القنبلة!';
				text = 'حاولوا مرة أخرى.';
			} else {
				icon = '⏹️';
				title = 'انتهت الجولات';
				text = 'تم إنهاء جميع الجولات.';
			}
			document.getElementById('resultIcon').textContent = icon;
			document.getElementById('resultTitle').textContent = title;
			document.getElementById('resultText').textContent = text;
			document.getElementById('resultBadges').innerHTML = badges;
		}
		document.getElementById('closeResults').onclick = ()=>{
			if(selectedStudents.length > 0){
				roundIndex++;
				document.getElementById('resultsScreen').style.display = 'none';
				document.getElementById('gameScreen').style.display = 'block';
				nextRound();
			} else {
				// إعادة التحدي
				document.getElementById('resultsScreen').style.display = 'none';
				document.getElementById('setupScreen').style.display = 'block';
				// إعادة تعيين
				selectedClass = null;
				selectedStudents = [];
				buildClassGrid();
				document.getElementById('studentsGrid').style.display = 'none';
				document.getElementById('studentStepTitle').style.display = 'none';
			}
		};
	</script>
</body>
</html>
