<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ’£ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Ù†Ø³Ø®Ø© Ù…ÙÙØ¹Ù‘Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --oman-red: #dc143c;
      --oman-green: #228b22;
      --oman-white: #fff;
      --accent-gold: #ffd700;
      --gradient-danger: linear-gradient(90deg, #dc143c 0%, #ffd700 100%);
      --gradient-safe: linear-gradient(90deg, #228b22 0%, #ffd700 100%);
      --gradient-warning: linear-gradient(90deg, #ffd700 0%, #dc143c 100%);
      --gradient-gold: linear-gradient(90deg, #ffd700 0%, #fff 100%);
      --gradient-dark: linear-gradient(135deg, #181a23 0%, #23243a 100%);
      --gradient-background: radial-gradient(ellipse at 70% 0%, #23243a 0%, #181a23 100%);
      --glass: rgba(255, 255, 255, 0.08);
      --shadow: 0 4px 24px #0006;
      --glow-gold: 0 0 16px #ffd70099;
      --info-card-border: 2px solid var(--accent-gold);
      --info-card-shadow: 0 2px 8px #ffd70033;
    }
    html, body { height:100%; min-height:100vh; margin:0; padding:0; background:var(--gradient-background); color:var(--oman-white); font-family:'Cairo', system-ui, sans-serif; overflow-x:hidden; }
    body::before { content:""; position:fixed; inset:0; z-index:0; pointer-events:none; background: radial-gradient(circle at 80% 10%, #ffd70022 0, transparent 60%), radial-gradient(circle at 20% 90%, #dc143c22 0, transparent 60%), radial-gradient(circle at 50% 50%, #228b2222 0, transparent 70%); animation:bgMove 12s linear infinite alternate; }
    @keyframes bgMove { 0%{background-position:80% 10%, 20% 90%, 50% 50%} 100%{background-position:70% 20%, 30% 80%, 60% 60%} }

    /* Toolbar */
    .top-toolbar { position:fixed; top:0; left:0; right:0; height:68px; background:var(--gradient-dark); display:flex; align-items:center; justify-content:flex-end; gap:12px; z-index:1000; box-shadow:var(--shadow); padding:0 24px; border-bottom:2px solid #ffd70033; backdrop-filter:blur(10px); }
    .toolbar-btn { width:48px; height:48px; border-radius:50%; background:var(--glass); border:none; color:var(--accent-gold); font-size:1.4rem; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px #ffd70022; cursor:pointer; transition:.18s; outline:none; }
    .toolbar-btn:hover, .toolbar-btn:active { background:#ffd70022; color:var(--oman-red); box-shadow:0 0 0 3px #ffd70055; }
    .toolbar-btn:focus { box-shadow:0 0 0 3px #ffd70099; }

    /* Header */
    .header { margin-top:80px; background:var(--gradient-dark); border-radius:0 0 32px 32px; box-shadow:var(--shadow); padding:32px 0 18px; text-align:center; position:relative; }
    .header-title { font-size:2.7rem; font-weight:900; color:var(--accent-gold); letter-spacing:1px; text-shadow:var(--glow-gold); animation:pulseTitle 2.5s infinite; }
    @keyframes pulseTitle { 0%,100%{text-shadow:var(--glow-gold)} 50%{text-shadow:0 0 32px #ffd700cc} }
    .header-subtitle { font-size:1.2rem; color:#ffd700cc; margin-top:10px; font-weight:500; text-shadow:0 2px 8px #000a; }

    /* Layout */
    .main-content { display:grid; grid-template-columns:1fr 1.2fr 1fr; gap:24px; max-width:1400px; margin:0 auto; padding:32px 12px; position:relative; z-index:1; }
    @media (max-width:1100px){ .main-content{ grid-template-columns:1fr 1.5fr } .game-info{ display:none } }
    @media (max-width:900px){ .main-content{ grid-template-columns:1fr } .game-info,.teacher-controls{ display:none } .bomb-area{ margin:0 auto } }

    /* Info cards */
    .game-info { display:flex; flex-direction:column; gap:18px; }
    .info-card { background:var(--glass); border:var(--info-card-border); border-radius:16px; box-shadow:var(--info-card-shadow); padding:18px 14px; color:var(--accent-gold); font-size:1.05rem; font-weight:800; display:flex; align-items:center; gap:12px; transition:.18s; }
    .info-card:hover { background:#ffd70011; color:var(--oman-red); box-shadow:0 0 0 3px #ffd70055; }

    /* Bomb area */
    .bomb-area { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:480px; gap:18px; position:relative; }
    .game-state { font-size:1.15rem; font-weight:900; padding:8px 22px; border-radius:12px; background:var(--gradient-warning); color:var(--oman-red); box-shadow:0 2px 8px #ffd70033; transition:.3s; text-align:center; }
    .state-waiting{ background:var(--gradient-warning); color:var(--oman-red) }
    .state-active{ background:var(--gradient-danger); color:#fff; animation:shake .7s infinite alternate }
    .state-success{ background:var(--gradient-safe); color:var(--oman-green) }
    .state-explosion{ background:var(--gradient-danger); color:#fff; animation:shake .2s 8 alternate }
    @keyframes shake{ 0%{transform:translateX(0)} 25%{transform:translateX(-4px)} 50%{transform:translateX(4px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)} }

    .bomb { width:180px; height:180px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #ffd700 0, #23243a 60%); box-shadow:0 0 0 4px #ffd70044 inset, 0 0 32px #ffd70033, 0 8px 30px #000a; display:flex; align-items:center; justify-content:center; font-size:5rem; color:#ffd700; position:relative; margin-bottom:12px; animation:bombPulse 1.5s infinite; transition: box-shadow .3s; }
    @keyframes bombPulse{ 0%,100%{box-shadow:0 0 0 4px #ffd70044 inset, 0 0 32px #ffd70033, 0 8px 30px #000a} 50%{box-shadow:0 0 0 8px #ffd70088 inset, 0 0 64px #ffd70077, 0 8px 30px #000a} }
    .fuse{ position:absolute; top:-38px; left:50%; transform:translateX(-50%); width:5px; height:60px; border-radius:8px; background:linear-gradient(#ffd700,#dc143c,#ffd700 80%); box-shadow:0 0 8px #ffd70099; z-index:2; overflow:visible }
    .fuse-flame{ position:absolute; top:-48px; left:50%; transform:translateX(-50%); width:22px; height:22px; border-radius:50%; background: radial-gradient(circle, #ffd700 60%, #dc143c 100%); filter:drop-shadow(0 0 12px #ffd700cc); animation:flameFlicker .18s infinite alternate; z-index:3; display:flex; align-items:center; justify-content:center; font-size:1.3rem }
    @keyframes flameFlicker{ 0%{opacity:1; transform:translateX(-50%) scale(1)} 100%{opacity:.7; transform:translateX(-50%) scale(1.15)} }

    .timer-display{ font-family:'Cairo', monospace; font-size:3.2rem; font-weight:900; color:var(--accent-gold); background:#181a23cc; border-radius:18px; padding:10px 38px; margin:0 auto 8px; text-align:center; letter-spacing:2px; box-shadow:0 2px 8px #ffd70033; text-shadow:0 0 18px #ffd70099; animation:pulseTimer 1.2s infinite }
    @keyframes pulseTimer { 0%,100%{text-shadow:0 0 18px #ffd70099} 50%{text-shadow:0 0 32px #ffd700cc} }
    .timer-text{ font-size:1.05rem; color:#ffd700cc; margin-bottom:8px; text-align:center }
    .timer-highlight{ animation: timerFlash 1.1s cubic-bezier(.4,0,.2,1) 1; box-shadow: 0 0 32px #ffd700cc, 0 2px 18px #ffd70044; }
    @keyframes timerFlash{ 0%{ box-shadow:0 0 0 #ffd70000 } 30%{ box-shadow:0 0 32px #ffd700cc, 0 2px 18px #ffd70044 } 100%{ box-shadow:0 0 0 #ffd70000 } }

    /* Teacher controls */
    .teacher-controls{ background:var(--glass); border-radius:18px; box-shadow:var(--shadow); padding:18px 14px 24px; display:flex; flex-direction:column; gap:18px; min-width:260px }
    .teacher-controls h3{ color:var(--accent-gold); font-size:1.25rem; font-weight:900; margin:0 0 10px; text-shadow:var(--glow-gold) }
    .control-section{ margin-bottom:12px }

    .oman-btn{ background:var(--gradient-safe); color:#fff; border:none; border-radius:12px; padding:12px 18px; font-size:1.05rem; font-weight:900; cursor:pointer; box-shadow:0 2px 8px #228b2233; margin:0 4px 8px 0; transition:.18s; outline:none; min-width:44px; min-height:44px; display:inline-flex; align-items:center; gap:8px; position:relative; overflow:hidden }
    .oman-btn.gold{ background:var(--gradient-gold); color:var(--oman-red); box-shadow:0 2px 8px #ffd70033 }
    .oman-btn.red{ background:var(--gradient-danger); box-shadow:0 2px 8px #dc143c33 }
    .oman-btn:hover{ filter:brightness(1.08) }

    .modern-select-wrapper{ position:relative; width:100%; margin-top:8px; margin-bottom:2px; display:flex; align-items:center }
    .modern-select{ width:100%; padding:12px 44px 12px 16px; border-radius:12px; border:2px solid #ffd70055; background:rgba(35,36,58,.85); color:#ffd700; font-size:1.05rem; font-family:'Cairo', system-ui, sans-serif; font-weight:800; appearance:none; outline:none; box-shadow:0 2px 8px #ffd70022; transition:border .18s, box-shadow .18s, background .18s; cursor:pointer }
    .modern-select:hover, .modern-select:focus{ border-color:#ffd700; background:#23243aee; box-shadow:0 0 0 3px #ffd70055 }
    .modern-select-arrow{ position:absolute; left:16px; top:50%; transform:translateY(-50%); pointer-events:none; color:#ffd700; font-size:1.2rem }

    /* Notifications */
    #notificationContainer{ position:fixed; top:24px; right:24px; z-index:99999; display:flex; flex-direction:column; gap:12px; align-items:flex-end }
    .notification{ background:#23243aee; color:#ffd700; border:2px solid #ffd700; border-radius:14px; box-shadow:0 0 18px #ffd70099, 0 2px 12px #000a; padding:16px 32px 16px 18px; font-size:1.05rem; font-weight:900; display:flex; align-items:center; gap:12px; opacity:0; transform:translateY(-30px) scale(.95); transition:opacity .35s, transform .35s; pointer-events:auto; min-width:220px; max-width:350px; cursor:pointer; user-select:none }
    .notification.show{ opacity:1; transform:translateY(0) scale(1.04); animation:notifPulse 1.2s infinite alternate }
    .notification-success{ border-color:#228b22; color:#fff; background:linear-gradient(90deg,#228b22 0%,#ffd700 100%) }
    .notification-error{ border-color:#dc143c; color:#fff; background:linear-gradient(90deg,#dc143c 0%,#ffd700 100%) }
    .notification-warning,.notification-info{ border-color:#ffd700; color:#ffd700; background:#23243aee }
    @keyframes notifPulse{ 0%{ box-shadow:0 0 18px #ffd70099, 0 2px 12px #000a } 100%{ box-shadow:0 0 32px #ffd700cc, 0 2px 18px #ffd70044 } }

    /* Evaluation box */
    .evaluation-box{ position:fixed; bottom:24px; left:24px; z-index:9999; background:#23243aee; color:#ffd700; border:2.5px solid #ffd700; padding:14px 18px; border-radius:14px; box-shadow:0 0 24px #ffd700cc, 0 2px 18px #ffd70044; font-weight:900; display:none }
    .evaluation-box.show{ display:block; animation:evalPulse 1.2s infinite alternate }
    @keyframes evalPulse{ 0%{ box-shadow:0 0 24px #ffd700cc, 0 2px 18px #ffd70044 } 100%{ box-shadow:0 0 40px #ffd700ee, 0 2px 24px #ffd70077 } }
  </style>
</head>
<body>
  <!-- Toolbar -->
  <div class="top-toolbar">
    <button class="toolbar-btn" id="homeBtn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><i class="fa-solid fa-house"></i></button>
    <button class="toolbar-btn" id="refreshBtn" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„"><i class="fa-solid fa-rotate-right"></i></button>
    <button class="toolbar-btn" id="instructionsBtn" title="ØªØ¹Ù„ÙŠÙ…Ø§Øª"><i class="fa-solid fa-circle-question"></i></button>
    <button class="toolbar-btn" id="fullscreenBtn" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©"><i class="fa-solid fa-expand"></i></button>
    <button class="toolbar-btn" id="soundBtn" title="Ø§Ù„ØµÙˆØª"><i class="fa-solid fa-volume-up"></i></button>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-title">ğŸ’£ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©</div>
    <div class="header-subtitle">Ø§Ø®ØªØ¨Ø± Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ‡Ø© ÙˆØ§Ù„ØªØ¹Ø§ÙˆÙ†â€¦ Ø£Ø¨Ø·Ù„ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª!</div>
  </div>

  <!-- Notifications -->
  <div id="notificationContainer"></div>

  <!-- Main content -->
  <div class="main-content">
    <!-- Left: info -->
    <div class="game-info">
      <div class="info-card"><i class="fa-solid fa-user"></i> Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentStudent">â€”</span></div>
      <div class="info-card"><i class="fa-solid fa-users"></i> Ø§Ù„ØµÙ: <span id="currentClass">â€”</span></div>
      <div class="info-card"><i class="fa-solid fa-star"></i> Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="gamePoints">0</span></div>
      <div class="info-card"><i class="fa-solid fa-bomb"></i> Ø§Ù„Ù‚Ù†Ø§Ø¨Ù„ Ø§Ù„Ù…ÙØ¨Ø·Ù„Ø©: <span id="defusedBombs">0</span></div>
      <div class="info-card"><i class="fa-solid fa-skull-crossbones"></i> Ø§Ù„Ù‚Ù†Ø§Ø¨Ù„ Ø§Ù„Ù…Ù†ÙØ¬Ø±Ø©: <span id="explodedBombs">0</span></div>
      <div class="info-card"><i class="fa-solid fa-chart-line"></i> Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­: <span id="successRate">0%</span></div>
    </div>

    <!-- Center: bomb -->
    <div class="bomb-area">
      <div id="gameState" class="game-state state-waiting">ğŸš¨ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
      <div class="bomb" id="bomb">
        <div class="fuse" id="fuse"></div>
        <div class="fuse-flame" id="fuseFlame">ğŸ”¥</div>
        <span style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);">ğŸ’£</span>
      </div>
      <div class="timer-display"><span class="timer-text" id="timerDisplay">00:00</span></div>
      <div id="bombMessage" class="timer-text" style="min-height:28px"></div>
    </div>

    <!-- Right: teacher controls -->
    <div class="teacher-controls">
      <h3>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…</h3>

      <div class="control-section">
        <label for="classSelect" style="font-weight:700;color:#FFD700;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ:</label>
        <div class="modern-select-wrapper">
          <select id="classSelect" class="modern-select">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ØµÙ â€”</option>
          </select>
          <span class="modern-select-arrow"><i class="fa-solid fa-chevron-down"></i></span>
        </div>
      </div>

      <div class="control-section">
        <label for="studentSelect" style="font-weight:700;color:#FFD700;">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
        <div class="modern-select-wrapper" id="studentSelectWrapper" style="display:none;">
          <select id="studentSelect" class="modern-select">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ â€”</option>
          </select>
          <span class="modern-select-arrow"><i class="fa-solid fa-chevron-down"></i></span>
        </div>
        <div id="currentExpertDisplay" class="timer-text" style="margin-top:8px"></div>
      </div>

      <div class="control-section">
        <label for="timerDurationSelect" style="font-weight:700;color:#FFD700;">Ù…Ø¯Ø© Ø§Ù„Ù…Ø¤Ù‚Øª:</label>
        <div class="modern-select-wrapper">
          <select id="timerDurationSelect" class="modern-select">
            <option value="30">30 Ø«Ø§Ù†ÙŠØ©</option>
            <option value="60" selected>1 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="120">2 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="180">3 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="240">4 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="300">5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="420">7 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="600">10 Ø¯Ù‚Ø§Ø¦Ù‚</option>
          </select>
          <span class="modern-select-arrow"><i class="fa-solid fa-chevron-down"></i></span>
        </div>
      </div>

      <div class="control-section">
        <button class="oman-btn gold" id="randomStudentBtn" type="button" style="width:100%;margin-top:2px;">
          <i class="fa-solid fa-shuffle"></i> Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        </button>
      </div>

      <div class="control-section">
        <button class="oman-btn" id="startBtn"><i class="fa-solid fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª</button>
        <button class="oman-btn gold" id="pauseBtn"><i class="fa-solid fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
        <button class="oman-btn red" id="resetBtn"><i class="fa-solid fa-rotate-right"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        <button class="oman-btn gold" id="newRoundBtn"><i class="fa-solid fa-forward"></i> Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>

      <div class="control-section">
        <button class="oman-btn" id="defuseBtn"><i class="fa-solid fa-check"></i> Ø¥Ø¨Ø·Ø§Ù„ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©</button>
        <button class="oman-btn red" id="explodeBtn"><i class="fa-solid fa-xmark"></i> Ø§Ù†ÙØ¬Ø§Ø±</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="instructionsModal" style="display:none; align-items:center; justify-content:center;">
    <div class="modal-content" style="max-width:560px; width:95vw;">
      <div class="modal-header">
        <h2>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©</h2>
        <button class="modal-close" data-close-modal="instructionsModal">&times;</button>
      </div>
      <div class="modal-body">
        <ul style="font-size:1.05rem;line-height:2; margin:0; padding-right:18px;">
          <li>Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø·Ø§Ù„Ø¨ØŒ Ø«Ù… Ø­Ø¯Ø¯ Ù…Ø¯Ø© Ø§Ù„Ù…Ø¤Ù‚Øª.</li>
          <li>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ­ÙÙ‘Ø² Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª.</li>
          <li>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø¥Ø¨Ø·Ø§Ù„ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ÙØ¬Ø§Ø±.</li>
          <li>Ø²Ø± "Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©" ÙŠØ®ØªØ§Ø± Ø·Ø§Ù„Ø¨Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ ÙˆÙŠØ­Ø¶Ø± Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.</li>
        </ul>
        <button class="oman-btn gold" data-close-modal="instructionsModal" style="margin-top:18px;">ÙÙ‡Ù…ØªØŒ Ù„Ù†Ø¨Ø¯Ø£!</button>
      </div>
    </div>
  </div>

  <!-- Confetti Canvas -->
  <canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;display:none;"></canvas>
  <div class="evaluation-box" id="evaluationBox">âœ… Ø£Ø­Ø³Ù†Øª ÙŠØ§ <span id="evalName">â€”</span>! (+10 Ù†Ù‚Ø§Ø·)</div>

  <script>
    // ====== Ø§Ù„ØµÙˆØª Ø§Ù„Ø°ÙƒÙŠ ======
    let currentAudio = null, soundOn = true;
    function playGameSound(src, volume = 1, allowOverlap = false){
      if(!soundOn) return; // Ø§Ø­ØªØ±Ø§Ù… Ø­Ø§Ù„Ø© ÙƒØªÙ… Ø§Ù„ØµÙˆØª
      try{
        if(!allowOverlap && currentAudio){ currentAudio.pause(); currentAudio.currentTime = 0; }
        const audio = new Audio(src);
        audio.volume = volume; audio.play();
        if(!allowOverlap) currentAudio = audio;
        audio.onended = () => { if(currentAudio === audio) currentAudio = null; };
      }catch(e){}
    }

    // ====== Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ======
    function showNotification(msg, type = 'info'){
      const container = document.getElementById('notificationContainer');
      if(!container) return;
      const el = document.createElement('div');
      el.className = `notification notification-${type}`;
      const icon = type==='success'?'âœ…': type==='error'?'âŒ': type==='warning'?'âš ï¸':'ğŸ””';
      el.innerHTML = `<span class="notif-icon">${icon}</span><span>${msg}</span>`;
      container.appendChild(el);
      setTimeout(()=> el.classList.add('show'), 10);
      setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=> el.remove(), 600); }, 3500);
    }

    // ====== Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ======
    const gameState = {
      isActive:false, isPaused:false, timeLeft:0, timer:null,
      currentStudent:'â€”', currentClass:'â€”',
      defusedBombs:0, explodedBombs:0, points:0
    };

    let students = [];           // Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ
    let allClasses = {};         // ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ => { "ØµÙ 1": ["Ø§Ø³Ù…" ...] }
    let currentExpert = null;    // Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
    let customTimerDuration = 60;// Ø§ÙØªØ±Ø§Ø¶ÙŠ
    let randomStudentPool = [];  // Ù„Ù„ØªØ¯ÙˆÙŠØ± Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±

    // ====== Ø£Ø¯ÙˆØ§Øª ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function formatTime(s){
      s = Math.max(0, Math.floor(s));
      const m = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${m}:${ss}`;
    }

    function updateGameInfo(){
      $('#currentStudent').textContent = gameState.currentStudent || 'â€”';
      $('#currentClass').textContent = gameState.currentClass || 'â€”';
      $('#gamePoints').textContent = gameState.points;
      $('#defusedBombs').textContent = gameState.defusedBombs;
      $('#explodedBombs').textContent = gameState.explodedBombs;
      const total = gameState.defusedBombs + gameState.explodedBombs;
      const rate = total? Math.round((gameState.defusedBombs/total)*100) : 0;
      $('#successRate').textContent = rate + '%';
    }

    function setState(cls){
      const gs = $('#gameState');
      gs.className = 'game-state ' + cls;
      if(cls==='state-active') gs.textContent = 'â±ï¸ Ø§Ù„Ù…Ø¤Ù‚Øª ÙŠØ¹Ù…Ù„';
      else if(cls==='state-success') gs.textContent = 'ğŸ‰ ØªÙ… Ø§Ù„Ø¥Ø¨Ø·Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­';
      else if(cls==='state-explosion') gs.textContent = 'ğŸ’¥ Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©';
      else gs.textContent = 'ğŸš¨ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©';
    }

    function animateTimerHighlight(){
      const t = $('#timerDisplay');
      if(!t) return;
      t.classList.remove('timer-highlight'); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
      void t.offsetWidth;
      t.classList.add('timer-highlight');
    }

    function openModal(id){ const m = document.getElementById(id); if(!m) return; m.style.display='flex'; }
    function closeModal(id){ const m = document.getElementById(id); if(!m) return; m.style.display='none'; }

    function showEvaluationBox(name){
      const box = $('#evaluationBox');
      $('#evalName').textContent = name || 'â€”';
      box.classList.add('show');
      setTimeout(()=> box.classList.remove('show'), 3000);
    }

    function fireConfetti(){
      const canvas = document.getElementById('confettiCanvas');
      canvas.style.display = 'block';
      const myConfetti = confetti.create(canvas, { resize: true, useWorker: true });
      myConfetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
      setTimeout(()=> canvas.style.display = 'none', 800);
    }

    // ====== Ø§Ù„Ù…Ø¤Ù‚Øª ======
    function startTimer(){
      if(gameState.isActive && !gameState.isPaused) return; // ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
      if(!gameState.timeLeft) gameState.timeLeft = customTimerDuration;
      setState('state-active');
      gameState.isActive = true; gameState.isPaused = false;
      $('#bombMessage').textContent = '';
      playGameSound('../assets/media/sounds/ui/confirm.mp3', 0.6);
      if(gameState.timer) clearInterval(gameState.timer);
      gameState.timer = setInterval(()=>{
        gameState.timeLeft -= 1;
        $('#timerDisplay').textContent = formatTime(gameState.timeLeft);
        if(gameState.timeLeft <= 0){
          clearInterval(gameState.timer);
          gameState.timer = null; gameState.isActive = false; gameState.isPaused = false;
          handleExplosion();
        }
      }, 1000);
      $('#timerDisplay').textContent = formatTime(gameState.timeLeft);
      animateTimerHighlight();
    }

    function pauseTimer(){
      if(!gameState.isActive || gameState.isPaused) return;
      gameState.isPaused = true; setState('state-waiting');
      if(gameState.timer) clearInterval(gameState.timer);
      gameState.timer = null;
      playGameSound('../assets/media/sounds/ui/pause.mp3', 0.6);
    }

    function resetTimer(){
      if(gameState.timer) clearInterval(gameState.timer);
      gameState.timer = null; gameState.isActive = false; gameState.isPaused = false;
      gameState.timeLeft = 0; $('#timerDisplay').textContent = '00:00';
      setState('state-waiting');
      $('#bombMessage').textContent = '';
      playGameSound('../assets/media/sounds/ui/reset.mp3', 0.6);
    }

    function newRound(){
      resetTimer();
      // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¬Ø¯ÙŠØ¯ Ø¥Ù† Ø£Ù…ÙƒÙ†
      const btn = $('#randomStudentBtn');
      if(btn && students.length){ btn.click(); }
      gameState.timeLeft = customTimerDuration;
      $('#timerDisplay').textContent = formatTime(gameState.timeLeft);
      showNotification('âœ¨ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ø£Øª', 'info');
    }

    function handleDefuse(){
      if(gameState.timer) { clearInterval(gameState.timer); gameState.timer = null; }
      gameState.isActive = false; gameState.isPaused = false;
      setState('state-success');
      gameState.defusedBombs += 1; gameState.points += 10;
      updateGameInfo();
      $('#bombMessage').textContent = 'ğŸ¯ ØªÙ… Ø¥Ø¨Ø·Ø§Ù„ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨!';
      fireConfetti();
      playGameSound('../assets/media/sounds/fx/success.mp3', 0.7);
      showEvaluationBox(gameState.currentStudent || 'Ø§Ù„Ø·Ø§Ù„Ø¨');
    }

    function handleExplosion(){
      setState('state-explosion');
      gameState.explodedBombs += 1; updateGameInfo();
      $('#bombMessage').textContent = 'ğŸ’¥ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!';
      playGameSound('../assets/media/sounds/fx/explosion.mp3', 0.7);
      showNotification('Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©! Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.', 'error');
    }

    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ ======
    function loadClasses(){
      // Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ù‘Ø©: Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
      // Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ
      fetch('../data/studentData.json')
        .then(r => r.json())
        .then(data => {
          allClasses = data || {};
          const classSelect = $('#classSelect');
          classSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ØµÙ â€”</option>';
          Object.keys(allClasses).forEach(className => {
            const opt = document.createElement('option');
            opt.value = className; opt.textContent = className; classSelect.appendChild(opt);
          });
        })
        .catch(err => {
          console.error(err);
          $('#classSelect').innerHTML = '<option value="">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙˆÙ</option>';
          showNotification('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙÙˆÙ', 'error');
        });
    }

    function onClassChange(e){
      const className = e.target.value;
      const studentSelect = $('#studentSelect');
      const wrapper = $('#studentSelectWrapper');
      if(!className){
        students = []; gameState.currentClass = 'â€”'; gameState.currentStudent = 'â€”'; currentExpert = null; updateGameInfo();
        studentSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ â€”</option>'; wrapper.style.display = 'none';
        randomStudentPool = [];
        return;
      }
      gameState.currentClass = className;
      students = Array.isArray(allClasses[className]) ? allClasses[className] : [];
      updateGameInfo();
      // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
      studentSelect.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ â€”</option>';
      students.forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; studentSelect.appendChild(o); });
      wrapper.style.display = '';
      studentSelect.value = '';
      currentExpert = null; gameState.currentStudent = 'â€”';
      $('#currentExpertDisplay').textContent = '';
      randomStudentPool = [...students];
    }

    function onStudentChange(e){
      const val = e.target.value;
      if(val){ currentExpert = val; gameState.currentStudent = val; $('#currentExpertDisplay').textContent = `ğŸ‘‘ Ø®Ø¨ÙŠØ± Ø§Ù„Ø¬ÙˆÙ„Ø©: ${val}`; animateTimerHighlight(); }
      else{ currentExpert = null; gameState.currentStudent = 'â€”'; $('#currentExpertDisplay').textContent = ''; }
      updateGameInfo();
    }

    function pickRandomStudent(){
      if(!students.length){ $('#bombMessage').textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ Ø£ÙˆÙ„Ø§Ù‹.'; return; }
      if(!randomStudentPool.length) randomStudentPool = [...students];
      const idx = Math.floor(Math.random() * randomStudentPool.length);
      const selected = randomStudentPool.splice(idx, 1)[0];
      currentExpert = selected; gameState.currentStudent = selected;
      $('#studentSelect').value = selected;
      $('#currentExpertDisplay').textContent = `ğŸ‘‘ Ø®Ø¨ÙŠØ± Ø§Ù„Ø¬ÙˆÙ„Ø©: ${selected}`;
      updateGameInfo(); animateTimerHighlight();
      playGameSound('../assets/media/sounds/kingdom-sounds/character-intro.mp3', 0.7);
      showNotification(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${selected} ÙƒØ®Ø¨ÙŠØ± Ø§Ù„Ø¬ÙˆÙ„Ø©!`, 'success');
      showEvaluationBox(selected);
    }

    // ====== Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª ======
    function setupToolbar(){
      $('#homeBtn').addEventListener('click', ()=>{ showNotification('Ù…Ø±Ø­Ø¨Ù‹Ø§! âœ¨', 'info'); });
      $('#refreshBtn').addEventListener('click', ()=> window.location.reload());
      $('#instructionsBtn').addEventListener('click', ()=> openModal('instructionsModal'));
      $('[data-close-modal="instructionsModal"]').addEventListener('click', ()=> closeModal('instructionsModal'));
      $('#fullscreenBtn').addEventListener('click', ()=>{
        if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); }
        else{ document.exitFullscreen?.(); }
      });
      $('#soundBtn').addEventListener('click', (e)=>{
        soundOn = !soundOn; const i = e.currentTarget.querySelector('i');
        i.classList.toggle('fa-volume-up', soundOn);
        i.classList.toggle('fa-volume-xmark', !soundOn);
        showNotification(soundOn? 'ğŸ”Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª' : 'ğŸ”‡ ØªÙ… ÙƒØªÙ… Ø§Ù„ØµÙˆØª', 'info');
      });
    }

    // ====== Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª ======
    function setupEventListeners(){
      $('#classSelect').addEventListener('change', onClassChange);
      $('#studentSelect').addEventListener('change', onStudentChange);
      $('#randomStudentBtn').addEventListener('click', pickRandomStudent);
      $('#timerDurationSelect').addEventListener('change', e=>{ customTimerDuration = parseInt(e.target.value,10) || 60; if(!gameState.isActive) { gameState.timeLeft = 0; $('#timerDisplay').textContent = '00:00'; } });

      // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¤Ù‚Øª
      $('#startBtn').addEventListener('click', startTimer);
      $('#pauseBtn').addEventListener('click', pauseTimer);
      $('#resetBtn').addEventListener('click', resetTimer);
      $('#newRoundBtn').addEventListener('click', newRound);

      // Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¬ÙˆÙ„Ø©
      $('#defuseBtn').addEventListener('click', handleDefuse);
      $('#explodeBtn').addEventListener('click', handleExplosion);

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      document.addEventListener('click', (e)=>{
        if(e.target.classList?.contains('modal')) closeModal(e.target.id);
      });
    }

    // ====== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ======
    document.addEventListener('DOMContentLoaded', ()=>{
      setupToolbar();
      setupEventListeners();
      loadClasses(); // âš ï¸ ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ fetch('../data/studentData.json')
      const sel = $('#timerDurationSelect'); customTimerDuration = parseInt(sel.value,10) || 60;
      $('#timerDisplay').textContent = '00:00';
      updateGameInfo();
    });
  </script>
</body>
</html>
