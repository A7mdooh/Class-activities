<!-- القنبلة الذكية | تجربة متكاملة واحترافية جداً -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>💣 القنبلة الذكية | الإصدار المتكامل</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ... سيتم تضمين CSS متقدم جداً مستوحى من برج الأسماء مع تخصيص كامل لأجواء القنبلة ... */
    body {
      font-family: 'Cairo', system-ui, sans-serif;
      background: radial-gradient(ellipse at 70% 0%, #1a1a2e 0%, #0e0f14 100%);
      color: #ffe066;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .top-toolbar {
      position: fixed; top: 0; left: 0; right: 0; height: 70px;
      background: linear-gradient(135deg,rgba(0,0,0,0.85) 0%,rgba(0,0,0,0.6) 50%,rgba(0,0,0,0.85) 100%);
      backdrop-filter: blur(18px); border-bottom: 2px solid #ffd70033;
      display: flex; align-items: center; justify-content: space-between; padding: 0 36px; z-index: 1000;
      box-shadow: 0 8px 30px #000a, inset 0 1px 0 #ffd70022;
      animation: toolbarSlideDown 1s cubic-bezier(0.25,0.46,0.45,0.94);
    }
    @keyframes toolbarSlideDown { 0%{opacity:0;transform:translateY(-100%);} 100%{opacity:1;transform:translateY(0);} }
    .game-logo { display: flex; align-items: center; gap: 12px; font-size: 2rem; font-weight: 900; color: #ffd700; letter-spacing: 1px; cursor: pointer; }
    .game-logo i { font-size: 2.2rem; animation: bombFloat 2.5s ease-in-out infinite; }
    @keyframes bombFloat { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-7px);} }
    .toolbar-icons { display: flex; gap: 18px; align-items: center; }
    .toolbar-icon { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg,#23243a 0%,#23243a 100%); border: 2px solid #ffd70055; display: flex; align-items: center; justify-content: center; color: #ffd700; font-size: 1.3rem; cursor: pointer; transition: all 0.2s; position: relative; }
    .toolbar-icon:hover { background: #ffd70022; color: #fff; border-color: #ffd700; box-shadow: 0 0 18px #ffd70088; }
    .container { max-width: 1200px; margin: 0 auto; padding: 90px 12px 32px 12px; }
    .main-title { text-align: center; margin-bottom: 32px; }
    .main-title h1 { font-size: 3.2rem; font-weight: 900; color: #ffd700; letter-spacing: 2px; text-shadow: 0 0 24px #ffd70055; }
    .main-title p { font-size: 1.2rem; color: #ffe066; opacity: 0.85; }
    /* ... المزيد من CSS المتقدم للبطاقات، إعدادات الصوت، واجهة القنبلة، العد التنازلي، المؤثرات ... */
  </style>
</head>
<body>
  <div class="top-toolbar">
    <div class="game-logo"><i class="fa-solid fa-bomb"></i> القنبلة الذكية</div>
    <div class="toolbar-icons">
      <div class="toolbar-icon" id="soundBtn" data-tooltip="الصوت"><i class="fa-solid fa-volume-up"></i></div>
      <div class="toolbar-icon" id="settingsBtn" data-tooltip="إعدادات"><i class="fa-solid fa-gear"></i></div>
    </div>
  </div>
  <div class="container">
    <div class="main-title">
      <h1>💣 القنبلة الذكية</h1>
      <p>تحدي تفاعلي متقدم — سباق مع الزمن، مؤثرات مذهلة، أدوار ذكية، أصوات ووميض وانفجار!</p>
    </div>
    <!-- شاشة الإعداد المتقدمة (اختيار الصف، الطلاب، إعدادات القنبلة، خيارات متقدمة) -->
    <div id="setupScreen" class="setup-screen">
      <div id="setupForm" style="max-width:600px;margin:0 auto;background:#23243aee;padding:2.5rem 2rem 2rem 2rem;border-radius:18px;box-shadow:0 8px 40px #0006;text-align:right;">
        <h2 style="color:#ffd700;font-size:2rem;margin-bottom:1.2rem;text-align:center;">إعداد التحدي</h2>
        <label style="font-weight:700;">اختر الصف:</label>
        <select id="classSelect" style="width:100%;padding:12px 10px;border-radius:10px;margin-bottom:1.2rem;font-size:1.1rem;"></select>
        <label style="font-weight:700;">اختر الطلاب المشاركين:</label>
        <div id="studentsGrid" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:1.2rem;"></div>
        <label style="font-weight:700;">عدد المشاركين في كل جولة:</label>
        <input type="number" id="perRound" min="1" max="10" value="3" style="width:80px;padding:6px 10px;border-radius:8px;margin-bottom:1.2rem;">
        <label style="font-weight:700;">مدة القنبلة (ثواني):</label>
        <input type="number" id="bombDuration" min="10" max="120" value="35" style="width:80px;padding:6px 10px;border-radius:8px;margin-bottom:1.2rem;">
        <div style="margin:1.5rem 0;text-align:center;">
          <button id="startGameBtn" class="start-btn" style="font-size:1.3rem;padding:18px 40px;border-radius:12px;background:linear-gradient(90deg,#ffd700,#ff9800);color:#23243a;font-weight:900;box-shadow:0 4px 18px #ffd70055;">ابدأ التحدي</button>
        </div>
      </div>
    </div>
    <!-- شاشة اللعبة -->
    <div id="gameScreen" class="game-screen" style="display:none">
      <div class="bomb-area" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px;">
        <div class="bomb-visual" id="bombVisual" style="width:180px;height:180px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #ffd700 0,#0e1328 60%);box-shadow:0 0 0 4px #0c1125 inset,0 0 32px #000a;position:relative;display:flex;align-items:center;justify-content:center;font-size:5rem;color:#ffd700;transition:transform .4s,filter .4s;">
          <div class="fuse" style="position:absolute;top:-36px;left:50%;transform:translateX(-50%);width:3px;height:60px;background:linear-gradient(#ffd700,#ff9800,#b45309);"></div>
          <div class="spark" style="position:absolute;top:-44px;left:calc(50% + 8px);width:14px;height:14px;border-radius:50%;background:#ffd43b;filter:drop-shadow(0 0 8px #ffd43b);animation:spark 1s linear infinite;"></div>
          💣
        </div>
        <div class="countdown" id="countdown" style="margin-top:18px;font-size:3.5rem;font-weight:900;letter-spacing:2px;text-shadow:0 0 10px #000a;color:#fff;">—</div>
        <div class="heat" style="width:320px;height:14px;border-radius:30px;border:1px solid #ffd70055;background:#12152a;overflow:hidden;margin:18px auto 0 auto;">
          <i id="heatFill" style="display:block;height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444);transition:width .5s;"></i>
        </div>
        <div class="students" id="selectedChips" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:18px 0 0 0;"></div>
        <div id="turnStatus" style="margin:18px 0 0 0;font-size:1.2rem;color:#ffd700;font-weight:700;"></div>
        <div style="margin:18px 0 0 0;display:flex;gap:12px;">
          <button id="pauseBtn" style="padding:10px 22px;border-radius:8px;background:#ffd700;color:#23243a;font-weight:700;font-size:1.1rem;">⏸️ إيقاف مؤقت</button>
          <button id="add5Btn" style="padding:10px 22px;border-radius:8px;background:#22c55e;color:#fff;font-weight:700;font-size:1.1rem;">+5 ثوانٍ</button>
          <button id="successBtn" style="padding:10px 22px;border-radius:8px;background:#22c55e;color:#fff;font-weight:700;font-size:1.1rem;">✅ نجاح</button>
          <button id="failBtn" style="padding:10px 22px;border-radius:8px;background:#ef4444;color:#fff;font-weight:700;font-size:1.1rem;">💥 انفجار</button>
        </div>
      </div>
      <div class="confetti" id="confetti"></div>
      <div class="flash" id="flash" style="position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:9998;"></div>
      <div class="notif-bar" id="notifBar2" style="position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#23243aee;color:#ffd700;border-radius:16px;box-shadow:0 4px 24px #0008;padding:1rem 2.2rem;font-size:1.2rem;z-index:2000;display:none;align-items:center;gap:0.7rem;"><span id="notifMsg2"></span></div>
    </div>
    <!-- شاشة النتائج -->
    <div id="resultsScreen" class="results-screen" style="display:none;text-align:center;margin-top:60px;">
      <div id="resultIcon" style="font-size:4rem;margin-bottom:18px;"></div>
      <div id="resultTitle" style="font-size:2.2rem;font-weight:900;color:#ffd700;margin-bottom:10px;"></div>
      <div id="resultText" style="font-size:1.2rem;color:#ffe066;margin-bottom:18px;"></div>
      <div id="resultBadges" style="margin-bottom:18px;"></div>
      <button id="closeResults" style="padding:12px 32px;border-radius:10px;background:#ffd700;color:#23243a;font-weight:900;font-size:1.2rem;">جولة جديدة</button>
    </div>
  </div>
  <script>
    // بيانات تجريبية للصفوف والطلاب (يمكن ربطها بملفات حقيقية لاحقاً)
    const DEMO_CLASSES = [
      {id:'A', name:'الصف الأول', students:[{id:1,name:'سالم',avatar:'👦'},{id:2,name:'مريم',avatar:'👧'},{id:3,name:'خالد',avatar:'👦'},{id:4,name:'سارة',avatar:'👧'},{id:5,name:'يوسف',avatar:'👦'},{id:6,name:'هند',avatar:'👧'}]},
      {id:'B', name:'الصف الثاني', students:[{id:7,name:'راشد',avatar:'👦'},{id:8,name:'ليلى',avatar:'👧'},{id:9,name:'عبدالله',avatar:'👦'},{id:10,name:'فاطمة',avatar:'👧'}]}
    ];
    let SELECTED_CLASS = null;
    let ALL_STUDENTS = [];
    let CURRENT_SELECTED = [];
    let PER_ROUND = 3;
    let BOMB_DURATION = 35;
    let ROUND_INDEX = 0;
    let ROUND_STUDENTS = [];
    let timer = null, timeLeft = 35, totalTime = 35, state = 'IDLE';
    // إعداد شاشة الإعداد
    function buildClassSelect() {
      const sel = document.getElementById('classSelect');
      sel.innerHTML = DEMO_CLASSES.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      sel.onchange = ()=>{
        SELECTED_CLASS = DEMO_CLASSES.find(c=>c.id===sel.value);
        ALL_STUDENTS = SELECTED_CLASS.students;
        buildStudentsGrid();
      };
      sel.value = DEMO_CLASSES[0].id;
      SELECTED_CLASS = DEMO_CLASSES[0];
      ALL_STUDENTS = SELECTED_CLASS.students;
    }
    function buildStudentsGrid() {
      const grid = document.getElementById('studentsGrid');
      grid.innerHTML = '';
      ALL_STUDENTS.forEach(s=>{
        const btn = document.createElement('button');
        btn.className = 'student-btn';
        btn.textContent = `${s.avatar||'👤'} ${s.name}`;
        btn.style = 'padding:10px 18px;border-radius:8px;background:#23243a;color:#ffd700;font-weight:700;font-size:1.1rem;border:2px solid #ffd70033;cursor:pointer;transition:.2s;';
        btn.onclick = ()=>{
          if(CURRENT_SELECTED.includes(s)){
            CURRENT_SELECTED = CURRENT_SELECTED.filter(x=>x!==s);
            btn.style.background = '#23243a';
            btn.style.color = '#ffd700';
          } else {
            CURRENT_SELECTED.push(s);
            btn.style.background = '#ffd700';
            btn.style.color = '#23243a';
          }
        };
        grid.appendChild(btn);
      });
    }
    buildClassSelect();
    buildStudentsGrid();
    document.getElementById('perRound').oninput = e=>{ PER_ROUND = Math.max(1,Math.min(10,parseInt(e.target.value)||3)); };
    document.getElementById('bombDuration').oninput = e=>{ BOMB_DURATION = Math.max(10,Math.min(120,parseInt(e.target.value)||35)); };
    // بدء اللعبة
    document.getElementById('startGameBtn').onclick = function() {
      if(CURRENT_SELECTED.length < 1){ alert('اختر الطلاب المشاركين أولاً'); return; }
      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'block';
      document.getElementById('resultsScreen').style.display = 'none';
      ROUND_INDEX = 0;
      nextRound();
    };
    // منطق الأدوار والجولات
    function nextRound() {
      if(CURRENT_SELECTED.length === 0){ showResults('END'); return; }
      ROUND_STUDENTS = CURRENT_SELECTED.slice(0, PER_ROUND);
      CURRENT_SELECTED = CURRENT_SELECTED.slice(PER_ROUND);
      document.getElementById('selectedChips').innerHTML = ROUND_STUDENTS.map(s=>`<div class='chip' style='background:#ffd70022;color:#ffd700;padding:8px 14px;border-radius:999px;margin:0 4px;font-weight:700;'>${s.avatar||'👤'} ${s.name}</div>`).join('');
      document.getElementById('turnStatus').textContent = `جولة ${ROUND_INDEX+1} — ${ROUND_STUDENTS.length} مشاركين`;
      startGame();
    }
    // نظام صوتي متقدم خاص بالقنبلة
    const sounds = {
      tick: new Audio('../assets/media/sounds/countdown-beep.mp3'),
      tickFast: new Audio('../assets/media/sounds/Notification.mp3'),
      alarm: new Audio('../assets/media/sounds/long-beep.mp3'),
      win: new Audio('../assets/media/sounds/win.mp3'),
      fail: new Audio('../assets/media/sounds/wrong_answer.mp3'),
      select: new Audio('../assets/media/sounds/select.mp3'),
      confetti: new Audio('../assets/media/sounds/kingdom-sounds/cosmic-explosion.mp3'),
      bonus: new Audio('../assets/media/sounds/kingdom-sounds/bonus-collect.mp3'),
      click: new Audio('../assets/media/sounds/Click.mp3')
    };
    let soundEnabled = true;
    let volume = 0.7;
    function playSound(name, force=false) {
      if (!soundEnabled && !force) return;
      if (sounds[name]) { sounds[name].volume = volume; sounds[name].currentTime = 0; sounds[name].play().catch(()=>{}); }
    }
    document.getElementById('settingsBtn').onclick = ()=>{
      document.getElementById('settingsModal').style.display = 'flex';
    };
    document.getElementById('closeSettings').onclick = ()=>{
      document.getElementById('settingsModal').style.display = 'none';
    };
    document.getElementById('volumeSlider').oninput = e=>{
      volume = parseFloat(e.target.value);
      Object.values(sounds).forEach(s=>s.volume=volume);
    };
    document.getElementById('soundToggle').onchange = e=>{
      soundEnabled = e.target.checked;
    };
    // إشعارات عصرية
    function showNotif2(msg, type='info', sec=2) {
      const bar = document.getElementById('notifBar2');
      document.getElementById('notifMsg2').textContent = msg;
      bar.style.display = 'flex';
      setTimeout(()=>bar.style.display='none', sec*1000);
      playSound('click',true);
    }
    // confetti
    function confettiBlast() {
      const box = document.getElementById('confetti');
      box.innerHTML = '';
      for(let i=0;i<120;i++){
        const p=document.createElement('i');
        p.style.cssText=`position:absolute;top:-10px;width:8px;height:12px;background:hsla(${Math.floor(Math.random()*360)},90%,60%,.95);transform:rotate(${Math.floor(Math.random()*360)}deg);animation:fall ${2+Math.random()*1.8}s linear forwards;left:${Math.random()*100}%`;
        box.appendChild(p);
      }
      setTimeout(()=>box.innerHTML='',3000);
      playSound('confetti');
    }
    // فلاش
    function doFlash() {
      const flash = document.getElementById('flash');
      flash.classList.remove('show'); void flash.offsetWidth; flash.classList.add('show');
    }
    // منطق اللعبة الذكي (لكل جولة)
    function startGame() {
      state = 'RUNNING';
      timeLeft = BOMB_DURATION;
      totalTime = BOMB_DURATION;
      updateBombVisual();
      if(timer) clearInterval(timer);
      timer = setInterval(()=>{
        timeLeft--;
        updateBombVisual();
        if (timeLeft === 10) { showNotif2('⚠️ آخر 10 ثوانٍ!','warn',2); playSound('tickFast'); document.getElementById('bombVisual').classList.add('yellow'); }
        if (timeLeft === 3) { showNotif2('🚨 اقترب الانفجار!','danger',2); playSound('alarm'); document.getElementById('bombVisual').classList.add('red','shake'); document.getElementById('countdown').classList.add('mega','danger'); doFlash(); }
        if (timeLeft <= 0) { clearInterval(timer); endGame(false); }
        else if (timeLeft < 10) playSound('tickFast');
        else playSound('tick');
      },1000);
    }
    function updateBombVisual() {
      document.getElementById('countdown').textContent = timeLeft > 0 ? timeLeft : '—';
      const fill = document.getElementById('heatFill');
      fill.style.width = ((1-(timeLeft/totalTime))*100)+'%';
    }
    function endGame(success) {
      state = success ? 'SUCCESS' : 'FAIL';
      if (success) {
        showNotif2('🎉 نجاح! أحسنت!');
        confettiBlast();
        playSound('win');
        showResults('SUCCESS');
      } else {
        showNotif2('💥 انفجرت القنبلة!');
        doFlash();
        playSound('fail');
        showResults('FAIL');
      }
      document.getElementById('bombVisual').classList.remove('yellow','red','shake');
      document.getElementById('countdown').classList.remove('mega','danger');
    }
    // تحكم المعلم أثناء الجولة
    document.getElementById('pauseBtn').onclick = ()=>{
      if(state==='RUNNING'){ clearInterval(timer); state='PAUSED'; showNotif2('⏸️ تم الإيقاف المؤقت','info',2); }
      else if(state==='PAUSED'){ startGame(); showNotif2('▶️ استئناف','info',1); }
    };
    document.getElementById('add5Btn').onclick = ()=>{ timeLeft+=5; showNotif2('⏫ +5 ثوانٍ!','success',1); updateBombVisual(); playSound('bonus'); };
    document.getElementById('successBtn').onclick = ()=>{ clearInterval(timer); endGame(true); };
    document.getElementById('failBtn').onclick = ()=>{ clearInterval(timer); endGame(false); };
    // اختصارات متقدمة
    window.addEventListener('keydown',e=>{
      if(state==='RUNNING'){
        if(e.key===' '){ document.getElementById('pauseBtn').click(); }
        if(e.key==='Enter'){ document.getElementById('successBtn').click(); }
        if(e.key==='Escape'){ document.getElementById('failBtn').click(); }
        if(e.key==='ArrowUp'){ document.getElementById('add5Btn').click(); }
      } else if(state==='PAUSED' && e.key===' '){ document.getElementById('pauseBtn').click(); }
    });
    // شاشة النتائج
    function showResults(type) {
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('resultsScreen').style.display = 'block';
      let icon = '', title = '', text = '', badges = '';
      if(type==='SUCCESS'){
        icon = '🎉';
        title = 'ممتاز!';
        text = 'تمت المهمة بنجاح.';
        badges = '<span style="background:#22c55e;color:#fff;padding:8px 18px;border-radius:999px;margin:0 4px;font-weight:700;">🏅 سريع الرد</span>';
      } else if(type==='FAIL'){
        icon = '💥';
        title = 'انفجرت القنبلة!';
        text = 'حاولوا مرة أخرى.';
      } else {
        icon = '⏹️';
        title = 'انتهت الجولات';
        text = 'تم إنهاء جميع الجولات.';
      }
      document.getElementById('resultIcon').textContent = icon;
      document.getElementById('resultTitle').textContent = title;
      document.getElementById('resultText').textContent = text;
      document.getElementById('resultBadges').innerHTML = badges;
    }
    document.getElementById('closeResults').onclick = ()=>{
      if(CURRENT_SELECTED.length > 0){
        ROUND_INDEX++;
        document.getElementById('resultsScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        nextRound();
      } else {
        // إعادة التحدي
        document.getElementById('resultsScreen').style.display = 'none';
        document.getElementById('setupScreen').style.display = 'block';
        // إعادة تعيين
        CURRENT_SELECTED = [];
        buildStudentsGrid();
      }
    };
  </script>
</body>
</html>
  }catch(err){
    console.error('فشل جلب البيانات', err);
    const holder = document.getElementById('classGrid');
    holder.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'tile';
    box.innerHTML = '<b>تعذر تحميل البيانات</b><br><small>تحقق من المسار data/studentData.json ثم أعد المحاولة.</small>';
    const retry = document.createElement('button');
    retry.className = 'btn warn';
    retry.textContent = 'إعادة المحاولة';
    retry.onclick = loadData;
    holder.appendChild(box);
    holder.appendChild(retry);
  }
}

/* ===================== المراجع ===================== */
const viewsRoot = document.getElementById('viewsRoot');
const teacherTab = document.getElementById('teacherTab');
const studentTab = document.getElementById('studentTab');

const sectionClass    = document.getElementById('sectionClass');
const sectionStudents = document.getElementById('sectionStudents');
const sectionStage    = document.getElementById('sectionStage');

const classGrid    = document.getElementById('classGrid');
const studentsGrid = document.getElementById('studentsGrid');
const selectedChips= document.getElementById('selectedChips');
const limitSpan    = document.getElementById('limitSpan');

const elDifficulty = document.getElementById('difficulty');
const elDuration   = document.getElementById('duration');
const elPerPlayer  = document.getElementById('perPlayer');
const elPerRound   = document.getElementById('perRound');
const elSoundOn    = document.getElementById('soundOn');
const elAllowSur   = document.getElementById('allowSurprises');
const elFairPick   = document.getElementById('fairPick');
const phaseSelect  = document.getElementById('phase');

const startBtn   = document.getElementById('startBtn');
const pauseBtn   = document.getElementById('pauseBtn');
const add5Btn    = document.getElementById('add5Btn');
const successBtn = document.getElementById('successBtn');
const failBtn    = document.getElementById('failBtn');

const countdownEl = document.getElementById('countdown');
const heatFill    = document.getElementById('heatFill');
const bomb        = document.getElementById('bomb');
const flash       = document.getElementById('flash');
const resultsEl   = document.getElementById('results');
const resultIcon  = document.getElementById('resultIcon');
const resultTitle = document.getElementById('resultTitle');
const resultText  = document.getElementById('resultText');
const resultBadges= document.getElementById('resultBadges');
const closeResults= document.getElementById('closeResults');
const confettiBox = document.getElementById('confetti');

const turnList   = document.getElementById('turnList');
const turnStatus = document.getElementById('turnStatus');
const logEl      = document.getElementById('log');

/* ===================== حالات وصعوبات ===================== */
const Difficulty = {
  Easy:    { duration: 60, pace: "slow",  surpriseProb: 0.05, effects:{ shake:false, flashAtEnd:true } },
  Medium:  { duration: 35, pace: "mid",   surpriseProb: 0.08, effects:{ shake:true,  flashAtEnd:true } },
  Hard:    { duration: 20, pace: "fast",  surpriseProb: 0.12, effects:{ shake:true,  flashAtEnd:true } },
  Custom:  { duration: 45, pace: "mid",   surpriseProb: 0.10, effects:{ shake:true,  flashAtEnd:true } }
};

const Bus = (()=>{ const m=new Map(); return { on:(e,h)=>m.set(e,(m.get(e)||[]).concat(h)), emit:(e,p)=> (m.get(e)||[]).forEach(h=>h(p)) }})();
const GameState = (()=>{ let s="IDLE"; const T={ IDLE:["ARMING"], ARMING:["RUNNING","IDLE"], RUNNING:["PAUSED","SUCCESS","FAIL","RESULTS"], PAUSED:["RUNNING","RESULTS"], SUCCESS:["RESULTS"], FAIL:["RESULTS"], RESULTS:["IDLE","ARMING"] }; return { get:()=>s, to:(n)=>{ if((T[s]||[]).includes(n)){ s=n; Bus.emit("state",s);} } }})();

/* ===================== صوتيات خفيفة ===================== */
const Sound = (() => {
  let ctx=null, enabled=true; function ensure(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(freq=880,ms=80,type="sine",gain=0.035){ if(!enabled) return; ensure(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+ms/1000);} 
  return {
    enable(v){enabled=!!v; if(enabled) ensure();}, resume(){ if(ctx && ctx.state==="suspended") ctx.resume(); },
    tickSlow:()=>beep(680,28,"square",.03), tickFast:()=>beep(900,24,"square",.035), heart:()=>{beep(120,60,"sine",.06); setTimeout(()=>beep(120,60,"sine",.06),120);}, alarm:()=>beep(1100,130,"sawtooth",.05), success:()=>{beep(660,120,"triangle",.05); setTimeout(()=>beep(880,140,"triangle",.05),150);}, boom:()=>{beep(80,200,"sawtooth",.08); setTimeout(()=>beep(50,260,"sawtooth",.08),120);} }
})();

/* ===================== مؤقّت rAF ===================== */
function createTimer(totalMs){
  let left=totalMs, id=null, last=performance.now(); const marks=new Set();
  function tick(now){ left -= now-last; last=now; Bus.emit("timer:tick",{left,seconds:Math.ceil(left/1000), total: totalMs}); const s=Math.ceil(left/1000); const half=Math.ceil(totalMs/2000);
    if(!marks.has("half") && s===half){ marks.add("half"); Bus.emit("timer:flag","half"); }
    if(!marks.has("last10") && s===10){ marks.add("last10"); Bus.emit("timer:flag","last10"); }
    if(s<=3){ Bus.emit("timer:flag","last3"); }
    if(left<=0){ cancelAnimationFrame(id); id=null; Bus.emit("timer:end"); return; }
    id=requestAnimationFrame(tick);
  }
  return { start(){ last=performance.now(); id=requestAnimationFrame(tick); Bus.emit("timer:start",{totalMs}); }, pause(){ if(id){ cancelAnimationFrame(id); id=null; Bus.emit("timer:pause",{left}); } }, resume(){ if(!id){ last=performance.now(); id=requestAnimationFrame(tick); Bus.emit("timer:resume",{left}); } }, add(ms){ left+=ms; Bus.emit("timer:add",{left,ms}); }, get left(){return left;} }
}

/* ===================== أدوات واجهة ===================== */
function log(msg){ const t=new Date().toLocaleTimeString(); logEl.innerHTML = `<div>[${t}] ${msg}</div>` + logEl.innerHTML; }
function setStartEnabled(v){ startBtn.disabled=!v; }
function setControls(running){ pauseBtn.disabled=add5Btn.disabled=successBtn.disabled=failBtn.disabled=!running; }
function toast(text){ const t=document.createElement('div'); t.style.cssText="position:absolute;top:16px;left:50%;transform:translateX(-50%);background:#111834;border:1px solid #2a3159;color:#eaf;padding:8px 12px;border-radius:999px;z-index:9"; t.textContent=text; document.getElementById('stage').appendChild(t); setTimeout(()=>t.remove(), 1400); }
function doFlash(){ flash.classList.remove("show"); void flash.offsetWidth; flash.classList.add("show"); }
function boom(){ document.getElementById('stage').classList.add("shake-hard"); doFlash(); Sound.boom(); setTimeout(()=>document.getElementById('stage').classList.remove("shake-hard"),600); }
function confetti(){ const box=document.getElementById('confetti'); box.innerHTML=""; for(let i=0;i<120;i++){ const p=document.createElement("i"); p.style.cssText=`position:absolute;top:-10px;width:8px;height:12px;background:hsla(${Math.floor(Math.random()*360)},90%,60%,.95);transform:rotate(${Math.floor(Math.random()*360)}deg);animation:fall ${2+Math.random()*1.8}s linear forwards;left:${Math.random()*100}%`; box.appendChild(p);} setTimeout(()=>box.innerHTML="",3000); }

/* ===================== بيانات جلسة ===================== */
let SELECTED_CLASS = null;
let ALL_STUDENTS = {}; // by classId
let CURRENT_SELECTED = []; // [{id,name,avatar}]
let TURN_INDEX = 0;
let GLOBAL_TIMER = null; let TURN_TIMER = null;

const Stats = (()=> { const key="bomb-pro-stats"; const store=JSON.parse(localStorage.getItem(key) || '{"session":{"total":0,"success":0,"fail":0},"students":{}}'); function save(){ localStorage.setItem(key, JSON.stringify(store)); }
  function recordRound(res){ store.session.total++; if(res.outcome==="SUCCESS") store.session.success++; else if(res.outcome==="FAIL") store.session.fail++; res.selectedStudents.forEach(s=>{ const st=store.students[s.id] || (store.students[s.id]={ name:s.name, points:0, rounds:0, success:0 }); st.rounds++; if(res.outcome==="SUCCESS"){ st.success++; st.points += res.pointsAwarded[s.id]||0; } }); save(); updateKPIs(); updateStudentPanels(); }
  function k(){ return store.session; } function getStudent(id){ return store.students[id]; } return { recordRound, k, getStudent } })();
function updateKPIs(){ const k=Stats.k(); document.getElementById('kRounds').textContent=k.total; document.getElementById('kWins').textContent=k.success; document.getElementById('kFails').textContent=k.fail; }

/* ===================== بناء الواجهات: صفوف وطلاب ===================== */
function buildClassGrid(){
  classGrid.innerHTML = '';
  if(!Array.isArray(DATA.classes) || DATA.classes.length===0){
    const emp = document.createElement('div'); emp.className='tile'; emp.innerHTML='<small>لا توجد صفوف في البيانات.</small>'; classGrid.appendChild(emp); return;
  }
  DATA.classes.forEach(c=>{
    const it = document.createElement('button');
    it.className = 'card-item';
    it.setAttribute('role','listitem');
    const icon = document.createElement('div'); icon.style.fontSize='26px'; icon.textContent = c.icon || '🏫';
    const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = c.name || c.id;
    it.append(icon, name);
    it.onclick = ()=> selectClass(c.id);
    classGrid.appendChild(it);
  });
}</div><div style="font-weight:700">${c.name}</div>`; it.onclick=()=> selectClass(c.id); classGrid.appendChild(it); }); }
function selectClass(id){
  SELECTED_CLASS = id;
  ALL_STUDENTS = DATA.students || {};
  sectionClass.hidden = true;
  sectionStudents.hidden = false;
  sectionStage.hidden = true;
  phaseSelect.value = 'selectStudents';
  buildStudentsGrid();
  log(`اختيار الصف: ${id}`);
}`); }
function buildStudentsGrid(){ const arr = [...(ALL_STUDENTS[SELECTED_CLASS]||[])]; studentsGrid.innerHTML=""; arr.forEach(s=>{ const b=document.createElement('button'); b.className='card-item'; b.setAttribute('role','listitem'); b.onclick=()=> toggleStudent(s,b); const label=document.createElement('div'); label.style.fontWeight='700'; label.textContent=s.name; const emo=document.createElement('div'); emo.style.fontSize='22px'; emo.textContent=s.avatar||'👤'; b.appendChild(emo); b.appendChild(label); studentsGrid.appendChild(b); }); updateSelectedChips(); updateStartButton(); }
function toggleStudent(s,btn){ const idx = CURRENT_SELECTED.findIndex(x=>x.id===s.id); const limit = Number(elPerRound.value||1); if(idx>=0){ CURRENT_SELECTED.splice(idx,1); btn.classList.remove('active'); } else { if(CURRENT_SELECTED.length>=limit){ toast(`الحد ${limit} طلاب.`); return; } CURRENT_SELECTED.push({...s}); btn.classList.add('active'); } updateSelectedChips(); updateStartButton(); }
function updateSelectedChips(){ selectedChips.innerHTML=""; CURRENT_SELECTED.forEach(s=>{ const chip=document.createElement('div'); chip.className='chip'; const i=document.createElement('i'); i.textContent=s.avatar||'👤'; const b=document.createElement('b'); b.textContent=s.name; chip.append(i,b); selectedChips.appendChild(chip); }); limitSpan.textContent=String(elPerRound.value||1); buildTurnList(); }
function buildTurnList(){ turnList.innerHTML=""; if(CURRENT_SELECTED.length===0){ turnList.innerHTML='<small>لا مشاركين بعد.</small>'; return; } CURRENT_SELECTED.forEach((s,idx)=>{ const t=document.createElement('div'); t.className='row'; t.innerHTML = `<div class="chip" style="flex:none"><i>${s.avatar||'👤'}</i><b>${s.name}</b></div><div style="font-size:.9rem;color:var(--muted)">${idx===TURN_INDEX? '🎯 الدور الحالي' : '… بانتظار الدور'}</div>`; turnList.appendChild(t); }); }

/* ===================== تبديل المراحل يدويًا (للمعاينة) ===================== */
phaseSelect.addEventListener('change',()=>{ const ph=phaseSelect.value; sectionClass.hidden = ph!=='selectClass'; sectionStudents.hidden = ph!=='selectStudents'; sectionStage.hidden = ph!=='stage'; });

/* ===================== بدء التحدي ===================== */
function updateStartButton(){ startBtn.disabled = CURRENT_SELECTED.length===0; }
function startChallenge(){ if(CURRENT_SELECTED.length===0){ alert('اختر الطلاب أولاً'); return; } Sound.resume(); setStartEnabled(false); setControls(true);
  // تهيئة مشهد القنبلة
  sectionClass.hidden=true; sectionStudents.hidden=true; sectionStage.hidden=false; phaseSelect.value='stage';
  // إعدادات
  const d = Difficulty[elDifficulty.value] || Difficulty.Medium; if(elDifficulty.value!=="Custom") elDuration.value=d.duration; const total = Number(elDuration.value||d.duration)*1000; const per = Number(elPerPlayer.value||15)*1000; const allowSur = elAllowSur.checked; const pace=d.pace; 
  // ARming
  GameState.to('ARMING'); countdownEl.textContent='جاهز؟'; bomb.classList.remove('yellow','red','shake-soft','shake-hard');
  setTimeout(()=>{
    // RUNNING
    GameState.to('RUNNING');
    startGlobal(total, per, { allowSur, pace, surpriseProb:d.surpriseProb });
  }, 1500);
}

function startGlobal(totalMs, perPlayerMs, options){
  // مؤقّت كلي
  GLOBAL_TIMER = createTimer(totalMs);
  let paceTimer=null; function setPace(mode){ if(paceTimer) clearInterval(paceTimer); if(mode==='slow') paceTimer=setInterval(Sound.tickSlow,1000); if(mode==='mid') paceTimer=setInterval(Sound.tickFast,700); if(mode==='fast') paceTimer=setInterval(Sound.tickFast,450); }
  setPace(options.pace);
  // مفاجأة
  if(options.allowSur && Math.random() < (options.surpriseProb||0.08)) setTimeout(()=>{ GLOBAL_TIMER.add(5000); toast('🎁 مفاجأة +5s'); }, 4000 + Math.random()*5000);

  attachTeacherControls(GLOBAL_TIMER, declareSuccess, declareFail);
  TURN_INDEX = 0; startTurn(perPlayerMs);

  Bus.on('timer:tick', ({left,seconds,total})=>{ countdownEl.textContent=seconds; const p=Math.max(0, Math.min(1, 1-(left/total))); heatFill.style.width=(p*100)+'%'; if(p>.5 && p<.8) bomb.classList.add('yellow'); if(p>=.8) bomb.classList.add('red'); turnStatus.textContent = `الوقت المتبقي للجولة: ${seconds}s`;
  });
  Bus.on('timer:flag', tag=>{ if(tag==='half') log('✳️ نصف الوقت'); if(tag==='last10'){ bomb.classList.add('shake-soft'); toast('⚠️ آخر 10 ثوانٍ'); } if(tag==='last3'){ countdownEl.classList.add('mega','danger'); Sound.alarm(); } });
  Bus.on('timer:end', ()=>{ boom(); declareFail(); });
  GLOBAL_TIMER.start();

  function declareSuccess(){ if(GameState.get()!=='RUNNING' && GameState.get()!=='PAUSED') return; GLOBAL_TIMER.pause(); GameState.to('SUCCESS'); showResults({ outcome:'SUCCESS', selectedStudents: CURRENT_SELECTED }); }
  function declareFail(){ if(GameState.get()!=='RUNNING' && GameState.get()!=='PAUSED') return; GLOBAL_TIMER.pause(); GameState.to('FAIL'); boom(); showResults({ outcome:'FAIL', selectedStudents: CURRENT_SELECTED }); }
}

function startTurn(perMs){ updateTurnUI(); TURN_TIMER && TURN_TIMER.pause(); TURN_TIMER=null; let left=perMs; const s = CURRENT_SELECTED[TURN_INDEX]; turnStatus.textContent=`🎯 دور ${s.name} — ${Math.ceil(left/1000)}s`;
  const id = setInterval(()=>{ left-=1000; updateTurnUI(); if(left<=0){ clearInterval(id); nextTurn(perMs); }
  },1000);
  // خفّة: نبضة قلب خفيفة مع كل ثانية
  const hb = setInterval(()=> Sound.heart(), 2000);
  TURN_TIMER = { pause(){ clearInterval(id); clearInterval(hb); }, resume(){ /* مبسّطة: لا حاجة الآن */ } };
}
function nextTurn(perMs){ TURN_INDEX++; if(TURN_INDEX>=CURRENT_SELECTED.length){ // انتهت الأدوار — المعلم يقرر نجاحًا أو يستمر حتى نهاية الوقت
  toast('انتهت الأدوار — أعلن النتيجة'); return; } startTurn(perMs); }
function updateTurnUI(){ buildTurnList(); const s = CURRENT_SELECTED[TURN_INDEX]; const secs = Math.max(0, Number(elPerPlayer.value||15)); turnStatus.textContent=`🎯 الدور الحالي: ${s.name} — ${secs}s لكل لاعب`; }

/* ===================== نتائج ===================== */
function showResults({ outcome, selectedStudents }){ const award = (outcome==='SUCCESS') ? 10 : 0; const result = { roundId: crypto.randomUUID(), selectedStudents, outcome, pointsAwarded:Object.fromEntries(selectedStudents.map(s=>[s.id, award])) };
  Stats.recordRound(result);
  if(outcome==='SUCCESS'){ resultIcon.textContent='🎉'; resultTitle.textContent='ممتاز!'; resultText.textContent='تمت المهمة بنجاح.'; confetti(); Sound.success(); resultBadges.innerHTML='<span class="badge">🏅 سريع الرد</span><span class="badge">💬 إجابة واثقة</span>'; }
  else if(outcome==='FAIL'){ resultIcon.textContent='💥'; resultTitle.textContent='انفجرت القنبلة!'; resultText.textContent='حاولوا مرة أخرى.'; }
  else { resultIcon.textContent='⏹️'; resultTitle.textContent='تم الإيقاف'; resultText.textContent='إنهاء مبكر للجولة.'; }
  resultsEl.classList.add('show');
}
closeResults.onclick = ()=>{ resultsEl.classList.remove('show'); setStartEnabled(true); setControls(false); countdownEl.classList.remove('mega','danger','warn'); };

/* ===================== تحكّم المعلم أثناء الجولة ===================== */
function attachTeacherControls(timer, onSuccess, onFail){ pauseBtn.onclick = ()=>{ if(GameState.get()==='RUNNING'){ timer.pause(); pauseBtn.textContent='استئناف ▶️'; GameState.to('PAUSED'); log('PAUSED'); } else if(GameState.get()==='PAUSED'){ timer.resume(); pauseBtn.textContent='إيقاف مؤقت ⏸'; GameState.to('RUNNING'); log('RESUMED'); } };
  add5Btn.onclick = ()=> timer.add(5000);
  successBtn.onclick = ()=> onSuccess();
  failBtn.onclick    = ()=> onFail();
}

/* ===================== تبويب المعلم/الطلاب في نفس الصفحة ===================== */
teacherTab.addEventListener('click',()=>{ teacherTab.classList.add('active'); teacherTab.setAttribute('aria-pressed','true'); studentTab.classList.remove('active'); studentTab.setAttribute('aria-pressed','false'); viewsRoot.classList.add('teacher-view'); viewsRoot.classList.remove('student-view'); });
studentTab.addEventListener('click',()=>{ studentTab.classList.add('active'); studentTab.setAttribute('aria-pressed','true'); teacherTab.classList.remove('active'); teacherTab.setAttribute('aria-pressed','false'); viewsRoot.classList.add('student-view'); viewsRoot.classList.remove('teacher-view'); });

/* ===================== تفاعلات الإعدادات ===================== */
elDifficulty.addEventListener('change',()=>{ const d=Difficulty[elDifficulty.value]; if(elDifficulty.value!=="Custom") elDuration.value=d.duration; });
elSoundOn.addEventListener('change',()=> Sound.enable(elSoundOn.checked) );
elPerRound.addEventListener('change',()=>{ if(CURRENT_SELECTED.length>Number(elPerRound.value||1)){ CURRENT_SELECTED.length = Number(elPerRound.value||1); buildStudentsGrid(); } updateSelectedChips(); updateStartButton(); });

/* ===================== Hotkeys ===================== */
window.addEventListener('keydown',(e)=>{ if(e.key===' '){ e.preventDefault(); pauseBtn.click(); } if(e.key==='Enter'){ e.preventDefault(); successBtn.click(); } if(e.key==='Escape'){ e.preventDefault(); failBtn.click(); } if(e.key==='ArrowUp'){ e.preventDefault(); add5Btn.click(); } });

/* ===================== تفعيل/تعطيل الأزرار حسب المرحلة ===================== */
function refreshPhase(){ const ph=phaseSelect.value; startBtn.disabled = (CURRENT_SELECTED.length===0) || ph!=='selectStudents'; pauseBtn.disabled=add5Btn.disabled=successBtn.disabled=failBtn.disabled = (ph!=='stage'); }
phaseSelect.addEventListener('change', refreshPhase);

/* ===================== ربط زر البدء ===================== */
startBtn.addEventListener('click', startChallenge);

/* ===================== تحديث لوحات الطلاب (يمين) ===================== */
function updateStudentPanels(){ CURRENT_SELECTED.forEach(s=>{ /* يمكن لاحقًا عرض نقاط/نجاحات من Stats.getStudent(s.id) */ }); }

/* ===================== تشغيل أولي ===================== */
loadData();
updateKPIs();
refreshPhase();
</script>
</body>
</html>
