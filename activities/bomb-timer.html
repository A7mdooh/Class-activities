<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>💣 القنبلة الذكية | Teacher & Student</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .role-switcher { position: fixed; top: 10px; left: 10px; z-index: 9999; }
    .role-switcher button { margin-left: 0.5rem; font-size: 1rem; padding: 0.4rem 1.2rem; border-radius: 18px; border: none; background: #ffd700; color: #232526; font-weight: bold; cursor: pointer; }
    .role-switcher button.active { background: #00e676; color: #232526; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- تبديل الدور -->
  <div class="role-switcher">
    <span>الوضع:</span>
    <button id="teacherModeBtn" class="active">المعلم</button>
    <button id="studentModeBtn">الطالب</button>
  </div>
  <div id="teacherView">
    <div class="container">
      <section id="classSelectSection">
        <h2>اختر الصف</h2>
        <div id="classGrid" class="class-grid"></div>
      </section>
      <section id="studentSelectSection" style="display:none;">
        <h2>اختر الطلاب المشاركين</h2>
        <div id="studentsGrid" class="students-grid"></div>
        <button id="startChallengeBtn" class="main-btn" disabled>بدء التحدي</button>
      </section>
      <section id="bombStage" style="display:none;">
        <div class="bomb-area">
          <div class="bomb" id="bombVisual">💣</div>
          <div class="timer" id="globalTimer">00:00</div>
          <div id="heatMeter" class="heat-meter"></div>
          <div id="turnInfo"></div>
          <div id="teacherPanel" class="teacher-panel">
            <button id="pauseBtn" aria-label="إيقاف مؤقت">⏸</button>
            <button id="resumeBtn" aria-label="استئناف" style="display:none;">▶️</button>
            <button id="addTimeBtn" aria-label="+5 ثوانٍ">+5s</button>
            <button id="successBtn" aria-label="نجاح">✔️</button>
            <button id="failBtn" aria-label="فشل">💥</button>
          </div>
          <div id="eventLog" class="event-log"></div>
        </div>
      </section>
    </div>
  </div>
  <div id="studentView" class="hidden">
    <div class="container">
      <section id="waitingSection">
        <div class="bomb bomb-sleep">💣💤</div>
        <div class="waiting-msg">بانتظار بدء التحدي من المعلم...</div>
      </section>
      <section id="studentBombStage" style="display:none;">
        <div class="bomb-area">
          <div class="bomb" id="studentBombVisual">💣</div>
          <div class="timer" id="studentGlobalTimer">00:00</div>
          <div id="turnList" class="turn-list"></div>
          <div id="studentTurnInfo"></div>
        </div>
      </section>
    </div>
  </div>
  <script>
    // --- إعداد تبديل الدور ---
    const teacherView = document.getElementById('teacherView');
    const studentView = document.getElementById('studentView');
    document.getElementById('teacherModeBtn').onclick = () => {
      teacherView.classList.remove('hidden');
      studentView.classList.add('hidden');
      document.getElementById('teacherModeBtn').classList.add('active');
      document.getElementById('studentModeBtn').classList.remove('active');
    };
    document.getElementById('studentModeBtn').onclick = () => {
      teacherView.classList.add('hidden');
      studentView.classList.remove('hidden');
      document.getElementById('teacherModeBtn').classList.remove('active');
      document.getElementById('studentModeBtn').classList.add('active');
    };
    // --- بيانات تجريبية للصفوف والطلاب ---
    const demoData = {
      'الصف الأول': ['أحمد','سارة','محمد','ليان','سلمان','جود'],
      'الصف الثاني': ['خالد','ريم','يوسف','هند','سيف','مها'],
      'الصف الثالث': ['سعيد','نورة','راشد','جمانة','طارق','شهد']
    };
  let selectedClass = null;
  let selectedStudents = [];
    let gameState = 'IDLE';
    let turnIndex = 0;
    let roundConfig = { totalSeconds: 35, perPlayerSeconds: 8 };
    let globalTimer = null, turnTimer = null;
    // --- واجهة المعلم ---
    function buildClassGrid() {
      const grid = document.getElementById('classGrid');
      grid.innerHTML = '';
      Object.keys(demoData).forEach(className => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.textContent = className;
        card.onclick = () => selectClass(className, card);
        grid.appendChild(card);
      });
    }
    function selectClass(className, card) {
      selectedClass = className;
      selectedStudents = [];
      document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      document.getElementById('classSelectSection').style.display = 'none';
      document.getElementById('studentSelectSection').style.display = '';
      buildStudentsGrid();
    }
    function buildStudentsGrid() {
      const grid = document.getElementById('studentsGrid');
      grid.innerHTML = '';
      if (!selectedClass) return;
      demoData[selectedClass].forEach(name => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.textContent = name;
        card.onclick = () => toggleStudent(card, name);
        if (selectedStudents.includes(name)) card.classList.add('selected');
        grid.appendChild(card);
      });
      document.getElementById('startChallengeBtn').disabled = selectedStudents.length === 0;
    }
    function toggleStudent(card, name) {
      if (selectedStudents.includes(name)) {
        selectedStudents = selectedStudents.filter(n => n !== name);
        card.classList.remove('selected');
      } else {
        selectedStudents.push(name);
        card.classList.add('selected');
      }
      document.getElementById('startChallengeBtn').disabled = selectedStudents.length === 0;
    }
    document.getElementById('startChallengeBtn').onclick = startChallenge;
    function startChallenge() {
      if (!selectedClass || selectedStudents.length === 0) return;
      gameState = 'ARMING';
      document.getElementById('studentSelectSection').style.display = 'none';
      document.getElementById('bombStage').style.display = '';
      // تمهيد قصير
      setTimeout(()=>{
        gameState = 'RUNNING';
        startGlobalTimer();
        startTurn(0);
      }, 1800);
    }
    // --- المؤقتات والأدوار ---
    function startGlobalTimer() {
      let left = roundConfig.totalSeconds;
      document.getElementById('globalTimer').textContent = formatTime(left);
      if (globalTimer) clearInterval(globalTimer);
      globalTimer = setInterval(()=>{
        left--;
        document.getElementById('globalTimer').textContent = formatTime(left);
        updateHeatMeter(left);
        if (left <= 0) {
          clearInterval(globalTimer);
          endGame('FAIL');
        }
      }, 1000);
    }
    function startTurn(idx) {
      turnIndex = idx;
      updateTurnInfo();
      let left = roundConfig.perPlayerSeconds;
      if (turnTimer) clearInterval(turnTimer);
      turnTimer = setInterval(()=>{
        left--;
        updateTurnInfo(left);
        if (left <= 0) {
          clearInterval(turnTimer);
          if (turnIndex < selectedStudents.length-1) startTurn(turnIndex+1);
          else endGame('SUCCESS');
        }
      }, 1000);
    }
    function updateTurnInfo(left) {
      const info = document.getElementById('turnInfo');
      if (gameState !== 'RUNNING') { info.textContent = ''; return; }
      const name = selectedStudents[turnIndex];
      info.textContent = `دور: ${name}  ${(left!==undefined? '⏳ '+left+'s':'')}`;
    }
    function updateHeatMeter(left) {
      const meter = document.getElementById('heatMeter');
      const percent = 100 - Math.round((left/roundConfig.totalSeconds)*100);
      meter.innerHTML = `<div class='heat-meter-bar' style='width:${percent}%;'></div>`;
    }
    function endGame(result) {
      gameState = result;
      document.getElementById('turnInfo').textContent = result==='SUCCESS'?'🎉 نجاح!':'💥 انفجرت القنبلة!';
      if (globalTimer) clearInterval(globalTimer);
      if (turnTimer) clearInterval(turnTimer);
    }
    // --- أدوات مساعدة ---
    function formatTime(sec) {
      sec = Math.max(0, Math.round(sec));
      return '00:' + String(sec).padStart(2, '0');
    }
    // --- واجهة الطالب ---
    // (تزامن داخلي: الطالب يقرأ الحالة من متغيرات المعلم)
    function updateStudentView() {
      const waiting = document.getElementById('waitingSection');
      const bombStage = document.getElementById('studentBombStage');
      if (gameState === 'IDLE' || gameState === 'ARMING') {
        waiting.style.display = '';
        bombStage.style.display = 'none';
      } else if (gameState === 'RUNNING') {
        waiting.style.display = 'none';
        bombStage.style.display = '';
        updateStudentBomb();
      } else {
        waiting.style.display = 'none';
        bombStage.style.display = '';
        document.getElementById('studentTurnInfo').textContent = (gameState==='SUCCESS'?'🎉 نجاح!':'💥 انفجرت القنبلة!');
      }
    }
    function updateStudentBomb() {
      document.getElementById('studentGlobalTimer').textContent = document.getElementById('globalTimer').textContent;
      // قائمة الأدوار
      const turnList = document.getElementById('turnList');
      turnList.innerHTML = '';
      selectedStudents.forEach((name,i)=>{
        const el = document.createElement('div');
        el.className = 'turn-student'+(i===turnIndex?' active':'');
        el.textContent = name;
        turnList.appendChild(el);
      });
      document.getElementById('studentTurnInfo').textContent = `دور: ${selectedStudents[turnIndex]}`;
    }
    // --- مراقبة التغيرات لتحديث واجهة الطالب ---
    setInterval(updateStudentView, 500);
    // --- بدء ---
    buildClassGrid();
  </script>
</body>
</html>
  <!-- شريط الأدوات العلوي -->
  <div class="top-toolbar">
    <div class="game-logo" style="font-size:1.5rem; font-weight:900; color:#ffd700; display:flex; align-items:center; gap:0.7rem;">
      <span>💣</span> القنبلة الذكية
    </div>
    <div class="toolbar-icons">
      <button class="toolbar-icon" id="notifBtn" title="الإشعارات"><i class="fa fa-bell"></i></button>
      <button class="toolbar-icon" id="progressBtn" title="شريط التقدم"><i class="fa fa-trophy"></i></button>
      <button class="toolbar-icon sound-icon" id="soundBtn" title="الصوت"><i class="fa fa-volume-up"></i></button>
      <button class="toolbar-icon" id="guideBtn" title="دليل المعلم"><i class="fa fa-book"></i></button>
      <button class="toolbar-icon" id="settingsBtn" title="الإعدادات"><i class="fa fa-gear"></i></button>
    </div>
  </div>
  <!-- إشعار عائم -->
  <div class="notif-bar" id="notifBar"><i class="fa fa-bell"></i> <span id="notifMsg">تم تفعيل النظام!</span></div>
  <!-- نافذة دليل المعلم -->
  <div class="guide-modal" id="guideModal">
    <div class="guide-content">
      <button class="guide-close" id="closeGuide">&times;</button>
      <h2>📚 دليل المعلم الاحترافي</h2>
      <ul>
        <li>ابدأ باختيار الصف ثم الطلاب المشاركين.</li>
        <li>استخدم شريط الأدوات العلوي للوصول السريع للإشعارات، التقدم، الصوت، والدليل.</li>
        <li>اختصارات لوحة المفاتيح:<br> <b>Ctrl+Enter</b> بدء التحدي، <b>Ctrl+A</b> اختيار الكل، <b>Ctrl+R</b> اختيار عشوائي، <b>Ctrl+H</b> إظهار/إخفاء الدليل.</li>
        <li>شريط التقدم يظهر نسبة الطلاب المختارين.</li>
        <li>النظام الصوتي والمرئي يمنح تجربة تفاعلية.</li>
      </ul>
    </div>
  </div>
  <!-- شريط التقدم -->
  <div class="progress-bar-wrap" id="progressWrap" style="display:none;">
    <div class="progress-bar" id="progressBar"></div>
    <div class="progress-label" id="progressLabel"></div>
  </div>
  <div class="creative-header">
    <h1>💣 القنبلة الذكية</h1>
    <p>تحدي صف تفاعلي مع مؤثرات متقدمة</p>
  </div>
  <div class="creative-container" id="mainContainer">
    <div class="step-title">1️⃣ اختر الصف</div>
    <div class="class-grid" id="classGrid"></div>
    <div class="step-title" id="studentStepTitle" style="display:none;">2️⃣ اختر الطلاب المشاركين</div>
    <div class="students-controls" id="studentsControls" style="display:none; text-align:center; margin-bottom:1rem;">
  <button class="bomb-btn bomb-btn-green" id="selectAllBtn"><i class="fa fa-users"></i> اختيار الكل</button>
  <button class="bomb-btn bomb-btn-red" id="clearAllBtn"><i class="fa fa-user-slash"></i> إلغاء الكل</button>
  <button class="bomb-btn bomb-btn-gold" id="randomBtn"><i class="fa fa-random"></i> عشوائي</button>
  <button class="bomb-btn bomb-btn-blue" id="countBtn"><i class="fa fa-hashtag"></i> عدد محدد</button>
      </div>
    </div>
    <div class="students-grid" id="studentsGrid" style="display:none;"></div>
    <button class="start-btn" id="startBtn" style="display:none;">ابدأ التحدي 💥</button>
    <div class="bomb-area" id="bombArea" style="display:none;">
      <div class="bomb">💣</div>
      <div class="timer" id="timerDisplay">00:30</div>
      <!-- لوحة تحكم المعلم -->
      <div id="teacherPanel" style="display:none; margin-top:1.2rem; text-align:center;">
        <button class="bomb-btn bomb-btn-green" id="resumeBtn"><i class="fa fa-play"></i> استئناف</button>
        <button class="bomb-btn bomb-btn-red" id="pauseBtn"><i class="fa fa-pause"></i> إيقاف مؤقت</button>
        <button class="bomb-btn bomb-btn-blue" id="addTimeBtn"><i class="fa fa-plus"></i> +5 ثوانٍ</button>
        <button class="bomb-btn bomb-btn-gold" id="successBtn"><i class="fa fa-check"></i> نجاح</button>
        <button class="bomb-btn bomb-btn-red" id="failBtn"><i class="fa fa-bomb"></i> فشل</button>
      </div>
    </div>
    <div class="success-msg" id="successMsg" style="display:none;"></div>
    <div class="explosion" id="explosionMsg" style="display:none;"></div>
  </div>
  <audio id="successSound" src="../assets/media/sounds/win.mp3"></audio>
  <audio id="failSound" src="../assets/media/sounds/wrong_answer.mp3"></audio>
  <audio id="tickSound" src="../assets/media/sounds/countdown-beep.mp3"></audio>
  <audio id="tickFastSound" src="../assets/media/sounds/Notification.mp3"></audio>
  <audio id="alarmSound" src="../assets/media/sounds/long-beep.mp3"></audio>
  <script>
    // اختيار عدد محدد من الطلاب
    document.getElementById('countBtn').onclick = function() {
      if (!studentData[selectedClass]) return;
      const total = studentData[selectedClass].length;
      let count = prompt('كم عدد الطلاب المطلوب اختيارهم؟ (1 - ' + total + ')', Math.min(3,total));
      count = parseInt(count);
      if (isNaN(count) || count < 1 || count > total) return showNotif('❗ رقم غير صحيح');
      const arr = [...studentData[selectedClass]];
      selectedStudents = [];
      while (selectedStudents.length < count) {
        const idx = Math.floor(Math.random() * arr.length);
        const name = arr[idx];
        if (!selectedStudents.includes(name)) selectedStudents.push(name);
      }
      buildStudentsGrid();
      showNotif('🎯 تم اختيار ' + count + ' طالب');
    };
    // إشعارات ومؤثرات صوتية وبصرية
    function showNotif(msg) {
      const bar = document.getElementById('notifBar');
      document.getElementById('notifMsg').textContent = msg;
      bar.classList.add('active');
      document.getElementById('notifSound').play();
      setTimeout(()=>bar.classList.remove('active'), 2500);
    }
    // شريط التقدم
    function updateProgressBar() {
      const wrap = document.getElementById('progressWrap');
      const bar = document.getElementById('progressBar');
      const label = document.getElementById('progressLabel');
      if (!studentData[selectedClass]) { wrap.style.display='none'; return; }
      const total = studentData[selectedClass].length;
      const sel = selectedStudents.length;
      const percent = total ? Math.round((sel/total)*100) : 0;
      bar.style.width = percent+'%';
      label.textContent = `${sel} / ${total} طالب`;
      wrap.style.display = '';
      if (percent === 100 && total>0) document.getElementById('progressSound').play();
    }
    // اختصارات لوحة المفاتيح
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') { document.getElementById('startBtn').click(); e.preventDefault(); }
      if (e.ctrlKey && (e.key === 'a' || e.key === 'A')) { document.getElementById('selectAllBtn').click(); e.preventDefault(); }
      if (e.ctrlKey && (e.key === 'r' || e.key === 'R')) { document.getElementById('randomBtn').click(); e.preventDefault(); }
      if (e.ctrlKey && (e.key === 'h' || e.key === 'H')) { document.getElementById('guideBtn').click(); e.preventDefault(); }
    });
    // أزرار الأدوات العلوية
    document.getElementById('notifBtn').onclick = ()=>showNotif('🔔 هذا إشعار تجريبي!');
    document.getElementById('progressBtn').onclick = ()=>{ updateProgressBar(); showNotif('🏆 شريط التقدم محدث!'); };
    let soundOn = true;
    document.getElementById('soundBtn').onclick = function() {
      soundOn = !soundOn;
      document.getElementById('soundBtn').innerHTML = soundOn ? '<i class="fa fa-volume-up"></i>' : '<i class="fa fa-volume-mute"></i>';
      document.getElementById('successSound').muted = !soundOn;
      document.getElementById('failSound').muted = !soundOn;
      document.getElementById('tickSound').muted = !soundOn;
      document.getElementById('notifSound').muted = !soundOn;
      document.getElementById('progressSound').muted = !soundOn;
      showNotif(soundOn ? '🎵 تم تفعيل الصوت' : '🔇 تم كتم الصوت');
    };
    document.getElementById('guideBtn').onclick = function() {
      document.getElementById('guideModal').classList.add('active');
    };
    document.getElementById('closeGuide').onclick = function() {
      document.getElementById('guideModal').classList.remove('active');
    };
    document.getElementById('settingsBtn').onclick = function() {
      showNotif('⚙️ إعدادات قادمة قريباً!');
    };
    let studentData = {};
  // (تم تعريف selectedClass وselectedStudents أعلاه)
    let timer = null;
    let timeLeft = 30;
    // تحميل بيانات الطلاب الحقيقية من ملف JSON
    function loadData() {
      fetch('../data/studentData.json')
        .then(res => res.json())
        .then(data => {
          studentData = data;
          buildClassGrid();
        })
        .catch(e => {
          alert('تعذر تحميل بيانات الطلاب!');
        });
    }
    function buildClassGrid() {
      const grid = document.getElementById('classGrid');
      grid.innerHTML = '';
      Object.keys(studentData).forEach(className => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.innerHTML = `<div style="font-size:2.2rem;">🏫</div><div>${className}</div><div style="font-size:0.9rem; color:var(--success);">${studentData[className].length} طالب</div>`;
        card.onclick = () => selectClass(className, card);
        grid.appendChild(card);
      });
    }
    function selectClass(className, card) {
      selectedClass = className;
      selectedStudents = [];
      document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      // إخفاء شبكة الصفوف بعد اختيار الصف
      document.getElementById('classGrid').style.display = 'none';
      document.getElementById('studentStepTitle').style.display = '';
      document.getElementById('studentsControls').style.display = '';
      buildStudentsGrid();
    }
    function buildStudentsGrid() {
      const grid = document.getElementById('studentsGrid');
      grid.innerHTML = '';
      grid.style.display = '';
      if (!studentData[selectedClass]) return;
      studentData[selectedClass].forEach(name => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `<div style="font-size:2rem;">👤</div><div>${name}</div>`;
        card.onclick = () => toggleStudent(card, name);
        if (selectedStudents.includes(name)) card.classList.add('selected');
        grid.appendChild(card);
      });
  document.getElementById('startBtn').style.display = selectedStudents.length > 0 ? '' : 'none';
  updateProgressBar();
    }
    function toggleStudent(card, name) {
      if (selectedStudents.includes(name)) {
        selectedStudents = selectedStudents.filter(n => n !== name);
        card.classList.remove('selected');
      } else {
        selectedStudents.push(name);
        card.classList.add('selected');
      }
  document.getElementById('startBtn').style.display = selectedStudents.length > 0 ? '' : 'none';
  updateProgressBar();
    }

    // أزرار التحكم في اختيار الطلاب
    document.getElementById('selectAllBtn').onclick = function() {
      if (!studentData[selectedClass]) return;
      selectedStudents = [...studentData[selectedClass]];
  buildStudentsGrid();
  showNotif('✅ تم اختيار جميع الطلاب');
    };
    document.getElementById('clearAllBtn').onclick = function() {
      selectedStudents = [];
  buildStudentsGrid();
  showNotif('❌ تم إلغاء تحديد الجميع');
    };
    document.getElementById('randomBtn').onclick = function() {
      if (!studentData[selectedClass]) return;
      const arr = [...studentData[selectedClass]];
      const count = Math.max(1, Math.floor(Math.random() * arr.length));
      selectedStudents = [];
      while (selectedStudents.length < count) {
        const idx = Math.floor(Math.random() * arr.length);
        const name = arr[idx];
        if (!selectedStudents.includes(name)) selectedStudents.push(name);
      }
  buildStudentsGrid();
  showNotif('🎲 تم اختيار طلاب عشوائيين');
    };
    document.getElementById('startBtn').onclick = startChallenge;

    // --- منطق FSM أساسي (قابل للتوسعة لاحقًا) ---
    const FSM_STATES = {
      IDLE: 'idle',
      ARMING: 'arming',
      RUNNING: 'running',
      SUCCESS: 'success',
      FAIL: 'fail',
      RESULTS: 'results',
      PAUSED: 'paused'
    };
    let fsmState = FSM_STATES.IDLE;
    function setFSMState(state) {
      fsmState = state;
      document.body.setAttribute('data-fsm', state);
      // إظهار/إخفاء لوحة تحكم المعلم حسب الحالة
      const panel = document.getElementById('teacherPanel');
      if (!panel) return;
      if (state === FSM_STATES.RUNNING || state === FSM_STATES.PAUSED) {
        panel.style.display = '';
        document.getElementById('pauseBtn').style.display = state === FSM_STATES.RUNNING ? '' : 'none';
        document.getElementById('resumeBtn').style.display = state === FSM_STATES.PAUSED ? '' : 'none';
      } else {
        panel.style.display = 'none';
      }
    }

    // --- مؤقّت rAF متقدم ---
    let timerRAF = null;
    let timerStart = 0;
    let timerPausedAt = 0;
    let timerDuration = 30;
    let timerOnEnd = null;
    function startTimer(duration, onEnd) {
      timerDuration = duration;
      timeLeft = duration;
      timerStart = performance.now();
      timerOnEnd = onEnd;
      setFSMState(FSM_STATES.RUNNING);
      tickRAF();
    }
    function tickRAF(now) {
      if (fsmState !== FSM_STATES.RUNNING) return;
      if (!timerStart) timerStart = now || performance.now();
      const elapsed = ((now || performance.now()) - timerStart) / 1000;
      timeLeft = Math.max(0, Math.ceil(timerDuration - elapsed));
      updateTimer();
      updateBombVisual(timeLeft, timerDuration);
      if (timeLeft > 0) {
        timerRAF = requestAnimationFrame(tickRAF);
      } else {
        setFSMState(FSM_STATES.FAIL);
        if (timerOnEnd) timerOnEnd();
      }
    }
    function pauseTimer() {
      if (fsmState !== FSM_STATES.RUNNING) return;
      setFSMState(FSM_STATES.PAUSED);
      timerPausedAt = performance.now();
      if (timerRAF) cancelAnimationFrame(timerRAF);
    }
    function resumeTimer() {
      if (fsmState !== FSM_STATES.PAUSED) return;
      setFSMState(FSM_STATES.RUNNING);
      // عدّل نقطة البداية حسب مدة التوقف
      timerStart += performance.now() - timerPausedAt;
      tickRAF();
    }
    function addTime(sec) {
      timerDuration += sec;
      updateTimer();
    }

    // --- تحديث المؤقت والمؤثرات ---
    function updateBombVisual(timeLeft, total) {
      const bomb = document.querySelector('.bomb');
      const timerDisplay = document.getElementById('timerDisplay');
      // مؤثرات القنبلة
      if (timeLeft > total/2) {
        bomb.className = 'bomb bomb-small';
        timerDisplay.className = 'timer';
      } else if (timeLeft > 10) {
        bomb.className = 'bomb bomb-mid';
        timerDisplay.className = 'timer';
      } else if (timeLeft > 3) {
        bomb.className = 'bomb bomb-large bomb-shake';
        timerDisplay.className = 'timer timer-red timer-shake';
      } else if (timeLeft > 0) {
        bomb.className = 'bomb bomb-large bomb-shake';
        timerDisplay.className = 'timer timer-big';
      }
      // اهتزاز الشاشة آخر 5 ثوانٍ
      if (timeLeft <= 5 && timeLeft > 0) {
        const shakeLevel = (6 - timeLeft) * 2;
        document.body.style.transform = `translate(${Math.random()*shakeLevel-Math.random()*shakeLevel}px,${Math.random()*shakeLevel-Math.random()*shakeLevel}px)`;
      } else {
        document.body.style.transform = '';
      }
      // الأصوات
      if (timeLeft > 10) {
        playTick();
      } else if (timeLeft > 3) {
        document.getElementById('tickFastSound').currentTime = 0;
        document.getElementById('tickFastSound').play();
      } else if (timeLeft > 0) {
        document.getElementById('alarmSound').currentTime = 0;
        document.getElementById('alarmSound').play();
      }
    }

    // --- بدء التحدي: إخفاء بطاقات الطلاب ولوحة التحكم ---
    function startChallenge() {
      showNotif('🚀 بدأ التحدي!');
      setFSMState(FSM_STATES.ARMING);
      document.getElementById('mainContainer').scrollIntoView({behavior:'smooth'});
      document.getElementById('bombArea').style.display = '';
      document.getElementById('successMsg').style.display = 'none';
      document.getElementById('explosionMsg').style.display = 'none';
      document.getElementById('studentsGrid').style.display = 'none';
      document.getElementById('studentsControls').style.display = 'none';
      document.getElementById('studentStepTitle').style.display = 'none';
      // إعادة المؤثرات
      const bomb = document.querySelector('.bomb');
      const timerDisplay = document.getElementById('timerDisplay');
      bomb.className = 'bomb bomb-small';
      timerDisplay.className = 'timer';
      document.body.classList.remove('shake');
      if (document.querySelector('.screen-flash')) document.querySelector('.screen-flash').remove();
      if (document.querySelector('.explosion-effect')) document.querySelector('.explosion-effect').remove();
      // بدء المؤقت المتقدم
      startTimer(30, onTimerEnd);
    }

    // --- نهاية المؤقت: فشل افتراضي (نجاح/فشل يدوي لاحقًا) ---
    function onTimerEnd() {
      document.body.style.transform = '';
      // فلاش الشاشة
      let flashDiv = document.createElement('div');
      flashDiv.className = 'screen-flash';
      document.body.appendChild(flashDiv);
      setTimeout(()=>{ if(flashDiv) flashDiv.remove(); }, 600);
      // شرارات ودخان
      let explosionDiv = document.createElement('div');
      explosionDiv.className = 'explosion-effect';
      document.body.appendChild(explosionDiv);
      document.body.classList.add('shake');
      document.getElementById('explosionMsg').textContent = '💥 انفجرت القنبلة!';
      document.getElementById('explosionMsg').style.display = '';
      document.getElementById('failSound').play();
      confetti({particleCount: 80, spread: 70, origin: { y: 0.7 }, colors: ['#ff4757','#ffd700']});
      setTimeout(()=>{
        document.body.classList.remove('shake');
        if (explosionDiv) explosionDiv.remove();
        setFSMState(FSM_STATES.RESULTS);
      }, 1500);
    }

    // --- لوحة تحكم المعلم ---
    document.getElementById('pauseBtn').onclick = pauseTimer;
    document.getElementById('resumeBtn').onclick = resumeTimer;
    document.getElementById('addTimeBtn').onclick = function() { addTime(5); showNotif('⏱️ +5 ثوانٍ!'); };
    document.getElementById('successBtn').onclick = function() {
      setFSMState(FSM_STATES.SUCCESS);
      document.body.style.transform = '';
      document.getElementById('successMsg').textContent = '🎉 نجاح! أحسنت!';
      document.getElementById('successMsg').style.display = '';
      document.getElementById('successSound').play();
      confetti({particleCount: 120, spread: 90, origin: { y: 0.7 }, colors: ['#00e676','#ffd700']});
      if (timerRAF) cancelAnimationFrame(timerRAF);
      setTimeout(()=>setFSMState(FSM_STATES.RESULTS), 1500);
    };
    document.getElementById('failBtn').onclick = function() {
      setFSMState(FSM_STATES.FAIL);
      onTimerEnd();
      if (timerRAF) cancelAnimationFrame(timerRAF);
    };

    // --- مفاتيح اختصار متقدمة ---
    document.addEventListener('keydown', function(e) {
      if (fsmState === FSM_STATES.RUNNING) {
        if (e.code === 'Space') { pauseTimer(); e.preventDefault(); }
        if (e.key === 'ArrowUp') { addTime(5); showNotif('⏱️ +5 ثوانٍ!'); e.preventDefault(); }
        if (e.key === 'Enter') { document.getElementById('successBtn').click(); e.preventDefault(); }
        if (e.key === 'Escape') { document.getElementById('failBtn').click(); e.preventDefault(); }
      } else if (fsmState === FSM_STATES.PAUSED) {
        if (e.code === 'Space') { resumeTimer(); e.preventDefault(); }
      }
    });
    function updateTimer() {
      document.getElementById('timerDisplay').textContent = `00:${String(timeLeft).padStart(2,'0')}`;
    }
    function showExplosion() {
      document.getElementById('explosionMsg').textContent = '💥 انفجرت القنبلة! حاول مرة أخرى';
      document.getElementById('explosionMsg').style.display = '';
      document.getElementById('failSound').play();
      confetti({particleCount: 80, spread: 70, origin: { y: 0.7 }, colors: ['#ff4757','#ffd700']});
    }
    function playTick() {
      document.getElementById('tickSound').currentTime = 0;
      document.getElementById('tickSound').play();
    }
    // بدء التحميل
    loadData();
  </script>
</body>
</html>
