<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’£ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© | Teacher & Student</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .role-switcher { position: fixed; top: 10px; left: 10px; z-index: 9999; }
    .role-switcher button { margin-left: 0.5rem; font-size: 1rem; padding: 0.4rem 1.2rem; border-radius: 18px; border: none; background: #ffd700; color: #232526; font-weight: bold; cursor: pointer; }
    .role-switcher button.active { background: #00e676; color: #232526; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± -->
  <div class="role-switcher">
    <span>Ø§Ù„ÙˆØ¶Ø¹:</span>
    <button id="teacherModeBtn" class="active">Ø§Ù„Ù…Ø¹Ù„Ù…</button>
    <button id="studentModeBtn">Ø§Ù„Ø·Ø§Ù„Ø¨</button>
  </div>
  <div id="teacherView">
    <div class="container">
      <section id="classSelectSection">
        <h2>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</h2>
        <div id="classGrid" class="class-grid"></div>
      </section>
      <section id="studentSelectSection" style="display:none;">
        <h2>Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h2>
        <div id="studentsGrid" class="students-grid"></div>
        <button id="startChallengeBtn" class="main-btn" disabled>Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
      </section>
      <section id="bombStage" style="display:none;">
        <div class="bomb-area">
          <div class="bomb" id="bombVisual">ğŸ’£</div>
          <div class="timer" id="globalTimer">00:00</div>
          <div id="heatMeter" class="heat-meter"></div>
          <div id="turnInfo"></div>
          <div id="teacherPanel" class="teacher-panel">
            <button id="pauseBtn" aria-label="Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª">â¸</button>
            <button id="resumeBtn" aria-label="Ø§Ø³ØªØ¦Ù†Ø§Ù" style="display:none;">â–¶ï¸</button>
            <button id="addTimeBtn" aria-label="+5 Ø«ÙˆØ§Ù†Ù">+5s</button>
            <button id="successBtn" aria-label="Ù†Ø¬Ø§Ø­">âœ”ï¸</button>
            <button id="failBtn" aria-label="ÙØ´Ù„">ğŸ’¥</button>
          </div>
          <div id="eventLog" class="event-log"></div>
        </div>
      </section>
    </div>
  </div>
  <div id="studentView" class="hidden">
    <div class="container">
      <section id="waitingSection">
        <div class="bomb bomb-sleep">ğŸ’£ğŸ’¤</div>
        <div class="waiting-msg">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…...</div>
      </section>
      <section id="studentBombStage" style="display:none;">
        <div class="bomb-area">
          <div class="bomb" id="studentBombVisual">ğŸ’£</div>
          <div class="timer" id="studentGlobalTimer">00:00</div>
          <div id="turnList" class="turn-list"></div>
          <div id="studentTurnInfo"></div>
        </div>
      </section>
    </div>
  </div>
  <script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± ---
    const teacherView = document.getElementById('teacherView');
    const studentView = document.getElementById('studentView');
    document.getElementById('teacherModeBtn').onclick = () => {
      teacherView.classList.remove('hidden');
      studentView.classList.add('hidden');
      document.getElementById('teacherModeBtn').classList.add('active');
      document.getElementById('studentModeBtn').classList.remove('active');
    };
    document.getElementById('studentModeBtn').onclick = () => {
      teacherView.classList.add('hidden');
      studentView.classList.remove('hidden');
      document.getElementById('teacherModeBtn').classList.remove('active');
      document.getElementById('studentModeBtn').classList.add('active');
    };
    // --- Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ ---
    const demoData = {
      'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„': ['Ø£Ø­Ù…Ø¯','Ø³Ø§Ø±Ø©','Ù…Ø­Ù…Ø¯','Ù„ÙŠØ§Ù†','Ø³Ù„Ù…Ø§Ù†','Ø¬ÙˆØ¯'],
      'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ': ['Ø®Ø§Ù„Ø¯','Ø±ÙŠÙ…','ÙŠÙˆØ³Ù','Ù‡Ù†Ø¯','Ø³ÙŠÙ','Ù…Ù‡Ø§'],
      'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«': ['Ø³Ø¹ÙŠØ¯','Ù†ÙˆØ±Ø©','Ø±Ø§Ø´Ø¯','Ø¬Ù…Ø§Ù†Ø©','Ø·Ø§Ø±Ù‚','Ø´Ù‡Ø¯']
    };
  let selectedClass = null;
  let selectedStudents = [];
    let gameState = 'IDLE';
    let turnIndex = 0;
    let roundConfig = { totalSeconds: 35, perPlayerSeconds: 8 };
    let globalTimer = null, turnTimer = null;
    // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù„Ù… ---
    function buildClassGrid() {
      const grid = document.getElementById('classGrid');
      grid.innerHTML = '';
      Object.keys(demoData).forEach(className => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.textContent = className;
        card.onclick = () => selectClass(className, card);
        grid.appendChild(card);
      });
    }
    function selectClass(className, card) {
      selectedClass = className;
      selectedStudents = [];
      document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      document.getElementById('classSelectSection').style.display = 'none';
      document.getElementById('studentSelectSection').style.display = '';
      buildStudentsGrid();
    }
    function buildStudentsGrid() {
      const grid = document.getElementById('studentsGrid');
      grid.innerHTML = '';
      if (!selectedClass) return;
      demoData[selectedClass].forEach(name => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.textContent = name;
        card.onclick = () => toggleStudent(card, name);
        if (selectedStudents.includes(name)) card.classList.add('selected');
        grid.appendChild(card);
      });
      document.getElementById('startChallengeBtn').disabled = selectedStudents.length === 0;
    }
    function toggleStudent(card, name) {
      if (selectedStudents.includes(name)) {
        selectedStudents = selectedStudents.filter(n => n !== name);
        card.classList.remove('selected');
      } else {
        selectedStudents.push(name);
        card.classList.add('selected');
      }
      document.getElementById('startChallengeBtn').disabled = selectedStudents.length === 0;
    }
    document.getElementById('startChallengeBtn').onclick = startChallenge;
    function startChallenge() {
      if (!selectedClass || selectedStudents.length === 0) return;
      gameState = 'ARMING';
      document.getElementById('studentSelectSection').style.display = 'none';
      document.getElementById('bombStage').style.display = '';
      // ØªÙ…Ù‡ÙŠØ¯ Ù‚ØµÙŠØ±
      setTimeout(()=>{
        gameState = 'RUNNING';
        startGlobalTimer();
        startTurn(0);
      }, 1800);
    }
    // --- Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø± ---
    function startGlobalTimer() {
      let left = roundConfig.totalSeconds;
      document.getElementById('globalTimer').textContent = formatTime(left);
      if (globalTimer) clearInterval(globalTimer);
      globalTimer = setInterval(()=>{
        left--;
        document.getElementById('globalTimer').textContent = formatTime(left);
        updateHeatMeter(left);
        if (left <= 0) {
          clearInterval(globalTimer);
          endGame('FAIL');
        }
      }, 1000);
    }
    function startTurn(idx) {
      turnIndex = idx;
      updateTurnInfo();
      let left = roundConfig.perPlayerSeconds;
      if (turnTimer) clearInterval(turnTimer);
      turnTimer = setInterval(()=>{
        left--;
        updateTurnInfo(left);
        if (left <= 0) {
          clearInterval(turnTimer);
          if (turnIndex < selectedStudents.length-1) startTurn(turnIndex+1);
          else endGame('SUCCESS');
        }
      }, 1000);
    }
    function updateTurnInfo(left) {
      const info = document.getElementById('turnInfo');
      if (gameState !== 'RUNNING') { info.textContent = ''; return; }
      const name = selectedStudents[turnIndex];
      info.textContent = `Ø¯ÙˆØ±: ${name}  ${(left!==undefined? 'â³ '+left+'s':'')}`;
    }
    function updateHeatMeter(left) {
      const meter = document.getElementById('heatMeter');
      const percent = 100 - Math.round((left/roundConfig.totalSeconds)*100);
      meter.innerHTML = `<div class='heat-meter-bar' style='width:${percent}%;'></div>`;
    }
    function endGame(result) {
      gameState = result;
      document.getElementById('turnInfo').textContent = result==='SUCCESS'?'ğŸ‰ Ù†Ø¬Ø§Ø­!':'ğŸ’¥ Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©!';
      if (globalTimer) clearInterval(globalTimer);
      if (turnTimer) clearInterval(turnTimer);
    }
    // --- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function formatTime(sec) {
      sec = Math.max(0, Math.round(sec));
      return '00:' + String(sec).padStart(2, '0');
    }
    // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ---
    // (ØªØ²Ø§Ù…Ù† Ø¯Ø§Ø®Ù„ÙŠ: Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…)
    function updateStudentView() {
      const waiting = document.getElementById('waitingSection');
      const bombStage = document.getElementById('studentBombStage');
      if (gameState === 'IDLE' || gameState === 'ARMING') {
        waiting.style.display = '';
        bombStage.style.display = 'none';
      } else if (gameState === 'RUNNING') {
        waiting.style.display = 'none';
        bombStage.style.display = '';
        updateStudentBomb();
      } else {
        waiting.style.display = 'none';
        bombStage.style.display = '';
        document.getElementById('studentTurnInfo').textContent = (gameState==='SUCCESS'?'ğŸ‰ Ù†Ø¬Ø§Ø­!':'ğŸ’¥ Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©!');
      }
    }
    function updateStudentBomb() {
      document.getElementById('studentGlobalTimer').textContent = document.getElementById('globalTimer').textContent;
      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
      const turnList = document.getElementById('turnList');
      turnList.innerHTML = '';
      selectedStudents.forEach((name,i)=>{
        const el = document.createElement('div');
        el.className = 'turn-student'+(i===turnIndex?' active':'');
        el.textContent = name;
        turnList.appendChild(el);
      });
      document.getElementById('studentTurnInfo').textContent = `Ø¯ÙˆØ±: ${selectedStudents[turnIndex]}`;
    }
    // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠØ±Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ---
    setInterval(updateStudentView, 500);
    // --- Ø¨Ø¯Ø¡ ---
    buildClassGrid();
  </script>
</body>
</html>
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="top-toolbar">
    <div class="game-logo" style="font-size:1.5rem; font-weight:900; color:#ffd700; display:flex; align-items:center; gap:0.7rem;">
      <span>ğŸ’£</span> Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©
    </div>
    <div class="toolbar-icons">
      <button class="toolbar-icon" id="notifBtn" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"><i class="fa fa-bell"></i></button>
      <button class="toolbar-icon" id="progressBtn" title="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…"><i class="fa fa-trophy"></i></button>
      <button class="toolbar-icon sound-icon" id="soundBtn" title="Ø§Ù„ØµÙˆØª"><i class="fa fa-volume-up"></i></button>
      <button class="toolbar-icon" id="guideBtn" title="Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…"><i class="fa fa-book"></i></button>
      <button class="toolbar-icon" id="settingsBtn" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"><i class="fa fa-gear"></i></button>
    </div>
  </div>
  <!-- Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ø¦Ù… -->
  <div class="notif-bar" id="notifBar"><i class="fa fa-bell"></i> <span id="notifMsg">ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…!</span></div>
  <!-- Ù†Ø§ÙØ°Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… -->
  <div class="guide-modal" id="guideModal">
    <div class="guide-content">
      <button class="guide-close" id="closeGuide">&times;</button>
      <h2>ğŸ“š Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</h2>
      <ul>
        <li>Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ Ø«Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†.</li>
        <li>Ø§Ø³ØªØ®Ø¯Ù… Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø¯Ù…ØŒ Ø§Ù„ØµÙˆØªØŒ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„.</li>
        <li>Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­:<br> <b>Ctrl+Enter</b> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØŒ <b>Ctrl+A</b> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„ØŒ <b>Ctrl+R</b> Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠØŒ <b>Ctrl+H</b> Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ù„ÙŠÙ„.</li>
        <li>Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ÙŠØ¸Ù‡Ø± Ù†Ø³Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±ÙŠÙ†.</li>
        <li>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØªÙŠ ÙˆØ§Ù„Ù…Ø±Ø¦ÙŠ ÙŠÙ…Ù†Ø­ ØªØ¬Ø±Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ©.</li>
      </ul>
    </div>
  </div>
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
  <div class="progress-bar-wrap" id="progressWrap" style="display:none;">
    <div class="progress-bar" id="progressBar"></div>
    <div class="progress-label" id="progressLabel"></div>
  </div>
  <div class="creative-header">
    <h1>ğŸ’£ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h1>
    <p>ØªØ­Ø¯ÙŠ ØµÙ ØªÙØ§Ø¹Ù„ÙŠ Ù…Ø¹ Ù…Ø¤Ø«Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</p>
  </div>
  <div class="creative-container" id="mainContainer">
    <div class="step-title">1ï¸âƒ£ Ø§Ø®ØªØ± Ø§Ù„ØµÙ</div>
    <div class="class-grid" id="classGrid"></div>
    <div class="step-title" id="studentStepTitle" style="display:none;">2ï¸âƒ£ Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</div>
    <div class="students-controls" id="studentsControls" style="display:none; text-align:center; margin-bottom:1rem;">
  <button class="bomb-btn bomb-btn-green" id="selectAllBtn"><i class="fa fa-users"></i> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„</button>
  <button class="bomb-btn bomb-btn-red" id="clearAllBtn"><i class="fa fa-user-slash"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
  <button class="bomb-btn bomb-btn-gold" id="randomBtn"><i class="fa fa-random"></i> Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
  <button class="bomb-btn bomb-btn-blue" id="countBtn"><i class="fa fa-hashtag"></i> Ø¹Ø¯Ø¯ Ù…Ø­Ø¯Ø¯</button>
      </div>
    </div>
    <div class="students-grid" id="studentsGrid" style="display:none;"></div>
    <button class="start-btn" id="startBtn" style="display:none;">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ ğŸ’¥</button>
    <div class="bomb-area" id="bombArea" style="display:none;">
      <div class="bomb">ğŸ’£</div>
      <div class="timer" id="timerDisplay">00:30</div>
      <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù… -->
      <div id="teacherPanel" style="display:none; margin-top:1.2rem; text-align:center;">
        <button class="bomb-btn bomb-btn-green" id="resumeBtn"><i class="fa fa-play"></i> Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
        <button class="bomb-btn bomb-btn-red" id="pauseBtn"><i class="fa fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
        <button class="bomb-btn bomb-btn-blue" id="addTimeBtn"><i class="fa fa-plus"></i> +5 Ø«ÙˆØ§Ù†Ù</button>
        <button class="bomb-btn bomb-btn-gold" id="successBtn"><i class="fa fa-check"></i> Ù†Ø¬Ø§Ø­</button>
        <button class="bomb-btn bomb-btn-red" id="failBtn"><i class="fa fa-bomb"></i> ÙØ´Ù„</button>
      </div>
    </div>
    <div class="success-msg" id="successMsg" style="display:none;"></div>
    <div class="explosion" id="explosionMsg" style="display:none;"></div>
  </div>
  <audio id="successSound" src="../assets/media/sounds/win.mp3"></audio>
  <audio id="failSound" src="../assets/media/sounds/wrong_answer.mp3"></audio>
  <audio id="tickSound" src="../assets/media/sounds/countdown-beep.mp3"></audio>
  <audio id="tickFastSound" src="../assets/media/sounds/Notification.mp3"></audio>
  <audio id="alarmSound" src="../assets/media/sounds/long-beep.mp3"></audio>
  <script>
    // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨
    document.getElementById('countBtn').onclick = function() {
      if (!studentData[selectedClass]) return;
      const total = studentData[selectedClass].length;
      let count = prompt('ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ù…ØŸ (1 - ' + total + ')', Math.min(3,total));
      count = parseInt(count);
      if (isNaN(count) || count < 1 || count > total) return showNotif('â— Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­');
      const arr = [...studentData[selectedClass]];
      selectedStudents = [];
      while (selectedStudents.length < count) {
        const idx = Math.floor(Math.random() * arr.length);
        const name = arr[idx];
        if (!selectedStudents.includes(name)) selectedStudents.push(name);
      }
      buildStudentsGrid();
      showNotif('ğŸ¯ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ' + count + ' Ø·Ø§Ù„Ø¨');
    };
    // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆÙ…Ø¤Ø«Ø±Ø§Øª ØµÙˆØªÙŠØ© ÙˆØ¨ØµØ±ÙŠØ©
    function showNotif(msg) {
      const bar = document.getElementById('notifBar');
      document.getElementById('notifMsg').textContent = msg;
      bar.classList.add('active');
      document.getElementById('notifSound').play();
      setTimeout(()=>bar.classList.remove('active'), 2500);
    }
    // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    function updateProgressBar() {
      const wrap = document.getElementById('progressWrap');
      const bar = document.getElementById('progressBar');
      const label = document.getElementById('progressLabel');
      if (!studentData[selectedClass]) { wrap.style.display='none'; return; }
      const total = studentData[selectedClass].length;
      const sel = selectedStudents.length;
      const percent = total ? Math.round((sel/total)*100) : 0;
      bar.style.width = percent+'%';
      label.textContent = `${sel} / ${total} Ø·Ø§Ù„Ø¨`;
      wrap.style.display = '';
      if (percent === 100 && total>0) document.getElementById('progressSound').play();
    }
    // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') { document.getElementById('startBtn').click(); e.preventDefault(); }
      if (e.ctrlKey && (e.key === 'a' || e.key === 'A')) { document.getElementById('selectAllBtn').click(); e.preventDefault(); }
      if (e.ctrlKey && (e.key === 'r' || e.key === 'R')) { document.getElementById('randomBtn').click(); e.preventDefault(); }
      if (e.ctrlKey && (e.key === 'h' || e.key === 'H')) { document.getElementById('guideBtn').click(); e.preventDefault(); }
    });
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
    document.getElementById('notifBtn').onclick = ()=>showNotif('ğŸ”” Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ!');
    document.getElementById('progressBtn').onclick = ()=>{ updateProgressBar(); showNotif('ğŸ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø­Ø¯Ø«!'); };
    let soundOn = true;
    document.getElementById('soundBtn').onclick = function() {
      soundOn = !soundOn;
      document.getElementById('soundBtn').innerHTML = soundOn ? '<i class="fa fa-volume-up"></i>' : '<i class="fa fa-volume-mute"></i>';
      document.getElementById('successSound').muted = !soundOn;
      document.getElementById('failSound').muted = !soundOn;
      document.getElementById('tickSound').muted = !soundOn;
      document.getElementById('notifSound').muted = !soundOn;
      document.getElementById('progressSound').muted = !soundOn;
      showNotif(soundOn ? 'ğŸµ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª' : 'ğŸ”‡ ØªÙ… ÙƒØªÙ… Ø§Ù„ØµÙˆØª');
    };
    document.getElementById('guideBtn').onclick = function() {
      document.getElementById('guideModal').classList.add('active');
    };
    document.getElementById('closeGuide').onclick = function() {
      document.getElementById('guideModal').classList.remove('active');
    };
    document.getElementById('settingsBtn').onclick = function() {
      showNotif('âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¯Ù…Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹!');
    };
    let studentData = {};
  // (ØªÙ… ØªØ¹Ø±ÙŠÙ selectedClass ÙˆselectedStudents Ø£Ø¹Ù„Ø§Ù‡)
    let timer = null;
    let timeLeft = 30;
    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ù…Ù„Ù JSON
    function loadData() {
      fetch('../data/studentData.json')
        .then(res => res.json())
        .then(data => {
          studentData = data;
          buildClassGrid();
        })
        .catch(e => {
          alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨!');
        });
    }
    function buildClassGrid() {
      const grid = document.getElementById('classGrid');
      grid.innerHTML = '';
      Object.keys(studentData).forEach(className => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.innerHTML = `<div style="font-size:2.2rem;">ğŸ«</div><div>${className}</div><div style="font-size:0.9rem; color:var(--success);">${studentData[className].length} Ø·Ø§Ù„Ø¨</div>`;
        card.onclick = () => selectClass(className, card);
        grid.appendChild(card);
      });
    }
    function selectClass(className, card) {
      selectedClass = className;
      selectedStudents = [];
      document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      // Ø¥Ø®ÙØ§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙÙˆÙ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ
      document.getElementById('classGrid').style.display = 'none';
      document.getElementById('studentStepTitle').style.display = '';
      document.getElementById('studentsControls').style.display = '';
      buildStudentsGrid();
    }
    function buildStudentsGrid() {
      const grid = document.getElementById('studentsGrid');
      grid.innerHTML = '';
      grid.style.display = '';
      if (!studentData[selectedClass]) return;
      studentData[selectedClass].forEach(name => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `<div style="font-size:2rem;">ğŸ‘¤</div><div>${name}</div>`;
        card.onclick = () => toggleStudent(card, name);
        if (selectedStudents.includes(name)) card.classList.add('selected');
        grid.appendChild(card);
      });
  document.getElementById('startBtn').style.display = selectedStudents.length > 0 ? '' : 'none';
  updateProgressBar();
    }
    function toggleStudent(card, name) {
      if (selectedStudents.includes(name)) {
        selectedStudents = selectedStudents.filter(n => n !== name);
        card.classList.remove('selected');
      } else {
        selectedStudents.push(name);
        card.classList.add('selected');
      }
  document.getElementById('startBtn').style.display = selectedStudents.length > 0 ? '' : 'none';
  updateProgressBar();
    }

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨
    document.getElementById('selectAllBtn').onclick = function() {
      if (!studentData[selectedClass]) return;
      selectedStudents = [...studentData[selectedClass]];
  buildStudentsGrid();
  showNotif('âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨');
    };
    document.getElementById('clearAllBtn').onclick = function() {
      selectedStudents = [];
  buildStudentsGrid();
  showNotif('âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù…ÙŠØ¹');
    };
    document.getElementById('randomBtn').onclick = function() {
      if (!studentData[selectedClass]) return;
      const arr = [...studentData[selectedClass]];
      const count = Math.max(1, Math.floor(Math.random() * arr.length));
      selectedStudents = [];
      while (selectedStudents.length < count) {
        const idx = Math.floor(Math.random() * arr.length);
        const name = arr[idx];
        if (!selectedStudents.includes(name)) selectedStudents.push(name);
      }
  buildStudentsGrid();
  showNotif('ğŸ² ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø§Ø¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠÙŠÙ†');
    };
    document.getElementById('startBtn').onclick = startChallenge;

    // --- Ù…Ù†Ø·Ù‚ FSM Ø£Ø³Ø§Ø³ÙŠ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ³Ø¹Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§) ---
    const FSM_STATES = {
      IDLE: 'idle',
      ARMING: 'arming',
      RUNNING: 'running',
      SUCCESS: 'success',
      FAIL: 'fail',
      RESULTS: 'results',
      PAUSED: 'paused'
    };
    let fsmState = FSM_STATES.IDLE;
    function setFSMState(state) {
      fsmState = state;
      document.body.setAttribute('data-fsm', state);
      // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù… Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
      const panel = document.getElementById('teacherPanel');
      if (!panel) return;
      if (state === FSM_STATES.RUNNING || state === FSM_STATES.PAUSED) {
        panel.style.display = '';
        document.getElementById('pauseBtn').style.display = state === FSM_STATES.RUNNING ? '' : 'none';
        document.getElementById('resumeBtn').style.display = state === FSM_STATES.PAUSED ? '' : 'none';
      } else {
        panel.style.display = 'none';
      }
    }

    // --- Ù…Ø¤Ù‚Ù‘Øª rAF Ù…ØªÙ‚Ø¯Ù… ---
    let timerRAF = null;
    let timerStart = 0;
    let timerPausedAt = 0;
    let timerDuration = 30;
    let timerOnEnd = null;
    function startTimer(duration, onEnd) {
      timerDuration = duration;
      timeLeft = duration;
      timerStart = performance.now();
      timerOnEnd = onEnd;
      setFSMState(FSM_STATES.RUNNING);
      tickRAF();
    }
    function tickRAF(now) {
      if (fsmState !== FSM_STATES.RUNNING) return;
      if (!timerStart) timerStart = now || performance.now();
      const elapsed = ((now || performance.now()) - timerStart) / 1000;
      timeLeft = Math.max(0, Math.ceil(timerDuration - elapsed));
      updateTimer();
      updateBombVisual(timeLeft, timerDuration);
      if (timeLeft > 0) {
        timerRAF = requestAnimationFrame(tickRAF);
      } else {
        setFSMState(FSM_STATES.FAIL);
        if (timerOnEnd) timerOnEnd();
      }
    }
    function pauseTimer() {
      if (fsmState !== FSM_STATES.RUNNING) return;
      setFSMState(FSM_STATES.PAUSED);
      timerPausedAt = performance.now();
      if (timerRAF) cancelAnimationFrame(timerRAF);
    }
    function resumeTimer() {
      if (fsmState !== FSM_STATES.PAUSED) return;
      setFSMState(FSM_STATES.RUNNING);
      // Ø¹Ø¯Ù‘Ù„ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø­Ø³Ø¨ Ù…Ø¯Ø© Ø§Ù„ØªÙˆÙ‚Ù
      timerStart += performance.now() - timerPausedAt;
      tickRAF();
    }
    function addTime(sec) {
      timerDuration += sec;
      updateTimer();
    }

    // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ§Ù„Ù…Ø¤Ø«Ø±Ø§Øª ---
    function updateBombVisual(timeLeft, total) {
      const bomb = document.querySelector('.bomb');
      const timerDisplay = document.getElementById('timerDisplay');
      // Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
      if (timeLeft > total/2) {
        bomb.className = 'bomb bomb-small';
        timerDisplay.className = 'timer';
      } else if (timeLeft > 10) {
        bomb.className = 'bomb bomb-mid';
        timerDisplay.className = 'timer';
      } else if (timeLeft > 3) {
        bomb.className = 'bomb bomb-large bomb-shake';
        timerDisplay.className = 'timer timer-red timer-shake';
      } else if (timeLeft > 0) {
        bomb.className = 'bomb bomb-large bomb-shake';
        timerDisplay.className = 'timer timer-big';
      }
      // Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ø´Ø§Ø´Ø© Ø¢Ø®Ø± 5 Ø«ÙˆØ§Ù†Ù
      if (timeLeft <= 5 && timeLeft > 0) {
        const shakeLevel = (6 - timeLeft) * 2;
        document.body.style.transform = `translate(${Math.random()*shakeLevel-Math.random()*shakeLevel}px,${Math.random()*shakeLevel-Math.random()*shakeLevel}px)`;
      } else {
        document.body.style.transform = '';
      }
      // Ø§Ù„Ø£ØµÙˆØ§Øª
      if (timeLeft > 10) {
        playTick();
      } else if (timeLeft > 3) {
        document.getElementById('tickFastSound').currentTime = 0;
        document.getElementById('tickFastSound').play();
      } else if (timeLeft > 0) {
        document.getElementById('alarmSound').currentTime = 0;
        document.getElementById('alarmSound').play();
      }
    }

    // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ: Ø¥Ø®ÙØ§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆÙ„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ---
    function startChallenge() {
      showNotif('ğŸš€ Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ!');
      setFSMState(FSM_STATES.ARMING);
      document.getElementById('mainContainer').scrollIntoView({behavior:'smooth'});
      document.getElementById('bombArea').style.display = '';
      document.getElementById('successMsg').style.display = 'none';
      document.getElementById('explosionMsg').style.display = 'none';
      document.getElementById('studentsGrid').style.display = 'none';
      document.getElementById('studentsControls').style.display = 'none';
      document.getElementById('studentStepTitle').style.display = 'none';
      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª
      const bomb = document.querySelector('.bomb');
      const timerDisplay = document.getElementById('timerDisplay');
      bomb.className = 'bomb bomb-small';
      timerDisplay.className = 'timer';
      document.body.classList.remove('shake');
      if (document.querySelector('.screen-flash')) document.querySelector('.screen-flash').remove();
      if (document.querySelector('.explosion-effect')) document.querySelector('.explosion-effect').remove();
      // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
      startTimer(30, onTimerEnd);
    }

    // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¤Ù‚Øª: ÙØ´Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù†Ø¬Ø§Ø­/ÙØ´Ù„ ÙŠØ¯ÙˆÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§) ---
    function onTimerEnd() {
      document.body.style.transform = '';
      // ÙÙ„Ø§Ø´ Ø§Ù„Ø´Ø§Ø´Ø©
      let flashDiv = document.createElement('div');
      flashDiv.className = 'screen-flash';
      document.body.appendChild(flashDiv);
      setTimeout(()=>{ if(flashDiv) flashDiv.remove(); }, 600);
      // Ø´Ø±Ø§Ø±Ø§Øª ÙˆØ¯Ø®Ø§Ù†
      let explosionDiv = document.createElement('div');
      explosionDiv.className = 'explosion-effect';
      document.body.appendChild(explosionDiv);
      document.body.classList.add('shake');
      document.getElementById('explosionMsg').textContent = 'ğŸ’¥ Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©!';
      document.getElementById('explosionMsg').style.display = '';
      document.getElementById('failSound').play();
      confetti({particleCount: 80, spread: 70, origin: { y: 0.7 }, colors: ['#ff4757','#ffd700']});
      setTimeout(()=>{
        document.body.classList.remove('shake');
        if (explosionDiv) explosionDiv.remove();
        setFSMState(FSM_STATES.RESULTS);
      }, 1500);
    }

    // --- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù… ---
    document.getElementById('pauseBtn').onclick = pauseTimer;
    document.getElementById('resumeBtn').onclick = resumeTimer;
    document.getElementById('addTimeBtn').onclick = function() { addTime(5); showNotif('â±ï¸ +5 Ø«ÙˆØ§Ù†Ù!'); };
    document.getElementById('successBtn').onclick = function() {
      setFSMState(FSM_STATES.SUCCESS);
      document.body.style.transform = '';
      document.getElementById('successMsg').textContent = 'ğŸ‰ Ù†Ø¬Ø§Ø­! Ø£Ø­Ø³Ù†Øª!';
      document.getElementById('successMsg').style.display = '';
      document.getElementById('successSound').play();
      confetti({particleCount: 120, spread: 90, origin: { y: 0.7 }, colors: ['#00e676','#ffd700']});
      if (timerRAF) cancelAnimationFrame(timerRAF);
      setTimeout(()=>setFSMState(FSM_STATES.RESULTS), 1500);
    };
    document.getElementById('failBtn').onclick = function() {
      setFSMState(FSM_STATES.FAIL);
      onTimerEnd();
      if (timerRAF) cancelAnimationFrame(timerRAF);
    };

    // --- Ù…ÙØ§ØªÙŠØ­ Ø§Ø®ØªØµØ§Ø± Ù…ØªÙ‚Ø¯Ù…Ø© ---
    document.addEventListener('keydown', function(e) {
      if (fsmState === FSM_STATES.RUNNING) {
        if (e.code === 'Space') { pauseTimer(); e.preventDefault(); }
        if (e.key === 'ArrowUp') { addTime(5); showNotif('â±ï¸ +5 Ø«ÙˆØ§Ù†Ù!'); e.preventDefault(); }
        if (e.key === 'Enter') { document.getElementById('successBtn').click(); e.preventDefault(); }
        if (e.key === 'Escape') { document.getElementById('failBtn').click(); e.preventDefault(); }
      } else if (fsmState === FSM_STATES.PAUSED) {
        if (e.code === 'Space') { resumeTimer(); e.preventDefault(); }
      }
    });
    function updateTimer() {
      document.getElementById('timerDisplay').textContent = `00:${String(timeLeft).padStart(2,'0')}`;
    }
    function showExplosion() {
      document.getElementById('explosionMsg').textContent = 'ğŸ’¥ Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
      document.getElementById('explosionMsg').style.display = '';
      document.getElementById('failSound').play();
      confetti({particleCount: 80, spread: 70, origin: { y: 0.7 }, colors: ['#ff4757','#ffd700']});
    }
    function playTick() {
      document.getElementById('tickSound').currentTime = 0;
      document.getElementById('tickSound').play();
    }
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    loadData();
  </script>
</body>
</html>
