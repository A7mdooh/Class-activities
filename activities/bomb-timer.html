<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù†Ø´Ø§Ø· Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© â€” Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
<style>
  :root{
    --bg:#0e0f14; --panel:#14192a; --card:#1a2036; --border:#27305a; --text:#e9ecff; --muted:#9aa0b4;
    --accent:#f7c948; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1000px 600px at 80% -20%,#1a2033 0,#0e0f14 55%);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#0f1528;position:sticky;top:0;z-index:20}
  header .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  header .brand i{font-style:normal;font-size:20px}
  header .tabs{display:flex;gap:6px}
  .tab{padding:8px 12px;border:1px solid var(--border);background:#111735;border-radius:10px;cursor:pointer}
  .tab.active{background:linear-gradient(180deg,#1c2241,#101635);border-color:#33407a}
  
  /* Layout */
  .layout{display:grid;grid-template-columns:320px 1fr 340px;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
  h2,h3{margin:.2rem 0 .6rem}
  .stack{display:grid;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row > *{flex:1}
  label{font-size:.9rem;color:var(--muted)}
  input,select{width:100%;background:#121936;border:1px solid #2a3569;color:#eaf;padding:10px;border-radius:10px}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  .btn{background:#1a2142;border:1px solid #2b3568;color:#eaf;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.ok{background:linear-gradient(180deg,#1f9d54,#167846);border-color:#0f6135}
  .btn.warn{background:linear-gradient(180deg,#d17d0d,#a55e08);border-color:#8a4e07}
  .btn.danger{background:linear-gradient(180deg,#c41d1d,#921616);border-color:#7a1313}
  .btn.ghost{background:#182044;border-color:#2b3568}

  /* Sections */
  .tile{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .card-item{background:#111735;border:1px solid #26305a;border-radius:12px;padding:10px;text-align:center;cursor:pointer;transition:.2s}
  .card-item:hover{transform:translateY(-2px)}
  .card-item.active{outline:2px solid var(--accent);}

  /* Stage */
  .stage{position:relative;display:grid;place-items:center;overflow:hidden;background:linear-gradient(180deg,#0f1222,#0b0d17);border:1px solid var(--border);border-radius:16px}
  .bomb{width:170px;height:170px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #384077 0,#0e1328 60%);box-shadow:0 0 0 4px #0c1125 inset, 0 0 32px rgba(0,0,0,.56);position:relative;transition:transform .4s, filter .4s}
  .bomb::before{content:""; position:absolute; top:-24px; left:50%; transform:translateX(-50%); width:28px; height:28px; background:#2a304f; border-radius:6px; border:2px solid #10142a}
  .fuse{position:absolute; top:-30px; left:50%; transform:translateX(-50%); width:2px; height:50px; background:linear-gradient(#ffd700,#ff9800,#b45309)}
  .spark{position:absolute; top:-36px; left:calc(50% + 6px); width:10px; height:10px; border-radius:50%; background:#ffd43b; filter:drop-shadow(0 0 6px #ffd43b); animation:spark 1s linear infinite}
  @keyframes spark{0%{transform:translate(0,0) scale(1)}50%{transform:translate(6px,-8px) scale(1.2)}100%{transform:translate(12px,-16px) scale(0.8)}}
  .bomb.yellow{filter:drop-shadow(0 0 18px rgba(247,201,72,.4))}
  .bomb.red{filter:drop-shadow(0 0 24px rgba(239,68,68,.65));transform:scale(1.08)}
  .shake-soft{animation:shake .4s linear infinite}
  .shake-hard{animation:shake .2s linear infinite}
  @keyframes shake{0%{transform:translate(0,0)}25%{transform:translate(1px,1px)}50%{transform:translate(-1px,0)}75%{transform:translate(1px,-1px)}100%{transform:translate(0,0)}}
  .flash{position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none}
  .flash.show{animation:flash .5s ease}
  @keyframes flash{0%{opacity:.9}100%{opacity:0}}
  .countdown{position:absolute; bottom:22px; font-weight:900; font-size:46px; letter-spacing:1px; text-shadow:0 0 10px rgba(0,0,0,.5)}
  .countdown.warn{color:var(--warn)}
  .countdown.danger{color:var(--danger)}
  .countdown.mega{position:absolute; inset:0; display:grid; place-items:center; font-size:96px; animation:blink .3s ease-in-out infinite}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
  .heat{position:absolute; top:16px; width:min(560px,85%); height:12px; border-radius:30px; border:1px solid #2f3866; background:#12152a; overflow:hidden}
  .heat > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444)}
  .students{position:absolute; bottom:84px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; max-width:90%}
  .chip{background:rgba(27,32,51,.7); border:1px solid #2a3159; padding:8px 10px; border-radius:999px; display:flex; align-items:center; gap:8px; backdrop-filter: blur(4px)}
  .chip b{font-size:1rem}
  .chip i{font-style:normal; font-size:1.1rem}

  /* KPI & Log */
  .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:6px; text-align:center}
  .kpi .box{background:#131833;border:1px solid var(--border); padding:10px; border-radius:10px}
  .log{max-height:240px; overflow:auto; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.85rem; background:#0f1329; border:1px dashed var(--border); padding:10px; border-radius:10px}

  /* Results modal */
  .results{position:absolute; inset:0; display:none; place-items:center; background:rgba(6,8,16,.72); backdrop-filter:blur(6px)}
  .results.show{display:grid}
  .card-result{background:#0f142b; border:1px solid var(--border); border-radius:16px; padding:18px; text-align:center; min-width:280px}
  .badge{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #2f3866; background:#151b36; margin:4px}

  /* Two-in-one: teacher vs student panes */
  .view-toggle{display:flex;gap:6px;margin-inline-start:auto}
  .views{display:grid;grid-template-columns:1fr;gap:12px}
  .student-view .teacher-only{display:none}
  .teacher-view .student-only{display:none}

  /* Accessibility */
  @media (prefers-reduced-motion: reduce){
    .shake-soft,.shake-hard,.spark,.countdown.mega{animation:none !important}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand"><i>ğŸ’£</i> <span>Ù†Ø´Ø§Ø· Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© â€” ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ù‘Ø¯Ø©</span></div>
      <div class="view-toggle">
        <button id="teacherTab" class="tab active" aria-pressed="true">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙØ¹Ù„Ù‘Ù…</button>
        <button id="studentTab" class="tab" aria-pressed="false">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      </div>
    </header>

    <div class="layout views teacher-view" id="viewsRoot">
      <!-- Ù„ÙˆØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… (ÙŠØ³Ø§Ø±) -->
      <aside class="panel teacher-only" aria-label="Ù„ÙˆØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
        <div class="stack">
          <div>
            <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
            <select id="phase">
              <option value="selectClass">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ</option>
              <option value="selectStudents">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨</option>
              <option value="stage">Ù…Ø´Ù‡Ø¯ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©</option>
            </select>
          </div>
          <div>
            <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
            <select id="difficulty">
              <option value="Easy">Ø³Ù‡Ù„ (60s)</option>
              <option value="Medium" selected>Ù…ØªÙˆØ³Ø· (35s)</option>
              <option value="Hard">ØµØ¹Ø¨ (20s)</option>
              <option value="Custom">Ù…Ø®ØµØµ</option>
            </select>
          </div>
          <div class="row">
            <div>
              <label>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙƒÙÙ„ÙŠÙ‘Ø© (Ø«)</label>
              <input id="duration" type="number" min="5" max="300" value="35" />
            </div>
            <div>
              <label>ÙˆÙ‚Øª ÙƒÙ„ Ù„Ø§Ø¹Ø¨ (Ø«)</label>
              <input id="perPlayer" type="number" min="5" max="120" value="15" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨/Ø§Ù„Ø¬ÙˆÙ„Ø©</label>
              <input id="perRound" type="number" min="1" max="5" value="1" />
            </div>
            <div class="switch"><input id="soundOn" type="checkbox" checked /><label for="soundOn">Ø§Ù„Ø£ØµÙˆØ§Øª</label></div>
          </div>
          <div class="row">
            <div class="switch"><input id="allowSurprises" type="checkbox" checked /><label for="allowSurprises">Ø§Ù„Ù…ÙØ§Ø¬Ø¢Øª</label></div>
            <div class="switch"><input id="fairPick" type="checkbox" /><label for="fairPick">Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø§Ø¯Ù„</label></div>
          </div>
          <div class="row">
            <button id="startBtn" class="btn ok" disabled>Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ â±ï¸</button>
            <button id="pauseBtn" class="btn ghost" disabled>Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª â¸</button>
          </div>
          <div class="row">
            <button id="add5Btn" class="btn warn" disabled>+5 Ø«ÙˆØ§Ù†Ù â©</button>
            <button id="successBtn" class="btn ok" disabled>Ø¥Ø¹Ù„Ø§Ù† Ù†Ø¬Ø§Ø­ âœ…</button>
            <button id="failBtn" class="btn danger" disabled>Ø¥Ù†Ù‡Ø§Ø¡/ÙØ´Ù„ ğŸ’¥</button>
          </div>
          <div class="tile">
            <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
            <div class="kpi">
              <div class="box"><div>Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</div><b id="kRounds">0</b></div>
              <div class="box"><div>Ù†Ø¬Ø§Ø­Ø§Øª</div><b id="kWins">0</b></div>
              <div class="box"><div>ÙØ´Ù„</div><b id="kFails">0</b></div>
            </div>
          </div>
          <div class="tile">
            <h3>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
            <div id="log" class="log" aria-live="polite"></div>
          </div>
        </div>
      </aside>

      <!-- Ø§Ù„Ù…Ø³Ø±Ø­ (ÙˆØ³Ø·) -->
      <main class="stage panel" id="stage" aria-label="Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨">
        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ -->
        <section id="sectionClass" class="stack">
          <h2>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</h2>
          <div id="classGrid" class="grid" role="list"></div>
        </section>
        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ -->
        <section id="sectionStudents" class="stack" hidden>
          <h2>Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
          <div id="studentsGrid" class="grid" role="list"></div>
          <div style="text-align:center"><small>ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø­ØªÙ‰ <span id="limitSpan">1</span> Ø·Ø§Ù„Ø¨/Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©.</small></div>
        </section>
        <!-- Ù…Ø´Ù‡Ø¯ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© -->
        <section id="sectionStage" class="stack" hidden>
          <div class="heat"><i id="heatFill"></i></div>
          <div class="students" id="selectedChips"></div>
          <div class="bomb" id="bomb">
            <div class="fuse"></div>
            <div class="spark" id="spark"></div>
            <div class="countdown" id="countdown">â€”</div>
          </div>
          <div class="flash" id="flash"></div>
          <div class="results" id="results">
            <div class="card-result">
              <div id="resultIcon" style="font-size:42px">ğŸ‰</div>
              <h2 id="resultTitle">Ù…Ù…ØªØ§Ø²!</h2>
              <p id="resultText">ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.</p>
              <div id="resultBadges"></div>
              <div style="margin-top:10px"><button class="btn ghost" id="closeResults">Ø¥ØºÙ„Ø§Ù‚</button></div>
            </div>
          </div>
          <div class="confetti" id="confetti"></div>
        </section>
      </main>

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (ÙŠÙ…ÙŠÙ†) -->
      <aside class="panel" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø§Ø¨">
        <h2>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
        <div id="studentView" class="stack">
          <div class="tile student-only"><b>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠâ€¦</b></div>
          <div class="tile">
            <h3>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</h3>
            <div id="turnList" class="stack"></div>
          </div>
          <div class="tile">
            <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <div id="turnStatus" style="font-size:1rem;color:var(--muted)">â€”</div>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ===================== Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† JSON ===================== */
const DATA_URL = 'data/studentData.json';
let DATA = { classes: [], students: {} };

async function loadData(){
  try{
    const res = await fetch(DATA_URL, { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const json = await res.json();
    // Ù‡ÙŠÙƒÙ„Ø© Ù…Ø±Ù†Ø©: Ù†Ù‚Ø¨Ù„ Ø´ÙƒÙ„ÙŠÙ†
    // 1) { classes:[{id,name,icon}], students:{ [classId]: [{id,name,avatar}] } }
    // 2) { classes:[{id,name,icon, students:[...]}] }
    if(Array.isArray(json.classes)){
      DATA.classes = json.classes.map(c=>({ id: c.id || c.classId || String(c.name||'C'), name: c.name || ('ØµÙ '+(c.id||'')), icon: c.icon || 'ğŸ«', students: c.students }));
      if(json.students && typeof json.students==='object'){
        DATA.students = json.students;
      } else {
        // Ø§Ø¨Ù†ÙŠ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø¥Ù† ÙˆÙØ¬Ø¯ students Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ
        DATA.students = {};
        DATA.classes.forEach(c=>{ if(Array.isArray(c.students)) DATA.students[c.id] = c.students; });
      }
    } else {
      throw new Error('Ù‡ÙŠÙƒÙ„ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ù„Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
    buildClassGrid();
  }catch(err){
    console.error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', err);
    const holder = document.getElementById('classGrid');
    holder.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'tile';
    box.innerHTML = '<b>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</b><br><small>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± data/studentData.json Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.</small>';
    const retry = document.createElement('button');
    retry.className = 'btn warn';
    retry.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
    retry.onclick = loadData;
    holder.appendChild(box);
    holder.appendChild(retry);
  }
}

/* ===================== Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ===================== */
const viewsRoot = document.getElementById('viewsRoot');
const teacherTab = document.getElementById('teacherTab');
const studentTab = document.getElementById('studentTab');

const sectionClass    = document.getElementById('sectionClass');
const sectionStudents = document.getElementById('sectionStudents');
const sectionStage    = document.getElementById('sectionStage');

const classGrid    = document.getElementById('classGrid');
const studentsGrid = document.getElementById('studentsGrid');
const selectedChips= document.getElementById('selectedChips');
const limitSpan    = document.getElementById('limitSpan');

const elDifficulty = document.getElementById('difficulty');
const elDuration   = document.getElementById('duration');
const elPerPlayer  = document.getElementById('perPlayer');
const elPerRound   = document.getElementById('perRound');
const elSoundOn    = document.getElementById('soundOn');
const elAllowSur   = document.getElementById('allowSurprises');
const elFairPick   = document.getElementById('fairPick');
const phaseSelect  = document.getElementById('phase');

const startBtn   = document.getElementById('startBtn');
const pauseBtn   = document.getElementById('pauseBtn');
const add5Btn    = document.getElementById('add5Btn');
const successBtn = document.getElementById('successBtn');
const failBtn    = document.getElementById('failBtn');

const countdownEl = document.getElementById('countdown');
const heatFill    = document.getElementById('heatFill');
const bomb        = document.getElementById('bomb');
const flash       = document.getElementById('flash');
const resultsEl   = document.getElementById('results');
const resultIcon  = document.getElementById('resultIcon');
const resultTitle = document.getElementById('resultTitle');
const resultText  = document.getElementById('resultText');
const resultBadges= document.getElementById('resultBadges');
const closeResults= document.getElementById('closeResults');
const confettiBox = document.getElementById('confetti');

const turnList   = document.getElementById('turnList');
const turnStatus = document.getElementById('turnStatus');
const logEl      = document.getElementById('log');

/* ===================== Ø­Ø§Ù„Ø§Øª ÙˆØµØ¹ÙˆØ¨Ø§Øª ===================== */
const Difficulty = {
  Easy:    { duration: 60, pace: "slow",  surpriseProb: 0.05, effects:{ shake:false, flashAtEnd:true } },
  Medium:  { duration: 35, pace: "mid",   surpriseProb: 0.08, effects:{ shake:true,  flashAtEnd:true } },
  Hard:    { duration: 20, pace: "fast",  surpriseProb: 0.12, effects:{ shake:true,  flashAtEnd:true } },
  Custom:  { duration: 45, pace: "mid",   surpriseProb: 0.10, effects:{ shake:true,  flashAtEnd:true } }
};

const Bus = (()=>{ const m=new Map(); return { on:(e,h)=>m.set(e,(m.get(e)||[]).concat(h)), emit:(e,p)=> (m.get(e)||[]).forEach(h=>h(p)) }})();
const GameState = (()=>{ let s="IDLE"; const T={ IDLE:["ARMING"], ARMING:["RUNNING","IDLE"], RUNNING:["PAUSED","SUCCESS","FAIL","RESULTS"], PAUSED:["RUNNING","RESULTS"], SUCCESS:["RESULTS"], FAIL:["RESULTS"], RESULTS:["IDLE","ARMING"] }; return { get:()=>s, to:(n)=>{ if((T[s]||[]).includes(n)){ s=n; Bus.emit("state",s);} } }})();

/* ===================== ØµÙˆØªÙŠØ§Øª Ø®ÙÙŠÙØ© ===================== */
const Sound = (() => {
  let ctx=null, enabled=true; function ensure(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(freq=880,ms=80,type="sine",gain=0.035){ if(!enabled) return; ensure(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+ms/1000);} 
  return {
    enable(v){enabled=!!v; if(enabled) ensure();}, resume(){ if(ctx && ctx.state==="suspended") ctx.resume(); },
    tickSlow:()=>beep(680,28,"square",.03), tickFast:()=>beep(900,24,"square",.035), heart:()=>{beep(120,60,"sine",.06); setTimeout(()=>beep(120,60,"sine",.06),120);}, alarm:()=>beep(1100,130,"sawtooth",.05), success:()=>{beep(660,120,"triangle",.05); setTimeout(()=>beep(880,140,"triangle",.05),150);}, boom:()=>{beep(80,200,"sawtooth",.08); setTimeout(()=>beep(50,260,"sawtooth",.08),120);} }
})();

/* ===================== Ù…Ø¤Ù‚Ù‘Øª rAF ===================== */
function createTimer(totalMs){
  let left=totalMs, id=null, last=performance.now(); const marks=new Set();
  function tick(now){ left -= now-last; last=now; Bus.emit("timer:tick",{left,seconds:Math.ceil(left/1000), total: totalMs}); const s=Math.ceil(left/1000); const half=Math.ceil(totalMs/2000);
    if(!marks.has("half") && s===half){ marks.add("half"); Bus.emit("timer:flag","half"); }
    if(!marks.has("last10") && s===10){ marks.add("last10"); Bus.emit("timer:flag","last10"); }
    if(s<=3){ Bus.emit("timer:flag","last3"); }
    if(left<=0){ cancelAnimationFrame(id); id=null; Bus.emit("timer:end"); return; }
    id=requestAnimationFrame(tick);
  }
  return { start(){ last=performance.now(); id=requestAnimationFrame(tick); Bus.emit("timer:start",{totalMs}); }, pause(){ if(id){ cancelAnimationFrame(id); id=null; Bus.emit("timer:pause",{left}); } }, resume(){ if(!id){ last=performance.now(); id=requestAnimationFrame(tick); Bus.emit("timer:resume",{left}); } }, add(ms){ left+=ms; Bus.emit("timer:add",{left,ms}); }, get left(){return left;} }
}

/* ===================== Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© ===================== */
function log(msg){ const t=new Date().toLocaleTimeString(); logEl.innerHTML = `<div>[${t}] ${msg}</div>` + logEl.innerHTML; }
function setStartEnabled(v){ startBtn.disabled=!v; }
function setControls(running){ pauseBtn.disabled=add5Btn.disabled=successBtn.disabled=failBtn.disabled=!running; }
function toast(text){ const t=document.createElement('div'); t.style.cssText="position:absolute;top:16px;left:50%;transform:translateX(-50%);background:#111834;border:1px solid #2a3159;color:#eaf;padding:8px 12px;border-radius:999px;z-index:9"; t.textContent=text; document.getElementById('stage').appendChild(t); setTimeout(()=>t.remove(), 1400); }
function doFlash(){ flash.classList.remove("show"); void flash.offsetWidth; flash.classList.add("show"); }
function boom(){ document.getElementById('stage').classList.add("shake-hard"); doFlash(); Sound.boom(); setTimeout(()=>document.getElementById('stage').classList.remove("shake-hard"),600); }
function confetti(){ const box=document.getElementById('confetti'); box.innerHTML=""; for(let i=0;i<120;i++){ const p=document.createElement("i"); p.style.cssText=`position:absolute;top:-10px;width:8px;height:12px;background:hsla(${Math.floor(Math.random()*360)},90%,60%,.95);transform:rotate(${Math.floor(Math.random()*360)}deg);animation:fall ${2+Math.random()*1.8}s linear forwards;left:${Math.random()*100}%`; box.appendChild(p);} setTimeout(()=>box.innerHTML="",3000); }

/* ===================== Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù„Ø³Ø© ===================== */
let SELECTED_CLASS = null;
let ALL_STUDENTS = {}; // by classId
let CURRENT_SELECTED = []; // [{id,name,avatar}]
let TURN_INDEX = 0;
let GLOBAL_TIMER = null; let TURN_TIMER = null;

const Stats = (()=> { const key="bomb-pro-stats"; const store=JSON.parse(localStorage.getItem(key) || '{"session":{"total":0,"success":0,"fail":0},"students":{}}'); function save(){ localStorage.setItem(key, JSON.stringify(store)); }
  function recordRound(res){ store.session.total++; if(res.outcome==="SUCCESS") store.session.success++; else if(res.outcome==="FAIL") store.session.fail++; res.selectedStudents.forEach(s=>{ const st=store.students[s.id] || (store.students[s.id]={ name:s.name, points:0, rounds:0, success:0 }); st.rounds++; if(res.outcome==="SUCCESS"){ st.success++; st.points += res.pointsAwarded[s.id]||0; } }); save(); updateKPIs(); updateStudentPanels(); }
  function k(){ return store.session; } function getStudent(id){ return store.students[id]; } return { recordRound, k, getStudent } })();
function updateKPIs(){ const k=Stats.k(); document.getElementById('kRounds').textContent=k.total; document.getElementById('kWins').textContent=k.success; document.getElementById('kFails').textContent=k.fail; }

/* ===================== Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª: ØµÙÙˆÙ ÙˆØ·Ù„Ø§Ø¨ ===================== */
function buildClassGrid(){
  classGrid.innerHTML = '';
  if(!Array.isArray(DATA.classes) || DATA.classes.length===0){
    const emp = document.createElement('div'); emp.className='tile'; emp.innerHTML='<small>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</small>'; classGrid.appendChild(emp); return;
  }
  DATA.classes.forEach(c=>{
    const it = document.createElement('button');
    it.className = 'card-item';
    it.setAttribute('role','listitem');
    const icon = document.createElement('div'); icon.style.fontSize='26px'; icon.textContent = c.icon || 'ğŸ«';
    const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = c.name || c.id;
    it.append(icon, name);
    it.onclick = ()=> selectClass(c.id);
    classGrid.appendChild(it);
  });
}</div><div style="font-weight:700">${c.name}</div>`; it.onclick=()=> selectClass(c.id); classGrid.appendChild(it); }); }
function selectClass(id){
  SELECTED_CLASS = id;
  ALL_STUDENTS = DATA.students || {};
  sectionClass.hidden = true;
  sectionStudents.hidden = false;
  sectionStage.hidden = true;
  phaseSelect.value = 'selectStudents';
  buildStudentsGrid();
  log(`Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ: ${id}`);
}`); }
function buildStudentsGrid(){ const arr = [...(ALL_STUDENTS[SELECTED_CLASS]||[])]; studentsGrid.innerHTML=""; arr.forEach(s=>{ const b=document.createElement('button'); b.className='card-item'; b.setAttribute('role','listitem'); b.onclick=()=> toggleStudent(s,b); const label=document.createElement('div'); label.style.fontWeight='700'; label.textContent=s.name; const emo=document.createElement('div'); emo.style.fontSize='22px'; emo.textContent=s.avatar||'ğŸ‘¤'; b.appendChild(emo); b.appendChild(label); studentsGrid.appendChild(b); }); updateSelectedChips(); updateStartButton(); }
function toggleStudent(s,btn){ const idx = CURRENT_SELECTED.findIndex(x=>x.id===s.id); const limit = Number(elPerRound.value||1); if(idx>=0){ CURRENT_SELECTED.splice(idx,1); btn.classList.remove('active'); } else { if(CURRENT_SELECTED.length>=limit){ toast(`Ø§Ù„Ø­Ø¯ ${limit} Ø·Ù„Ø§Ø¨.`); return; } CURRENT_SELECTED.push({...s}); btn.classList.add('active'); } updateSelectedChips(); updateStartButton(); }
function updateSelectedChips(){ selectedChips.innerHTML=""; CURRENT_SELECTED.forEach(s=>{ const chip=document.createElement('div'); chip.className='chip'; const i=document.createElement('i'); i.textContent=s.avatar||'ğŸ‘¤'; const b=document.createElement('b'); b.textContent=s.name; chip.append(i,b); selectedChips.appendChild(chip); }); limitSpan.textContent=String(elPerRound.value||1); buildTurnList(); }
function buildTurnList(){ turnList.innerHTML=""; if(CURRENT_SELECTED.length===0){ turnList.innerHTML='<small>Ù„Ø§ Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø¨Ø¹Ø¯.</small>'; return; } CURRENT_SELECTED.forEach((s,idx)=>{ const t=document.createElement('div'); t.className='row'; t.innerHTML = `<div class="chip" style="flex:none"><i>${s.avatar||'ğŸ‘¤'}</i><b>${s.name}</b></div><div style="font-size:.9rem;color:var(--muted)">${idx===TURN_INDEX? 'ğŸ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ' : 'â€¦ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙˆØ±'}</div>`; turnList.appendChild(t); }); }

/* ===================== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©) ===================== */
phaseSelect.addEventListener('change',()=>{ const ph=phaseSelect.value; sectionClass.hidden = ph!=='selectClass'; sectionStudents.hidden = ph!=='selectStudents'; sectionStage.hidden = ph!=='stage'; });

/* ===================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ ===================== */
function updateStartButton(){ startBtn.disabled = CURRENT_SELECTED.length===0; }
function startChallenge(){ if(CURRENT_SELECTED.length===0){ alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹'); return; } Sound.resume(); setStartEnabled(false); setControls(true);
  // ØªÙ‡ÙŠØ¦Ø© Ù…Ø´Ù‡Ø¯ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
  sectionClass.hidden=true; sectionStudents.hidden=true; sectionStage.hidden=false; phaseSelect.value='stage';
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  const d = Difficulty[elDifficulty.value] || Difficulty.Medium; if(elDifficulty.value!=="Custom") elDuration.value=d.duration; const total = Number(elDuration.value||d.duration)*1000; const per = Number(elPerPlayer.value||15)*1000; const allowSur = elAllowSur.checked; const pace=d.pace; 
  // ARming
  GameState.to('ARMING'); countdownEl.textContent='Ø¬Ø§Ù‡Ø²ØŸ'; bomb.classList.remove('yellow','red','shake-soft','shake-hard');
  setTimeout(()=>{
    // RUNNING
    GameState.to('RUNNING');
    startGlobal(total, per, { allowSur, pace, surpriseProb:d.surpriseProb });
  }, 1500);
}

function startGlobal(totalMs, perPlayerMs, options){
  // Ù…Ø¤Ù‚Ù‘Øª ÙƒÙ„ÙŠ
  GLOBAL_TIMER = createTimer(totalMs);
  let paceTimer=null; function setPace(mode){ if(paceTimer) clearInterval(paceTimer); if(mode==='slow') paceTimer=setInterval(Sound.tickSlow,1000); if(mode==='mid') paceTimer=setInterval(Sound.tickFast,700); if(mode==='fast') paceTimer=setInterval(Sound.tickFast,450); }
  setPace(options.pace);
  // Ù…ÙØ§Ø¬Ø£Ø©
  if(options.allowSur && Math.random() < (options.surpriseProb||0.08)) setTimeout(()=>{ GLOBAL_TIMER.add(5000); toast('ğŸ Ù…ÙØ§Ø¬Ø£Ø© +5s'); }, 4000 + Math.random()*5000);

  attachTeacherControls(GLOBAL_TIMER, declareSuccess, declareFail);
  TURN_INDEX = 0; startTurn(perPlayerMs);

  Bus.on('timer:tick', ({left,seconds,total})=>{ countdownEl.textContent=seconds; const p=Math.max(0, Math.min(1, 1-(left/total))); heatFill.style.width=(p*100)+'%'; if(p>.5 && p<.8) bomb.classList.add('yellow'); if(p>=.8) bomb.classList.add('red'); turnStatus.textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¬ÙˆÙ„Ø©: ${seconds}s`;
  });
  Bus.on('timer:flag', tag=>{ if(tag==='half') log('âœ³ï¸ Ù†ØµÙ Ø§Ù„ÙˆÙ‚Øª'); if(tag==='last10'){ bomb.classList.add('shake-soft'); toast('âš ï¸ Ø¢Ø®Ø± 10 Ø«ÙˆØ§Ù†Ù'); } if(tag==='last3'){ countdownEl.classList.add('mega','danger'); Sound.alarm(); } });
  Bus.on('timer:end', ()=>{ boom(); declareFail(); });
  GLOBAL_TIMER.start();

  function declareSuccess(){ if(GameState.get()!=='RUNNING' && GameState.get()!=='PAUSED') return; GLOBAL_TIMER.pause(); GameState.to('SUCCESS'); showResults({ outcome:'SUCCESS', selectedStudents: CURRENT_SELECTED }); }
  function declareFail(){ if(GameState.get()!=='RUNNING' && GameState.get()!=='PAUSED') return; GLOBAL_TIMER.pause(); GameState.to('FAIL'); boom(); showResults({ outcome:'FAIL', selectedStudents: CURRENT_SELECTED }); }
}

function startTurn(perMs){ updateTurnUI(); TURN_TIMER && TURN_TIMER.pause(); TURN_TIMER=null; let left=perMs; const s = CURRENT_SELECTED[TURN_INDEX]; turnStatus.textContent=`ğŸ¯ Ø¯ÙˆØ± ${s.name} â€” ${Math.ceil(left/1000)}s`;
  const id = setInterval(()=>{ left-=1000; updateTurnUI(); if(left<=0){ clearInterval(id); nextTurn(perMs); }
  },1000);
  // Ø®ÙÙ‘Ø©: Ù†Ø¨Ø¶Ø© Ù‚Ù„Ø¨ Ø®ÙÙŠÙØ© Ù…Ø¹ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
  const hb = setInterval(()=> Sound.heart(), 2000);
  TURN_TIMER = { pause(){ clearInterval(id); clearInterval(hb); }, resume(){ /* Ù…Ø¨Ø³Ù‘Ø·Ø©: Ù„Ø§ Ø­Ø§Ø¬Ø© Ø§Ù„Ø¢Ù† */ } };
}
function nextTurn(perMs){ TURN_INDEX++; if(TURN_INDEX>=CURRENT_SELECTED.length){ // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± â€” Ø§Ù„Ù…Ø¹Ù„Ù… ÙŠÙ‚Ø±Ø± Ù†Ø¬Ø§Ø­Ù‹Ø§ Ø£Ùˆ ÙŠØ³ØªÙ…Ø± Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª
  toast('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± â€” Ø£Ø¹Ù„Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©'); return; } startTurn(perMs); }
function updateTurnUI(){ buildTurnList(); const s = CURRENT_SELECTED[TURN_INDEX]; const secs = Math.max(0, Number(elPerPlayer.value||15)); turnStatus.textContent=`ğŸ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${s.name} â€” ${secs}s Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨`; }

/* ===================== Ù†ØªØ§Ø¦Ø¬ ===================== */
function showResults({ outcome, selectedStudents }){ const award = (outcome==='SUCCESS') ? 10 : 0; const result = { roundId: crypto.randomUUID(), selectedStudents, outcome, pointsAwarded:Object.fromEntries(selectedStudents.map(s=>[s.id, award])) };
  Stats.recordRound(result);
  if(outcome==='SUCCESS'){ resultIcon.textContent='ğŸ‰'; resultTitle.textContent='Ù…Ù…ØªØ§Ø²!'; resultText.textContent='ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.'; confetti(); Sound.success(); resultBadges.innerHTML='<span class="badge">ğŸ… Ø³Ø±ÙŠØ¹ Ø§Ù„Ø±Ø¯</span><span class="badge">ğŸ’¬ Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø«Ù‚Ø©</span>'; }
  else if(outcome==='FAIL'){ resultIcon.textContent='ğŸ’¥'; resultTitle.textContent='Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©!'; resultText.textContent='Ø­Ø§ÙˆÙ„ÙˆØ§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'; }
  else { resultIcon.textContent='â¹ï¸'; resultTitle.textContent='ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù'; resultText.textContent='Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¨ÙƒØ± Ù„Ù„Ø¬ÙˆÙ„Ø©.'; }
  resultsEl.classList.add('show');
}
closeResults.onclick = ()=>{ resultsEl.classList.remove('show'); setStartEnabled(true); setControls(false); countdownEl.classList.remove('mega','danger','warn'); };

/* ===================== ØªØ­ÙƒÙ‘Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ===================== */
function attachTeacherControls(timer, onSuccess, onFail){ pauseBtn.onclick = ()=>{ if(GameState.get()==='RUNNING'){ timer.pause(); pauseBtn.textContent='Ø§Ø³ØªØ¦Ù†Ø§Ù â–¶ï¸'; GameState.to('PAUSED'); log('PAUSED'); } else if(GameState.get()==='PAUSED'){ timer.resume(); pauseBtn.textContent='Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª â¸'; GameState.to('RUNNING'); log('RESUMED'); } };
  add5Btn.onclick = ()=> timer.add(5000);
  successBtn.onclick = ()=> onSuccess();
  failBtn.onclick    = ()=> onFail();
}

/* ===================== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© ===================== */
teacherTab.addEventListener('click',()=>{ teacherTab.classList.add('active'); teacherTab.setAttribute('aria-pressed','true'); studentTab.classList.remove('active'); studentTab.setAttribute('aria-pressed','false'); viewsRoot.classList.add('teacher-view'); viewsRoot.classList.remove('student-view'); });
studentTab.addEventListener('click',()=>{ studentTab.classList.add('active'); studentTab.setAttribute('aria-pressed','true'); teacherTab.classList.remove('active'); teacherTab.setAttribute('aria-pressed','false'); viewsRoot.classList.add('student-view'); viewsRoot.classList.remove('teacher-view'); });

/* ===================== ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===================== */
elDifficulty.addEventListener('change',()=>{ const d=Difficulty[elDifficulty.value]; if(elDifficulty.value!=="Custom") elDuration.value=d.duration; });
elSoundOn.addEventListener('change',()=> Sound.enable(elSoundOn.checked) );
elPerRound.addEventListener('change',()=>{ if(CURRENT_SELECTED.length>Number(elPerRound.value||1)){ CURRENT_SELECTED.length = Number(elPerRound.value||1); buildStudentsGrid(); } updateSelectedChips(); updateStartButton(); });

/* ===================== Hotkeys ===================== */
window.addEventListener('keydown',(e)=>{ if(e.key===' '){ e.preventDefault(); pauseBtn.click(); } if(e.key==='Enter'){ e.preventDefault(); successBtn.click(); } if(e.key==='Escape'){ e.preventDefault(); failBtn.click(); } if(e.key==='ArrowUp'){ e.preventDefault(); add5Btn.click(); } });

/* ===================== ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ===================== */
function refreshPhase(){ const ph=phaseSelect.value; startBtn.disabled = (CURRENT_SELECTED.length===0) || ph!=='selectStudents'; pauseBtn.disabled=add5Btn.disabled=successBtn.disabled=failBtn.disabled = (ph!=='stage'); }
phaseSelect.addEventListener('change', refreshPhase);

/* ===================== Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ ===================== */
startBtn.addEventListener('click', startChallenge);

/* ===================== ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (ÙŠÙ…ÙŠÙ†) ===================== */
function updateStudentPanels(){ CURRENT_SELECTED.forEach(s=>{ /* ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ø±Ø¶ Ù†Ù‚Ø§Ø·/Ù†Ø¬Ø§Ø­Ø§Øª Ù…Ù† Stats.getStudent(s.id) */ }); }

/* ===================== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ===================== */
loadData();
updateKPIs();
refreshPhase();
</script>
</body>
</html>
