<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üí£ ŸÑÿπÿ®ÿ© ÿßŸÑŸÇŸÜÿ®ŸÑÿ© ÿßŸÑŸÖÿ§ŸÇÿ™ÿ© (ŸÜÿ≥ÿÆÿ© ŸÖŸèŸÅÿπŸëŸÑÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --oman-red: #dc143c;
      --oman-green: #228b22;
      --oman-white: #fff;
      --accent-gold: #ffd700;
      --gradient-danger: linear-gradient(90deg, #dc143c 0%, #ffd700 100%);
      --gradient-safe: linear-gradient(90deg, #228b22 0%, #ffd700 100%);
      --gradient-warning: linear-gradient(90deg, #ffd700 0%, #dc143c 100%);
      --gradient-gold: linear-gradient(90deg, #ffd700 0%, #fff 100%);
      --gradient-dark: linear-gradient(135deg, #181a23 0%, #23243a 100%);
      --gradient-background: radial-gradient(ellipse at 70% 0%, #23243a 0%, #181a23 100%);
      --glass: rgba(255, 255, 255, 0.08);
      --shadow: 0 4px 24px #0006;
      --glow-gold: 0 0 16px #ffd70099;
      --info-card-border: 2px solid var(--accent-gold);
      --info-card-shadow: 0 2px 8px #ffd70033;
    }
    html, body { height:100%; min-height:100vh; margin:0; padding:0; background:var(--gradient-background); color:var(--oman-white); font-family:'Cairo', system-ui, sans-serif; overflow-x:hidden; }
    body::before { content:""; position:fixed; inset:0; z-index:0; pointer-events:none; background: radial-gradient(circle at 80% 10%, #ffd70022 0, transparent 60%), radial-gradient(circle at 20% 90%, #dc143c22 0, transparent 60%), radial-gradient(circle at 50% 50%, #228b2222 0, transparent 70%); animation:bgMove 12s linear infinite alternate; }
    @keyframes bgMove { 0%{background-position:80% 10%, 20% 90%, 50% 50%} 100%{background-position:70% 20%, 30% 80%, 60% 60%} }

    /* Toolbar */
    .top-toolbar { position:fixed; top:0; left:0; right:0; height:68px; background:var(--gradient-dark); display:flex; align-items:center; justify-content:flex-end; gap:12px; z-index:1000; box-shadow:var(--shadow); padding:0 24px; border-bottom:2px solid #ffd70033; backdrop-filter:blur(10px); }
    .toolbar-btn { width:48px; height:48px; border-radius:50%; background:var(--glass); border:none; color:var(--accent-gold); font-size:1.4rem; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px #ffd70022; cursor:pointer; transition:.18s; outline:none; }
    .toolbar-btn:hover, .toolbar-btn:active { background:#ffd70022; color:var(--oman-red); box-shadow:0 0 0 3px #ffd70055; }
    .toolbar-btn:focus { box-shadow:0 0 0 3px #ffd70099; }

    /* Header */
    .header { margin-top:80px; background:var(--gradient-dark); border-radius:0 0 32px 32px; box-shadow:var(--shadow); padding:32px 0 18px; text-align:center; position:relative; }
    .header-title { font-size:2.7rem; font-weight:900; color:var(--accent-gold); letter-spacing:1px; text-shadow:var(--glow-gold); animation:pulseTitle 2.5s infinite; }
    @keyframes pulseTitle { 0%,100%{text-shadow:var(--glow-gold)} 50%{text-shadow:0 0 32px #ffd700cc} }
    .header-subtitle { font-size:1.2rem; color:#ffd700cc; margin-top:10px; font-weight:500; text-shadow:0 2px 8px #000a; }

    /* Layout */
    .main-content { display:grid; grid-template-columns:1fr 1.2fr 1fr; gap:24px; max-width:1400px; margin:0 auto; padding:32px 12px; position:relative; z-index:1; }
    @media (max-width:1100px){ .main-content{ grid-template-columns:1fr 1.5fr } .game-info{ display:none } }
    @media (max-width:900px){ .main-content{ grid-template-columns:1fr } .game-info,.teacher-controls{ display:none } .bomb-area{ margin:0 auto } }

    /* Info cards */
    .game-info { display:flex; flex-direction:column; gap:18px; }
    .info-card { background:var(--glass); border:var(--info-card-border); border-radius:16px; box-shadow:var(--info-card-shadow); padding:18px 14px; color:var(--accent-gold); font-size:1.05rem; font-weight:800; display:flex; align-items:center; gap:12px; transition:.18s; }
    .info-card:hover { background:#ffd70011; color:var(--oman-red); box-shadow:0 0 0 3px #ffd70055; }

    /* Bomb area */
    .bomb-area { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:480px; gap:18px; position:relative; }
    .game-state { font-size:1.15rem; font-weight:900; padding:8px 22px; border-radius:12px; background:var(--gradient-warning); color:var(--oman-red); box-shadow:0 2px 8px #ffd70033; transition:.3s; text-align:center; }
    .state-waiting{ background:var(--gradient-warning); color:var(--oman-red) }
    .state-active{ background:var(--gradient-danger); color:#fff; animation:shake .7s infinite alternate }
    .state-success{ background:var(--gradient-safe); color:var(--oman-green) }
    .state-explosion{ background:var(--gradient-danger); color:#fff; animation:shake .2s 8 alternate }
    @keyframes shake{ 0%{transform:translateX(0)} 25%{transform:translateX(-4px)} 50%{transform:translateX(4px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)} }

    .bomb { width:180px; height:180px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #ffd700 0, #23243a 60%); box-shadow:0 0 0 4px #ffd70044 inset, 0 0 32px #ffd70033, 0 8px 30px #000a; display:flex; align-items:center; justify-content:center; font-size:5rem; color:#ffd700; position:relative; margin-bottom:12px; animation:bombPulse 1.5s infinite; transition: box-shadow .3s; }
    @keyframes bombPulse{ 0%,100%{box-shadow:0 0 0 4px #ffd70044 inset, 0 0 32px #ffd70033, 0 8px 30px #000a} 50%{box-shadow:0 0 0 8px #ffd70088 inset, 0 0 64px #ffd70077, 0 8px 30px #000a} }
    .fuse{ position:absolute; top:-38px; left:50%; transform:translateX(-50%); width:5px; height:60px; border-radius:8px; background:linear-gradient(#ffd700,#dc143c,#ffd700 80%); box-shadow:0 0 8px #ffd70099; z-index:2; overflow:visible }
    .fuse-flame{ position:absolute; top:-48px; left:50%; transform:translateX(-50%); width:22px; height:22px; border-radius:50%; background: radial-gradient(circle, #ffd700 60%, #dc143c 100%); filter:drop-shadow(0 0 12px #ffd700cc); animation:flameFlicker .18s infinite alternate; z-index:3; display:flex; align-items:center; justify-content:center; font-size:1.3rem }
    @keyframes flameFlicker{ 0%{opacity:1; transform:translateX(-50%) scale(1)} 100%{opacity:.7; transform:translateX(-50%) scale(1.15)} }

    .timer-display{ font-family:'Cairo', monospace; font-size:3.2rem; font-weight:900; color:var(--accent-gold); background:#181a23cc; border-radius:18px; padding:10px 38px; margin:0 auto 8px; text-align:center; letter-spacing:2px; box-shadow:0 2px 8px #ffd70033; text-shadow:0 0 18px #ffd70099; animation:pulseTimer 1.2s infinite }
    @keyframes pulseTimer { 0%,100%{text-shadow:0 0 18px #ffd70099} 50%{text-shadow:0 0 32px #ffd700cc} }
    .timer-text{ font-size:1.05rem; color:#ffd700cc; margin-bottom:8px; text-align:center }
    .timer-highlight{ animation: timerFlash 1.1s cubic-bezier(.4,0,.2,1) 1; box-shadow: 0 0 32px #ffd700cc, 0 2px 18px #ffd70044; }
    @keyframes timerFlash{ 0%{ box-shadow:0 0 0 #ffd70000 } 30%{ box-shadow:0 0 32px #ffd700cc, 0 2px 18px #ffd70044 } 100%{ box-shadow:0 0 0 #ffd70000 } }

    /* Teacher controls */
    .teacher-controls{ background:var(--glass); border-radius:18px; box-shadow:var(--shadow); padding:18px 14px 24px; display:flex; flex-direction:column; gap:18px; min-width:260px }
    .teacher-controls h3{ color:var(--accent-gold); font-size:1.25rem; font-weight:900; margin:0 0 10px; text-shadow:var(--glow-gold) }
    .control-section{ margin-bottom:12px }

    .oman-btn{ background:var(--gradient-safe); color:#fff; border:none; border-radius:12px; padding:12px 18px; font-size:1.05rem; font-weight:900; cursor:pointer; box-shadow:0 2px 8px #228b2233; margin:0 4px 8px 0; transition:.18s; outline:none; min-width:44px; min-height:44px; display:inline-flex; align-items:center; gap:8px; position:relative; overflow:hidden }
    .oman-btn.gold{ background:var(--gradient-gold); color:var(--oman-red); box-shadow:0 2px 8px #ffd70033 }
    .oman-btn.red{ background:var(--gradient-danger); box-shadow:0 2px 8px #dc143c33 }
    .oman-btn:hover{ filter:brightness(1.08) }

    .modern-select-wrapper{ position:relative; width:100%; margin-top:8px; margin-bottom:2px; display:flex; align-items:center }
    .modern-select{ width:100%; padding:12px 44px 12px 16px; border-radius:12px; border:2px solid #ffd70055; background:rgba(35,36,58,.85); color:#ffd700; font-size:1.05rem; font-family:'Cairo', system-ui, sans-serif; font-weight:800; appearance:none; outline:none; box-shadow:0 2px 8px #ffd70022; transition:border .18s, box-shadow .18s, background .18s; cursor:pointer }
    .modern-select:hover, .modern-select:focus{ border-color:#ffd700; background:#23243aee; box-shadow:0 0 0 3px #ffd70055 }
    .modern-select-arrow{ position:absolute; left:16px; top:50%; transform:translateY(-50%); pointer-events:none; color:#ffd700; font-size:1.2rem }

    /* Notifications */
    #notificationContainer{ position:fixed; top:24px; right:24px; z-index:99999; display:flex; flex-direction:column; gap:12px; align-items:flex-end }
    .notification{ background:#23243aee; color:#ffd700; border:2px solid #ffd700; border-radius:14px; box-shadow:0 0 18px #ffd70099, 0 2px 12px #000a; padding:16px 32px 16px 18px; font-size:1.05rem; font-weight:900; display:flex; align-items:center; gap:12px; opacity:0; transform:translateY(-30px) scale(.95); transition:opacity .35s, transform .35s; pointer-events:auto; min-width:220px; max-width:350px; cursor:pointer; user-select:none }
    .notification.show{ opacity:1; transform:translateY(0) scale(1.04); animation:notifPulse 1.2s infinite alternate }
    .notification-success{ border-color:#228b22; color:#fff; background:linear-gradient(90deg,#228b22 0%,#ffd700 100%) }
    .notification-error{ border-color:#dc143c; color:#fff; background:linear-gradient(90deg,#dc143c 0%,#ffd700 100%) }
    .notification-warning,.notification-info{ border-color:#ffd700; color:#ffd700; background:#23243aee }
    @keyframes notifPulse{ 0%{ box-shadow:0 0 18px #ffd70099, 0 2px 12px #000a } 100%{ box-shadow:0 0 32px #ffd700cc, 0 2px 18px #ffd70044 } }

    /* Evaluation box */
    .evaluation-box{ position:fixed; bottom:24px; left:24px; z-index:9999; background:#23243aee; color:#ffd700; border:2.5px solid #ffd700; padding:14px 18px; border-radius:14px; box-shadow:0 0 24px #ffd700cc, 0 2px 18px #ffd70044; font-weight:900; display:none }
    .evaluation-box.show{ display:block; animation:evalPulse 1.2s infinite alternate }
    @keyframes evalPulse{ 0%{ box-shadow:0 0 24px #ffd700cc, 0 2px 18px #ffd70044 } 100%{ box-shadow:0 0 40px #ffd700ee, 0 2px 24px #ffd70077 } }
  </style>
</head>
<body>
  <!-- Toolbar -->
  <div class="top-toolbar">
    <button class="toolbar-btn" id="homeBtn" title="ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©"><i class="fa-solid fa-house"></i></button>
    <button class="toolbar-btn" id="refreshBtn" title="ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ"><i class="fa-solid fa-rotate-right"></i></button>
    <button class="toolbar-btn" id="instructionsBtn" title="ÿ™ÿπŸÑŸäŸÖÿßÿ™"><i class="fa-solid fa-circle-question"></i></button>
    <button class="toolbar-btn" id="fullscreenBtn" title="ŸÖŸÑÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©"><i class="fa-solid fa-expand"></i></button>
    <button class="toolbar-btn" id="soundBtn" title="ÿßŸÑÿµŸàÿ™"><i class="fa-solid fa-volume-up"></i></button>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-title">üí£ ŸÑÿπÿ®ÿ© ÿßŸÑŸÇŸÜÿ®ŸÑÿ© ÿßŸÑŸÖÿ§ŸÇÿ™ÿ©</div>
    <div class="header-subtitle">ÿßÿÆÿ™ÿ®ÿ± ÿ≥ÿ±ÿπÿ© ÿßŸÑÿ®ÿØŸäŸáÿ© ŸàÿßŸÑÿ™ÿπÿßŸàŸÜ‚Ä¶ ÿ£ÿ®ÿ∑ŸÑ ÿßŸÑŸÇŸÜÿ®ŸÑÿ© ŸÇÿ®ŸÑ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸàŸÇÿ™!</div>
  </div>

  <!-- Notifications -->
  <div id="notificationContainer"></div>

  <!-- Main content -->
  <div class="main-content">
    <!-- Left: info -->
    <div class="game-info">
      <div class="info-card"><i class="fa-solid fa-user"></i> ÿßŸÑÿ∑ÿßŸÑÿ® ÿßŸÑÿ≠ÿßŸÑŸä: <span id="currentStudent">‚Äî</span></div>
      <div class="info-card"><i class="fa-solid fa-users"></i> ÿßŸÑÿµŸÅ: <span id="currentClass">‚Äî</span></div>
      <div class="info-card"><i class="fa-solid fa-star"></i> ÿßŸÑŸÜŸÇÿßÿ∑: <span id="gamePoints">0</span></div>
      <div class="info-card"><i class="fa-solid fa-bomb"></i> ÿßŸÑŸÇŸÜÿßÿ®ŸÑ ÿßŸÑŸÖŸèÿ®ÿ∑ŸÑÿ©: <span id="defusedBombs">0</span></div>
      <div class="info-card"><i class="fa-solid fa-skull-crossbones"></i> ÿßŸÑŸÇŸÜÿßÿ®ŸÑ ÿßŸÑŸÖŸÜŸÅÿ¨ÿ±ÿ©: <span id="explodedBombs">0</span></div>
      <div class="info-card"><i class="fa-solid fa-chart-line"></i> ŸÖÿπÿØŸÑ ÿßŸÑŸÜÿ¨ÿßÿ≠: <span id="successRate">0%</span></div>
    </div>

    <!-- Center: bomb -->
    <div class="bomb-area">
      <div id="gameState" class="game-state state-waiting">üö® ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©</div>
      <div class="bomb" id="bomb">
        <div class="fuse" id="fuse"></div>
        <div class="fuse-flame" id="fuseFlame">üî•</div>
        <span style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);">üí£</span>
      </div>
      <div class="timer-display"><span class="timer-text" id="timerDisplay">00:00</span></div>
      <div id="bombMessage" class="timer-text" style="min-height:28px"></div>
    </div>

    <!-- Right: teacher controls -->
    <div class="teacher-controls">
      <h3>üéõÔ∏è ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿπŸÑŸÖ</h3>

      <div class="control-section">
        <label for="classSelect" style="font-weight:700;color:#FFD700;">ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅ:</label>
        <div class="modern-select-wrapper">
          <select id="classSelect" class="modern-select">
            <option value="">‚Äî ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅ ‚Äî</option>
          </select>
          <span class="modern-select-arrow"><i class="fa-solid fa-chevron-down"></i></span>
        </div>
      </div>

      <div class="control-section">
        <label for="studentSelect" style="font-weight:700;color:#FFD700;">ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿßŸÑÿ®:</label>
        <div class="modern-select-wrapper" id="studentSelectWrapper" style="display:none;">
          <select id="studentSelect" class="modern-select">
            <option value="">‚Äî ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿßŸÑÿ® ‚Äî</option>
          </select>
          <span class="modern-select-arrow"><i class="fa-solid fa-chevron-down"></i></span>
        </div>
        <div id="currentExpertDisplay" class="timer-text" style="margin-top:8px"></div>
      </div>

      <div class="control-section">
        <label for="timerDurationSelect" style="font-weight:700;color:#FFD700;">ŸÖÿØÿ© ÿßŸÑŸÖÿ§ŸÇÿ™:</label>
        <div class="modern-select-wrapper">
          <select id="timerDurationSelect" class="modern-select">
            <option value="30">30 ÿ´ÿßŸÜŸäÿ©</option>
            <option value="60" selected>1 ÿØŸÇŸäŸÇÿ©</option>
            <option value="120">2 ÿØŸÇŸäŸÇÿ©</option>
            <option value="180">3 ÿØŸÇÿßÿ¶ŸÇ</option>
            <option value="240">4 ÿØŸÇÿßÿ¶ŸÇ</option>
            <option value="300">5 ÿØŸÇÿßÿ¶ŸÇ</option>
            <option value="420">7 ÿØŸÇÿßÿ¶ŸÇ</option>
            <option value="600">10 ÿØŸÇÿßÿ¶ŸÇ</option>
          </select>
          <span class="modern-select-arrow"><i class="fa-solid fa-chevron-down"></i></span>
        </div>
      </div>

      <div class="control-section">
        <button class="oman-btn gold" id="randomStudentBtn" type="button" style="width:100%;margin-top:2px;">
          <i class="fa-solid fa-shuffle"></i> ÿßÿÆÿ™Ÿäÿßÿ± ÿπÿ¥Ÿàÿßÿ¶Ÿä
        </button>
      </div>

      <div class="control-section">
        <button class="oman-btn" id="startBtn"><i class="fa-solid fa-play"></i> ÿ®ÿØÿ° ÿßŸÑŸÖÿ§ŸÇÿ™</button>
        <button class="oman-btn gold" id="pauseBtn"><i class="fa-solid fa-pause"></i> ÿ•ŸäŸÇÿßŸÅ ŸÖÿ§ŸÇÿ™</button>
        <button class="oman-btn red" id="resetBtn"><i class="fa-solid fa-rotate-right"></i> ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑</button>
        <button class="oman-btn gold" id="newRoundBtn"><i class="fa-solid fa-forward"></i> ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button>
      </div>

      <div class="control-section">
        <button class="oman-btn" id="defuseBtn"><i class="fa-solid fa-check"></i> ÿ•ÿ®ÿ∑ÿßŸÑ ÿßŸÑŸÇŸÜÿ®ŸÑÿ©</button>
        <button class="oman-btn red" id="explodeBtn"><i class="fa-solid fa-xmark"></i> ÿßŸÜŸÅÿ¨ÿßÿ±</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="instructionsModal" style="display:none; align-items:center; justify-content:center;">
    <div class="modal-content" style="max-width:560px; width:95vw;">
      <div class="modal-header">
        <h2>ÿ™ÿπŸÑŸäŸÖÿßÿ™ ŸÑÿπÿ®ÿ© ÿßŸÑŸÇŸÜÿ®ŸÑÿ© ÿßŸÑŸÖÿ§ŸÇÿ™ÿ©</h2>
        <button class="modal-close" data-close-modal="instructionsModal">&times;</button>
      </div>
      <div class="modal-body">
        <ul style="font-size:1.05rem;line-height:2; margin:0; padding-right:18px;">
          <li>ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅ ŸàÿßŸÑÿ∑ÿßŸÑÿ®ÿå ÿ´ŸÖ ÿ≠ÿØÿØ ŸÖÿØÿ© ÿßŸÑŸÖÿ§ŸÇÿ™.</li>
          <li>ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ§ŸÇÿ™ Ÿàÿ≠ŸÅŸëÿ≤ ÿßŸÑÿ∑ÿßŸÑÿ® ÿπŸÑŸâ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸÇÿ®ŸÑ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸàŸÇÿ™.</li>
          <li>ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸÑÿ•ÿ®ÿ∑ÿßŸÑ ÿßŸÑŸÇŸÜÿ®ŸÑÿ© ÿ£Ÿà ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÜŸÅÿ¨ÿßÿ±.</li>
          <li>ÿ≤ÿ± "ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©" ŸäÿÆÿ™ÿßÿ± ÿ∑ÿßŸÑÿ®Ÿãÿß ÿ¨ÿØŸäÿØŸãÿß ŸàŸäÿ≠ÿ∂ÿ± ŸÖÿ§ŸÇÿ™Ÿãÿß ÿ¨ÿØŸäÿØŸãÿß.</li>
        </ul>
        <button class="oman-btn gold" data-close-modal="instructionsModal" style="margin-top:18px;">ŸÅŸáŸÖÿ™ÿå ŸÑŸÜÿ®ÿØÿ£!</button>
      </div>
    </div>
  </div>

  <!-- Confetti Canvas -->
  <canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;display:none;"></canvas>
  <div class="evaluation-box" id="evaluationBox">‚úÖ ÿ£ÿ≠ÿ≥ŸÜÿ™ Ÿäÿß <span id="evalName">‚Äî</span>! (+10 ŸÜŸÇÿßÿ∑)</div>

  <script>
    // ====== ÿßŸÑÿµŸàÿ™ ÿßŸÑÿ∞ŸÉŸä ======
    let currentAudio = null, soundOn = true;
    function playGameSound(src, volume = 1, allowOverlap = false){
      if(!soundOn) return; // ÿßÿ≠ÿ™ÿ±ÿßŸÖ ÿ≠ÿßŸÑÿ© ŸÉÿ™ŸÖ ÿßŸÑÿµŸàÿ™
      try{
        if(!allowOverlap && currentAudio){ currentAudio.pause(); currentAudio.currentTime = 0; }
        const audio = new Audio(src);
        audio.volume = volume; audio.play();
        if(!allowOverlap) currentAudio = audio;
        audio.onended = () => { if(currentAudio === audio) currentAudio = null; };
      }catch(e){}
    }

    // ====== ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ======
    function showNotification(msg, type = 'info'){
      const container = document.getElementById('notificationContainer');
      if(!container) return;
      const el = document.createElement('div');
      el.className = `notification notification-${type}`;
      const icon = type==='success'?'‚úÖ': type==='error'?'‚ùå': type==='warning'?'‚ö†Ô∏è':'üîî';
      el.innerHTML = `<span class="notif-icon">${icon}</span><span>${msg}</span>`;
      container.appendChild(el);
      setTimeout(()=> el.classList.add('show'), 10);
      setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=> el.remove(), 600); }, 3500);
    }

    // ====== ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ© ======
    const gameState = {
      isActive:false, isPaused:false, timeLeft:0, timer:null,
      currentStudent:'‚Äî', currentClass:'‚Äî',
      defusedBombs:0, explodedBombs:0, points:0
    };

    let students = [];           // ŸÇÿßÿ¶ŸÖÿ© ÿ∑ŸÑÿßÿ® ÿßŸÑÿµŸÅ ÿßŸÑÿ≠ÿßŸÑŸä
    let allClasses = {};         // ŸÉŸÑ ÿßŸÑÿµŸÅŸàŸÅ => { "ÿµŸÅ 1": ["ÿßÿ≥ŸÖ" ...] }
    let currentExpert = null;    // ÿßŸÑÿ∑ÿßŸÑÿ® ÿßŸÑŸÖÿÆÿ™ÿßÿ±
    let customTimerDuration = 60;// ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
    let randomStudentPool = [];  // ŸÑŸÑÿ™ÿØŸàŸäÿ± ÿ®ÿØŸàŸÜ ÿ™ŸÉÿ±ÿßÿ±

    // ====== ÿ£ÿØŸàÿßÿ™ ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function formatTime(s){
      s = Math.max(0, Math.floor(s));
      const m = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${m}:${ss}`;
    }

    function updateGameInfo(){
      $('#currentStudent').textContent = gameState.currentStudent || '‚Äî';
      $('#currentClass').textContent = gameState.currentClass || '‚Äî';
      $('#gamePoints').textContent = gameState.points;
      $('#defusedBombs').textContent = gameState.defusedBombs;
      $('#explodedBombs').textContent = gameState.explodedBombs;
      const total = gameState.defusedBombs + gameState.explodedBombs;
      const rate = total? Math.round((gameState.defusedBombs/total)*100) : 0;
      $('#successRate').textContent = rate + '%';
    }

    function setState(cls){
      const gs = $('#gameState');
      gs.className = 'game-state ' + cls;
      if(cls==='state-active') gs.textContent = '‚è±Ô∏è ÿßŸÑŸÖÿ§ŸÇÿ™ ŸäÿπŸÖŸÑ';
      else if(cls==='state-success') gs.textContent = 'üéâ ÿ™ŸÖ ÿßŸÑÿ•ÿ®ÿ∑ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠';
      else if(cls==='state-explosion') gs.textContent = 'üí• ÿßŸÜŸÅÿ¨ÿ±ÿ™ ÿßŸÑŸÇŸÜÿ®ŸÑÿ©';
      else gs.textContent = 'üö® ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©';
    }

    function animateTimerHighlight(){
      const t = $('#timerDisplay');
      if(!t) return;
      t.classList.remove('timer-highlight'); // ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ
      void t.offsetWidth;
      t.classList.add('timer-highlight');
    }

    function openModal(id){ const m = document.getElementById(id); if(!m) return; m.style.display='flex'; }
    function closeModal(id){ const m = document.getElementById(id); if(!m) return; m.style.display='none'; }

    function showEvaluationBox(name){
      const box = $('#evaluationBox');
      $('#evalName').textContent = name || '‚Äî';
      box.classList.add('show');
      setTimeout(()=> box.classList.remove('show'), 3000);
    }

    function fireConfetti(){
      const canvas = document.getElementById('confettiCanvas');
      canvas.style.display = 'block';
      const myConfetti = confetti.create(canvas, { resize: true, useWorker: true });
      myConfetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
      setTimeout(()=> canvas.style.display = 'none', 800);
    }

    // ====== ÿßŸÑŸÖÿ§ŸÇÿ™ ======
    function startTimer(){
      if(gameState.isActive && !gameState.isPaused) return; // ŸäÿπŸÖŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ
      if(!gameState.timeLeft) gameState.timeLeft = customTimerDuration;
      setState('state-active');
      gameState.isActive = true; gameState.isPaused = false;
      $('#bombMessage').textContent = '';
      playGameSound('../assets/media/sounds/ui/confirm.mp3', 0.6);
      if(gameState.timer) clearInterval(gameState.timer);
      gameState.timer = setInterval(()=>{
        gameState.timeLeft -= 1;
        $('#timerDisplay').textContent = formatTime(gameState.timeLeft);
        if(gameState.timeLeft <= 0){
          clearInterval(gameState.timer);
          gameState.timer = null; gameState.isActive = false; gameState.isPaused = false;
          handleExplosion();
        }
      }, 1000);
      $('#timerDisplay').textContent = formatTime(gameState.timeLeft);
      animateTimerHighlight();
    }

    function pauseTimer(){
      if(!gameState.isActive || gameState.isPaused) return;
      gameState.isPaused = true; setState('state-waiting');
      if(gameState.timer) clearInterval(gameState.timer);
      gameState.timer = null;
      playGameSound('../assets/media/sounds/ui/pause.mp3', 0.6);
    }

    function resetTimer(){
      if(gameState.timer) clearInterval(gameState.timer);
      gameState.timer = null; gameState.isActive = false; gameState.isPaused = false;
      gameState.timeLeft = 0; $('#timerDisplay').textContent = '00:00';
      setState('state-waiting');
      $('#bombMessage').textContent = '';
      playGameSound('../assets/media/sounds/ui/reset.mp3', 0.6);
    }

    function newRound(){
      resetTimer();
      // ÿßÿÆÿ™Ÿäÿßÿ± ÿπÿ¥Ÿàÿßÿ¶Ÿä ÿ¨ÿØŸäÿØ ÿ•ŸÜ ÿ£ŸÖŸÉŸÜ
      const btn = $('#randomStudentBtn');
      if(btn && students.length){ btn.click(); }
      gameState.timeLeft = customTimerDuration;
      $('#timerDisplay').textContent = formatTime(gameState.timeLeft);
      showNotification('‚ú® ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ© ÿ®ÿØÿ£ÿ™', 'info');
    }

    function handleDefuse(){
      if(gameState.timer) { clearInterval(gameState.timer); gameState.timer = null; }
      gameState.isActive = false; gameState.isPaused = false;
      setState('state-success');
      gameState.defusedBombs += 1; gameState.points += 10;
      updateGameInfo();
      $('#bombMessage').textContent = 'üéØ ÿ™ŸÖ ÿ•ÿ®ÿ∑ÿßŸÑ ÿßŸÑŸÇŸÜÿ®ŸÑÿ© ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®!';
      fireConfetti();
      playGameSound('../assets/media/sounds/fx/success.mp3', 0.7);
      showEvaluationBox(gameState.currentStudent || 'ÿßŸÑÿ∑ÿßŸÑÿ®');
    }

    function handleExplosion(){
      setState('state-explosion');
      gameState.explodedBombs += 1; updateGameInfo();
      $('#bombMessage').textContent = 'üí• ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!';
      playGameSound('../assets/media/sounds/fx/explosion.mp3', 0.7);
      showNotification('ÿßŸÜŸÅÿ¨ÿ±ÿ™ ÿßŸÑŸÇŸÜÿ®ŸÑÿ©! ÿ≠ÿßŸàŸÑ ŸÖÿ¨ÿØÿØŸãÿß.', 'error');
    }

    // ====== ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅŸàŸÅ ŸàÿßŸÑÿ∑ŸÑÿßÿ® ======
    function loadClasses(){
      // ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÖŸáŸÖŸëÿ©: ŸÜÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ÿ∑ÿ±ŸäŸÇÿ© ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÉŸÖÿß ÿ∑ŸÑÿ®ÿ™
      // ŸÑÿß ÿ™ÿ∫ŸäŸëÿ± ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑÿ™ÿßŸÑŸä
      fetch('../data/studentData.json')
        .then(r => r.json())
        .then(data => {
          allClasses = data || {};
          const classSelect = $('#classSelect');
          classSelect.innerHTML = '<option value="">‚Äî ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅ ‚Äî</option>';
          Object.keys(allClasses).forEach(className => {
            const opt = document.createElement('option');
            opt.value = className; opt.textContent = className; classSelect.appendChild(opt);
          });
        })
        .catch(err => {
          console.error(err);
          $('#classSelect').innerHTML = '<option value="">ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅŸàŸÅ</option>';
          showNotification('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸÅŸàŸÅ', 'error');
        });
    }

    function onClassChange(e){
      const className = e.target.value;
      const studentSelect = $('#studentSelect');
      const wrapper = $('#studentSelectWrapper');
      if(!className){
        students = []; gameState.currentClass = '‚Äî'; gameState.currentStudent = '‚Äî'; currentExpert = null; updateGameInfo();
        studentSelect.innerHTML = '<option value="">‚Äî ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿßŸÑÿ® ‚Äî</option>'; wrapper.style.display = 'none';
        randomStudentPool = [];
        return;
      }
      gameState.currentClass = className;
      students = Array.isArray(allClasses[className]) ? allClasses[className] : [];
      updateGameInfo();
      // ÿ®ŸÜÿßÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ŸÑÿßÿ®
      studentSelect.innerHTML = '<option value="">‚Äî ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿßŸÑÿ® ‚Äî</option>';
      students.forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; studentSelect.appendChild(o); });
      wrapper.style.display = '';
      studentSelect.value = '';
      currentExpert = null; gameState.currentStudent = '‚Äî';
      $('#currentExpertDisplay').textContent = '';
      randomStudentPool = [...students];
    }

    function onStudentChange(e){
      const val = e.target.value;
      if(val){ currentExpert = val; gameState.currentStudent = val; $('#currentExpertDisplay').textContent = `üëë ÿÆÿ®Ÿäÿ± ÿßŸÑÿ¨ŸàŸÑÿ©: ${val}`; animateTimerHighlight(); }
      else{ currentExpert = null; gameState.currentStudent = '‚Äî'; $('#currentExpertDisplay').textContent = ''; }
      updateGameInfo();
    }

    function pickRandomStudent(){
      if(!students.length){ $('#bombMessage').textContent = 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµŸÅ ÿ£ŸàŸÑÿßŸã.'; return; }
      if(!randomStudentPool.length) randomStudentPool = [...students];
      const idx = Math.floor(Math.random() * randomStudentPool.length);
      const selected = randomStudentPool.splice(idx, 1)[0];
      currentExpert = selected; gameState.currentStudent = selected;
      $('#studentSelect').value = selected;
      $('#currentExpertDisplay').textContent = `üëë ÿÆÿ®Ÿäÿ± ÿßŸÑÿ¨ŸàŸÑÿ©: ${selected}`;
      updateGameInfo(); animateTimerHighlight();
      playGameSound('../assets/media/sounds/kingdom-sounds/character-intro.mp3', 0.7);
      showNotification(`ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ${selected} ŸÉÿÆÿ®Ÿäÿ± ÿßŸÑÿ¨ŸàŸÑÿ©!`, 'success');
      showEvaluationBox(selected);
    }

    // ====== ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ£ÿØŸàÿßÿ™ ======
    function setupToolbar(){
      $('#homeBtn').addEventListener('click', ()=>{ showNotification('ŸÖÿ±ÿ≠ÿ®Ÿãÿß! ‚ú®', 'info'); });
      $('#refreshBtn').addEventListener('click', ()=> window.location.reload());
      $('#instructionsBtn').addEventListener('click', ()=> openModal('instructionsModal'));
      $('[data-close-modal="instructionsModal"]').addEventListener('click', ()=> closeModal('instructionsModal'));
      $('#fullscreenBtn').addEventListener('click', ()=>{
        if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); }
        else{ document.exitFullscreen?.(); }
      });
      $('#soundBtn').addEventListener('click', (e)=>{
        soundOn = !soundOn; const i = e.currentTarget.querySelector('i');
        i.classList.toggle('fa-volume-up', soundOn);
        i.classList.toggle('fa-volume-xmark', !soundOn);
        showNotification(soundOn? 'üîä ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™' : 'üîá ÿ™ŸÖ ŸÉÿ™ŸÖ ÿßŸÑÿµŸàÿ™', 'info');
      });
    }

    // ====== ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ======
    function setupEventListeners(){
      $('#classSelect').addEventListener('change', onClassChange);
      $('#studentSelect').addEventListener('change', onStudentChange);
      $('#randomStudentBtn').addEventListener('click', pickRandomStudent);
      $('#timerDurationSelect').addEventListener('change', e=>{ customTimerDuration = parseInt(e.target.value,10) || 60; if(!gameState.isActive) { gameState.timeLeft = 0; $('#timerDisplay').textContent = '00:00'; } });

      // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖÿ§ŸÇÿ™
      $('#startBtn').addEventListener('click', startTimer);
      $('#pauseBtn').addEventListener('click', pauseTimer);
      $('#resetBtn').addEventListener('click', resetTimer);
      $('#newRoundBtn').addEventListener('click', newRound);

      // ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ¨ŸàŸÑÿ©
      $('#defuseBtn').addEventListener('click', handleDefuse);
      $('#explodeBtn').addEventListener('click', handleExplosion);

      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ ÿ®ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
      document.addEventListener('click', (e)=>{
        if(e.target.classList?.contains('modal')) closeModal(e.target.id);
      });
    }

    // ====== ÿ™ÿ¥ÿ∫ŸäŸÑ ÿ£ŸàŸÑŸä ======
    document.addEventListener('DOMContentLoaded', ()=>{
      setupToolbar();
      setupEventListeners();
      loadClasses(); // ‚ö†Ô∏è Ÿäÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ fetch('../data/studentData.json')
      const sel = $('#timerDurationSelect'); customTimerDuration = parseInt(sel.value,10) || 60;
      $('#timerDisplay').textContent = '00:00';
      updateGameInfo();
    });
  </script>
</body>
</html>
