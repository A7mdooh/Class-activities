<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù†Ø´Ø§Ø· Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© â€” Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
<style>
  :root{
    --bg:#0e0f14; --panel:#14192a; --card:#1a2036; --border:#27305a; --text:#e9ecff; --muted:#9aa0b4;
    --accent:#f7c948; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1000px 600px at 80% -20%,#1a2033 0,#0e0f14 55%);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#0f1528;position:sticky;top:0;z-index:20}
  header .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  header .brand i{font-style:normal;font-size:20px}
  header .tabs{display:flex;gap:6px}
  .tab{padding:8px 12px;border:1px solid var(--border);background:#111735;border-radius:10px;cursor:pointer}
  <!DOCTYPE html>
  <html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’£ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
      body { background: radial-gradient(ellipse at 70% 0%, #23243a 0%, #0e0f14 100%); color: #f7c948; font-family: 'Cairo', system-ui, sans-serif; margin:0; min-height:100vh; }
      .main-wrap { max-width: 900px; margin: 0 auto; padding: 0 8px; }
      .topbar { display:flex; align-items:center; justify-content:space-between; padding:18px 0 8px 0; }
      .brand { font-size:2.1rem; font-weight:900; letter-spacing:1px; display:flex; align-items:center; gap:10px; color:#ffd700; }
      .settings-btn { background:none; border:none; color:#ffd700; font-size:1.5rem; cursor:pointer; transition:.2s; }
      .settings-btn:hover { color:#22c55e; }
      .notif { position:fixed; top:18px; left:50%; transform:translateX(-50%); background:#23243aee; color:#ffd700; border-radius:16px; box-shadow:0 4px 24px #0008; padding:1rem 2.2rem; font-size:1.2rem; z-index:2000; display:none; align-items:center; gap:0.7rem; animation:notifFadeIn 0.5s; }
      @keyframes notifFadeIn { from { opacity: 0; top:0; } to { opacity: 1; top:18px; } }
      .notif.active { display:flex; }
      .bomb-area { display:flex; flex-direction:column; align-items:center; justify-content:center; margin:2.5rem 0 1.5rem 0; }
      .bomb-visual { width:170px; height:170px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #384077 0,#0e1328 60%); box-shadow:0 0 0 4px #0c1125 inset, 0 0 32px rgba(0,0,0,.56); position:relative; display:flex; align-items:center; justify-content:center; font-size:4.5rem; color:#ffd700; transition:transform .4s, filter .4s; }
      .bomb-visual.yellow { filter:drop-shadow(0 0 18px rgba(247,201,72,.4)); }
      .bomb-visual.red { filter:drop-shadow(0 0 24px rgba(239,68,68,.65)); transform:scale(1.08); }
      .bomb-visual.shake { animation:shake .2s linear infinite; }
      @keyframes shake { 0%{transform:translate(0,0)}25%{transform:translate(1px,1px)}50%{transform:translate(-1px,0)}75%{transform:translate(1px,-1px)}100%{transform:translate(0,0)} }
      .fuse { position:absolute; top:-30px; left:50%; transform:translateX(-50%); width:2px; height:50px; background:linear-gradient(#ffd700,#ff9800,#b45309); }
      .spark { position:absolute; top:-36px; left:calc(50% + 6px); width:10px; height:10px; border-radius:50%; background:#ffd43b; filter:drop-shadow(0 0 6px #ffd43b); animation:spark 1s linear infinite; }
      @keyframes spark {0%{transform:translate(0,0) scale(1)}50%{transform:translate(6px,-8px) scale(1.2)}100%{transform:translate(12px,-16px) scale(0.8)}}
      .countdown { position:absolute; bottom:22px; font-weight:900; font-size:46px; letter-spacing:1px; text-shadow:0 0 10px rgba(0,0,0,.5); color:#fff; }
      .countdown.warn { color:#f59e0b; }
      .countdown.danger { color:#ef4444; }
      .countdown.mega { font-size:96px; animation:blink .3s ease-in-out infinite; }
      @keyframes blink {0%,100%{opacity:1}50%{opacity:.35}}
      .heat { width:min(560px,85%); height:12px; border-radius:30px; border:1px solid #2f3866; background:#12152a; overflow:hidden; margin:18px auto 0 auto; }
      .heat > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444); transition:width .5s; }
      .students { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:18px 0 0 0; }
      .chip { background:rgba(27,32,51,.7); border:1px solid #2a3159; padding:8px 10px; border-radius:999px; display:flex; align-items:center; gap:8px; backdrop-filter: blur(4px); font-size:1.1rem; }
      .chip b { font-size:1rem; }
      .chip i { font-style:normal; font-size:1.1rem; }
      .confetti { position:fixed; left:0; top:0; width:100vw; height:100vh; pointer-events:none; z-index:9999; }
      .flash { position:fixed; inset:0; background:#fff; opacity:0; pointer-events:none; z-index:9998; }
      .flash.show { animation:flash .5s ease; }
      @keyframes flash {0%{opacity:.9}100%{opacity:0}}
      .notif-bar { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#23243aee; color:#ffd700; border-radius:16px; box-shadow:0 4px 24px #0008; padding:1rem 2.2rem; font-size:1.2rem; z-index:2000; display:none; align-items:center; gap:0.7rem; }
      .notif-bar.active { display:flex; }
      .settings-modal { position:fixed; inset:0; background:rgba(20,20,40,0.85); display:none; align-items:center; justify-content:center; z-index:3000; }
      .settings-modal.active { display:flex; }
      .settings-content { background:#23243a; color:#ffd700; border-radius:18px; max-width:400px; width:95%; padding:2.5rem 2rem; box-shadow:0 8px 40px #0006; text-align:right; position:relative; }
      .settings-content h2 { color:#ffd700; font-size:2rem; margin-bottom:1rem; }
      .settings-content label { display:block; margin:1rem 0 0.5rem 0; font-weight:700; }
      .settings-content input[type=range] { width:100%; }
      .settings-close { position:absolute; left:1.2rem; top:1.2rem; background:none; border:none; font-size:1.5rem; color:#ef4444; cursor:pointer; }
      @media (max-width:600px) { .main-wrap {padding:0 2px;} .bomb-visual{width:120px;height:120px;font-size:2.5rem;} }
    </style>
  </head>
  <body>
    <div class="main-wrap">
      <div class="topbar">
        <div class="brand"><span>ğŸ’£</span> Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©</div>
        <button class="settings-btn" id="settingsBtn" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"><i class="fa fa-gear"></i></button>
      </div>
      <div class="notif" id="notifBar"><span id="notifMsg">ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…!</span></div>
      <div class="bomb-area">
        <div class="bomb-visual" id="bombVisual"><div class="fuse"></div><div class="spark"></div>ğŸ’£</div>
        <div class="countdown" id="countdown">â€”</div>
        <div class="heat"><i id="heatFill"></i></div>
        <div class="students" id="selectedChips"></div>
      </div>
      <div class="confetti" id="confetti"></div>
      <div class="flash" id="flash"></div>
      <div class="notif-bar" id="notifBar2"><span id="notifMsg2"></span></div>
      <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
          <button class="settings-close" id="closeSettings">&times;</button>
          <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª</h2>
          <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª</label>
          <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.7">
          <label><input type="checkbox" id="soundToggle" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª</label>
        </div>
      </div>
    </div>
    <script>
      // Ù†Ø¸Ø§Ù… ØµÙˆØªÙŠ Ù…ØªÙ‚Ø¯Ù…
      const sounds = {
        tick: new Audio('../assets/media/sounds/countdown-beep.mp3'),
        tickFast: new Audio('../assets/media/sounds/Notification.mp3'),
        alarm: new Audio('../assets/media/sounds/long-beep.mp3'),
        win: new Audio('../assets/media/sounds/win.mp3'),
        fail: new Audio('../assets/media/sounds/wrong_answer.mp3'),
        select: new Audio('../assets/media/sounds/select.mp3'),
        confetti: new Audio('../assets/media/sounds/kingdom-sounds/cosmic-explosion.mp3'),
        bonus: new Audio('../assets/media/sounds/kingdom-sounds/bonus-collect.mp3'),
        click: new Audio('../assets/media/sounds/Click.mp3')
      };
      let soundEnabled = true;
      let volume = 0.7;
      function playSound(name, force=false) {
        if (!soundEnabled && !force) return;
        if (sounds[name]) { sounds[name].volume = volume; sounds[name].currentTime = 0; sounds[name].play().catch(()=>{}); }
      }
      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
      document.getElementById('settingsBtn').onclick = ()=>{
        document.getElementById('settingsModal').classList.add('active');
      };
      document.getElementById('closeSettings').onclick = ()=>{
        document.getElementById('settingsModal').classList.remove('active');
      };
      document.getElementById('volumeSlider').oninput = e=>{
        volume = parseFloat(e.target.value);
        Object.values(sounds).forEach(s=>s.volume=volume);
      };
      document.getElementById('soundToggle').onchange = e=>{
        soundEnabled = e.target.checked;
      };
      // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹ØµØ±ÙŠØ©
      function showNotif(msg, type='info', sec=2) {
        const bar = document.getElementById('notifBar');
        document.getElementById('notifMsg').textContent = msg;
        bar.classList.add('active');
        setTimeout(()=>bar.classList.remove('active'), sec*1000);
        playSound('click',true);
      }
      function showNotif2(msg, sec=2) {
        const bar = document.getElementById('notifBar2');
        document.getElementById('notifMsg2').textContent = msg;
        bar.classList.add('active');
        setTimeout(()=>bar.classList.remove('active'), sec*1000);
      }
      // confetti
      function confettiBlast() {
        const box = document.getElementById('confetti');
        box.innerHTML = '';
        for(let i=0;i<120;i++){
          const p=document.createElement('i');
          p.style.cssText=`position:absolute;top:-10px;width:8px;height:12px;background:hsla(${Math.floor(Math.random()*360)},90%,60%,.95);transform:rotate(${Math.floor(Math.random()*360)}deg);animation:fall ${2+Math.random()*1.8}s linear forwards;left:${Math.random()*100}%`;
          box.appendChild(p);
        }
        setTimeout(()=>box.innerHTML='',3000);
        playSound('confetti');
      }
      // ÙÙ„Ø§Ø´
      function doFlash() {
        const flash = document.getElementById('flash');
        flash.classList.remove('show'); void flash.offsetWidth; flash.classList.add('show');
      }
      // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ
      let timer = null, timeLeft = 35, totalTime = 35, state = 'IDLE';
      function startGame() {
        state = 'RUNNING';
        timeLeft = totalTime;
        updateBombVisual();
        timer = setInterval(()=>{
          timeLeft--;
          updateBombVisual();
          if (timeLeft === 10) { showNotif('âš ï¸ Ø¢Ø®Ø± 10 Ø«ÙˆØ§Ù†Ù!','warn',2); playSound('tickFast'); document.getElementById('bombVisual').classList.add('yellow'); }
          if (timeLeft === 3) { showNotif('ğŸš¨ Ø§Ù‚ØªØ±Ø¨ Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±!','danger',2); playSound('alarm'); document.getElementById('bombVisual').classList.add('red','shake'); document.getElementById('countdown').classList.add('mega','danger'); doFlash(); }
          if (timeLeft <= 0) { clearInterval(timer); endGame(false); }
          else if (timeLeft < 10) playSound('tickFast');
          else playSound('tick');
        },1000);
      }
      function updateBombVisual() {
        document.getElementById('countdown').textContent = timeLeft > 0 ? timeLeft : 'â€”';
        const fill = document.getElementById('heatFill');
        fill.style.width = ((1-(timeLeft/totalTime))*100)+'%';
      }
      function endGame(success) {
        state = success ? 'SUCCESS' : 'FAIL';
        if (success) {
          showNotif2('ğŸ‰ Ù†Ø¬Ø§Ø­! Ø£Ø­Ø³Ù†Øª!');
          confettiBlast();
          playSound('win');
        } else {
          showNotif2('ğŸ’¥ Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©!');
          doFlash();
          playSound('fail');
        }
        document.getElementById('bombVisual').classList.remove('yellow','red','shake');
        document.getElementById('countdown').classList.remove('mega','danger');
      }
      // Ø¨Ø¯Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
      showNotif('Ø¬Ø§Ù‡Ø²ØŸ Ø§Ø¶ØºØ· Ø£ÙŠ Ù…ÙƒØ§Ù† Ù„Ù„Ø¨Ø¯Ø¡!','info',3);
      document.body.onclick = function(){ if(state==='IDLE'){ startGame(); showNotif('ğŸš€ Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ!','success',2); } };
      // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
      window.addEventListener('keydown',e=>{
        if(state==='RUNNING'){
          if(e.key===' '){ clearInterval(timer); showNotif('â¸ï¸ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª','info',2); state='PAUSED'; }
          if(e.key==='Enter'){ clearInterval(timer); endGame(true); }
          if(e.key==='Escape'){ clearInterval(timer); endGame(false); }
          if(e.key==='ArrowUp'){ timeLeft+=5; showNotif('â« +5 Ø«ÙˆØ§Ù†Ù!','success',1); updateBombVisual(); playSound('bonus'); }
        } else if(state==='PAUSED' && e.key===' '){ startGame(); showNotif('â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù','info',1); }
      });
    </script>
  </body>
  </html>
  }catch(err){
    console.error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', err);
    const holder = document.getElementById('classGrid');
    holder.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'tile';
    box.innerHTML = '<b>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</b><br><small>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± data/studentData.json Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.</small>';
    const retry = document.createElement('button');
    retry.className = 'btn warn';
    retry.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
    retry.onclick = loadData;
    holder.appendChild(box);
    holder.appendChild(retry);
  }
}

/* ===================== Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ===================== */
const viewsRoot = document.getElementById('viewsRoot');
const teacherTab = document.getElementById('teacherTab');
const studentTab = document.getElementById('studentTab');

const sectionClass    = document.getElementById('sectionClass');
const sectionStudents = document.getElementById('sectionStudents');
const sectionStage    = document.getElementById('sectionStage');

const classGrid    = document.getElementById('classGrid');
const studentsGrid = document.getElementById('studentsGrid');
const selectedChips= document.getElementById('selectedChips');
const limitSpan    = document.getElementById('limitSpan');

const elDifficulty = document.getElementById('difficulty');
const elDuration   = document.getElementById('duration');
const elPerPlayer  = document.getElementById('perPlayer');
const elPerRound   = document.getElementById('perRound');
const elSoundOn    = document.getElementById('soundOn');
const elAllowSur   = document.getElementById('allowSurprises');
const elFairPick   = document.getElementById('fairPick');
const phaseSelect  = document.getElementById('phase');

const startBtn   = document.getElementById('startBtn');
const pauseBtn   = document.getElementById('pauseBtn');
const add5Btn    = document.getElementById('add5Btn');
const successBtn = document.getElementById('successBtn');
const failBtn    = document.getElementById('failBtn');

const countdownEl = document.getElementById('countdown');
const heatFill    = document.getElementById('heatFill');
const bomb        = document.getElementById('bomb');
const flash       = document.getElementById('flash');
const resultsEl   = document.getElementById('results');
const resultIcon  = document.getElementById('resultIcon');
const resultTitle = document.getElementById('resultTitle');
const resultText  = document.getElementById('resultText');
const resultBadges= document.getElementById('resultBadges');
const closeResults= document.getElementById('closeResults');
const confettiBox = document.getElementById('confetti');

const turnList   = document.getElementById('turnList');
const turnStatus = document.getElementById('turnStatus');
const logEl      = document.getElementById('log');

/* ===================== Ø­Ø§Ù„Ø§Øª ÙˆØµØ¹ÙˆØ¨Ø§Øª ===================== */
const Difficulty = {
  Easy:    { duration: 60, pace: "slow",  surpriseProb: 0.05, effects:{ shake:false, flashAtEnd:true } },
  Medium:  { duration: 35, pace: "mid",   surpriseProb: 0.08, effects:{ shake:true,  flashAtEnd:true } },
  Hard:    { duration: 20, pace: "fast",  surpriseProb: 0.12, effects:{ shake:true,  flashAtEnd:true } },
  Custom:  { duration: 45, pace: "mid",   surpriseProb: 0.10, effects:{ shake:true,  flashAtEnd:true } }
};

const Bus = (()=>{ const m=new Map(); return { on:(e,h)=>m.set(e,(m.get(e)||[]).concat(h)), emit:(e,p)=> (m.get(e)||[]).forEach(h=>h(p)) }})();
const GameState = (()=>{ let s="IDLE"; const T={ IDLE:["ARMING"], ARMING:["RUNNING","IDLE"], RUNNING:["PAUSED","SUCCESS","FAIL","RESULTS"], PAUSED:["RUNNING","RESULTS"], SUCCESS:["RESULTS"], FAIL:["RESULTS"], RESULTS:["IDLE","ARMING"] }; return { get:()=>s, to:(n)=>{ if((T[s]||[]).includes(n)){ s=n; Bus.emit("state",s);} } }})();

/* ===================== ØµÙˆØªÙŠØ§Øª Ø®ÙÙŠÙØ© ===================== */
const Sound = (() => {
  let ctx=null, enabled=true; function ensure(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(freq=880,ms=80,type="sine",gain=0.035){ if(!enabled) return; ensure(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+ms/1000);} 
  return {
    enable(v){enabled=!!v; if(enabled) ensure();}, resume(){ if(ctx && ctx.state==="suspended") ctx.resume(); },
    tickSlow:()=>beep(680,28,"square",.03), tickFast:()=>beep(900,24,"square",.035), heart:()=>{beep(120,60,"sine",.06); setTimeout(()=>beep(120,60,"sine",.06),120);}, alarm:()=>beep(1100,130,"sawtooth",.05), success:()=>{beep(660,120,"triangle",.05); setTimeout(()=>beep(880,140,"triangle",.05),150);}, boom:()=>{beep(80,200,"sawtooth",.08); setTimeout(()=>beep(50,260,"sawtooth",.08),120);} }
})();

/* ===================== Ù…Ø¤Ù‚Ù‘Øª rAF ===================== */
function createTimer(totalMs){
  let left=totalMs, id=null, last=performance.now(); const marks=new Set();
  function tick(now){ left -= now-last; last=now; Bus.emit("timer:tick",{left,seconds:Math.ceil(left/1000), total: totalMs}); const s=Math.ceil(left/1000); const half=Math.ceil(totalMs/2000);
    if(!marks.has("half") && s===half){ marks.add("half"); Bus.emit("timer:flag","half"); }
    if(!marks.has("last10") && s===10){ marks.add("last10"); Bus.emit("timer:flag","last10"); }
    if(s<=3){ Bus.emit("timer:flag","last3"); }
    if(left<=0){ cancelAnimationFrame(id); id=null; Bus.emit("timer:end"); return; }
    id=requestAnimationFrame(tick);
  }
  return { start(){ last=performance.now(); id=requestAnimationFrame(tick); Bus.emit("timer:start",{totalMs}); }, pause(){ if(id){ cancelAnimationFrame(id); id=null; Bus.emit("timer:pause",{left}); } }, resume(){ if(!id){ last=performance.now(); id=requestAnimationFrame(tick); Bus.emit("timer:resume",{left}); } }, add(ms){ left+=ms; Bus.emit("timer:add",{left,ms}); }, get left(){return left;} }
}

/* ===================== Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© ===================== */
function log(msg){ const t=new Date().toLocaleTimeString(); logEl.innerHTML = `<div>[${t}] ${msg}</div>` + logEl.innerHTML; }
function setStartEnabled(v){ startBtn.disabled=!v; }
function setControls(running){ pauseBtn.disabled=add5Btn.disabled=successBtn.disabled=failBtn.disabled=!running; }
function toast(text){ const t=document.createElement('div'); t.style.cssText="position:absolute;top:16px;left:50%;transform:translateX(-50%);background:#111834;border:1px solid #2a3159;color:#eaf;padding:8px 12px;border-radius:999px;z-index:9"; t.textContent=text; document.getElementById('stage').appendChild(t); setTimeout(()=>t.remove(), 1400); }
function doFlash(){ flash.classList.remove("show"); void flash.offsetWidth; flash.classList.add("show"); }
function boom(){ document.getElementById('stage').classList.add("shake-hard"); doFlash(); Sound.boom(); setTimeout(()=>document.getElementById('stage').classList.remove("shake-hard"),600); }
function confetti(){ const box=document.getElementById('confetti'); box.innerHTML=""; for(let i=0;i<120;i++){ const p=document.createElement("i"); p.style.cssText=`position:absolute;top:-10px;width:8px;height:12px;background:hsla(${Math.floor(Math.random()*360)},90%,60%,.95);transform:rotate(${Math.floor(Math.random()*360)}deg);animation:fall ${2+Math.random()*1.8}s linear forwards;left:${Math.random()*100}%`; box.appendChild(p);} setTimeout(()=>box.innerHTML="",3000); }

/* ===================== Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù„Ø³Ø© ===================== */
let SELECTED_CLASS = null;
let ALL_STUDENTS = {}; // by classId
let CURRENT_SELECTED = []; // [{id,name,avatar}]
let TURN_INDEX = 0;
let GLOBAL_TIMER = null; let TURN_TIMER = null;

const Stats = (()=> { const key="bomb-pro-stats"; const store=JSON.parse(localStorage.getItem(key) || '{"session":{"total":0,"success":0,"fail":0},"students":{}}'); function save(){ localStorage.setItem(key, JSON.stringify(store)); }
  function recordRound(res){ store.session.total++; if(res.outcome==="SUCCESS") store.session.success++; else if(res.outcome==="FAIL") store.session.fail++; res.selectedStudents.forEach(s=>{ const st=store.students[s.id] || (store.students[s.id]={ name:s.name, points:0, rounds:0, success:0 }); st.rounds++; if(res.outcome==="SUCCESS"){ st.success++; st.points += res.pointsAwarded[s.id]||0; } }); save(); updateKPIs(); updateStudentPanels(); }
  function k(){ return store.session; } function getStudent(id){ return store.students[id]; } return { recordRound, k, getStudent } })();
function updateKPIs(){ const k=Stats.k(); document.getElementById('kRounds').textContent=k.total; document.getElementById('kWins').textContent=k.success; document.getElementById('kFails').textContent=k.fail; }

/* ===================== Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª: ØµÙÙˆÙ ÙˆØ·Ù„Ø§Ø¨ ===================== */
function buildClassGrid(){
  classGrid.innerHTML = '';
  if(!Array.isArray(DATA.classes) || DATA.classes.length===0){
    const emp = document.createElement('div'); emp.className='tile'; emp.innerHTML='<small>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</small>'; classGrid.appendChild(emp); return;
  }
  DATA.classes.forEach(c=>{
    const it = document.createElement('button');
    it.className = 'card-item';
    it.setAttribute('role','listitem');
    const icon = document.createElement('div'); icon.style.fontSize='26px'; icon.textContent = c.icon || 'ğŸ«';
    const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = c.name || c.id;
    it.append(icon, name);
    it.onclick = ()=> selectClass(c.id);
    classGrid.appendChild(it);
  });
}</div><div style="font-weight:700">${c.name}</div>`; it.onclick=()=> selectClass(c.id); classGrid.appendChild(it); }); }
function selectClass(id){
  SELECTED_CLASS = id;
  ALL_STUDENTS = DATA.students || {};
  sectionClass.hidden = true;
  sectionStudents.hidden = false;
  sectionStage.hidden = true;
  phaseSelect.value = 'selectStudents';
  buildStudentsGrid();
  log(`Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ: ${id}`);
}`); }
function buildStudentsGrid(){ const arr = [...(ALL_STUDENTS[SELECTED_CLASS]||[])]; studentsGrid.innerHTML=""; arr.forEach(s=>{ const b=document.createElement('button'); b.className='card-item'; b.setAttribute('role','listitem'); b.onclick=()=> toggleStudent(s,b); const label=document.createElement('div'); label.style.fontWeight='700'; label.textContent=s.name; const emo=document.createElement('div'); emo.style.fontSize='22px'; emo.textContent=s.avatar||'ğŸ‘¤'; b.appendChild(emo); b.appendChild(label); studentsGrid.appendChild(b); }); updateSelectedChips(); updateStartButton(); }
function toggleStudent(s,btn){ const idx = CURRENT_SELECTED.findIndex(x=>x.id===s.id); const limit = Number(elPerRound.value||1); if(idx>=0){ CURRENT_SELECTED.splice(idx,1); btn.classList.remove('active'); } else { if(CURRENT_SELECTED.length>=limit){ toast(`Ø§Ù„Ø­Ø¯ ${limit} Ø·Ù„Ø§Ø¨.`); return; } CURRENT_SELECTED.push({...s}); btn.classList.add('active'); } updateSelectedChips(); updateStartButton(); }
function updateSelectedChips(){ selectedChips.innerHTML=""; CURRENT_SELECTED.forEach(s=>{ const chip=document.createElement('div'); chip.className='chip'; const i=document.createElement('i'); i.textContent=s.avatar||'ğŸ‘¤'; const b=document.createElement('b'); b.textContent=s.name; chip.append(i,b); selectedChips.appendChild(chip); }); limitSpan.textContent=String(elPerRound.value||1); buildTurnList(); }
function buildTurnList(){ turnList.innerHTML=""; if(CURRENT_SELECTED.length===0){ turnList.innerHTML='<small>Ù„Ø§ Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø¨Ø¹Ø¯.</small>'; return; } CURRENT_SELECTED.forEach((s,idx)=>{ const t=document.createElement('div'); t.className='row'; t.innerHTML = `<div class="chip" style="flex:none"><i>${s.avatar||'ğŸ‘¤'}</i><b>${s.name}</b></div><div style="font-size:.9rem;color:var(--muted)">${idx===TURN_INDEX? 'ğŸ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ' : 'â€¦ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙˆØ±'}</div>`; turnList.appendChild(t); }); }

/* ===================== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©) ===================== */
phaseSelect.addEventListener('change',()=>{ const ph=phaseSelect.value; sectionClass.hidden = ph!=='selectClass'; sectionStudents.hidden = ph!=='selectStudents'; sectionStage.hidden = ph!=='stage'; });

/* ===================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ ===================== */
function updateStartButton(){ startBtn.disabled = CURRENT_SELECTED.length===0; }
function startChallenge(){ if(CURRENT_SELECTED.length===0){ alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹'); return; } Sound.resume(); setStartEnabled(false); setControls(true);
  // ØªÙ‡ÙŠØ¦Ø© Ù…Ø´Ù‡Ø¯ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
  sectionClass.hidden=true; sectionStudents.hidden=true; sectionStage.hidden=false; phaseSelect.value='stage';
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  const d = Difficulty[elDifficulty.value] || Difficulty.Medium; if(elDifficulty.value!=="Custom") elDuration.value=d.duration; const total = Number(elDuration.value||d.duration)*1000; const per = Number(elPerPlayer.value||15)*1000; const allowSur = elAllowSur.checked; const pace=d.pace; 
  // ARming
  GameState.to('ARMING'); countdownEl.textContent='Ø¬Ø§Ù‡Ø²ØŸ'; bomb.classList.remove('yellow','red','shake-soft','shake-hard');
  setTimeout(()=>{
    // RUNNING
    GameState.to('RUNNING');
    startGlobal(total, per, { allowSur, pace, surpriseProb:d.surpriseProb });
  }, 1500);
}

function startGlobal(totalMs, perPlayerMs, options){
  // Ù…Ø¤Ù‚Ù‘Øª ÙƒÙ„ÙŠ
  GLOBAL_TIMER = createTimer(totalMs);
  let paceTimer=null; function setPace(mode){ if(paceTimer) clearInterval(paceTimer); if(mode==='slow') paceTimer=setInterval(Sound.tickSlow,1000); if(mode==='mid') paceTimer=setInterval(Sound.tickFast,700); if(mode==='fast') paceTimer=setInterval(Sound.tickFast,450); }
  setPace(options.pace);
  // Ù…ÙØ§Ø¬Ø£Ø©
  if(options.allowSur && Math.random() < (options.surpriseProb||0.08)) setTimeout(()=>{ GLOBAL_TIMER.add(5000); toast('ğŸ Ù…ÙØ§Ø¬Ø£Ø© +5s'); }, 4000 + Math.random()*5000);

  attachTeacherControls(GLOBAL_TIMER, declareSuccess, declareFail);
  TURN_INDEX = 0; startTurn(perPlayerMs);

  Bus.on('timer:tick', ({left,seconds,total})=>{ countdownEl.textContent=seconds; const p=Math.max(0, Math.min(1, 1-(left/total))); heatFill.style.width=(p*100)+'%'; if(p>.5 && p<.8) bomb.classList.add('yellow'); if(p>=.8) bomb.classList.add('red'); turnStatus.textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¬ÙˆÙ„Ø©: ${seconds}s`;
  });
  Bus.on('timer:flag', tag=>{ if(tag==='half') log('âœ³ï¸ Ù†ØµÙ Ø§Ù„ÙˆÙ‚Øª'); if(tag==='last10'){ bomb.classList.add('shake-soft'); toast('âš ï¸ Ø¢Ø®Ø± 10 Ø«ÙˆØ§Ù†Ù'); } if(tag==='last3'){ countdownEl.classList.add('mega','danger'); Sound.alarm(); } });
  Bus.on('timer:end', ()=>{ boom(); declareFail(); });
  GLOBAL_TIMER.start();

  function declareSuccess(){ if(GameState.get()!=='RUNNING' && GameState.get()!=='PAUSED') return; GLOBAL_TIMER.pause(); GameState.to('SUCCESS'); showResults({ outcome:'SUCCESS', selectedStudents: CURRENT_SELECTED }); }
  function declareFail(){ if(GameState.get()!=='RUNNING' && GameState.get()!=='PAUSED') return; GLOBAL_TIMER.pause(); GameState.to('FAIL'); boom(); showResults({ outcome:'FAIL', selectedStudents: CURRENT_SELECTED }); }
}

function startTurn(perMs){ updateTurnUI(); TURN_TIMER && TURN_TIMER.pause(); TURN_TIMER=null; let left=perMs; const s = CURRENT_SELECTED[TURN_INDEX]; turnStatus.textContent=`ğŸ¯ Ø¯ÙˆØ± ${s.name} â€” ${Math.ceil(left/1000)}s`;
  const id = setInterval(()=>{ left-=1000; updateTurnUI(); if(left<=0){ clearInterval(id); nextTurn(perMs); }
  },1000);
  // Ø®ÙÙ‘Ø©: Ù†Ø¨Ø¶Ø© Ù‚Ù„Ø¨ Ø®ÙÙŠÙØ© Ù…Ø¹ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
  const hb = setInterval(()=> Sound.heart(), 2000);
  TURN_TIMER = { pause(){ clearInterval(id); clearInterval(hb); }, resume(){ /* Ù…Ø¨Ø³Ù‘Ø·Ø©: Ù„Ø§ Ø­Ø§Ø¬Ø© Ø§Ù„Ø¢Ù† */ } };
}
function nextTurn(perMs){ TURN_INDEX++; if(TURN_INDEX>=CURRENT_SELECTED.length){ // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± â€” Ø§Ù„Ù…Ø¹Ù„Ù… ÙŠÙ‚Ø±Ø± Ù†Ø¬Ø§Ø­Ù‹Ø§ Ø£Ùˆ ÙŠØ³ØªÙ…Ø± Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª
  toast('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± â€” Ø£Ø¹Ù„Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©'); return; } startTurn(perMs); }
function updateTurnUI(){ buildTurnList(); const s = CURRENT_SELECTED[TURN_INDEX]; const secs = Math.max(0, Number(elPerPlayer.value||15)); turnStatus.textContent=`ğŸ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${s.name} â€” ${secs}s Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨`; }

/* ===================== Ù†ØªØ§Ø¦Ø¬ ===================== */
function showResults({ outcome, selectedStudents }){ const award = (outcome==='SUCCESS') ? 10 : 0; const result = { roundId: crypto.randomUUID(), selectedStudents, outcome, pointsAwarded:Object.fromEntries(selectedStudents.map(s=>[s.id, award])) };
  Stats.recordRound(result);
  if(outcome==='SUCCESS'){ resultIcon.textContent='ğŸ‰'; resultTitle.textContent='Ù…Ù…ØªØ§Ø²!'; resultText.textContent='ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.'; confetti(); Sound.success(); resultBadges.innerHTML='<span class="badge">ğŸ… Ø³Ø±ÙŠØ¹ Ø§Ù„Ø±Ø¯</span><span class="badge">ğŸ’¬ Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø«Ù‚Ø©</span>'; }
  else if(outcome==='FAIL'){ resultIcon.textContent='ğŸ’¥'; resultTitle.textContent='Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©!'; resultText.textContent='Ø­Ø§ÙˆÙ„ÙˆØ§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'; }
  else { resultIcon.textContent='â¹ï¸'; resultTitle.textContent='ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù'; resultText.textContent='Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¨ÙƒØ± Ù„Ù„Ø¬ÙˆÙ„Ø©.'; }
  resultsEl.classList.add('show');
}
closeResults.onclick = ()=>{ resultsEl.classList.remove('show'); setStartEnabled(true); setControls(false); countdownEl.classList.remove('mega','danger','warn'); };

/* ===================== ØªØ­ÙƒÙ‘Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ===================== */
function attachTeacherControls(timer, onSuccess, onFail){ pauseBtn.onclick = ()=>{ if(GameState.get()==='RUNNING'){ timer.pause(); pauseBtn.textContent='Ø§Ø³ØªØ¦Ù†Ø§Ù â–¶ï¸'; GameState.to('PAUSED'); log('PAUSED'); } else if(GameState.get()==='PAUSED'){ timer.resume(); pauseBtn.textContent='Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª â¸'; GameState.to('RUNNING'); log('RESUMED'); } };
  add5Btn.onclick = ()=> timer.add(5000);
  successBtn.onclick = ()=> onSuccess();
  failBtn.onclick    = ()=> onFail();
}

/* ===================== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© ===================== */
teacherTab.addEventListener('click',()=>{ teacherTab.classList.add('active'); teacherTab.setAttribute('aria-pressed','true'); studentTab.classList.remove('active'); studentTab.setAttribute('aria-pressed','false'); viewsRoot.classList.add('teacher-view'); viewsRoot.classList.remove('student-view'); });
studentTab.addEventListener('click',()=>{ studentTab.classList.add('active'); studentTab.setAttribute('aria-pressed','true'); teacherTab.classList.remove('active'); teacherTab.setAttribute('aria-pressed','false'); viewsRoot.classList.add('student-view'); viewsRoot.classList.remove('teacher-view'); });

/* ===================== ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===================== */
elDifficulty.addEventListener('change',()=>{ const d=Difficulty[elDifficulty.value]; if(elDifficulty.value!=="Custom") elDuration.value=d.duration; });
elSoundOn.addEventListener('change',()=> Sound.enable(elSoundOn.checked) );
elPerRound.addEventListener('change',()=>{ if(CURRENT_SELECTED.length>Number(elPerRound.value||1)){ CURRENT_SELECTED.length = Number(elPerRound.value||1); buildStudentsGrid(); } updateSelectedChips(); updateStartButton(); });

/* ===================== Hotkeys ===================== */
window.addEventListener('keydown',(e)=>{ if(e.key===' '){ e.preventDefault(); pauseBtn.click(); } if(e.key==='Enter'){ e.preventDefault(); successBtn.click(); } if(e.key==='Escape'){ e.preventDefault(); failBtn.click(); } if(e.key==='ArrowUp'){ e.preventDefault(); add5Btn.click(); } });

/* ===================== ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ===================== */
function refreshPhase(){ const ph=phaseSelect.value; startBtn.disabled = (CURRENT_SELECTED.length===0) || ph!=='selectStudents'; pauseBtn.disabled=add5Btn.disabled=successBtn.disabled=failBtn.disabled = (ph!=='stage'); }
phaseSelect.addEventListener('change', refreshPhase);

/* ===================== Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ ===================== */
startBtn.addEventListener('click', startChallenge);

/* ===================== ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (ÙŠÙ…ÙŠÙ†) ===================== */
function updateStudentPanels(){ CURRENT_SELECTED.forEach(s=>{ /* ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ø±Ø¶ Ù†Ù‚Ø§Ø·/Ù†Ø¬Ø§Ø­Ø§Øª Ù…Ù† Stats.getStudent(s.id) */ }); }

/* ===================== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ===================== */
loadData();
updateKPIs();
refreshPhase();
</script>
</body>
</html>
