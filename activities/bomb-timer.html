<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© â€“ ØªØ¬Ø±Ø¨Ø© ØµÙÙŠØ©</title>
  <style>
    :root{--bg:#0f1224;--panel:#121737;--card:#171d43;--muted:#90a4c3;--text:#e9ecff;--accent:#6ea0ff;--green:#22c55e;--red:#ef4444;--yellow:#eab308}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 50% -10%,#1d2450,transparent),var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cairo,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #242a53;background:#0f1330;position:sticky;top:0;z-index:5}
    .title{font-weight:800;letter-spacing:.4px}
    .tabbar{margin-inline-start:auto;display:flex;gap:8px}
    .tab{background:#111834;border:1px solid #232a59;color:#cfe3ff;padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{background:#223169;color:#fff;border-color:#2c4599}
    .container{display:grid;grid-template-columns:280px 1fr 320px;gap:12px;padding:14px}
    .panel{background:var(--panel);border:1px solid #273064;border-radius:16px;padding:14px;min-height:200px}
    .panel h3{margin:0 0 10px;font-size:1rem;color:#cfe3ff}
    .row{display:flex;gap:8px;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .card-item{background:var(--card);border:1px solid #2a3159;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:6px;align-items:center;cursor:pointer}
    .card-item.active{outline:2px solid var(--accent)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#10173a;border:1px solid #2a3463;border-radius:999px;padding:6px 10px}
    .btn{background:#1a2250;border:1px solid #2b3b8a;color:#eaf; padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.warn{background:#3b1c1c;border-color:#7d2a2a}
    .btn.success{background:#18391f;border-color:#2e6b3a}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    select,input{background:#111834;color:#e9ecff;border:1px solid #2a3159;border-radius:10px;padding:8px 10px}
    label{font-size:.92rem;color:#c9d6ff}
    small, .muted{color:var(--muted)}

    /* Ø§Ù„Ù…Ø³Ø±Ø­ */
    #stage{position:relative;background:linear-gradient(180deg,#0f1437 0%,#0e1029 100%);border:1px solid #273064;border-radius:16px;padding:16px;min-height:400px;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:flex-start}
    #bombVisual{position:relative;width:180px;height:180px;border-radius:999px;background:#1b243f;border:2px solid #2d3d7a;display:grid;place-items:center;box-shadow:0 0 0 6px rgba(110,160,255,.08) inset}
    #bombVisual.yellow{background:#312f1a}
    #bombVisual.red{background:#3a1618}
    #countdown{font-weight:900;font-size:52px}
    #countdown.mega{font-size:76px}
    #countdown.danger{color:#ffb3b3}
    #heat{width:100%;height:8px;background:#0f1432;border:1px solid #2a3159;border-radius:999px;overflow:hidden}
    #heatFill{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#eab308,#ef4444)}
    #flash{position:absolute;inset:0;background:radial-gradient(600px 250px at 50% 40%,rgba(255,255,255,0.65),transparent);opacity:0;pointer-events:none;transition:opacity .25s}
    #flash.show{opacity:1;animation:flash .4s ease}
    @keyframes flash{0%{opacity:.95}100%{opacity:0}}
    .shake-soft{animation:shake .4s linear infinite}
    .shake-hard{animation:shake .15s linear 6}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}

    /* Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
    #results{position:absolute;inset:0;background:rgba(10,14,36,.72);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center}
    #results.show{display:flex}
    .results-card{background:#0f1639;border:1px solid #2a3a8a;border-radius:18px;padding:18px;min-width:280px;max-width:92vw;text-align:center}
    .badge{background:#223169;color:#fff;border:1px solid #3453b2;padding:6px 12px;border-radius:999px;margin:0 4px;display:inline-block}

    #confetti i{position:absolute;top:-10px;width:8px;height:12px;animation:fall 2.6s linear forwards}
    @keyframes fall{to{transform:translateY(120vh) rotate(360deg);opacity:.85}}

    .kpis{display:flex;gap:10px}
    .kpi{background:#0f1636;border:1px solid #273064;border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:2px;min-width:90px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="title">ğŸ’£ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© â€” Ù†Ø³Ø®Ø© Ù…ØµØ­Ø­Ø©</div>
    <div class="tabbar" id="topTabs">
      <button id="teacherTab" class="tab active" aria-pressed="true">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…</button>
      <button id="studentTab" class="tab" aria-pressed="false">ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
    </div>
  </header>

  <main class="container" id="viewsRoot">
    <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <aside class="panel" id="settings">
      <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
      <div class="row" style="justify-content:space-between">
        <label for="difficulty">Ø¯Ø±Ø¬Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
        <select id="difficulty">
          <option value="Easy">Ø³Ù‡Ù„</option>
          <option value="Medium" selected>Ù…ØªÙˆØ³Ø·</option>
          <option value="Hard">ØµØ¹Ø¨</option>
          <option value="Custom">Ù…Ø®ØµÙ‘Øµ</option>
        </select>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <label for="duration">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (Ø«)</label>
        <input id="duration" type="number" min="10" max="300" value="35" />
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <label for="perPlayer">Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ (Ø«)</label>
        <input id="perPlayer" type="number" min="5" max="60" value="15" />
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <label for="perRound">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„ÙƒÙ„ Ø¬ÙˆÙ„Ø©</label>
        <input id="perRound" type="number" min="1" max="8" value="3" />
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <label for="soundOn">Ø§Ù„ØµÙˆØªÙŠØ§Øª</label>
        <input id="soundOn" type="checkbox" checked />
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <label for="allowSurprises">Ù…ÙØ§Ø¬Ø¢Øª Ø§Ù„ÙˆÙ‚Øª</label>
        <input id="allowSurprises" type="checkbox" checked />
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <label class="muted" for="fairPick">Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø§Ø¯Ù„</label>
        <input id="fairPick" type="checkbox" />
      </div>
      <hr style="border:0;border-top:1px solid #273064;margin:12px 0" />
      <div class="row" style="justify-content:space-between">
        <label for="phase">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
        <select id="phase">
          <option value="selectClass">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ</option>
          <option value="selectStudents" selected>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨</option>
          <option value="stage">Ø§Ù„Ù…Ø³Ø±Ø­</option>
        </select>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="startBtn" class="btn">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ â–¶ï¸</button>
        <button id="pauseBtn" class="btn" disabled>Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª â¸</button>
        <button id="add5Btn" class="btn" disabled>+5 Ø«ÙˆØ§Ù†Ù</button>
        <button id="successBtn" class="btn success" disabled>Ù†Ø¬Ø§Ø­ âœ…</button>
        <button id="failBtn" class="btn warn" disabled>ÙØ´Ù„ âŒ</button>
      </div>
      <div style="margin-top:12px" class="kpis">
        <div class="kpi"><small>Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</small><b id="kRounds">0</b></div>
        <div class="kpi"><small>Ù†Ø¬Ø§Ø­Ø§Øª</small><b id="kWins">0</b></div>
        <div class="kpi"><small>ÙØ´Ù„</small><b id="kFails">0</b></div>
      </div>
    </aside>

    <!-- Ø§Ù„ÙˆØ³Ø·: Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø«Ù„Ø§Ø«Ø© -->
    <section class="panel" id="mid">
      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ -->
      <div id="sectionClass">
        <h3>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</h3>
        <div class="grid" id="classGrid"></div>
      </div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ -->
      <div id="sectionStudents">
        <h3>Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„Ø­Ø¯ <b id="limitSpan">3</b>)</h3>
        <div style="margin:8px 0;display:flex;gap:6px;flex-wrap:wrap" id="selectedChips"></div>
        <div class="grid" id="studentsGrid"></div>
      </div>

      <!-- Ø§Ù„Ù…Ø³Ø±Ø­ -->
      <div id="sectionStage" hidden>
        <div id="stage">
          <div id="bombVisual" class="">
            <div id="countdown">Ø¬Ø§Ù‡Ø²ØŸ</div>
          </div>
          <div id="heat" aria-label="Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø®ÙˆÙ†Ø©"><div id="heatFill"></div></div>
          <div id="turnStatus" class="muted">Ù„Ø§ Ø¬ÙˆÙ„Ø© Ù†Ø´Ø·Ø©</div>
          <div id="flash"></div>
          <div id="confetti"></div>
          <div id="results" role="dialog" aria-modal="true">
            <div class="results-card">
              <div style="font-size:44px" id="resultIcon">â¹ï¸</div>
              <h3 id="resultTitle" style="margin:6px 0 8px">ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù</h3>
              <div id="resultText" class="muted" style="margin-bottom:8px">Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¨ÙƒØ± Ù„Ù„Ø¬ÙˆÙ„Ø©.</div>
              <div id="resultBadges" style="margin:6px 0"></div>
              <div style="margin-top:10px"><button class="btn" id="closeResults">Ù…ØªØ§Ø¨Ø¹Ø©</button></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ø³Ø¬Ù„ -->
    <aside class="panel">
      <h3>Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</h3>
      <div id="turnList" class="col"></div>
      <hr style="border:0;border-top:1px solid #273064;margin:12px 0" />
      <h3>Ø§Ù„Ø³Ø¬Ù„</h3>
      <div id="log" class="muted" style="font-size:.92rem;min-height:80px"></div>
    </aside>
  </main>

  <script>
  /* ===================== Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† fetch ===================== */
  const DATA = {
    classes: [
      { id:"A1", name:"Ø§Ù„ØµÙ A1", icon:"ğŸ«"},
      { id:"B2", name:"Ø§Ù„ØµÙ B2", icon:"ğŸ«"}
    ],
    students: {
      A1: [
        { id:"s1", name:"Ù„ÙŠØ§Ù†", avatar:"ğŸ‘§"},
        { id:"s2", name:"Ø¹Ù…Ø±", avatar:"ğŸ§’"},
        { id:"s3", name:"Ø³Ø§Ø±Ø©", avatar:"ğŸ‘§"},
        { id:"s4", name:"Ø®Ø§Ù„Ø¯", avatar:"ğŸ‘¦"}
      ],
      B2: [
        { id:"s5", name:"Ù†ÙˆØ±Ø©", avatar:"ğŸ‘§"},
        { id:"s6", name:"Ø²ÙŠØ§Ø¯", avatar:"ğŸ‘¦"},
        { id:"s7", name:"Ù‡Ù†Ø¯", avatar:"ğŸ‘§"},
        { id:"s8", name:"Ù…Ø§Ø²Ù†", avatar:"ğŸ‘¦"}
      ]
    }
  };

  function loadData(){ buildClassGrid(); }

  /* ===================== Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ===================== */
  const viewsRoot = document.getElementById('viewsRoot');
  const teacherTab = document.getElementById('teacherTab');
  const studentTab = document.getElementById('studentTab');

  const sectionClass    = document.getElementById('sectionClass');
  const sectionStudents = document.getElementById('sectionStudents');
  const sectionStage    = document.getElementById('sectionStage');

  const classGrid    = document.getElementById('classGrid');
  const studentsGrid = document.getElementById('studentsGrid');
  const selectedChips= document.getElementById('selectedChips');
  const limitSpan    = document.getElementById('limitSpan');

  const elDifficulty = document.getElementById('difficulty');
  const elDuration   = document.getElementById('duration');
  const elPerPlayer  = document.getElementById('perPlayer');
  const elPerRound   = document.getElementById('perRound');
  const elSoundOn    = document.getElementById('soundOn');
  const elAllowSur   = document.getElementById('allowSurprises');
  const elFairPick   = document.getElementById('fairPick');
  const phaseSelect  = document.getElementById('phase');

  const startBtn   = document.getElementById('startBtn');
  const pauseBtn   = document.getElementById('pauseBtn');
  const add5Btn    = document.getElementById('add5Btn');
  const successBtn = document.getElementById('successBtn');
  const failBtn    = document.getElementById('failBtn');

  const countdownEl = document.getElementById('countdown');
  const heatFill    = document.getElementById('heatFill');
  const bombVisual  = document.getElementById('bombVisual');
  const flash       = document.getElementById('flash');
  const resultsEl   = document.getElementById('results');
  const resultIcon  = document.getElementById('resultIcon');
  const resultTitle = document.getElementById('resultTitle');
  const resultText  = document.getElementById('resultText');
  const resultBadges= document.getElementById('resultBadges');
  const closeResults= document.getElementById('closeResults');
  const confettiBox = document.getElementById('confetti');

  const turnList   = document.getElementById('turnList');
  const turnStatus = document.getElementById('turnStatus');
  const logEl      = document.getElementById('log');

  /* ===================== Ø­Ø§Ù„Ø§Øª ÙˆØµØ¹ÙˆØ¨Ø§Øª ===================== */
  const Difficulty = {
    Easy:    { duration: 60, pace: "slow",  surpriseProb: 0.05, effects:{ shake:false, flashAtEnd:true } },
    Medium:  { duration: 35, pace: "mid",   surpriseProb: 0.08, effects:{ shake:true,  flashAtEnd:true } },
    Hard:    { duration: 20, pace: "fast",  surpriseProb: 0.12, effects:{ shake:true,  flashAtEnd:true } },
    Custom:  { duration: 45, pace: "mid",   surpriseProb: 0.10, effects:{ shake:true,  flashAtEnd:true } }
  };

  const Bus = (()=>{ const m=new Map(); return { on:(e,h)=>m.set(e,(m.get(e)||[]).concat(h)), emit:(e,p)=> (m.get(e)||[]).forEach(h=>h(p)) }})();
  const GameState = (()=>{ let s="IDLE"; const T={ IDLE:["ARMING"], ARMING:["RUNNING","IDLE"], RUNNING:["PAUSED","SUCCESS","FAIL","RESULTS"], PAUSED:["RUNNING","RESULTS"], SUCCESS:["RESULTS"], FAIL:["RESULTS"], RESULTS:["IDLE","ARMING"] }; return { get:()=>s, to:(n)=>{ if((T[s]||[]).includes(n)){ s=n; Bus.emit("state",s);} } }})();

  /* ===================== ØµÙˆØªÙŠØ§Øª Ø®ÙÙŠÙØ© ===================== */
  const Sound = (() => {
    let ctx=null, enabled=true; function ensure(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); }
    function beep(freq=880,ms=80,type="sine",gain=0.035){ if(!enabled) return; ensure(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+ms/1000);} 
    return {
      enable(v){enabled=!!v; if(enabled) ensure();}, resume(){ if(ctx && ctx.state==="suspended") ctx.resume(); },
      tickSlow:()=>beep(680,28,"square",.03), tickFast:()=>beep(900,24,"square",.035), heart:()=>{beep(120,60,"sine",.06); setTimeout(()=>beep(120,60,"sine",.06),120);}, alarm:()=>beep(1100,130,"sawtooth",.05), success:()=>{beep(660,120,"triangle",.05); setTimeout(()=>beep(880,140,"triangle",.05),150);}, boom:()=>{beep(80,200,"sawtooth",.08); setTimeout(()=>beep(50,260,"sawtooth",.08),120);} }
  })();

  /* ===================== Ù…Ø¤Ù‚Ù‘Øª rAF ===================== */
  function createTimer(totalMs){
    let left=totalMs, id=null, last=performance.now(); const marks=new Set();
    function tick(now){ left -= now-last; last=now; Bus.emit("timer:tick",{left,seconds:Math.ceil(left/1000), total: totalMs}); const s=Math.ceil(left/1000); const half=Math.ceil(totalMs/2000);
      if(!marks.has("half") && s===half){ marks.add("half"); Bus.emit("timer:flag","half"); }
      if(!marks.has("last10") && s===10){ marks.add("last10"); Bus.emit("timer:flag","last10"); }
      if(s<=3){ Bus.emit("timer:flag","last3"); }
      if(left<=0){ cancelAnimationFrame(id); id=null; Bus.emit("timer:end"); return; }
      id=requestAnimationFrame(tick);
    }
    return { start(){ last=performance.now(); id=requestAnimationFrame(tick); Bus.emit("timer:start",{totalMs}); }, pause(){ if(id){ cancelAnimationFrame(id); id=null; Bus.emit("timer:pause",{left}); } }, resume(){ if(!id){ last=performance.now(); id=requestAnimationFrame(tick); Bus.emit("timer:resume",{left}); } }, add(ms){ left+=ms; Bus.emit("timer:add",{left,ms}); }, get left(){return left;} }
  }

  /* ===================== Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© ===================== */
  function log(msg){ const t=new Date().toLocaleTimeString(); logEl.innerHTML = `<div>[${t}] ${msg}</div>` + logEl.innerHTML; }
  function setStartEnabled(v){ startBtn.disabled=!v; }
  function setControls(running){ pauseBtn.disabled=add5Btn.disabled=successBtn.disabled=failBtn.disabled=!running; }
  function toast(text){ const t=document.createElement('div'); t.style.cssText="position:absolute;top:16px;left:50%;transform:translateX(-50%);background:#111834;border:1px solid #2a3159;color:#eaf;padding:8px 12px;border-radius:999px;z-index:9"; t.textContent=text; document.getElementById('stage').appendChild(t); setTimeout(()=>t.remove(), 1400); }
  function doFlash(){ flash.classList.remove("show"); void flash.offsetWidth; flash.classList.add("show"); }
  function boom(){ document.getElementById('stage').classList.add("shake-hard"); doFlash(); Sound.boom(); setTimeout(()=>document.getElementById('stage').classList.remove("shake-hard"),600); }
  function confetti(){ const box=document.getElementById('confetti'); box.innerHTML=""; for(let i=0;i<120;i++){ const p=document.createElement("i"); p.style.cssText=`left:${Math.random()*100}%`; p.style.background=`hsla(${Math.floor(Math.random()*360)},90%,60%,.95)`; box.appendChild(p);} setTimeout(()=>box.innerHTML="",3000); }

  /* ===================== Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù„Ø³Ø© ===================== */
  let SELECTED_CLASS = null;
  let ALL_STUDENTS = {}; // by classId
  let CURRENT_SELECTED = []; // [{id,name,avatar}]
  let TURN_INDEX = 0;
  let GLOBAL_TIMER = null; let TURN_TIMER = null;

  const Stats = (()=> { const key="bomb-pro-stats"; const store=JSON.parse(localStorage.getItem(key) || '{"session":{"total":0,"success":0,"fail":0},"students":{}}'); function save(){ localStorage.setItem(key, JSON.stringify(store)); }
    function recordRound(res){ store.session.total++; if(res.outcome==="SUCCESS") store.session.success++; else if(res.outcome==="FAIL") store.session.fail++; res.selectedStudents.forEach(s=>{ const st=store.students[s.id] || (store.students[s.id]={ name:s.name, points:0, rounds:0, success:0 }); st.rounds++; if(res.outcome==="SUCCESS"){ st.success++; st.points += res.pointsAwarded[s.id]||0; } }); save(); updateKPIs(); updateStudentPanels(); }
    function k(){ return store.session; } function getStudent(id){ return store.students[id]; } return { recordRound, k, getStudent } })();
  function updateKPIs(){ const k=Stats.k(); document.getElementById('kRounds').textContent=k.total; document.getElementById('kWins').textContent=k.success; document.getElementById('kFails').textContent=k.fail; }

  /* ===================== Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª: ØµÙÙˆÙ ÙˆØ·Ù„Ø§Ø¨ ===================== */
  function buildClassGrid(){
    classGrid.innerHTML = '';
    if(!Array.isArray(DATA.classes) || DATA.classes.length===0){
      const emp = document.createElement('div'); emp.className='card-item'; emp.innerHTML='<small>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</small>'; classGrid.appendChild(emp); return;
    }
    DATA.classes.forEach(c=>{
      const it = document.createElement('button');
      it.className = 'card-item';
      it.setAttribute('role','listitem');
      const icon = document.createElement('div'); icon.style.fontSize='26px'; icon.textContent = c.icon || 'ğŸ«';
      const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = c.name || c.id;
      it.append(icon, name);
      it.onclick = ()=> selectClass(c.id);
      classGrid.appendChild(it);
    });
  }
  function selectClass(id){
    SELECTED_CLASS = id;
    ALL_STUDENTS = DATA.students || {};
    sectionClass.hidden = true;
    sectionStudents.hidden = false;
    sectionStage.hidden = true;
    phaseSelect.value = 'selectStudents';
    buildStudentsGrid();
    log(`Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ: ${id}`);
  }
  function buildStudentsGrid(){ const arr = [...(ALL_STUDENTS[SELECTED_CLASS]||[])]; studentsGrid.innerHTML=""; arr.forEach(s=>{ const b=document.createElement('button'); b.className='card-item'; b.setAttribute('role','listitem'); b.onclick=()=> toggleStudent(s,b); const label=document.createElement('div'); label.style.fontWeight='700'; label.textContent=s.name; const emo=document.createElement('div'); emo.style.fontSize='22px'; emo.textContent=s.avatar||'ğŸ‘¤'; b.appendChild(emo); b.appendChild(label); studentsGrid.appendChild(b); }); updateSelectedChips(); updateStartButton(); }
  function toggleStudent(s,btn){ const idx = CURRENT_SELECTED.findIndex(x=>x.id===s.id); const limit = Number(elPerRound.value||1); if(idx>=0){ CURRENT_SELECTED.splice(idx,1); btn.classList.remove('active'); } else { if(CURRENT_SELECTED.length>=limit){ toast(`Ø§Ù„Ø­Ø¯ ${limit} Ø·Ù„Ø§Ø¨.`); return; } CURRENT_SELECTED.push({...s}); btn.classList.add('active'); } updateSelectedChips(); updateStartButton(); }
  function updateSelectedChips(){ selectedChips.innerHTML=""; CURRENT_SELECTED.forEach(s=>{ const chip=document.createElement('div'); chip.className='chip'; const i=document.createElement('i'); i.textContent=s.avatar||'ğŸ‘¤'; const b=document.createElement('b'); b.textContent=s.name; chip.append(i,b); selectedChips.appendChild(chip); }); limitSpan.textContent=String(elPerRound.value||1); buildTurnList(); }
  function buildTurnList(){ turnList.innerHTML=""; if(CURRENT_SELECTED.length===0){ turnList.innerHTML='<small>Ù„Ø§ Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø¨Ø¹Ø¯.</small>'; return; } CURRENT_SELECTED.forEach((s,idx)=>{ const t=document.createElement('div'); t.className='row'; t.innerHTML = `<div class="chip" style="flex:none"><i>${s.avatar||'ğŸ‘¤'}</i><b>${s.name}</b></div><div style="font-size:.9rem;color:var(--muted)">${idx===TURN_INDEX? 'ğŸ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ' : 'â€¦ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙˆØ±'}</div>`; turnList.appendChild(t); }); }

  /* ===================== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©) ===================== */
  phaseSelect.addEventListener('change',()=>{ const ph=phaseSelect.value; sectionClass.hidden = ph!=='selectClass'; sectionStudents.hidden = ph!=='selectStudents'; sectionStage.hidden = ph!=='stage'; refreshPhase(); });

  /* ===================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ ===================== */
  function updateStartButton(){ startBtn.disabled = CURRENT_SELECTED.length===0; }
  function startChallenge(){ if(CURRENT_SELECTED.length===0){ alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹'); return; } Sound.resume(); setStartEnabled(false); setControls(true);
    // ØªÙ‡ÙŠØ¦Ø© Ù…Ø´Ù‡Ø¯ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
    sectionClass.hidden=true; sectionStudents.hidden=true; sectionStage.hidden=false; phaseSelect.value='stage';
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const d = Difficulty[elDifficulty.value] || Difficulty.Medium; if(elDifficulty.value!=="Custom") elDuration.value=d.duration; const total = Number(elDuration.value||d.duration)*1000; const per = Number(elPerPlayer.value||15)*1000; const allowSur = elAllowSur.checked; const pace=d.pace; 
    // ØªØ³Ù„ÙŠØ­
    GameState.to('ARMING'); countdownEl.textContent='Ø¬Ø§Ù‡Ø²ØŸ'; bombVisual.classList.remove('yellow','red','shake-soft','shake-hard');
    setTimeout(()=>{ GameState.to('RUNNING'); startGlobal(total, per, { allowSur, pace, surpriseProb:d.surpriseProb }); }, 1200);
  }

  function startGlobal(totalMs, perPlayerMs, options){
    GLOBAL_TIMER = createTimer(totalMs);
    let paceTimer=null; function setPace(mode){ if(paceTimer) clearInterval(paceTimer); if(mode==='slow') paceTimer=setInterval(Sound.tickSlow,1000); if(mode==='mid') paceTimer=setInterval(Sound.tickFast,700); if(mode==='fast') paceTimer=setInterval(Sound.tickFast,450); }
    setPace(options.pace);
    if(options.allowSur && Math.random() < (options.surpriseProb||0.08)) setTimeout(()=>{ GLOBAL_TIMER.add(5000); toast('ğŸ Ù…ÙØ§Ø¬Ø£Ø© +5s'); }, 3000 + Math.random()*4000);

    attachTeacherControls(GLOBAL_TIMER, declareSuccess, declareFail);
    TURN_INDEX = 0; startTurn(perPlayerMs);

    Bus.on('timer:tick', ({left,seconds,total})=>{ countdownEl.textContent=seconds; const p=Math.max(0, Math.min(1, 1-(left/total))); heatFill.style.width=(p*100)+'%'; if(p>.5 && p<.8) bombVisual.classList.add('yellow'); if(p>=.8) bombVisual.classList.add('red'); turnStatus.textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¬ÙˆÙ„Ø©: ${seconds}s`; });
    Bus.on('timer:flag', tag=>{ if(tag==='half') log('âœ³ï¸ Ù†ØµÙ Ø§Ù„ÙˆÙ‚Øª'); if(tag==='last10'){ bombVisual.classList.add('shake-soft'); toast('âš ï¸ Ø¢Ø®Ø± 10 Ø«ÙˆØ§Ù†Ù'); } if(tag==='last3'){ countdownEl.classList.add('mega','danger'); Sound.alarm(); } });
    Bus.on('timer:end', ()=>{ boom(); declareFail(); });
    GLOBAL_TIMER.start();

    function declareSuccess(){ if(GameState.get()!=='RUNNING' && GameState.get()!=='PAUSED') return; GLOBAL_TIMER.pause(); GameState.to('SUCCESS'); showResults({ outcome:'SUCCESS', selectedStudents: CURRENT_SELECTED }); }
    function declareFail(){ if(GameState.get()!=='RUNNING' && GameState.get()!=='PAUSED') return; GLOBAL_TIMER.pause(); GameState.to('FAIL'); boom(); showResults({ outcome:'FAIL', selectedStudents: CURRENT_SELECTED }); }
  }

  function startTurn(perMs){ updateTurnUI(); if(TURN_TIMER) TURN_TIMER.pause(); TURN_TIMER=null; let left=perMs; const s = CURRENT_SELECTED[TURN_INDEX]; turnStatus.textContent=`ğŸ¯ Ø¯ÙˆØ± ${s.name} â€” ${Math.ceil(left/1000)}s`;
    const id = setInterval(()=>{ left-=1000; updateTurnUI(); if(left<=0){ clearInterval(id); nextTurn(perMs); } },1000);
    const hb = setInterval(()=> Sound.heart(), 2000);
    TURN_TIMER = { pause(){ clearInterval(id); clearInterval(hb); }, resume(){} };
  }
  function nextTurn(perMs){ TURN_INDEX++; if(TURN_INDEX>=CURRENT_SELECTED.length){ toast('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± â€” Ø£Ø¹Ù„Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©'); return; } startTurn(perMs); }
  function updateTurnUI(){ buildTurnList(); if(CURRENT_SELECTED.length===0) return; const s = CURRENT_SELECTED[TURN_INDEX]||CURRENT_SELECTED.at(-1); const secs = Math.max(0, Number(elPerPlayer.value||15)); turnStatus.textContent=`ğŸ¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${s.name} â€” ${secs}s Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨`; }

  /* ===================== Ù†ØªØ§Ø¦Ø¬ ===================== */
  function showResults({ outcome, selectedStudents }){ const award = (outcome==='SUCCESS') ? 10 : 0; const result = { roundId: crypto.randomUUID(), selectedStudents, outcome, pointsAwarded:Object.fromEntries(selectedStudents.map(s=>[s.id, award])) };
    Stats.recordRound(result);
    if(outcome==='SUCCESS'){ resultIcon.textContent='ğŸ‰'; resultTitle.textContent='Ù…Ù…ØªØ§Ø²!'; resultText.textContent='ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.'; confetti(); Sound.success(); resultBadges.innerHTML='<span class="badge">ğŸ… Ø³Ø±ÙŠØ¹ Ø§Ù„Ø±Ø¯</span><span class="badge">ğŸ’¬ Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø«Ù‚Ø©</span>'; }
    else if(outcome==='FAIL'){ resultIcon.textContent='ğŸ’¥'; resultTitle.textContent='Ø§Ù†ÙØ¬Ø±Øª Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©!'; resultText.textContent='Ø­Ø§ÙˆÙ„ÙˆØ§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'; }
    else { resultIcon.textContent='â¹ï¸'; resultTitle.textContent='ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù'; resultText.textContent='Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¨ÙƒØ± Ù„Ù„Ø¬ÙˆÙ„Ø©.'; }
    resultsEl.classList.add('show');
  }
  closeResults.onclick = ()=>{ resultsEl.classList.remove('show'); setStartEnabled(true); setControls(false); countdownEl.classList.remove('mega','danger'); };

  /* ===================== ØªØ­ÙƒÙ‘Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ===================== */
  function attachTeacherControls(timer, onSuccess, onFail){ pauseBtn.onclick = ()=>{ if(GameState.get()==='RUNNING'){ timer.pause(); pauseBtn.textContent='Ø§Ø³ØªØ¦Ù†Ø§Ù â–¶ï¸'; GameState.to('PAUSED'); log('PAUSED'); } else if(GameState.get()==='PAUSED'){ timer.resume(); pauseBtn.textContent='Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª â¸'; GameState.to('RUNNING'); log('RESUMED'); } };
    add5Btn.onclick = ()=> timer.add(5000);
    successBtn.onclick = ()=> onSuccess();
    failBtn.onclick    = ()=> onFail();
  }

  /* ===================== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© ===================== */
  teacherTab.addEventListener('click',()=>{ teacherTab.classList.add('active'); teacherTab.setAttribute('aria-pressed','true'); studentTab.classList.remove('active'); studentTab.setAttribute('aria-pressed','false'); viewsRoot.classList.add('teacher-view'); viewsRoot.classList.remove('student-view'); });
  studentTab.addEventListener('click',()=>{ studentTab.classList.add('active'); studentTab.setAttribute('aria-pressed','true'); teacherTab.classList.remove('active'); teacherTab.setAttribute('aria-pressed','false'); viewsRoot.classList.add('student-view'); viewsRoot.classList.remove('teacher-view'); });

  /* ===================== ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===================== */
  elDifficulty.addEventListener('change',()=>{ const d=Difficulty[elDifficulty.value]; if(elDifficulty.value!=="Custom") elDuration.value=d.duration; });
  elSoundOn.addEventListener('change',()=> Sound.enable(elSoundOn.checked) );
  elPerRound.addEventListener('change',()=>{ if(CURRENT_SELECTED.length>Number(elPerRound.value||1)){ CURRENT_SELECTED.length = Number(elPerRound.value||1); buildStudentsGrid(); } updateSelectedChips(); updateStartButton(); });

  /* ===================== Hotkeys ===================== */
  window.addEventListener('keydown',(e)=>{ if(GameState.get()==='RUNNING'){ if(e.key===' '){ e.preventDefault(); pauseBtn.click(); } if(e.key==='Enter'){ e.preventDefault(); successBtn.click(); } if(e.key==='Escape'){ e.preventDefault(); failBtn.click(); } if(e.key==='ArrowUp'){ e.preventDefault(); add5Btn.click(); } } else if(GameState.get()==='PAUSED' && e.key===' '){ e.preventDefault(); pauseBtn.click(); } });

  /* ===================== ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ===================== */
  function refreshPhase(){ const ph=phaseSelect.value; startBtn.disabled = (CURRENT_SELECTED.length===0) || ph!=='selectStudents'; pauseBtn.disabled=add5Btn.disabled=successBtn.disabled=failBtn.disabled = (ph!=='stage'); }
  phaseSelect.addEventListener('change', refreshPhase);

  /* ===================== Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ ===================== */
  startBtn.addEventListener('click', startChallenge);

  /* ===================== ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (ÙŠÙ…ÙŠÙ†) ===================== */
  function updateStudentPanels(){ /* Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ */ }

  /* ===================== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ===================== */
  loadData();
  updateKPIs();
  refreshPhase();
  </script>
</body>
</html>
